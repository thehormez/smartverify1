import React, { useEffect, useMemo, useState } from "react";

// ⚡️ نسخة خفيفة بلا shadcn ولا مكوّنات خارجية — فقط Tailwind + عناصر HTML
// لحل مشكلة ظهور الصفحة ككتابة غير منسقة

const CLIENTS = [
  { id: "c1", name: "عميل تجريبي", username: "client1", password: "123456", credit: 50 },
];

const LS_AUTH = "hormez_client_auth";
const LS_INVITES = "hormez_client_invites";

function normalizePhone(phone) {
  return String(phone || "").replace(/\D/g, "");
}

function makeInvite({ guestName, phone, count, eventName }) {
  return {
    id: `${Date.now()}_${Math.random().toString(36).slice(2, 8)}`,
    guestName: guestName?.trim() || "",
    phone: normalizePhone(phone),
    count: Math.max(1, Number(count || 1)),
    eventName: eventName?.trim() || "بدون اسم حدث",
    status: "new",
    createdAt: new Date().toISOString(),
  };
}

function computeStats(invites) {
  const total = invites.length;
  const sent = invites.filter(i => ["sent","reminded","attended"].includes(i.status)).length;
  const attended = invites.filter(i => i.status === "attended").length;
  return { total, sent, attended };
}

function openWhatsApp(phone, msg) {
  const digits = normalizePhone(phone);
  if (!digits) { alert("رقم الهاتف غير صالح"); return; }
  const url = `https://wa.me/${digits}?text=${encodeURIComponent(msg)}`;
  window.open(url, "_blank");
}

export default function ClientInviteApp() {
  const [auth, setAuth] = useState(() => {
    try { return JSON.parse(localStorage.getItem(LS_AUTH) || "null"); } catch { return null; }
  });
  const [invites, setInvites] = useState(() => auth ? loadInvites(auth.client.id) : []);

  useEffect(() => { if (auth) setInvites(loadInvites(auth.client.id)); }, [auth?.client?.id]);
  useEffect(() => { if (auth) saveInvites(auth.client.id, invites); }, [auth, invites]);

  if (!auth) return <Login onSuccess={setAuth}/>;
  return <ClientArea auth={auth} setAuth={setAuth} invites={invites} setInvites={setInvites}/>;
}

function Login({ onSuccess }) {
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");

  const attempt = () => {
    const c = CLIENTS.find(x => x.username === username.trim());
    if (!c || c.password !== password) { alert("بيانات الدخول غير صحيحة"); return; }
    const payload = { client: { id: c.id, name: c.name, username: c.username, credit: c.credit } };
    localStorage.setItem(LS_AUTH, JSON.stringify(payload));
    onSuccess(payload);
  };

  return (
    <div className="min-h-screen bg-neutral-950 text-neutral-100 flex items-center justify-center p-6" dir="rtl">
      <div className="w-full max-w-md bg-neutral-900 border border-neutral-800 rounded-2xl shadow-xl p-6">
        <h1 className="text-center text-2xl font-black mb-6">HORMEZ <span className="text-yellow-400">SECURITY</span></h1>
        <div className="space-y-4">
          <div>
            <label className="block mb-1">اسم المستخدم</label>
            <input className="w-full rounded bg-neutral-800 border border-neutral-700 px-3 py-2" value={username} onChange={e=>setUsername(e.target.value)}/>
          </div>
          <div>
            <label className="block mb-1">كلمة المرور</label>
            <input type="password" className="w-full rounded bg-neutral-800 border border-neutral-700 px-3 py-2" value={password} onChange={e=>setPassword(e.target.value)}/>
          </div>
          <button onClick={attempt} className="w-full rounded bg-yellow-500 text-black font-bold py-2">تسجيل الدخول</button>
        </div>
      </div>
    </div>
  );
}

function ClientArea({ auth, setAuth, invites, setInvites }) {
  const [active, setActive] = useState("home");
  const stats = useMemo(()=>computeStats(invites), [invites]);

  const logout = () => { localStorage.removeItem(LS_AUTH); setAuth(null); };
  const addInvite = inv => setInvites([inv, ...invites]);
  const markStatus = (id, status) => setInvites(prev => prev.map(i=>i.id===id?{...i,status}:i));

  return (
    <div className="min-h-screen bg-neutral-950 text-neutral-100" dir="rtl">
      <header className="border-b border-neutral-800 bg-neutral-900 p-4 flex justify-between">
        <span className="font-black">HORMEZ <span className="text-yellow-400">SECURITY</span></span>
        <div>
          <span className="mr-3">{auth.client.name}</span>
          <button onClick={logout}>خروج</button>
        </div>
      </header>

      <main className="max-w-4xl mx-auto p-4 space-y-6">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          <Stat label="إجمالي الدعوات" value={stats.total}/>
          <Stat label="الدعوات المُرسلة" value={stats.sent}/>
          <Stat label="الحضور" value={stats.attended}/>
          <Stat label="الرصيد المتبقي" value={Math.max(0, (auth.client.credit ?? 0) - stats.sent)}/>
        </div>

        <div className="flex gap-2 flex-wrap">
          {NavBtn("home","الرئيسية",()=>setActive("home"),active)}
          {NavBtn("new","دعوة جديدة",()=>setActive("new"),active)}
          {NavBtn("send","الإرسال",()=>setActive("send"),active)}
          {NavBtn("remind","التذكير",()=>setActive("remind"),active)}
          {NavBtn("attend","الحضور",()=>setActive("attend"),active)}
        </div>

        {active==="home" && <InviteTable invites={invites} onMark={markStatus}/>} 
        {active==="new" && <NewInviteForm onCreate={addInvite}/>} 
      </main>
    </div>
  );
}

function Stat({label,value}){
  return <div className="bg-neutral-900 p-4 rounded"><p className="text-neutral-400 text-sm">{label}</p><p className="text-2xl font-bold">{value}</p></div>;
}

function NavBtn(key,label,onClick,active){
  return <button key={key} onClick={onClick} className={`px-4 py-2 rounded ${active===key?"bg-yellow-500 text-black":"bg-neutral-800 text-white"}`}>{label}</button>;
}

function InviteTable({invites,onMark}){
  if(!invites.length) return <p className="text-neutral-400">لا توجد دعوات بعد.</p>;
  return (
    <table className="w-full text-right border border-neutral-800">
      <thead className="bg-neutral-800 text-neutral-300">
        <tr><th>الاسم</th><th>الجوال</th><th>الحدث</th><th>الحالة</th><th>إجراءات</th></tr>
      </thead>
      <tbody>
        {invites.map(i=>(
          <tr key={i.id} className="border-t border-neutral-800">
            <td>{i.guestName}</td>
            <td>{i.phone}</td>
            <td>{i.eventName}</td>
            <td>{i.status}</td>
            <td className="flex gap-2">
              <button onClick={()=>onMark(i.id,"sent")} className="px-2 bg-blue-600 rounded">مرسلة</button>
              <button onClick={()=>onMark(i.id,"attended")} className="px-2 bg-green-600 rounded">حضر</button>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  );
}

function NewInviteForm({onCreate}){
  const [guestName,setGuestName]=useState("");
  const [phone,setPhone]=useState("");
  const [count,setCount]=useState(1);
  const [eventName,setEventName]=useState("زفاف خالد");

  const create=()=>{
    if(!guestName||!phone){alert("أدخل الاسم ورقم الهاتف");return;}
    onCreate(makeInvite({guestName,phone,count,eventName}));
    setGuestName("");setPhone("");setCount(1);
  };

  return (
    <div className="bg-neutral-900 p-6 rounded space-y-4">
      <div>
        <label>الاسم</label>
        <input className="w-full bg-neutral-800 px-3 py-2 rounded" value={guestName} onChange={e=>setGuestName(e.target.value)}/>
      </div>
      <div>
        <label>رقم الهاتف</label>
        <input className="w-full bg-neutral-800 px-3 py-2 rounded" value={phone} onChange={e=>setPhone(e.target.value)}/>
      </div>
      <div>
        <label>عدد الكروت</label>
        <input type="number" className="w-full bg-neutral-800 px-3 py-2 rounded" value={count} onChange={e=>setCount(Number(e.target.value||1))}/>
      </div>
      <div>
        <label>اسم الحدث</label>
        <input className="w-full bg-neutral-800 px-3 py-2 rounded" value={eventName} onChange={e=>setEventName(e.target.value)}/>
      </div>
      <button onClick={create} className="w-full bg-yellow-500 text-black py-2 rounded">إضافة الدعوة</button>
    </div>
  );
}

function saveInvites(clientId,invites){
  const all=JSON.parse(localStorage.getItem(LS_INVITES)||"{}");
  all[clientId]=invites;
  localStorage.setItem(LS_INVITES,JSON.stringify(all));
}
function loadInvites(clientId){
  const all=JSON.parse(localStorage.getItem(LS_INVITES)||"{}");
  return Array.isArray(all[clientId])?all[clientId]:[];
}
