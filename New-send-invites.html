<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez â€” Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒØ±ÙˆØª (Ù…Ø­Ù„ÙŠ) â€¢ ÙØ±Ø¯ÙŠ/Ø¬Ù…Ø§Ø¹ÙŠ</title>
  <style>
    :root{--bg:#0b1020;--ink:#e5e7eb;--muted:#94a3b8;--line:#334155}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .btn{appearance:none;border:1px solid var(--line);background:#0b1220;color:var(--ink);border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{background:#0d1528}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .input,.select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
    .grid{display:grid;gap:12px}
    .grid-cards{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    .thumb{width:100%;aspect-ratio:4/5;background:#0b1220;border:1px solid rgba(255,255,255,.08);border-radius:12px;object-fit:cover}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px}
    .item{background:#0b1220;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:8px}
    .stack{display:flex;flex-direction:column;gap:8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="row" style="margin-bottom:10px">
      <div style="font-weight:800">ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒØ±ÙˆØª (Ù…Ø­Ù„ÙŠ) â€” ØªØ­Ù…ÙŠÙ„ ØµÙˆØ± + Ø±Ø¨Ø· Ø§Ù„Ø¶ÙŠÙˆÙ + Ø¥Ø±Ø³Ø§Ù„ ÙØ±Ø¯ÙŠ/Ø¬Ù…Ø§Ø¹ÙŠ</div>
      <div style="margin-inline-start:auto" class="row">
        <input id="searchBox" class="input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø±Ù‚Ù…/Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù" style="min-width:260px" />
        <select id="filterMode" class="select">
          <option value="all">Ø§Ù„ÙƒÙ„</option>
          <option value="paired">Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¶ÙŠÙˆÙ</option>
          <option value="unpaired">ØºÙŠØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</option>
        </select>
        <button id="btnSendAll" class="btn">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ</button>
        <button id="btnZipAll" class="btn">â¤“ ØªÙ†Ø²ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± (ZIP)</button>
      </div>
    </div>

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© -->
    <div class="card">
      <div class="row">
        <div style="flex:2">
          <div class="muted">Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</div>
          <textarea id="msgTemplate" rows="2" class="input" placeholder="{name}ØŒ Ø¯Ø¹ÙˆØªÙƒ Ù…Ø±ÙÙ‚Ø© Ø¨Ø§Ù„ØµÙˆØ±Ø©."></textarea>
          <div class="muted" style="font-size:12px">Ø§Ù„Ù…ØªØºÙŠÙ‘Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©: {name}</div>
        </div>
        <div style="flex:1">
          <div class="muted">Ù…Ù‡Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ (Ù…Ù„Ù‘ÙŠ Ø«Ø§Ù†ÙŠØ©ØŒ ØªÙÙØªØ­ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙÙŠ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©)</div>
          <input id="batchDelay" class="input" type="number" value="1200" />
        </div>
      </div>
    </div>

    <!-- Ø±ÙØ¹ Ø§Ù„ÙƒØ±ÙˆØª -->
    <div class="card">
      <div class="row">
        <div style="flex:2">
          <div class="muted">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ±ÙˆØª Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ</div>
          <input id="cardsInput" class="input" type="file" accept="image/*" multiple />
        </div>
        <div style="flex:1">
          <div class="muted">Ø¹Ø¯Ù‘Ø§Ø¯</div>
          <div class="badge"><span>ğŸ–¼ï¸</span><span id="countCards">0</span> ØµÙˆØ±Ø©</div>
        </div>
      </div>
    </div>

    <!-- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙŠÙˆÙ -->
    <div class="card">
      <div class="row">
        <div style="flex:1">
          <div class="muted">Ø£Ø¶Ù Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… (Ø³Ø·Ø± Ù„ÙƒÙ„ Ø¶ÙŠÙ: name, phone)</div>
          <textarea id="guestsText" rows="6" class="input" placeholder="Ø£Ø­Ù…Ø¯, 9665XXXXXXX
Ø³Ø§Ø±Ø©, 9665YYYYYYY"></textarea>
        </div>
        <div style="width:320px" class="stack">
          <div>
            <div class="muted">Ø£Ùˆ Ø§Ø±ÙØ¹ Ù…Ù„Ù Excel/CSV (Ø£ÙˆÙ„ Ø¹Ù…ÙˆØ¯ nameØŒ Ø«Ø§Ù†ÙŠ Ø¹Ù…ÙˆØ¯ phone)</div>
            <input id="csvInput" class="input" type="file" accept=".csv,.xlsx" />
          </div>
          <button id="btnParseGuests" class="btn">âœ”ï¸ ØªØ£ÙƒÙŠØ¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¶ÙŠÙˆÙ</button>
          <div class="badge"><span>ğŸ‘¤</span><span id="countGuests">0</span> Ø¶ÙŠÙ</div>
        </div>
      </div>
    </div>

    <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± -->
    <div class="card">
      <div class="row" style="margin-bottom:8px">
        <div class="muted">Ø§Ù„ÙƒØ±ÙˆØª + Ø±Ø¨Ø· Ø§Ù„Ø¶ÙŠÙˆÙ (ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø­Ø³Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§Ø› ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)</div>
      </div>
      <div id="grid" class="grid grid-cards"></div>
    </div>
  </div>

  <script>
    // ===== Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    const state = {
      cards: [],   // [{file, url, name}]
      guests: [],  // [{name, phone}]
      pairs: []    // index-wise pairing: pairs[i] = guestIndex for card i
    };

    const $ = (s,root=document)=>root.querySelector(s);
    const cardsInput = $('#cardsInput');
    const csvInput = $('#csvInput');
    const guestsText = $('#guestsText');
    const grid = $('#grid');

    function sanitizePhone(p){
      p = String(p||'').trim();
      // Ù†Ø³Ù…Ø­ Ø¨Ù€+ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ¨Ø§Ù‚ÙŠÙ‡Ø§ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
      p = p.replace(/\s+/g,'').replace(/(?!^)\+/g,'');
      if(!/^\+?\d+$/.test(p)) p = p.replace(/[^\d+]/g,'');
      return p;
    }

    function buildMessage(name){
      const t = ($('#msgTemplate').value||'').trim() || '{name}ØŒ Ø¯Ø¹ÙˆØªÙƒ Ù…Ø±ÙÙ‚Ø© Ø¨Ø§Ù„ØµÙˆØ±Ø©.';
      return t.replaceAll('{name}', name||'');
    }

    function openWhatsAppWebSameTab(phone, text){
      const url = `https://web.whatsapp.com/send?phone=${encodeURIComponent(sanitizePhone(phone))}&text=${encodeURIComponent(text)}`;
      // Ù†ÙØ³ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
      window.location.href = url;
    }

    function renderGrid(){
      const term = ($('#searchBox').value||'').toLowerCase().trim();
      const mode = ($('#filterMode').value||'all');
      grid.innerHTML = '';
      state.cards.forEach((card, i)=>{
        const gIdx = state.pairs[i];
        const g = gIdx>=0 ? state.guests[gIdx] : null;
        const hay = [card.name.toLowerCase(), (g?.name||'').toLowerCase(), (g?.phone||'').toLowerCase()].join(' ');
        if(term && !hay.includes(term)) return;
        if(mode==='paired' && !(gIdx>=0)) return;
        if(mode==='unpaired' && (gIdx>=0)) return;

        const item = document.createElement('div');
        item.className = 'item';
        const sel = document.createElement('select');
        sel.className = 'select';
        sel.innerHTML = `<option value="-1">â€” Ø§Ø®ØªØ± Ø¶ÙŠÙ â€”</option>` +
          state.guests.map((g, idx)=>`<option value="${idx}">${g.name} â€” ${sanitizePhone(g.phone)}</option>`).join('');
        sel.value = (state.pairs[i] ?? -1);
        sel.addEventListener('change', ()=>{ state.pairs[i] = parseInt(sel.value, 10); });

        const img = document.createElement('img'); img.className='thumb'; img.src=card.url; img.alt=card.name;
        const dl = document.createElement('a'); dl.className='btn'; dl.href=card.url; dl.download=card.name; dl.textContent='â¤“ ØªÙ†Ø²ÙŠÙ„';

        const phoneInput = document.createElement('input'); phoneInput.className='input mono'; phoneInput.placeholder='Ø±Ù‚Ù… Ø§Ù„Ø¶ÙŠÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)';

        const sendBtn = document.createElement('button'); sendBtn.className='btn'; sendBtn.textContent='ğŸ“² ÙˆØ§ØªØ³Ø§Ø¨ (ØªØ¨ÙˆÙŠØ¨ Ù†ÙØ³Ù‡)';
        sendBtn.addEventListener('click', ()=>{
          let phone = phoneInput.value.trim();
          if(!phone && gIdx>=0){ phone = state.guests[gIdx]?.phone || ''; }
          phone = sanitizePhone(phone);
          if(!phone){ alert('Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¶ÙŠÙ Ø£Ùˆ Ø§Ø±Ø¨Ø· Ø¶ÙŠÙÙ‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©'); return; }
          const guestName = (gIdx>=0? state.guests[gIdx]?.name : '') || '';
          const text = buildMessage(guestName);
          openWhatsAppWebSameTab(phone, text);
        });

        const meta = document.createElement('div'); meta.className='muted mono'; meta.textContent=card.name + (g? ` â†’ ${g.name}`:'');

        item.appendChild(img); item.appendChild(meta); item.appendChild(sel); item.appendChild(phoneInput);
        const row = document.createElement('div'); row.className='row'; row.appendChild(dl); row.appendChild(sendBtn);
        item.appendChild(row); grid.appendChild(item);
      });
    }

    async function sendAll(){
      const delay = Math.max(800, parseInt($('#batchDelay').value||'1200',10));
      const queue = [];
      state.cards.forEach((card,i)=>{ const gIdx = state.pairs[i]; if(gIdx>=0){ queue.push(state.guests[gIdx]); } });
      if(!queue.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¶ÙŠÙˆÙ'); return; }
      // Ù„Ù„ØªØ¬Ù…ÙŠØ¹ÙŠ: Ø³Ù†ÙØªØ­ ÙÙŠ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø­ØªÙ‰ Ù„Ø§ Ù†ÙÙ‚Ø¯ Ø§Ù„ØµÙØ­Ø©.
      for(let k=0;k<queue.length;k++){
        const g = queue[k];
        const phone = sanitizePhone(g.phone);
        const text = buildMessage(g.name);
        const url = `https://web.whatsapp.com/send?phone=${encodeURIComponent(phone)}&text=${encodeURIComponent(text)}`;
        window.open(url, '_blank');
        await new Promise(r=>setTimeout(r, delay));
      }
    }

    // Ù‚Ø±Ø§Ø¡Ø© CSV Ø¨Ø³ÙŠØ· name,phone
    function parseCSV(text){
      const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const rows = [];
      for(const ln of lines){
        const m = ln.split(',');
        if(m.length>=2){ rows.push({ name: m[0].trim(), phone: m[1].trim() }); }
      }
      return rows;
    }

    function buildGuestsFromText(){
      const txt = guestsText.value || '';
      return parseCSV(txt);
    }

    function autoPair(){
      state.pairs = state.cards.map((_,i)=> i < state.guests.length ? i : -1);
    }

    // ===== Ø£Ø­Ø¯Ø§Ø«
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('btnSendAll').addEventListener('click', sendAll);

      document.getElementById('btnParseGuests').addEventListener('click', ()=>{
        const g = buildGuestsFromText();
        state.guests = g;
        document.getElementById('countGuests').textContent = g.length;
        autoPair();
        renderGrid();
      });

      document.getElementById('csvInput').addEventListener('change', async ()=>{
        const f = document.getElementById('csvInput').files?.[0]; if(!f) return;
        if(/\.xlsx$/i.test(f.name)){
          // ØªØ­Ù…ÙŠÙ„ SheetJS Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© ÙÙ‚Ø·
          await new Promise(r=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'; s.onload=r; document.head.appendChild(s); });
          const data = await f.arrayBuffer();
          const wb = XLSX.read(data, {type:'array'});
          const ws = wb.Sheets[wb.SheetNames[0]];
          const arr = XLSX.utils.sheet_to_json(ws, {header:1});
          const rows = [];
          for(let i=0;i<arr.length;i++){
            const row = arr[i]; if(!row || row.length<2) continue; if(i===0 && /name/i.test(row[0]) && /phone/i.test(row[1])) continue; // ØªØ®Ø·Ù‘ÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            rows.push({ name: String(row[0]||'').trim(), phone: String(row[1]||'').trim() });
          }
          state.guests = rows; document.getElementById('countGuests').textContent = rows.length; autoPair(); renderGrid();
        } else {
          const text = await f.text();
          let rows = [];
          const first = (text.split(/\r?\n/)[0]||'');
          if(/name\s*,\s*phone/i.test(first)){
            rows = text.split(/\r?\n/).slice(1).filter(Boolean).map(l=>l.split(',')).filter(r=>r.length>=2).map(r=>({name:r[0].trim(), phone:r[1].trim()}));
          } else {
            rows = text.split(/\r?\n/).filter(Boolean).map(l=>l.split(',')).filter(r=>r.length>=2).map(r=>({name:r[0].trim(), phone:r[1].trim()}));
          }
          state.guests = rows; document.getElementById('countGuests').textContent = rows.length; autoPair(); renderGrid();
        }
      });

      document.getElementById('cardsInput').addEventListener('change', ()=>{
        const files = document.getElementById('cardsInput').files;
        state.cards = [...files].map(f=>({file:f, url:URL.createObjectURL(f), name:f.name}));
        document.getElementById('countCards').textContent = state.cards.length;
        autoPair();
        renderGrid();
      });

      document.getElementById('btnZipAll').addEventListener('click', async ()=>{
        const js1 = document.createElement('script'); js1.src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
        const js2 = document.createElement('script'); js2.src='https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js';
        await new Promise(r=>{ js1.onload=r; document.head.appendChild(js1); });
        await new Promise(r=>{ js2.onload=r; document.head.appendChild(js2); });
        const zip = new JSZip();
        for(const c of state.cards){ const res = await fetch(c.url); const blob = await res.blob(); zip.file(c.name, blob); }
        const blob = await zip.generateAsync({type:'blob'}); saveAs(blob, 'cards.zip');
      });

      document.getElementById('searchBox').addEventListener('input', renderGrid);
      document.getElementById('filterMode').addEventListener('change', renderGrid);
    });
  </script>
</body>
</html>
