<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez — صفحة العميل لإرسال الدعوات</title>
  <style>
    :root{--bg:#0b1020;--ink:#e5e7eb;--muted:#94a3b8;--line:#334155;--card:#0e172a;--ok:#16a34a;--bad:#dc2626;--warn:#f59e0b}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .container{max-width:1200px;margin:0 auto;padding:14px}
    .topbar{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid #243047}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .btn{appearance:none;border:1px solid var(--line);background:#0b1220;color:var(--ink);border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn:hover{background:#0d1528}
    .select,.input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
    .grid{display:grid;gap:12px}
    @media(min-width:1024px){.grid-3{grid-template-columns:1.5fr 1fr 1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-top:1px solid rgba(255,255,255,.08)}
    thead th{position:sticky;top:0;background:#0e162c}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0b1220}
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="container row" style="justify-content:space-between">
      <div class="row" style="gap:12px">
        <div class="logo" style="width:38px;height:38px;border-radius:10px;background:#111;border:1px solid #333;display:grid;place-items:center"><span style="font-weight:900;color:#ffd700">HS</span></div>
        <div>
          <div class="muted" style="font-size:12px">HORMEZ</div>
          <div id="tbTitle" style="font-weight:800">صفحة العميل لإرسال الدعوات</div>
          <div id="tbSub" class="muted" style="font-size:12px">CSV/Excel للضيوف + رسالة واتساب + إرسال جماعي/فردي</div>
        </div>
      </div>
      <div class="row">
        <button id="langBtn" class="btn">EN</button>
        <button id="helpBtn" class="btn">؟</button>
      </div>
    </div>
  </div>

  <div class="container grid grid-3">
    <!-- (1) استيراد الضيوف -->
    <div class="card">
      $1
      <div class="row" style="margin-top:10px">
        <button id="pickContactsBtn" class="btn">📇 استيراد من جهات الاتصال (تجريبي)</button>
        <span class="muted" style="font-size:12px">قد لا يعمل على كل المتصفحات</span>
      </div>
      <div style="margin-top:6px">
        <input type="file" id="fileInput" class="input" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />
      </div>
      <div style="margin-top:8px" class="muted" id="fmtHint">الصيغة: name, phone[, count]</div>
      <div style="margin-top:8px">
        <textarea id="pasteArea" rows="5" class="input" placeholder="name, phone\nname2, phone2"></textarea>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="parseBtn" class="btn">إضافة المدخلات</button>
        <button id="clearAllBtn" class="btn">مسح القائمة</button>
      </div>
      <div style="margin-top:8px" class="muted" id="exHint">مثال CSV: علي, 0551234567, 2</div>
    </div>

    <!-- (2) إعدادات الإرسال -->
    <div class="card">
      <div class="muted" id="secSettings">إعدادات الإرسال</div>
      <div style="margin-top:8px">
        <div class="muted" id="lblEvent">اسم الحدث</div>
        <input id="eventName" class="input" placeholder="زفاف سعيد" />
      </div>
      <div style="margin-top:8px">
        <div class="muted" id="lblDefaultQty">عدد الدعوات الافتراضي</div>
        <input id="defaultQty" class="input" type="number" min="1" value="1" />
      </div>
      <div style="margin-top:8px">
        <div class="muted" id="lblCc">بادئة الدولة (اختياري)</div>
        <input id="countryCode" class="input" placeholder="مثال: 966 بدون +" />
      </div>
      <div style="margin-top:8px">
        <div class="muted" id="lblDelay">تأخير بين الفتحات (ms)</div>
        <input id="openDelay" class="input" type="number" min="0" value="800" />
      </div>
      <div style="margin-top:8px">
        <div class="muted" id="lblMsg">نص رسالة واتساب</div>
        <textarea id="waTemplate" rows="6" class="input" placeholder="مرحبًا {{name}}، يسعدنا دعوتك لحضور {{event}}. عدد الدعوات: {{count}}.">مرحبًا {{name}}، يسعدنا دعوتك لحضور {{event}}. عدد الدعوات: {{count}}.</textarea>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="applyDefaultBtn" class="btn">تطبيق العدد الافتراضي</button>
        <button id="exportBtn" class="btn">تصدير CSV</button>
      </div>
    </div>

    <!-- (3) إرسال/فلترة -->
    <div class="card">
      <div class="muted" id="secActions">الإرسال والفلترة</div>
      <div style="margin-top:8px">
        <div class="muted" id="lblSearch">بحث</div>
        <input id="searchInput" class="input" placeholder="ابحث بالاسم أو الرقم" />
      </div>
      <div class="row" style="margin-top:8px">
        <button id="bulkSendBtn" class="btn">إرسال جماعي (WhatsApp Web)</button>
        <button id="previewBtn" class="btn">معاينة 10 رسائل</button>
      </div>
      <div style="margin-top:8px" class="muted" id="waNote">سيتم فتح WhatsApp Web مع نص الرسالة جاهز. لا يمكن إرفاق صورة تلقائيًا من المتصفح — أرفق صورتك يدويًا داخل المحادثة.</div>
    </div>
  </div>

  <!-- جدول الضيوف -->
  <div class="container card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="muted" id="tblTitle">قائمة الضيوف</div>
      <span class="tag"><span id="stats">—</span></span>
    </div>
    <div style="max-height:55vh;overflow:auto;margin-top:8px">
      <table>
        <thead>
          <tr>
            <th id="thName">الاسم</th>
            <th id="thPhone">الرقم</th>
            <th id="thQty">العدد</th>
            <th id="thSend">إرسال</th>
          </tr>
        </thead>
        <tbody id="rowsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- PapaParse (CSV/Excel via SheetJS-lite alt) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const $ = (s, root=document) => root.querySelector(s);

    // ===== i18n =====
    const T = {
      ar: { title:'صفحة العميل لإرسال الدعوات', sub:'CSV/Excel للضيوف + رسالة واتساب + إرسال جماعي/فردي', import:'استيراد الضيوف', fmt:'الصيغة: name, phone[, count]', example:'مثال CSV: علي, 0551234567, 2', settings:'إعدادات الإرسال', event:'اسم الحدث', defQty:'عدد الدعوات الافتراضي', cc:'بادئة الدولة (اختياري)', delay:'تأخير بين الفتحات (ms)', msg:'نص رسالة واتساب', apply:'تطبيق العدد الافتراضي', export:'تصدير CSV', actions:'الإرسال والفلترة', search:'بحث', bulk:'إرسال جماعي (WhatsApp Web)', preview:'معاينة 10 رسائل', note:'سيتم فتح WhatsApp Web مع نص الرسالة جاهز. لا يمكن إرفاق صورة تلقائيًا من المتصفح — أرفق صورتك يدويًا داخل المحادثة.', guests:'قائمة الضيوف', name:'الاسم', phone:'الرقم', qty:'العدد', send:'إرسال', added:'تمت الإضافة', cleared:'تم المسح', noRows:'لا توجد بيانات', stats:(n)=>`الكل: ${n}` },
      en: { title:"Client — Invite Sender", sub:"CSV/Excel contacts + WhatsApp text + Bulk/Single send", import:"Import guests", fmt:"Format: name, phone[, count]", example:"CSV example: Ali, 0551234567, 2", settings:"Send settings", event:"Event name", defQty:"Default invites per guest", cc:"Country prefix (optional)", delay:"Open delay (ms)", msg:"WhatsApp message", apply:"Apply default", export:"Export CSV", actions:"Send & Filter", search:"Search", bulk:"Bulk send (WhatsApp Web)", preview:"Preview 10", note:"WhatsApp Web will open with prefilled text. Browsers can't auto-attach images — attach your image manually.", guests:"Guest list", name:"Name", phone:"Phone", qty:"Qty", send:"Send", added:"Added", cleared:"Cleared", noRows:"No data", stats:(n)=>`Total: ${n}` }
    };
    let LANG = localStorage.getItem('hs:client:lang') || 'ar';

    function applyLang(){
      const L=T[LANG]; document.documentElement.lang=LANG; document.documentElement.dir=(LANG==='ar')?'rtl':'ltr';
      $('#langBtn').textContent = (LANG==='ar')? 'EN' : 'AR';
      $('#tbTitle').textContent=L.title; $('#tbSub').textContent=L.sub;
      $('#secImport').textContent=L.import; $('#fmtHint').textContent=L.fmt; $('#exHint').textContent=L.example;
      $('#secSettings').textContent=L.settings; $('#lblEvent').textContent=L.event; $('#lblDefaultQty').textContent=L.defQty; $('#lblCc').textContent=L.cc; $('#lblDelay').textContent=L.delay; $('#lblMsg').textContent=L.msg; $('#applyDefaultBtn').textContent=L.apply; $('#exportBtn').textContent=L.export;
      $('#secActions').textContent=L.actions; $('#lblSearch').textContent=L.search; $('#bulkSendBtn').textContent=L.bulk; $('#previewBtn').textContent=L.preview; $('#waNote').textContent=L.note;
      $('#tblTitle').textContent=L.guests; $('#thName').textContent=L.name; $('#thPhone').textContent=L.phone; $('#thQty').textContent=L.qty; $('#thSend').textContent=L.send;
      render();
    }

    // ===== State =====
    let rows = JSON.parse(localStorage.getItem('hs:client:rows')||'[]');

    function save(){ localStorage.setItem('hs:client:rows', JSON.stringify(rows)); }

    function addRows(list){
      const defQty = parseInt($('#defaultQty').value||'1',10) || 1;
      for(const r of list){
        const name = (r.name||r[0]||'').toString().trim();
        const phone= (r.phone||r[1]||'').toString().trim();
        const qty  = parseInt((r.count||r[2]||defQty),10) || defQty;
        if(!name || !phone) continue;
        rows.push({name, phone, qty});
      }
      save(); render(); toast(T[LANG].added);
    }

    function clearAll(){ rows=[]; save(); render(); toast(T[LANG].cleared); }

    function render(){
      const L=T[LANG];
      const q=($('#searchInput').value||'').toLowerCase().trim();
      const body=$('#rowsBody'); body.innerHTML='';
      const filtered = rows.filter(r => !q || r.name.toLowerCase().includes(q) || r.phone.includes(q));
      $('#stats').textContent = L.stats(filtered.length);
      if(filtered.length===0){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=4; td.className='muted'; td.style.textAlign='center'; td.style.padding='18px'; td.textContent=L.noRows; tr.appendChild(td); body.appendChild(tr); return; }
      filtered.forEach((r,idx)=>{
        const tr=document.createElement('tr');
        // name
        const td1=document.createElement('td'); td1.textContent=r.name; tr.appendChild(td1);
        // phone
        const td2=document.createElement('td'); td2.className='mono'; td2.textContent=r.phone; tr.appendChild(td2);
        // qty
        const td3=document.createElement('td'); const inp=document.createElement('input'); inp.type='number'; inp.min='1'; inp.value=r.qty; inp.className='input'; inp.style.width='110px'; inp.onchange=()=>{ r.qty = Math.max(1, parseInt(inp.value||'1',10)||1); save(); }; td3.appendChild(inp); tr.appendChild(td3);
        // send
        const td4=document.createElement('td'); const b=document.createElement('button'); b.className='btn'; b.textContent=L.send; b.onclick=()=> openWA(r); td4.appendChild(b); tr.appendChild(td4);
        body.appendChild(tr);
      });
    }

    // ===== WhatsApp helpers =====
    function buildPhone(phone){
      const cc = ($('#countryCode').value||'').replace(/[^0-9]/g,'');
      let p = phone.replace(/[^0-9]/g,'');
      if(cc && !p.startsWith(cc)) p = cc + p.replace(/^0+/, '');
      return p;
    }
    function tpl(str, ctx){ return str.replace(/\{\{(\w+)\}\}/g, (_,k)=> (ctx[k] ?? '')); }
    function openWA(rec){
      const event = $('#eventName').value.trim();
      const msgTpl = $('#waTemplate').value;
      const text = tpl(msgTpl, { name: rec.name, count: rec.qty, event });
      const phone = buildPhone(rec.phone);
      if(!phone){ alert('رقم غير صالح'); return; }
      const url = `https://wa.me/${encodeURIComponent(phone)}?text=${encodeURIComponent(text)}`;
      window.open(url, '_blank');
    }

    async function bulkSend(limit=10){
      const L=T[LANG];
      const event = $('#eventName').value.trim();
      if(!event){ alert(L.event+': ?'); return; }
      const msgTpl = $('#waTemplate').value; const delay = Math.max(0, parseInt($('#openDelay').value||'800',10));
      const q=($('#searchInput').value||'').toLowerCase().trim();
      const list = rows.filter(r => !q || r.name.toLowerCase().includes(q) || r.phone.includes(q));
      if(!list.length){ alert(L.noRows); return; }
      let opened = 0;
      for(const r of list){
        const text=tpl(msgTpl,{name:r.name,count:r.qty,event});
        const phone=buildPhone(r.phone); if(!phone) continue;
        const url=`https://wa.me/${encodeURIComponent(phone)}?text=${encodeURIComponent(text)}`;
        window.open(url, '_blank'); opened++;
        if(opened>=limit){ await new Promise(res=>setTimeout(res, delay)); opened=0; }
      }
    }

    function exportCSV(){
      const L=T[LANG];
      const header=['name','phone','count'];
      const lines = rows.map(r=> [r.name, r.phone, r.qty].join(','));
      const csv=[header.join(','), ...lines].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='guests.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // ===== CSV parsing =====
    function parseText(text){
      const res = Papa.parse(text, { header:false, skipEmptyLines:true });
      const list = res.data.map(row=>({ name: (row[0]||'').toString(), phone:(row[1]||'').toString(), count: row[2] }));
      addRows(list);
    }

    function parseFile(file){
      if(!file) return;
      const ext = (file.name.split('.').pop()||'').toLowerCase();
      if(ext==='csv'){
        Papa.parse(file, { header:true, skipEmptyLines:true, complete: (res)=>{
          // If headerless CSV, reparse without header
          if(res.meta.fields && res.meta.fields.length>=2 && (res.data[0] && (res.data[0].name||res.data[0].phone))){
            const list = res.data.map(r=>({ name:r.name||'', phone:r.phone||'', count:r.count })); addRows(list);
          } else {
            Papa.parse(file, { header:false, skipEmptyLines:true, complete:(res2)=>{
              const list = res2.data.map(row=>({ name:(row[0]||'').toString(), phone:(row[1]||'').toString(), count: row[2] })); addRows(list);
            }});
          }
        }});
      } else {
        alert('فضلاً ارفع CSV. (Excel غير مدعوم في هذه النسخة المستقلة بدون مكتبات إضافية)');
      }
    }

    // ===== Contacts Picker (experimental) =====
    async function pickContacts(){
      try{
        if(!('contacts' in navigator) || !('select' in navigator.contacts)){
          alert('المتصفح لا يدعم استيراد جهات الاتصال مباشرة. استخدم CSV.');
          return;
        }
        const props=['name','tel'];
        const opts={ multiple:true };
        const selected = await navigator.contacts.select(props, opts);
        if(!selected || !selected.length) return;
        const mapped = selected.map(c=>{
          const name = Array.isArray(c.name)? (c.name[0]||'') : (c.name||'');
          const tel  = Array.isArray(c.tel)?  (c.tel[0]||'')  : (c.tel||'');
          return { name, phone: tel, count: 1 };
        }).filter(x=> x.name && x.phone);
        if(mapped.length) addRows(mapped);
      }catch(e){ alert('تعذر الوصول لجهات الاتصال: '+ (e.message||e)); }
    }

    // ===== UI wiring =====
    function toast(msg){ const t=document.createElement('div'); t.className='tag'; t.textContent=msg; t.style.position='fixed'; t.style.left='50%'; t.style.transform='translateX(-50%)'; t.style.top='12px'; t.style.zIndex='50'; document.body.appendChild(t); setTimeout(()=>t.remove(),1500); }

    document.addEventListener('DOMContentLoaded', ()=>{
      applyLang();
      $('#langBtn').addEventListener('click', ()=>{ LANG=(LANG==='ar')?'en':'ar'; localStorage.setItem('hs:client:lang',LANG); applyLang(); });
      $('#parseBtn').addEventListener('click', ()=> parseText($('#pasteArea').value||''));
      $('#fileInput').addEventListener('change', (e)=> parseFile(e.target.files?.[0]));
      $('#clearAllBtn').addEventListener('click', clearAll);
      $('#applyDefaultBtn').addEventListener('click', ()=>{ const n=Math.max(1, parseInt($('#defaultQty').value||'1',10)||1); rows.forEach(r=>r.qty=n); save(); render(); });
      $('#exportBtn').addEventListener('click', exportCSV);
      $('#searchInput').addEventListener('input', render);
      $('#bulkSendBtn').addEventListener('click', ()=> bulkSend(8));
      $('#previewBtn').addEventListener('click', ()=>{
        const L=T[LANG];
        const event=$('#eventName').value.trim(); const q=($('#searchInput').value||'').toLowerCase().trim();
        const list=rows.filter(r=>!q || r.name.toLowerCase().includes(q) || r.phone.includes(q)).slice(0,10);
        if(!list.length) { alert(L.noRows); return; }
        const msgTpl=$('#waTemplate').value; const preview=list.map(r=> T[LANG]===T.ar? `إلى ${r.name} (${r.phone}) → ${msgTpl.replace(/\{\{name\}\}/g,r.name).replace(/\{\{count\}\}/g,r.qty).replace(/\{\{event\}\}/g,event)}` : `To ${r.name} (${r.phone}) → ${msgTpl.replace(/\{\{name\}\}/g,r.name).replace(/\{\{count\}\}/g,r.qty).replace(/\{\{event\}\}/g,event)}` ).join('\n\n');
        alert(preview);
      });
      $1
      $('#pickContactsBtn').addEventListener('click', pickContacts);
      });
    });
  </script>
</body>
</html>
