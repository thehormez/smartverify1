<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez â€” Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª + ØªÙ†Ø²ÙŠÙ„/Ø±ÙØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</title>
  <style>
    :root{--bg:#0b1020;--ink:#e5e7eb;--muted:#94a3b8;--line:#334155;--card:#0e172a}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;gap:12px}
    @media(min-width:1120px){.grid-2{grid-template-columns:430px 1fr}}
    .card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .btn{appearance:none;border:1px solid var(--line);background:#0b1220;color:var(--ink);border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:#0d1528}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .select,.input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
    label{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-top:1px solid rgba(255,255,255,.08)}
    thead th{position:sticky;top:0;background:#0e162c}
    .status-badge{padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.2);font-size:12px}
    .ok{color:#86efac;border-color:#16a34a} .warn{color:#fbbf24;border-color:#f59e0b} .err{color:#fca5a5;border-color:#ef4444}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Courier New",monospace}
    .muted{color:var(--muted)}
    #preview{width:100%;background:#0b1220;border-radius:12px;display:block;max-height:55vh}
    .tiny{font-size:11px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <div class="row" style="margin-bottom:8px">
      <div style="font-weight:800">ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ù„Ù„Ø¶ÙŠÙˆÙ + ØªÙ†Ø²ÙŠÙ„/Ø±ÙØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</div>
      <div style="margin-inline-start:auto" class="row">
        <button id="langBtn" class="btn">AR</button>
      </div>
    </div>

    <div class="grid grid-2">
      <!-- Left controls -->
      <div class="card">
        <div class="row">
          <div style="flex:1">
            <label id="lblEvent">Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«</label>
            <input id="eventName" class="input" placeholder="Ù…Ø«Ø§Ù„: Ø²ÙØ§Ù Ø³Ø¹ÙŠØ¯" />
          </div>
          <div style="width:130px">
            <label id="lblCountry">Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©</label>
            <input id="countryCode" class="input" value="+966" />
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label id="lblBaseUrl">Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© (ÙŠÙØ¶Ø§Ù Ù„Ù‡ Ø§Ù„ÙƒÙˆØ¯)</label>
            <input id="baseUrl" class="input" placeholder="https://example.com/invite?code=" />
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label id="lblChannel">Ù‚Ù†Ø§Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>
            <select id="channel" class="select">
              <option value="whatsapp">WhatsApp</option>
              <option value="sms">SMS</option>
            </select>
          </div>
          <div style="flex:1">
            <label id="lblLang">Ù„ØºØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
            <select id="msgLang" class="select">
              <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label id="lblTemplate">Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
            <textarea id="msgTemplate" rows="6" class="input" placeholder="{name}ØŒ ÙŠØ³Ø¹Ø¯Ù†Ø§ Ø¯Ø¹ÙˆØªÙƒ Ù„Ø­Ø¶ÙˆØ± {event}. ÙƒÙˆØ¯Ùƒ: {code}\nØ§Ù„Ø±Ø§Ø¨Ø·: {link}\nØ§Ù„ØµÙˆØ±Ø©: {image}"></textarea>
            <div class="tiny">Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª: {name} {event} {code} {link} {image}</div>
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label id="lblCsv">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¶ÙŠÙˆÙ (CSV: name, phone, code)</label>
            <input id="csvFile" type="file" accept=".csv" class="input" />
          </div>
        </div>
        <div class="row">
          <button id="btnFetch" class="btn">Ø¬Ù„Ø¨ Ù…Ù† Firestore</button>
          <button id="btnAddRow" class="btn">Ø¥Ø¶Ø§ÙØ© Ø¶ÙŠÙ</button>
          <button id="btnClear" class="btn">Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        </div>
        <hr style="border-color:rgba(255,255,255,.1)" />

        <!-- ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„ØªÙˆÙ„ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©/Ø§Ù„ØªÙˆÙ„ÙŠØ¯) -->
        <div class="row">
          <div style="flex:1">
            <label>ØµÙˆØ±Ø© ÙƒØ±Øª Ø§Ù„Ø¯Ø¹ÙˆØ© (Ù‡Ø°Ù‡ ØªÙØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª ØªÙˆÙ„ÙŠØ¯ Ø¨Ø·Ø§Ù‚Ø© Ù„ÙƒÙ„ Ø¶ÙŠÙ)</label>
            <input id="cardImage" type="file" accept="image/png,image/jpeg" class="input" />
            <div class="tiny">Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ØŒ Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© Ø¨Ø§Ù„Ø£Ø³ÙÙ„ ÙƒÙ…Ø§ Ù‡ÙŠ.</div>
          </div>
        </div>
        <div class="row">
          <div style="width:120px">
            <label>Ø­Ø¬Ù… QR</label>
            <input id="qrSize" type="number" class="input" value="300" />
          </div>
          <div style="width:120px">
            <label>Ù…ÙˆØ¶Ø¹ X</label>
            <input id="posX" type="number" class="input" value="100" />
          </div>
          <div style="width:120px">
            <label>Ù…ÙˆØ¶Ø¹ Y</label>
            <input id="posY" type="number" class="input" value="100" />
          </div>
        </div>
        <div class="row">
          <div style="width:120px">
            <label>Ø­Ø¬Ù… Ø®Ø· Ø§Ù„ÙƒÙˆØ¯</label>
            <input id="fontSize" type="number" class="input" value="36" />
          </div>
          <div style="width:160px">
            <label>Ø¥Ø²Ø§Ø­Ø© Ø§Ù„Ù†Øµ Ø£Ø³ÙÙ„ Ø§Ù„Ù€QR</label>
            <input id="textOffset" type="number" class="input" value="20" />
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>Ù„ÙˆÙ† Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
            <input id="qrColor" type="color" class="input" value="#000000" />
          </div>
          <div style="flex:1">
            <label>Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
            <input id="bgColor" type="color" class="input" value="#ffffff" />
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>Ù„ÙˆÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø©</label>
            <input id="textColor" type="color" class="input" value="#ffffff" />
          </div>
        </div>

        <!-- Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ÙØ±Ø³Ù„Ø© ÙƒÙ…Ø§ Ù‡ÙŠ -->
        <div class="row" style="align-items:center"><b>Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø±Ø³Ù„Ø©</b></div>
        <div class="row" style="gap:12px">
          <div style="flex:1">
            <label>ğŸ”¹ ÙƒØ±Øª Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø£ØµÙ„ÙŠ (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„)</label>
            <input id="plainCardImage" type="file" accept="image/png,image/jpeg" class="input" />
            <div class="row"><button id="btnUploadPlain" class="btn">Ø±ÙØ¹ Ø¥Ù„Ù‰ Ø§Ù„ØªØ®Ø²ÙŠÙ†</button><span id="plainStatus" class="tiny"></span></div>
          </div>
          <div style="flex:1">
            <label>ğŸ”¸ ÙƒØ±Øª Ù…Ø¯Ù…Ø¬ Ø¨Ø§Ù„Ù€QR (Ù…Ù† new-merge-qr.html)</label>
            <input id="qrCardImage" type="file" accept="image/png,image/jpeg" class="input" />
            <div class="row"><button id="btnUploadQRCard" class="btn">Ø±ÙØ¹ Ø¥Ù„Ù‰ Ø§Ù„ØªØ®Ø²ÙŠÙ†</button><span id="qrCardStatus" class="tiny"></span></div>
          </div>
        </div>
        <div class="row" style="align-items:center;gap:10px">
          <label>Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„: </label>
          <label class="row"><input type="radio" name="imgMode" value="none" checked /> Ø¨Ø¯ÙˆÙ† ØµÙˆØ±Ø©</label>
          <label class="row"><input type="radio" name="imgMode" value="plain" /> Ø±Ø§Ø¨Ø· ÙƒØ±Øª Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø£ØµÙ„ÙŠ</label>
          <label class="row"><input type="radio" name="imgMode" value="qr" /> Ø±Ø§Ø¨Ø· ÙƒØ±Øª Ø§Ù„Ù€QR Ø§Ù„Ø¬Ø§Ù‡Ø²</label>
        </div>
        <div class="tiny">Ù…Ù„Ø§Ø­Ø¸Ø©: ÙˆØ§ØªØ³Ø§Ø¨/SMS Ø¹Ø¨Ø± Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ±ÙÙ‚Ø§Ù† Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¨Ø§Ø´Ø±Ø©Ø› Ù„Ø°Ù„Ùƒ Ù†Ø±ÙØ¹Ù‡Ø§ Ø¥Ù„Ù‰ Firebase Storage ÙˆÙ†Ø¶ÙŠÙ <b>Ø§Ù„Ø±Ø§Ø¨Ø·</b> Ø¯Ø§Ø®Ù„ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.</div>

        <div class="row">
          <button id="btnPreviewCard" class="btn">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø·Ø§Ù‚Ø©</button>
          <button id="btnZipCards" class="btn">ØªÙ†Ø²ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (ZIP)</button>
          <button id="btnZipQrs" class="btn">ØªÙ†Ø²ÙŠÙ„ ÙƒÙ„ Ø£ÙƒÙˆØ§Ø¯ QR (ZIP)</button>
          <button id="btnSendAll" class="btn">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ÙƒÙ„ (Ø¹Ù„Ù‰ Ø¯ÙØ¹Ø§Øª)</button>
        </div>
      </div>

      <!-- Right table -->
      <div class="card">
        <div class="row" style="margin-bottom:6px"><span class="muted">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</span><span id="countBadge" class="muted" style="margin-inline-start:auto">0 Ø¶ÙŠÙ</span></div>
        <div style="max-height:60vh;overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                <th>Ø§Ù„ÙƒÙˆØ¯</th>
                <th>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>ØªÙ†Ø²ÙŠÙ„</th>
                <th>Ø¥Ø±Ø³Ø§Ù„</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
        <canvas id="preview" style="display:none"></canvas>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>

  <script>
    (function(){
      const $=(s,root=document)=>root.querySelector(s);
      const STR={ ar:{title:'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ù„Ù„Ø¶ÙŠÙˆÙ',pending:'Ø¬Ø§Ù‡Ø²',sent:'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„',failed:'ÙØ´Ù„',download:'Ø¨Ø·Ø§Ù‚Ø©',downloadQR:'QR'}, en:{title:'Send invites',pending:'Ready',sent:'Sent',failed:'Failed',download:'Card',downloadQR:'QR'} };
      let LANG=localStorage.getItem('hs:send:lang')||'ar'; function L(k){return (STR[LANG]||STR.ar)[k]||k}
      document.title = `Hormez â€” ${L('title')}`;

      // ===== Firebase =====
      const cfg={ apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac", authDomain:"hormez-inv.firebaseapp.com", projectId:"hormez-inv", storageBucket:"hormez-inv.firebasestorage.app" };
      try{ if(!firebase.apps.length){firebase.initializeApp(cfg);} }catch{}
      const db=(()=>{ try{return firebase.firestore();}catch{return null} })();
      const storage=(()=>{ try{return firebase.storage();}catch{return null} })();

      // Ù…Ù„ÙØ§Øª ÙˆØ±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© ÙƒÙ…Ø§ Ù‡ÙŠ
      const uploaded = { plain: { file:null, url:'' }, qr: { file:null, url:'' } };

      const state={ rows:[], cardImg:null };

      function normalizePhone(p, cc){ p = String(p||'').replace(/[^\d+]/g,''); if(p.startsWith('0')) p = p.replace(/^0+/, ''); if(!p.startsWith('+')) p = (cc||'') + p; return p; }
      function buildLink(code){ const base = ($('#baseUrl').value||'').trim(); const u = base.includes('?')? base + '&code=' + encodeURIComponent(code) : base + (base.endsWith('=')? '' : '?code=') + encodeURIComponent(code); return u; }

      // ===== Table render =====
      function render(){ const tb=$('#rows'); tb.innerHTML=''; $('#countBadge').textContent= state.rows.length + (LANG==='ar'? ' Ø¶ÙŠÙ':' guests'); state.rows.forEach((r,i)=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td contenteditable="true">${r.name||''}</td>
                         <td contenteditable="true" class="mono">${r.phone||''}</td>
                         <td contenteditable="true" class="mono">${r.code||''}</td>
                         <td class="mono">${previewMsg(r).replace(/</g,'&lt;')}</td>
                         <td><span class="status-badge ${r.status==='sent'?'ok':(r.status==='failed'?'err':'warn')}">${r.status||L('pending')}</span></td>
                         <td><button class="btn" data-dlcard="${i}">${L('download')}</button> <button class="btn" data-dlqr="${i}">${L('downloadQR')}</button></td>
                         <td><button class="btn" data-send="${i}">Ø¥Ø±Ø³Ø§Ù„</button> <button class="btn" data-del="${i}">Ø­Ø°Ù</button></td>`;
          tb.appendChild(tr);
        });
        tb.querySelectorAll('button[data-send]').forEach(b=> b.addEventListener('click', ()=> sendOne(parseInt(b.getAttribute('data-send'),10))));
        tb.querySelectorAll('button[data-del]').forEach(b=> b.addEventListener('click', ()=> { const j=parseInt(b.getAttribute('data-del'),10); state.rows.splice(j,1); render(); }));
        tb.querySelectorAll('button[data-dlqr]').forEach(b=> b.addEventListener('click', ()=> downloadQR(parseInt(b.getAttribute('data-dlqr'),10))));
        tb.querySelectorAll('button[data-dlcard]').forEach(b=> b.addEventListener('click', ()=> downloadCard(parseInt(b.getAttribute('data-dlcard'),10))));
        tb.querySelectorAll('td[contenteditable]').forEach((cell)=>{ cell.addEventListener('blur', ()=>{ const rowIndex = [...cell.parentElement.parentElement.children].indexOf(cell.parentElement); const colIndex = [...cell.parentElement.children].indexOf(cell); const cols=['name','phone','code']; if(colIndex<3){ state.rows[rowIndex][cols[colIndex]] = cell.textContent.trim(); render(); } }); });
      }

      function tmpl(extra){
        const ar = `{name}ØŒ ÙŠØ³Ø¹Ø¯Ù†Ø§ Ø¯Ø¹ÙˆØªÙƒ Ù„Ø­Ø¶ÙˆØ± {event}.\nÙƒÙˆØ¯Ùƒ: {code}\nØ§Ù„Ø±Ø§Ø¨Ø·: {link}\nØ§Ù„ØµÙˆØ±Ø©: {image}`;
        const en = `Dear {name}, you're invited to {event}.\nYour code: {code}\nLink: {link}\nImage: {image}`;
        const cur = ($('#msgTemplate').value||'').trim();
        const lang=$('#msgLang').value; const base = cur || (lang==='ar'? ar: en);
        return base.replaceAll('{image}', (extra?.image)||'');
      }
      function previewMsg(r, extra){ const link=buildLink(r.code); const t=tmpl(extra); return t.replaceAll('{name}', r.name||'').replaceAll('{event}', $('#eventName').value||'').replaceAll('{code}', r.code||'').replaceAll('{link}', link); }

      function openWhatsApp(phone, text){ const url = `https://wa.me/${phone.replace(/[^\d]/g,'')}?text=${encodeURIComponent(text)}`; window.open(url, '_blank'); }
      function openSMS(phone, text){ const url = `sms:${encodeURIComponent(phone)}?&body=${encodeURIComponent(text)}`; window.open(url, '_blank'); }

      function makeQRCanvas(text, size, colorDark, colorLight){ const holder=document.createElement('div'); new QRCode(holder,{text,width:size,height:size,colorDark,colorLight,correctLevel:QRCode.CorrectLevel.M}); return holder.querySelector('canvas'); }
      function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
      async function drawCard(canvas, code){ const ctx=canvas.getContext('2d'); const img=state.cardImg; if(!img){ const size=parseInt($('#qrSize').value||'300',10); const qr=makeQRCanvas(code, size, $('#qrColor').value||'#000', $('#bgColor').value||'#fff'); canvas.width=size; canvas.height=size; ctx.clearRect(0,0,size,size); ctx.drawImage(qr,0,0,size,size); return; }
        const w=img.naturalWidth, h=img.naturalHeight; canvas.width=w; canvas.height=h; ctx.clearRect(0,0,w,h); ctx.drawImage(img,0,0,w,h);
        const size=parseInt($('#qrSize').value||'300',10); let x=parseInt($('#posX').value||'0',10); let y=parseInt($('#posY').value||'0',10); x=clamp(x,0,Math.max(0,w-size)); y=clamp(y,0,Math.max(0,h-size));
        const qr=makeQRCanvas(code, size, $('#qrColor').value||'#000', $('#bgColor').value||'#fff'); ctx.drawImage(qr, x, y, size, size);
        const fontSize=parseInt($('#fontSize').value||'36',10); const toff=parseInt($('#textOffset').value||'20',10); ctx.fillStyle=$('#textColor').value||'#fff'; ctx.font=`bold ${fontSize}px ui-monospace,Menlo,Consolas,'Courier New',monospace`; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillText(code, x+size/2, y+size+toff);
      }

      async function downloadQR(idx){ const r=state.rows[idx]; if(!r) return; const size=parseInt($('#qrSize').value||'300',10); const qr=makeQRCanvas(r.code, size, $('#qrColor').value||'#000', $('#bgColor').value||'#fff'); const url=qr.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download=`${r.code}.png`; a.click(); }
      async function downloadCard(idx){ const r=state.rows[idx]; if(!r) return; const canvas=$('#preview'); await drawCard(canvas, r.code); const url=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download=`card-${r.code}.png`; a.click(); }

      // Ø±ÙØ¹ Blob ÙˆØ¥Ø±Ø¬Ø§Ø¹ URL
      async function uploadBlobAndGetURL(path, blob){
        if(!storage) throw new Error('Firebase Storage ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„');
        const ref = storage.ref().child(path);
        await ref.put(blob, { contentType: 'image/png', cacheControl:'public,max-age=31536000' });
        return await ref.getDownloadURL();
      }
      // Ø±ÙØ¹ Ù…Ù„Ù input ÙƒÙ…Ø§ Ù‡Ùˆ
      async function uploadFileInput(inputEl, which){
        const f=inputEl.files?.[0];
        if(!f){ alert('Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§ Ø£ÙˆÙ„Ù‹Ø§'); return ''; }
        const ev=($('#eventName').value||'event').replace(/\s+/g,'_');
        const path=`invites/${ev}/${which}.png`;
        const url=await uploadBlobAndGetURL(path, f);
        uploaded[which].file=f; uploaded[which].url=url;
        return url;
      }

      async function sendOne(idx){
        const r=state.rows[idx]; if(!r) return;
        const phone = normalizePhone(r.phone, $('#countryCode').value);
        let extra={};
        try{
          const mode = (document.querySelector('input[name="imgMode"]:checked')||{}).value;
          if(mode==='plain'){
            if(!uploaded.plain.url){
              if(!uploaded.plain.file){ alert('Ø§Ø±ÙØ¹ ÙƒØ±Øª Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø£ØµÙ„ÙŠ Ø£ÙˆÙ„Ù‹Ø§'); throw new Error('no-plain'); }
              const url=await uploadFileInput($('#plainCardImage'),'plain'); uploaded.plain.url=url;
            }
            extra.image = uploaded.plain.url;
          } else if(mode==='qr'){
            if(!uploaded.qr.url){
              if(!uploaded.qr.file){ alert('Ø§Ø±ÙØ¹ ÙƒØ±Øª Ø§Ù„Ù€QR Ø£ÙˆÙ„Ù‹Ø§'); throw new Error('no-qr'); }
              const url=await uploadFileInput($('#qrCardImage'),'qr'); uploaded.qr.url=url;
            }
            extra.image = uploaded.qr.url;
          } else { extra.image=''; }

          const text = previewMsg(r, extra);
          if(($('#channel').value)==='whatsapp'){ openWhatsApp(phone, text); } else { openSMS(phone, text); }
          state.rows[idx].status='sent';
          try{
            if(db){
              await db.collection('invites').doc(r.code).set({
                sentAt: firebase.firestore.FieldValue.serverTimestamp(),
                sentTo: phone,
                imageMode: mode,
                sentImage: extra.image||null
              }, { merge:true });
            }
          }catch{}
        }catch(e){
          state.rows[idx].status='failed';
        }
        render();
      }

      async function sendAll(){ let i=0; const batch=3; const delay=1600; async function sleep(ms){return new Promise(r=>setTimeout(r,ms))}
        while(i < state.rows.length){ const end=Math.min(i+batch, state.rows.length); for(let j=i;j<end;j++){ await sendOne(j); } i=end; await sleep(delay); }
      }

      // ===== CSV & Firestore =====
      function loadCSVFile(file){ Papa.parse(file,{header:true,skipEmptyLines:true,complete: (res)=>{ const rows=[]; res.data.forEach(x=>{ rows.push({ name: x.name||x.Name||'', phone: x.phone||x.Phone||'', code: x.code||x.Code||'' , status:'ready' }); }); state.rows=rows; render(); }}); }
      async function fetchFromFirestore(){ if(!db){ alert('Firestore ØºÙŠØ± Ù…ØªØ§Ø­'); return; } const ev=$('#eventName').value.trim(); if(!ev){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«'); return; } try{ const snap=await db.collection('invites').where('EventName','==',ev).get(); const arr=[]; snap.forEach(d=>{ const x=d.data()||{}; arr.push({ name: x.Name||'', phone: x.Phone||'', code: x.Code||d.id, status:'ready' }); }); state.rows=arr; render(); }catch(e){ alert(e.message); }
      }

      function exportCSV(){ const lines=['name,phone,code,status']; state.rows.forEach(r=>{ lines.push([r.name,r.phone,r.code,r.status||''].join(',')); }); const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='invite-send-status.csv'; a.click(); URL.revokeObjectURL(url); }

      // ===== ZIP all =====
      async function zipAll(type){ if(!state.rows.length){ alert('Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©'); return; } const zip=new JSZip(); const canvas=$('#preview'); if(type==='cards' && !state.cardImg){ if(!confirm('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© ÙƒØ±Øª Ù…Ø±ÙÙˆØ¹Ø©ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª QR ÙÙ‚Ø·. Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return; }
        for(const r of state.rows){ if(type==='cards'){ await drawCard(canvas, r.code); const url=canvas.toDataURL('image/png'); const data=await (await fetch(url)).blob(); zip.file(`card-${r.code}.png`, data);} else { const size=parseInt($('#qrSize').value||'300',10); const qr=makeQRCanvas(r.code, size, $('#qrColor').value||'#000', $('#bgColor').value||'#fff'); const url=qr.toDataURL('image/png'); const data=await (await fetch(url)).blob(); zip.file(`${r.code}.png`, data);} }
        const blob=await zip.generateAsync({type:'blob'}); saveAs(blob, type==='cards'? 'cards.zip':'qrs.zip'); }

      // ===== Wire =====
      document.addEventListener('DOMContentLoaded', ()=>{
        $('#langBtn').addEventListener('click', ()=>{ LANG=(LANG==='ar')?'en':'ar'; localStorage.setItem('hs:send:lang',LANG); render(); });
        $('#csvFile').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(f) loadCSVFile(f); });
        $('#btnFetch').addEventListener('click', fetchFromFirestore);
        $('#btnAddRow').addEventListener('click', ()=>{ state.rows.unshift({name:'',phone:'',code:'',status:'ready'}); render(); });
        $('#btnClear').addEventListener('click', ()=>{ state.rows=[]; render(); });
        $('#btnSendAll').addEventListener('click', sendAll);
        $('#btnExportCsv').addEventListener('click', exportCSV);
        ['eventName','countryCode','baseUrl','channel','msgLang','msgTemplate'].forEach(id=>{ $('#'+id).addEventListener('input', ()=> render()); });

        // ØªÙˆÙ„ÙŠØ¯/Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
        $('#cardImage').addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(f){ const img=new Image(); img.onload=()=>{ state.cardImg=img; alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„ÙƒØ±Øª â€” Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©/Ø§Ù„Ø¬ÙŠÙ„'); }; img.src=URL.createObjectURL(f); } });
        $('#btnPreviewCard').addEventListener('click', async()=>{ const sample=(state.rows[0]?.code||'SAMPLE_001'); await drawCard($('#preview'), sample); const url=$('#preview').toDataURL('image/png'); window.open(url,'_blank'); });
        $('#btnZipCards').addEventListener('click', ()=> zipAll('cards'));
        $('#btnZipQrs').addEventListener('click', ()=> zipAll('qrs'));

        // Ø±ÙØ¹ Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© ÙƒÙ…Ø§ Ù‡ÙŠ
        $('#btnUploadPlain').addEventListener('click', async ()=>{
          try{ $('#plainStatus').textContent='Ø¬Ø§Ø±Ù Ø§Ù„Ø±ÙØ¹...';
               const url=await uploadFileInput($('#plainCardImage'),'plain');
               $('#plainStatus').textContent='ØªÙ… Ø§Ù„Ø±ÙØ¹'; console.log('plain url',url);
          }catch(e){ $('#plainStatus').textContent='Ø®Ø·Ø£'; }
        });
        $('#btnUploadQRCard').addEventListener('click', async ()=>{
          try{ $('#qrCardStatus').textContent='Ø¬Ø§Ø±Ù Ø§Ù„Ø±ÙØ¹...';
               const url=await uploadFileInput($('#qrCardImage'),'qr');
               $('#qrCardStatus').textContent='ØªÙ… Ø§Ù„Ø±ÙØ¹'; console.log('qr url',url);
          }catch(e){ $('#qrCardStatus').textContent='Ø®Ø·Ø£'; }
        });

        render();
      });
    })();
  </script>
</body>
</html>
