<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez â€” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… / Dashboard</title>
  <style>
    :root{--bg:#0b1020;--ink:#e5e7eb;--muted:#94a3b8;--card:#0e172a;--b:#1f2937;--ok:#16a34a;--bad:#dc2626;--warn:#f59e0b}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .topbar{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid #243047}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;border-radius:10px;background:#111;border:1px solid #333;display:grid;place-items:center}
    .logo span{font-weight:900;color:#ffd700}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #243047;background:#0b1220;border-radius:10px;padding:8px 10px}
    .btn{appearance:none;border:1px solid #334155;background:#0b1220;color:var(--ink);border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{background:#0d1528}
    .select,.input{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:var(--ink)}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .grid{display:grid;gap:12px}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    .grid-4{grid-template-columns:repeat(4,1fr)}
    @media(max-width:900px){.grid-3{grid-template-columns:1fr}.grid-4{grid-template-columns:1fr 1fr}}
    .kpi{display:flex;gap:12px;align-items:center}
    .kpi .n{font-size:26px;font-weight:900}
    .badge{padding:4px 8px;border-radius:8px;border:1px solid transparent;font-weight:700;font-size:12px}
    .badge.ok{background:rgba(22,163,74,.12);border-color:rgba(22,163,74,.35);color:#86efac}
    .badge.no{background:rgba(220,38,38,.12);border-color:rgba(220,38,38,.35);color:#fca5a5}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-top:1px solid rgba(255,255,255,.08)}
    thead th{position:sticky;top:0;background:#0e162c}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .muted{color:var(--muted)}

    /* Print styles */
    @media print {
      body{background:#fff;color:#000}
      .topbar,.grid.grid-3 .card:last-child{display:none!important} /* hide header & export block */
      .card{border:1px solid #ccc}
      .badge{border:1px solid #333}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="topbar">
    <div class="container row" style="align-items:center">
      <div class="brand">
        <div class="logo"><span>HS</span></div>
        <div>
          <div class="muted" style="font-size:12px">HORMEZ SECURITY</div>
          <div style="font-weight:800">Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±ÙƒÙ‡ / HORMEZ Dashboard</div>
          <div class="muted" style="font-size:12px">Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª â€¢ Live attendance & status</div>
        </div>
      </div>
      <div style="margin-inline-start:auto" class="row">
        <button id="langBtn" class="btn">AR</button>
        <button id="refreshBtn" class="btn">â†» ØªØ­Ø¯ÙŠØ« / Refresh</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Filters -->
    <div class="grid grid-3">
      <div class="card">
        <div class="muted" id="lblEvent" style="font-size:12px">Ø§Ù„Ø­Ø¯Ø«</div>
        <select id="eventSelect" class="select"></select>
      </div>
      <div class="card">
        <div class="muted" id="lblSearch" style="font-size:12px">Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯â€¦</div>
        <input id="searchInput" class="input" placeholder="KH_001" />
      </div>
      <div class="card" style="display:flex;align-items:flex-end;gap:8px">
        <button id="exportBtn" class="btn" style="flex:1">â¤“ ØªØµØ¯ÙŠØ± CSV</button>
        <button id="printBtn" class="btn" style="flex:1">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
    </div>

    <!-- Date Filter -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="align-items:end">
        <div style="flex:1;min-width:200px">
          <div class="muted" id="lblFrom" style="font-size:12px">Ù…Ù† ØªØ§Ø±ÙŠØ®</div>
          <input id="dateFrom" type="date" class="input" />
        </div>
        <div style="flex:1;min-width:200px">
          <div class="muted" id="lblTo" style="font-size:12px">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</div>
          <input id="dateTo" type="date" class="input" />
        </div>
        <div style="display:flex;gap:8px;align-items:end">
          <button id="applyDate" class="btn">ØªØ·Ø¨ÙŠÙ‚</button>
          <button id="clearDate" class="btn">Ù…Ø³Ø­</button>
        </div>
        <div id="activeFilter" class="muted" style="margin-inline-start:auto"></div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid grid-4" style="margin-top:12px">
      <div class="card kpi"><div class="muted" id="kpiTotalLbl">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div><div id="kpiTotal" class="n">â€”</div></div>
      <div class="card kpi"><div class="muted" id="kpiUsedLbl">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div><div id="kpiUsed" class="n">â€”</div></div>
      <div class="card kpi"><div class="muted" id="kpiLeftLbl">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div><div id="kpiLeft" class="n">â€”</div></div>
      <div class="card kpi"><div class="muted" id="kpiRateLbl">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div><div id="kpiRate" class="n">â€”%</div></div>
    </div>

    <!-- Table -->
    <div class="card" style="margin-top:12px">
      <div class="muted" id="recentLbl" style="font-size:12px">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø­Ø§Øª (Ø¢Ø®Ø± 100)</div>
      <div id="printArea" style="max-height:60vh;overflow:auto;margin-top:8px">
        <table>
          <thead>
            <tr>
              <th id="thCode">Ø§Ù„ÙƒÙˆØ¯</th>
              <th id="thStatus">Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th id="thTime">Ø§Ù„ÙˆÙ‚Øª</th>
            </tr>
          </thead>
          <tbody id="rowsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ===== i18n =====
    const STR = {
      en: {
        event:"Event", search:"Search codeâ€¦", export:"Export CSV", print:"Print", total:"Total", used:"Checked-in", left:"Remaining", rate:"Attendance", recent:"Recent scans (latest 100)", code:"Code", status:"Status", time:"Time", all:"All events", refreshed:"Refreshed", from:"From", to:"To", apply:"Apply", clear:"Clear", filterActive:(f,t)=>`Filter: ${f} â†’ ${t}` },
      ar: {
        event:"Ø§Ù„Ø­Ø¯Ø«", search:"Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯â€¦", export:"ØªØµØ¯ÙŠØ± CSV", print:"Ø·Ø¨Ø§Ø¹Ø©", total:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", used:"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", left:"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ", rate:"Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±", recent:"Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø­Ø§Øª (Ø¢Ø®Ø± 100)", code:"Ø§Ù„ÙƒÙˆØ¯", status:"Ø§Ù„Ø­Ø§Ù„Ø©", time:"Ø§Ù„ÙˆÙ‚Øª", all:"ÙƒÙ„ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª", refreshed:"ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«", from:"Ù…Ù† ØªØ§Ø±ÙŠØ®", to:"Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®", apply:"ØªØ·Ø¨ÙŠÙ‚", clear:"Ù…Ø³Ø­", filterActive:(f,t)=>`ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙÙ„ØªØ±: ${f} â†’ ${t}` }
    };

    const $ = (s,root=document)=>root.querySelector(s);
    const state = { lang: localStorage.getItem('hs:dash:lang')||'ar', event: localStorage.getItem('hs:dash:event')||'', from:'', to:'' };

    function applyLang(){
      const L = STR[state.lang] || STR.en; const isAr = state.lang==='ar';
      document.documentElement.lang = state.lang; document.documentElement.dir = isAr?'rtl':'ltr';
      $('#langBtn').textContent = isAr? 'EN' : 'AR';
      $('#lblEvent').textContent = L.event; $('#lblSearch').textContent = L.search; $('#exportBtn').textContent = (isAr? 'â¤“ ' : '') + L.export; $('#printBtn').textContent = 'ğŸ–¨ï¸ ' + L.print;
      $('#kpiTotalLbl').textContent = L.total; $('#kpiUsedLbl').textContent = L.used; $('#kpiLeftLbl').textContent = L.left; $('#kpiRateLbl').textContent = L.rate;
      $('#recentLbl').textContent = L.recent; $('#thCode').textContent = L.code; $('#thStatus').textContent = L.status; $('#thTime').textContent = L.time;
      $('#lblFrom').textContent = L.from; $('#lblTo').textContent = L.to; $('#applyDate').textContent = L.apply; $('#clearDate').textContent = L.clear;
      renderActiveFilter();
    }

    // ===== Firebase =====
    const firebaseConfig = { apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac", authDomain:"hormez-inv.firebaseapp.com", projectId:"hormez-inv", storageBucket:"hormez-inv.firebasestorage.app", messagingSenderId:"747519941805", appId:"1:747519941805:web:468fada2492700e9da3a24" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app);

    // ===== Populate events =====
    async function loadEvents(){
      const ref = collection(db,'invites'); const snap = await getDocs(query(ref, limit(500)));
      const setE = new Set(); snap.forEach(d=>{ const ev=d.data().EventName||''; if(ev) setE.add(ev); });
      const list = ['__ALL__', ...Array.from(setE).sort((a,b)=>a.localeCompare(b))];
      const sel = $('#eventSelect'); sel.innerHTML = '';
      for(const ev of list){ const opt = document.createElement('option'); opt.value = ev; opt.textContent = ev==='__ALL__' ? STR[state.lang].all : ev; sel.appendChild(opt); }
      sel.value = state.event && list.includes(state.event) ? state.event : '__ALL__';
      state.event = sel.value; localStorage.setItem('hs:dash:event', state.event);
    }

    // ===== Live KPIs & table =====
    let unsub = null, rowsAll = [], rows = [];
    function startStream(){
      if(unsub) unsub();
      const ref = collection(db,'invites');
      const qAll = state.event && state.event!=='__ALL__' ? query(ref, where('EventName','==', state.event)) : query(ref);
      unsub = onSnapshot(qAll, snap=>{
        let t=0,u=0; const rec=[];
        snap.forEach(d=>{ const x=d.data(); t++; if((x.Status||'').toLowerCase()==='yes') u++; if(x.scannedAt?.toDate?.()) rec.push({id:d.id,Code:x.Code||d.id,Status:x.Status||'no',scannedAt:x.scannedAt.toDate()}); });
        // KPIs (overall for event selection)
        renderKPIs(t,u);
        rowsAll = rec.sort((a,b)=>(b.scannedAt?.getTime?.()||0)-(a.scannedAt?.getTime?.()||0));
        applyFilters();
      });
    }

    function withinDateRange(d){
      if(!d) return false; const ts = d.getTime();
      if(state.from){ const fromTs = new Date(state.from+"T00:00:00").getTime(); if(ts < fromTs) return false; }
      if(state.to){ const toTs = new Date(state.to+"T23:59:59").getTime(); if(ts > toTs) return false; }
      return true;
    }

    function applyFilters(){
      const s = ($('#searchInput').value||'').trim().toLowerCase();
      let list = rowsAll;
      if(state.from || state.to) list = list.filter(r=> withinDateRange(r.scannedAt));
      if(s) list = list.filter(r=> (r.Code||'').toLowerCase().includes(s));
      rows = list.slice(0,100); // keep UI fast
      renderRows(); renderActiveFilter();
    }

    function renderActiveFilter(){
      const L = STR[state.lang] || STR.en; const box=$('#activeFilter');
      if(state.from || state.to){ box.textContent = L.filterActive(state.from||'â€”', state.to||'â€”'); }
      else { box.textContent=''; }
    }

    function renderKPIs(total, used){
      const left = Math.max(total-used,0); const rate = total>0 ? Math.round((used/total)*100) : 0;
      $('#kpiTotal').textContent = total; $('#kpiUsed').textContent = used; $('#kpiLeft').textContent = left; $('#kpiRate').textContent = rate + '%';
    }

    function renderRows(){
      const L = STR[state.lang]||STR.en; const isAr = state.lang==='ar';
      const tb = $('#rowsBody'); tb.innerHTML='';
      if(rows.length===0){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=3; td.className='muted'; td.style.textAlign='center'; td.style.padding='18px'; td.textContent= isAr? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø­Ø§Øª' : 'No scans yet'; tr.appendChild(td); tb.appendChild(tr); return; }
      for(const r of rows){
        const tr=document.createElement('tr');
        const td1=document.createElement('td'); td1.className='mono'; td1.textContent=r.Code; tr.appendChild(td1);
        const td2=document.createElement('td'); const b=document.createElement('span'); const ok=(r.Status||'no').toLowerCase()==='yes'; b.className='badge ' + (ok? 'ok':'no'); b.textContent= ok ? (isAr?'yes':'yes') : (isAr?'no':'no'); td2.appendChild(b); tr.appendChild(td2);
        const td3=document.createElement('td'); td3.textContent= r.scannedAt ? r.scannedAt.toLocaleString(isAr?'ar-EG':'en-GB') : 'â€”'; tr.appendChild(td3);
        tb.appendChild(tr);
      }
    }

    function exportCSV(){
      const L = STR[state.lang]||STR.en; const header=[L.code,L.status,'EventName',L.time].join(',');
      const lines = rows.map(r=> [r.Code, r.Status, state.event==='__ALL__'?'ALL':state.event, r.scannedAt? new Date(r.scannedAt).toISOString():'' ].join(','));
      const csv=[header,...lines].join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`hormez-${state.event||'all'}-scans.csv`; a.click(); URL.revokeObjectURL(url);
    }

    function printTable(){
      // Simple: use native print; CSS hides header, keeps table
      window.print();
    }

    // ===== Wire UI =====
    document.addEventListener('DOMContentLoaded', async ()=>{
      applyLang(); await loadEvents(); startStream();
      $('#langBtn').addEventListener('click', ()=>{ state.lang = state.lang==='ar'?'en':'ar'; localStorage.setItem('hs:dash:lang', state.lang); applyLang(); loadEvents().then(()=>startStream()); applyFilters(); });
      $('#refreshBtn').addEventListener('click', ()=> location.reload());
      $('#eventSelect').addEventListener('change', (e)=>{ state.event = e.target.value; localStorage.setItem('hs:dash:event', state.event); startStream(); });
      $('#searchInput').addEventListener('input', ()=> applyFilters());
      $('#exportBtn').addEventListener('click', exportCSV);
      $('#printBtn').addEventListener('click', printTable);
      $('#applyDate').addEventListener('click', ()=>{ state.from=$('#dateFrom').value||''; state.to=$('#dateTo').value||''; applyFilters(); });
      $('#clearDate').addEventListener('click', ()=>{ state.from=''; state.to=''; $('#dateFrom').value=''; $('#dateTo').value=''; applyFilters(); });
    });
  </script>
</body>
</html>
