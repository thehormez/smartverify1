<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>KRS INVITE â€” Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø­Ø¯Ø«</title>

  <style>
    :root{
      --bg0:#06080f;
      --bg1:#0a0f1d;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --ink:#e9edf5;
      --muted:#a7b0c3;
      --gold:#d6b15e;
      --gold2:#b48a18;
      --blue:#1e40af;
      --rose:#be123c;
      --green:#047857;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --r16:16px;
      --r20:20px;
      --r24:24px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      color:var(--ink);
      font-family: system-ui,-apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(214,177,94,.14), transparent 55%),
        radial-gradient(900px 500px at 80% 15%, rgba(30,64,175,.12), transparent 60%),
        radial-gradient(900px 500px at 70% 90%, rgba(190,18,60,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .container{max-width:1100px;margin:0 auto;padding:14px}

    /* ===== Topbar ===== */
    .topbar{
      position:sticky; top:0; z-index:20;
      background: rgba(6,8,15,.72);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .top-inner{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 260px;
    }

    .logoMark{
      width:40px;height:40px;border-radius:14px;
      background:
        radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.22), transparent 55%),
        linear-gradient(145deg, rgba(214,177,94,.25), rgba(180,138,24,.08));
      border:1px solid rgba(214,177,94,.35);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:grid;place-items:center;
      position:relative;
      overflow:hidden;
    }
    .logoMark:after{
      content:"";
      position:absolute; inset:-40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.20), transparent);
      transform: rotate(25deg);
      animation: sheen 6s linear infinite;
    }
    @keyframes sheen{
      0%{transform:translateX(-30%) rotate(25deg)}
      100%{transform:translateX(30%) rotate(25deg)}
    }
    .logoMark span{
      z-index:1;
      font-weight:900; letter-spacing:.5px;
      color: #1b1405;
      background: linear-gradient(180deg, #1b1405, #000);
      -webkit-background-clip:text; background-clip:text;
      color:transparent;
      font-size:12px;
    }

    .hdrOrg{color:var(--muted);font-size:12px;letter-spacing:.6px}
    .hdrTitle{font-weight:900;font-size:15px}
    .hdrTitle .ev{color:var(--gold)}
    .actions{margin-inline-start:auto; display:flex; gap:8px; flex-wrap:wrap}

    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color:var(--ink);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      min-height:42px;
      font-size:14px;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.08); border-color:rgba(214,177,94,.30); transform: translateY(-1px)}
    .btn:active{transform: translateY(0px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(214,177,94,.30), rgba(180,138,24,.12));
      border-color: rgba(214,177,94,.35);
    }
    .btn.danger{border-color: rgba(190,18,60,.45); background: rgba(190,18,60,.10)}
    .btn.block{width:100%}

    .input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color:var(--ink);
      min-height:44px;
      font-size:14px;
      outline:none;
      transition: border-color .12s ease, background .12s ease;
    }
    .input:focus{
      border-color: rgba(214,177,94,.40);
      background: rgba(255,255,255,.07);
      box-shadow: 0 0 0 4px rgba(214,177,94,.10);
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r20);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .card.soft{
      background: var(--card2);
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
    }

    .muted{color:var(--muted);font-size:12px}
    .error{color:#ff9fb3;font-size:12px;margin-top:8px}

    .grid{display:grid; gap:12px}
    .grid-2{grid-template-columns: 1fr 1fr}
    .grid-4{grid-template-columns: repeat(4, 1fr)}
    @media(max-width:980px){.grid-4{grid-template-columns: 1fr 1fr}}
    @media(max-width:760px){.grid-2{grid-template-columns:1fr}}
    @media(max-width:520px){.grid-4{grid-template-columns:1fr}.container{padding:12px}}

    /* ===== Gate (Login) ===== */
    .gateWrap{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:12px;
      align-items:stretch;
    }
    @media(max-width:900px){.gateWrap{grid-template-columns:1fr}}

    .hero{
      border-radius: var(--r24);
      padding: 18px;
      border: 1px solid rgba(214,177,94,.20);
      background:
        radial-gradient(900px 300px at 20% 0%, rgba(214,177,94,.14), transparent 60%),
        radial-gradient(900px 380px at 90% 70%, rgba(30,64,175,.10), transparent 60%),
        rgba(255,255,255,.03);
      box-shadow: 0 24px 70px rgba(0,0,0,.50);
    }
    .heroTitle{
      font-weight:1000;
      font-size:18px;
      margin:0 0 6px;
      letter-spacing:.3px;
    }
    .heroTitle .g{color:var(--gold)}
    .heroP{margin:0;color:var(--muted);font-size:13px;line-height:1.65}
    .heroBadges{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
    .pill{
      padding:7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--ink);
      font-size:12px;
    }
    .pill.gold{border-color: rgba(214,177,94,.28); background: rgba(214,177,94,.10)}

    /* ===== KPI ===== */
    .kpi{
      position:relative;
      border:none;
      overflow:hidden;
      padding:14px;
      border-radius: var(--r20);
      min-height: 92px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .kpi .t{font-weight:900;font-size:12px;color:rgba(255,255,255,.90);letter-spacing:.4px}
    .kpi .n{font-size:26px;font-weight:1000;letter-spacing:.4px}
    .kpi:before{
      content:"";
      position:absolute; inset:-60%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), transparent 55%);
      transform: rotate(15deg);
      pointer-events:none;
    }
    .kpi.blue{background:linear-gradient(135deg, rgba(30,64,175,1), rgba(30,64,175,.45))}
    .kpi.gold{background:linear-gradient(135deg, rgba(214,177,94,1), rgba(180,138,24,.40)); color:#161106}
    .kpi.rose{background:linear-gradient(135deg, rgba(190,18,60,1), rgba(190,18,60,.40))}
    .kpi.green{background:linear-gradient(135deg, rgba(4,120,87,1), rgba(4,120,87,.40))}
    .kpi.gold .t,.kpi.gold .n{color:#161106}

    /* ===== Table ===== */
    .tableWrap{
      margin-top: 10px;
      border-radius: var(--r20);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    table{width:100%; border-collapse:collapse; font-size:14px}
    thead th{
      text-align:start;
      padding:10px 10px;
      background: rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      font-weight:900;
      letter-spacing:.3px;
    }
    tbody td{
      padding:10px;
      border-top:1px solid rgba(255,255,255,.08);
      color: rgba(233,237,245,.92);
    }
    tbody tr:hover td{background: rgba(214,177,94,.06)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}

    .badge{
      padding:6px 10px;
      border-radius: 999px;
      font-weight:900;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    .badge.ok{border-color:rgba(34,197,94,.25); background:rgba(34,197,94,.10); color:#b7f7d0}
    .badge.no{border-color:rgba(244,63,94,.25); background:rgba(244,63,94,.10); color:#ffc0cd}

    /* ===== Mobile Cards ===== */
    #desktopTableWrap{display:block}
    #mobileList{display:none}

    @media(max-width:760px){
      #desktopTableWrap{display:none}
      #mobileList{display:block}
      .scan-card{
        background: rgba(255,255,255,.05);
        border:1px solid rgba(255,255,255,.10);
        border-radius: 18px;
        padding:12px;
        margin-bottom:10px;
        box-shadow: 0 18px 50px rgba(0,0,0,.28);
      }
      .scan-head{
        display:flex; justify-content:space-between; align-items:center; gap:10px;
        padding-bottom:10px; margin-bottom:10px;
        border-bottom:1px dashed rgba(255,255,255,.12);
      }
      .scan-code{font-weight:1000; letter-spacing:.3px}
      .scan-line{display:flex; justify-content:space-between; gap:12px; margin:8px 0}
      .scan-label{color:#cbd5e1;font-weight:900;font-size:12px}
      .scan-value{font-size:14px; color: rgba(233,237,245,.95)}
      .scan-value.mono{font-family: ui-monospace, monospace}
    }

    /* ===== Print ===== */
    @media print{
      .topbar, #gate, #logoutBtn, #langBtn, #refreshBtn, #exportBtn, #printBtn{display:none!important}
      body{background:#fff;color:#111}
      .card, .tableWrap{box-shadow:none;border:1px solid #ddd;background:#fff}
      thead th{background:#f5f5f5;color:#111}
      tbody td{color:#111}
    }
  </style>
</head>

<body>
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="container top-inner">
      <div class="brand">
        <div class="logoMark"><span>KRS</span></div>
        <div>
          <div class="hdrOrg muted" id="hdrOrg">KRS INVITE</div>
          <div class="hdrTitle">
            <span id="hdrTitlePrefix">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø­Ø¯Ø« â€” </span>
            <span class="ev" id="evNameTitle">â€”</span>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="langBtn" class="btn">AR</button>
        <button id="refreshBtn" class="btn">â†»</button>
        <button id="logoutBtn" class="btn danger" style="display:none">ğŸšª <span id="logoutTxt">Ø®Ø±ÙˆØ¬</span></button>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- GATE + HERO -->
    <div class="gateWrap" id="gateWrap">
      <div class="hero">
        <h3 class="heroTitle">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… <span class="g">KRS INVITE</span> Ù„Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª</h3>
        <p class="heroP" id="heroP">
          ÙˆØ§Ø¬Ù‡Ø© Ø£Ù†ÙŠÙ‚Ø© ÙˆØ³Ø±ÙŠØ¹Ø© Ù„Ù„Ø²Ø¨Ø§Ø¦Ù†: Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ Ø¨Ø­Ø« ÙÙˆØ±ÙŠØŒ ÙˆØ·Ø¨Ø§Ø¹Ø©/ØªØµØ¯ÙŠØ± Ø®Ù„Ø§Ù„ Ø«ÙˆØ§Ù†ÙŠ.
        </p>
        <div class="heroBadges">
          <span class="pill gold">Premium Dashboard</span>
          <span class="pill">Live Updates</span>
          <span class="pill">Mobile Friendly</span>
        </div>
      </div>

      <div class="card soft gate" id="gate">
        <div class="muted" id="gateHint" style="margin-bottom:10px">Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
        <div class="grid" style="gap:10px">
          <div>
            <div class="muted" id="lblEvent">Ø§Ù„Ø­Ø¯Ø«</div>
            <input id="eventInput" class="input" placeholder="Ù…Ø«Ø§Ù„: haddad" />
          </div>
          <div>
            <div class="muted" id="lblPass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
            <input id="passInput" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢" />
          </div>
          <button id="enterBtn" class="btn primary block">Ø¯Ø®ÙˆÙ„</button>
        </div>
        <div id="gateMsg" class="error"></div>
      </div>
    </div>

    <!-- CONTENT -->
    <div id="content" style="display:none; margin-top:14px">

      <div class="grid grid-2">
        <div class="card soft">
          <div class="muted" id="lblSearch">Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯â€¦</div>
          <input id="searchInput" class="input" placeholder="FA_001" />
        </div>

        <div class="card soft" style="display:flex; gap:10px; align-items:end; flex-wrap:wrap; justify-content:flex-end">
          <button id="exportBtn" class="btn">â¤“ CSV</button>
          <button id="printBtn" class="btn">ğŸ–¨ï¸ <span id="printTxt">Ø·Ø¨Ø§Ø¹Ø©</span></button>
        </div>
      </div>

      <div class="grid grid-4" style="margin-top:12px">
        <div class="kpi blue">
          <div class="t" id="kpiTotalLbl">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
          <div id="kpiTotal" class="n">â€”</div>
        </div>
        <div class="kpi gold">
          <div class="t" id="kpiUsedLbl">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
          <div id="kpiUsed" class="n">â€”</div>
        </div>
        <div class="kpi rose">
          <div class="t" id="kpiLeftLbl">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
          <div id="kpiLeft" class="n">â€”</div>
        </div>
        <div class="kpi green">
          <div class="t" id="kpiRateLbl">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div>
          <div id="kpiRate" class="n">â€”%</div>
        </div>
      </div>

      <div class="card soft" style="margin-top:12px">
        <div class="muted" id="recentLbl">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø­Ø§Øª (Ø¢Ø®Ø± 100)</div>

        <!-- Desktop table -->
        <div id="desktopTableWrap" class="tableWrap" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th id="thCode">Ø§Ù„ÙƒÙˆØ¯</th>
                <th id="thStatus">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th id="thTime">Ø§Ù„ÙˆÙ‚Øª</th>
              </tr>
            </thead>
            <tbody id="rowsBody"></tbody>
          </table>
        </div>

        <!-- Mobile cards -->
        <div id="mobileList" style="margin-top:10px"></div>
      </div>

    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

/* ===================== i18n ===================== */
const STR={
  ar:{
    org:"KRS INVITE",
    titlePrefix:"Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø­Ø¯Ø« â€” ",
    hero:"ÙˆØ§Ø¬Ù‡Ø© Ø£Ù†ÙŠÙ‚Ø© ÙˆØ³Ø±ÙŠØ¹Ø© Ù„Ù„Ø²Ø¨Ø§Ø¦Ù†: Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ Ø¨Ø­Ø« ÙÙˆØ±ÙŠØŒ ÙˆØ·Ø¨Ø§Ø¹Ø©/ØªØµØ¯ÙŠØ± Ø®Ù„Ø§Ù„ Ø«ÙˆØ§Ù†ÙŠ.",
    gateHint:"Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
    event:"Ø§Ù„Ø­Ø¯Ø«", pass:"ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", enter:"Ø¯Ø®ÙˆÙ„", logout:"Ø®Ø±ÙˆØ¬",
    badpass:"ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©", badname:"âŒ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ØºÙŠØ± ØµØ­ÙŠØ­",
    search:"Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯â€¦", export:"ØªØµØ¯ÙŠØ± CSV", print:"Ø·Ø¨Ø§Ø¹Ø©",
    total:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", used:"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", left:"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ", rate:"Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±",
    recent:"Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø­Ø§Øª (Ø¢Ø®Ø± 100)",
    code:"Ø§Ù„ÙƒÙˆØ¯", status:"Ø§Ù„Ø­Ø§Ù„Ø©", time:"Ø§Ù„ÙˆÙ‚Øª",
    yes:"ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„", no:"Ù„Ù… ÙŠØ¯Ø®Ù„", noRows:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø­Ø§Øª"
  },
  en:{
    org:"KRS INVITE",
    titlePrefix:"Event Dashboard â€” ",
    hero:"A premium client dashboard: live stats, instant search, and export/print in seconds.",
    gateHint:"Enter event name and password",
    event:"Event", pass:"Password", enter:"Enter", logout:"Logout",
    badpass:"Wrong password", badname:"âŒ Wrong event name",
    search:"Search codeâ€¦", export:"Export CSV", print:"Print",
    total:"Total", used:"Checked-in", left:"Remaining", rate:"Attendance",
    recent:"Recent scans (latest 100)",
    code:"Code", status:"Status", time:"Time",
    yes:"Checked-in", no:"Not yet", noRows:"No scans yet"
  }
};
const $=(s,r=document)=>r.querySelector(s);
const state={ lang: localStorage.getItem('hs:dash:lang')||'ar' };

function applyLang(){
  const L=STR[state.lang];
  const isAr=state.lang==='ar';
  document.documentElement.lang=state.lang;
  document.documentElement.dir=isAr?'rtl':'ltr';

  $('#hdrOrg').textContent=L.org;
  $('#hdrTitlePrefix').textContent=L.titlePrefix;
  $('#langBtn').textContent=isAr?'EN':'AR';
  $('#logoutTxt').textContent=L.logout;

  $('#heroP').textContent=L.hero;

  $('#gateHint').textContent=L.gateHint;
  $('#lblEvent').textContent=L.event;
  $('#lblPass').textContent=L.pass;
  $('#enterBtn').textContent=L.enter;

  $('#lblSearch').textContent=L.search;
  $('#exportBtn').textContent='â¤“ ' + L.export;
  $('#printTxt').textContent=L.print;

  $('#kpiTotalLbl').textContent=L.total;
  $('#kpiUsedLbl').textContent=L.used;
  $('#kpiLeftLbl').textContent=L.left;
  $('#kpiRateLbl').textContent=L.rate;

  $('#recentLbl').textContent=L.recent;
  $('#thCode').textContent=L.code;
  $('#thStatus').textContent=L.status;
  $('#thTime').textContent=L.time;

  $('#searchInput').placeholder = (isAr?'Ù…Ø«Ø§Ù„: ':'e.g. ') + 'FA_001';
}

/* ===================== Firebase ===================== */
const app=initializeApp({
  apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
  authDomain:"hormez-inv.firebaseapp.com",
  projectId:"hormez-inv",
  storageBucket:"hormez-inv.firebasestorage.app",
  messagingSenderId:"747519941805",
  appId:"1:747519941805:web:468fada2492700e9da3a24"
});
const db=getFirestore(app);

// Ø¶Ø¹ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ÙÙ‚Ø·:
const PAGE_EVENT='Ø²ÙØ§Ù Ø´Ù…Ù‡';
const PAGE_PASSWORD='9900';
const sessKey=()=>`hs:dash:${PAGE_EVENT}`;

/* ===================== Gate ===================== */
function openContent(){
  $('#gateWrap').style.display='none';
  $('#content').style.display='block';
  $('#logoutBtn').style.display='inline-flex';
  $('#evNameTitle').textContent=PAGE_EVENT;
  startStream();
}
function handleEnter(){
  const ev=$('#eventInput').value.trim();
  const pw=$('#passInput').value.trim();
  if(ev!==PAGE_EVENT){ $('#gateMsg').textContent=STR[state.lang].badname; return; }
  if(pw!==PAGE_PASSWORD){ $('#gateMsg').textContent=STR[state.lang].badpass; return; }
  localStorage.setItem(sessKey(),'ok'); openContent();
}
function tryAutoLogin(){
  if(localStorage.getItem(sessKey())==='ok'){
    $('#eventInput').value=PAGE_EVENT; openContent();
  }else{
    $('#eventInput').value=PAGE_EVENT;
  }
}
function logout(){ localStorage.removeItem(sessKey()); location.href=location.pathname; }

/* ===================== Data & Render ===================== */
let unsub=null, allRows=[], filtRows=[];

function startStream(){
  if(unsub) unsub();
  const qEv=query(collection(db,'invites'), where('EventName','==',PAGE_EVENT));
  unsub=onSnapshot(qEv, snap=>{
    let t=0, u=0; const rec=[];
    snap.forEach(d=>{
      const x=d.data(); t++; if((x.Status||'').toLowerCase()==='yes') u++;
      if(x.scannedAt?.toDate?.()){
        rec.push({ Code:x.Code||d.id, Status:String(x.Status||'no'), scannedAt:x.scannedAt.toDate() });
      }
    });
    renderKPIs(t,u);
    allRows = rec.sort((a,b)=> b.scannedAt - a.scannedAt);
    applyFilters();
  });
}

function applyFilters(){
  const q = ($('#searchInput').value||'').trim().toLowerCase();
  let list = allRows;
  if(q) list = list.filter(r => (r.Code||'').toLowerCase().includes(q));
  filtRows = list.slice(0,100);
  renderRows();
}

function renderKPIs(total, used){
  const left=Math.max(total-used,0);
  const rate= total>0? Math.round((used/total)*100):0;
  $('#kpiTotal').textContent=total;
  $('#kpiUsed').textContent=used;
  $('#kpiLeft').textContent=left;
  $('#kpiRate').textContent=rate+'%';
}

function renderRows(){
  const L=STR[state.lang];

  // Desktop table
  const tb=$('#rowsBody'); tb.innerHTML='';
  if(filtRows.length===0){
    const tr=document.createElement('tr');
    const td=document.createElement('td');
    td.colSpan=3; td.className='muted'; td.style.textAlign='center'; td.textContent=L.noRows;
    tr.appendChild(td); tb.appendChild(tr);
  }else{
    for(const r of filtRows){
      const tr=document.createElement('tr');

      const td1=document.createElement('td');
      td1.textContent=r.Code; td1.className='mono';

      const td2=document.createElement('td');
      const b=document.createElement('span');
      const ok=(r.Status||'no').toLowerCase()==='yes';
      b.className='badge ' + (ok? 'ok':'no');
      b.textContent = ok ? L.yes : L.no;
      td2.appendChild(b);

      const td3=document.createElement('td');
      td3.textContent = r.scannedAt ? r.scannedAt.toLocaleString(state.lang==='ar'?'ar-EG':'en-GB') : 'â€”';

      tr.append(td1,td2,td3); tb.appendChild(tr);
    }
  }

  // Mobile cards
  const listBox = $('#mobileList'); listBox.innerHTML='';
  if(filtRows.length===0){
    const empty=document.createElement('div');
    empty.className='muted';
    empty.style.textAlign='center';
    empty.textContent=L.noRows;
    listBox.appendChild(empty);
  }else{
    for(const r of filtRows){
      const ok=(r.Status||'no').toLowerCase()==='yes';

      const card=document.createElement('div'); card.className='scan-card';

      const head=document.createElement('div'); head.className='scan-head';
      const code=document.createElement('div'); code.className='scan-code mono'; code.textContent=r.Code;

      const badge=document.createElement('span'); badge.className='badge ' + (ok?'ok':'no');
      badge.textContent = ok ? L.yes : L.no;

      head.append(code,badge);

      const line1=document.createElement('div'); line1.className='scan-line';
      const l1=document.createElement('div'); l1.className='scan-label'; l1.textContent=L.time;
      const v1=document.createElement('div'); v1.className='scan-value';
      v1.textContent = r.scannedAt ? r.scannedAt.toLocaleString(state.lang==='ar'?'ar-EG':'en-GB') : 'â€”';
      line1.append(l1,v1);

      card.append(head,line1);
      listBox.appendChild(card);
    }
  }
}

function exportCSV(){
  const L=STR[state.lang];
  const header=[L.code,L.status,'EventName',L.time].join(',');
  const lines=filtRows.map(r=>[
    r.Code,
    ((r.Status||'no').toLowerCase()==='yes' ? L.yes : L.no),
    PAGE_EVENT,
    r.scannedAt ? r.scannedAt.toISOString() : ''
  ].join(','));
  const csv=[header,...lines].join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`${PAGE_EVENT}-scans.csv`; a.click(); URL.revokeObjectURL(url);
}

/* ===================== Wire UI ===================== */
document.addEventListener('DOMContentLoaded', ()=>{
  applyLang();
  $('#eventInput').value=PAGE_EVENT;
  tryAutoLogin();

  $('#langBtn').addEventListener('click', ()=>{
    state.lang = (state.lang==='ar') ? 'en' : 'ar';
    localStorage.setItem('hs:dash:lang', state.lang);
    applyLang();
    renderRows();
  });
  $('#refreshBtn').addEventListener('click', ()=> location.reload());
  $('#logoutBtn').addEventListener('click', logout);

  $('#enterBtn').addEventListener('click', handleEnter);
  $('#passInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); handleEnter(); } });

  $('#searchInput').addEventListener('input', applyFilters);
  $('#exportBtn').addEventListener('click', exportCSV);
  $('#printBtn').addEventListener('click', ()=>window.print());
});
</script>
</body>
</html>
