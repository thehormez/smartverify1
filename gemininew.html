<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ (ØªØ®ØµÙŠØµ ÙƒØ±ÙˆØª Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Tahoma, Arial, sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-top: 30px; color: #5d7eaf; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background-color: #5d7eaf; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: background-color 0.3s; }
        .btn-action { background-color: #FF9800; color: white; }
        .btn-action:hover { background-color: #e68900; }
        .btn-qr { background-color: #00bcd4; color: white; }
        .btn-qr:hover { background-color: #0097a7; }
        .btn-whatsapp { background-color: #25D366; color: white; }
        .btn-whatsapp:hover { background-color: #1DA851; }
        .btn-delete { background-color: #f44336; color: white; }
        .btn-delete:hover { background-color: #da190b; }
        .btn-assign { background-color: #3f51b5; color: white; }
        .btn-assign:hover { background-color: #303f9f; }
        .alert-error { color: #f44336; font-weight: bold; }
        textarea { width: 98%; min-height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; margin-bottom: 15px; }
        .placeholder-note { color: #f44336; font-weight: bold; margin-bottom: 15px; display: block; text-align: right; }
        .form-control { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <h1>Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ (ØªØ®ØµÙŠØµ ÙƒØ±ÙˆØª Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯)</h1>

    <h2>âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¶ÙŠÙˆÙ</h2>

    <div style="margin-bottom: 15px; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
        <h3>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Excel Ø£Ùˆ CSV)</h3>
        <p>ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù Ù‡ÙŠ: <strong><code>name</code>, <code>phone</code>, <code>companions</code></strong>.</p>
        <input type="file" id="guestListUpload" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="margin-bottom: 10px;">
        <button onclick="handleFileUpload()" class="btn-action">âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
        <p>ØªÙ… ØªØ­Ù…ÙŠÙ„ <span id="guestCount">0</span> Ø¶ÙŠÙ.</p>
    </div>

    <div style="margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
        <h3>ğŸ–¼ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h3>
        <p>Ø§Ø®ØªØ± ÙƒÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©. ÙŠØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ **Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨** Ø¹Ù„Ù‰ Ø§Ù„Ø¶ÙŠÙˆÙ Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯.</p>
        <input type="file" id="barcodeUpload" accept="image/*" multiple style="margin-bottom: 10px;">
        <button onclick="loadBarcodes()" class="btn-action">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
        <p>ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ <span id="barcodeCount">0</span> Ù…Ù„Ù Ø¨Ø§Ø±ÙƒÙˆØ¯.</p>
        <p style="color: green; font-weight: bold;">Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©: <span id="importedQrCodes">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span></p>
        <p class="alert-error" id="qrMismatchAlert" style="display:none;"></p>
    </div>
    
    <h2>â• Ø¥Ø¶Ø§ÙØ© Ø¶ÙŠÙ ÙŠØ¯ÙˆÙŠØ§Ù‹</h2>
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
        <input type="text" id="newGuestName" placeholder="Ø§Ù„Ø§Ø³Ù…" class="form-control">
        <input type="text" id="newGuestPhone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ (9665...)" class="form-control">
        <input type="number" id="newGuestCompanions" placeholder="Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†" min="0" value="0" class="form-control">
        <button onclick="addGuestManually()" class="btn-qr">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙŠÙ</button>
    </div>

    <h2>ğŸ–Šï¸ ØªØ¹Ø¯ÙŠÙ„ Ù†Øµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</h2>
    <span class="placeholder-note">
        Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª: <code>#{{GUEST_NAME}}#</code> (Ø§Ù„Ø§Ø³Ù…), <code>#{{COMPANIONS_COUNT}}#</code> (Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†).
    </span>
    <textarea id="messageTemplate">
Ù…Ø±Ø­Ø¨Ø§Ù‹ #{{GUEST_NAME}}#ØŒ
Ù†ØªØ´Ø±Ù Ø¨Ø¯Ø¹ÙˆØªÙƒÙ… Ù„Ø­Ø¶ÙˆØ±... (Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£ÙØ±Ø§Ø¯: #{{COMPANIONS_COUNT}}#).

Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø³Ø­ ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„.
    </textarea>

    <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†</h2>
    <table>
        <thead>
            <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ</th>
                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ† (Ø¨Ù…Ø§ ÙÙŠÙ‡Ù… Ø§Ù„Ø¶ÙŠÙ)</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®ØµØµØ©</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="guestTableBody">
            </tbody>
    </table>

</div>

<script>
    let guests = [];
    let barcodeImages = {}; 
    let availableQrIds = []; 
    let internalGuestIdCounter = 0; 


    // ----------------------------------------------------------------------
    // 1. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
    // ----------------------------------------------------------------------

    function handleFileUpload() {
        // ... (ÙˆØ¸ÙŠÙØ© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª) ...
        const fileInput = document.getElementById('guestListUpload');
        const file = fileInput.files[0];
        if (!file) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹.');
            return;
        }

        const fileExtension = file.name.split('.').pop().toLowerCase();

        if (fileExtension === 'csv') {
            readCSV(file);
        } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
            readExcel(file);
        } else {
            alert('ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… CSV Ø£Ùˆ XLSX.');
        }
    }

    function readCSV(file) {
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                processImportedData(results.data);
            },
            error: function(error) {
                alert(`Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù CSV: ${error.message}`);
            }
        });
    }

    function readExcel(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const importedData = XLSX.utils.sheet_to_json(worksheet);
            processImportedData(importedData);
        };
        reader.readAsArrayBuffer(file);
    }
    
    /**
     * ÙŠØ¹Ø§Ù„Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© ÙˆÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯.
     */
    function processImportedData(data) {
        const requiredFields = ['name', 'phone', 'companions']; 
        
        if (data.length === 0 || !requiredFields.every(field => 
            Object.keys(data[0]).some(key => key.toLowerCase() === field.toLowerCase())
        )) {
            alert('Ø®Ø·Ø£: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (name, phone, companions).');
            return;
        }

        internalGuestIdCounter = 0;
        
        let newGuests = data.map((guest) => {
            const getField = (field) => {
                const key = Object.keys(guest).find(k => k.toLowerCase() === field.toLowerCase());
                return key ? guest[key] : 'N/A';
            };
            
            internalGuestIdCounter++;
            const companionsCount = parseInt(getField('companions')) || 0;

            return {
                internalId: internalGuestIdCounter,
                name: String(getField('name')).trim() || 'N/A',
                phone: String(getField('phone')).trim() || 'N/A',
                companions: companionsCount,
                totalNeeded: companionsCount + 1, // **Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© = Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ† + 1**
                assignedQrIds: [] // **Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† ÙƒÙ„ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®ØµØµØ©**
            };
        });

        guests = newGuests;
        distributeBarcodesAutomatically();
        renderGuestTable();
        checkQrMismatch();
        alert(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${guests.length} Ø¶ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªÙˆØ²ÙŠØ¹ ${guests.reduce((sum, g) => sum + g.totalNeeded, 0)} ÙƒØ±Øª Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨.`);
    }

    /**
     * ÙŠØ¶ÙŠÙ Ø¶ÙŠÙÙ‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§ Ù…Ù† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠØ©.
     */
    function addGuestManually() {
        const nameInput = document.getElementById('newGuestName').value;
        const phoneInput = document.getElementById('newGuestPhone').value;
        const companionsInput = document.getElementById('newGuestCompanions').value;

        if (!nameInput || !phoneInput) {
            alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø­Ù‚Ù„ÙŠ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‡Ø§ØªÙ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
            return;
        }
        
        internalGuestIdCounter++;
        const companionsCount = parseInt(companionsInput) || 0;


        const newGuest = {
            internalId: internalGuestIdCounter,
            name: nameInput,
            phone: phoneInput,
            companions: companionsCount,
            totalNeeded: companionsCount + 1,
            assignedQrIds: []
        };

        guests.push(newGuest);
        distributeBarcodesAutomatically(); 
        renderGuestTable();

        document.getElementById('newGuestName').value = '';
        document.getElementById('newGuestPhone').value = '';
        document.getElementById('newGuestCompanions').value = '0';
        checkQrMismatch();
    }
    
    /**
     * ÙŠØ­Ø°Ù Ø¶ÙŠÙÙ‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.
     */
    function deleteGuest(internalId) {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¶ÙŠÙØŸ')) {
            guests = guests.filter(guest => guest.internalId !== internalId);
            distributeBarcodesAutomatically();
            renderGuestTable();
            checkQrMismatch();
        }
    }

    /**
     * ÙŠØ­Ù…Ù‘Ù„ ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆÙŠØ®Ø²Ù†Ù‡Ø§ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (ÙƒÙ€ Base64).
     */
    function loadBarcodes() {
        const files = document.getElementById('barcodeUpload').files;
        if (files.length === 0) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹.');
            return;
        }

        barcodeImages = {}; 
        availableQrIds = []; 
        let loadedCount = 0;

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const fileNameWithoutExtension = file.name.split('.').slice(0, -1).join(''); 
                barcodeImages[fileNameWithoutExtension] = e.target.result; 
                availableQrIds.push(fileNameWithoutExtension); 
                loadedCount++;
                document.getElementById('barcodeCount').textContent = loadedCount;
                
                document.getElementById('importedQrCodes').textContent = availableQrIds.join(', ');
                
                if (loadedCount === files.length) {
                    // ÙØ±Ø² Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­ (Ø±Ù‚Ù…ÙŠØ§Ù‹)
                    availableQrIds.sort((a, b) => {
                        const numA = parseInt(a);
                        const numB = parseInt(b);
                        if (!isNaN(numA) && !isNaN(numB)) {
                            return numA - numB;
                        }
                        return a.localeCompare(b);
                    });

                    distributeBarcodesAutomatically();
                    renderGuestTable();
                    checkQrMismatch();
                    alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${loadedCount} ÙƒÙˆØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­. ÙˆØªÙ… ØªÙˆØ²ÙŠØ¹Ù‡Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¶ÙŠÙˆÙ Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯.`);
                }
            };
            reader.readAsDataURL(file); 
        });
    }

    /**
     * ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ÙŠØªÙ… ØªØ®ØµÙŠØµ Ø§Ù„ÙƒØ±ÙˆØª Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯ (Ø§Ù„Ø¶ÙŠÙ + Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†).
     */
    function distributeBarcodesAutomatically() {
        // Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªÙŠ ØªÙ… ØªØ®ØµÙŠØµÙ‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ø³Ø¨Ù‚Ù‹Ø§
        const manuallyAssignedIds = guests.flatMap(g => g.assignedQrIds || []).filter(id => id !== null);
        
        // Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ø§Ù„ØªÙŠ Ù„Ù… ÙŠØªÙ… ØªØ®ØµÙŠØµÙ‡Ø§ Ø¨Ø¹Ø¯
        let unassignedQrIds = availableQrIds.filter(id => !manuallyAssignedIds.includes(id));
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ²ÙŠØ¹ Ù„Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
        let qrIndex = 0;
        
        guests.forEach(guest => {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¶ÙŠÙ Ù„Ù… ÙŠØ®ØµØµ Ù„Ù‡ ÙƒØ±ÙˆØª (Ø£ÙŠ Ø£Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ©)ØŒ ÙŠØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ.
            // *Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‚Ø¯ ØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹ØŒ Ù„Ø§ Ù†Ø¹ÙŠØ¯ ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.*
            if (guest.assignedQrIds.length === 0) {
                const needed = guest.totalNeeded;
                
                if (qrIndex + needed <= unassignedQrIds.length) {
                    guest.assignedQrIds = unassignedQrIds.slice(qrIndex, qrIndex + needed);
                    qrIndex += needed;
                } else {
                    guest.assignedQrIds = []; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ±ÙˆØª ÙƒØ§ÙÙŠØ© Ù„Ù„ØªØ®ØµÙŠØµ
                }
            }
        });
    }

    /**
     * ÙŠØ³Ù…Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ØªØ¹ÙŠÙŠÙ† ÙƒÙˆØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø®ØªÙ„Ù ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù„Ø¶ÙŠÙ.
     */
    function assignBarcode(internalId) {
        const currentGuest = guests.find(g => g.internalId === internalId);
        if (!currentGuest) return;

        const needed = currentGuest.totalNeeded;
        let promptMessage = `Ø£Ø¯Ø®Ù„ ${needed} ÙƒÙˆØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙØµÙˆÙ„ÙŠÙ† Ø¨ÙØ§ØµÙ„Ø© (,) Ù„Ù€ ${currentGuest.name}: (Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentGuest.assignedQrIds.join(', ') || 'Ù„Ù… ÙŠØ®ØµØµ'})\n\n`;
        promptMessage += `Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©: ${availableQrIds.join(', ')}`;
        
        const newQrIdsStr = prompt(promptMessage, currentGuest.assignedQrIds.join(', '));
        
        if (newQrIdsStr === null) return; // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù„ØºÙ‰ Ø§Ù„Ø£Ù…Ø±

        const newQrIds = newQrIdsStr.split(',').map(id => id.trim()).filter(id => id !== '');
        
        if (newQrIds.length !== needed) {
             alert(`Ø®Ø·Ø£: ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ${needed} ÙƒÙˆØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø§Ù„Ø¶Ø¨Ø· Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯ (${needed}).`);
             return;
        }

        // ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        const allAssignedIds = guests.flatMap(g => g.assignedQrIds || []);
        for (const newId of newQrIds) {
             // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
             if (!barcodeImages[newId]) {
                alert(`ØªØ­Ø°ÙŠØ±: Ø§Ù„ÙƒÙˆØ¯ "${newId}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©!`);
             }
             // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± Ù…Ø¹ Ø¶ÙŠÙˆÙ Ø¢Ø®Ø±ÙŠÙ†
             if (allAssignedIds.some(id => id === newId && !currentGuest.assignedQrIds.includes(id))) {
                 alert(`Ø®Ø·Ø£: ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ "${newId}" Ù…ÙØ¹ÙŠÙ‘Ù† Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ø¶ÙŠÙ Ø¢Ø®Ø±.`);
                 return;
             }
        }
        
        currentGuest.assignedQrIds = newQrIds;
        distributeBarcodesAutomatically();
        renderGuestTable();
        checkQrMismatch();
    }


    // ----------------------------------------------------------------------
    // 2. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
    // ----------------------------------------------------------------------

    /**
     * ÙˆØ¸ÙŠÙØ© Ù„ØªÙ†Ø²ÙŠÙ„ ÙƒÙ„ ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù„Ø¶ÙŠÙ.
     */
    function downloadBarcodeImage(guest) {
        const qrCodeIds = guest.assignedQrIds; 
        
        if (qrCodeIds.length === 0) {
             alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† ÙƒÙˆØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¶ÙŠÙ Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ¹ÙŠÙŠÙ† ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ùˆ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ÙƒØ±ÙˆØª.');
             return;
        }

        // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙƒØ±Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø· (Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
        const qrCodeId = qrCodeIds[0];
        const imageName = `${qrCodeId}.png`; 
        const base64Data = barcodeImages[qrCodeId];
        
        if (!base64Data) {
            alert(`Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ù„Ù€ ÙƒÙˆØ¯ "${qrCodeId}". ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Ø§Ø³Ù…Ù‡ "${qrCodeId}.png".`);
            return;
        }
        
        // ÙŠÙ…ÙƒÙ†Ù†Ø§ Ù‡Ù†Ø§ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„ÙƒØ±ÙˆØª Ø£Ùˆ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙƒØ±Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        
        const downloadLink = document.createElement('a');
        downloadLink.href = base64Data;
        downloadLink.download = imageName;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);

        // ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø£Ù† Ø§Ù„ÙƒØ±Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø· ØªÙ… ØªÙ†Ø²ÙŠÙ„Ù‡ (ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø³ÙŠØ·)
        if (qrCodeIds.length > 1) {
             alert(`ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙƒØ±Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (${qrCodeId}.png) Ø¨Ù†Ø¬Ø§Ø­. ØªØ°ÙƒØ± Ø£Ù† Ø§Ù„Ø¶ÙŠÙ ÙŠØ­ØªØ§Ø¬ ${qrCodeIds.length} ÙƒØ±ÙˆØª.`);
        }
    }
    
    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ù…Ø¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.
     */
    function checkQrMismatch() {
        const requiredCount = guests.reduce((sum, g) => sum + g.totalNeeded, 0);
        const availableCount = availableQrIds.length;
        const alertBox = document.getElementById('qrMismatchAlert');

        if (availableCount < requiredCount) {
             alertBox.style.display = 'block';
             alertBox.textContent = `ØªØ­Ø°ÙŠØ±: Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© (${availableCount}) Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${requiredCount}). Ù„Ù† ÙŠØªÙ… ØªØ®ØµÙŠØµ ÙƒØ±ÙˆØª Ù„Ø¨Ø¹Ø¶ Ø§Ù„Ø¶ÙŠÙˆÙ.`;
        } else if (availableCount > requiredCount) {
             alertBox.style.display = 'block';
             alertBox.textContent = `Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© (${availableCount}) Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${requiredCount}). ${availableCount - requiredCount} ÙƒØ±Øª Ù„Ù… ÙŠØªÙ… ØªØ®ØµÙŠØµÙ‡.`;
        } else {
             alertBox.style.display = 'none';
        }
    }


    // ----------------------------------------------------------------------
    // 3. ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Render)
    // ----------------------------------------------------------------------
    
    function renderGuestTable() {
        const tableBody = document.getElementById('guestTableBody');
        tableBody.innerHTML = '';
        document.getElementById('guestCount').textContent = guests.length;
        
        guests.forEach(guest => {
            const row = tableBody.insertRow();
            
            row.insertCell().textContent = guest.name;
            // Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙŠ
            row.insertCell().textContent = `${guest.companions} + 1 = ${guest.totalNeeded}`; 
            row.insertCell().textContent = guest.phone;
            
            // Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®ØµØµØ©
            const qrCodeCell = row.insertCell();
            const qrList = guest.assignedQrIds.join(', ');
            qrCodeCell.textContent = qrList || 'Ù„Ù… ÙŠØ®ØµØµ';
            qrCodeCell.style.color = qrList ? '#333' : '#f44336'; 
            qrCodeCell.style.fontWeight = 'bold';

            const actionsCell = row.insertCell();

            // Ø²Ø± ØªØ¹ÙŠÙŠÙ† ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø§Ù„Ø¥Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ)
            const assignButton = document.createElement('button');
            assignButton.textContent = 'ØªØ¹ÙŠÙŠÙ†/ØªØºÙŠÙŠØ± Ø§Ù„ÙƒØ±ÙˆØª';
            assignButton.className = 'btn-assign';
            assignButton.onclick = () => assignBarcode(guest.internalId); 
            actionsCell.appendChild(assignButton);
            
            // Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (ÙŠØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙƒØ±Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø· ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªÙ†ÙÙŠØ°)
            const qrButton = document.createElement('button');
            qrButton.textContent = 'ğŸ’¾ Ø³Ø­Ø¨ Ø§Ù„ÙƒØ±Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ';
            qrButton.className = 'btn-qr';
            qrButton.onclick = () => downloadBarcodeImage(guest); 
            
            if (guest.assignedQrIds.length < guest.totalNeeded) {
                 qrButton.disabled = true;
                 qrButton.textContent = 'ğŸš« Ù†Ù‚Øµ ÙƒØ±ÙˆØª';
            }
            actionsCell.appendChild(qrButton);
            
            // Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨
            const waButton = document.createElement('button');
            waButton.textContent = 'ğŸ’¬ Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨';
            waButton.className = 'btn-whatsapp';
            waButton.onclick = () => sendWhatsAppMessage(guest);
            actionsCell.appendChild(waButton);
            
            // Ø²Ø± Ø§Ù„Ø­Ø°Ù
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'ğŸ—‘ï¸';
            deleteButton.className = 'btn-delete';
            deleteButton.onclick = () => deleteGuest(guest.internalId); 
            actionsCell.appendChild(deleteButton);
        });
    }

    document.addEventListener('DOMContentLoaded', renderGuestTable);
</script>
</body>
</html>
