<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مركز الإرسال اليدوي (توزيع آلي/يدوي للكروت)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Tahoma, Arial, sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-top: 30px; color: #5d7eaf; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background-color: #5d7eaf; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: background-color 0.3s; }
        .btn-action { background-color: #FF9800; color: white; }
        .btn-action:hover { background-color: #e68900; }
        .btn-qr { background-color: #00bcd4; color: white; }
        .btn-qr:hover { background-color: #0097a7; }
        .btn-whatsapp { background-color: #25D366; color: white; }
        .btn-whatsapp:hover { background-color: #1DA851; }
        .btn-delete { background-color: #f44336; color: white; }
        .btn-delete:hover { background-color: #da190b; }
        .btn-assign { background-color: #3f51b5; color: white; }
        .btn-assign:hover { background-color: #303f9f; }
        textarea { width: 98%; min-height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; margin-bottom: 15px; }
        .placeholder-note { color: #f44336; font-weight: bold; margin-bottom: 15px; display: block; text-align: right; }
        .form-control { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <h1>مركز الإرسال اليدوي (توزيع آلي/يدوي للكروت)</h1>

    <h2>⚙️ إدارة قائمة الضيوف</h2>

    <div style="margin-bottom: 15px; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
        <h3>استيراد القائمة (Excel أو CSV)</h3>
        <p>يجب أن تكون رؤوس الأعمدة في الملف هي: <strong><code>name</code>, <code>phone</code>, <code>companions</code></strong>.</p>
        <input type="file" id="guestListUpload" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="margin-bottom: 10px;">
        <button onclick="handleFileUpload()" class="btn-action">✅ استيراد الأسماء</button>
        <p>تم تحميل <span id="guestCount">0</span> ضيف.</p>
    </div>

    <div style="margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
        <h3>🖼️ استيراد صور الباركود</h3>
        <p>اختر كل ملفات الباركود دفعة واحدة. يتم التوزيع التلقائي **بالترتيب** على الضيوف.</p>
        <input type="file" id="barcodeUpload" accept="image/*" multiple style="margin-bottom: 10px;">
        <button onclick="loadBarcodes()" class="btn-action">استيراد الباركود</button>
        <p>تم استيراد <span id="barcodeCount">0</span> ملف باركود.</p>
        <p style="color: green; font-weight: bold;">أكواد الباركود المستوردة: <span id="importedQrCodes">لا يوجد</span></p>
    </div>
    
    <h2>➕ إضافة ضيف يدوياً</h2>
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
        <input type="text" id="newGuestName" placeholder="الاسم" class="form-control">
        <input type="text" id="newGuestPhone" placeholder="الهاتف (9665...)" class="form-control">
        <input type="number" id="newGuestCompanions" placeholder="المرافقين" min="0" value="0" class="form-control">
        <button onclick="addGuestManually()" class="btn-qr">إضافة الضيف</button>
    </div>

    <h2>🖊️ تعديل نص رسالة الواتساب التلقائية</h2>
    <span class="placeholder-note">
        استخدم المتغيرات: <code>#{{GUEST_NAME}}#</code> (الاسم), <code>#{{COMPANIONS_COUNT}}#</code> (المرافقين).
    </span>
    <textarea id="messageTemplate">
مرحباً #{{GUEST_NAME}}#،
نتشرف بدعوتكم لحضور... (مجموع الأفراد: #{{COMPANIONS_COUNT}}#).

الرجاء مسح كود الباركود في الصورة المرفقة للدخول.
    </textarea>

    <h2>📋 قائمة المدعوين</h2>
    <table>
        <thead>
            <tr>
                <th>اسم الضيف</th>
                <th>عدد المرافقين</th>
                <th>رقم الهاتف</th>
                <th>كود الباركود المخصص</th>
                <th>الإجراءات</th>
            </tr>
        </thead>
        <tbody id="guestTableBody">
            </tbody>
    </table>

</div>

<script>
    let guests = [];
    let barcodeImages = {}; // كائن يخزن بيانات الصور (المفتاح: اسم الملف بدون امتداد)
    let availableQrIds = []; // مصفوفة لتخزين مفاتيح الباركود المستوردة

    // يتم استخدام ID تسلسلي داخلي فقط لتسهيل الحذف والتعيين اليدوي
    let internalGuestIdCounter = 0; 


    // ----------------------------------------------------------------------
    // 1. وظائف الإدارة والاستيراد
    // ----------------------------------------------------------------------

    /**
     * يتعامل مع تحميل الملفات (CSV أو Excel)
     */
    function handleFileUpload() {
        const fileInput = document.getElementById('guestListUpload');
        const file = fileInput.files[0];
        if (!file) {
            alert('يرجى اختيار ملف أولاً.');
            return;
        }

        const fileExtension = file.name.split('.').pop().toLowerCase();

        if (fileExtension === 'csv') {
            readCSV(file);
        } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
            readExcel(file);
        } else {
            alert('صيغة الملف غير مدعومة. يرجى استخدام CSV أو XLSX.');
        }
    }

    function readCSV(file) {
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                processImportedData(results.data);
            },
            error: function(error) {
                alert(`خطأ في قراءة ملف CSV: ${error.message}`);
            }
        });
    }

    function readExcel(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const importedData = XLSX.utils.sheet_to_json(worksheet);
            processImportedData(importedData);
        };
        reader.readAsArrayBuffer(file);
    }
    
    /**
     * يعالج البيانات المستوردة ويقوم بالتوزيع التلقائي للباركود.
     */
    function processImportedData(data) {
        const requiredFields = ['name', 'phone', 'companions']; 
        
        if (data.length === 0 || !requiredFields.every(field => 
            Object.keys(data[0]).some(key => key.toLowerCase() === field.toLowerCase())
        )) {
            alert('خطأ: البيانات المستوردة لا تحتوي على جميع الأعمدة المطلوبة (name, phone, companions).');
            return;
        }

        // إعادة ضبط العداد الداخلي والضيوف
        internalGuestIdCounter = 0;
        
        let newGuests = data.map((guest) => {
            const getField = (field) => {
                const key = Object.keys(guest).find(k => k.toLowerCase() === field.toLowerCase());
                return key ? guest[key] : 'N/A';
            };
            
            // توليد ID داخلي فريد فقط للحذف والتعيين
            internalGuestIdCounter++;

            return {
                internalId: internalGuestIdCounter,
                name: String(getField('name')).trim() || 'N/A',
                phone: String(getField('phone')).trim() || 'N/A',
                companions: parseInt(getField('companions')) || 0,
                assignedQrId: null // سيتم تعيينه لاحقًا أو يدوياً
            };
        });

        guests = newGuests;
        // بعد تحميل الضيوف، نقوم بإعادة توزيع الباركود
        distributeBarcodesAutomatically();
        renderGuestTable();
        alert(`تم تحميل ${guests.length} ضيف بنجاح. سيتم الآن توزيع أكواد الباركود المستوردة بالترتيب.`);
    }

    /**
     * يضيف ضيفًا جديدًا من حقول الإدخال اليدوية.
     */
    function addGuestManually() {
        const nameInput = document.getElementById('newGuestName').value;
        const phoneInput = document.getElementById('newGuestPhone').value;
        const companionsInput = document.getElementById('newGuestCompanions').value;

        if (!nameInput || !phoneInput) {
            alert('يرجى ملء حقلي الاسم والهاتف على الأقل.');
            return;
        }
        
        internalGuestIdCounter++;

        const newGuest = {
            internalId: internalGuestIdCounter,
            name: nameInput,
            phone: phoneInput,
            companions: parseInt(companionsInput) || 0,
            assignedQrId: null // سيتم تعيينه يدويًا أو تلقائيًا (إذا لم يكن هناك ضيوف آخرون)
        };

        guests.push(newGuest);
        // التوزيع التلقائي للباركود غير المخصص
        distributeBarcodesAutomatically();
        renderGuestTable();

        document.getElementById('newGuestName').value = '';
        document.getElementById('newGuestPhone').value = '';
        document.getElementById('newGuestCompanions').value = '0';
    }
    
    /**
     * يحذف ضيفًا من القائمة.
     */
    function deleteGuest(internalId) {
        if (confirm('هل أنت متأكد من حذف هذا الضيف؟')) {
            guests = guests.filter(guest => guest.internalId !== internalId);
            distributeBarcodesAutomatically(); // إعادة التوزيع بعد الحذف
            renderGuestTable();
        }
    }

    /**
     * يحمّل صور الباركود ويخزنها في الذاكرة (كـ Base64).
     */
    function loadBarcodes() {
        const files = document.getElementById('barcodeUpload').files;
        if (files.length === 0) {
            alert('يرجى اختيار ملفات الصور أولاً.');
            return;
        }

        barcodeImages = {}; 
        availableQrIds = []; 
        let loadedCount = 0;

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const fileNameWithoutExtension = file.name.split('.').slice(0, -1).join(''); 
                barcodeImages[fileNameWithoutExtension] = e.target.result; 
                availableQrIds.push(fileNameWithoutExtension); 
                loadedCount++;
                document.getElementById('barcodeCount').textContent = loadedCount;
                
                // تحديث القائمة المعروضة
                document.getElementById('importedQrCodes').textContent = availableQrIds.join(', ');
                
                // عند اكتمال التحميل، أعد التوزيع التلقائي
                if (loadedCount === files.length) {
                    distributeBarcodesAutomatically();
                    renderGuestTable();
                    alert(`تم استيراد ${loadedCount} كود باركود بنجاح. وتم توزيعهم تلقائيًا على الضيوف.`);
                }
            };
            reader.readAsDataURL(file); 
        });
    }

    /**
     * وظيفة التوزيع التلقائي: يتم تعيين الباركود المستورد بالترتيب للضيوف غير المخصص لهم كرت.
     */
    function distributeBarcodesAutomatically() {
        const assignedIds = guests.map(g => g.assignedQrId).filter(id => id !== null);
        const unassignedQrIds = availableQrIds.filter(id => !assignedIds.includes(id));
        
        let qrIndex = 0;
        
        guests.forEach(guest => {
            // إذا لم يكن هناك كود باركود مُعيّن بالفعل، نقوم بتعيين أول كود غير مستخدم
            if (guest.assignedQrId === null && qrIndex < unassignedQrIds.length) {
                guest.assignedQrId = unassignedQrIds[qrIndex];
                qrIndex++;
            }
        });
    }

    /**
     * يسمح للمستخدم بتعيين كود باركود مختلف يدوياً للضيف.
     */
    function assignBarcode(internalId) {
        const currentGuest = guests.find(g => g.internalId === internalId);
        if (!currentGuest) return;

        // عرض قائمة الأكواد المستوردة للمساعدة
        const availableList = availableQrIds.filter(id => !guests.some(g => g.assignedQrId === id && g.internalId !== currentGuest.internalId));
        
        const defaultQr = currentGuest.assignedQrId || 'غير مخصص';
        let promptMessage = `أدخل كود الباركود الجديد لـ ${currentGuest.name}: (الحالي: ${defaultQr})\n\n`;
        promptMessage += `الأكواد غير المخصصة المتاحة: ${availableList.join(', ')}`;

        const newQrId = prompt(promptMessage, currentGuest.assignedQrId);

        if (newQrId === null) return; // المستخدم ألغى الأمر

        if (newQrId.trim() === '') {
            currentGuest.assignedQrId = null; // إلغاء التعيين
        } else if (newQrId !== currentGuest.assignedQrId) {
            // 1. التحقق من أن الكود تم استيراده بالفعل
            if (!barcodeImages[newQrId]) {
                 alert(`تحذير: الكود "${newQrId}" غير موجود في قائمة الباركود المستوردة!`);
            }
            // 2. التحقق من عدم تكرار الكود
            if (guests.some(g => g.assignedQrId === newQrId && g.internalId !== currentGuest.internalId)) {
                 alert(`خطأ: كود الباركود "${newQrId}" مُعيّن بالفعل لضيف آخر.`);
                return;
            }
            
            currentGuest.assignedQrId = newQrId; 
        }
        
        // بعد التعيين اليدوي، يتم إعادة التوزيع (لترتيب الأكواد غير المخصصة)
        distributeBarcodesAutomatically();
        renderGuestTable();
    }


    // ----------------------------------------------------------------------
    // 2. وظائف الإرسال والتحميل
    // ----------------------------------------------------------------------

    /**
     * وظيفة لتنزيل صورة الباركود المخصصة.
     */
    function downloadBarcodeImage(guest) {
        const qrCodeId = guest.assignedQrId; 
        
        if (!qrCodeId) {
             alert('خطأ: لم يتم تعيين كود باركود لهذا الضيف بعد. يرجى التعيين يدوياً أو استيراد الكروت.');
             return;
        }

        const imageName = `${qrCodeId}.png`; 
        const base64Data = barcodeImages[qrCodeId];
        
        if (!base64Data) {
            alert(`خطأ: لم يتم العثور على صورة لـ كود "${qrCodeId}". يرجى التأكد من استيراد ملف اسمه "${qrCodeId}.png".`);
            return;
        }

        const downloadLink = document.createElement('a');
        downloadLink.href = base64Data;
        downloadLink.download = imageName;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    }

    /**
     * وظيفة لفتح محادثة واتساب مع رسالة مُعدَّة مسبقاً.
     */
    function sendWhatsAppMessage(guest) {
        if (!guest.assignedQrId) {
             alert('لا يمكن إرسال الرسالة: لم يتم تعيين كود باركود لهذا الضيف.');
             return;
        }
        
        let messageText = document.getElementById('messageTemplate').value;

        messageText = messageText.replace(/#{{GUEST_NAME}}#/g, guest.name);
        messageText = messageText.replace(/#{{COMPANIONS_COUNT}}#/g, guest.companions);
        
        const waLink = `https://wa.me/${guest.phone}?text=${encodeURIComponent(messageText)}`;
        window.open(waLink, '_blank');
    }

    // ----------------------------------------------------------------------
    // 3. وظيفة عرض الجدول (Render)
    // ----------------------------------------------------------------------
    
    function renderGuestTable() {
        const tableBody = document.getElementById('guestTableBody');
        tableBody.innerHTML = '';
        document.getElementById('guestCount').textContent = guests.length;
        
        guests.forEach(guest => {
            const row = tableBody.insertRow();
            
            row.insertCell().textContent = guest.name;
            row.insertCell().textContent = guest.companions;
            row.insertCell().textContent = guest.phone;
            
            // كود الباركود المخصص
            const qrCodeCell = row.insertCell();
            qrCodeCell.textContent = guest.assignedQrId || 'لم يخصص';
            qrCodeCell.style.color = guest.assignedQrId ? '#333' : '#f44336'; 
            qrCodeCell.style.fontWeight = 'bold';

            const actionsCell = row.insertCell();

            // زر تعيين كود الباركود (الإختيار اليدوي)
            const assignButton = document.createElement('button');
            assignButton.textContent = 'تعيين/تغيير الكرت';
            assignButton.className = 'btn-assign';
            assignButton.onclick = () => assignBarcode(guest.internalId); 
            actionsCell.appendChild(assignButton);
            
            // زر تحميل الباركود
            const qrButton = document.createElement('button');
            qrButton.textContent = '💾 سحب الباركود';
            qrButton.className = 'btn-qr';
            qrButton.onclick = () => downloadBarcodeImage(guest); 
            
            if (!guest.assignedQrId || !barcodeImages[guest.assignedQrId]) {
                 qrButton.disabled = true;
                 qrButton.textContent = '🚫 لا يوجد كرت';
            }
            actionsCell.appendChild(qrButton);
            
            // زر إرسال واتساب
            const waButton = document.createElement('button');
            waButton.textContent = '💬 إرسال واتساب';
            waButton.className = 'btn-whatsapp';
            waButton.onclick = () => sendWhatsAppMessage(guest);
            actionsCell.appendChild(waButton);
            
            // زر الحذف
            const deleteButton = document.createElement('button');
            deleteButton.textContent = '🗑️';
            deleteButton.className = 'btn-delete';
            deleteButton.onclick = () => deleteGuest(guest.internalId); 
            actionsCell.appendChild(deleteButton);
        });
    }

    document.addEventListener('DOMContentLoaded', renderGuestTable);
</script>
</body>
</html>
