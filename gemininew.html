<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: Tahoma, Arial, sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-top: 30px; color: #5d7eaf; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background-color: #5d7eaf; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: background-color 0.3s; }
        .btn-action { background-color: #FF9800; color: white; }
        .btn-action:hover { background-color: #e68900; }
        .btn-qr { background-color: #00bcd4; color: white; }
        .btn-qr:hover { background-color: #0097a7; }
        .btn-whatsapp { background-color: #25D366; color: white; }
        .btn-whatsapp:hover { background-color: #1DA851; }
        textarea { width: 98%; min-height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; margin-bottom: 15px; }
        .placeholder-note { color: #f44336; font-weight: bold; margin-bottom: 15px; display: block; text-align: right; }
    </style>
</head>
<body>

<div class="container">
    <h1>Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹)</h1>

    <h2>âš™ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h2>

    <div style="margin-bottom: 15px; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
        <h3>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¶ÙŠÙˆÙ (CSV)</h3>
        <p>ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ù…Ù„Ù CSV Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¨ØªØ±ØªÙŠØ¨ Ù…Ø¹ÙŠÙ†: <strong><code>name</code> (Ø§Ù„Ø§Ø³Ù…), <code>phone</code> (Ø§Ù„Ù‡Ø§ØªÙ), <code>companions</code> (Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†)</strong>.</p>
        <input type="file" id="guestListUpload" accept=".csv" style="margin-bottom: 10px;">
        <button onclick="loadGuestsFromCSV()" class="btn-action">âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
        <p>ØªÙ… ØªØ­Ù…ÙŠÙ„ <span id="guestCount">0</span> Ø¶ÙŠÙ.</p>
    </div>

    <div style="margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
        <h3>Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h3>
        <p>Ø§Ø®ØªØ± ÙƒÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù‡Ùˆ **Ø±Ù‚Ù… ID Ø§Ù„Ø¶ÙŠÙ** (Ù…Ø«Ù„Ø§Ù‹: <code>1001.png</code>).</p>
        <input type="file" id="barcodeUpload" accept="image/*" multiple style="margin-bottom: 10px;">
        <button onclick="loadBarcodes()" class="btn-action">ğŸ–¼ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
        <p>ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ <span id="barcodeCount">0</span> Ù…Ù„Ù Ø¨Ø§Ø±ÙƒÙˆØ¯.</p>
    </div>

    <h2>ğŸ–Šï¸ ØªØ¹Ø¯ÙŠÙ„ Ù†Øµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</h2>
    <span class="placeholder-note">
        Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª: <code>#{{GUEST_NAME}}#</code>, <code>#{{COMPANIONS_COUNT}}#</code>. **(Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù† ØªØ¹Ù…Ù„ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ£ÙƒÙŠØ¯/Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±)**.
    </span>
    <textarea id="messageTemplate">
Ù…Ø±Ø­Ø¨Ø§Ù‹ #{{GUEST_NAME}}#ØŒ
Ù†ØªØ´Ø±Ù Ø¨Ø¯Ø¹ÙˆØªÙƒÙ… Ù„Ø­Ø¶ÙˆØ±... (Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£ÙØ±Ø§Ø¯: #{{COMPANIONS_COUNT}}#).

Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø³Ø­ ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø© Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ±.
    </textarea>

    <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†</h2>
    <table>
        <thead>
            <tr>
                <th>Ø§Ù„Ù€ ID (Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯)</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ</th>
                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="guestTableBody">
            </tbody>
    </table>

</div>

<script>
    let guests = [];
    // Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¦Ù† Ø³ÙŠØ®Ø²Ù† ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø´ÙØ±Ø© (Base64)
    let barcodeImages = {}; 

    // ----------------------------------------------------------------------
    // 1. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ (CSV ÙˆØ§Ù„ØµÙˆØ±)
    // ----------------------------------------------------------------------

    /**
     * ÙŠØ­Ù…Ù‘Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¶ÙŠÙˆÙ Ù…Ù† Ù…Ù„Ù CSV (Ø¨Ø«Ù„Ø§Ø«Ø© Ø£Ø¹Ù…Ø¯Ø© ÙÙ‚Ø·).
     */
    function loadGuestsFromCSV() {
        const fileInput = document.getElementById('guestListUpload');
        const file = fileInput.files[0];
        if (!file) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù CSV Ø£ÙˆÙ„Ø§Ù‹.');
            return;
        }

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                const requiredFields = ['name', 'phone', 'companions'];
                const data = results.data;
                
                if (data.length === 0 || !requiredFields.every(field => Object.keys(data[0]).includes(field))) {
                    alert('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ù…Ù„Ù CSV. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: name, phone, companions.');
                    return;
                }
                
                // ØªØ¹ÙŠÙŠÙ† ID Ù„ÙƒÙ„ Ø¶ÙŠÙ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ØªØ±ØªÙŠØ¨Ù‡ (G1, G2...) Ù„Ø±Ø¨Ø·Ù‡ Ø¨ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
                guests = data.map((guest, index) => ({
                    id: `${1000 + index + 1}`, // ØªÙˆÙ„ÙŠØ¯ ID Ø¨Ø³ÙŠØ· (Ù…Ø«Ù„Ø§Ù‹: 1001ØŒ 1002)
                    name: guest.name || 'N/A',
                    companions: parseInt(guest.companions) || 0,
                    phone: guest.phone || 'N/A',
                }));
                
                renderGuestTable();
                alert(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${guests.length} Ø¶ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­. ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù€ ID (Ù…Ø«Ù„ 1001) Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯.`);
            },
            error: function(error) {
                alert(`Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù CSV: ${error.message}`);
            }
        });
    }

    /**
     * ÙŠØ­Ù…Ù‘Ù„ ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆÙŠØ®Ø²Ù†Ù‡Ø§ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (ÙƒÙ€ Base64).
     */
    function loadBarcodes() {
        const files = document.getElementById('barcodeUpload').files;
        if (files.length === 0) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹.');
            return;
        }

        barcodeImages = {}; 
        let loadedCount = 0;

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù (Ø¨Ø¯ÙˆÙ† Ø§Ù…ØªØ¯Ø§Ø¯Ù‡) ÙƒÙ…ÙØªØ§Ø­ØŒ ÙˆÙ‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù€ ID
                // Ù…Ø«Ø§Ù„: Ù…Ù„Ù "1001.png" ÙŠØªÙ… ØªØ®Ø²ÙŠÙ†Ù‡ ØªØ­Øª Ø§Ù„Ù…ÙØªØ§Ø­ "1001"
                const fileNameWithoutExtension = file.name.split('.').slice(0, -1).join('.'); 
                barcodeImages[fileNameWithoutExtension] = e.target.result; 
                loadedCount++;
                document.getElementById('barcodeCount').textContent = loadedCount;
            };
            reader.readAsDataURL(file); 
        });
        alert('ØªÙ… Ø¨Ø¯Ø¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ØµÙˆØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ±.');
    }

    // ----------------------------------------------------------------------
    // 2. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±Ø¯ÙŠ
    // ----------------------------------------------------------------------

    /**
     * ÙˆØ¸ÙŠÙØ© Ù„ØªÙ†Ø²ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®ØµØµØ© (ÙØ±Ø¯ÙŠ) Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© (Base64).
     */
    function downloadBarcodeImage(guestId) {
        const imageName = `${guestId}.png`; // Ø§ÙØªØ±Ø§Ø¶ Ø£Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù‡Ùˆ ID Ø§Ù„Ø¶ÙŠÙ ÙˆØ§Ù…ØªØ¯Ø§Ø¯Ù‡ PNG
        const base64Data = barcodeImages[guestId];
        
        if (!base64Data) {
            alert(`Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ù„Ù€ ID Ø±Ù‚Ù… "${guestId}". ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù…Ù„Ù Ø§Ù„ØµÙˆØ±Ø© ÙŠØ­Ù…Ù„ Ø§Ø³Ù… "${guestId}.png" ÙˆØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡.`);
            return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· ÙˆÙ‡Ù…ÙŠ Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ù…Ù† Base64
        const downloadLink = document.createElement('a');
        downloadLink.href = base64Data;
        downloadLink.download = imageName;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    }

    /**
     * ÙˆØ¸ÙŠÙØ© Ù„ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¹ Ø±Ø³Ø§Ù„Ø© Ù…ÙØ¹Ø¯Ù‘ÙØ© Ù…Ø³Ø¨Ù‚Ø§Ù‹.
     */
    function sendWhatsAppMessage(guest) {
        let messageText = document.getElementById('messageTemplate').value;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù‚Ø¯ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        if (!barcodeImages[guest.id]) {
             console.warn(`ØªØ­Ø°ÙŠØ±: ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù€ ID ${guest.id} ØºÙŠØ± Ù…Ø³ØªÙˆØ±Ø¯Ø©!`);
        }

        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        messageText = messageText.replace(/#{{GUEST_NAME}}#/g, guest.name);
        messageText = messageText.replace(/#{{COMPANIONS_COUNT}}#/g, guest.companions);
        
        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…Ø© (Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù†Ø¸Ø§ÙØ©)
        messageText = messageText.replace(/{{CONFIRM_LINK}}/g, ''); 
        messageText = messageText.replace(/{{DECLINE_LINK}}/g, ''); 


        const waLink = `https://wa.me/${guest.phone}?text=${encodeURIComponent(messageText)}`;
        window.open(waLink, '_blank');
    }

    // ----------------------------------------------------------------------
    // 3. ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Render)
    // ----------------------------------------------------------------------
    
    function renderGuestTable() {
        const tableBody = document.getElementById('guestTableBody');
        tableBody.innerHTML = '';
        document.getElementById('guestCount').textContent = guests.length;
        
        guests.forEach(guest => {
            const row = tableBody.insertRow();
            
            row.insertCell().textContent = guest.id; // Ø¹Ø±Ø¶ Ø§Ù„Ù€ ID Ø§Ù„Ø°ÙŠ ÙŠÙ…Ø«Ù„ Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
            row.insertCell().textContent = guest.name;
            row.insertCell().textContent = guest.companions;
            row.insertCell().textContent = guest.phone;
            
            const actionsCell = row.insertCell();

            // Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (ÙØ±Ø¯ÙŠ)
            const qrButton = document.createElement('button');
            qrButton.textContent = 'ğŸ’¾ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯';
            qrButton.className = 'btn-qr';
            qrButton.onclick = () => downloadBarcodeImage(guest.id); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ ID
            actionsCell.appendChild(qrButton);
            
            // Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨
            const waButton = document.createElement('button');
            waButton.textContent = 'ğŸ’¬ Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨';
            waButton.className = 'btn-whatsapp';
            waButton.onclick = () => sendWhatsAppMessage(guest);
            actionsCell.appendChild(waButton);
        });
    }

    document.addEventListener('DOMContentLoaded', renderGuestTable);
</script>
</body>
</html>
