<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KRS — WA Dashboard (Debug)</title>
  <style>
    body{margin:0;font-family:system-ui;background:#0b1020;color:#e9edf5}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;margin-top:12px}
    button{cursor:pointer;background:rgba(214,177,94,.18);border:1px solid rgba(214,177,94,.35);color:#e9edf5;padding:10px 12px;border-radius:12px}
    input{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#e9edf5;padding:10px 12px;border-radius:12px;outline:none}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    pre{white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,.35);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid rgba(255,255,255,.10);padding:10px;text-align:right}
    .muted{color:#a7b0c3}
    .ok{color:#34d399}
    .bad{color:#fb7185}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <button id="btnLogin">تسجيل الدخول (Google)</button>
        <button id="btnLogout" style="display:none">تسجيل الخروج</button>
        <button id="btnTest">اختبار قراءة wa_messages</button>
        <input id="eventId" placeholder="eventId (اختياري) مثال: zafaf_khaled" style="flex:1;min-width:240px" />
      </div>
      <div class="muted" id="who">غير مسجّل دخول</div>
    </div>

    <div class="card">
      <div style="font-weight:800;margin-bottom:8px">نتيجة الاختبار</div>
      <div id="statusLine" class="muted">—</div>
      <pre id="debug">—</pre>
    </div>

    <div class="card">
      <div style="font-weight:800;margin-bottom:8px">آخر 50 سجل</div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>guestName</th>
              <th>to/recipient</th>
              <th>code</th>
              <th>eventId</th>
              <th>status</th>
              <th>docId</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, where, limit }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ✅ ضع config الصحيح لمشروع hormez-inv
    const firebaseConfig = {
      apiKey: "PUT_API_KEY",
      authDomain: "hormez-inv.firebaseapp.com",
      projectId: "hormez-inv",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const tbody = $("tbody");

    function showDebug(obj){
      $("debug").textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }

    $("btnLogin").onclick = async ()=>{
      await signInWithPopup(auth, new GoogleAuthProvider());
    };
    $("btnLogout").onclick = async ()=>{
      await signOut(auth);
    };

    onAuthStateChanged(auth, (user)=>{
      if(user){
        $("who").innerHTML = `<span class="ok">مسجّل دخول:</span> ${user.email} — UID: ${user.uid}`;
        $("btnLogin").style.display="none";
        $("btnLogout").style.display="inline-block";
      }else{
        $("who").innerHTML = `غير مسجّل دخول`;
        $("btnLogin").style.display="inline-block";
        $("btnLogout").style.display="none";
      }
    });

    $("btnTest").onclick = async ()=>{
      try{
        $("statusLine").innerHTML = "جار القراءة...";
        showDebug("...");

        const ev = $("eventId").value.trim();

        const col = collection(db, "wa_messages");

        // ✅ اختبار بسيط جداً (بدون orderBy ولا indexes)
        const qq = ev ? query(col, where("eventId","==",ev), limit(50)) : query(col, limit(50));

        const snap = await getDocs(qq);

        $("statusLine").innerHTML = `<span class="ok">نجح</span> — docs: ${snap.size}`;
        const arr = [];
        tbody.innerHTML = "";

        snap.forEach(doc=>{
          const d = doc.data() || {};
          arr.push({ docId: doc.id, ...d });

          const status = d.lastStatus || d.status || d?.lastStatusRaw?.status || "-";
          const to = d.to || d.recipient_id || d?.lastStatusRaw?.recipient_id || "-";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.guestName || "-"}</td>
            <td dir="ltr" style="text-align:left">${to}</td>
            <td dir="ltr" style="text-align:left">${d.code || "-"}</td>
            <td>${d.eventId || "-"}</td>
            <td>${status}</td>
            <td dir="ltr" style="text-align:left">${doc.id}</td>
          `;
          tbody.appendChild(tr);
        });

        showDebug(arr[0] ? { sampleFirstDoc: arr[0] } : "لا توجد وثائق للعرض");

      }catch(e){
        $("statusLine").innerHTML = `<span class="bad">فشل</span>`;
        showDebug({
          name: e?.name,
          message: e?.message,
          code: e?.code,
          stack: (e?.stack || "").split("\n").slice(0,3).join("\n")
        });
      }
    };
  </script>
</body>
</html>
