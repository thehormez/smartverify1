<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>Hormez â€” Ù…Ø§Ø³Ø­ Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
Â  <style>
Â  Â  :root{--bg:#0b1020;--ink:#e5e7eb;--muted:#94a3b8;--line:#334155;--ok:#22c55e;--bad:#ef4444;--warn:#f59e0b;--card:#0e172a}
Â  Â  html,body{height:100%}
Â  Â  body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
Â  Â  .topbar{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid #243047}
Â  Â  .container{max-width:1200px;margin:0 auto;padding:14px}
Â  Â  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
Â  Â  .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
Â  Â  .btn{appearance:none;border:1px solid var(--line);background:#0b1220;color:var(--ink);border-radius:10px;padding:10px 14px;cursor:pointer}
Â  Â  .btn:disabled{opacity:.5;cursor:not-allowed}
Â  Â  .btn:hover{background:#0d1528}
Â  Â  .select,.input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
Â  Â  .grid{display:grid;gap:12px}
Â  Â  @media(min-width:1024px){.grid-2{grid-template-columns:2fr 1fr}}
Â  Â  .muted{color:var(--muted)}
Â  Â  .dot{width:10px;height:10px;border-radius:50%}
Â  Â  .status{display:flex;gap:8px;align-items:center}

Â  Â  /* Scanner video */
Â  Â  .scanWrap{
      position:relative;width:100%;aspect-ratio:3/4;max-width:480px;
      margin-inline:auto;border-radius:14px;overflow:hidden;background:#000;
      border:1px solid rgba(255,255,255,.08);
      /* ğŸŸ¢ Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù„Ø¬Ø¹Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø³Ù„Ø³Ù‹Ø§ */
      transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
    }
Â  Â  /* ğŸŸ¢ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¶Ø§Ø¡Ø© Ø§Ù„Ø´Ø§Ø´Ø© */
    .scanWrap.status-ok {
        background-color: var(--ok); /* Ø£Ø®Ø¶Ø± Ù„Ù„Ù‚Ø¨ÙˆÙ„ */
        border-color: var(--ok);
    }
    .scanWrap.status-bad {
        background-color: var(--bad); /* Ø£Ø­Ù…Ø± Ù„Ù„Ø±ÙØ¶ */
        border-color: var(--bad);
    }
Â  Â  #video{width:100%;height:100%;object-fit:cover}
Â  Â  .frame{position:absolute;inset:0;pointer-events:none}
Â  Â  .corner{position:absolute;width:42px;height:42px;border:3px solid rgba(255,255,255,.7)}
Â  Â  .corner.tl{top:12px;left:12px;border-right:none;border-bottom:none;border-radius:10px 0 0 0}
Â  Â  .corner.tr{top:12px;right:12px;border-left:none;border-bottom:none;border-radius:0 10px 0 0}
Â  Â  .corner.bl{bottom:12px;left:12px;border-right:none;border-top:none;border-radius:0 0 0 10px}
Â  Â  .corner.br{bottom:12px;right:12px;border-left:none;border-top:none;border-radius:0 0 10px 0}

Â  Â  /* Last result */
Â  Â  .qrBox{display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:center}
Â  Â  .qrBox canvas{background:#fff;border-radius:10px}

Â  Â  .hist{max-height:300px;overflow:auto}
Â  Â  .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0b1220}
Â  Â  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
Â  </style>
</head>
<body>
Â  Â  <div class="topbar">
Â  Â  <div class="container row" style="justify-content:space-between">
Â  Â  Â  <div class="row"><div style="font-weight:900">HS</div><div class="muted">Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ â€” Ù…Ù†Ø§Ø³Ø¨Ø© Ù…Ø­Ø¯Ø¯Ø©</div></div>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <span class="tag">Event: <b id="evTag">â€”</b></span>
Â  Â  Â  Â  <button id="setEventBtn" class="btn">ØªØ¹ÙŠÙŠÙ†/ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¯Ø«</button>
Â  Â  Â  Â  <button id="langBtn" class="btn">AR</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="container grid grid-2">
Â  Â  Â  Â  <div class="card">
Â  Â  Â  <div class="row" style="justify-content:space-between; gap:8px">
Â  Â  Â  Â  <div class="status"><div id="statusDot" class="dot" style="background:#9ca3af"></div><div id="statusText" class="muted">â€”</div></div>
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <button id="startBtn" class="btn">â–¶ï¸ ØªØ´ØºÙŠÙ„</button>
Â  Â  Â  Â  Â  <button id="stopBtn" class="btn" disabled>â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
Â  Â  Â  Â  Â  <button id="switchBtn" class="btn">ğŸ”„ ØªØ¨Ø¯ÙŠÙ„</button>
Â  Â  Â  Â  Â  <button id="torchBtn" class="btn">ğŸ’¡ ÙÙ„Ø§Ø´</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="scanWrap" id="scanWrap">
Â  Â  Â  Â  <video id="video" playsinline muted autoplay></video>
Â  Â  Â  Â  <div class="frame">
Â  Â  Â  Â  Â  <div class="corner tl"></div>
Â  Â  Â  Â  Â  <div class="corner tr"></div>
Â  Â  Â  Â  Â  <div class="corner bl"></div>
Â  Â  Â  Â  Â  <div class="corner br"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="row" style="margin-top:10px">
Â  Â  Â  Â  <div style="width:160px">
Â  Â  Â  Â  Â  <div class="muted">ÙØªØ±Ø© Ø§Ù„ØªÙˆÙ‚Ù (Ù…Ù„Ù‘ÙŠ Ø«Ø§Ù†ÙŠØ©)</div>
Â  Â  Â  Â  Â  <input id="pauseMs" class="input" type="number" value="2000" />
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="width:150px">
Â  Â  Â  Â  Â  <div class="muted">Ø§Ù„Ø£ØµÙˆØ§Øª</div>
Â  Â  Â  Â  Â  <select id="soundMode" class="select">
Â  Â  Â  Â  Â  Â  <option value="on">ØªØ´ØºÙŠÙ„</option>
Â  Â  Â  Â  Â  Â  <option value="off">Ø¥ÙŠÙ‚Ø§Ù</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="width:180px">
Â  Â  Â  Â  Â  <div class="muted">Ø­Ø¬Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦</div>
Â  Â  Â  Â  Â  <select id="scanSize" class="select">
Â  Â  Â  Â  Â  Â  <option value="360">ØµØºÙŠØ±</option>
Â  Â  Â  Â  Â  Â  <option value="480" selected>Ù…ØªÙˆØ³Ø·</option>
Â  Â  Â  Â  Â  Â  <option value="680">ÙƒØ¨ÙŠØ±</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="width:220px">
Â  Â  Â  Â  Â  <div class="muted">Ù†Ù…Ø· Ø§Ù„ÙƒÙˆØ¯ (Regex)</div>
Â  Â  Â  Â  Â  <input id="codeRegex" class="input mono" value="^[A-Z]{2}_[0-9]{3,}$" />
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="width:170px">
Â  Â  Â  Â  Â  <div class="muted">ÙˆØ¶Ø¹ ØµØ§Ø±Ù…</div>
Â  Â  Â  Â  Â  <select id="strictMode" class="select">
Â  Â  Â  Â  Â  Â  <option value="on">Ø§Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ ÙÙ‚Ø·</option>
Â  Â  Â  Â  Â  Â  <option value="off">Ø§Ù‚Ø¨Ù„ Ø§Ù„ÙƒÙ„</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row" style="margin-top:10px">
Â  Â  Â  Â  <div style="flex:1">
Â  Â  Â  Â  Â  <div class="muted" id="lblCam">Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div>
Â  Â  Â  Â  Â  <select id="cameraSelect" class="select"></select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="flex:1">
Â  Â  Â  Â  Â  <div class="muted" id="lblManual">Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <input id="manualCode" class="input" placeholder="SA_001" />
Â  Â  Â  Â  Â  Â  <button id="manualBtn" class="btn">ØªØ­Ù‚Ù‚</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="httpsWarn" class="card" style="display:none; margin-top:10px; border-color:#7f1d1d;background:#450a0a;color:#fecaca">
Â  Â  Â  Â  âš ï¸ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØªØ·Ù„Ø¨ HTTPS Ø£Ùˆ localhost.
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="card">
Â  Â  Â  <div class="muted" style="font-size:12px">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©</div>
Â  Â  Â  <div class="qrBox" style="margin-top:6px">
Â  Â  Â  Â  <canvas id="qrCanvas" width="120" height="120"></canvas>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div id="lastCode" class="mono" style="font-size:22px;font-weight:800">â€”</div>
Â  Â  Â  Â  Â  <div id="lastMsg" class="muted" style="font-size:12px;margin-top:4px">â€”</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="grid-column:1/3; margin-top:10px; font-size:14px; text-align:center;">
          <span id="flashMessage" style="font-weight:bold; color:var(--ink)"></span>
        </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="muted" style="font-size:12px;margin-top:14px">Ø§Ù„Ø³Ø¬Ù„ (Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©)</div>
Â  Â  Â  <div id="hist" class="hist"></div>
Â  Â  Â  <div class="row" style="margin-top:8px"><button id="clearHist" class="btn">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button></div>
Â  Â  </div>
Â  </div>

Â  Â  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

Â  Â  <script>
Â  Â  (function(){
Â  Â  Â  const CANDS=[
Â  Â  Â  Â  'https://unpkg.com/@zxing/browser@0.1.3/umd/index.min.js',
Â  Â  Â  Â  'https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.3/umd/index.min.js',
Â  Â  Â  Â  'https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js',
Â  Â  Â  Â  'https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js'
Â  Â  Â  ];
Â  Â  Â  function load(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.async=true;s.onload=()=>res();s.onerror=rej;document.head.appendChild(s);});}
Â  Â  Â  window.ensureZXing=async()=>{if(window.ZXing&&(window.ZXing.BrowserMultiFormatReader||window.ZXing.BrowserQRCodeReader))return true;for(const u of CANDS){try{await load(u);if(window.ZXing&&(window.ZXing.BrowserMultiFormatReader||window.ZXing.BrowserQRCodeReader))return true;}catch(_){} }return !!(window.ZXing&&(window.ZXing.BrowserMultiFormatReader||window.ZXing.BrowserQRCodeReader))};
Â  Â  Â  window.hasNativeDetector = 'BarcodeDetector' in window;
Â  Â  })();
Â  </script>

Â  Â  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

Â  <script>
Â  (function(){
Â  Â  const $=(s,root=document)=>root.querySelector(s);
Â  Â  const T={
Â  Â  Â  ar:{ready:'Ø¬Ø§Ù‡Ø²',checking:'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚â€¦',start:'â–¶ï¸ ØªØ´ØºÙŠÙ„',stop:'â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù',switch:'ğŸ”„ ØªØ¨Ø¯ÙŠÙ„',flash:'ğŸ’¡ ÙÙ„Ø§Ø´',camera:'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§',manual:'Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ',ok:'âœ… Ù…Ù‚Ø¨ÙˆÙ„',dupe:'âš ï¸ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ø³Ø§Ø¨Ù‚Ù‹Ø§',notfound:'âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯',mismatch:'âŒ Ù„Ø§ ÙŠØ®Øµ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©',needHttps:'âš ï¸ ÙŠØªØ·Ù„Ø¨ HTTPS',camlib:'âš ï¸ Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù… ØªÙØ­Ù…Ù‘Ù„',paused:'â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª',needEvent:'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹ÙŠÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹'},
Â  Â  Â  en:{ready:'Ready',checking:'Checkingâ€¦',start:'â–¶ï¸ Start',stop:'â¹ï¸ Stop',switch:'ğŸ”„ Switch',flash:'ğŸ’¡ Torch',camera:'Camera',manual:'Manual input',ok:'âœ… Accepted',dupe:'âš ï¸ Already used',notfound:'âŒ Code not found',mismatch:'âŒ Not this event',needHttps:'âš ï¸ HTTPS required',camlib:'âš ï¸ Camera lib not loaded',paused:'â¸ï¸ Paused',needEvent:'Please set the event name first'}
Â  Â  };
Â  Â  let LANG=localStorage.getItem('hs:evscan:lang')||'ar';
Â  Â  function i18n(){ const L=T[LANG]; $('#langBtn').textContent = (LANG==='ar'?'EN':'AR'); $('#statusText').textContent=L.ready; $('#lblCam').textContent=L.camera; $('#lblManual').textContent=L.manual; $('#startBtn').textContent=L.start; $('#stopBtn').textContent=L.stop; $('#switchBtn').textContent=L.switch; $('#torchBtn').textContent=L.flash; }

Â  Â  // ===== Firebase =====
Â  Â  const cfg={ apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac", authDomain:"hormez-inv.firebaseapp.com", projectId:"hormez-inv" };
Â  Â  if(!firebase.apps.length){ firebase.initializeApp(cfg); }
Â  Â  const db=firebase.firestore();

Â  Â  // ===== Event handling =====
Â  Â  const URL_EVENT = new URLSearchParams(location.search).get('event');
Â  Â  let EVENT_LOCKED = false; // true Ø¥Ø°Ø§ Ù…Ø­Ø¯Ø¯ Ù…Ù† URL
Â  Â  let EVENT_NAME = '';

Â  Â  function setEvent(name, locked=false){
Â  Â  Â  EVENT_NAME = String(name||'').trim();
Â  Â  Â  EVENT_LOCKED = !!locked;
Â  Â  Â  $('#evTag').textContent = EVENT_NAME || 'â€”';
Â  Â  Â  localStorage.setItem('hs:evscan:event', EVENT_NAME);
Â  Â  Â  renderHist();
Â  Â  Â  $('#evSetup')?.classList?.add?.('hidden');
Â  Â  Â  $('#startBtn').disabled = !httpsOK() || !EVENT_NAME;
Â  Â  Â  $('#manualBtn').disabled = !EVENT_NAME;
Â  Â  }

Â  Â  function initEvent(){
Â  Â  Â  const saved = localStorage.getItem('hs:evscan:event')||'';
Â  Â  Â  if(URL_EVENT){ setEvent(URL_EVENT, true); }
Â  Â  Â  else if(saved){ setEvent(saved, false); }
Â  Â  Â  else { // Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ¹ÙŠÙŠÙ†
Â  Â  Â  Â  // Ø£Ø¶Ù Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³ÙÙ„ Ø§Ù„ØªÙˆØ¨ Ø¨Ø§Ø±
Â  Â  Â  Â  const card=document.createElement('div'); card.className='card'; card.id='evSetup';
Â  Â  Â  Â  card.innerHTML=`<div class="muted" style="margin-bottom:6px">Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø¨Ø§Ù„Ø¶Ø¨Ø· ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Firestore (Ø§Ù„Ø­Ù‚Ù„ EventName)</div>
Â  Â  Â  Â  <div class="row"><input id="evInput" class="input" placeholder="Ù…Ø«Ø§Ù„: Ø²ÙØ§Ù Ø³Ø¹ÙŠØ¯" /><button id="saveEv" class="btn">Ø­ÙØ¸</button></div>`;
Â  Â  Â  Â  document.querySelector('.container').prepend(card);
Â  Â  Â  Â  $('#startBtn').disabled = true; $('#manualBtn').disabled=true;
Â  Â  Â  Â  $('#saveEv').addEventListener('click', ()=>{ const v=$('#evInput').value.trim(); if(!v) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©'); if(scanning){ stop(); } setEvent(v,false); });
Â  Â  Â  }
Â  Â  }

Â  Â  // HTTPS guard
Â  Â  function httpsOK(){ const isLocal = ['localhost','127.0.0.1'].includes(location.hostname); const ok = location.protocol==='https:'||isLocal; $('#httpsWarn').style.display = ok? 'none':'block'; if(!ok) { $('#startBtn').disabled=true; } return ok; }

Â  Â  // History per event
Â  Â  function hKey(){ return `hs:evscan:hist:${EVENT_NAME||'__NONE__'}` }
Â  Â  function getHist(){ try{ return JSON.parse(localStorage.getItem(hKey())||'[]'); }catch{return []} }
Â  Â  function pushHist(code,msg,good){ const h=getHist(); h.unshift({code,msg,at:Date.now(),good}); localStorage.setItem(hKey(), JSON.stringify(h.slice(0,80))); renderHist(); }
Â  Â  function renderHist(){ const box=$('#hist'); const L=T[LANG]; box.innerHTML=''; const h=getHist(); if(!EVENT_NAME){ box.innerHTML = `<div class="muted">${L.needEvent}</div>`; return; } if(!h.length){ box.innerHTML = `<div class="muted">â€”</div>`; return; } h.forEach(x=>{ const d=document.createElement('div'); d.style.padding='6px'; d.style.borderTop='1px solid var(--line)'; d.innerHTML = `<div class="mono">${x.code}</div><div class=\"muted\" style=\"font-size:12px\">${new Date(x.at).toLocaleString(LANG==='ar'?'ar-EG':'en-GB')} â€” ${x.msg}</div>`; box.appendChild(d); }); }

Â  Â  // ===== Audio (WebAudio, unlocked on Start) =====
Â  Â  let audioCtx=null;
Â  Â  function ensureAudio(){ try{ if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } if(audioCtx.state==='suspended') audioCtx.resume(); }catch{} }
Â  Â  window.__hsPlayTone = function(type='ok'){
Â  Â  Â  if(document.getElementById('soundMode')?.value==='off') return;
Â  Â  Â  try{
Â  Â  Â  Â  ensureAudio(); if(!audioCtx) return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
Â  Â  Â  Â  o.type='sine'; o.frequency.value = (type==='ok')? 880 : 220; const now=audioCtx.currentTime; const dur=(type==='ok')?0.12:0.22;
Â  Â  Â  Â  o.connect(g); g.connect(audioCtx.destination);
Â  Â  Â  Â  g.gain.setValueAtTime(0.0001, now);
Â  Â  Â  Â  g.gain.exponentialRampToValueAtTime(0.2, now+0.02);
Â  Â  Â  Â  g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
Â  Â  Â  Â  o.start(); o.stop(now+dur+0.02);
Â  Â  Â  }catch{}
Â  Â  }

Â  Â  // UI helpers
Â  Â  function setStatus(text,color){ $('#statusText').textContent=text; $('#statusDot').style.background=color; }
Â  Â  function drawQRPreview(text){ const c=$('#qrCanvas'); if(!c) return; try{ if(!text){ const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,c.width,c.height); return; } QRCode.toCanvas(c, text, {width:120, margin:1}, ()=>{}); }catch{} }
Â  Â  
    // ğŸŸ¢ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø´Ø§Ø´Ø© (Ø§Ù„ÙÙ„Ø§Ø´)
    function flashScreen(good) {
        const wrap = $('#scanWrap');
        if (!wrap) return;

        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ÙØ¦Ø§Øª Ø­Ø§Ù„Ø© Ø³Ø§Ø¨Ù‚Ø©
        wrap.classList.remove('status-ok', 'status-bad');
        
        // ØªØ­Ø¯ÙŠØ¯ ÙØ¦Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        const statusClass = good ? 'status-ok' : 'status-bad';
        wrap.classList.add(statusClass);

        // Ø¥Ø²Ø§Ù„Ø© ÙØ¦Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ 300 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© (Ù„ØªÙˆÙÙŠØ± ÙˆÙ…ÙŠØ¶)
        setTimeout(() => {
            wrap.classList.remove(statusClass);
        }, 300); 
    }

    // ğŸŸ¢ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙˆÙ…ÙŠØ¶
Â  Â  function showLast(code,msg,good){ 
        $('#lastCode').textContent=code||'â€”'; 
        $('#lastCode').style.color = good? '#86efac':'#fca5a5'; 
        $('#lastMsg').textContent=msg||''; 
        drawQRPreview(code||''); 
        
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø´Ø§Ø´Ø©
        flashScreen(good);

        try{ 
            window.__hsPlayTone(good? 'ok':'err'); 
            navigator.vibrate?.(good? 60:120); 
        }catch{} 
    }

Â  Â  // Camera state
Â  Â  let devices=[], currentDeviceId=null, track=null, scanning=false, torch=false, rafId=null; let reader=null, ndet=null; let locked=false; function lockPause(){ locked=true; const ms = Math.max(300, parseInt($('#pauseMs')?.value||'2000',10)); setTimeout(()=>{ locked=false; }, ms); }

Â  Â  // Regex/Strict helpers
Â  Â  function strictOn(){ return (document.getElementById('strictMode')?.value||'on')==='on'; }
Â  Â  function codeRegex(){ try{ return new RegExp(document.getElementById('codeRegex')?.value||''); }catch{ return null; } }

Â  Â  async function ensurePerm(){ try{ const tmp=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false}); tmp.getTracks().forEach(t=>t.stop()); }catch{} }
Â  Â  async function listCams(){ const all=await navigator.mediaDevices.enumerateDevices(); devices = all.filter(d=>d.kind==='videoinput'); const sel=$('#cameraSelect'); sel.innerHTML=''; devices.forEach((d,i)=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||`Camera ${i+1}`; sel.appendChild(o); }); if(devices.length){ if(!currentDeviceId){ const back=devices.find(d=>/back|rear|environment|Ø®Ù„Ù/i.test(d.label||'')); currentDeviceId = back? back.deviceId : devices[0].deviceId; } sel.value=currentDeviceId; }
Â  Â  }

Â  Â  async function start(){ locked=false; ensureAudio(); if(!EVENT_NAME){ alert(T[LANG].needEvent); return; } if(!httpsOK()) { alert(T[LANG].needHttps); return; } await ensurePerm(); await listCams(); const video=$('#video'); const dev=$('#cameraSelect').value||currentDeviceId; currentDeviceId=dev; const stream = await navigator.mediaDevices.getUserMedia({video:{deviceId: dev? {exact:dev}:undefined, focusMode:'continuous'}, audio:false}); video.srcObject=stream; await video.play().catch(()=>{}); track = stream.getVideoTracks()[0]||null; scanning=true; $('#startBtn').disabled=true; $('#stopBtn').disabled=false; setStatus(T[LANG].ready,'#22c55e');
Â  Â  Â  const zxingOk = await window.ensureZXing();
Â  Â  Â  if(zxingOk && window.ZXing && window.ZXing.BrowserMultiFormatReader){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  if(window.ZXing && window.ZXing.BarcodeFormat && window.ZXing.DecodeHintType){
Â  Â  Â  Â  Â  Â  const hints = new Map();
Â  Â  Â  Â  Â  Â  hints.set(window.ZXing.DecodeHintType.POSSIBLE_FORMATS, [window.ZXing.BarcodeFormat.QR_CODE]);
Â  Â  Â  Â  Â  Â  reader = new window.ZXing.BrowserMultiFormatReader(hints);
Â  Â  Â  Â  Â  }else{
Â  Â  Â  Â  Â  Â  reader = new window.ZXing.BrowserMultiFormatReader();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }catch{ reader = new window.ZXing.BrowserMultiFormatReader(); }
Â  Â  Â  Â  reader.decodeFromVideoDevice(dev||null, video, (res,err)=>{ if(res){ if(locked) return; const text = res.getText? res.getText(): (res.text||''); handleRawScan(String(text||'').trim()); } });
Â  Â  Â  }
Â  Â  Â  else if('BarcodeDetector' in window){
Â  Â  Â  Â  ndet = new window.BarcodeDetector({formats:['qr_code']});
Â  Â  Â  Â  const loop=async()=>{ if(!scanning) return; try{ if(!locked){ const bar=await ndet.detect(video); if(bar && bar.length){ handleRawScan(String(bar[0].rawValue||'').trim()); } } }catch{} rafId = requestAnimationFrame(loop); }; loop();
Â  Â  Â  } else {
Â  Â  Â  Â  alert(T[LANG].camlib); setStatus(T[LANG].camlib,'#f59e0b');
Â  Â  Â  }
Â  Â  }

Â  Â  async function stop(){ try{ if(reader){ try{reader.reset();}catch{} reader=null; } if(rafId){ cancelAnimationFrame(rafId); rafId=null; } if(track){ try{track.stop();}catch{} track=null; } const v=$('#video'); if(v.srcObject){ v.srcObject.getTracks().forEach(t=>t.stop()); v.srcObject=null; } }catch{} scanning=false; $('#startBtn').disabled=false; $('#stopBtn').disabled=true; setStatus(T[LANG].paused,'#f59e0b'); }

Â  Â  async function switchCam(){ if(!devices.length) return; const idx=devices.findIndex(d=>d.deviceId===currentDeviceId); const next=devices[(idx+1)%devices.length]; currentDeviceId=next.deviceId; $('#cameraSelect').value=currentDeviceId; if(scanning){ await stop(); await start(); } }

Â  Â  async function toggleTorch(){ try{ if(!track) return; const caps=track.getCapabilities?.(); if(!caps?.torch) return alert('No torch'); const on = caps.torch && !(track.getConstraints()?.advanced?.[0]?.torch); await track.applyConstraints({advanced:[{torch: on}]}); }catch(e){ alert('Torch error'); } }

Â  Â  // ===== Verification (event-locked)
    // ğŸŸ¢ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ verifyAndMark Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø­Ø§Ù„Ø© dot Ø¥Ù„Ù‰ "Ø¬Ø§Ù‡Ø²" Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø±Ø¶
Â  Â  async function verifyAndMark(code){ 
        const L=T[LANG]; 
        setStatus(L.checking,'#f59e0b'); // Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚
Â  Â  Â  try{
Â  Â  Â  Â  if(!EVENT_NAME){ 
            showLast(code, L.needEvent, false); 
            setStatus(L.paused,'#f59e0b'); // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª
            return; 
        }
Â  Â  Â  Â  const ref = db.collection('invites');
Â  Â  Â  Â  const q = await ref.where('Code','==',code).where('EventName','==',EVENT_NAME).limit(1).get();
Â  Â  Â  Â  if(q.empty){ 
            showLast(code,L.mismatch,false); 
            pushHist(code,L.mismatch,false); 
            setStatus(L.ready,'#22c55e'); // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²
            return; 
        }
Â  Â  Â  Â  const doc = q.docs[0]; 
        const data = doc.data()||{};
Â  Â  Â  Â  if(String((data.Status||'')).toLowerCase()==='yes'){
Â  Â  Â  Â  Â  showLast(code,L.dupe,false); 
            pushHist(code,L.dupe,false); 
            setStatus(L.ready,'#22c55e'); // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  await doc.ref.set({ Status:'yes', scannedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
Â  Â  Â  Â  Â  showLast(code,L.ok,true); 
            pushHist(code,L.ok,true);
            setStatus(L.ready,'#22c55e'); // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²
Â  Â  Â  Â  }
Â  Â  Â  }catch(e){ 
        showLast(code, e.message||'Error', false); 
        pushHist(code, e.message||'Error', false); 
        setStatus(L.ready,'#22c55e'); // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²
    }
Â  Â  }

Â  Â  function onCode(text){ if(!text) return; if(locked) return; lockPause(); verifyAndMark(text); }

Â  Â  function handleRawScan(raw){
Â  Â  Â  const strict = strictOn();
Â  Â  Â  const re = codeRegex();
Â  Â  Â  if(strict){ if(!re) return; if(!re.test(raw)) return; }
Â  Â  Â  onCode(raw);
Â  Â  }

Â  Â  // Wire
Â  Â  document.addEventListener('DOMContentLoaded', ()=>{
Â  Â  Â  i18n(); httpsOK(); initEvent(); renderHist(); drawQRPreview('');
Â  Â  Â  // Ø­Ø¬Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦
Â  Â  Â  const savedW = localStorage.getItem('hs:evscan:scanw');
Â  Â  Â  if(savedW && document.getElementById('scanSize')){
Â  Â  Â  Â  document.getElementById('scanSize').value = savedW;
Â  Â  Â  }
Â  Â  Â  applyScanSize();
Â  Â  Â  document.getElementById('scanSize')?.addEventListener('change', applyScanSize);

Â  Â  Â  $('#langBtn').addEventListener('click', ()=>{ LANG= (LANG==='ar')?'en':'ar'; localStorage.setItem('hs:evscan:lang',LANG); i18n(); renderHist(); });
Â  Â  Â  $('#startBtn').addEventListener('click', ()=>{ ensureAudio(); start(); });
Â  Â  Â  $('#stopBtn').addEventListener('click', stop);
Â  Â  Â  $('#switchBtn').addEventListener('click', switchCam);
Â  Â  Â  $('#torchBtn').addEventListener('click', toggleTorch);
Â  Â  Â  $('#manualBtn').addEventListener('click', ()=>{ ensureAudio(); const c=$('#manualCode').value.trim(); if(!c){return;} handleRawScan(c); });
Â  Â  Â  $('#clearHist').addEventListener('click', ()=>{ if(!EVENT_NAME) return; localStorage.removeItem(hKey()); renderHist(); });

Â  Â  Â  $('#setEventBtn').addEventListener('click', ()=>{
Â  Â  Â  Â  if(EVENT_LOCKED){ alert('ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯Ø« Ù…Ù† Ø®Ù„Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡.'); return; }
Â  Â  Â  Â  const ex=document.getElementById('evSetup');
Â  Â  Â  Â  if(ex){ ex.classList.toggle('hidden'); ex.querySelector('#evInput')?.focus(); }
Â  Â  Â  Â  else{
Â  Â  Â  Â  Â  const card=document.createElement('div'); card.className='card'; card.id='evSetup';
Â  Â  Â  Â  Â  card.innerHTML=`<div class="muted" style="margin-bottom:6px">Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø¨Ø§Ù„Ø¶Ø¨Ø· ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Firestore (Ø§Ù„Ø­Ù‚Ù„ EventName)</div>
Â  Â  Â  Â  Â  <div class="row"><input id="evInput" class="input" placeholder="Ù…Ø«Ø§Ù„: Ø²ÙØ§Ù Ø³Ø¹ÙŠØ¯" /><button id="saveEv" class="btn">Ø­ÙØ¸</button></div>`;
Â  Â  Â  Â  Â  document.querySelector('.container').prepend(card);
Â  Â  Â  Â  Â  document.getElementById('saveEv').addEventListener('click', ()=>{ const v=document.getElementById('evInput').value.trim(); if(!v) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©'); if(scanning){ stop(); } setEvent(v,false); });
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  });

Â  Â  function applyScanSize(){
Â  Â  Â  const wrap = document.getElementById('scanWrap'); if(!wrap) return;
Â  Â  Â  const w = document.getElementById('scanSize')?.value || '480';
Â  Â  Â  wrap.style.maxWidth = w + 'px';
Â  Â  Â  localStorage.setItem('hs:evscan:scanw', w);
Â  Â  }
Â  })();
Â  </script>
</body>
</html>
