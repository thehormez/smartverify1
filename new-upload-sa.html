<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>توليد الأكواد وربطها — Hormez</title>
  <style>
    :root{--bg:#0b1020;--ink:#e5e7eb;--muted:#9aa4b2}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .logo{width:40px;height:40px;border-radius:10px;background:#111;border:1px solid #333;display:grid;place-items:center}
    .logo span{font-weight:900;color:#ffd700}
    .input{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:var(--ink)}
    .btn{border:1px solid #334155;background:#0b1220;color:var(--ink);border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:#0d1528}
    .grid{display:grid;gap:12px}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    .qr{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .qr .box{background:#0b1220;border:1px solid #334155;border-radius:12px;padding:10px;text-align:center;color:#e5e7eb}
    .log{white-space:pre-wrap;background:#0b1220;border:1px solid #334155;border-radius:12px;padding:10px;font-size:12px;max-height:200px;overflow:auto}
    .muted{color:var(--muted)}
    .ok{color:#86efac} .err{color:#fca5a5}
  </style>
</head>
<body>
  <div class="container">
    <div class="row" style="align-items:center">
      <div class="logo"><span>HS</span></div>
      <div style="font-weight:800;margin-inline-start:10px">توليد الأكواد وربطها بالفايربيس</div>
    </div>

    <div class="grid grid-3" style="margin-top:12px">
      <div class="card">
        <div class="muted">الحدث</div>
        <input id="eventName" class="input" placeholder="زفاف سعيد" value="زفاف سعيد" />
      </div>
      <div class="card">
        <div class="muted">البادئة</div>
        <input id="prefix" class="input" placeholder="SA" value="SA" />
      </div>
      <div class="card">
        <div class="muted">من</div>
        <input id="start" class="input" type="number" value="1" />
      </div>
      <div class="card">
        <div class="muted">إلى</div>
        <input id="end" class="input" type="number" value="10" />
      </div>
      <div class="card" style="display:flex;align-items:flex-end">
        <button id="btnGenerate" class="btn" style="width:100%">توليد وحفظ & QR</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="muted">الأكواد المولدة (QR)</div>
      <div id="qrGrid" class="qr" style="margin-top:10px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="muted">السجل</div>
      <div id="log" class="log"></div>
    </div>
  </div>

  <!-- QR Code lib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    // ===== Firebase =====
    const firebaseConfig={ apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac", authDomain:"hormez-inv.firebaseapp.com", projectId:"hormez-inv" };
    if(!firebase.apps.length){firebase.initializeApp(firebaseConfig);} 
    const db=firebase.firestore();

    // ===== Helpers =====
    function pad(n,w){n=String(n);return n.length>=w?n:'0'.repeat(w-n.length)+n;}
    function makeCode(prefix,num,digits){return `${prefix}_${pad(num,digits)}`;}
    function log(msg,cls=''){const box=document.getElementById('log');const d=document.createElement('div');d.textContent=msg;if(cls)d.className=cls;box.appendChild(d);box.scrollTop=box.scrollHeight;}

    // توليد كانفس يحتوي الـ QR + التسمية أسفل نفس الصورة
    function makeLabeledCanvas(qrCanvas, label){
      const qrW = qrCanvas.width, qrH = qrCanvas.height;
      const pad = 14;  // حواف خارجية
      const gap = 8;   // فراغ بين الـ QR والنص
      const textH = 28; // ارتفاع مساحة النص
      const W = qrW + pad*2;
      const H = qrH + pad*2 + gap + textH;
      const out = document.createElement('canvas'); out.width = W; out.height = H;
      const ctx = out.getContext('2d');
      // خلفية بيضاء لكونتراست ممتاز في الطباعة
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,W,H);
      // رسم الـ QR في الوسط
      const qrX = Math.floor((W - qrW)/2), qrY = pad;
      ctx.drawImage(qrCanvas, qrX, qrY);
      // كتابة الكود أسفل الصورة
      ctx.fillStyle = '#000000';
      ctx.font = 'bold 16px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const textY = qrY + qrH + gap + Math.floor(textH/2);
      ctx.fillText(label, Math.floor(W/2), textY);
      return out;
    }

    function downloadCanvasAsPng(canvas, filename){
      const a=document.createElement('a'); a.download=filename; a.href=canvas.toDataURL('image/png'); a.click();
    }

    async function upsertCode(code,eventName){
      try{await db.collection('invites').doc(code).set({Code:code,Status:'no',EventName:eventName},{merge:true});return true;}catch(e){log('⚠️ '+e.message,'err');return false;}
    }

    async function renderQR(codes){
      const grid=document.getElementById('qrGrid');grid.innerHTML='';
      for(const code of codes){
        const box=document.createElement('div');box.className='box';
        const holder=document.createElement('div');holder.style.width='160px';holder.style.height='160px';holder.style.margin='0 auto';
        box.appendChild(holder);
        // ارسم الـ QR أولًا على كانفس داخلي
        new QRCode(holder,{text:code,width:160,height:160,correctLevel:QRCode.CorrectLevel.M});
        await new Promise(r=>setTimeout(r,25));
        const raw = holder.querySelector('canvas');
        if(raw){
          const labeled = makeLabeledCanvas(raw, code);
          holder.innerHTML='';
          holder.appendChild(labeled);
          labeled.style.cursor='pointer'; labeled.title='اضغط للتنزيل';
          labeled.addEventListener('click',()=>downloadCanvasAsPng(labeled, `${code}.png`));
        }
        grid.appendChild(box);
      }
    }

    // ===== Actions =====
    document.getElementById('btnGenerate').addEventListener('click',async()=>{
      const eventName=document.getElementById('eventName').value.trim();
      const prefix=(document.getElementById('prefix').value.trim()||'').toUpperCase();
      const start=parseInt(document.getElementById('start').value,10);
      const end=parseInt(document.getElementById('end').value,10);
      if(!eventName||!prefix||!start||!end){alert('أدخل البيانات');return;}
      if(end<start){alert('النهاية يجب أن تكون ≥ البداية');return;}
      const codes=[];for(let i=start;i<=end;i++){codes.push(makeCode(prefix,i,3));}
      for(const code of codes){const ok=await upsertCode(code,eventName);log(ok?`✅ ${code}`:`❌ ${code}`, ok?'ok':'err');}
      renderQR(codes);
    });
  </script>
</body>
</html>
