<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez — حذف أحداث متعددة من Firebase</title>
  <style>
    :root{--bg:#0b1020;--ink:#e5e7eb;--muted:#94a3b8;--line:#334155;--card:#0e172a;--ok:#22c55e;--bad:#ef4444;--warn:#f59e0b}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .topbar{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid #243047}
    .container{max-width:900px;margin:0 auto;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .btn{appearance:none;border:1px solid var(--line);background:#0b1220;color:var(--ink);border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn.primary{background:#7c2d12;border-color:#a16207} /* ذهبي داكن */
    .btn.danger{background:#7f1d1d;border-color:#dc2626}
    .btn.ghost{background:#0b1220}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn:hover{background:#0d1528}
    .input,.select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
    .muted{color:var(--muted)}
    .tag{display:inline-flex;gap:6px;align-items:center;border:1px dashed var(--line);padding:6px 10px;border-radius:999px;background:#0b1220}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .list{max-height:46vh;overflow:auto;border:1px solid rgba(255,255,255,.08);border-radius:12px}
    .item{display:flex;align-items:center;gap:10px;padding:10px;border-top:1px solid rgba(255,255,255,.06)}
    .item:first-child{border-top:none}
    .event-pill{padding:6px 10px;border-radius:999px;background:#0e172a;border:1px solid var(--line)}
    .count{font-weight:700}
    .progress{height:10px;background:#0b1220;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#f59e0b,#fde047)}
    .hint{font-size:12px;color:var(--muted)}
    @media(max-width:640px){.container{padding:10px} .btn{padding:10px}}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container row" style="justify-content:space-between">
      <div class="row"><div style="font-weight:900">HS</div><div class="muted" id="subTitle">حذف أحداث متعددة من Firebase</div></div>
      <div class="row">
        <span class="tag"><span id="langTag">AR</span></span>
        <button id="langBtn" class="btn">EN</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h2 id="hdr">🗑️ حذف أحداث متعددة</h2>
      <p class="muted" id="desc">يتم جلب أسماء الأحداث تلقائيًا من مجموعة <code class="mono">invites</code> بالحقل <code class="mono">EventName</code>.</p>

      <div class="row">
        <button id="loadBtn" class="btn primary">جلب/تحديث قائمة الأحداث</button>
        <input id="search" class="input" placeholder="بحث عن حدث…" />
      </div>

      <div class="row" style="justify-content:space-between;margin-top:6px">
        <div class="hint" id="foundLbl">—</div>
        <div class="row">
          <button id="selectAllBtn" class="btn ghost">تحديد الكل</button>
          <button id="clearSelBtn" class="btn ghost">مسح التحديد</button>
        </div>
      </div>

      <div id="list" class="list" style="margin-top:8px"></div>

      <div class="card" style="margin-top:10px">
        <div class="row" style="justify-content:space-between">
          <div>
            <button id="countBtn" class="btn">حساب العناصر المختارة</button>
            <button id="deleteBtn" class="btn danger" disabled>حذف نهائي</button>
            <button id="localBtn" class="btn" title="حذف التخزين المحلي للأحداث المختارة">مسح المحلي فقط</button>
          </div>
          <div class="hint" id="tips">⚠️ يلزم سماح القواعد بالحذف أو استخدام حساب بصلاحيات. الحذف يتم بدُفعات 500.</div>
        </div>
        <div class="row" style="align-items:center;margin-top:8px">
          <div style="flex:1">
            <div class="progress"><div id="bar" class="bar" style="width:0%"></div></div>
          </div>
          <div id="pct" class="mono" style="min-width:46px;text-align:end">0%</div>
        </div>
        <div id="log" class="muted mono" style="margin-top:8px;font-size:12px;white-space:pre-wrap;max-height:170px;overflow:auto"></div>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
  (function(){
    const $=(s,root=document)=>root.querySelector(s);
    const STR={
      ar:{
        subTitle:'حذف أحداث متعددة من Firebase',
        hdr:'🗑️ حذف أحداث متعددة',
        desc:'يتم جلب أسماء الأحداث تلقائيًا من مجموعة invites بالحقل EventName.',
        load:'جلب/تحديث قائمة الأحداث',
        searchPh:'بحث عن حدث…',
        selectAll:'تحديد الكل',
        clearSel:'مسح التحديد',
        count:'حساب العناصر المختارة',
        del:'حذف نهائي',
        local:'مسح المحلي فقط',
        tips:'⚠️ يلزم سماح القواعد بالحذف أو استخدام حساب بصلاحيات. الحذف يتم بدُفعات 500.',
        found:n=>`تم العثور على ${n} حدث(ًا).`,
        none:'لا توجد أحداث.',
        counting:'جاري العد…',
        foundItems:(ev,n)=>`[${ev}] عدد العناصر: ${n}`,
        totalItems:n=>`إجمالي العناصر: ${n}`,
        confirm1:n=>`سيتم حذف كل الدعوات لعدد (${n}) من الأحداث نهائيًا من Firebase. متابعة؟`,
        confirm2:'تأكيد أخير: هذا الإجراء لا يمكن التراجع عنه. متابعة؟',
        deleting:'جاري الحذف…',
        deletedEvent:(ev,n)=>`[${ev}] تم حذف ${n} عنصر.`,
        doneDel:n=>`تم الحذف النهائي. المجموع: ${n} عنصر.`,
        err:e=>'خطأ: '+e,
        localDone:n=>`تم مسح التخزين المحلي لعدد (${n}) حدث.`,
        btnEN:'EN', btnAR:'AR',
        loadWarn:'قد يتطلب فهرسًا للترتيب حسب EventName. إن ظهرت رسالة فهرس، أنشئ الفهرس ثم أعد المحاولة.'
      },
      en:{
        subTitle:'Delete Multiple Events from Firebase',
        hdr:'🗑️ Delete Multiple Events',
        desc:'Event names are fetched automatically from invites collection (EventName field).',
        load:'Fetch/Refresh event list',
        searchPh:'Search events…',
        selectAll:'Select all',
        clearSel:'Clear selection',
        count:'Count selected items',
        del:'Delete permanently',
        local:'Clear local only',
        tips:'⚠️ Your Firestore rules must allow deletion or use an authenticated account. Deletion runs in 500-doc batches.',
        found:n=>`${n} event(s) found.`,
        none:'No events.',
        counting:'Counting…',
        foundItems:(ev,n)=>`[${ev}] items: ${n}`,
        totalItems:n=>`Total items: ${n}`,
        confirm1:n=>`This will permanently delete invites for (${n}) events. Continue?`,
        confirm2:'Final confirmation: this cannot be undone. Proceed?',
        deleting:'Deleting…',
        deletedEvent:(ev,n)=>`[${ev}] deleted ${n}.`,
        doneDel:n=>`Done. Total deleted: ${n}`,
        err:e=>'Error: '+e,
        localDone:n=>`Cleared local storage for (${n}) event(s).`,
        btnEN:'AR', btnAR:'EN',
        loadWarn:'You may need an index to order by EventName. If prompted, create the index then retry.'
      }
    };
    let LANG=localStorage.getItem('hs:delmulti:lang')||'ar';
    function L(){return STR[LANG];}
    function applyLang(){
      document.documentElement.lang=LANG;
      document.documentElement.dir=(LANG==='ar'?'rtl':'ltr');
      $('#subTitle').textContent=L().subTitle;
      $('#hdr').textContent=L().hdr;
      $('#desc').textContent=L().desc;
      $('#loadBtn').textContent=L().load;
      $('#search').placeholder=L().searchPh;
      $('#selectAllBtn').textContent=L().selectAll;
      $('#clearSelBtn').textContent=L().clearSel;
      $('#countBtn').textContent=L().count;
      $('#deleteBtn').textContent=L().del;
      $('#localBtn').textContent=L().local;
      $('#tips').textContent=L().tips;
      $('#langBtn').textContent = (LANG==='ar' ? STR.ar.btnEN : STR.en.btnEN);
      $('#langTag').textContent = (LANG==='ar' ? 'AR' : 'EN');
    }

    // ===== Firebase init (ضع إعدادات مشروعك) =====
    const firebaseConfig = {
      apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
      authDomain:"hormez-inv.firebaseapp.com",
      projectId:"hormez-inv"
    };
    if(!firebase.apps.length){ firebase.initializeApp(firebaseConfig); }
    const db=firebase.firestore();

    // ===== State =====
    let allEvents=[];       // [{name, count: null|number, selected:false}]
    let filtered=[];

    function setProgress(p){ p=Math.max(0,Math.min(100,p||0)); $('#bar').style.width=p+'%'; $('#pct').textContent=Math.round(p)+'%'; }
    function logLine(t){ const el=$('#log'); el.textContent += (t+'\n'); el.scrollTop = el.scrollHeight; }
    function render(){
      const q = ($('#search').value||'').toLowerCase();
      filtered = allEvents.filter(e=> e.name.toLowerCase().includes(q));
      $('#foundLbl').textContent = filtered.length ? L().found(filtered.length) : L().none;
      const box=$('#list'); box.innerHTML='';
      filtered.forEach((ev,i)=>{
        const row=document.createElement('div'); row.className='item';
        row.innerHTML = `
          <input type="checkbox" ${ev.selected?'checked':''} data-ev="${ev.name}">
          <span class="event-pill mono">${ev.name}</span>
          <span class="muted">${ev.count==null?'—':(LANG==='ar'?'عدد العناصر: ':'items: ')}<b class="count">${ev.count==null?'?':ev.count}</b></span>
        `;
        box.appendChild(row);
      });
      // bind checkboxes
      box.querySelectorAll('input[type="checkbox"]').forEach(ch=>{
        ch.addEventListener('change', e=>{
          const name=e.target.getAttribute('data-ev');
          const obj=allEvents.find(x=>x.name===name);
          if(obj){ obj.selected = e.target.checked; }
        });
      });
    }

    // جلب كل الأسماء الفريدة عبر paginate
    async function fetchDistinctEvents(){
      allEvents=[]; render(); setProgress(0); $('#log').textContent='';
      logLine(L().load+' …'); logLine(L().loadWarn);
      const seen=new Set();
      let last=null; const PAGE=800; let totalFetched=0; // اضبط الحجم حسب حجم البيانات/الميزانية
      while(true){
        let q = db.collection('invites').orderBy('EventName').limit(PAGE);
        if(last) q = q.startAfter(last);
        const snap = await q.get();
        if(snap.empty) break;
        snap.docs.forEach(d=>{
          totalFetched++;
          const ev = d.get('EventName')||'';
          if(ev && !seen.has(ev)){
            seen.add(ev);
            allEvents.push({name:ev, count:null, selected:false});
          }
        });
        last = snap.docs[snap.docs.length-1];
        if(snap.size < PAGE) break;
        // تقدم تقريبي
        setProgress( Math.min(90, setProgress.value||0 + 5) );
      }
      setProgress(100);
      render();
      logLine((LANG==='ar'?'تم جمع أحداث فريدة: ':'Unique events collected: ')+allEvents.length);
    }

    async function countForEvent(ev){
      const qs = await db.collection('invites').where('EventName','==',ev).get();
      return qs.size;
    }

    async function countSelected(){
      $('#log').textContent=''; setProgress(0); logLine(L().counting);
      const targets = allEvents.filter(e=>e.selected);
      if(!targets.length){ logLine(L().none); setProgress(100); return {total:0}; }
      let total=0, done=0;
      for(const t of targets){
        const n = await countForEvent(t.name);
        t.count = n; total += n; done++;
        logLine(L().foundItems(t.name, n));
        setProgress( (done/targets.length) * 100 );
        render();
      }
      logLine('—'); logLine(L().totalItems(total));
      return {total, targets};
    }

    function clearLocalForEvent(ev){
      try{
        const keyEvent='hs:evscan:event';
        const saved=localStorage.getItem(keyEvent);
        if(saved && saved===ev){ localStorage.removeItem(keyEvent); }
        localStorage.removeItem(`hs:evscan:hist:${ev}`);
      }catch{}
    }

    async function deleteBatchesForEvent(ev){
      let deleted=0;
      const LIMIT=500;
      while(true){
        const snap = await db.collection('invites').where('EventName','==',ev).limit(LIMIT).get();
        if(snap.empty) break;
        const batch = db.batch();
        snap.forEach(doc=> batch.delete(doc.ref));
        await batch.commit();
        deleted += snap.size;
        logLine(`   - ${snap.size} …`);
      }
      return deleted;
    }

    async function deleteSelected(){
      $('#deleteBtn').disabled=true; $('#countBtn').disabled=true;
      $('#log').textContent=''; setProgress(0); logLine(L().deleting);
      // تأكد من الحساب أولًا
      const {total, targets} = await countSelected();
      if(!targets || !targets.length){ $('#deleteBtn').disabled=false; $('#countBtn').disabled=false; return; }
      if(total===0){ $('#deleteBtn').disabled=false; $('#countBtn').disabled=false; return; }

      if(!confirm(L().confirm1(targets.length))) { $('#deleteBtn').disabled=false; $('#countBtn').disabled=false; return; }
      if(!confirm(L().confirm2)) { $('#deleteBtn').disabled=false; $('#countBtn').disabled=false; return; }

      let deletedAll=0, step=0;
      for(const t of targets){
        const del = await deleteBatchesForEvent(t.name);
        deletedAll += del; step++;
        clearLocalForEvent(t.name);
        logLine(L().deletedEvent(t.name, del));
        setProgress( (step/targets.length)*100 );
      }
      logLine('—'); logLine(L().doneDel(deletedAll));
      // حددها كغير محددة واحذفها من القائمة (اختياري) أو أعد التحميل
      allEvents = allEvents.filter(e=> !targets.find(t=>t.name===e.name));
      render();
      $('#deleteBtn').disabled=false; $('#countBtn').disabled=false;
    }

    function clearLocalSelected(){
      const targets = allEvents.filter(e=>e.selected);
      targets.forEach(t=> clearLocalForEvent(t.name));
      alert(L().localDone(targets.length));
    }

    // ===== Wire UI =====
    document.addEventListener('DOMContentLoaded', ()=>{
      applyLang();
      $('#langBtn').addEventListener('click', ()=>{ LANG=(LANG==='ar'?'en':'ar'); localStorage.setItem('hs:delmulti:lang',LANG); applyLang(); render(); });

      $('#loadBtn').addEventListener('click', fetchDistinctEvents);
      $('#search').addEventListener('input', render);
      $('#selectAllBtn').addEventListener('click', ()=>{ filtered.forEach(ev=>{ ev.selected=true; }); render(); });
      $('#clearSelBtn').addEventListener('click', ()=>{ filtered.forEach(ev=>{ ev.selected=false; }); render(); });
      $('#countBtn').addEventListener('click', countSelected);
      $('#deleteBtn').addEventListener('click', deleteSelected);
      $('#localBtn').addEventListener('click', clearLocalSelected);

      // تحميل تلقائي عند الفتح
      fetchDistinctEvents().catch(e=>{ logLine(STR[LANG].err(e.message||e)); });
    });
  })();
  </script>
</body>
</html>
