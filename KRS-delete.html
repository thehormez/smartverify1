<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez â€” Ø­Ø°Ù Ø£Ø­Ø¯Ø§Ø« Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ù† Firebase</title>
  <style>
    :root{--bg:#0b1020;--ink:#e5e7eb;--muted:#94a3b8;--line:#334155;--card:#0e172a;--ok:#22c55e;--bad:#ef4444;--warn:#f59e0b}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .topbar{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid #243047}
    .container{max-width:900px;margin:0 auto;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .btn{appearance:none;border:1px solid var(--line);background:#0b1220;color:var(--ink);border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn.primary{background:#7c2d12;border-color:#a16207} /* Ø°Ù‡Ø¨ÙŠ Ø¯Ø§ÙƒÙ† */
    .btn.danger{background:#7f1d1d;border-color:#dc2626}
    .btn.ghost{background:#0b1220}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn:hover{background:#0d1528}
    .input,.select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
    .muted{color:var(--muted)}
    .tag{display:inline-flex;gap:6px;align-items:center;border:1px dashed var(--line);padding:6px 10px;border-radius:999px;background:#0b1220}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .list{max-height:46vh;overflow:auto;border:1px solid rgba(255,255,255,.08);border-radius:12px}
    .item{display:flex;align-items:center;gap:10px;padding:10px;border-top:1px solid rgba(255,255,255,.06)}
    .item:first-child{border-top:none}
    .event-pill{padding:6px 10px;border-radius:999px;background:#0e172a;border:1px solid var(--line)}
    .count{font-weight:700}
    .progress{height:10px;background:#0b1220;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#f59e0b,#fde047)}
    .hint{font-size:12px;color:var(--muted)}
    @media(max-width:640px){.container{padding:10px} .btn{padding:10px}}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container row" style="justify-content:space-between">
      <div class="row"><div style="font-weight:900">HS</div><div class="muted" id="subTitle">Ø­Ø°Ù Ø£Ø­Ø¯Ø§Ø« Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ù† Firebase</div></div>
      <div class="row">
        <span class="tag"><span id="langTag">AR</span></span>
        <button id="langBtn" class="btn">EN</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h2 id="hdr">ğŸ—‘ï¸ Ø­Ø°Ù Ø£Ø­Ø¯Ø§Ø« Ù…ØªØ¹Ø¯Ø¯Ø©</h2>
      <p class="muted" id="desc">ÙŠØªÙ… Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© <code class="mono">invites</code> Ø¨Ø§Ù„Ø­Ù‚Ù„ <code class="mono">EventName</code>.</p>

      <div class="row">
        <button id="loadBtn" class="btn primary">Ø¬Ù„Ø¨/ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</button>
        <input id="search" class="input" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø­Ø¯Ø«â€¦" />
      </div>

      <div class="row" style="justify-content:space-between;margin-top:6px">
        <div class="hint" id="foundLbl">â€”</div>
        <div class="row">
          <button id="selectAllBtn" class="btn ghost">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
          <button id="clearSelBtn" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
        </div>
      </div>

      <div id="list" class="list" style="margin-top:8px"></div>

      <div class="card" style="margin-top:10px">
        <div class="row" style="justify-content:space-between">
          <div>
            <button id="countBtn" class="btn">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</button>
            <button id="deleteBtn" class="btn danger" disabled>Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
            <button id="localBtn" class="btn" title="Ø­Ø°Ù Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©">Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·</button>
          </div>
          <div class="hint" id="tips">âš ï¸ ÙŠÙ„Ø²Ù… Ø³Ù…Ø§Ø­ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø¨Ø§Ù„Ø­Ø°Ù Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨ Ø¨ØµÙ„Ø§Ø­ÙŠØ§Øª. Ø§Ù„Ø­Ø°Ù ÙŠØªÙ… Ø¨Ø¯ÙÙØ¹Ø§Øª 500.</div>
        </div>
        <div class="row" style="align-items:center;margin-top:8px">
          <div style="flex:1">
            <div class="progress"><div id="bar" class="bar" style="width:0%"></div></div>
          </div>
          <div id="pct" class="mono" style="min-width:46px;text-align:end">0%</div>
        </div>
        <div id="log" class="muted mono" style="margin-top:8px;font-size:12px;white-space:pre-wrap;max-height:170px;overflow:auto"></div>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
  (function(){
    const $=(s,root=document)=>root.querySelector(s);
    const STR={
      ar:{
        subTitle:'Ø­Ø°Ù Ø£Ø­Ø¯Ø§Ø« Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ù† Firebase',
        hdr:'ğŸ—‘ï¸ Ø­Ø°Ù Ø£Ø­Ø¯Ø§Ø« Ù…ØªØ¹Ø¯Ø¯Ø©',
        desc:'ÙŠØªÙ… Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© invites Ø¨Ø§Ù„Ø­Ù‚Ù„ EventName.',
        load:'Ø¬Ù„Ø¨/ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«',
        searchPh:'Ø¨Ø­Ø« Ø¹Ù† Ø­Ø¯Ø«â€¦',
        selectAll:'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„',
        clearSel:'Ù…Ø³Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ¯',
        count:'Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©',
        del:'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ',
        local:'Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·',
        tips:'âš ï¸ ÙŠÙ„Ø²Ù… Ø³Ù…Ø§Ø­ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø¨Ø§Ù„Ø­Ø°Ù Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨ Ø¨ØµÙ„Ø§Ø­ÙŠØ§Øª. Ø§Ù„Ø­Ø°Ù ÙŠØªÙ… Ø¨Ø¯ÙÙØ¹Ø§Øª 500.',
        found:n=>`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${n} Ø­Ø¯Ø«(Ù‹Ø§).`,
        none:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø«.',
        counting:'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ø¯â€¦',
        foundItems:(ev,n)=>`[${ev}] Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±: ${n}`,
        totalItems:n=>`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±: ${n}`,
        confirm1:n=>`Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ù„Ø¹Ø¯Ø¯ (${n}) Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Firebase. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`,
        confirm2:'ØªØ£ÙƒÙŠØ¯ Ø£Ø®ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ',
        deleting:'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ùâ€¦',
        deletedEvent:(ev,n)=>`[${ev}] ØªÙ… Ø­Ø°Ù ${n} Ø¹Ù†ØµØ±.`,
        doneDel:n=>`ØªÙ… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ. Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${n} Ø¹Ù†ØµØ±.`,
        err:e=>'Ø®Ø·Ø£: '+e,
        localDone:n=>`ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ø¹Ø¯Ø¯ (${n}) Ø­Ø¯Ø«.`,
        btnEN:'EN', btnAR:'AR',
        loadWarn:'Ù‚Ø¯ ÙŠØªØ·Ù„Ø¨ ÙÙ‡Ø±Ø³Ù‹Ø§ Ù„Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ EventName. Ø¥Ù† Ø¸Ù‡Ø±Øª Ø±Ø³Ø§Ù„Ø© ÙÙ‡Ø±Ø³ØŒ Ø£Ù†Ø´Ø¦ Ø§Ù„ÙÙ‡Ø±Ø³ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.'
      },
      en:{
        subTitle:'Delete Multiple Events from Firebase',
        hdr:'ğŸ—‘ï¸ Delete Multiple Events',
        desc:'Event names are fetched automatically from invites collection (EventName field).',
        load:'Fetch/Refresh event list',
        searchPh:'Search eventsâ€¦',
        selectAll:'Select all',
        clearSel:'Clear selection',
        count:'Count selected items',
        del:'Delete permanently',
        local:'Clear local only',
        tips:'âš ï¸ Your Firestore rules must allow deletion or use an authenticated account. Deletion runs in 500-doc batches.',
        found:n=>`${n} event(s) found.`,
        none:'No events.',
        counting:'Countingâ€¦',
        foundItems:(ev,n)=>`[${ev}] items: ${n}`,
        totalItems:n=>`Total items: ${n}`,
        confirm1:n=>`This will permanently delete invites for (${n}) events. Continue?`,
        confirm2:'Final confirmation: this cannot be undone. Proceed?',
        deleting:'Deletingâ€¦',
        deletedEvent:(ev,n)=>`[${ev}] deleted ${n}.`,
        doneDel:n=>`Done. Total deleted: ${n}`,
        err:e=>'Error: '+e,
        localDone:n=>`Cleared local storage for (${n}) event(s).`,
        btnEN:'AR', btnAR:'EN',
        loadWarn:'You may need an index to order by EventName. If prompted, create the index then retry.'
      }
    };
    let LANG=localStorage.getItem('hs:delmulti:lang')||'ar';
    function L(){return STR[LANG];}
    function applyLang(){
      document.documentElement.lang=LANG;
      document.documentElement.dir=(LANG==='ar'?'rtl':'ltr');
      $('#subTitle').textContent=L().subTitle;
      $('#hdr').textContent=L().hdr;
      $('#desc').textContent=L().desc;
      $('#loadBtn').textContent=L().load;
      $('#search').placeholder=L().searchPh;
      $('#selectAllBtn').textContent=L().selectAll;
      $('#clearSelBtn').textContent=L().clearSel;
      $('#countBtn').textContent=L().count;
      $('#deleteBtn').textContent=L().del;
      $('#localBtn').textContent=L().local;
      $('#tips').textContent=L().tips;
      $('#langBtn').textContent = (LANG==='ar' ? STR.ar.btnEN : STR.en.btnEN);
      $('#langTag').textContent = (LANG==='ar' ? 'AR' : 'EN');
    }

    // ===== Firebase init (Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ) =====
    const firebaseConfig = {
      apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
      authDomain:"hormez-inv.firebaseapp.com",
      projectId:"hormez-inv"
    };
    if(!firebase.apps.length){ firebase.initializeApp(firebaseConfig); }
    const db=firebase.firestore();

    // ===== State =====
    let allEvents=[];       // [{name, count: null|number, selected:false}]
    let filtered=[];

    function setProgress(p){ p=Math.max(0,Math.min(100,p||0)); $('#bar').style.width=p+'%'; $('#pct').textContent=Math.round(p)+'%'; }
    function logLine(t){ const el=$('#log'); el.textContent += (t+'\n'); el.scrollTop = el.scrollHeight; }
    function render(){
      const q = ($('#search').value||'').toLowerCase();
      filtered = allEvents.filter(e=> e.name.toLowerCase().includes(q));
      $('#foundLbl').textContent = filtered.length ? L().found(filtered.length) : L().none;
      const box=$('#list'); box.innerHTML='';
      filtered.forEach((ev,i)=>{
        const row=document.createElement('div'); row.className='item';
        row.innerHTML = `
          <input type="checkbox" ${ev.selected?'checked':''} data-ev="${ev.name}">
          <span class="event-pill mono">${ev.name}</span>
          <span class="muted">${ev.count==null?'â€”':(LANG==='ar'?'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±: ':'items: ')}<b class="count">${ev.count==null?'?':ev.count}</b></span>
        `;
        box.appendChild(row);
      });
      // bind checkboxes
      box.querySelectorAll('input[type="checkbox"]').forEach(ch=>{
        ch.addEventListener('change', e=>{
          const name=e.target.getAttribute('data-ev');
          const obj=allEvents.find(x=>x.name===name);
          if(obj){ obj.selected = e.target.checked; }
        });
      });
    }

    // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØ±ÙŠØ¯Ø© Ø¹Ø¨Ø± paginate
    async function fetchDistinctEvents(){
      allEvents=[]; render(); setProgress(0); $('#log').textContent='';
      logLine(L().load+' â€¦'); logLine(L().loadWarn);
      const seen=new Set();
      let last=null; const PAGE=800; let totalFetched=0; // Ø§Ø¶Ø¨Ø· Ø§Ù„Ø­Ø¬Ù… Ø­Ø³Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª/Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©
      while(true){
        let q = db.collection('invites').orderBy('EventName').limit(PAGE);
        if(last) q = q.startAfter(last);
        const snap = await q.get();
        if(snap.empty) break;
        snap.docs.forEach(d=>{
          totalFetched++;
          const ev = d.get('EventName')||'';
          if(ev && !seen.has(ev)){
            seen.add(ev);
            allEvents.push({name:ev, count:null, selected:false});
          }
        });
        last = snap.docs[snap.docs.length-1];
        if(snap.size < PAGE) break;
        // ØªÙ‚Ø¯Ù… ØªÙ‚Ø±ÙŠØ¨ÙŠ
        setProgress( Math.min(90, setProgress.value||0 + 5) );
      }
      setProgress(100);
      render();
      logLine((LANG==='ar'?'ØªÙ… Ø¬Ù…Ø¹ Ø£Ø­Ø¯Ø§Ø« ÙØ±ÙŠØ¯Ø©: ':'Unique events collected: ')+allEvents.length);
    }

    async function countForEvent(ev){
      const qs = await db.collection('invites').where('EventName','==',ev).get();
      return qs.size;
    }

    async function countSelected(){
      $('#log').textContent=''; setProgress(0); logLine(L().counting);
      const targets = allEvents.filter(e=>e.selected);
      if(!targets.length){ logLine(L().none); setProgress(100); return {total:0}; }
      let total=0, done=0;
      for(const t of targets){
        const n = await countForEvent(t.name);
        t.count = n; total += n; done++;
        logLine(L().foundItems(t.name, n));
        setProgress( (done/targets.length) * 100 );
        render();
      }
      logLine('â€”'); logLine(L().totalItems(total));
      return {total, targets};
    }

    function clearLocalForEvent(ev){
      try{
        const keyEvent='hs:evscan:event';
        const saved=localStorage.getItem(keyEvent);
        if(saved && saved===ev){ localStorage.removeItem(keyEvent); }
        localStorage.removeItem(`hs:evscan:hist:${ev}`);
      }catch{}
    }

    async function deleteBatchesForEvent(ev){
      let deleted=0;
      const LIMIT=500;
      while(true){
        const snap = await db.collection('invites').where('EventName','==',ev).limit(LIMIT).get();
        if(snap.empty) break;
        const batch = db.batch();
        snap.forEach(doc=> batch.delete(doc.ref));
        await batch.commit();
        deleted += snap.size;
        logLine(`   - ${snap.size} â€¦`);
      }
      return deleted;
    }

    async function deleteSelected(){
      $('#deleteBtn').disabled=true; $('#countBtn').disabled=true;
      $('#log').textContent=''; setProgress(0); logLine(L().deleting);
      // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£ÙˆÙ„Ù‹Ø§
      const {total, targets} = await countSelected();
      if(!targets || !targets.length){ $('#deleteBtn').disabled=false; $('#countBtn').disabled=false; return; }
      if(total===0){ $('#deleteBtn').disabled=false; $('#countBtn').disabled=false; return; }

      if(!confirm(L().confirm1(targets.length))) { $('#deleteBtn').disabled=false; $('#countBtn').disabled=false; return; }
      if(!confirm(L().confirm2)) { $('#deleteBtn').disabled=false; $('#countBtn').disabled=false; return; }

      let deletedAll=0, step=0;
      for(const t of targets){
        const del = await deleteBatchesForEvent(t.name);
        deletedAll += del; step++;
        clearLocalForEvent(t.name);
        logLine(L().deletedEvent(t.name, del));
        setProgress( (step/targets.length)*100 );
      }
      logLine('â€”'); logLine(L().doneDel(deletedAll));
      // Ø­Ø¯Ø¯Ù‡Ø§ ÙƒØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø© ÙˆØ§Ø­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø£Ùˆ Ø£Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
      allEvents = allEvents.filter(e=> !targets.find(t=>t.name===e.name));
      render();
      $('#deleteBtn').disabled=false; $('#countBtn').disabled=false;
    }

    function clearLocalSelected(){
      const targets = allEvents.filter(e=>e.selected);
      targets.forEach(t=> clearLocalForEvent(t.name));
      alert(L().localDone(targets.length));
    }

    // ===== Wire UI =====
    document.addEventListener('DOMContentLoaded', ()=>{
      applyLang();
      $('#langBtn').addEventListener('click', ()=>{ LANG=(LANG==='ar'?'en':'ar'); localStorage.setItem('hs:delmulti:lang',LANG); applyLang(); render(); });

      $('#loadBtn').addEventListener('click', fetchDistinctEvents);
      $('#search').addEventListener('input', render);
      $('#selectAllBtn').addEventListener('click', ()=>{ filtered.forEach(ev=>{ ev.selected=true; }); render(); });
      $('#clearSelBtn').addEventListener('click', ()=>{ filtered.forEach(ev=>{ ev.selected=false; }); render(); });
      $('#countBtn').addEventListener('click', countSelected);
      $('#deleteBtn').addEventListener('click', deleteSelected);
      $('#localBtn').addEventListener('click', clearLocalSelected);

      // ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
      fetchDistinctEvents().catch(e=>{ logLine(STR[LANG].err(e.message||e)); });
    });
  })();
  </script>
</body>
</html>
