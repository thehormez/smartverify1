<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez â€” Ø­Ø°Ù Ø­Ø¯Ø« Ù…Ù† Firebase</title>
  <style>
    :root{--bg:#0b1020;--ink:#e5e7eb;--muted:#94a3b8;--line:#334155;--card:#0e172a;--ok:#22c55e;--bad:#ef4444;--warn:#f59e0b}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .topbar{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid #243047}
    .container{max-width:720px;margin:0 auto;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .btn{appearance:none;border:1px solid var(--line);background:#0b1220;color:var(--ink);border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn.primary{background:#7c2d12;border-color:#a16207} /* Ø°Ù‡Ø¨ÙŠ Ø¯Ø§ÙƒÙ† */
    .btn.danger{background:#7f1d1d;border-color:#dc2626}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn:hover{background:#0d1528}
    .input,.select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
    .muted{color:var(--muted)}
    .tag{display:inline-flex;gap:6px;align-items:center;border:1px dashed var(--line);padding:6px 10px;border-radius:999px;background:#0b1220}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .stat{display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid rgba(255,255,255,.08);border-radius:10px}
    .ok{color:#86efac}.bad{color:#fca5a5}.warn{color:#fde68a}
    .progress{height:10px;background:#0b1220;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#f59e0b,#fde047)}
    @media(max-width:640px){.container{padding:10px} .btn{padding:10px}}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container row" style="justify-content:space-between">
      <div class="row"><div style="font-weight:900">HS</div><div class="muted" id="subTitle">Ø­Ø°Ù Ø­Ø¯Ø« Ù…Ù† Firebase</div></div>
      <div class="row">
        <span class="tag"><span id="langTag">AR</span></span>
        <button id="langBtn" class="btn">EN</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h2 id="hdr">ğŸ—‘ï¸ Ø­Ø°Ù Ø­Ø¯Ø«</h2>
      <p class="muted" id="desc">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ØªÙ…Ø§Ù…Ù‹Ø§ ÙƒÙ…Ø§ ÙŠÙØ®Ø²Ù‘Ù† ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ <code class="mono">EventName</code> Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù…ÙˆØ¹Ø© <code class="mono">invites</code>.</p>

      <div class="row">
        <input id="eventInput" class="input" placeholder="Ù…Ø«Ø§Ù„: Wedding2025" />
      </div>

      <div class="row">
        <button id="countBtn" class="btn">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ±</button>
        <button id="deleteBtn" class="btn danger" disabled>Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
        <button id="localBtn" class="btn" title="Ø­Ø°Ù Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·">Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·</button>
      </div>

      <div id="statBox" class="card" style="margin-top:10px;display:none">
        <div class="stat">
          <div id="countLabel">Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</div>
          <div id="countValue" class="mono">â€”</div>
        </div>
        <div class="stat" style="margin-top:8px">
          <div id="progressLabel">Ø§Ù„ØªÙ‚Ø¯Ù…</div>
          <div style="flex:1;margin-inline-start:10px">
            <div class="progress"><div id="bar" class="bar" style="width:0%"></div></div>
          </div>
          <div id="pct" class="mono" style="min-width:46px;text-align:end">0%</div>
        </div>
        <div id="log" class="muted mono" style="margin-top:8px;font-size:12px;white-space:pre-wrap;max-height:160px;overflow:auto"></div>
      </div>

      <div class="card" style="margin-top:10px">
        <div id="tips" class="muted" style="font-size:13px">
          âš ï¸ Ø³ØªØ­ØªØ§Ø¬ Ø£Ù† ØªØ³Ù…Ø­ Ù‚ÙˆØ§Ø¹Ø¯ Firestore Ø¨Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ø£Ùˆ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø³Ø¬Ù‘Ù„Ø§Ù‹ Ø¨Ø­Ø³Ø§Ø¨ Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ§Øª. ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ø¹Ù„Ù‰ Ø¯ÙØ¹Ø§Øª 500 Ø¹Ù†ØµØ± ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©.
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
  (function(){
    const $ = (s,root=document)=>root.querySelector(s);
    const STR = {
      ar: {
        subTitle:'Ø­Ø°Ù Ø­Ø¯Ø« Ù…Ù† Firebase',
        hdr:'ğŸ—‘ï¸ Ø­Ø°Ù Ø­Ø¯Ø«',
        desc:'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ØªÙ…Ø§Ù…Ù‹Ø§ ÙƒÙ…Ø§ ÙŠÙØ®Ø²Ù‘Ù† ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ EventName Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù…ÙˆØ¹Ø© invites.',
        placeholder:'Ù…Ø«Ø§Ù„: Wedding2025',
        count:'Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ±',
        del:'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ',
        local:'Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·',
        target:'Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©',
        prog:'Ø§Ù„ØªÙ‚Ø¯Ù…',
        tips:'âš ï¸ Ø³ØªØ­ØªØ§Ø¬ Ø£Ù† ØªØ³Ù…Ø­ Ù‚ÙˆØ§Ø¹Ø¯ Firestore Ø¨Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ø£Ùˆ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø³Ø¬Ù‘Ù„Ø§Ù‹ Ø¨Ø­Ø³Ø§Ø¨ Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ§Øª. ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ø¹Ù„Ù‰ Ø¯ÙØ¹Ø§Øª 500 Ø¹Ù†ØµØ± ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©.',
        needEvent:'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹.',
        counting:'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ø¯â€¦',
        found:n=>`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${n} Ø¹Ù†ØµØ±.`,
        none:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯Ø«.',
        confirm1:e=>`Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ù„Ù„Ø­Ø¯Ø« "${e}" Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Firebase. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`,
        confirm2:'ØªØ£ÙƒÙŠØ¯ Ø£Ø®ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡. Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø°ÙØŸ',
        deleting:'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ùâ€¦',
        doneDel:n=>`ØªÙ… Ø­Ø°Ù ${n} Ø¹Ù†ØµØ±.`,
        err:e=>'Ø®Ø·Ø£: '+e,
        localDone:e=>`ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ø­Ø¯Ø« "${e}".`,
        btnEN:'EN', btnAR:'AR'
      },
      en: {
        subTitle:'Delete Event from Firebase',
        hdr:'ğŸ—‘ï¸ Delete Event',
        desc:'Enter the exact event name as stored in EventName field inside invites collection.',
        placeholder:'e.g., Wedding2025',
        count:'Count items',
        del:'Delete permanently',
        local:'Clear local only',
        target:'Target items',
        prog:'Progress',
        tips:'âš ï¸ Your Firestore rules must allow deletion from client or use an authenticated account. Deletion runs in 500-doc batches.',
        needEvent:'Please enter an event name first.',
        counting:'Countingâ€¦',
        found:n=>`${n} item(s) found.`,
        none:'No items for this event.',
        confirm1:e=>`This will permanently delete all invites for "${e}" from Firebase. Continue?`,
        confirm2:'Final confirmation: this cannot be undone. Proceed?',
        deleting:'Deletingâ€¦',
        doneDel:n=>`Deleted ${n} item(s).`,
        err:e=>'Error: '+e,
        localDone:e=>`Local data cleared for "${e}".`,
        btnEN:'AR', btnAR:'EN'
      }
    };
    let LANG = localStorage.getItem('hs:del:lang') || 'ar';
    function L(){ return STR[LANG]; }
    function applyLang(){
      document.documentElement.lang = LANG;
      document.documentElement.dir  = (LANG==='ar'?'rtl':'ltr');
      $('#subTitle').textContent = L().subTitle;
      $('#hdr').textContent      = L().hdr;
      $('#desc').textContent     = L().desc;
      $('#eventInput').placeholder = L().placeholder;
      $('#countBtn').textContent = L().count;
      $('#deleteBtn').textContent= L().del;
      $('#localBtn').textContent = L().local;
      $('#countLabel').textContent = L().target;
      $('#progressLabel').textContent = L().prog;
      $('#tips').textContent = L().tips;
      $('#langBtn').textContent = (LANG==='ar' ? STR.ar.btnEN : STR.en.btnEN);
      $('#langTag').textContent = (LANG==='ar' ? 'AR' : 'EN');
    }

    // ===== Firebase init (Ù†ÙØ³ Ù…Ø´Ø±ÙˆØ¹Ùƒ) =====
    const firebaseConfig = {
      apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
      authDomain:"hormez-inv.firebaseapp.com",
      projectId:"hormez-inv"
    };
    if(!firebase.apps.length){ firebase.initializeApp(firebaseConfig); }
    const db = firebase.firestore();

    // ===== Helpers =====
    const BATCH_LIMIT = 500;
    function showStatBox(show=true){ $('#statBox').style.display = show?'block':'none'; }
    function setProgress(p){ p=Math.max(0,Math.min(100,p||0)); $('#bar').style.width = p+'%'; $('#pct').textContent = Math.round(p)+'%'; }
    function logLine(t){ const el=$('#log'); el.textContent += (t+'\n'); el.scrollTop = el.scrollHeight; }

    async function countDocsForEvent(eventName){
      const ref = db.collection('invites');
      const q = await ref.where('EventName','==', eventName).get();
      return q.size; // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ ÙŠØ¬Ù„Ø¨ Ø§Ù„ØµÙØ­Ø© ÙƒØ§Ù…Ù„Ø©Ø› Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©. Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø¶Ø®Ù…Ø© Ø§Ø³ØªØ®Ø¯Ù… paginate.
    }

    async function deleteInBatches(eventName){
      // Ø­Ø°Ù Ø¹Ù„Ù‰ Ø¯ÙØ¹Ø§Øª 500
      let totalDeleted = 0;
      let lastDel = 0;
      while(true){
        const snap = await db.collection('invites')
          .where('EventName','==', eventName)
          .limit(BATCH_LIMIT)
          .get();

        if(snap.empty) break;

        const batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();

        lastDel = snap.size;
        totalDeleted += lastDel;
        logLine(`${lastDel} deletedâ€¦`);
        // ØªÙ‚Ø¯ÙŠØ± Ø§Ù„ØªÙ‚Ø¯Ù…: Ø³Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¯ÙØ¹Ø© Ø¥Ù† Ø´Ø¦Øª
      }
      return totalDeleted;
    }

    function clearLocal(eventName){
      try {
        const keyEvent = 'hs:evscan:event';
        const saved = localStorage.getItem(keyEvent);
        if(saved && saved === eventName){ localStorage.removeItem(keyEvent); }
        localStorage.removeItem(`hs:evscan:hist:${eventName}`);
        // Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ§Ù‹:
        // for(let i=localStorage.length-1;i>=0;i--){ const k=localStorage.key(i); if(k && k.startsWith('hs:evscan:hist:')) localStorage.removeItem(k); }
      }catch{}
    }

    // ===== Wire UI =====
    document.addEventListener('DOMContentLoaded', ()=>{
      applyLang();

      $('#langBtn').addEventListener('click', ()=>{
        LANG = (LANG==='ar') ? 'en' : 'ar';
        localStorage.setItem('hs:del:lang', LANG);
        applyLang();
      });

      $('#countBtn').addEventListener('click', async ()=>{
        const ev = ($('#eventInput').value||'').trim();
        if(!ev){ alert(L().needEvent); return; }
        showStatBox(true); setProgress(0); $('#log').textContent=''; $('#countValue').textContent='â€¦';
        $('#deleteBtn').disabled = true;
        try{
          logLine(L().counting);
          const n = await countDocsForEvent(ev);
          $('#countValue').textContent = n;
          if(n>0){
            logLine(L().found(n));
            $('#deleteBtn').disabled = false;
          }else{
            logLine(L().none);
            setProgress(100);
          }
        }catch(e){
          logLine(L().err(e.message||e));
        }
      });

      $('#deleteBtn').addEventListener('click', async ()=>{
        const ev = ($('#eventInput').value||'').trim();
        if(!ev){ alert(L().needEvent); return; }

        if(!confirm(L().confirm1(ev))) return;
        if(!confirm(L().confirm2)) return;

        $('#deleteBtn').disabled = true;
        $('#countBtn').disabled = true;
        setProgress(0); $('#log').textContent=''; showStatBox(true); logLine(L().deleting);

        try{
          // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø£ÙˆÙ„Ù‹Ø§ Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„ØªÙ‚Ø¯Ù…
          let total = await countDocsForEvent(ev);
          if(total===0){ logLine(L().none); setProgress(100); $('#deleteBtn').disabled=false; $('#countBtn').disabled=false; return; }

          let deleted = 0;
          while(true){
            const snap = await db.collection('invites').where('EventName','==', ev).limit(BATCH_LIMIT).get();
            if(snap.empty) break;
            const batch = db.batch();
            snap.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            deleted += snap.size;
            setProgress((deleted/total)*100);
            logLine(`${snap.size} deleted ( ${deleted} / ${total} )`);
          }

          clearLocal(ev);
          logLine(L().doneDel(deleted));
          setProgress(100);
          $('#deleteBtn').disabled=false;
          $('#countBtn').disabled=false;
          alert(L().doneDel(deleted));
        }catch(e){
          logLine(L().err(e.message||e));
          $('#deleteBtn').disabled=false;
          $('#countBtn').disabled=false;
        }
      });

      $('#localBtn').addEventListener('click', ()=>{
        const ev = ($('#eventInput').value||'').trim();
        if(!ev){ alert(L().needEvent); return; }
        clearLocal(ev);
        alert(L().localDone(ev));
      });
    });
  })();
  </script>
</body>
</html>
