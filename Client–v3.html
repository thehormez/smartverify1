<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مركز الإرسال الفخم — أسود/ذهبي</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700;900&display=swap" rel="stylesheet" />

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    :root{
      --bg:#0b0b0c;          /* خلفية أسود عميق */
      --bg-soft:#121214;     /* طبقة أغمق للكروت */
      --panel:#16171b;       /* بطاقات */
      --stroke:#27282f;      /* حدود ناعمة */
      --gold:#d4af37;        /* ذهبي ملكي */
      --gold-2:#b8952f;      /* ذهبي داكن للهوفر */
      --txt:#e7e7e7;         /* نص فاتح */
      --muted:#a7a7a7;       /* نص ثانوي */
      --danger:#ef4444;      /* أحمر تحذير */
      --whatsapp:#25d366;    /* واتساب */
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; font-family:'Noto Sans Arabic', system-ui, -apple-system, Segoe UI, Arial;
      background: radial-gradient(1200px 600px at 80% -10%, rgba(212,175,55,.08), transparent 50%), var(--bg);
      color:var(--txt);
    }

    /* شريط علوي أنيق */
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(140%) blur(6px);
      background:linear-gradient(180deg, rgba(12,12,14,0.85), rgba(12,12,14,0.65));
      border-bottom:1px solid var(--stroke);
    }
    .container{ max-width:1280px; margin:0 auto; padding:16px }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px }
    .brand-dot{ width:12px; height:12px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #ffe8a3, var(--gold)); box-shadow:0 0 0 2px rgba(212,175,55,.25) inset }

    /* تبويبات عليا */
    .tabs{ display:flex; gap:8px; flex-wrap:wrap }
    .tab{ border:1px solid var(--stroke); background:var(--panel); color:var(--txt); padding:10px 14px; border-radius:12px; cursor:pointer; transition:.15s ease; font-weight:700 }
    .tab:hover{ border-color:var(--gold); color:#fff }
    .tab.active{ background:linear-gradient(180deg, #1a1b20, #14151a); border-color:var(--gold); box-shadow:0 0 0 1px rgba(212,175,55,.35) inset; color:#fff }

    /* بطاقات */
    .card{ background:linear-gradient(180deg, #15161a, #121316); border:1px solid var(--stroke); border-radius:16px; padding:16px }
    .card + .card{ margin-top:16px }

    h1{ margin:0; font-size:26px; font-weight:900 }
    h2{ margin:0 0 10px; font-size:18px; font-weight:800; color:#fff }
    .sub{ color:var(--muted); font-size:13px }

    /* أزرار */
    .btn{ appearance:none; border:1px solid var(--stroke); background:var(--panel); color:var(--txt); padding:10px 14px; border-radius:12px; cursor:pointer; transition:.15s ease; font-weight:800 }
    .btn:hover{ border-color:#3a3b42 }
    .btn.gold{ background:linear-gradient(180deg, #2a2211, #1f1a0d); border-color:var(--gold); color:#fff; box-shadow:0 0 0 1px rgba(212,175,55,.25) inset }
    .btn.gold:hover{ border-color:#ffdb6e; box-shadow:0 0 0 1px rgba(255,219,110,.35) inset }
    .btn.ghost{ background:#0f1013 }
    .btn.danger{ border-color:#7a1f1f; color:#ffd9d9 }
    .btn.whatsapp{ border-color:#1b8c4f; color:#dff7ea }

    /* إدخالات */
    .row{ display:grid; grid-template-columns: 1.5fr 1fr auto; gap:10px; align-items:center }
    .grid{ display:grid; gap:12px }
    .grid.cols-4{ grid-template-columns: repeat(4, 1fr) }
    .grid.cols-3{ grid-template-columns: 2fr 1fr 1fr }
    .field{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--stroke); background:#0f1013; color:var(--txt) }
    .field:focus{ outline:none; border-color:var(--gold) }
    .hint{ font-size:12px; color:var(--muted) }

    /* جدول */
    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; margin-top:10px }
    thead th{ background:linear-gradient(180deg, #222328, #1a1b20); color:#f6f6f6; border-bottom:1px solid var(--stroke); padding:12px; text-align:right; font-weight:900 }
    tbody td{ padding:12px; border-bottom:1px solid var(--stroke) }
    tbody tr:hover{ background:rgba(212,175,55,0.05) }
    .kpi{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px }
    .kpi .card{ text-align:center }

    .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:99px; background:#101114; border:1px solid var(--stroke); font-size:12px; color:var(--muted) }
    .badge .dot{ width:7px; height:7px; border-radius:50%; background:var(--gold) }

    .editable{ cursor:pointer; color:#ffd76a; font-weight:800; text-decoration:underline dotted rgba(212,175,55,.6); text-underline-offset:3px }
    .warn{ color:#ffaaaa }
  </style>
</head>
<body>
  <!-- شريط علوي -->
  <div class="topbar">
    <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:12px">
      <div class="brand"><span class="brand-dot"></span><span>مركز الإرسال الفخم</span></div>
      <nav class="tabs" id="tabs">
        <button class="tab active" data-go="#sec-event">الحدث</button>
        <button class="tab" data-go="#sec-import-guests">استيراد الضيوف</button>
        <button class="tab" data-go="#sec-import-qr">استيراد الباركود</button>
        <button class="tab" data-go="#sec-add">إضافة يدوي</button>
        <button class="tab" data-go="#sec-msg">نص الرسالة</button>
        <button class="tab" data-go="#sec-list">قائمة الضيوف</button>
      </nav>
    </div>
  </div>

  <main class="container">
    <!-- الحدث -->
    <section id="sec-event" class="card">
      <h2>🏷️ بيانات الحدث</h2>
      <div class="grid cols-3" style="margin-top:10px">
        <input id="eventName" class="field" placeholder="اسم الحدث (مثال: زواج علي 2025)" />
        <button class="btn gold" onclick="saveData()">💾 حفظ البيانات (JSON)</button>
        <div style="display:flex; gap:8px; align-items:center">
          <input id="dataUpload" type="file" accept=".json" style="display:none" onchange="loadDataFile(this.files[0])" />
          <button class="btn" onclick="document.getElementById('dataUpload').click()">↩️ تحميل بيانات</button>
          <span class="badge"><span class="dot"></span><span id="statsBadge">الكروت المتاحة: 0</span></span>
        </div>
      </div>
    </section>

    <!-- إدارة واستيراد -->
    <section id="sec-import-guests" class="card">
      <h2>👥 1) استيراد قائمة الضيوف</h2>
      <p class="sub">الأعمدة: <code>name</code>، <code>phone</code>، <code>totalNeeded</code></p>
      <div class="row">
        <input id="guestListUpload" type="file" class="field" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />
        <button class="btn gold" onclick="handleFileUpload()">✅ استيراد الأسماء</button>
        <div class="badge"><span class="dot"></span>تم تحميل <b id="guestCount">0</b> ضيف</div>
      </div>
    </section>

    <section id="sec-import-qr" class="card">
      <h2>🖼️ 2) استيراد صور الباركود</h2>
      <p class="sub">اختر كل ملفات الباركود دفعة واحدة (PNG/JPG/SVG). يتم التوزيع تلقائيًا <b>بالترتيب</b>.</p>
      <div class="row">
        <input id="barcodeUpload" type="file" class="field" accept="image/*" multiple />
        <button class="btn gold" onclick="loadBarcodes()">🗂️ استيراد الباركود</button>
        <div class="badge"><span class="dot"></span>تم استيراد <b id="barcodeCount">0</b></div>
      </div>
      <div class="hint" style="margin-top:8px">الأكواد: <span id="importedQrCodes">—</span></div>
      <div id="qrMismatchAlert" class="hint warn" style="display:none; margin-top:8px"></div>
    </section>

    <!-- إضافة يدوي -->
    <section id="sec-add" class="card">
      <h2>➕ إضافة ضيف يدوياً</h2>
      <div class="grid cols-4" style="margin-top:10px">
        <input id="newGuestName" class="field" placeholder="الاسم" />
        <input id="newGuestPhone" class="field" placeholder="الهاتف (9665...)" />
        <input id="newGuestTotalNeeded" class="field" type="number" min="1" value="1" placeholder="عدد الدعوات" />
        <button class="btn gold" onclick="addGuestManually()">إضافة الضيف</button>
      </div>
    </section>

    <!-- الرسالة -->
    <section id="sec-msg" class="card">
      <h2>🖊️ نص رسالة الواتساب</h2>
      <p class="sub">المتغيرات المتاحة: <code>#{{GUEST_NAME}}#</code>، <code>#{{TOTAL_COUNT}}#</code></p>
      <textarea id="messageTemplate" class="field" rows="5" style="resize:vertical; line-height:1.9">
مرحباً #{{GUEST_NAME}}#،
نتشرف بدعوتكم لحضور فعاليتنا (إجمالي الدعوات: #{{TOTAL_COUNT}}#).
الرجاء إحضار/إظهار أحد أكواد الباركود المرفقة للدخول.
      </textarea>
    </section>

    <!-- القائمة -->
    <section id="sec-list" class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px">
        <h2>📋 قائمة المدعوين</h2>
        <span class="hint">انقر على <b class="editable">الاسم</b> أو <b class="editable">الهاتف</b> أو <b class="editable">العدد</b> للتعديل الفوري</span>
      </div>

      <div class="kpi" style="margin-top:12px">
        <div class="card"><div class="hint">إجمالي الضيوف</div><div style="font-size:22px; font-weight:900" id="kpiTotal">0</div></div>
        <div class="card"><div class="hint">المطلوب من الكروت</div><div style="font-size:22px; font-weight:900" id="kpiNeeded">0</div></div>
        <div class="card"><div class="hint">الكروت المستوردة</div><div style="font-size:22px; font-weight:900" id="kpiImported">0</div></div>
        <div class="card"><div class="hint">المتبقي للتخصيص</div><div style="font-size:22px; font-weight:900" id="kpiRemain">0</div></div>
      </div>

      <table>
        <thead>
          <tr>
            <th>اسم الضيف</th>
            <th>عدد الدعوات</th>
            <th>رقم الهاتف</th>
            <th>الباركود المخصصة</th>
            <th style="text-align:left">الإجراءات</th>
          </tr>
        </thead>
        <tbody id="guestTableBody"></tbody>
      </table>
    </section>
  </main>

  <script>
    // ======== نفس منطقك مع تحسين العرض (نقلت الشيفرة كما هي تقريبًا) ========
    let guests = [];
    let barcodeImages = {}; // id -> dataURL
    let availableQrIds = [];
    let internalGuestIdCounter = 0;

    // تنقل التبويبات
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const target = document.querySelector(btn.dataset.go);
        if(target){ target.scrollIntoView({behavior:'smooth', block:'start'}); }
      })
    })

    function updateBadges(){
      document.getElementById('statsBadge').textContent = `الكروت المتاحة: ${availableQrIds.length}`;
      document.getElementById('kpiTotal').textContent = guests.length;
      const needed = guests.reduce((s,g)=>s + (parseInt(g.totalNeeded)||0), 0);
      document.getElementById('kpiNeeded').textContent = needed;
      document.getElementById('kpiImported').textContent = availableQrIds.length;
      document.getElementById('kpiRemain').textContent = Math.max(availableQrIds.length - needed, 0);
    }

    // حفظ/تحميل بيانات
    function saveData(){
      const eventName = document.getElementById('eventName').value || 'Unnamed_Event';
      const dataToSave = { eventName, guests, availableQrIds, internalGuestIdCounter, messageTemplate: document.getElementById('messageTemplate').value };
      const blob = new Blob([JSON.stringify(dataToSave,null,2)], {type:'application/json'});
      saveAs(blob, `${eventName}_Data_${new Date().toISOString().slice(0,10)}.json`);
      alert('تم حفظ البيانات. تذكير: الصور لا تنتقل بين الأجهزة إلا بإعادة استيرادها.');
    }
    function loadDataFile(file){ if(!file) return; const r=new FileReader(); r.onload=(e)=>{ try{ const d=JSON.parse(e.target.result); loadData(d); alert('تم التحميل. أعد استيراد صور الباركود عند الحاجة.'); }catch(err){ alert('ملف غير صالح'); } }; r.readAsText(file); }
    function loadData(d){ guests = d.guests||[]; availableQrIds = d.availableQrIds||[]; internalGuestIdCounter = d.internalGuestIdCounter||0; document.getElementById('eventName').value = d.eventName||''; document.getElementById('messageTemplate').value = d.messageTemplate||document.getElementById('messageTemplate').value; barcodeImages={}; document.getElementById('barcodeCount').textContent=0; document.getElementById('importedQrCodes').textContent = availableQrIds.join(', ')||'—'; renderGuestTable(); checkQrMismatch(); updateBadges(); }

    // استيراد الضيوف
    function handleFileUpload(){
      const f = document.getElementById('guestListUpload').files[0]; if(!f){ alert('اختر ملفًا'); return; }
      const ext = f.name.split('.').pop().toLowerCase();
      if(ext==='csv') readCSV(f); else if(ext==='xlsx'||ext==='xls') readExcel(f); else alert('استخدم CSV أو XLSX');
    }
    function readCSV(file){ Papa.parse(file,{ header:true, skipEmptyLines:true, complete:(res)=>processImportedData(res.data), error:(e)=>alert('CSV خطأ: '+e.message) }); }
    function readExcel(file){ const r=new FileReader(); r.onload=(e)=>{ const data=new Uint8Array(e.target.result); const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]]; const arr=XLSX.utils.sheet_to_json(ws); processImportedData(arr); }; r.readAsArrayBuffer(file); }

    function processImportedData(data){
      const required=['name','phone','totalNeeded'];
      if(!data.length || !required.every(f=>Object.keys(data[0]).some(k=>k.toLowerCase()===f))) { alert('الأعمدة المطلوبة: name, phone, totalNeeded'); return; }
      internalGuestIdCounter=0;
      guests = data.map(guest=>{
        const get=(f)=>{ const key=Object.keys(guest).find(k=>k.toLowerCase()===f); return key? guest[key]:'' };
        internalGuestIdCounter++;
        const total=Math.max(1, parseInt(get('totalneeded'))||1);
        return { internalId:internalGuestIdCounter, name:String(get('name')).trim()||'—', phone:String(get('phone')).trim()||'—', totalNeeded:total, assignedQrIds:[], isManuallyAssigned:false };
      });
      distributeBarcodesAutomatically(); renderGuestTable(); checkQrMismatch(); updateBadges();
      alert(`تم تحميل ${guests.length} ضيف. سيتم توزيع ${guests.reduce((s,g)=>s+g.totalNeeded,0)} كرت تلقائيًا.`);
    }

    // استيراد الباركود
    function loadBarcodes(){
      const files = document.getElementById('barcodeUpload').files; if(!files.length){ alert('اختر ملفات'); return; }
      barcodeImages={}; availableQrIds=[]; let ok=0; const total=files.length;
      Array.from(files).forEach(file=>{
        const reader=new FileReader(); reader.onload=(e)=>{
          const id=file.name.split('.').slice(0,-1).join('');
          barcodeImages[id]=e.target.result; availableQrIds.push(id); ok++;
          document.getElementById('barcodeCount').textContent=ok; document.getElementById('importedQrCodes').textContent=availableQrIds.join(', ');
          if(ok===total){
            availableQrIds.sort((a,b)=>{ const A=parseInt(a), B=parseInt(b); if(!isNaN(A)&&!isNaN(B)) return A-B; return a.localeCompare(b) });
            distributeBarcodesAutomatically(); renderGuestTable(); checkQrMismatch(); updateBadges();
            alert(`تم استيراد ${ok} كود وتوزيعها تلقائيًا.`);
          }
        }; reader.readAsDataURL(file);
      })
    }

    // توزيع تلقائي
    function distributeBarcodesAutomatically(){
      const usedByManual = guests.filter(g=>g.isManuallyAssigned).flatMap(g=>g.assignedQrIds);
      const free = availableQrIds.filter(id=>!usedByManual.includes(id));
      guests.forEach(g=>{ if(!g.isManuallyAssigned) g.assignedQrIds=[]; });
      let i=0; guests.forEach(g=>{ if(!g.isManuallyAssigned){ const need=g.totalNeeded; if(i+need<=free.length){ g.assignedQrIds = free.slice(i, i+need); i+=need } else { g.assignedQrIds=[] } } });
    }

    // يدوي
    function assignBarcode(internalId){
      const g = guests.find(x=>x.internalId===internalId); if(!g) return;
      const need=g.totalNeeded; const val = prompt(`أدخل ${need} كود مفصولة بفواصل لـ ${g.name}:`, g.assignedQrIds.join(', ')); if(val===null) return;
      const list = val.split(',').map(s=>s.trim()).filter(Boolean);
      if(list.length!==need){ alert(`يجب إدخال ${need} كود بالضبط`); return; }
      const others = guests.flatMap(x=>x.assignedQrIds||[]).filter(id=>!g.assignedQrIds.includes(id));
      for(const id of list){ if(!barcodeImages[id]){ alert(`"${id}" غير موجود ضمن الصور المستوردة`); return } if(others.includes(id)){ alert(`الكود "${id}" مستخدم لضيف آخر`); return } }
      g.assignedQrIds = list; g.isManuallyAssigned = true; distributeBarcodesAutomatically(); renderGuestTable(); checkQrMismatch(); updateBadges();
    }

    // تعديل
    function editTotalNeeded(id){ const g=guests.find(x=>x.internalId===id); if(!g) return; const s=prompt(`عدد جديد لـ ${g.name}:`, g.totalNeeded); if(s===null||s.trim()==='') return; const n=parseInt(s); if(isNaN(n)||n<1){ alert('عدد غير صالح'); return } g.totalNeeded=n; g.isManuallyAssigned=false; distributeBarcodesAutomatically(); renderGuestTable(); checkQrMismatch(); updateBadges(); }
    function editGuestDetails(id, field){ const g=guests.find(x=>x.internalId===id); if(!g) return; const s=prompt(field==='name'?`اسم جديد لـ ${g.name}:`:`هاتف جديد لـ ${g.name}:`, g[field]); if(s===null||s.trim()==='') return; g[field]=s.trim(); renderGuestTable(); }

    // تنزيل الصور (PNG فردي أو ZIP متعدد)
    async function downloadBarcodeImage(guest){
      const ids=guest.assignedQrIds; const total=guest.totalNeeded; if(!ids.length){ alert('لا توجد كروت لهذا الضيف'); return }
      const missing=ids.filter(id=>!barcodeImages[id]); if(missing.length){ alert('صور ناقصة: '+missing.join(', ')); return }
      if(total===1){ const id=ids[0]; const a=document.createElement('a'); a.href=barcodeImages[id]; a.download=`${guest.name}_${id}.png`; document.body.appendChild(a); a.click(); a.remove(); return }
      const zip=new JSZip(); let count=0; for(const id of ids){ const b64=barcodeImages[id].split(',')[1]; zip.file(`${id}.png`, b64, {base64:true}); count++; }
      const blob = await zip.generateAsync({type:'blob'}); saveAs(blob, `${guest.name}_${total}_Cards.zip`);
    }

    function deleteGuest(id){ if(!confirm('حذف الضيف؟')) return; guests = guests.filter(g=>g.internalId!==id); distributeBarcodesAutomatically(); renderGuestTable(); checkQrMismatch(); updateBadges(); }

    // واتساب
    function sendWhatsAppMessage(guest){ if(!guest.assignedQrIds.length){ alert('لا كروت للضيف'); return } let txt=document.getElementById('messageTemplate').value; txt=txt.replace(/#\{\{GUEST_NAME\}\}#/g, guest.name).replace(/#\{\{TOTAL_COUNT\}\}#/g, guest.totalNeeded); const url=`https://wa.me/${guest.phone}?text=${encodeURIComponent(txt)}`; window.open(url,'_blank'); }

    // تنبيهات التوافق بين المتاح والمطلوب
    function checkQrMismatch(){ const need=guests.reduce((s,g)=>s+g.totalNeeded,0); const available=availableQrIds.length; const el=document.getElementById('qrMismatchAlert'); if(available<need){ el.style.display='block'; el.textContent=`تحذير: المتاح (${available}) أقل من المطلوب (${need}).` } else if(available>need){ el.style.display='block'; el.textContent=`ملاحظة: المتاح (${available}) أكثر من المطلوب (${need}). المتبقي: ${available-need}` } else { el.style.display='none' } }

    // رسم الجدول
    function renderGuestTable(){
      const body=document.getElementById('guestTableBody'); body.innerHTML='';
      document.getElementById('guestCount').textContent = guests.length;
      guests.forEach(guest=>{
        const tr=document.createElement('tr');
        const tdName=document.createElement('td'); tdName.innerHTML=`<span class="editable" title="تعديل" onclick="editGuestDetails(${guest.internalId}, 'name')">${guest.name}</span>`; tr.appendChild(tdName);
        const tdCount=document.createElement('td'); tdCount.innerHTML=`<span class="editable" title="تعديل" onclick="editTotalNeeded(${guest.internalId})">${guest.totalNeeded}</span>`; tr.appendChild(tdCount);
        const tdPhone=document.createElement('td'); tdPhone.innerHTML=`<span class="editable" title="تعديل" onclick="editGuestDetails(${guest.internalId}, 'phone')">${guest.phone}</span>`; tr.appendChild(tdPhone);
        const tdQr=document.createElement('td'); const list=guest.assignedQrIds.join(', '); tdQr.textContent=list||'لم يخصَّص'; tdQr.style.color = guest.assignedQrIds.length===guest.totalNeeded? '#cfd2d6' : '#ffb3b3'; tdQr.style.fontWeight='800'; tr.appendChild(tdQr);
        const tdAct=document.createElement('td'); tdAct.style.textAlign='left';
          const b1=document.createElement('button'); b1.className='btn'; b1.textContent='تعيين/تغيير'; b1.onclick=()=>assignBarcode(guest.internalId);
          const b2=document.createElement('button'); b2.className='btn'; b2.textContent= guest.totalNeeded===1? '💾 PNG' : '💾 ZIP'; b2.onclick=()=>downloadBarcodeImage(guest);
          const b3=document.createElement('button'); b3.className='btn whatsapp'; b3.textContent='💬 واتساب'; b3.onclick=()=>sendWhatsAppMessage(guest);
          const b4=document.createElement('button'); b4.className='btn danger'; b4.textContent='🗑️'; b4.onclick=()=>deleteGuest(guest.internalId);
          [b1,b2,b3,b4].forEach(b=>{ b.style.marginInlineStart='6px'; tdAct.appendChild(b); })
        tr.appendChild(tdAct);
        body.appendChild(tr);
      })
      updateBadges();
    }

    document.addEventListener('DOMContentLoaded', renderGuestTable);
  </script>
</body>
</html>

