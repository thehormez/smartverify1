<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez Security — Client Invite Portal</title>
  <style>
    /* =====================================
       Hormez UI — Luxury Black & Gold Theme
       Clean layout, clear hierarchy, pro cards
       ===================================== */
    :root{
      --bg:#0b0c0f;          /* خلفية داكنة فاخرة */
      --panel:#12141a;       /* لوحات أساسية */
      --panel-2:#171a21;     /* لوحات ثانوية */
      --stroke:#262a35;      /* حدود خفيفة */
      --text:#f2f5f9;        /* نص أساسي */
      --muted:#9aa3b2;       /* نص ثانوي */
      --gold-1:#f7e29c;      /* ذهبي فاتح */
      --gold-2:#caa24b;      /* ذهبي رئيسي */
      --gold-3:#8a6b2a;      /* ذهبي داكن */
      --accent:#2f81ff;      /* أزرق مساعد للروابط */
      --ok:#16a34a;          /* نجاح */
      --danger:#ef4444;      /* خطأ */
      --warn:#f59e0b;        /* تحذير */
      --radius-xl:18px;
      --radius-lg:14px;
      --radius:12px;
      --shadow: 0 10px 30px rgba(0,0,0,.35), 0 2px 0 rgba(255,255,255,.02) inset;
      --glow: 0 0 0 1px #000, 0 0 0 1px var(--stroke) inset, 0 30px 60px rgba(0,0,0,.55);
      --pad:16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", "Noto Sans Arabic", Arial, sans-serif; background:var(--bg); color:var(--text);}

    /* ===== Shell ===== */
    .shell{max-width:1200px; margin:auto; padding:20px}
    .topbar{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:18px}
    .brand{display:flex; gap:14px; align-items:center}
    .logo{width:42px; height:42px; border-radius:12px; background: radial-gradient(120% 120% at 20% 15%, #ffffff26, #0000), linear-gradient(135deg,#1b1e26,#0c0f14); border:1px solid var(--stroke); display:grid; place-items:center; box-shadow:var(--shadow)}
    .logo span{font-weight:900; letter-spacing:.5px; background: linear-gradient(180deg,var(--gold-1), var(--gold-2), var(--gold-3)); -webkit-background-clip:text; background-clip:text; color:transparent}
    .title h1{font-size:clamp(18px,2.4vw,26px); margin:0}
    .title .sub{color:var(--muted); font-size:12px}

    .badge{background:linear-gradient(135deg, #1a1d25, #12141a); border:1px solid var(--stroke); color:var(--gold-1); padding:8px 12px; border-radius:10px; box-shadow:var(--shadow)}

    /* ===== Grid ===== */
    .grid{display:grid; gap:18px}
    .cols-2{grid-template-columns: 1.2fr .8fr}
    @media (max-width: 1030px){.cols-2{grid-template-columns:1fr}}

    /* ===== Cards ===== */
    .card{background:linear-gradient(180deg, #141822, #10131a); border:1px solid var(--stroke); border-radius:var(--radius-xl); padding:18px; box-shadow:var(--glow)}
    .card h2{margin:0 0 12px; font-size:18px}
    .section{display:grid; gap:12px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    /* ===== Inputs ===== */
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 0}
    .input, .select, .area{width:100%; background:#0d1016; color:var(--text); border:1px solid var(--stroke); border-radius:12px; padding:12px 14px; outline:none; transition: .2s}
    .input:focus, .select:focus, .area:focus{border-color: var(--gold-2); box-shadow:0 0 0 3px rgba(202,162,75,.15)}
    .input[readonly]{opacity:.75}

    /* ===== Buttons ===== */
    .btn{border:0; padding:11px 14px; border-radius:12px; cursor:pointer; font-weight:600; transition: .2s; box-shadow:var(--shadow)}
    .btn:active{transform: translateY(1px)}
    .btn.gold{background:linear-gradient(135deg, var(--gold-1), var(--gold-2)); color:#191308}
    .btn.ghost{background:#0e1117; color:var(--text); border:1px solid var(--stroke)}
    .btn.primary{background:#2f81ff; color:white}
    .btn.warn{background:linear-gradient(135deg,#20170a,#18120a); color:var(--gold-1); border:1px solid #3a2a11}
    .btn.danger{background:linear-gradient(135deg,#2b0e0e,#1a0a0a); color:#fecaca; border:1px solid #3b1515}

    /* ===== Stats ===== */
    .stats{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px}
    .stat{background:linear-gradient(180deg,#0e1219,#0b0e14); border:1px dashed var(--stroke); border-radius:14px; padding:12px; text-align:center}
    .stat .label{font-size:12px; color:var(--muted)}
    .stat .value{font-size:20px; font-weight:800; letter-spacing:.3px}

    /* ===== Table ===== */
    .table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; border:1px solid var(--stroke); box-shadow:var(--glow)}
    .table th{background:linear-gradient(180deg,#151922,#0e1117); color:var(--gold-1); font-weight:700}
    .table th, .table td{padding:12px; border-bottom:1px solid var(--stroke); text-align:start; font-size:14px}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; background:#0f131a; border:1px solid var(--stroke); margin:0 6px 6px 0}

    /* ===== Dropzone ===== */
    .drop{border:1.5px dashed var(--stroke); border-radius:14px; padding:16px; background:linear-gradient(180deg,#0d1016,#0b0d12); text-align:center; transition:.2s}
    .drop.drag{border-color:var(--gold-2); box-shadow:0 0 0 3px rgba(202,162,75,.15)}

    /* ===== Preview Modal (Card style) ===== */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); backdrop-filter:saturate(110%) blur(8px); padding:20px}
    .modal.open{display:flex}
    .modal .panel{width:min(680px, 100%); background:linear-gradient(180deg,#141824,#0f131b); border:1px solid var(--stroke); border-radius:18px; box-shadow:var(--glow); padding:18px}
    .qr-preview{display:flex; gap:14px; align-items:center; flex-wrap:wrap}
    .qr-box{background:#fff; padding:10px; border-radius:12px; box-shadow:0 6px 30px rgba(0,0,0,.35)}

    /* ===== Footer ===== */
    .footer{color:var(--muted); font-size:12px; margin-top:14px; text-align:center; opacity:.9}

    /* Utility */
    .muted{color:var(--muted)}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="shell">
    <!-- Topbar -->
    <div class="topbar">
      <div class="brand">
        <div class="logo"><span>HS</span></div>
        <div class="title">
          <h1>Hormez Security — بوابة إرسال الدعوات</h1>
          <div class="sub">Client Invite Portal · Persistent QR (IndexedDB) · Gold/Black UI</div>
        </div>
      </div>
      <div class="badge">يحفظ تلقائيًا لكل فعالية</div>
    </div>

    <!-- Main Grid -->
    <div class="grid cols-2">
      <!-- Settings Card -->
      <section class="card section" id="eventCard">
        <h2>إعدادات الفعالية</h2>
        <div class="grid" style="grid-template-columns:repeat(4, minmax(0,1fr)); gap:12px">
          <div>
            <label>اسم الفعالية</label>
            <input class="input" id="eventName" placeholder="مثال: زفاف خالد" />
          </div>
          <div>
            <label>رمز الفعالية (للتسلسل)</label>
            <input class="input" id="eventCode" placeholder="مثال: KH" />
          </div>
          <div>
            <label>الرصيد الإجمالي للكروت</label>
            <input type="number" min="0" class="input" id="balanceTotal" placeholder="أدخل العدد" />
          </div>
          <div>
            <label>آخر تسلسل مُستخدم</label>
            <input class="input" id="lastSeq" readonly />
          </div>
        </div>
        <div class="row">
          <button class="btn gold" id="saveEvent">حفظ الإعدادات</button>
          <button class="btn ghost" id="resetEvent">تهيئة الفعالية (لا يحذف السجل)</button>
        </div>
        <div class="stats">
          <div class="stat">
            <div class="label">إجمالي الرصيد</div>
            <div class="value" id="sTotal">0</div>
          </div>
          <div class="stat">
            <div class="label">المحجوز (تم توليده/إرساله)</div>
            <div class="value" id="sUsed">0</div>
          </div>
          <div class="stat">
            <div class="label">المتبقّي</div>
            <div class="value" id="sLeft">0</div>
          </div>
        </div>
      </section>

      <!-- New Invite Card -->
      <section class="card section">
        <h2>دعوة جديدة</h2>
        <div class="grid" style="grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px">
          <div>
            <label>الاسم</label>
            <input class="input" id="guestName" placeholder="اسم الضيف" />
          </div>
          <div>
            <label>رقم الهاتف (مع مفتاح الدولة)</label>
            <input class="input" id="guestPhone" placeholder="9715XXXXXXXX" />
          </div>
          <div>
            <label>عدد الكروت للمرافقين (يشمل الضيف)</label>
            <input type="number" min="1" value="1" class="input" id="guestTickets" />
          </div>
          <div>
            <label>ملاحظة (اختياري)</label>
            <input class="input" id="guestNote" placeholder="VIP، عائلة العريس…" />
          </div>
        </div>
        <div class="row">
          <button class="btn primary" id="pickContact">استيراد من سجل الهاتف</button>
          <button class="btn gold" id="createInvite">توليد & إرسال</button>
          <button class="btn ghost" id="previewFirst">معاينة الكرت الأول</button>
        </div>
        <div class="muted" style="font-size:12px">في الأجهزة الداعمة لـ <b>Contact Picker API</b> و <b>Web Share API</b> سيتم الاستيراد والمشاركة مباشرة. بخلاف ذلك، يتم فتح واتساب مع النص وتنزيل الصورة محليًا.</div>
      </section>
    </div>

    <!-- Import CSV -->
    <section class="card section" style="margin-top:8px">
      <h2>استيراد قائمة الضيوف (CSV)</h2>
      <div class="drop" id="dropZone">
        اسحب ملف CSV هنا أو <label for="csvFile" style="text-decoration:underline; cursor:pointer; color:var(--gold-1)">اختر ملفًا</label>
        <input id="csvFile" type="file" accept=".csv" hidden />
      </div>
      <div class="muted" style="font-size:12px">صيغة الأعمدة: <b>Name, Phone, Tickets</b>. سيُشارك الكرت الأول تلقائيًا لأول صف فقط لتفادي الإزعاج، والباقي متاح للتنزيل.</div>
    </section>

    <!-- Invites Table -->
    <section class="card section">
      <h2>سجل الدعوات</h2>
      <table class="table" id="invitesTable">
        <thead>
          <tr>
            <th>#</th>
            <th>الضيف</th>
            <th>الهاتف</th>
            <th>الكروت</th>
            <th>الأكواد</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <div class="footer">© 2025 — Hormez Security. واجهة فاخرة (أسود/ذهبي)، حفظ محلي، جاهزة للجوال.</div>
  </div>

  <!-- QRCode CDN -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script>
  /* =====================================
     IndexedDB & Core State
     ===================================== */
  const DB_NAME = 'hormez_invites_db';
  const DB_VER  = 1;
  const STORE_SETTINGS = 'settings';
  const STORE_INVITES  = 'invites';
  const STORE_QR       = 'qr_images';

  const $  = s=> document.querySelector(s);
  const $$ = s=> Array.from(document.querySelectorAll(s));
  const pad = (n,w=3)=> String(n).padStart(w,'0');

  let gdb;
  let settings = { eventName:'', eventCode:'', balanceTotal:0, lastSeq:0 };
  let currentEventKey = '';

  function openDB(){
    return new Promise((resolve, reject)=>{
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = ()=>{
        const db = req.result;
        if(!db.objectStoreNames.contains(STORE_SETTINGS)) db.createObjectStore(STORE_SETTINGS);
        if(!db.objectStoreNames.contains(STORE_INVITES)){
          const s = db.createObjectStore(STORE_INVITES, { keyPath:'id' });
          s.createIndex('by_event','eventKey');
        }
        if(!db.objectStoreNames.contains(STORE_QR)){
          const q = db.createObjectStore(STORE_QR, { keyPath:'code' });
          q.createIndex('by_event','eventKey');
        }
      };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror   = ()=> reject(req.error);
    });
  }
  const tx = (db, store, mode='readonly')=> db.transaction(store, mode).objectStore(store);

  function makeEventKey(){
    return (settings.eventCode||'EVT').toUpperCase()+ '|' + (settings.eventName||'EVENT');
  }
  function normalizePhone(p){ return String(p||'').replace(/\D+/g,''); }

  async function saveSettings(){ gdb=gdb||await openDB(); return new Promise((res,rej)=>{ const r=tx(gdb,STORE_SETTINGS,'readwrite').put(settings,'event_settings'); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
  async function loadSettings(){
    gdb=gdb||await openDB();
    const st = await new Promise((res,rej)=>{ const r=tx(gdb,STORE_SETTINGS).get('event_settings'); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); });
    if(st) settings=st;
    currentEventKey=makeEventKey();
    // Fill UI
    $('#eventName').value=settings.eventName||'';
    $('#eventCode').value=settings.eventCode||'';
    $('#balanceTotal').value=settings.balanceTotal||'';
    updateStatsUI();
    await refreshTable();
  }

  async function computeUsed(){
    gdb=gdb||await openDB();
    return new Promise((res)=>{
      const c = tx(gdb,STORE_INVITES).index('by_event').openCursor(IDBKeyRange.only(currentEventKey));
      let sum=0; c.onsuccess=(e)=>{ const cur=e.target.result; if(cur){ sum += (cur.value.tickets||0); cur.continue(); } else res(sum); };
      c.onerror=()=>res(0);
    });
  }

  function updateStatsUI(){
    $('#sTotal').textContent = settings.balanceTotal;
    computeUsed().then(used=>{ $('#sUsed').textContent = used; $('#sLeft').textContent = Math.max(0, settings.balanceTotal - used); });
    $('#lastSeq').value = settings.lastSeq;
  }

  function nextSequence(){ settings.lastSeq += 1; return settings.lastSeq; }
  const codeFor = (idx)=>{ const seq=pad(nextSequence()); const base=(settings.eventCode||'EVT').toUpperCase()+ '_' + seq; return idx>1? `${base}-${idx}` : base; };

  function textTemplate({name,eventName,code}){
    return `دعوة ${name}\nفعالية: ${eventName}\nالباركود: ${code}\nيرجى إبراز الباركود عند الدخول.`;
  }
  function waLink(phone, text){ const p=normalizePhone(phone); return `https://wa.me/${p}?text=${encodeURIComponent(text)}`; }

  async function generateQRToBlob(text){
    try{
      const canvas=document.createElement('canvas');
      await QRCode.toCanvas(canvas, text, { errorCorrectionLevel:'M', margin:2, scale:6 });
      return await new Promise(res=> canvas.toBlob(res,'image/png'));
    }catch(_){ return new Blob([`QR: ${text}`], {type:'text/plain'}); }
  }

  async function storeQR(code, blob){
    gdb=gdb||await openDB();
    const rec={ code, blob, eventKey:currentEventKey, ts:Date.now() };
    return new Promise((res,rej)=>{ const r=tx(gdb,STORE_QR,'readwrite').put(rec); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); });
  }

  async function saveInvite(inv){ gdb=gdb||await openDB(); return new Promise((res,rej)=>{ const r=tx(gdb,STORE_INVITES,'readwrite').put(inv); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
  async function readInvite(id){ gdb=gdb||await openDB(); return new Promise((res,rej)=>{ const r=tx(gdb,STORE_INVITES).get(id); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); }); }
  async function deleteInvite(id){ gdb=gdb||await openDB(); return new Promise((res,rej)=>{ const r=tx(gdb,STORE_INVITES,'readwrite').delete(id); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
  async function getQRBlob(code){ gdb=gdb||await openDB(); return new Promise((res)=>{ const r=tx(gdb,STORE_QR).get(code); r.onsuccess=()=>res(r.result?.blob||null); r.onerror=()=>res(null); }); }

  async function refreshTable(){
    gdb=gdb||await openDB();
    const tbody=$('#invitesTable tbody'); tbody.innerHTML='';
    const idx=tx(gdb,STORE_INVITES).index('by_event');
    const req=idx.openCursor(IDBKeyRange.only(currentEventKey));
    let i=1;
    req.onsuccess=async (e)=>{
      const cur=e.target.result;
      if(cur){
        const v=cur.value; const tr=document.createElement('tr');
        const codes=(v.codes||[]).map(c=>`<span class=\"pill\">${c}</span>`).join('');
        tr.innerHTML=`
          <td>${i++}</td>
          <td>${v.name||''}</td>
          <td>${v.phone||''}</td>
          <td>${v.tickets||0}</td>
          <td>${codes}</td>
          <td>
            <button class=\"btn ghost\" data-action=\"share-first\" data-id=\"${v.id}\">مشاركة الأول</button>
            <button class=\"btn ghost\" data-action=\"download-all\" data-id=\"${v.id}\">تنزيل الكل</button>
            <button class=\"btn danger\" data-action=\"delete\" data-id=\"${v.id}\">حذف</button>
          </td>`;
        tbody.appendChild(tr);
        cur.continue();
      }
    }
  }

  async function downloadBlob(filename, blob){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 2000); }

  async function shareOrDownloadFirst(inv){
    if(!inv || !inv.codes?.length) return;
    const code=inv.codes[0];
    const blob=await getQRBlob(code);
    const text=textTemplate({ name:inv.name, eventName:settings.eventName, code });
    if(navigator.canShare && blob){
      try{ const file=new File([blob], `${code}.png`, {type:'image/png'}); await navigator.share({ files:[file], text }); return; }catch(_){ /* fallback */ }
    }
    const link=waLink(inv.phone, text); window.open(link,'_blank');
    if(blob) downloadBlob(`${code}.png`, blob);
  }
  async function downloadAll(inv){ for(const code of inv.codes||[]){ const b=await getQRBlob(code); if(b) await downloadBlob(`${code}.png`, b); } }

  function persistForm(){ const snap={ guestName:$('#guestName').value, guestPhone:$('#guestPhone').value, guestTickets:$('#guestTickets').value, guestNote:$('#guestNote').value }; localStorage.setItem('formSnap:'+currentEventKey, JSON.stringify(snap)); }
  function restoreForm(){ const raw=localStorage.getItem('formSnap:'+currentEventKey); if(raw){ try{ const s=JSON.parse(raw); Object.entries(s).forEach(([k,v])=>{ const el=document.getElementById(k); if(el) el.value=v; }); }catch(_){ } } }

  /* =====================================
     UI Events
     ===================================== */
  $('#saveEvent').addEventListener('click', async ()=>{
    settings.eventName=$('#eventName').value.trim();
    settings.eventCode=$('#eventCode').value.trim();
    settings.balanceTotal=parseInt($('#balanceTotal').value||'0',10)||0;
    currentEventKey=makeEventKey();
    await saveSettings(); updateStatsUI(); restoreForm(); await refreshTable();
  });
  $('#resetEvent').addEventListener('click', async ()=>{
    settings={ eventName:'', eventCode:'', balanceTotal:0, lastSeq:0 };
    $('#eventName').value=''; $('#eventCode').value=''; $('#balanceTotal').value='';
    await saveSettings(); currentEventKey=makeEventKey(); updateStatsUI(); await refreshTable();
  });

  $$('#eventCard input').forEach(el=> el.addEventListener('input', ()=>{ if(el.id!=='balanceTotal') persistForm(); }));
  $$('#guestName, #guestPhone, #guestTickets, #guestNote').forEach(el=> el.addEventListener('input', persistForm));

  $('#pickContact').addEventListener('click', async ()=>{
    try{
      if(navigator.contacts && navigator.contacts.select){
        const res=await navigator.contacts.select(['name','tel'], {multiple:false});
        if(res && res[0]){
          const c=res[0]; const nm=Array.isArray(c.name)? c.name[0] : (c.name||''); const tel=Array.isArray(c.tel)? c.tel[0] : (c.tel||'');
          $('#guestName').value=nm||''; $('#guestPhone').value=tel||''; persistForm();
        }
      }else{ alert('جهازك لا يدعم استيراد جهات الاتصال مباشرة — استخدم ملف CSV.'); }
    }catch(_){ alert('تعذر الوصول لدفتر العناوين — تأكد من الأذونات.'); }
  });

  $('#createInvite').addEventListener('click', async ()=>{
    const name=$('#guestName').value.trim();
    const phone=normalizePhone($('#guestPhone').value);
    const note=$('#guestNote').value.trim();
    let tickets=parseInt($('#guestTickets').value||'1',10)||1; if(tickets<1) tickets=1;
    if(!name || !phone){ alert('الرجاء إدخال الاسم ورقم الهاتف'); return; }

    const used=await computeUsed();
    if(used + tickets > settings.balanceTotal){ if(!confirm('عدد الكروت يتجاوز الرصيد المتبقي. هل تريد المتابعة؟')) return; }

    const codes=[];
    for(let i=1;i<=tickets;i++){ const c=codeFor(i); codes.push(c); const blob=await generateQRToBlob(c); await storeQR(c, blob); }
    await saveSettings(); updateStatsUI();

    const inv={ id:crypto.randomUUID(), name, phone, note, tickets, codes, eventKey:currentEventKey, ts:Date.now() };
    await saveInvite(inv); await refreshTable();

    await shareOrDownloadFirst(inv);
    alert('تم توليد الدعوة ومشاركة الكرت الأول. باقي الصور متاحة للتنزيل من السجل.');
  });

  // Preview Modal
  const modal = (()=>{ const el=document.createElement('div'); el.className='modal'; el.innerHTML=`<div class=\"panel\"><h2 style=\"margin:0 0 10px\">معاينة الكرت الأول</h2><div class=\"qr-preview\" id=\"previewArea\"></div><div class=\"row\" style=\"margin-top:12px; justify-content:flex-end\"><button class=\"btn ghost\" id=\"closePreview\">إغلاق</button></div></div>`; document.body.appendChild(el); return el; })();
  function openModal(){ modal.classList.add('open'); }
  function closeModal(){ modal.classList.remove('open'); }
  document.addEventListener('click', (e)=>{ if(e.target.id==='closePreview' || e.target===modal) closeModal(); });

  $('#previewFirst').addEventListener('click', async ()=>{
    const name=$('#guestName').value.trim()||'ضيف';
    const seq=settings.lastSeq + 1; const base=(settings.eventCode||'EVT').toUpperCase() + '_' + pad(seq);
    const area=document.getElementById('previewArea'); area.innerHTML='';
    const box=document.createElement('div'); box.className='qr-box'; const cv=document.createElement('canvas'); box.appendChild(cv); area.appendChild(box);
    try{ await QRCode.toCanvas(cv, base, { errorCorrectionLevel:'M', margin:2, scale:6 }); }catch(_){ box.textContent=base; }
    const meta=document.createElement('div'); meta.className='muted'; meta.style.marginTop='6px'; meta.innerHTML=`${name} — سيتم توليد الأكواد بدءًا من <b style=\"color:var(--gold-1)\">${base}</b>`; area.appendChild(meta);
    openModal();
  });

  // Table actions
  $('#invitesTable').addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return; const id=b.getAttribute('data-id'); const action=b.getAttribute('data-action'); const inv=await readInvite(id); if(!inv) return;
    if(action==='share-first'){ await shareOrDownloadFirst(inv); }
    else if(action==='download-all'){ await downloadAll(inv); }
    else if(action==='delete'){ if(confirm('حذف هذه الدعوة؟')){ await deleteInvite(id); await refreshTable(); updateStatsUI(); } }
  });

  // CSV Import
  const dropZone=$('#dropZone');
  dropZone.addEventListener('dragover', e=>{ e.preventDefault(); dropZone.classList.add('drag'); });
  dropZone.addEventListener('dragleave', ()=> dropZone.classList.remove('drag'));
  dropZone.addEventListener('drop', e=>{ e.preventDefault(); dropZone.classList.remove('drag'); handleFiles(e.dataTransfer.files); });
  $('#csvFile').addEventListener('change', e=> handleFiles(e.target.files));

  function handleFiles(files){ if(!files || !files.length) return; const f=files[0]; const reader=new FileReader(); reader.onload=async ()=>{ const rows=parseCSV(reader.result); const header=rows[0]||[]; const iName=header.findIndex(h=> /name/i.test(h)); const iPhone=header.findIndex(h=> /phone|mobile|tel/i.test(h)); const iTix=header.findIndex(h=> /tickets|count|qty/i.test(h)); if(iName===-1||iPhone===-1){ alert('CSV يجب أن يحتوي الأعمدة: Name, Phone, Tickets'); return; }
      for(let r=1; r<rows.length; r++){
        const row=rows[r]; if(!row || row.length<2) continue;
        const name=(row[iName]||'').trim(); if(!name) continue;
        const phone=normalizePhone(row[iPhone]||''); if(!phone) continue;
        const tickets=Math.max(1, parseInt(row[iTix]||'1',10)||1);
        const codes=[]; for(let i=1;i<=tickets;i++){ const c=codeFor(i); codes.push(c); const blob=await generateQRToBlob(c); await storeQR(c, blob); }
        await saveSettings(); const inv={ id:crypto.randomUUID(), name, phone, note:'', tickets, codes, eventKey:currentEventKey, ts:Date.now() };
        await saveInvite(inv); if(r===1){ await shareOrDownloadFirst(inv); }
      }
      updateStatsUI(); await refreshTable(); alert('تم استيراد القائمة وإنشاء الدعوات.'); };
    reader.readAsText(f, 'utf-8'); }

  function parseCSV(text){ const rows=[]; let row=[]; let cell=''; let q=false; for(let i=0;i<text.length;i++){ const ch=text[i]; if(q){ if(ch==='"'){ if(text[i+1]==='"'){ cell+='"'; i++; } else{ q=false; } } else{ cell+=ch; } } else { if(ch==='"'){ q=true; } else if(ch===','){ row.push(cell); cell=''; } else if(ch==='\n'){ row.push(cell); rows.push(row); row=[]; cell=''; } else if(ch==='\r'){ } else { cell+=ch; } } } row.push(cell); rows.push(row); return rows.filter(r=> r.some(c=> String(c).trim()!==''); }

  // Init
  loadSettings().then(()=> restoreForm());
  </script>
</body>
</html>
