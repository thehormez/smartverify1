<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Client Invite Portal – Persistent QR (IndexedDB) + Image Share – Index</title>
  <style>
    :root{
      --bg:#0f0f13; --card:#17171d; --muted:#9aa0a6; --text:#e6e9ef; --gold:#c9a34a; --accent:#2d7ff9; --danger:#ef4444; --ok:#10b981;
    }
    html, body{height:100%}
    body{margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", "Noto Sans Arabic", Arial, sans-serif; background:var(--bg); color:var(--text)}
    .container{max-width:1100px; margin:24px auto; padding:0 16px}
    .grid{display:grid; gap:16px}
    .cols-2{grid-template-columns: repeat(2, minmax(0,1fr))}
    @media (max-width: 900px){.cols-2{grid-template-columns: 1fr}}
    .card{background:var(--card); border:1px solid #23232a; border-radius:16px; padding:16px}
    h1{font-size:clamp(20px,2.2vw,28px); margin:0 0 6px;}
    h2{font-size:18px; margin:0 0 10px}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input, select, button, textarea{font:inherit}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .input{background:#0d0d11; border:1px solid #2a2a33; color:var(--text); border-radius:12px; padding:10px 12px}
    .input[readonly]{opacity:.7}
    .btn{border:0; padding:10px 14px; border-radius:12px; cursor:pointer}
    .btn.gold{background:linear-gradient(135deg, #e9d28b, #b88a2a); color:#1a1406; font-weight:700}
    .btn.primary{background:#2d7ff9; color:white}
    .btn.ghost{background:transparent; border:1px solid #2a2a33; color:var(--text)}
    .btn.danger{background:var(--danger); color:white}
    .stat{background: #121218; border:1px dashed #2a2a33; padding:10px 12px; border-radius:12px; text-align:center}
    .stat .v{display:block; font-weight:700; font-size:18px}
    .muted{color:var(--muted)}
    .table{width:100%; border-collapse:collapse}
    .table th, .table td{padding:10px; border-bottom:1px solid #23232a; text-align:start}
    .pill{padding:2px 8px; border-radius:999px; font-size:12px; background:#1c1c24; border:1px solid #2a2a33}
    .ok{color:#10d096}
    .warn{color:#fbbf24}
    .drop{border:1px dashed #2a2a33; padding:14px; border-radius:12px; text-align:center; background:#101016}
    .footer{opacity:.7; font-size:12px; margin-top:8px}
    .brand{display:flex; align-items:center; gap:12px}
    .brand .logo{width:38px; height:38px; border-radius:10px; background: radial-gradient(circle at 30% 20%, #fff6, #0000), linear-gradient(135deg, #2a2a2f, #0c0c10); border:1px solid #2a2a33; display:flex; align-items:center; justify-content:center; font-weight:800; color:var(--gold)}
    .badge{border:1px solid #2a2a33; padding:6px 8px; border-radius:8px; font-size:12px; background:#121219}
    .qr-preview{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .qr-box{background:#fff; padding:8px; border-radius:8px}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="container">
    <div class="row" style="justify-content:space-between; margin-bottom:14px">
      <div class="brand">
        <div class="logo">HS</div>
        <div>
          <h1>HORMEZ SECURITY • بوابة العميل لإرسال الدعوات</h1>
          <div class="muted" style="font-size:12px">Client Invite Portal – Persistent QR (IndexedDB) + Image Share</div>
        </div>
      </div>
      <div class="badge">يحفظ تلقائيًا لكل فعالية (IndexedDB)</div>
    </div>

    <div class="grid cols-2">
      <!-- Event / Balance Settings -->
      <section class="card" id="eventCard">
        <h2>إعدادات الفعالية</h2>
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
          <div>
            <label>اسم الفعالية</label>
            <input class="input" id="eventName" placeholder="مثال: زفاف خالد" />
          </div>
          <div>
            <label>رمز الفعالية (اختياري – للترقيم)</label>
            <input class="input" id="eventCode" placeholder="مثال: KH" />
          </div>
          <div>
            <label>الرصيد الإجمالي للكروت</label>
            <input type="number" min="0" class="input" id="balanceTotal" placeholder="أدخل العدد" />
          </div>
          <div>
            <label>آخر تسلسل مُستخدم</label>
            <input class="input" id="lastSeq" readonly />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn gold" id="saveEvent">حفظ الإعدادات</button>
          <button class="btn ghost" id="resetEvent">إعادة تعيين الفعالية (لا يمسح الدعوات)</button>
        </div>
        <div class="row" style="margin-top:12px">
          <div class="stat" style="flex:1">
            <span class="muted">إجمالي الرصيد</span>
            <span class="v" id="sTotal">0</span>
          </div>
          <div class="stat" style="flex:1">
            <span class="muted">المحجوز (مُرسل/مولّد)</span>
            <span class="v" id="sUsed">0</span>
          </div>
          <div class="stat" style="flex:1">
            <span class="muted">المتبقّي</span>
            <span class="v" id="sLeft">0</span>
          </div>
        </div>
      </section>

      <!-- New Invite -->
      <section class="card">
        <h2>دعوة جديدة</h2>
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
          <div>
            <label>الاسم</label>
            <input class="input" id="guestName" placeholder="اسم الضيف" />
          </div>
          <div>
            <label>رقم الهاتف (مع مفتاح الدولة)</label>
            <input class="input" id="guestPhone" placeholder="مثال: 9715XXXXXXXX" />
          </div>
          <div>
            <label>عدد الكروت للمرافقين (يشمل الضيف)</label>
            <input type="number" min="1" value="1" class="input" id="guestTickets" />
          </div>
          <div>
            <label>ملاحظة (اختياري)</label>
            <input class="input" id="guestNote" placeholder="مثال: VIP، عائلة العريس…" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="pickContact">استيراد من سجل الهاتف</button>
          <button class="btn gold" id="createInvite">توليد & إرسال</button>
          <button class="btn ghost" id="previewFirst">معاينة الكرت الأول</button>
        </div>
        <div class="footer">• إن كان جهازك يدعم <b>Contact Picker API</b> و <b>Web Share API</b> سيتم استيراد الأسماء ومشاركة الصورة مباشرة. خلاف ذلك ستظهر لك روابط واتساب وروابط تحميل.</div>
      </section>
    </div>

    <!-- CSV Import -->
    <section class="card" style="margin-top:16px">
      <h2>استيراد قائمة الضيوف (CSV)</h2>
      <div class="drop" id="dropZone">
        اسحب ملف CSV هنا أو <label for="csvFile" style="text-decoration:underline; cursor:pointer">اختر ملفًا</label>
        <input id="csvFile" type="file" accept=".csv" hidden />
      </div>
      <div class="footer">صيغة الأعمدة الموصى بها: <b>Name, Phone, Tickets</b> (والتذاكر رقم صحيح). سيتم توليد الكرت الأول تلقائيًا ومشاركة الصورة، وباقي الصور للتحميل/المشاركة.</div>
    </section>

    <!-- Invites Table -->
    <section class="card" style="margin-top:16px">
      <h2>سجل الدعوات</h2>
      <table class="table" id="invitesTable">
        <thead>
          <tr>
            <th>#</th>
            <th>الضيف</th>
            <th>الهاتف</th>
            <th>الكروت</th>
            <th>الأكواد</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Quick Preview Modal (simple) -->
    <section class="card hidden" id="previewCard">
      <h2>معاينة الكرت الأول</h2>
      <div class="qr-preview" id="previewArea"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="closePreview">إغلاق</button>
      </div>
    </section>

    <div class="footer">© 2025 • Hormez Security – بوابة العميل. تصميم احترافي بواجهة ذهبية/سوداء. يحفظ تلقائيًا داخل جهاز العميل. </div>
  </div>

  <!-- QRCode library (CDN). إن تعذّر التحميل سيعمل كل شيء ما عدا توليد الصورة. -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script>
  /******************************
   * IndexedDB Minimal Wrapper  *
   ******************************/
  const DB_NAME = 'hormez_invites_db';
  const DB_VER  = 1;
  const STORE_SETTINGS = 'settings';
  const STORE_INVITES  = 'invites';
  const STORE_QR       = 'qr_images';

  function openDB(){
    return new Promise((resolve, reject)=>{
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = (e)=>{
        const db = req.result;
        if(!db.objectStoreNames.contains(STORE_SETTINGS)) db.createObjectStore(STORE_SETTINGS);
        if(!db.objectStoreNames.contains(STORE_INVITES)){
          const s = db.createObjectStore(STORE_INVITES, { keyPath:'id' });
          s.createIndex('by_event', 'eventKey');
        }
        if(!db.objectStoreNames.contains(STORE_QR)){
          const q = db.createObjectStore(STORE_QR, { keyPath:'code' });
          q.createIndex('by_event', 'eventKey');
        }
      };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror   = ()=> reject(req.error);
    });
  }
  function tx(db, store, mode='readonly'){ return db.transaction(store, mode).objectStore(store); }

  /******************************
   * State + Utilities          *
   ******************************/
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const pad = (n, w=3)=> String(n).padStart(w, '0');

  let gdb;                 // db conn
  let settings = {         // per-event
    eventName: '',
    eventCode: '',
    balanceTotal: 0,
    lastSeq: 0
  };
  let currentEventKey = '';

  function makeEventKey(){
    return (settings.eventCode||'EVT').toUpperCase() + '|' + (settings.eventName||'EVENT');
  }

  function updateStatsUI(){
    $('#sTotal').textContent = settings.balanceTotal;
    computeUsed().then(used=>{
      $('#sUsed').textContent = used;
      $('#sLeft').textContent = Math.max(0, settings.balanceTotal - used);
    });
    $('#lastSeq').value = settings.lastSeq;
  }

  async function loadSettings(){
    gdb = gdb || await openDB();
    const st = await new Promise((res,rej)=>{
      const r = tx(gdb, STORE_SETTINGS).get('event_settings');
      r.onsuccess = ()=> res(r.result || null);
      r.onerror   = ()=> rej(r.error);
    });
    if(st){ settings = st; }
    currentEventKey = makeEventKey();
    // Fill UI
    $('#eventName').value = settings.eventName || '';
    $('#eventCode').value = settings.eventCode || '';
    $('#balanceTotal').value = settings.balanceTotal || '';
    updateStatsUI();
    await refreshTable();
  }

  async function saveSettings(){
    gdb = gdb || await openDB();
    await new Promise((res,rej)=>{
      const r = tx(gdb, STORE_SETTINGS, 'readwrite').put(settings, 'event_settings');
      r.onsuccess = ()=> res();
      r.onerror   = ()=> rej(r.error);
    });
  }

  async function computeUsed(){
    gdb = gdb || await openDB();
    return await new Promise((res)=>{
      const s = tx(gdb, STORE_INVITES).index('by_event').openCursor(IDBKeyRange.only(currentEventKey));
      let total = 0;
      s.onsuccess = (e)=>{
        const cur = e.target.result;
        if(cur){ total += (cur.value.tickets || 0); cur.continue(); }
        else res(total);
      };
      s.onerror = ()=> res(0);
    });
  }

  function normalizePhone(p){
    return String(p||'').replace(/\D+/g,'');
  }

  function nextSequence(){
    settings.lastSeq += 1; // increments global sequence per event
    return settings.lastSeq;
  }

  function codeFor(idx){
    const seq = pad(nextSequence());
    const base = (settings.eventCode||'EVT').toUpperCase() + '_' + seq;
    return idx>1 ? `${base}-${idx}` : base;
  }

  function textTemplate({name, eventName, code}){
    return `دعوة ${name}\nفعالية: ${eventName}\nالباركود: ${code}\nيرجى إبراز الباركود عند الدخول.`;
  }

  function waLink(phone, text){
    const p = normalizePhone(phone);
    return `https://wa.me/${p}?text=${encodeURIComponent(text)}`;
  }

  async function generateQRToBlob(text){
    // using QRCode library; fallback to dataURL text if not loaded
    try{
      const canvas = document.createElement('canvas');
      await QRCode.toCanvas(canvas, text, { errorCorrectionLevel: 'M', margin:2, scale:6 });
      return await new Promise(res=> canvas.toBlob(res, 'image/png'));
    }catch(err){
      const blob = new Blob([`QR: ${text}`], {type:'text/plain'});
      return blob;
    }
  }

  async function storeQR(code, blob){
    gdb = gdb || await openDB();
    const rec = { code, blob, eventKey: currentEventKey, ts: Date.now() };
    await new Promise((res,rej)=>{
      const r = tx(gdb, STORE_QR, 'readwrite').put(rec);
      r.onsuccess = ()=> res();
      r.onerror   = ()=> rej(r.error);
    });
  }

  async function saveInvite(inv){
    gdb = gdb || await openDB();
    await new Promise((res,rej)=>{
      const r = tx(gdb, STORE_INVITES, 'readwrite').put(inv);
      r.onsuccess = ()=> res();
      r.onerror   = ()=> rej(r.error);
    });
  }

  async function refreshTable(){
    gdb = gdb || await openDB();
    const tbody = $('#invitesTable tbody');
    tbody.innerHTML = '';
    const idx = tx(gdb, STORE_INVITES).index('by_event');
    const req = idx.openCursor(IDBKeyRange.only(currentEventKey));
    let i=1;
    req.onsuccess = async (e)=>{
      const cur = e.target.result;
      if(cur){
        const v = cur.value;
        const tr = document.createElement('tr');
        const codesHtml = (v.codes||[]).map(c=>`<span class="pill">${c}</span>`).join(' ');
        tr.innerHTML = `
          <td>${i++}</td>
          <td>${v.name||''}</td>
          <td>${v.phone||''}</td>
          <td>${v.tickets||0}</td>
          <td>${codesHtml}</td>
          <td>
            <button class="btn ghost" data-action="share-first" data-id="${v.id}">مشاركة الأول</button>
            <button class="btn ghost" data-action="download-all" data-id="${v.id}">تنزيل الكل</button>
            <button class="btn danger" data-action="delete" data-id="${v.id}">حذف</button>
          </td>`;
        tbody.appendChild(tr);
        cur.continue();
      }
    }
  }

  async function readInvite(id){
    gdb = gdb || await openDB();
    return await new Promise((res,rej)=>{
      const r = tx(gdb, STORE_INVITES).get(id);
      r.onsuccess = ()=> res(r.result || null);
      r.onerror   = ()=> rej(r.error);
    });
  }

  async function deleteInvite(id){
    gdb = gdb || await openDB();
    await new Promise((res,rej)=>{
      const r = tx(gdb, STORE_INVITES, 'readwrite').delete(id);
      r.onsuccess = ()=> res();
      r.onerror   = ()=> rej(r.error);
    });
    await refreshTable();
    updateStatsUI();
  }

  async function getQRBlob(code){
    gdb = gdb || await openDB();
    return await new Promise((res)=>{
      const r = tx(gdb, STORE_QR).get(code);
      r.onsuccess = ()=> res(r.result?.blob || null);
      r.onerror   = ()=> res(null);
    });
  }

  async function downloadBlob(filename, blob){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 3000);
  }

  async function shareOrDownloadFirst(inv){
    if(!inv || !inv.codes?.length) return;
    const code = inv.codes[0];
    const blob = await getQRBlob(code);
    const text = textTemplate({ name: inv.name, eventName: settings.eventName, code });

    // Try Web Share with file
    if(navigator.canShare && blob){
      try{
        const file = new File([blob], `${code}.png`, {type:'image/png'});
        await navigator.share({ files:[file], text });
        return;
      }catch(e){ /* fallthrough */ }
    }
    // Fallback: open WhatsApp text only + auto-download image
    const link = waLink(inv.phone, text);
    window.open(link, '_blank');
    if(blob) downloadBlob(`${code}.png`, blob);
  }

  async function downloadAll(inv){
    for(const code of inv.codes||[]){
      const blob = await getQRBlob(code);
      if(blob) await downloadBlob(`${code}.png`, blob);
    }
  }

  function persistForm(){
    const snap = {
      guestName: $('#guestName').value,
      guestPhone: $('#guestPhone').value,
      guestTickets: $('#guestTickets').value,
      guestNote: $('#guestNote').value
    };
    localStorage.setItem('formSnap:'+currentEventKey, JSON.stringify(snap));
  }
  function restoreForm(){
    const raw = localStorage.getItem('formSnap:'+currentEventKey);
    if(raw){
      try{ const s = JSON.parse(raw); Object.entries(s).forEach(([k,v])=>{ const el = document.getElementById(k); if(el) el.value = v; }); }catch(_){ }
    }
  }

  /******************************
   * Event Listeners            *
   ******************************/
  $('#saveEvent').addEventListener('click', async ()=>{
    settings.eventName   = $('#eventName').value.trim();
    settings.eventCode   = $('#eventCode').value.trim();
    settings.balanceTotal= parseInt($('#balanceTotal').value||'0',10) || 0;
    currentEventKey      = makeEventKey();
    await saveSettings();
    updateStatsUI();
    restoreForm();
    await refreshTable();
  });

  $('#resetEvent').addEventListener('click', async ()=>{
    settings.eventName   = '';
    settings.eventCode   = '';
    settings.balanceTotal= 0;
    settings.lastSeq     = 0;
    $('#eventName').value = '';
    $('#eventCode').value = '';
    $('#balanceTotal').value = '';
    await saveSettings();
    currentEventKey      = makeEventKey();
    updateStatsUI();
    await refreshTable();
  });

  // Persist on input
  $$('#eventCard input').forEach(el=> el.addEventListener('input', ()=>{
    if(el.id==='balanceTotal') return; // avoid crazy writes while typing numbers
    persistForm();
  }));
  $$('#guestName, #guestPhone, #guestTickets, #guestNote').forEach(el=> el.addEventListener('input', persistForm));

  // Contact Picker
  $('#pickContact').addEventListener('click', async ()=>{
    try{
      if(navigator.contacts && navigator.contacts.select){
        const props = ['name','tel'];
        const opts  = { multiple:false }; 
        const res = await navigator.contacts.select(props, opts);
        if(res && res[0]){
          const c = res[0];
          const nm = Array.isArray(c.name) ? c.name[0] : (c.name||'');
          const tel= Array.isArray(c.tel)  ? c.tel[0]  : (c.tel||'');
          $('#guestName').value = nm || '';
          $('#guestPhone').value= tel || '';
          persistForm();
        }
      }else{
        alert('جهازك لا يدعم استيراد جهات الاتصال مباشرة. استخدم ملف CSV أعلاه.');
      }
    }catch(e){ alert('تعذّر الوصول لدفتر العناوين. تأكد من الأذونات.'); }
  });

  // Create Invite
  $('#createInvite').addEventListener('click', async ()=>{
    const name   = $('#guestName').value.trim();
    const phone  = normalizePhone($('#guestPhone').value);
    const note   = $('#guestNote').value.trim();
    let tickets  = parseInt($('#guestTickets').value||'1',10) || 1;
    if(!name || !phone){ alert('رجاء أدخل الاسم ورقم الهاتف'); return; }
    if(tickets<1) tickets = 1;

    // Check balance
    const used = await computeUsed();
    if(used + tickets > settings.balanceTotal){
      if(!confirm('عدد الكروت يتجاوز الرصيد المتبقي. هل تريد المتابعة؟')) return;
    }

    const codes = [];
    for(let i=1;i<=tickets;i++){
      const c = codeFor(i); // updates lastSeq
      codes.push(c);
      const qrBlob = await generateQRToBlob(c);
      await storeQR(c, qrBlob);
    }
    await saveSettings(); // persist lastSeq
    updateStatsUI();

    const inv = {
      id: crypto.randomUUID(),
      name, phone, note, tickets,
      codes, eventKey: currentEventKey, ts: Date.now()
    };
    await saveInvite(inv);
    await refreshTable();

    // Auto share first & show others for download
    await shareOrDownloadFirst(inv);
    alert('تم توليد الدعوة. تم فتح واتساب/المشاركة للكرت الأول. باقي الكروت متاحة للتنزيل من السجل.');
  });

  // Preview first
  $('#previewFirst').addEventListener('click', async ()=>{
    const name   = $('#guestName').value.trim() || 'ضيف';
    const tickets= parseInt($('#guestTickets').value||'1',10) || 1;
    // temporary generate (not persisted) text preview
    const seq = settings.lastSeq + 1;
    const base = (settings.eventCode||'EVT').toUpperCase() + '_' + pad(seq);
    const first = base; // idx 1
    $('#previewCard').classList.remove('hidden');
    const area = $('#previewArea');
    area.innerHTML = '';
    const box = document.createElement('div');
    box.className = 'qr-box';
    const cv = document.createElement('canvas');
    box.appendChild(cv);
    area.appendChild(box);
    try{
      await QRCode.toCanvas(cv, first, { errorCorrectionLevel: 'M', margin:2, scale:6 });
    }catch(_){ box.textContent = first; }
    const meta = document.createElement('div');
    meta.innerHTML = `<div class="muted">${name} – سيتم توليد ${tickets} كروت بدءًا من: <b>${first}</b></div>`;
    area.appendChild(meta);
  });
  $('#closePreview').addEventListener('click', ()=> $('#previewCard').classList.add('hidden'));

  // Table actions
  $('#invitesTable').addEventListener('click', async (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    const id = b.getAttribute('data-id');
    const action = b.getAttribute('data-action');
    const inv = await readInvite(id);
    if(!inv) return;
    if(action==='share-first'){
      await shareOrDownloadFirst(inv);
    }else if(action==='download-all'){
      await downloadAll(inv);
    }else if(action==='delete'){
      if(confirm('حذف هذه الدعوة؟')) await deleteInvite(id);
    }
  });

  // CSV Import (drag/drop + input)
  const dropZone = $('#dropZone');
  dropZone.addEventListener('dragover', e=>{ e.preventDefault(); dropZone.style.borderColor = '#2d7ff9'; });
  dropZone.addEventListener('dragleave', ()=> dropZone.style.borderColor = '#2a2a33');
  dropZone.addEventListener('drop', e=>{ e.preventDefault(); dropZone.style.borderColor = '#2a2a33'; handleFiles(e.dataTransfer.files); });
  $('#csvFile').addEventListener('change', e=> handleFiles(e.target.files));

  function handleFiles(files){
    if(!files || !files.length) return;
    const f = files[0];
    const reader = new FileReader();
    reader.onload = async ()=>{
      const rows = parseCSV(reader.result);
      // Expect headers
      const header = rows[0]||[];
      const iName = header.findIndex(h=> /name/i.test(h));
      const iPhone= header.findIndex(h=> /phone|mobile|tel/i.test(h));
      const iTix  = header.findIndex(h=> /tickets|count|qty/i.test(h));
      if(iName===-1 || iPhone===-1){ alert('CSV يجب أن يحتوي الأعمدة: Name, Phone, Tickets'); return; }
      for(let r=1; r<rows.length; r++){
        const row = rows[r]; if(!row || row.length<2) continue;
        const name = (row[iName]||'').trim(); if(!name) continue;
        const phone= normalizePhone(row[iPhone]||''); if(!phone) continue;
        const tickets = Math.max(1, parseInt(row[iTix]||'1',10)||1);
        // Create silently (no alerts per row)
        const codes=[];
        for(let i=1;i<=tickets;i++){
          const c= codeFor(i);
          codes.push(c);
          const qrBlob = await generateQRToBlob(c);
          await storeQR(c, qrBlob);
        }
        await saveSettings();
        const inv = { id: crypto.randomUUID(), name, phone, note:'', tickets, codes, eventKey: currentEventKey, ts: Date.now() };
        await saveInvite(inv);
        // Auto share only first of the FIRST row (to avoid bombarding)
        if(r===1){ await shareOrDownloadFirst(inv); }
      }
      updateStatsUI();
      await refreshTable();
      alert('تم استيراد القائمة وإنشاء الدعوات.');
    };
    reader.readAsText(f, 'utf-8');
  }

  // Minimal CSV parser (handles commas, quotes, newlines)
  function parseCSV(text){
    const rows=[]; let row=[]; let cell=''; let q=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i];
      if(q){
        if(ch==='"'){
          if(text[i+1]==='"'){ cell+='"'; i++; }
          else{ q=false; }
        }else{ cell+=ch; }
      }else{
        if(ch==='"'){ q=true; }
        else if(ch===','){ row.push(cell); cell=''; }
        else if(ch==='\n'){ row.push(cell); rows.push(row); row=[]; cell=''; }
        else if(ch==='\r'){ /* ignore */ }
        else{ cell+=ch; }
      }
    }
    row.push(cell); rows.push(row);
    return rows.filter(r=> r.some(c=> String(c).trim()!==''));
  }

  // INIT
  loadSettings().then(()=> restoreForm());
  </script>
</body>
</html>

