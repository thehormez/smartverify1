<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez INV â€” RSVP Dashboard</title>

  <!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700;900&display=swap" rel="stylesheet"/>

  <!-- XLSX Ù„Ù‚Ø±Ø§Ø¡Ø© Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b0f1a; --card:#111827; --card2:#0f172a; --stroke:#243041;
      --txt:#e5e7eb; --muted:#94a3b8; --gold:#d6b15e; --ok:#22c55e; --bad:#ef4444; --blue:#60a5fa;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#070a12,var(--bg));color:var(--txt);font-family:"Noto Sans Arabic",system-ui}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;position:sticky;top:0;background:rgba(7,10,18,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--stroke);padding:12px 18px;z-index:20}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .dot{width:12px;height:12px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#ffe8a3,var(--gold))}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:rgba(255,255,255,.04);border:1px solid var(--stroke);border-radius:16px;padding:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    input,select,button,textarea{
      width:100%;border:1px solid var(--stroke);background:rgba(255,255,255,.03);
      color:var(--txt);padding:12px 12px;border-radius:14px;font:inherit;outline:none
    }
    textarea{min-height:90px;resize:vertical;line-height:1.8}
    button{cursor:pointer;font-weight:900}
    .btn{background:#0b1225}
    .btnGold{background:linear-gradient(180deg,#e9cf8a,var(--gold));color:#111;border:none}
    .btnOk{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.5)}
    .btnBad{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.5)}
    .hint{color:var(--muted);font-size:13px}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media(max-width:900px){.kpi{grid-template-columns:1fr 1fr}}
    .kpi .box{background:rgba(255,255,255,.04);border:1px solid var(--stroke);border-radius:16px;padding:12px}
    .kpi .t{color:var(--muted);font-size:12px;font-weight:700}
    .kpi .n{font-size:22px;font-weight:900;margin-top:6px}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:16px;margin-top:10px}
    thead th{background:rgba(255,255,255,.06);padding:12px;border-bottom:1px solid var(--stroke);text-align:right;font-weight:900;font-size:13px}
    tbody td{padding:12px;border-bottom:1px solid var(--stroke);background:rgba(0,0,0,.15);font-size:14px}
    tbody tr:hover td{background:rgba(255,255,255,.05)}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;border:1px solid var(--stroke);font-size:12px}
    .tag.ok{border-color:rgba(34,197,94,.6)}
    .tag.bad{border-color:rgba(239,68,68,.6)}
    .tag.blue{border-color:rgba(96,165,250,.6)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .hidden{display:none!important}
  </style>
</head>

<body>
  <div class="top">
    <div class="brand"><span class="dot"></span><span>Hormez INV â€” RSVP Dashboard</span></div>
    <div class="row" style="min-width:320px;justify-content:flex-end">
      <button id="btnLogout" class="btn btnBad hidden" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div class="wrap">

    <!-- LOGIN -->
    <div id="loginCard" class="card" style="max-width:520px;margin:18px auto">
      <h2 style="margin:0 0 8px">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
      <div class="hint">Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Firebase Auth.</div>
      <div style="height:10px"></div>

      <div class="grid">
        <div>
          <div class="hint">Email</div>
          <input id="adminEmail" placeholder="thehormez@gmail.com" />
        </div>
        <div>
          <div class="hint">Password</div>
          <input id="adminPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
      </div>

      <div style="height:10px"></div>
      <button class="btnGold" onclick="loginAdmin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <div id="loginMsg" class="hint" style="margin-top:10px"></div>
    </div>

    <!-- DASHBOARD -->
    <div id="dash" class="hidden">

      <!-- Settings -->
      <div class="grid">
        <div class="card">
          <h3 style="margin:0 0 8px">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</h3>

          <div class="grid">
            <div>
              <div class="hint">Event ID</div>
              <input id="eventId" value="test_event" placeholder="Ù…Ø«Ø§Ù„: zafaf_khaled_2026" />
            </div>
            <div>
              <div class="hint">Template</div>
              <input id="templateName" value="krs_rsvp" />
            </div>
          </div>

          <div class="grid" style="margin-top:10px">
            <div>
              <div class="hint">Language</div>
              <select id="lang">
                <option value="ar" selected>ar</option>
                <option value="en">en</option>
              </select>
            </div>
            <div>
              <div class="hint">Cloud Function URL</div>
              <input id="fnUrl" class="mono" value="https://us-central1-hormez-inv.cloudfunctions.net/sendWhatsAppTemplate" />
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="hint">
            Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (vars) Ù„Ù„ØªÙ…Ø¨Ù„ÙŠØª ØªÙØ±Ø³Ù„ Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªØ±ØªÙŠØ¨. Ù…Ø«Ø§Ù„: <span class="mono">["ÙØ§Ø±Ø³","Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯","15-01-2026"]</span>
          </div>
          <textarea id="varsJson" class="mono">["ÙØ§Ø±Ø³","Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯","15-01-2026"]</textarea>

          <div style="height:10px"></div>
          <div class="row">
            <button class="btn btnOk" onclick="refreshAll()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="btn" onclick="ensureIndexesHint()">Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ÙÙ‡Ø§Ø±Ø³</button>
          </div>
          <div id="sysMsg" class="hint" style="margin-top:10px"></div>
        </div>

        <!-- Upload guests -->
        <div class="card">
          <h3 style="margin:0 0 8px">ğŸ“¥ Ø±ÙØ¹ Ø§Ù„Ø¶ÙŠÙˆÙ (Excel/CSV) Ø¥Ù„Ù‰ Firestore</h3>
          <div class="hint">Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©: name/Ø§Ù„Ø§Ø³Ù… + phone/Ø§Ù„Ù‡Ø§ØªÙ (ÙˆØ¥Ø®ØªÙŠØ§Ø±ÙŠ: invites/Ø¹Ø¯Ø¯)</div>

          <div style="height:10px"></div>
          <input id="fileGuests" type="file" accept=".csv,.xlsx,.xls" />

          <div style="height:10px"></div>
          <div class="row">
            <button class="btnGold" onclick="importGuests()">Ø±ÙØ¹ Ø§Ù„Ø¶ÙŠÙˆÙ</button>
            <button class="btn btnBad" onclick="clearEventGuests()">Ø­Ø°Ù Ø¶ÙŠÙˆÙ Ø§Ù„Ø­Ø¯Ø«</button>
          </div>

          <div id="importMsg" class="hint" style="margin-top:10px"></div>

          <hr style="border:none;border-top:1px solid var(--stroke);margin:14px 0" />

          <h3 style="margin:0 0 8px">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø³Ø±ÙŠØ¹ (ÙØ±Ø¯ÙŠ)</h3>
          <div class="grid">
            <div>
              <div class="hint">Ø§Ù„Ø§Ø³Ù…</div>
              <input id="oneName" value="ÙØ§Ø±Ø³" />
            </div>
            <div>
              <div class="hint">Ø§Ù„Ø±Ù‚Ù… (Ø¨Ø¯ÙˆÙ† +)</div>
              <input id="onePhone" value="971566112323" class="mono" />
            </div>
          </div>
          <div style="height:10px"></div>
          <button class="btnGold" onclick="sendOne()">Ø¥Ø±Ø³Ø§Ù„ Template Ø§Ù„Ø¢Ù†</button>
          <div id="sendOneMsg" class="hint" style="margin-top:10px"></div>
        </div>
      </div>

      <!-- KPI -->
      <div style="height:12px"></div>
      <div class="kpi">
        <div class="box"><div class="t">Ø¹Ø¯Ø¯ Ø§Ù„Ø¶ÙŠÙˆÙ</div><div class="n" id="kpiGuests">0</div></div>
        <div class="box"><div class="t">Pending RSVP</div><div class="n" id="kpiPending">0</div></div>
        <div class="box"><div class="t">Confirmed</div><div class="n" id="kpiYes">0</div></div>
        <div class="box"><div class="t">Declined</div><div class="n" id="kpiNo">0</div></div>
      </div>

      <!-- Guests table -->
      <div style="height:12px"></div>
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">ğŸ‘¥ Ø¶ÙŠÙˆÙ Ø§Ù„Ø­Ø¯Ø«</h3>
          <div class="row" style="min-width:360px;justify-content:flex-end">
            <button class="btn" onclick="toggleSelectAll()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„/Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn btnOk" onclick="sendSelected()">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø­Ø¯Ø¯</button>
            <button class="btnGold" onclick="sendAll()">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
          </div>
        </div>
        <div class="hint" id="guestsHint" style="margin-top:8px"></div>

        <table>
          <thead>
            <tr>
              <th style="text-align:center;width:50px">âœ“</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
              <th>Ø¹Ø¯Ø¯</th>
              <th>RSVP</th>
              <th>Ø¢Ø®Ø± Ø¥Ø±Ø³Ø§Ù„</th>
              <th>Ø¢Ø®Ø± Ø­Ø§Ù„Ø©</th>
            </tr>
          </thead>
          <tbody id="guestsBody"></tbody>
        </table>
      </div>

      <!-- WA messages -->
      <div style="height:12px"></div>
      <div class="card">
        <h3 style="margin:0 0 8px">ğŸ“¨ Ø¢Ø®Ø± Ø±Ø³Ø§Ø¦Ù„ WhatsApp (wa_messages)</h3>
        <div class="hint">Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ£ØªÙŠ Ù…Ù† Firestore (Collection: wa_messages) Ø­Ø³Ø¨ eventId.</div>

        <table>
          <thead>
            <tr>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th>to</th>
              <th>status</th>
              <th>wamid</th>
              <th>error</th>
            </tr>
          </thead>
          <tbody id="msgsBody"></tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- Firebase (v10 modular) + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, deleteDoc,
      collection, query, where, orderBy, limit, getDocs, writeBatch,
      onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // âœ… Firebase Config (hormez-inv)
    const firebaseConfig = {
      apiKey: "AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
      authDomain: "hormez-inv.firebaseapp.com",
      projectId: "hormez-inv",
      storageBucket: "hormez-inv.firebasestorage.app",
      messagingSenderId: "747519941805",
      appId: "1:747519941805:web:468fada2492700e9da3a24"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --------- UI helpers ----------
    const $ = (id) => document.getElementById(id);
    const show = (id, yes) => $(id).classList.toggle("hidden", !yes);

    // --------- State ----------
    let guests = []; // {phone,name,invites,rsvp,lastSendAt,lastStatus}
    let selected = new Set();
    let unsubGuests = null;
    let unsubMsgs = null;

    function normalizePhone(p){
      // ÙŠÙ‚Ø¨Ù„: +971..., 971..., 05..., 50...
      p = String(p || "").trim();
      p = p.replace(/\s+/g,"").replace(/^\+/,"");
      // Ø¥Ø°Ø§ Ø¨Ø¯Ø£ Ø¨Ù€ 0 Ù†Ø­Ø°Ù 0 Ùˆ Ù†ÙØªØ±Ø¶ UAE (971)
      if(/^0\d+/.test(p)) p = "971" + p.slice(1);
      return p;
    }

    function parseVars(){
      try{
        const v = JSON.parse($("varsJson").value || "[]");
        if(!Array.isArray(v)) throw new Error("vars must be array");
        return v;
      }catch(e){
        throw new Error("varsJson ØºÙŠØ± ØµØ§Ù„Ø­. Ù„Ø§Ø²Ù… Array JSON Ù…Ø«Ù„ [\"ÙØ§Ø±Ø³\",\"Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯\",\"15-01-2026\"]");
      }
    }

    function fmtTime(ts){
      if(!ts) return "";
      const d = ts?.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString("ar-AE");
    }

    function statusTag(s){
      const st = (s||"").toLowerCase();
      if(st==="delivered" || st==="read" || st==="sent") return `<span class="tag ok">${st}</span>`;
      if(st==="failed") return `<span class="tag bad">failed</span>`;
      return `<span class="tag blue">${st || "â€”"}</span>`;
    }

    function renderGuests(){
      $("kpiGuests").textContent = guests.length;

      let pending=0, yes=0, no=0;
      guests.forEach(g=>{
        if(g.rsvp==="yes") yes++;
        else if(g.rsvp==="no") no++;
        else pending++;
      });
      $("kpiPending").textContent = pending;
      $("kpiYes").textContent = yes;
      $("kpiNo").textContent = no;

      $("guestsHint").textContent = `Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹: ${guests.length} | Ø§Ù„Ù…Ø­Ø¯Ø¯: ${selected.size}`;

      const body = $("guestsBody");
      body.innerHTML = "";

      guests.forEach(g=>{
        const checked = selected.has(g.phone);
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td style="text-align:center">
            <input type="checkbox" ${checked ? "checked":""} />
          </td>
          <td>${g.name || ""}</td>
          <td class="mono">${g.phone}</td>
          <td>${g.invites || 1}</td>
          <td>${g.rsvp ? statusTag(g.rsvp) : `<span class="tag blue">pending</span>`}</td>
          <td>${g.lastSendAt ? fmtTime(g.lastSendAt) : "â€”"}</td>
          <td>${g.lastStatus ? statusTag(g.lastStatus) : "â€”"}</td>
        `;

        tr.querySelector("input").addEventListener("change",(e)=>{
          if(e.target.checked) selected.add(g.phone);
          else selected.delete(g.phone);
          renderGuests();
        });

        body.appendChild(tr);
      });
    }

    function renderMsgs(rows){
      const body = $("msgsBody");
      body.innerHTML = "";
      rows.forEach(m=>{
        const err = m?.statusRaw?.errors?.[0]?.error_data?.details || m?.statusRaw?.errors?.[0]?.message || "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.statusAt ? (typeof m.statusAt === "string" ? m.statusAt : fmtTime(m.statusAt)) : fmtTime(m.updatedAt || m.createdAt)}</td>
          <td class="mono">${m.to || ""}</td>
          <td>${statusTag(m.status)}</td>
          <td class="mono" style="max-width:420px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${m.wamid || ""}</td>
          <td>${err ? `<span class="tag bad">${err}</span>` : "â€”"}</td>
        `;
        body.appendChild(tr);
      });
    }

    // --------- Auth ----------
    window.loginAdmin = async function(){
      $("loginMsg").textContent = "";
      const email = $("adminEmail").value.trim();
      const pass  = $("adminPassword").value.trim();
      try{
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(err){
        console.error(err);
        $("loginMsg").textContent = "âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + (err.code || err.message);
      }
    };

    window.logout = async function(){
      await signOut(auth);
    };

    onAuthStateChanged(auth, (user)=>{
      if(user){
        show("loginCard", false);
        show("dash", true);
        show("btnLogout", true);
        $("sysMsg").textContent = "âœ… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„: " + (user.email || user.uid);
        refreshAll();
      }else{
        // cleanup listeners
        if(unsubGuests) unsubGuests();
        if(unsubMsgs) unsubMsgs();
        unsubGuests = null; unsubMsgs = null;

        guests = [];
        selected.clear();
        renderGuests();
        renderMsgs([]);

        show("loginCard", true);
        show("dash", false);
        show("btnLogout", false);
      }
    });

    // --------- Firestore paths ----------
    function guestsCol(){
      const eventId = $("eventId").value.trim();
      return collection(db, "events", eventId, "guests");
    }

    // --------- Load data ----------
    window.refreshAll = async function(){
      const eventId = $("eventId").value.trim();
      if(!eventId){ alert("Ø§ÙƒØªØ¨ eventId"); return; }

      // Guests live
      if(unsubGuests) unsubGuests();
      unsubGuests = onSnapshot(query(guestsCol(), orderBy("createdAt","desc"), limit(500)), (snap)=>{
        guests = snap.docs.map(d=>{
          const x = d.data();
          return {
            phone: d.id,
            name: x.name || "",
            invites: x.invites || 1,
            rsvp: x.rsvp || "pending",
            lastSendAt: x.lastSendAt || null,
            lastStatus: x.lastStatus || null
          };
        });
        // ØªÙ†Ø¸ÙŠÙ selection Ù„Ùˆ Ø­Ø°Ù Ø¶ÙŠÙ
        const setNow = new Set(guests.map(g=>g.phone));
        [...selected].forEach(p=>{ if(!setNow.has(p)) selected.delete(p); });
        renderGuests();
      });

      // Messages live
      if(unsubMsgs) unsubMsgs();
      // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø£ÙØ¶Ù„ ØªØ¹Ù…Ù„ ÙÙ‡Ø±Ø³ Ù„Ù„Ù€ eventId + updatedAt
      unsubMsgs = onSnapshot(
        query(collection(db,"wa_messages"), where("eventId","==",eventId), orderBy("updatedAt","desc"), limit(100)),
        (snap)=>{
          const rows = snap.docs.map(d=>d.data());
          renderMsgs(rows);
        },
        (err)=>{
          console.error(err);
          $("sysMsg").textContent = "âš ï¸ Ù…Ø´ÙƒÙ„Ø© Query Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ (ØºØ§Ù„Ø¨Ù‹Ø§ ÙŠØ­ØªØ§Ø¬ Index): " + err.message;
        }
      );

      $("sysMsg").textContent = `âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø­Ø¯Ø«: ${eventId}`;
    };

    window.ensureIndexesHint = function(){
      alert(
        "Ù„Ùˆ wa_messages Ù…Ø§ ØªØ¸Ù‡Ø± Ø£Ùˆ Ø¸Ù‡Ø±Øª Ø±Ø³Ø§Ù„Ø© Index:\n" +
        "Ø£Ù†Ø´Ø¦ Composite Index ÙÙŠ Firestore Ù„Ù€ wa_messages:\n" +
        "eventId (ASC) + updatedAt (DESC)\n\n" +
        "ÙˆØ£ÙŠØ¶Ø§Ù‹ guests Ø¯Ø§Ø®Ù„ events/{eventId}/guests:\n" +
        "createdAt (DESC) Ø¹Ø§Ø¯Ø© Ù„Ø§ ÙŠØ­ØªØ§Ø¬ ÙƒÙˆÙ…Ø¨ÙˆØ²Øª Ù„Ø£Ù†Ù‡Ø§ Ø¯Ø§Ø®Ù„ subcollection."
      );
    };

    // --------- Import guests from file ----------
    function readCSV(text){
      // Ø¨Ø³ÙŠØ·: ÙŠÙØµÙ„ Ø¨Ø§Ù„ÙƒÙˆÙ…Ù‘Ø§/Ø³ÙŠÙ…ÙŠ ÙƒÙˆÙ„Ù†
      const lines = text.split(/\r?\n/).filter(Boolean);
      if(!lines.length) return [];
      const headers = lines[0].split(/,|;/).map(h=>h.trim());
      const rows = [];
      for(let i=1;i<lines.length;i++){
        const cols = lines[i].split(/,|;/);
        const obj = {};
        headers.forEach((h,idx)=> obj[h]= (cols[idx]||"").trim());
        rows.push(obj);
      }
      return rows;
    }

    function findKey(keys, wanted){
      const norm = (s)=> String(s||"").toLowerCase().trim();
      const map = {
        name: ["name","full name","guest","guest name","Ø§Ù„Ø§Ø³Ù…","Ø§Ø³Ù…","Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ"],
        phone:["phone","mobile","tel","number","Ø§Ù„Ø¬ÙˆØ§Ù„","Ø§Ù„Ù‡Ø§ØªÙ","Ø±Ù‚Ù…","Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ","Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„"],
        invites:["invites","tickets","count","qty","total","Ø¹Ø¯Ø¯","Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª","Ø§Ù„Ø¹Ø¯Ø¯"]
      };
      const list = map[wanted].map(norm);
      return keys.find(k=> list.includes(norm(k))) || null;
    }

    window.importGuests = async function(){
      $("importMsg").textContent = "";
      const eventId = $("eventId").value.trim();
      if(!eventId){ alert("Ø§ÙƒØªØ¨ eventId"); return; }

      const f = $("fileGuests").files?.[0];
      if(!f){ alert("Ø§Ø®ØªØ± Ù…Ù„Ù CSV Ø£Ùˆ Excel"); return; }

      let arr = [];
      const ext = f.name.split(".").pop().toLowerCase();

      if(ext==="csv"){
        const text = await f.text();
        arr = readCSV(text);
      }else if(ext==="xlsx" || ext==="xls"){
        const data = new Uint8Array(await f.arrayBuffer());
        const wb = XLSX.read(data, { type:"array" });
        const ws = wb.Sheets[wb.SheetNames[0]];
        arr = XLSX.utils.sheet_to_json(ws);
      }else{
        alert("Ø§Ù…ØªØ¯Ø§Ø¯ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…");
        return;
      }

      if(!arr.length){
        alert("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº");
        return;
      }

      const keys = Object.keys(arr[0] || {});
      const kName = findKey(keys,"name");
      const kPhone= findKey(keys,"phone");
      const kInv  = findKey(keys,"invites");

      if(!kName || !kPhone){
        alert("Ù„Ø§Ø²Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: name/Ø§Ù„Ø§Ø³Ù… Ùˆ phone/Ø§Ù„Ù‡Ø§ØªÙ");
        return;
      }

      // Batch write (500 limit Ù„ÙƒÙ„ Ø¯ÙØ¹Ø©)
      let added=0, skipped=0;
      const colRef = guestsCol();

      let batch = writeBatch(db);
      let inBatch = 0;

      for(const row of arr){
        const name = String(row[kName]||"").trim();
        const phoneRaw = String(row[kPhone]||"").trim();
        const phone = normalizePhone(phoneRaw);
        const invites = Math.max(1, parseInt(row[kInv] || "1") || 1);

        if(!name || !phone){
          skipped++;
          continue;
        }

        const dref = doc(colRef, phone);
        batch.set(dref, {
          name,
          phone,
          invites,
          rsvp: "pending",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });

        added++;
        inBatch++;

        if(inBatch >= 450){
          await batch.commit();
          batch = writeBatch(db);
          inBatch = 0;
        }
      }

      if(inBatch>0) await batch.commit();

      $("importMsg").textContent = `âœ… ØªÙ… Ø±ÙØ¹ ${added} | ØªÙ… ØªØ¬Ø§Ù‡Ù„ ${skipped}`;
    };

    window.clearEventGuests = async function(){
      const eventId = $("eventId").value.trim();
      if(!eventId){ alert("Ø§ÙƒØªØ¨ eventId"); return; }
      if(!confirm("Ø­Ø°Ù ÙƒÙ„ Ø¶ÙŠÙˆÙ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯Ø«ØŸ")) return;

      const snap = await getDocs(query(guestsCol(), limit(1000)));
      let batch = writeBatch(db);
      let c=0, committed=0;

      for(const d of snap.docs){
        batch.delete(d.ref);
        c++;
        if(c>=450){
          await batch.commit();
          committed += c;
          batch = writeBatch(db);
          c=0;
        }
      }
      if(c>0){
        await batch.commit();
        committed += c;
      }
      alert("âœ… ØªÙ… Ø­Ø°Ù: " + committed);
    };

    // --------- Send via Cloud Function ----------
    async function callSendTemplate(payload){
      const url = $("fnUrl").value.trim();
      const res = await fetch(url, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload),
      });
      const j = await res.json().catch(()=> ({}));
      if(!res.ok || j?.ok===false) {
        const msg = j?.error?.message || j?.error || ("HTTP " + res.status);
        throw new Error(msg);
      }
      return j;
    }

    window.sendOne = async function(){
      $("sendOneMsg").textContent = "";
      try{
        const eventId = $("eventId").value.trim();
        const to = normalizePhone($("onePhone").value);
        const name = $("oneName").value.trim() || "Ø¶ÙŠÙ";
        const templateName = $("templateName").value.trim();
        const lang = $("lang").value;
        const vars = parseVars();

        // Ù…Ù‡Ù…: Ø¨Ø¹Ø¶ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ ØªØ­ØªØ§Ø¬ vars Ù…Ø­Ø¯Ø¯Ø©. Ù„Ùˆ ØªØ¨ÙŠ Ø§Ù„Ø§Ø³Ù… ÙŠØªØºÙŠØ±ØŒ Ø®Ù„ÙŠÙ‡ Ø£ÙˆÙ„ Ø¹Ù†ØµØ±
        if(vars.length) vars[0] = name;

        const j = await callSendTemplate({ eventId, to, name, templateName, lang, vars });
        $("sendOneMsg").textContent = "âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + (j.wamid || "");
      }catch(e){
        console.error(e);
        $("sendOneMsg").textContent = "âŒ ÙØ´Ù„: " + e.message;
      }
    };

    window.toggleSelectAll = function(){
      if(selected.size === guests.length) selected.clear();
      else guests.forEach(g=> selected.add(g.phone));
      renderGuests();
    };

    window.sendSelected = async function(){
      if(selected.size===0){ alert("Ø­Ø¯Ø¯ Ø¶ÙŠÙˆÙ Ø£ÙˆÙ„Ø§Ù‹"); return; }
      if(!confirm(`Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø­Ø¯Ø¯ (${selected.size})ØŸ`)) return;

      const eventId = $("eventId").value.trim();
      const templateName = $("templateName").value.trim();
      const lang = $("lang").value;
      const baseVars = parseVars();

      let ok=0, bad=0;
      $("sysMsg").textContent = "â³ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø­Ø¯Ø¯...";

      for(const phone of selected){
        const g = guests.find(x=>x.phone===phone);
        if(!g) continue;

        const vars = [...baseVars];
        if(vars.length) vars[0] = g.name || vars[0];

        try{
          await callSendTemplate({
            eventId,
            to: g.phone,
            name: g.name,
            templateName,
            lang,
            vars
          });
          ok++;
        }catch(e){
          console.error(e);
          bad++;
        }
        // ØªØ®ÙÙŠÙ Ø¶ØºØ·
        await new Promise(r=>setTimeout(r, 350));
      }

      $("sysMsg").textContent = `âœ… ØªÙ…: ${ok} | âŒ ÙØ´Ù„: ${bad}`;
    };

    window.sendAll = async function(){
      if(!guests.length){ alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¶ÙŠÙˆÙ"); return; }
      if(!confirm(`Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¬Ù…ÙŠØ¹ (${guests.length})ØŸ`)) return;

      const eventId = $("eventId").value.trim();
      const templateName = $("templateName").value.trim();
      const lang = $("lang").value;
      const baseVars = parseVars();

      let ok=0, bad=0;
      $("sysMsg").textContent = "â³ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¬Ù…ÙŠØ¹...";

      for(const g of guests){
        const vars = [...baseVars];
        if(vars.length) vars[0] = g.name || vars[0];

        try{
          await callSendTemplate({
            eventId,
            to: g.phone,
            name: g.name,
            templateName,
            lang,
            vars
          });
          ok++;
        }catch(e){
          console.error(e);
          bad++;
        }
        await new Promise(r=>setTimeout(r, 350));
      }

      $("sysMsg").textContent = `âœ… ØªÙ…: ${ok} | âŒ ÙØ´Ù„: ${bad}`;
    };
  </script>
</body>
</html>
