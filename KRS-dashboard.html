<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Hormez â€” Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø­Ø¯Ø« (Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¬ÙˆØ§Ù„)</title>
  <style>
    :root{
      --bg:#0b1020; --ink:#e5e7eb; --muted:#94a3b8; --card:#0e172a; --b:#1f2937;
      --ok:#16a34a; --bad:#dc2626; --warn:#f59e0b;
      --solid-blue:#1e40af;   /* Ø£Ø²Ø±Ù‚ */
      --solid-gold:#b48a18;   /* Ø°Ù‡Ø¨ÙŠ */
      --solid-rose:#be123c;   /* ÙˆØ±Ø¯ÙŠ */
      --solid-green:#047857;  /* Ø£Ø®Ø¶Ø± */
    }

    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,#0b1020,#0a0f1d);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial
    }
    .container{max-width:1000px;margin:0 auto;padding:12px}
    .topbar{
      position:sticky;top:0;z-index:10;
      background:rgba(11,16,32,.88);backdrop-filter:blur(6px);
      border-bottom:1px solid #243047
    }
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:32px;height:32px;border-radius:8px;background:#111;border:1px solid #333;display:grid;place-items:center}
    .logo span{font-weight:900;color:#ffd700;font-size:12px}

    .btn{
      appearance:none;border:1px solid #334155;background:#0b1220;color:var(--ink);
      border-radius:10px;padding:8px 12px;cursor:pointer;min-height:40px;font-size:14px
    }
    .btn:hover{background:#0d1528}
    .btn.block{width:100%}

    .input{
      width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:var(--ink);
      min-height:40px;font-size:14px
    }

    .card{
      background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
      border-radius:14px;padding:12px
    }

    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-4{grid-template-columns:repeat(4,1fr)}

    /* Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ­ÙˆÙ„ Ù„Ù„Ø¬ÙˆØ§Ù„ */
    @media(max-width:900px){
      .grid-2{grid-template-columns:1fr}
      .grid-4{grid-template-columns:1fr 1fr}
    }
    @media(max-width:560px){
      .grid-4{grid-template-columns:1fr}
      .container{padding:10px}
    }

    /* KPI Ø¨Ø£Ù„ÙˆØ§Ù† Ù…ØµÙ…ØªØ© ÙƒØ§Ù…Ù„Ø© ÙˆØ­Ø¬Ù… Ø£ØµØºØ± */
    .kpi{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .kpi .title{font-weight:800;font-size:13px}
    .kpi .n{font-size:22px;font-weight:900}
    .kpi.card{background-image:none!important;border-color:transparent!important;color:#fff}
    .kpi.card *{color:inherit!important}
    .kpi.card.blue   { background:var(--solid-blue)!important; }
    .kpi.card.gold   { background:var(--solid-gold)!important; color:#111!important; }
    .kpi.card.rose   { background:var(--solid-rose)!important; }
    .kpi.card.green  { background:var(--solid-green)!important; }

    .muted{color:var(--muted);font-size:12px}
    .titlebar{font-weight:800;font-size:14px}

    .badge{padding:3px 6px;border-radius:10px;border:1px solid transparent;font-weight:700;font-size:12px}
    .badge.ok{background:rgba(22,163,74,.12);border-color:rgba(22,163,74,.35);color:#86efac}
    .badge.no{background:rgba(220,38,38,.12);border-color:rgba(220,38,38,.35);color:#fca5a5}

    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-top:1px solid rgba(255,255,255,.08)}
    thead th{position:sticky;top:0;background:#0e162c}

    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .error{color:#fda4af;font-size:12px}

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media(max-width:760px){
      table thead{display:none}
      table,tbody,tr,td{display:block;width:100%}
      tbody tr{
        background:rgba(255,255,255,.04);
        border:1px solid rgba(255,255,255,.08);
        border-radius:12px;margin-bottom:8px;overflow:hidden
      }
      tbody td{display:flex;justify-content:space-between;gap:8px;border-top:none;border-bottom:1px solid rgba(255,255,255,.08);padding:10px}
      tbody td:last-child{border-bottom:none}
      tbody td::before{
        content:attr(data-label);color:#cbd5e1;font-weight:700;font-size:12px
      }
    }

    /* Ø·Ø¨Ø§Ø¹Ø© */
    @media print{
      body{background:#fff;color:#000}
      .topbar,.gate{display:none!important}
      .card{border:1px solid #ccc}
      .badge{border:1px solid #333}
    }
  </style>
</head>
<body>
  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <div class="topbar">
    <div class="container row" style="align-items:center">
      <div class="brand">
        <div class="logo"><span>HS</span></div>
        <div>
          <div class="muted">HORMEZ SECURITY</div>
          <div class="titlebar">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø­Ø¯Ø« â€” <span id="evNameTitle">â€”</span></div>
        </div>
      </div>
      <div style="margin-inline-start:auto" class="row">
        <button id="langBtn" class="btn">AR</button>
        <button id="refreshBtn" class="btn">â†»</button>
        <button id="logoutBtn" class="btn" style="display:none">ğŸšª Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù…Ø±ØªÙ‘Ø¨Ø© Ù„Ù„Ø¬ÙˆØ§Ù„: Ø¹Ù…ÙˆØ¯ÙŠ) -->
    <div class="card gate" id="gate">
      <div class="muted" style="margin-bottom:6px">Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
      <div class="grid" style="gap:8px">
        <div>
          <div class="muted" id="lblEvent">Ø§Ù„Ø­Ø¯Ø«</div>
          <input id="eventInput" class="input" placeholder="Ù…Ø«Ø§Ù„: haddad" />
        </div>
        <div>
          <div class="muted" id="lblPass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
          <input id="passInput" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢" />
        </div>
        <button id="enterBtn" class="btn block">Ø¯Ø®ÙˆÙ„</button>
      </div>
      <div id="gateMsg" class="error" style="margin-top:6px"></div>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ -->
    <div id="content" style="display:none">
      <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµØ¯ÙŠØ± -->
      <div class="grid grid-2">
        <div class="card">
          <div class="muted" id="lblSearch">Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯â€¦</div>
          <input id="searchInput" class="input" placeholder="FA_001" />
        </div>
        <div class="card" style="display:flex;gap:8px;align-items:end;flex-wrap:wrap">
          <button id="exportBtn" class="btn">â¤“ CSV</button>
          <button id="printBtn" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>
      </div>

      <!-- KPIs Ù…ØµÙ…ØªØ© ÙˆØ¨Ø£Ø­Ø¬Ø§Ù… Ø£ØµØºØ± -->
      <div class="grid grid-4" style="margin-top:10px">
        <div class="card kpi blue">
          <div class="title" id="kpiTotalLbl">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
          <div id="kpiTotal" class="n">â€”</div>
        </div>
        <div class="card kpi gold">
          <div class="title" id="kpiUsedLbl">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
          <div id="kpiUsed" class="n">â€”</div>
        </div>
        <div class="card kpi rose">
          <div class="title" id="kpiLeftLbl">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
          <div id="kpiLeft" class="n">â€”</div>
        </div>
        <div class="card kpi green">
          <div class="title" id="kpiRateLbl">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div>
          <div id="kpiRate" class="n">â€”%</div>
        </div>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ / Ø¨Ø·Ø§Ù‚Ø§Øª -->
      <div class="card" style="margin-top:10px">
        <div class="muted" id="recentLbl">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø­Ø§Øª (Ø¢Ø®Ø± 100)</div>
        <div id="printArea" style="max-height:60vh;overflow:auto;margin-top:6px">
          <table>
            <thead>
              <tr>
                <th id="thCode">Ø§Ù„ÙƒÙˆØ¯</th>
                <th id="thStatus">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th id="thTime">Ø§Ù„ÙˆÙ‚Øª</th>
              </tr>
            </thead>
            <tbody id="rowsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs (Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ===== i18n =====
    const STR = {
      en: { event:"Event", pass:"Password", enter:"Enter", badpass:"Wrong password", search:"Search codeâ€¦", export:"Export CSV", print:"Print", total:"Total", used:"Checked-in", left:"Remaining", rate:"Attendance", recent:"Recent scans (latest 100)", code:"Code", status:"Status", time:"Time" },
      ar: { event:"Ø§Ù„Ø­Ø¯Ø«", pass:"ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", enter:"Ø¯Ø®ÙˆÙ„", badpass:"ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©", search:"Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯â€¦", export:"ØªØµØ¯ÙŠØ± CSV", print:"Ø·Ø¨Ø§Ø¹Ø©", total:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", used:"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", left:"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ", rate:"Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±", recent:"Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø­Ø§Øª (Ø¢Ø®Ø± 100)", code:"Ø§Ù„ÙƒÙˆØ¯", status:"Ø§Ù„Ø­Ø§Ù„Ø©", time:"Ø§Ù„ÙˆÙ‚Øª" }
    };
    const $ = (s,root=document)=>root.querySelector(s);
    const state = { lang: localStorage.getItem('hs:dash:lang')||'ar' };

    function applyLang(){
      const L = STR[state.lang] || STR.en; const isAr = state.lang==='ar';
      document.documentElement.lang = state.lang; document.documentElement.dir = isAr?'rtl':'ltr';
      $('#langBtn').textContent = isAr? 'EN' : 'AR';
      $('#lblEvent').textContent = L.event; $('#lblPass').textContent = L.pass; $('#enterBtn').textContent = L.enter;
      $('#lblSearch').textContent = L.search;
      $('#kpiTotalLbl').textContent = L.total; $('#kpiUsedLbl').textContent = L.used; $('#kpiLeftLbl').textContent = L.left; $('#kpiRateLbl').textContent = L.rate;
      $('#recentLbl').textContent = L.recent; $('#thCode').textContent = L.code; $('#thStatus').textContent = L.status; $('#thTime').textContent = L.time;
      $('#exportBtn').textContent = (isAr? 'â¤“ ' : '') + L.export;
      $('#printBtn').textContent = 'ğŸ–¨ï¸ ' + L.print;
    }

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
      authDomain:"hormez-inv.firebaseapp.com",
      projectId:"hormez-inv",
      storageBucket:"hormez-inv.firebasestorage.app",
      messagingSenderId:"747519941805",
      appId:"1:747519941805:web:468fada2492700e9da3a24"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Ø¶Ø¹ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ÙÙ‚Ø·:
    const PAGE_EVENT = 'haddad';
    const PAGE_PASSWORD = '8888';
    const sessKey = ()=> `hs:dash:event:${PAGE_EVENT}`;

    function openContent(){
      $('#gate').style.display='none';
      $('#content').style.display='block';
      $('#logoutBtn').style.display='inline-block';
      $('#evNameTitle').textContent = PAGE_EVENT;
      startStream();
      setTimeout(()=>{ window.scrollTo({top:0,behavior:'smooth'}); }, 30);
    }

    function handleEnter(){
      const ev = ($('#eventInput').value||'').trim();
      const pw = ($('#passInput').value||'').trim();
      if(ev!==PAGE_EVENT){ $('#gateMsg').textContent = 'âŒ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ØºÙŠØ± ØµØ­ÙŠØ­ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©'; return; }
      if(PAGE_PASSWORD && pw!==PAGE_PASSWORD){ $('#gateMsg').textContent = STR[state.lang].badpass; return; }
      localStorage.setItem(sessKey(),'ok');
      openContent();
    }

    function tryAutoLogin(){
      const passParam = new URLSearchParams(location.search).get('pass');
      if(localStorage.getItem(sessKey())==='ok' || (PAGE_PASSWORD && passParam===PAGE_PASSWORD) || !PAGE_PASSWORD){
        $('#eventInput').value = PAGE_EVENT; openContent();
      }else{
        $('#eventInput').value = PAGE_EVENT;
      }
    }

    function logout(){ localStorage.removeItem(sessKey()); location.href = location.pathname; }
    window.logout = logout;

    let unsub=null; let allRows=[]; let filtRows=[];

    function startStream(){
      if(unsub) unsub();
      const ref = collection(db,'invites');
      const qEv = query(ref, where('EventName','==', PAGE_EVENT));
      unsub = onSnapshot(qEv, snap=>{
        let t=0,u=0; const rec=[];
        snap.forEach(d=>{
          const x=d.data();
          t++; if((x.Status||'').toLowerCase()==='yes') u++;
          if(x.scannedAt?.toDate?.()) rec.push({id:d.id,Code:x.Code||d.id,Status:x.Status||'no',scannedAt:x.scannedAt.toDate()});
        });
        renderKPIs(t,u);
        allRows = rec.sort((a,b)=>(b.scannedAt?.getTime?.()||0)-(a.scannedAt?.getTime?.()||0));
        applyFilters();
      });
    }

    function applyFilters(){
      const q = ($('#searchInput').value||'').trim().toLowerCase();
      let list = allRows;
      if(q) list = list.filter(r=> (r.Code||'').toLowerCase().includes(q));
      filtRows = list.slice(0,100);
      renderRows();
    }

    function renderKPIs(total, used){
      const left=Math.max(total-used,0);
      const rate= total>0? Math.round((used/total)*100):0;
      $('#kpiTotal').textContent=total;
      $('#kpiUsed').textContent=used;
      $('#kpiLeft').textContent=left;
      $('#kpiRate').textContent=rate+'%';
    }

    function renderRows(){
      const isAr = (state.lang==='ar');
      const tb=$('#rowsBody'); tb.innerHTML='';
      if(filtRows.length===0){
        const tr=document.createElement('tr');
        const td=document.createElement('td');
        td.colSpan=3; td.className='muted'; td.style.textAlign='center'; td.style.padding='14px';
        td.textContent=isAr?'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø­Ø§Øª':'No scans yet';
        tr.appendChild(td); tb.appendChild(tr); return;
      }
      for(const r of filtRows){
        const tr=document.createElement('tr');

        const td1=document.createElement('td');
        td1.setAttribute('data-label', isAr?'Ø§Ù„ÙƒÙˆØ¯':'Code');
        td1.className='mono'; td1.textContent=r.Code;
        tr.appendChild(td1);

        const td2=document.createElement('td');
        td2.setAttribute('data-label', isAr?'Ø§Ù„Ø­Ø§Ù„Ø©':'Status');
        const b=document.createElement('span'); const ok=(r.Status||'no').toLowerCase()==='yes';
        b.className='badge ' + (ok? 'ok':'no'); b.textContent= ok ? 'yes' : 'no';
        td2.appendChild(b);
        tr.appendChild(td2);

        const td3=document.createElement('td');
        td3.setAttribute('data-label', isAr?'Ø§Ù„ÙˆÙ‚Øª':'Time');
        td3.textContent= r.scannedAt ? r.scannedAt.toLocaleString(isAr?'ar-EG':'en-GB') : 'â€”';
        tr.appendChild(td3);

        tb.appendChild(tr);
      }
    }

    function exportCSV(){
      const L = STR[state.lang]||STR.en;
      const header=[L.code,L.status,'EventName',L.time].join(',');
      const lines = filtRows.map(r=> [r.Code, r.Status, PAGE_EVENT, r.scannedAt? new Date(r.scannedAt).toISOString():'' ].join(','));
      const csv=[header,...lines].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`hormez-${PAGE_EVENT}-scans.csv`; a.click();
      URL.revokeObjectURL(url);
    }

    function printTable(){ window.print(); }

    // Ø±Ø¨Ø· Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
    document.addEventListener('DOMContentLoaded', ()=>{
      $('#eventInput').value = PAGE_EVENT; $('#evNameTitle').textContent = PAGE_EVENT;
      applyLang(); tryAutoLogin();

      $('#langBtn').addEventListener('click', ()=>{
        state.lang = state.lang==='ar'?'en':'ar';
        localStorage.setItem('hs:dash:lang', state.lang);
        applyLang(); renderRows();
      });
      $('#refreshBtn').addEventListener('click', ()=> location.reload());
      $('#logoutBtn').addEventListener('click', logout);
      $('#enterBtn').addEventListener('click', handleEnter);
      $('#passInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); handleEnter(); } });

      $('#searchInput').addEventListener('input', applyFilters);
      $('#exportBtn').addEventListener('click', exportCSV);
      $('#printBtn').addEventListener('click', printTable);
    });
  </script>
</body>
</html>
