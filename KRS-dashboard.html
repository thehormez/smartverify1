<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Hormez — لوحة تحكم الحدث (مناسبة للجوال)</title>
  <style>
    :root{
      --bg:#0b1020; --ink:#e5e7eb; --muted:#94a3b8;
      --solid-blue:#1e40af; --solid-gold:#b48a18;
      --solid-rose:#be123c; --solid-green:#047857;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);
      color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .container{max-width:1000px;margin:0 auto;padding:12px}
    .topbar{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.88);
      backdrop-filter:blur(6px);border-bottom:1px solid #243047}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:32px;height:32px;border-radius:8px;background:#111;
      border:1px solid #333;display:grid;place-items:center}
    .logo span{font-weight:900;color:#ffd700;font-size:12px}
    .btn{border:1px solid #334155;background:#0b1220;color:var(--ink);
      border-radius:10px;padding:8px 12px;cursor:pointer;min-height:40px;font-size:14px}
    .btn:hover{background:#0d1528}.btn.block{width:100%}
    .input{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;
      background:#0b1220;color:var(--ink);min-height:40px;font-size:14px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
      border-radius:14px;padding:12px}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-4{grid-template-columns:repeat(4,1fr)}
    @media(max-width:900px){.grid-2{grid-template-columns:1fr}.grid-4{grid-template-columns:1fr 1fr}}
    @media(max-width:560px){.grid-4{grid-template-columns:1fr}.container{padding:10px}}
    .kpi{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .kpi .title{font-weight:800;font-size:13px}.kpi .n{font-size:22px;font-weight:900}
    .kpi.card{border:none;color:#fff}.kpi.card *{color:inherit!important}
    .kpi.card.blue{background:var(--solid-blue)}.kpi.card.gold{background:var(--solid-gold);color:#111}
    .kpi.card.rose{background:var(--solid-rose)}.kpi.card.green{background:var(--solid-green)}
    .muted{color:var(--muted);font-size:12px}.titlebar{font-weight:800;font-size:14px}
    .badge{padding:3px 6px;border-radius:10px;font-weight:700;font-size:12px}
    .badge.ok{background:rgba(22,163,74,.12);color:#86efac}
    .badge.no{background:rgba(220,38,38,.12);color:#fca5a5}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-top:1px solid rgba(255,255,255,.08)}
    thead th{background:#0e162c}
    .mono{font-family:ui-monospace,monospace}.error{color:#fda4af;font-size:12px}
    /* بطاقات على الجوال */
    @media(max-width:760px){
      table thead{display:none}table,tbody,tr,td{display:block;width:100%}
      tbody tr{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
        border-radius:12px;margin-bottom:8px}
      tbody td{display:flex;justify-content:space-between;gap:8px;
        border-bottom:1px solid rgba(255,255,255,.08);padding:10px}
      tbody td:last-child{border-bottom:none}
      tbody td::before{content:attr(data-label);color:#cbd5e1;font-weight:700;font-size:12px}
    }
    /* إصلاح قص القائمة */
    @media(max-width:760px){
      #printArea{max-height:none!important;overflow:visible!important;
        -webkit-overflow-scrolling:auto;padding-bottom:8px}
      #rowsBody td{word-break:break-word;white-space:normal}
      thead th{position:static!important}
    }
  </style>
</head>
<body>
<div class="topbar">
  <div class="container row" style="align-items:center">
    <div class="brand">
      <div class="logo"><span>HS</span></div>
      <div>
        <div class="muted">HORMEZ SECURITY</div>
        <div class="titlebar">لوحة تحكم الحدث — <span id="evNameTitle">—</span></div>
      </div>
    </div>
    <div style="margin-inline-start:auto" class="row">
      <button id="langBtn" class="btn">AR</button>
      <button id="refreshBtn" class="btn">↻</button>
      <button id="logoutBtn" class="btn" style="display:none">🚪 خروج</button>
    </div>
  </div>
</div>

<div class="container">
  <!-- شاشة الدخول -->
  <div class="card gate" id="gate">
    <div class="muted" style="margin-bottom:6px">ادخل اسم الحدث وكلمة المرور</div>
    <div class="grid" style="gap:8px">
      <div><div class="muted" id="lblEvent">الحدث</div>
        <input id="eventInput" class="input" placeholder="مثال: haddad" /></div>
      <div><div class="muted" id="lblPass">كلمة المرور</div>
        <input id="passInput" type="password" class="input" placeholder="••••" /></div>
      <button id="enterBtn" class="btn block">دخول</button>
    </div>
    <div id="gateMsg" class="error" style="margin-top:6px"></div>
  </div>

  <!-- المحتوى -->
  <div id="content" style="display:none">
    <div class="grid grid-2">
      <div class="card">
        <div class="muted" id="lblSearch">ابحث عن كود…</div>
        <input id="searchInput" class="input" placeholder="FA_001" />
      </div>
      <div class="card" style="display:flex;gap:8px;align-items:end;flex-wrap:wrap">
        <button id="exportBtn" class="btn">⤓ CSV</button>
        <button id="printBtn" class="btn">🖨️ طباعة</button>
      </div>
    </div>

    <div class="grid grid-4" style="margin-top:10px">
      <div class="card kpi blue"><div class="title" id="kpiTotalLbl">الإجمالي</div><div id="kpiTotal" class="n">—</div></div>
      <div class="card kpi gold"><div class="title" id="kpiUsedLbl">المستخدم</div><div id="kpiUsed" class="n">—</div></div>
      <div class="card kpi rose"><div class="title" id="kpiLeftLbl">المتبقي</div><div id="kpiLeft" class="n">—</div></div>
      <div class="card kpi green"><div class="title" id="kpiRateLbl">نسبة الحضور</div><div id="kpiRate" class="n">—%</div></div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="muted" id="recentLbl">أحدث المسحات (آخر 100)</div>
      <div id="printArea" style="margin-top:6px">
        <table>
          <thead><tr><th id="thCode">الكود</th><th id="thStatus">الحالة</th><th id="thTime">الوقت</th></tr></thead>
          <tbody id="rowsBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const STR={ar:{badpass:"كلمة المرور غير صحيحة"},en:{badpass:"Wrong password"}};
const $=(s,r=document)=>r.querySelector(s);const state={lang:'ar'};

const app=initializeApp({
  apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
  authDomain:"hormez-inv.firebaseapp.com",
  projectId:"hormez-inv",
  storageBucket:"hormez-inv.firebasestorage.app",
  messagingSenderId:"747519941805",
  appId:"1:747519941805:web:468fada2492700e9da3a24"
});
const db=getFirestore(app);
const PAGE_EVENT='haddad';const PAGE_PASSWORD='8888';
const sessKey=()=>`hs:dash:${PAGE_EVENT}`;

function openContent(){
  $('#gate').style.display='none';$('#content').style.display='block';
  $('#logoutBtn').style.display='inline-block';$('#evNameTitle').textContent=PAGE_EVENT;startStream();
}
function handleEnter(){
  const ev=$('#eventInput').value.trim(),pw=$('#passInput').value.trim();
  if(ev!==PAGE_EVENT)return $('#gateMsg').textContent='❌ اسم الحدث غير صحيح';
  if(pw!==PAGE_PASSWORD)return $('#gateMsg').textContent=STR[state.lang].badpass;
  localStorage.setItem(sessKey(),'ok');openContent();
}
function tryAutoLogin(){
  if(localStorage.getItem(sessKey())==='ok'){ $('#eventInput').value=PAGE_EVENT;openContent(); }
  else $('#eventInput').value=PAGE_EVENT;
}
function logout(){localStorage.removeItem(sessKey());location.href=location.pathname;}
let unsub=null,allRows=[],filtRows=[];
function startStream(){
  if(unsub)unsub();
  const qEv=query(collection(db,'invites'),where('EventName','==',PAGE_EVENT));
  unsub=onSnapshot(qEv,snap=>{
    let t=0,u=0;const rec=[];
    snap.forEach(d=>{
      const x=d.data();t++;if((x.Status||'').toLowerCase()==='yes')u++;
      if(x.scannedAt?.toDate?.())rec.push({Code:x.Code||d.id,Status:x.Status||'no',scannedAt:x.scannedAt.toDate()});
    });
    renderKPIs(t,u);allRows=rec.sort((a,b)=>b.scannedAt-b.scannedAt);applyFilters();
  });
}
function applyFilters(){
  const q=$('#searchInput').value.trim().toLowerCase();
  let list=allRows;if(q)list=list.filter(r=>(r.Code||'').toLowerCase().includes(q));
  filtRows=list.slice(0,100);renderRows();
}
function renderKPIs(t,u){const l=Math.max(t-u,0),r=t>0?Math.round((u/t)*100):0;
  $('#kpiTotal').textContent=t;$('#kpiUsed').textContent=u;
  $('#kpiLeft').textContent=l;$('#kpiRate').textContent=r+'%';
}
function renderRows(){
  const tb=$('#rowsBody');tb.innerHTML='';
  if(filtRows.length===0){const tr=document.createElement('tr'),td=document.createElement('td');
    td.colSpan=3;td.className='muted';td.style.textAlign='center';td.textContent='لا توجد مسحات';
    tr.appendChild(td);tb.appendChild(tr);return;}
  for(const r of filtRows){
    const tr=document.createElement('tr');
    const td1=document.createElement('td');td1.setAttribute('data-label','الكود');td1.className='mono';td1.textContent=r.Code;
    const td2=document.createElement('td');td2.setAttribute('data-label','الحالة');
    const b=document.createElement('span');b.className='badge '+((r.Status||'no').toLowerCase()==='yes'?'ok':'no');
    b.textContent=(r.Status||'no');td2.appendChild(b);
    const td3=document.createElement('td');td3.setAttribute('data-label','الوقت');
    td3.textContent=r.scannedAt?r.scannedAt.toLocaleString('ar-EG'):'—';
    tr.append(td1,td2,td3);tb.appendChild(tr);
  }
}
function exportCSV(){
  const lines=filtRows.map(r=>[r.Code,r.Status,PAGE_EVENT,r.scannedAt.toISOString()].join(','));
  const csv=['Code,Status,EventName,Time',...lines].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`${PAGE_EVENT}-scans.csv`;a.click();URL.revokeObjectURL(url);
}
document.addEventListener('DOMContentLoaded',()=>{
  $('#eventInput').value=PAGE_EVENT;tryAutoLogin();
  $('#enterBtn').onclick=handleEnter;$('#logoutBtn').onclick=logout;
  $('#refreshBtn').onclick=()=>location.reload();
  $('#searchInput').oninput=applyFilters;$('#exportBtn').onclick=exportCSV;
});
</script>
</body>
</html>
