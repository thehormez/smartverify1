<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Hormez â€” Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø­Ø¯Ø« (Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¬ÙˆØ§Ù„)</title>
  <style>
    :root{
      --bg:#0b1020; --ink:#e5e7eb; --muted:#94a3b8;
      --solid-blue:#1e40af; --solid-gold:#b48a18;
      --solid-rose:#be123c; --solid-green:#047857;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);
      color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .container{max-width:1000px;margin:0 auto;padding:12px}
    .topbar{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.88);
      backdrop-filter:blur(6px);border-bottom:1px solid #243047}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:32px;height:32px;border-radius:8px;background:#111;border:1px solid #333;display:grid;place-items:center}
    .logo span{font-weight:900;color:#ffd700;font-size:12px}
    .btn{border:1px solid #334155;background:#0b1220;color:var(--ink);
      border-radius:10px;padding:8px 12px;cursor:pointer;min-height:40px;font-size:14px}
    .btn:hover{background:#0d1528}.btn.block{width:100%}
    .input{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;
      background:#0b1220;color:var(--ink);min-height:40px;font-size:14px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
      border-radius:14px;padding:12px}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-4{grid-template-columns:repeat(4,1fr)}
    @media(max-width:900px){.grid-2{grid-template-columns:1fr}.grid-4{grid-template-columns:1fr 1fr}}
    @media(max-width:560px){.grid-4{grid-template-columns:1fr}.container{padding:10px}}
    .kpi{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .kpi .title{font-weight:800;font-size:13px}.kpi .n{font-size:22px;font-weight:900}
    .kpi.card{border:none;color:#fff}.kpi.card *{color:inherit!important}
    .kpi.card.blue{background:var(--solid-blue)}.kpi.card.gold{background:var(--solid-gold);color:#111}
    .kpi.card.rose{background:var(--solid-rose)}.kpi.card.green{background:var(--solid-green)}
    .muted{color:var(--muted);font-size:12px}.titlebar{font-weight:800;font-size:14px}
    .badge{padding:3px 6px;border-radius:10px;font-weight:700;font-size:12px}
    .badge.ok{background:rgba(22,163,74,.12);color:#86efac}
    .badge.no{background:rgba(220,38,38,.12);color:#fca5a5}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-top:1px solid rgba(255,255,255,.08)}
    thead th{background:#0e162c}
    .mono{font-family:ui-monospace,monospace}.error{color:#fda4af;font-size:12px}

    /* ===== Ø¹Ø±Ø¶ÙŠÙ† Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©: Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ + Ø¨Ø·Ø§Ù‚Ø§Øª Ø¹Ù…ÙˆØ¯ÙŠØ© Ù„Ù„Ø¬ÙˆØ§Ù„ ===== */
    #desktopTableWrap{display:block}
    #mobileList{display:none}

    @media(max-width:760px){
      #desktopTableWrap{display:none}
      #mobileList{display:block}
      .scan-card{
        background:rgba(255,255,255,.04);
        border:1px solid rgba(255,255,255,.08);
        border-radius:12px;
        padding:10px; margin-bottom:8px
      }
      .scan-line{display:flex;justify-content:space-between;gap:10px;margin:6px 0}
      .scan-label{color:#cbd5e1;font-weight:700;font-size:12px}
      .scan-value{font-size:14px}
      .scan-value.mono{font-family:ui-monospace,monospace}
    }
  </style>
</head>
<body>
<div class="topbar">
  <div class="container row" style="align-items:center">
    <div class="brand">
      <div class="logo"><span>KRS</span></div>
      <div>
        <div class="muted" id="hdrOrg">HORMEZ SECURITY</div>
        <div class="titlebar"><span id="hdrTitlePrefix">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø­Ø¯Ø« â€” </span><span id="evNameTitle">â€”</span></div>
      </div>
    </div>
    <div style="margin-inline-start:auto" class="row">
      <button id="langBtn" class="btn">AR</button>
      <button id="refreshBtn" class="btn">â†»</button>
      <button id="logoutBtn" class="btn" style="display:none">ğŸšª <span id="logoutTxt">Ø®Ø±ÙˆØ¬</span></button>
    </div>
  </div>
</div>

<div class="container">
  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div class="card gate" id="gate">
    <div class="muted" id="gateHint" style="margin-bottom:6px">Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
    <div class="grid" style="gap:8px">
      <div><div class="muted" id="lblEvent">Ø§Ù„Ø­Ø¯Ø«</div>
        <input id="eventInput" class="input" placeholder="Ù…Ø«Ø§Ù„: haddad" /></div>
      <div><div class="muted" id="lblPass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
        <input id="passInput" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢" /></div>
      <button id="enterBtn" class="btn block">Ø¯Ø®ÙˆÙ„</button>
    </div>
    <div id="gateMsg" class="error" style="margin-top:6px"></div>
  </div>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
  <div id="content" style="display:none">
    <div class="grid grid-2">
      <div class="card">
        <div class="muted" id="lblSearch">Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯â€¦</div>
        <input id="searchInput" class="input" placeholder="FA_001" />
      </div>
      <div class="card" style="display:flex;gap:8px;align-items:end;flex-wrap:wrap">
        <button id="exportBtn" class="btn">â¤“ CSV</button>
        <button id="printBtn" class="btn">ğŸ–¨ï¸ <span id="printTxt">Ø·Ø¨Ø§Ø¹Ø©</span></button>
      </div>
    </div>

    <div class="grid grid-4" style="margin-top:10px">
      <div class="card kpi blue"><div class="title" id="kpiTotalLbl">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div><div id="kpiTotal" class="n">â€”</div></div>
      <div class="card kpi gold"><div class="title" id="kpiUsedLbl">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div><div id="kpiUsed" class="n">â€”</div></div>
      <div class="card kpi rose"><div class="title" id="kpiLeftLbl">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div><div id="kpiLeft" class="n">â€”</div></div>
      <div class="card kpi green"><div class="title" id="kpiRateLbl">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div><div id="kpiRate" class="n">â€”%</div></div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="muted" id="recentLbl">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø­Ø§Øª (Ø¢Ø®Ø± 100)</div>

      <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨: Ø¬Ø¯ÙˆÙ„ -->
      <div id="desktopTableWrap" style="margin-top:6px">
        <table>
          <thead>
            <tr>
              <th id="thCode">Ø§Ù„ÙƒÙˆØ¯</th>
              <th id="thStatus">Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th id="thTime">Ø§Ù„ÙˆÙ‚Øª</th>
            </tr>
          </thead>
          <tbody id="rowsBody"></tbody>
        </table>
      </div>

      <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø¬ÙˆØ§Ù„: Ø¨Ø·Ø§Ù‚Ø§Øª Ø¹Ù…ÙˆØ¯ÙŠØ© -->
      <div id="mobileList" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

/* ===================== i18n ===================== */
const STR={
  ar:{
    org:"KRS INVIT",
    titlePrefix:"Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø­Ø¯Ø« â€” ",
    gateHint:"Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
    event:"Ø§Ù„Ø­Ø¯Ø«", pass:"ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", enter:"Ø¯Ø®ÙˆÙ„", logout:"Ø®Ø±ÙˆØ¬",
    badpass:"ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©", badname:"âŒ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ØºÙŠØ± ØµØ­ÙŠØ­",
    search:"Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯â€¦", export:"ØªØµØ¯ÙŠØ± CSV", print:"Ø·Ø¨Ø§Ø¹Ø©",
    total:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", used:"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", left:"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ", rate:"Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±",
    recent:"Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø­Ø§Øª (Ø¢Ø®Ø± 100)",
    code:"Ø§Ù„ÙƒÙˆØ¯", status:"Ø§Ù„Ø­Ø§Ù„Ø©", time:"Ø§Ù„ÙˆÙ‚Øª",
    yes:"Ù†Ø¹Ù…", no:"Ù„Ø§", noRows:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø­Ø§Øª"
  },
  en:{
    org:"KRS INVITE",
    titlePrefix:"Event Dashboard â€” ",
    gateHint:"Enter event name and password",
    event:"Event", pass:"Password", enter:"Enter", logout:"Logout",
    badpass:"Wrong password", badname:"âŒ Wrong event name",
    search:"Search codeâ€¦", export:"Export CSV", print:"Print",
    total:"Total", used:"Checked-in", left:"Remaining", rate:"Attendance",
    recent:"Recent scans (latest 100)",
    code:"Code", status:"Status", time:"Time",
    yes:"Yes", no:"No", noRows:"No scans yet"
  }
};
const $=(s,r=document)=>r.querySelector(s);
const state={ lang: localStorage.getItem('hs:dash:lang')||'ar' };

function applyLang(){
  const L=STR[state.lang];
  const isAr=state.lang==='ar';
  document.documentElement.lang=state.lang;
  document.documentElement.dir=isAr?'rtl':'ltr';

  // Top bar
  $('#hdrOrg').textContent=L.org;
  $('#hdrTitlePrefix').textContent=L.titlePrefix;
  $('#langBtn').textContent=isAr?'EN':'AR';
  $('#logoutTxt').textContent=L.logout;

  // Gate
  $('#gateHint').textContent=L.gateHint;
  $('#lblEvent').textContent=L.event;
  $('#lblPass').textContent=L.pass;
  $('#enterBtn').textContent=L.enter;

  // Filters
  $('#lblSearch').textContent=L.search;
  $('#exportBtn').textContent=(isAr?'â¤“ ':'â¤“ ')+L.export;
  $('#printTxt').textContent=L.print;

  // KPI labels
  $('#kpiTotalLbl').textContent=L.total;
  $('#kpiUsedLbl').textContent=L.used;
  $('#kpiLeftLbl').textContent=L.left;
  $('#kpiRateLbl').textContent=L.rate;

  // Table headers
  $('#recentLbl').textContent=L.recent;
  $('#thCode').textContent=L.code;
  $('#thStatus').textContent=L.status;
  $('#thTime').textContent=L.time;

  // Placeholders
  $('#searchInput').placeholder = (isAr?'Ù…Ø«Ø§Ù„: ':'e.g. ') + 'FA_001';
}

/* ===================== Firebase ===================== */
const app=initializeApp({
  apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
  authDomain:"hormez-inv.firebaseapp.com",
  projectId:"hormez-inv",
  storageBucket:"hormez-inv.firebasestorage.app",
  messagingSenderId:"747519941805",
  appId:"1:747519941805:web:468fada2492700e9da3a24"
});
const db=getFirestore(app);

// Ø¶Ø¹ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ÙÙ‚Ø·:
const PAGE_EVENT='Ø²ÙØ§Ù Ø³Ø¹ÙŠØ¯';
const PAGE_PASSWORD='123456';
const sessKey=()=>`hs:dash:${PAGE_EVENT}`;

/* ===================== Gate ===================== */
function openContent(){
  $('#gate').style.display='none';
  $('#content').style.display='block';
  $('#logoutBtn').style.display='inline-block';
  $('#evNameTitle').textContent=PAGE_EVENT;
  startStream();
}
function handleEnter(){
  const ev=$('#eventInput').value.trim();
  const pw=$('#passInput').value.trim();
  if(ev!==PAGE_EVENT){ $('#gateMsg').textContent=STR[state.lang].badname; return; }
  if(pw!==PAGE_PASSWORD){ $('#gateMsg').textContent=STR[state.lang].badpass; return; }
  localStorage.setItem(sessKey(),'ok'); openContent();
}
function tryAutoLogin(){
  if(localStorage.getItem(sessKey())==='ok'){
    $('#eventInput').value=PAGE_EVENT; openContent();
  }else{
    $('#eventInput').value=PAGE_EVENT;
  }
}
function logout(){ localStorage.removeItem(sessKey()); location.href=location.pathname; }

/* ===================== Data & Render ===================== */
let unsub=null, allRows=[], filtRows=[];

function startStream(){
  if(unsub) unsub();
  const qEv=query(collection(db,'invites'), where('EventName','==',PAGE_EVENT));
  unsub=onSnapshot(qEv, snap=>{
    let t=0, u=0; const rec=[];
    snap.forEach(d=>{
      const x=d.data(); t++; if((x.Status||'').toLowerCase()==='yes') u++;
      if(x.scannedAt?.toDate?.()){
        rec.push({ Code:x.Code||d.id, Status:String(x.Status||'no'), scannedAt:x.scannedAt.toDate() });
      }
    });
    renderKPIs(t,u);
    allRows = rec.sort((a,b)=> b.scannedAt - a.scannedAt);
    applyFilters();
  });
}

function applyFilters(){
  const q = ($('#searchInput').value||'').trim().toLowerCase();
  let list = allRows;
  if(q) list = list.filter(r => (r.Code||'').toLowerCase().includes(q));
  filtRows = list.slice(0,100);
  renderRows();
}

function renderKPIs(total, used){
  const left=Math.max(total-used,0);
  const rate= total>0? Math.round((used/total)*100):0;
  $('#kpiTotal').textContent=total;
  $('#kpiUsed').textContent=used;
  $('#kpiLeft').textContent=left;
  $('#kpiRate').textContent=rate+'%';
}

function renderRows(){
  const L=STR[state.lang];

  // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨
  const tb=$('#rowsBody'); tb.innerHTML='';
  if(filtRows.length===0){
    const tr=document.createElement('tr');
    const td=document.createElement('td');
    td.colSpan=3; td.className='muted'; td.style.textAlign='center'; td.textContent=L.noRows;
    tr.appendChild(td); tb.appendChild(tr);
  }else{
    for(const r of filtRows){
      const tr=document.createElement('tr');

      const td1=document.createElement('td');
      td1.textContent=r.Code; td1.className='mono';
      const td2=document.createElement('td');
      const b=document.createElement('span');
      const ok=(r.Status||'no').toLowerCase()==='yes';
      b.className='badge ' + (ok? 'ok':'no');
      b.textContent = ok ? L.yes : L.no;
      td2.appendChild(b);
      const td3=document.createElement('td');
      td3.textContent = r.scannedAt ? r.scannedAt.toLocaleString(state.lang==='ar'?'ar-EG':'en-GB') : 'â€”';

      tr.append(td1,td2,td3); tb.appendChild(tr);
    }
  }

  // Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ (Ø¹Ù…ÙˆØ¯ÙŠØ©)
  const listBox = $('#mobileList'); listBox.innerHTML='';
  if(filtRows.length===0){
    const empty=document.createElement('div');
    empty.className='muted';
    empty.style.textAlign='center';
    empty.textContent=L.noRows;
    listBox.appendChild(empty);
  }else{
    for(const r of filtRows){
      const card=document.createElement('div'); card.className='scan-card';

      const line1=document.createElement('div'); line1.className='scan-line';
      const l1=document.createElement('div'); l1.className='scan-label'; l1.textContent=L.code;
      const v1=document.createElement('div'); v1.className='scan-value mono'; v1.textContent=r.Code;
      line1.append(l1,v1);

      const line2=document.createElement('div'); line2.className='scan-line';
      const l2=document.createElement('div'); l2.className='scan-label'; l2.textContent=L.status;
      const v2=document.createElement('div'); v2.className='scan-value';
      const ok=(r.Status||'no').toLowerCase()==='yes';
      v2.textContent = ok ? L.yes : L.no;
      line2.append(l2,v2);

      const line3=document.createElement('div'); line3.className='scan-line';
      const l3=document.createElement('div'); l3.className='scan-label'; l3.textContent=L.time;
      const v3=document.createElement('div'); v3.className='scan-value';
      v3.textContent = r.scannedAt ? r.scannedAt.toLocaleString(state.lang==='ar'?'ar-EG':'en-GB') : 'â€”';
      line3.append(l3,v3);

      card.append(line1,line2,line3);
      listBox.appendChild(card);
    }
  }
}

function exportCSV(){
  const L=STR[state.lang];
  const header=[L.code,L.status,'EventName',L.time].join(',');
  const lines=filtRows.map(r=>[
    r.Code,
    ((r.Status||'no').toLowerCase()==='yes' ? L.yes : L.no),
    PAGE_EVENT,
    r.scannedAt ? r.scannedAt.toISOString() : ''
  ].join(','));
  const csv=[header,...lines].join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`${PAGE_EVENT}-scans.csv`; a.click(); URL.revokeObjectURL(url);
}

/* ===================== Wire UI ===================== */
document.addEventListener('DOMContentLoaded', ()=>{
  // Ù„ØºØ©/Ù†ØµÙˆØµ
  applyLang();

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©
  $('#eventInput').value=PAGE_EVENT;
  tryAutoLogin();

  // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ·
  $('#langBtn').addEventListener('click', ()=>{
    state.lang = (state.lang==='ar') ? 'en' : 'ar';
    localStorage.setItem('hs:dash:lang', state.lang);
    applyLang();
    renderRows();
  });
  $('#refreshBtn').addEventListener('click', ()=> location.reload());
  $('#logoutBtn').addEventListener('click', logout);

  // Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©
  $('#enterBtn').addEventListener('click', handleEnter);
  $('#passInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); handleEnter(); } });

  // Ø§Ù„Ø¨Ø­Ø«/ØªØµØ¯ÙŠØ±/Ø·Ø¨Ø§Ø¹Ø©
  $('#searchInput').addEventListener('input', applyFilters);
  $('#exportBtn').addEventListener('click', exportCSV);
  $('#printBtn').addEventListener('click', ()=>window.print());
});
</script>
</body>
</html>
