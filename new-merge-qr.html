<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez — دمج الباركود مع كرت الدعوة (Drag & Drop)</title>
  <style>
    :root{--bg:#0b1020;--ink:#e5e7eb;--muted:#94a3b8;--line:#334155}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:12px}
    @media(min-width:980px){.grid-2{grid-template-columns:360px 1fr}}
    .card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--line);background:#0b1220;color:var(--ink);border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .input,.select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
    label{font-size:12px;color:var(--muted)}
    #preview{width:100%;background:#0b1220;border-radius:12px;display:block;max-height:75vh;cursor:grab;touch-action:none}
    #preview.dragging{cursor:grabbing}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <div class="row" style="align-items:center;margin-bottom:8px">
      <div style="font-weight:800">🧩 دمج الباركود مع كرت الدعوة — سحب لتحديد الموضع</div>
      <button id="langBtn" class="btn" style="margin-inline-start:auto">AR</button>
    </div>

    <div class="grid grid-2">
      <!-- Controls -->
      <div class="card">
        <div class="row">
          <div style="flex:1">
            <label id="lblTemplate">ملف الكرت (PNG/JPG)</label>
            <input id="templateFile" type="file" accept="image/png,image/jpeg" class="input" />
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label id="lblEvent">اسم الحدث (اختياري — Firestore)</label>
            <input id="eventName" class="input" placeholder="مثال: زفاف سعيد" />
          </div>
        </div>
        <hr style="border-color:rgba(255,255,255,.08)"/>
        <div class="row">
          <div style="flex:1">
            <label id="lblPrefix">بادئة الكود</label>
            <input id="codePrefix" class="input" value="SA_" />
          </div>
          <div style="width:90px">
            <label id="lblStart">بداية</label>
            <input id="startNum" type="number" class="input" value="1" />
          </div>
          <div style="width:110px">
            <label id="lblCount">عدد الأكواد</label>
            <input id="count" type="number" class="input" value="50" />
          </div>
          <div style="width:90px">
            <label id="lblPad">أرقام</label>
            <input id="pad" type="number" class="input" value="3" />
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label id="lblManualList">قائمة أكواد (اختياري — كل كود بسطر)</label>
            <textarea id="manualList" rows="5" class="input" placeholder="SA_001\nSA_002\nSA_003"></textarea>
          </div>
        </div>
        <div class="row">
          <button id="btnLoadFirestore" class="btn">جلب من Firestore</button>
          <button id="btnUseGenerated" class="btn">استخدام التسلسل</button>
        </div>
        <hr style="border-color:rgba(255,255,255,.08)"/>
        <div class="row">
          <div style="width:120px">
            <label id="lblQrSize">حجم QR</label>
            <input id="qrSize" type="number" class="input" value="300" />
          </div>
          <div style="width:120px">
            <label id="lblPosX">موضع X</label>
            <input id="posX" type="number" class="input" value="100" />
          </div>
          <div style="width:120px">
            <label id="lblPosY">موضع Y</label>
            <input id="posY" type="number" class="input" value="100" />
          </div>
        </div>
        <div class="row">
          <div style="width:120px">
            <label id="lblFont">حجم الخط</label>
            <input id="fontSize" type="number" class="input" value="36" />
          </div>
          <div style="width:160px">
            <label id="lblTextOffset">ازاحة النص (أسفل QR)</label>
            <input id="textOffset" type="number" class="input" value="20" />
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>لون الباركود</label>
            <input id="qrColor" type="color" class="input" value="#000000" />
          </div>
          <div style="flex:1">
            <label>لون الكتابة</label>
            <input id="textColor" type="color" class="input" value="#ffffff" />
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>لون الخلفية</label>
            <input id="bgColor" type="color" class="input" value="#ffffff" />
          </div>
        </div>
        <div class="row">
          <button id="btnTest" class="btn">تجربة على معاينة</button>
          <button id="btnDownload" class="btn">إنشاء و تنزيل ZIP</button>
        </div>
        <div class="muted" id="hint">اسحب مربع الـQR مباشرة فوق المعاينة لتحديد المكان (X/Y تتحدّث تلقائيًا). بالتصدير تُستخدم نفس القيم.</div>
      </div>

      <!-- Preview -->
      <div class="card">
        <canvas id="preview"></canvas>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    (function(){
      const $=(s,root=document)=>root.querySelector(s);
      let templateImg=null; let codes=[];

      function loadTemplate(file){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=URL.createObjectURL(file); }); }
      function pad(n,width){ const s=String(n); return s.length>=width?s:('0'.repeat(width-s.length)+s); }
      function genSeq(){ const prefix=$('#codePrefix').value||'SA_'; const start=parseInt($('#startNum').value||'1',10); const count=parseInt($('#count').value||'1',10); const p=parseInt($('#pad').value||'3',10); const arr=[]; for(let i=0;i<count;i++){ arr.push(prefix+pad(start+i,p)); } return arr; }

      // ===== Helpers for drag =====
      function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
      function getCanvasPoint(evt, canvas){ const rect=canvas.getBoundingClientRect(); const isTouch=evt.touches&&evt.touches.length; const clientX=isTouch? evt.touches[0].clientX : evt.clientX; const clientY=isTouch? evt.touches[0].clientY : evt.clientY; const x=(clientX-rect.left)*(canvas.width/rect.width); const y=(clientY-rect.top)*(canvas.height/rect.height); return {x,y}; }

      async function drawOneToCanvas(canvas, img, code, highlight=true){
        const ctx=canvas.getContext('2d'); const w=img.naturalWidth, h=img.naturalHeight;
        canvas.width=w; canvas.height=h; ctx.clearRect(0,0,w,h); ctx.drawImage(img,0,0,w,h);
        const size=parseInt($('#qrSize').value||'300',10); let x=parseInt($('#posX').value||'0',10); let y=parseInt($('#posY').value||'0',10);
        // clamp & reflect
        x = clamp(x, 0, Math.max(0,w-size)); y = clamp(y, 0, Math.max(0,h-size)); $('#posX').value=x; $('#posY').value=y;
        const qrColor=$('#qrColor').value||'#000000'; const textColor=$('#textColor').value||'#ffffff'; const bgColor=$('#bgColor').value||'#ffffff';
        // generate QR off-DOM
        const holder=document.createElement('div'); holder.style.position='fixed'; holder.style.left='-9999px'; document.body.appendChild(holder);
        new QRCode(holder,{text: code,width:size,height:size,colorDark:qrColor,colorLight:bgColor,correctLevel:QRCode.CorrectLevel.M});
        await new Promise(r=>setTimeout(r,16));
        const qrc=holder.querySelector('canvas'); if(qrc) ctx.drawImage(qrc,x,y,size,size);
        document.body.removeChild(holder);
        // text under QR
        const fontSize=parseInt($('#fontSize').value||'36',10); const toff=parseInt($('#textOffset').value||'20',10);
        ctx.fillStyle=textColor; ctx.font=`bold ${fontSize}px ui-monospace, Menlo, Consolas, 'Courier New', monospace`; ctx.textAlign='center'; ctx.textBaseline='top';
        ctx.fillText(code, x + size/2, y + size + toff);
        if(highlight){ ctx.save(); ctx.strokeStyle='rgba(255,255,255,.6)'; ctx.setLineDash([10,6]); ctx.lineWidth=2; ctx.strokeRect(x-2, y-2, size+4, size+4); ctx.restore(); }
      }

      async function doPreview(){ if(!templateImg){ alert('حمّل صورة الكرت أولاً'); return; } const sample=(codes[0]||genSeq()[0]); await drawOneToCanvas($('#preview'), templateImg, sample, true); }

      function dataURLToBlob(dataURL){ const parts=dataURL.split(','); const bstr=atob(parts[1]); let n=bstr.length; const u8=new Uint8Array(n); while(n--){ u8[n]=bstr.charCodeAt(n); } return new Blob([u8],{type:'image/png'}); }

      async function buildZip(){ if(!templateImg){ alert('حمّل صورة الكرت أولاً'); return; } if(!codes.length){ codes = genSeq(); }
        const zip=new JSZip(); const canvas=document.createElement('canvas'); const folder=zip.folder('cards');
        for(let i=0;i<codes.length;i++){
          const c=codes[i]; await drawOneToCanvas(canvas, templateImg, c, false); const url=canvas.toDataURL('image/png'); const blob=dataURLToBlob(url); folder.file(`${c}.png`, blob);
        }
        const content=await zip.generateAsync({type:'blob'}); saveAs(content, 'cards-with-qr.zip'); }

      // ===== Drag state & handlers =====
      const drag={active:false, dx:0, dy:0};
      function startDrag(evt){ if(!templateImg) return; const canvas=$('#preview'); const pt=getCanvasPoint(evt, canvas); const x=parseInt($('#posX').value||'0',10); const y=parseInt($('#posY').value||'0',10); drag.active=true; drag.dx=pt.x-x; drag.dy=pt.y-y; canvas.classList.add('dragging'); evt.preventDefault(); }
      function moveDrag(evt){ if(!drag.active) return; const canvas=$('#preview'); const pt=getCanvasPoint(evt, canvas); const size=parseInt($('#qrSize').value||'300',10); let nx=Math.round(pt.x-drag.dx); let ny=Math.round(pt.y-drag.dy); nx = clamp(nx, 0, Math.max(0, canvas.width - size)); ny = clamp(ny, 0, Math.max(0, canvas.height - size)); $('#posX').value=nx; $('#posY').value=ny; drawOneToCanvas(canvas, templateImg, (codes[0]||genSeq()[0]), true); evt.preventDefault(); }
      function endDrag(){ if(!drag.active) return; drag.active=false; $('#preview').classList.remove('dragging'); }

      // ===== Wire =====
      document.addEventListener('DOMContentLoaded', ()=>{
        $('#templateFile').addEventListener('change', async e=>{ const f=e.target.files?.[0]; if(f){ templateImg=await loadTemplate(f); await doPreview(); } });
        $('#btnUseGenerated').addEventListener('click', ()=>{ codes = genSeq(); alert(`${codes.length} codes ready`); doPreview(); });
        $('#btnTest').addEventListener('click', doPreview);
        $('#btnDownload').addEventListener('click', buildZip);
        // react to inputs
        ['qrSize','posX','posY','fontSize','textOffset','qrColor','textColor','bgColor'].forEach(id=>{
          const el=$('#'+id); if(el) el.addEventListener('input', ()=>{ if(templateImg) doPreview(); });
        });
        // drag listeners
        const c=$('#preview');
        c.addEventListener('mousedown', startDrag);
        c.addEventListener('mousemove', moveDrag);
        c.addEventListener('mouseup', endDrag);
        c.addEventListener('mouseleave', endDrag);
        c.addEventListener('touchstart', startDrag, {passive:false});
        c.addEventListener('touchmove', moveDrag, {passive:false});
        c.addEventListener('touchend', endDrag);
        c.addEventListener('touchcancel', endDrag);
      });
    })();
  </script>
</body>
</html>
