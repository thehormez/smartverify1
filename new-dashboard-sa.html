<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة التحكم — Hormez</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;background:#0b1020;color:#e5e7eb}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:16px;margin-bottom:16px}
    .btn{border:1px solid #334155;background:#0b1220;color:#e5e7eb;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:#0d1528}
    .input{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
    #loginScreen{text-align:center;margin-top:100px}
    #dashboard{display:none}
    .error{color:#f87171;margin-top:10px}
  </style>
</head>
<body>
  <div id="loginScreen" class="container">
    <div class="card">
      <h2>🔒 حماية لوحة التحكم</h2>
      <p>الرجاء إدخال كلمة المرور الخاصة بالحدث</p>
      <input type="password" id="passwordInput" class="input" placeholder="كلمة المرور"/>
      <button id="loginBtn" class="btn" style="margin-top:10px">دخول</button>
      <div id="errorMsg" class="error"></div>
    </div>
  </div>

  <div id="dashboard" class="container">
    <div class="card">
      <h2>📊 لوحة التحكم للحدث: <span id="eventNameTitle">—</span></h2>
      <button id="logoutBtn" class="btn" style="float:left">🚪 خروج</button>
    </div>
    <div class="card">
      <div id="stats">جاري التحميل...</div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig={ apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac", authDomain:"hormez-inv.firebaseapp.com", projectId:"hormez-inv" };
    if(!firebase.apps.length){firebase.initializeApp(firebaseConfig);} 
    const db=firebase.firestore();

    const loginScreen=document.getElementById('loginScreen');
    const dashboard=document.getElementById('dashboard');
    const errorMsg=document.getElementById('errorMsg');
    const eventNameTitle=document.getElementById('eventNameTitle');

    function getEventName(){
      const p=new URLSearchParams(location.search);
      return p.get('event')||'';
    }

    async function checkPassword(){
      const eventName=getEventName();
      const pwdEl=document.getElementById('passwordInput');
      const pwdRaw=pwdEl ? pwdEl.value : '';
      // Normalize: trim + convert Arabic-Indic digits to ASCII
      const mapDigits = {"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9"};
      const toAsciiDigits = (s)=> String(s||'').replace(/[٠١٢٣٤٥٦٧٨٩]/g, ch => mapDigits[ch]||ch);
      const clean = (s)=> toAsciiDigits(String(s||'').trim());
      const pwd = clean(pwdRaw);
      if(!eventName){errorMsg.textContent='⚠️ لم يتم تحديد الحدث في الرابط';return;}
      try{
        const ref=db.collection('events').doc(eventName.trim());
        const snap=await ref.get();
        if(!snap.exists){errorMsg.textContent='⚠️ الحدث غير موجود: '+eventName;return;}
        const data=snap.data()||{};
        const stored = clean((data.Password!==undefined?data.Password:(data.password!==undefined?data.password:data.pass))||'');
        if(!stored){ errorMsg.textContent='⚠️ لا توجد كلمة مرور محفوظة لهذا الحدث (حقل Password)'; return; }
        if(stored===pwd){ localStorage.setItem('hs:dashboard:auth:'+eventName,'ok'); openDashboard(eventName); }
        else { errorMsg.textContent='❌ كلمة المرور غير صحيحة'; }
      }catch(e){ errorMsg.textContent='❌ خطأ: '+e.message; }
    }
      try{
        const ref=db.collection('events').doc(eventName);
        const snap=await ref.get();
        if(!snap.exists){errorMsg.textContent='⚠️ الحدث غير موجود';return;}
        const data=snap.data();
        if(data.Password===pwd){
          localStorage.setItem('hs:dashboard:auth:'+eventName,'ok');
          openDashboard(eventName);
        } else {
          errorMsg.textContent='❌ كلمة المرور غير صحيحة';
        }
      }catch(e){errorMsg.textContent='❌ خطأ: '+e.message;}
    }

    function openDashboard(eventName){
      loginScreen.style.display='none';
      dashboard.style.display='block';
      eventNameTitle.textContent=eventName;
      loadStats(eventName);
    }

    function logout(){
      const ev=getEventName();
      localStorage.removeItem('hs:dashboard:auth:'+ev);
      location.reload();
    }

    async function loadStats(eventName){
      try{
        const snap=await db.collection('invites').where('EventName','==',eventName).get();
        let total=0, used=0;
        snap.forEach(doc=>{ total++; if((doc.data().Status||'').toLowerCase()==='yes'){used++;} });
        const remain=total-used;
        document.getElementById('stats').innerHTML=`
          <div>📨 عدد الدعوات: <b>${total}</b></div>
          <div>✅ المستخدمة: <b>${used}</b></div>
          <div>📭 المتبقية: <b>${remain}</b></div>
        `;
      }catch(e){
        document.getElementById('stats').textContent='❌ خطأ: '+e.message;
      }
    }

    document.getElementById('loginBtn').addEventListener('click',checkPassword);
    document.getElementById('logoutBtn').addEventListener('click',logout);

    // Auto check session
    window.addEventListener('DOMContentLoaded',()=>{
      const ev=getEventName();
      if(!ev){errorMsg.textContent='⚠️ أضف ?event=اسم_الحدث في الرابط';return;}
      const auth=localStorage.getItem('hs:dashboard:auth:'+ev);
      if(auth==='ok') openDashboard(ev);
    });
  </script>
</body>
</html>
