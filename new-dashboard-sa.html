<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Hormez</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;background:#0b1020;color:#e5e7eb}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:16px;margin-bottom:16px}
    .btn{border:1px solid #334155;background:#0b1220;color:#e5e7eb;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:#0d1528}
    .input{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
    #loginScreen{text-align:center;margin-top:100px}
    #dashboard{display:none}
    .error{color:#f87171;margin-top:10px}
  </style>
</head>
<body>
  <div id="loginScreen" class="container">
    <div class="card">
      <h2>ğŸ”’ Ø­Ù…Ø§ÙŠØ© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
      <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø­Ø¯Ø«</p>
      <input type="password" id="passwordInput" class="input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"/>
      <button id="loginBtn" class="btn" style="margin-top:10px">Ø¯Ø®ÙˆÙ„</button>
      <div id="errorMsg" class="error"></div>
    </div>
  </div>

  <div id="dashboard" class="container">
    <div class="card">
      <h2>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ø­Ø¯Ø«: <span id="eventNameTitle">â€”</span></h2>
      <button id="logoutBtn" class="btn" style="float:left">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>
    <div class="card">
      <div id="stats">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig={ apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac", authDomain:"hormez-inv.firebaseapp.com", projectId:"hormez-inv" };
    if(!firebase.apps.length){firebase.initializeApp(firebaseConfig);} 
    const db=firebase.firestore();

    const loginScreen=document.getElementById('loginScreen');
    const dashboard=document.getElementById('dashboard');
    const errorMsg=document.getElementById('errorMsg');
    const eventNameTitle=document.getElementById('eventNameTitle');

    function getEventName(){
      const p=new URLSearchParams(location.search);
      return p.get('event')||'';
    }

    async function checkPassword(){
      const eventName=getEventName();
      const pwdEl=document.getElementById('passwordInput');
      const pwdRaw=pwdEl ? pwdEl.value : '';
      // Normalize: trim + convert Arabic-Indic digits to ASCII
      const mapDigits = {"Ù ":"0","Ù¡":"1","Ù¢":"2","Ù£":"3","Ù¤":"4","Ù¥":"5","Ù¦":"6","Ù§":"7","Ù¨":"8","Ù©":"9"};
      const toAsciiDigits = (s)=> String(s||'').replace(/[Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©]/g, ch => mapDigits[ch]||ch);
      const clean = (s)=> toAsciiDigits(String(s||'').trim());
      const pwd = clean(pwdRaw);
      if(!eventName){errorMsg.textContent='âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·';return;}
      try{
        const ref=db.collection('events').doc(eventName.trim());
        const snap=await ref.get();
        if(!snap.exists){errorMsg.textContent='âš ï¸ Ø§Ù„Ø­Ø¯Ø« ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: '+eventName;return;}
        const data=snap.data()||{};
        const stored = clean((data.Password!==undefined?data.Password:(data.password!==undefined?data.password:data.pass))||'');
        if(!stored){ errorMsg.textContent='âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯Ø« (Ø­Ù‚Ù„ Password)'; return; }
        if(stored===pwd){ localStorage.setItem('hs:dashboard:auth:'+eventName,'ok'); openDashboard(eventName); }
        else { errorMsg.textContent='âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'; }
      }catch(e){ errorMsg.textContent='âŒ Ø®Ø·Ø£: '+e.message; }
    }
      try{
        const ref=db.collection('events').doc(eventName);
        const snap=await ref.get();
        if(!snap.exists){errorMsg.textContent='âš ï¸ Ø§Ù„Ø­Ø¯Ø« ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';return;}
        const data=snap.data();
        if(data.Password===pwd){
          localStorage.setItem('hs:dashboard:auth:'+eventName,'ok');
          openDashboard(eventName);
        } else {
          errorMsg.textContent='âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
        }
      }catch(e){errorMsg.textContent='âŒ Ø®Ø·Ø£: '+e.message;}
    }

    function openDashboard(eventName){
      loginScreen.style.display='none';
      dashboard.style.display='block';
      eventNameTitle.textContent=eventName;
      loadStats(eventName);
    }

    function logout(){
      const ev=getEventName();
      localStorage.removeItem('hs:dashboard:auth:'+ev);
      location.reload();
    }

    async function loadStats(eventName){
      try{
        const snap=await db.collection('invites').where('EventName','==',eventName).get();
        let total=0, used=0;
        snap.forEach(doc=>{ total++; if((doc.data().Status||'').toLowerCase()==='yes'){used++;} });
        const remain=total-used;
        document.getElementById('stats').innerHTML=`
          <div>ğŸ“¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª: <b>${total}</b></div>
          <div>âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©: <b>${used}</b></div>
          <div>ğŸ“­ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <b>${remain}</b></div>
        `;
      }catch(e){
        document.getElementById('stats').textContent='âŒ Ø®Ø·Ø£: '+e.message;
      }
    }

    document.getElementById('loginBtn').addEventListener('click',checkPassword);
    document.getElementById('logoutBtn').addEventListener('click',logout);

    // Auto check session
    window.addEventListener('DOMContentLoaded',()=>{
      const ev=getEventName();
      if(!ev){errorMsg.textContent='âš ï¸ Ø£Ø¶Ù ?event=Ø§Ø³Ù…_Ø§Ù„Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·';return;}
      const auth=localStorage.getItem('hs:dashboard:auth:'+ev);
      if(auth==='ok') openDashboard(ev);
    });
  </script>
</body>
</html>
