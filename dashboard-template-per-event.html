<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Ø­Ø¯Ø« Ù…Ø­Ø¯Ø¯</title>
  <style>
    :root{--bg:#0b1020;--ink:#e5e7eb;--mut:#9fb1c7;--line:#334155}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:16px;margin-bottom:16px}
    .btn{border:1px solid var(--line);background:#0b1220;color:var(--ink);border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:#0d1528}
    .input,.select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .kpi .box{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:14px}
    .kpi .n{font-size:26px;font-weight:900}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:start}
    th{color:var(--mut);font-size:12px;font-weight:600}
    .hidden{display:none}
    .error{color:#f87171}
  </style>
</head>
<body>
  <div class="container">
    <div class="row" style="align-items:center">
      <div style="font-weight:800">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” <span id="evTitle">â€”</span></div>
      <div style="margin-inline-start:auto" class="row">
        <button id="logoutBtn" class="btn hidden">ğŸšª Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø­Ø¯Ø« Ù†ÙØ³Ù‡ (Ù…Ø­Ù„ÙŠØ©) -->
    <div id="gate" class="card">
      <div style="font-weight:700;margin-bottom:6px">ğŸ”’ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø­Ø¯Ø«</div>
      <div class="row">
        <div style="flex:1;min-width:260px">
          <div class="input" style="background:#0b1220;opacity:.7" id="evNameBox"></div>
        </div>
        <div style="flex:1;min-width:260px">
          <input id="passInput" class="input" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
        </div>
        <div style="display:flex;align-items:flex-end">
          <button id="enterBtn" class="btn" style="height:42px">Ø¯Ø®ÙˆÙ„</button>
        </div>
      </div>
      <div id="gateMsg" class="error" style="margin-top:8px"></div>
      <div class="row" style="margin-top:8px">
        <div class="input" style="opacity:.6">ØªÙ„Ù…ÙŠØ­: ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ…Ø±ÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡ÙƒØ°Ø§: <span id="hintUrl" style="font-family:ui-monospace"></span></div>
      </div>
    </div>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <div id="dash" class="hidden">
      <div class="card">
        <div class="row" style="align-items:center">
          <div class="kpi" style="flex:1">
            <div class="box"><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</div><div class="n" id="kTotal">0</div></div>
            <div class="box"><div>ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„</div><div class="n" id="kYes">0</div></div>
            <div class="box"><div>Ù„Ù… ÙŠØ¯Ø®Ù„</div><div class="n" id="kNo">0</div></div>
          </div>
          <div class="row" style="margin-inline-start:auto;min-width:260px">
            <select id="filterSel" class="select">
              <option value="all">Ø§Ù„ÙƒÙ„</option>
              <option value="yes">ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ (yes)</option>
              <option value="no">Ù„Ù… ÙŠØ¯Ø®Ù„ (no)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <table id="codesTbl">
          <thead>
            <tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th></tr>
          </thead>
          <tbody id="codesBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    // ========= ØªÙ‡ÙŠØ¦Ø© Ø«Ø§Ø¨ØªØ© Ù„ÙƒÙ„ Ø­Ø¯Ø« =========
    // Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø³Ø·Ø±ÙŠÙ† Ø§Ù„ØªØ§Ù„ÙŠÙŠÙ† Ù„ÙƒÙ„ ØµÙØ­Ø© Ø­Ø¯Ø«
    const EVENT_NAME = 'Ø²ÙØ§Ù Ø³Ø¹ÙŠØ¯';   // â† Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©
    const EVENT_PASSWORD = '';     // â† Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø­Ø¯Ø«
    // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ±Ùƒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙØ§Ø±ØºÙ‹Ø§ '' ÙŠØ¬Ø¹Ù„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¯ÙˆÙ† Ø­Ù…Ø§ÙŠØ©

    // ========= Firebase =========
    const firebaseConfig={ apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac", authDomain:"hormez-inv.firebaseapp.com", projectId:"hormez-inv" };
    if(!firebase.apps.length){firebase.initializeApp(firebaseConfig);} 
    const db=firebase.firestore();

    // ========= Ø¹Ù†Ø§ØµØ± DOM =========
    const gate=document.getElementById('gate');
    const dash=document.getElementById('dash');
    const evTitle=document.getElementById('evTitle');
    const evNameBox=document.getElementById('evNameBox');
    const passInput=document.getElementById('passInput');
    const enterBtn=document.getElementById('enterBtn');
    const gateMsg=document.getElementById('gateMsg');
    const hintUrl=document.getElementById('hintUrl');
    const logoutBtn=document.getElementById('logoutBtn');

    const kTotal=document.getElementById('kTotal');
    const kYes=document.getElementById('kYes');
    const kNo=document.getElementById('kNo');
    const filterSel=document.getElementById('filterSel');
    const codesBody=document.getElementById('codesBody');

    // ========= Helpers =========
    const mapDigits={"Ù ":"0","Ù¡":"1","Ù¢":"2","Ù£":"3","Ù¤":"4","Ù¥":"5","Ù¦":"6","Ù§":"7","Ù¨":"8","Ù©":"9"};
    const toAsciiDigits=s=>String(s||'').replace(/[Ù -Ù©]/g,ch=>mapDigits[ch]||ch);
    const clean=s=>toAsciiDigits(String(s||'').replace(/\u00A0/g,' ').trim());
    const sessKey=()=>`hs:dash:event:${EVENT_NAME}`;

    function tsToStr(ts){ try{ const d=ts?.toDate? ts.toDate() : (ts instanceof Date? ts : null); return d? d.toLocaleString('ar-EG') : 'â€”'; }catch{return 'â€”'} }

    function renderRows(list){
      codesBody.innerHTML='';
      const f=filterSel.value;
      list.forEach(x=>{
        if(f!=='all' && (String(x.Status||'').toLowerCase()!==f)) return;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td style="font-family:ui-monospace">${x.Code}</td><td>${x.Status||'no'}</td><td style="color:#9fb1c7">${tsToStr(x.updatedAt||x.scannedAt)}</td>`;
        codesBody.appendChild(tr);
      });
    }

    // ========= Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ =========
    function openDash(){ gate.classList.add('hidden'); dash.classList.remove('hidden'); logoutBtn.classList.remove('hidden'); startLive(); }

    function tryAutoLogin(){
      const url=new URL(location.href);
      const passParam=clean(url.searchParams.get('pass'));
      if((EVENT_PASSWORD && passParam && passParam===clean(EVENT_PASSWORD)) || localStorage.getItem(sessKey())==='ok' || !EVENT_PASSWORD){
        openDash();
      }
    }

    function handleEnter(){
      const v=clean(passInput.value);
      if(!EVENT_PASSWORD){ openDash(); return; }
      if(v===clean(EVENT_PASSWORD)){
        localStorage.setItem(sessKey(),'ok');
        openDash();
      }else{
        gateMsg.textContent='âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
      }
    }

    function logout(){ localStorage.removeItem(sessKey()); location.href=location.pathname; }

    // ========= Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± =========
    let unsub=null;
    function startLive(){
      evTitle.textContent=EVENT_NAME; evNameBox.textContent=EVENT_NAME; hintUrl.textContent=`?pass=ÙƒÙ„Ù…Ø©-Ø§Ù„Ù…Ø±ÙˆØ±`;
      if(unsub) try{unsub();}catch{}
      const q=db.collection('invites').where('EventName','==',EVENT_NAME);
      unsub=q.onSnapshot(snap=>{
        const arr=[]; let total=0, yes=0, no=0;
        snap.forEach(doc=>{ const d=doc.data(); total++; const st=String(d.Status||'no').toLowerCase(); if(st==='yes') yes++; else no++; arr.push({Code:d.Code, Status:st, updatedAt:d.updatedAt, scannedAt:d.scannedAt}); });
        kTotal.textContent=total; kYes.textContent=yes; kNo.textContent=no;
        arr.sort((a,b)=>a.Code.localeCompare(b.Code));
        renderRows(arr);
      }, err=>{ gateMsg.textContent='âš ï¸ Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: '+err.message; });
    }

    // ========= Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« =========
    enterBtn.addEventListener('click', handleEnter);
    passInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); handleEnter(); } });
    logoutBtn.addEventListener('click', logout);
    filterSel.addEventListener('change', ()=>{
      const rows=[...codesBody.querySelectorAll('tr')].map(tr=>({
        Code: tr.children[0].textContent,
        Status: tr.children[1].textContent.toLowerCase(),
        updatedAt: null
      }));
      renderRows(rows);
    });

    // ========= Ø¥Ù‚Ù„Ø§Ø¹ =========
    window.addEventListener('DOMContentLoaded',()=>{
      evTitle.textContent=EVENT_NAME; evNameBox.textContent=EVENT_NAME; hintUrl.textContent=`?pass=ÙƒÙ„Ù…Ø©-Ø§Ù„Ù…Ø±ÙˆØ±`;
      tryAutoLogin();
    });
  </script>
</body>
</html>
