<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upload KH Invites</title>
  <style>
    body { font-family: Tahoma, Arial, sans-serif; background:#111; color:#ffd700; text-align:center; padding:24px; }
    .btn { background:#ffd700; color:#000; border:none; border-radius:10px; padding:10px 18px; font-weight:bold; cursor:pointer; }
    .muted { color:#ccc; font-size:14px; margin-top:8px; }
    .log { margin:18px auto; max-width:720px; text-align:start; background:#1e1e1e; color:#eaeaea; padding:12px 14px; border-radius:10px; line-height:1.6; direction:ltr; }
    progress { width: 320px; height: 12px; border-radius: 6px; margin-top: 10px; }
  </style>

  <!-- Firebase SDK (Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ضع إعدادات مشروعك (كما زودتني بها سابقاً)
    const firebaseConfig = {
      apiKey: "AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
      authDomain: "hormez-inv.firebaseapp.com",
      projectId: "hormez-inv",
      storageBucket: "hormez-inv.appspot.com",
      messagingSenderId: "747519941805",
      appId: "1:747519941805:web:468fada2492700e9da3a24"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // مولد الأكواد KH_001 → KH_020
    function generateCodes(n = 20) {
      const arr = [];
      for (let i = 1; i <= n; i++) arr.push(`KH_${String(i).padStart(3, "0")}`);
      return arr;
    }

    async function codeExists(code) {
      const q = query(collection(db, "invites"), where("code", "==", code));
      const snap = await getDocs(q);
      return !snap.empty;
    }

    async function uploadInvites() {
      const log  = document.getElementById("log");
      const bar  = document.getElementById("bar");
      const btn  = document.getElementById("btn");
      log.textContent = "";
      btn.disabled = true;

      const codes = generateCodes(20);
      let created = 0, skipped = 0;

      for (let i = 0; i < codes.length; i++) {
        const code = codes[i];
        try {
          // منع التكرار
          if (await codeExists(code)) {
            skipped++;
            log.textContent += `⏭️ Skipped (exists): ${code}\n`;
          } else {
            await addDoc(collection(db, "invites"), {
              code,
              eventName: "زفاف خالد",
              status: "pending",
              createdAt: new Date().toISOString()
            });
            created++;
            log.textContent += `✅ Created: ${code}\n`;
          }
        } catch (e) {
          log.textContent += `❌ Error: ${code} -> ${e.message}\n`;
        }

        // تحديث الشريط
        bar.value = ((i + 1) / codes.length) * 100;
      }

      log.textContent += `\n— Summary —\nCreated: ${created}\nSkipped (exists): ${skipped}\nTotal: ${codes.length}\n`;
      btn.disabled = false;
    }

    // إتاحة الدالة للزر
    window.uploadInvites = uploadInvites;
  </script>
</head>
<body>
  <h2>Upload 20 Invites for Khaled Wedding</h2>
  <button id="btn" class="btn" onclick="uploadInvites()">Upload Now</button>

  <div class="muted">سيتم إنشاء الأكواد KH_001 إلى KH_020 وحفظها داخل مجموعة <code>invites</code> في Firestore.</div>
  <progress id="bar" max="100" value="0"></progress>
  <pre id="log" class="log"></pre>
</body>
</html>
