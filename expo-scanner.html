<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez — ماسح مناسبة احترافي</title>
  <style>
    :root{--bg:#0b1020;--ink:#e5e7eb;--muted:#94a3b8;--line:#334155;--ok:#16a34a;--bad:#dc2626;--warn:#f59e0b;--card:#0e172a}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .container{max-width:1200px;margin:0 auto;padding:14px}
    .topbar{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid #243047}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .btn{appearance:none;border:1px solid var(--line);background:#0b1220;color:var(--ink);border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn:hover{background:#0d1528}
    .select,.input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
    .muted{color:var(--muted)}
    .status{display:flex;gap:8px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%}

    /* Scanner video */
    .scanWrap{position:relative;width:100%;aspect-ratio:3/4;max-width:480px;margin-inline:auto;border-radius:14px;overflow:hidden;border:4px solid var(--line);transition:border-color .25s ease, box-shadow .25s ease}
    .scanWrap.ok{border-color:var(--ok); box-shadow:0 0 0 3px rgba(22,163,74,.25) inset}
    .scanWrap.err{border-color:var(--bad); box-shadow:0 0 0 3px rgba(220,38,38,.25) inset}
    #video{width:100%;height:100%;object-fit:cover}
    .corner{position:absolute;width:36px;height:36px;border:3px solid rgba(255,255,255,.7)}
    .corner.tl{top:10px;left:10px;border-right:none;border-bottom:none;border-radius:10px 0 0 0}
    .corner.tr{top:10px;right:10px;border-left:none;border-bottom:none;border-radius:0 10px 0 0}
    .corner.bl{bottom:10px;left:10px;border-right:none;border-top:none;border-radius:0 0 0 10px}
    .corner.br{bottom:10px;right:10px;border-left:none;border-top:none;border-radius:0 0 10px 0}

    .grid{display:grid;gap:12px}
    @media(min-width:1024px){.grid-2{grid-template-columns:2fr 1fr}}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .hist{max-height:300px;overflow:auto}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0b1220}
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="container row" style="justify-content:space-between">
      <div class="row"><b>HS</b><div class="muted" style="margin-inline-start:8px">ماسح الباركود — مناسبة محددة</div></div>
      <div class="row">
        <span class="tag">Event: <b id="evTag">—</b></span>
        <button id="setEventBtn" class="btn">تعيين/تغيير الحدث</button>
        <button id="langBtn" class="btn">AR</button>
      </div>
    </div>
  </div>

  <div class="container grid grid-2">
    <!-- Left: Scanner -->
    <div class="card">
      <div class="row" style="justify-content:space-between; gap:8px">
        <div class="status"><div id="statusDot" class="dot" style="background:#9ca3af"></div><div id="statusText" class="muted">—</div></div>
        <div class="row">
          <button id="startBtn" class="btn">▶️ تشغيل</button>
          <button id="stopBtn" class="btn" disabled>⏹️ إيقاف</button>
          <button id="switchBtn" class="btn">🔄 تبديل</button>
          <button id="torchBtn" class="btn">💡 فلاش</button>
        </div>
      </div>

      <div class="scanWrap" id="scanWrap">
        <video id="video" playsinline muted autoplay></video>
        <div class="corner tl"></div>
        <div class="corner tr"></div>
        <div class="corner bl"></div>
        <div class="corner br"></div>
      </div>

      <!-- Controls -->
      <div class="row" style="margin-top:10px">
        <div style="width:150px">
          <div class="muted">فترة التوقف (ms)</div>
          <input id="pauseMs" class="input" type="number" value="2000" />
        </div>
        <div style="width:140px">
          <div class="muted">الأصوات</div>
          <select id="soundMode" class="select">
            <option value="on">تشغيل</option>
            <option value="off">إيقاف</option>
          </select>
        </div>
        <div style="width:170px">
          <div class="muted">حجم القارئ</div>
          <select id="scanSize" class="select">
            <option value="360">صغير</option>
            <option value="480" selected>متوسط</option>
            <option value="680">كبير</option>
          </select>
        </div>
        <div style="width:220px">
          <div class="muted">نمط الكود (Regex)</div>
          <input id="codeRegex" class="input mono" value="^[A-Z]{2}_[0-9]{3,}$" />
        </div>
        <div style="width:170px">
          <div class="muted">وضع صارم</div>
          <select id="strictMode" class="select">
            <option value="on">مطابق فقط</option>
            <option value="off">اقبل الكل</option>
          </select>
        </div>
      </div>

      <div id="httpsWarn" class="card" style="display:none; margin-top:10px; border-color:#7f1d1d;background:#450a0a;color:#fecaca">
        ⚠️ الكاميرا تتطلب HTTPS أو localhost.
      </div>
    </div>

    <!-- Right: Last result + history -->
    <div class="card">
      <div class="muted" style="font-size:12px">النتيجة الأخيرة</div>
      <div class="row" style="margin-top:6px; align-items:center">
        <canvas id="qrCanvas" width="120" height="120" style="background:#fff;border-radius:10px"></canvas>
        <div>
          <div id="lastCode" class="mono" style="font-size:22px;font-weight:800">—</div>
          <div id="lastMsg" class="muted" style="font-size:12px;margin-top:4px">—</div>
        </div>
      </div>

      <div class="muted" style="font-size:12px;margin-top:14px">السجل (محفوظ محليًا حسب المناسبة)</div>
      <div id="hist" class="hist"></div>
      <div class="row" style="margin-top:8px"><button id="clearHist" class="btn">مسح السجل</button></div>
    </div>
  </div>

  <!-- QR lib for preview -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- ZXing loader & native flag -->
  <script>
    (function(){
      const CANDS=[
        'https://unpkg.com/@zxing/browser@0.1.3/umd/index.min.js',
        'https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.3/umd/index.min.js',
        'https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js',
        'https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js'
      ];
      function load(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.async=true;s.onload=()=>res();s.onerror=rej;document.head.appendChild(s);});}
      window.ensureZXing=async()=>{if(window.ZXing&&(window.ZXing.BrowserMultiFormatReader||window.ZXing.BrowserQRCodeReader))return true;for(const u of CANDS){try{await load(u);if(window.ZXing&&(window.ZXing.BrowserMultiFormatReader||window.ZXing.BrowserQRCodeReader))return true;}catch(_){} }return !!(window.ZXing&&(window.ZXing.BrowserMultiFormatReader||window.ZXing.BrowserQRCodeReader))};
      window.hasNativeDetector = 'BarcodeDetector' in window;
    })();
  </script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
  (function(){
    const $=(s,root=document)=>root.querySelector(s);

    // i18n (مختصر)
    const T={ ar:{ready:'جاهز',checking:'جاري التحقق…',paused:'⏸️ مؤقت',needEvent:'حدد المناسبة أولاً',ok:'✅ مقبول',dupe:'⚠️ مستخدم سابقًا',mismatch:'❌ غير تابع للمناسبة',notfound:'❌ غير موجود',start:'▶️ تشغيل',stop:'⏹️ إيقاف'},
              en:{ready:'Ready',checking:'Checking…',paused:'⏸️ Paused',needEvent:'Set event first',ok:'✅ Accepted',dupe:'⚠️ Already used',mismatch:'❌ Not this event',notfound:'❌ Not found',start:'▶️ Start',stop:'⏹️ Stop'} };
    let LANG=localStorage.getItem('hs:evscan:lang')||'ar';
    function L(k){return (T[LANG]||T.ar)[k]||k}

    // Firebase
    const cfg={ apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac", authDomain:"hormez-inv.firebaseapp.com", projectId:"hormez-inv" };
    if(!firebase.apps.length){ firebase.initializeApp(cfg); }
    const db=firebase.firestore();

    // Event state
    const URL_EVENT = new URLSearchParams(location.search).get('event');
    let EVENT_LOCKED=false, EVENT_NAME='';
    function setEvent(name,locked=false){ EVENT_NAME=String(name||'').trim(); EVENT_LOCKED=!!locked; $('#evTag').textContent=EVENT_NAME||'—'; localStorage.setItem('hs:evscan:event',EVENT_NAME); renderHist(); refreshButtons(); }
    function initEvent(){ const saved=localStorage.getItem('hs:evscan:event')||''; if(URL_EVENT){ setEvent(URL_EVENT,true); } else if(saved){ setEvent(saved); } else { promptEvent(); } }
    function promptEvent(){ const name=prompt('اكتب اسم المناسبة (مطابق لـ EventName):'); if(name){ setEvent(name,false); } }

    // HTTPS guard
    function httpsOK(){ const isLocal=['localhost','127.0.0.1'].includes(location.hostname); const ok=location.protocol==='https:'||isLocal; $('#httpsWarn').style.display= ok? 'none':'block'; return ok; }

    // Audio
    let audioCtx=null; function ensureAudio(){ try{ if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); } if(audioCtx.state==='suspended') audioCtx.resume(); }catch{} }
    function beep(type='ok'){ if($('#soundMode')?.value==='off') return; try{ ensureAudio(); if(!audioCtx) return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.value=(type==='ok')?880:220; const now=audioCtx.currentTime; const dur=(type==='ok')?0.12:0.22; o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0.0001,now); g.gain.exponentialRampToValueAtTime(0.25,now+0.02); g.gain.exponentialRampToValueAtTime(0.0001,now+dur); o.start(); o.stop(now+dur+0.02);}catch{} }

    // History
    function hKey(){return `hs:evscan:hist:${EVENT_NAME||'__NONE__'}`}
    function getHist(){ try{return JSON.parse(localStorage.getItem(hKey())||'[]')}catch{return[]} }
    function pushHist(code,msg,good){ const h=getHist(); h.unshift({code,msg,good,at:Date.now()}); localStorage.setItem(hKey(),JSON.stringify(h.slice(0,80))); renderHist(); }
    function renderHist(){ const box=$('#hist'); box.innerHTML=''; const h=getHist(); if(!EVENT_NAME){ box.innerHTML=`<div class="muted">${L('needEvent')}</div>`; return;} if(!h.length){ box.innerHTML=`<div class="muted">—</div>`; return;} h.forEach(x=>{ const d=document.createElement('div'); d.style.padding='6px'; d.style.borderTop='1px solid rgba(255,255,255,.08)'; d.innerHTML=`<div class="mono">${x.code}</div><div class="muted" style="font-size:12px">${new Date(x.at).toLocaleString(LANG==='ar'?'ar-EG':'en-GB')} — ${x.msg}</div>`; box.appendChild(d); }); }

    // UI helpers
    function refreshButtons(){ $('#startBtn').textContent=L('start'); $('#stopBtn').textContent=L('stop'); $('#startBtn').disabled = !httpsOK() || !EVENT_NAME; $('#stopBtn').disabled = !scanning; }
    function setStatus(text,color){ $('#statusText').textContent=text; $('#statusDot').style.background=color; }
    function drawQR(text){ const c=$('#qrCanvas'); if(!c) return; const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,c.width,c.height); if(!text) return; try{ QRCode.toCanvas(c,text,{width:120,margin:1},()=>{});}catch{} }
    function highlight(ok){ const w=$('#scanWrap'); w.classList.remove('ok','err'); w.classList.add(ok?'ok':'err'); // رجوع تلقائي للون الافتراضي بعد فترة التوقف
      const ms=Math.max(300,parseInt($('#pauseMs')?.value||'2000',10)); setTimeout(()=>{ w.classList.remove('ok','err'); }, Math.min(ms, 2500)); }

    // Scanner state
    let devices=[], currentDeviceId=null, track=null, scanning=false, rafId=null, reader=null, ndet=null; let locked=false;
    function lockPause(){ locked=true; const ms=Math.max(300,parseInt($('#pauseMs')?.value||'2000',10)); setTimeout(()=>{ locked=false; }, ms); }
    function strictOn(){ return ($('#strictMode')?.value||'on')==='on'; }
    function codeRegex(){ try{ return new RegExp($('#codeRegex')?.value||''); }catch{ return null; } }

    async function ensurePerm(){ try{ const tmp=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false}); tmp.getTracks().forEach(t=>t.stop()); }catch{} }
    async function listCams(){ const all=await navigator.mediaDevices.enumerateDevices(); devices=all.filter(d=>d.kind==='videoinput'); const sel=$('#cameraSelect'); if(!sel) return; sel.innerHTML=''; devices.forEach((d,i)=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||`Camera ${i+1}`; sel.appendChild(o); }); if(devices.length){ if(!currentDeviceId){ const back=devices.find(d=>/back|rear|environment|خلف/i.test(d.label||'')); currentDeviceId=back?back.deviceId:devices[0].deviceId; } sel.value=currentDeviceId; } }

    async function start(){ ensureAudio(); if(!EVENT_NAME){ alert(L('needEvent')); return; } if(!httpsOK()){ alert('HTTPS required'); return;} await ensurePerm(); await listCams(); const dev=currentDeviceId; const v=$('#video'); const stream=await navigator.mediaDevices.getUserMedia({video:{deviceId: dev?{exact:dev}:undefined, focusMode:'continuous'}, audio:false}); v.srcObject=stream; await v.play().catch(()=>{}); track=stream.getVideoTracks()[0]||null; scanning=true; refreshButtons(); setStatus(L('ready'),'#16a34a');
      const zOk=await window.ensureZXing();
      if(zOk && window.ZXing && window.ZXing.BrowserMultiFormatReader){ try{ if(window.ZXing.BarcodeFormat&&window.ZXing.DecodeHintType){ const hints=new Map(); hints.set(window.ZXing.DecodeHintType.POSSIBLE_FORMATS,[window.ZXing.BarcodeFormat.QR_CODE]); reader=new window.ZXing.BrowserMultiFormatReader(hints);} else { reader=new window.ZXing.BrowserMultiFormatReader(); } }catch{ reader=new window.ZXing.BrowserMultiFormatReader(); }
        reader.decodeFromVideoDevice(dev||null, v, (res,err)=>{ if(res){ if(locked) return; const text=res.getText?res.getText():(res.text||''); handleRawScan(String(text||'').trim()); } });
      } else if('BarcodeDetector' in window){ ndet=new window.BarcodeDetector({formats:['qr_code']}); const loop=async()=>{ if(!scanning) return; try{ if(!locked){ const arr=await ndet.detect(v); if(arr&&arr.length){ handleRawScan(String(arr[0].rawValue||'').trim()); } } }catch{} rafId=requestAnimationFrame(loop); }; loop(); }
      else { alert('Camera library not loaded'); setStatus('⚠️', '#f59e0b'); }
    }

    async function stop(){ try{ if(reader){ try{reader.reset();}catch{} reader=null;} if(rafId){ cancelAnimationFrame(rafId); rafId=null;} const v=$('#video'); if(v.srcObject){ v.srcObject.getTracks().forEach(t=>t.stop()); v.srcObject=null; } track=null; }catch{} scanning=false; refreshButtons(); setStatus(L('paused'),'#f59e0b'); }

    async function toggleTorch(){ try{ if(!track) return alert('No torch'); const caps=track.getCapabilities?.(); if(!caps?.torch) return alert('Torch not supported'); const on=!(track.getConstraints()?.advanced?.[0]?.torch); await track.applyConstraints({advanced:[{torch:on}]}); }catch(e){ alert('Torch error'); } }

    // Verify
    async function verifyAndMark(code){ setStatus(L('checking'),'#f59e0b');
      try{
        const q=await db.collection('invites').where('Code','==',code).where('EventName','==',EVENT_NAME).limit(1).get();
        if(q.empty){ show(false, L('mismatch'), code); return; }
        const d=q.docs[0]; const data=d.data()||{};
        if(String(data.Status||'').toLowerCase()==='yes'){ show(false, L('dupe'), code); }
        else { await d.ref.set({ Status:'yes', scannedAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true}); show(true, L('ok'), code); }
      }catch(e){ show(false, e.message||'Error', code); }
    }

    function show(ok, msg, code){ $('#lastCode').textContent=code||'—'; $('#lastCode').style.color= ok? '#86efac':'#fca5a5'; $('#lastMsg').textContent=msg||''; drawQR(code||''); pushHist(code,msg,ok); navigator.vibrate?.(ok?60:120); beep(ok?'ok':'err'); highlight(ok); }

    function onCode(text){ if(!text) return; if(locked) return; lockPause(); verifyAndMark(text); }
    function handleRawScan(raw){ const strict=strictOn(); const re=codeRegex(); if(strict){ if(!re) return; if(!re.test(raw)) return; } onCode(raw); }

    // Wire
    document.addEventListener('DOMContentLoaded', ()=>{
      initEvent(); renderHist(); drawQR(''); refreshButtons();
      // scan size
      const savedW=localStorage.getItem('hs:evscan:scanw'); if(savedW && $('#scanSize')) $('#scanSize').value=savedW; applyScanSize(); $('#scanSize')?.addEventListener('change', applyScanSize);

      $('#langBtn').addEventListener('click', ()=>{ LANG=(LANG==='ar')?'en':'ar'; localStorage.setItem('hs:evscan:lang',LANG); refreshButtons(); renderHist(); });
      $('#startBtn').addEventListener('click', ()=>{ ensureAudio(); start(); });
      $('#stopBtn').addEventListener('click', stop);
      $('#switchBtn')?.addEventListener('click', async ()=>{ await stop(); const sel=$('#cameraSelect'); if(sel){ const w=sel.selectedIndex; sel.selectedIndex=(w+1)%(sel.length||1); currentDeviceId=sel.value; } await start(); });
      $('#torchBtn')?.addEventListener('click', toggleTorch);
      $('#manualBtn')?.addEventListener('click', ()=>{ ensureAudio(); const c=$('#manualCode')?.value?.trim(); if(!c) return; handleRawScan(c); });
      $('#clearHist').addEventListener('click', ()=>{ if(!EVENT_NAME) return; localStorage.removeItem(hKey()); renderHist(); });
      $('#setEventBtn').addEventListener('click', ()=>{ if(EVENT_LOCKED){ alert('تم تعيين الحدث من رابط الصفحة'); return;} promptEvent(); });
    });

    function applyScanSize(){ const wrap=$('#scanWrap'); if(!wrap) return; const w=$('#scanSize')?.value||'480'; wrap.style.maxWidth=w+'px'; localStorage.setItem('hs:evscan:scanw',w); }
  })();
  </script>
</body>
</html>
