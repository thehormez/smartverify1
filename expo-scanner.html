<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez — Event Scanner (with Inline Sounds)</title>
  <style>
    body{margin:0;background:#0b1020;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:1200px;margin:0 auto;padding:14px}
    .topbar{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.85);border-bottom:1px solid #243047;padding:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;margin-top:10px}
    .btn{border:1px solid #334155;background:#0b1220;color:#e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{background:#0d1528}
    .status{display:flex;gap:8px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%}
    .scanWrap{position:relative;width:100%;aspect-ratio:3/4;max-width:400px;margin:auto;border:4px solid #334155;border-radius:14px;overflow:hidden;transition:.25s}
    .scanWrap.ok{border-color:#16a34a;box-shadow:0 0 0 3px rgba(22,163,74,.3) inset}
    .scanWrap.err{border-color:#dc2626;box-shadow:0 0 0 3px rgba(220,38,38,.3) inset}
    #video{width:100%;height:100%;object-fit:cover}
    .mono{font-family:ui-monospace,monospace}
    .hist{max-height:300px;overflow:auto}
  </style>
</head>
<body>
  <div class="topbar row">
    <div><b>HS</b> — <span id="tbTitle">ماسح الباركود</span></div>
    <div class="row" style="margin-inline-start:auto">
      <span id="eventTag" class="btn">—</span>
      <button id="langBtn" class="btn">EN</button>
    </div>
  </div>

  <div class="container row">
    <div class="card" style="flex:2">
      <div class="row" style="justify-content:space-between">
        <div class="status"><div id="statusDot" class="dot" style="background:#9ca3af"></div><div id="statusText">—</div></div>
        <div class="row">
          <button id="startBtn" class="btn">▶️</button>
          <button id="stopBtn" class="btn">⏹️</button>
        </div>
      </div>
      <div class="scanWrap" id="scanWrap">
        <video id="video" playsinline muted autoplay></video>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="manualCode" class="btn mono" placeholder="SA_001" style="flex:1"/>
        <button id="manualBtn" class="btn">تحقق</button>
      </div>
    </div>

    <div class="card" style="flex:1">
      <div>آخر نتيجة</div>
      <div id="lastCode" class="mono" style="font-size:20px;font-weight:700">—</div>
      <div id="lastMsg" style="font-size:14px">—</div>
      <div class="hist" id="hist"></div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
  (function(){
    const $=(s,root=document)=>root.querySelector(s);

    // === Inline sounds (Base64) ===
    const EMBED_OK = "data:audio/wav;base64,UklGRjYAAABXQVZFZm10..."; // success.wav base64
    const EMBED_ERR = "data:audio/wav;base64,UklGRiYAAABXQVZFZm10..."; // error.wav base64

    let okAudio=new Audio(EMBED_OK), errAudio=new Audio(EMBED_ERR);

    function playTone(ok=true){
      const a= ok? okAudio: errAudio; a.currentTime=0; a.play().catch(()=>{});
    }

    // === i18n ===
    const STR={ ar:{ready:'جاهز',ok:'✅ مقبول',dupe:'⚠️ مستخدم',notfound:'❌ غير موجود',paused:'⏸️ متوقف'}, en:{ready:'Ready',ok:'✅ Accepted',dupe:'⚠️ Already used',notfound:'❌ Not found',paused:'⏸️ Paused'}};
    let LANG='ar';

    function applyLang(){ const L=STR[LANG]; $('#statusText').textContent=L.ready; $('#langBtn').textContent=(LANG==='ar')?'EN':'AR'; }

    // === Firebase ===
    const cfg={ apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac", authDomain:"hormez-inv.firebaseapp.com", projectId:"hormez-inv" };
    if(!firebase.apps.length) firebase.initializeApp(cfg);
    const db=firebase.firestore();

    // === Event from query or session ===
    const EVENT=new URLSearchParams(location.search).get('event')||sessionStorage.getItem('hs:evscan:event')||'';
    $('#eventTag').textContent=EVENT||'—';

    // === Scan ===
    function show(ok,msg,code){ $('#lastCode').textContent=code; $('#lastMsg').textContent=msg; $('#scanWrap').classList.remove('ok','err'); $('#scanWrap').classList.add(ok?'ok':'err'); playTone(ok); pushHist(code,msg,ok); }
    async function verify(code){
      const q=await db.collection('invites').where('Code','==',code).where('EventName','==',EVENT).limit(1).get();
      if(q.empty) return show(false,STR[LANG].notfound,code);
      const d=q.docs[0]; const data=d.data();
      if((data.Status||'').toLowerCase()==='yes') return show(false,STR[LANG].dupe,code);
      await d.ref.set({Status:'yes',scannedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
      show(true,STR[LANG].ok,code);
    }

    // === History ===
    function pushHist(code,msg,ok){ const h=JSON.parse(localStorage.getItem('hist')||'[]'); h.unshift({code,msg,ok,at:Date.now()}); localStorage.setItem('hist',JSON.stringify(h.slice(0,50))); renderHist(); }
    function renderHist(){ const box=$('#hist'); box.innerHTML=''; const h=JSON.parse(localStorage.getItem('hist')||'[]'); h.forEach(x=>{ const d=document.createElement('div'); d.textContent=`${x.code} — ${x.msg}`; box.appendChild(d); }); }

    // === Wire ===
    document.addEventListener('DOMContentLoaded',()=>{
      applyLang(); renderHist();
      $('#langBtn').onclick=()=>{LANG=(LANG==='ar')?'en':'ar';applyLang();};
      $('#manualBtn').onclick=()=>{ const c=$('#manualCode').value.trim(); if(c) verify(c); };
    });
  })();
  </script>
</body>
</html>
