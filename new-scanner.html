<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invitation Scanner — Hormez Security</title>
  <style>
    :root{--ok:#16a34a;--warn:#f59e0b;--bad:#dc2626;--ink:#0f172a;--muted:#64748b;--bg:#0b1020;--card:#0e172a}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;color:#e5e7eb}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:38px;height:38px;border-radius:10px;background:#111;border:1px solid #333;display:grid;place-items:center}
    .logo span{font-weight:800;color:#ffd700}
    .card{background:rgba(255,255,255,0.04);backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,0.08); border-radius:16px; padding:16px}
    .grid{display:grid;gap:16px}
    .grid.cols{grid-template-columns: 1fr 1fr}
    @media(max-width:900px){.grid.cols{grid-template-columns:1fr}}
    h1{font-size:clamp(18px,3vw,22px); margin:6px 0 0}
    .muted{color:#a3a3a3}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px dashed #334155;border-radius:999px;padding:6px 10px;font-size:12px}
    .status{border-radius:14px;padding:10px 12px;font-weight:700;display:inline-flex;align-items:center;gap:8px}
    .status.ok{background:rgba(22,163,74,.1); color:var(--ok); border:1px solid rgba(22,163,74,.3)}
    .status.warn{background:rgba(245,158,11,.1); color:var(--warn); border:1px solid rgba(245,158,11,.3)}
    .status.bad{background:rgba(220,38,38,.1); color:var(--bad); border:1px solid rgba(220,38,38,.3)}
    .status.neutral{background:rgba(148,163,184,.08); color:#e5e7eb; border:1px solid rgba(148,163,184,.2)}
    .kpi{display:flex;gap:12px;flex-wrap:wrap}
    .kpi .box{flex:1 1 160px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:14px; padding:14px}
    .kpi .n{font-weight:800;font-size:22px}
    .btn{appearance:none;border:1px solid #334155;background:#0b1220;color:#e5e7eb;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn:hover{background:#0d1528}
    .btn.ghost{background:transparent}
    .btn.ok{border-color:rgba(22,163,74,.3)}
    .btn.warn{border-color:rgba(245,158,11,.3)}
    .btn.bad{border-color:rgba(220,38,38,.3)}
    #reader{width:100%;min-height:360px;border-radius:12px;overflow:hidden;background:#000}
    input[type="text"], select{width:100%;padding:12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .small{font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .tests li{margin:4px 0}
    .pass{color:#16a34a}
    .fail{color:#dc2626}
  </style>

  <!-- Dynamic loader with CDN fallbacks -->
  <script>
    (function(){
      const CDN_CANDIDATES = [
        'https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js',
        'https://unpkg.com/html5-qrcode@2/html5-qrcode.min.js',
        'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/html5-qrcode.min.js',
        'https://cdn.jsdelivr.net/npm/html5-qrcode@2/html5-qrcode.min.js'
      ];
      function loadScript(src){
        return new Promise((resolve, reject)=>{
          const s = document.createElement('script');
          s.src = src; s.async = true; s.onload = ()=>resolve(src); s.onerror = ()=>reject(src);
          document.head.appendChild(s);
        });
      }
      async function ensureHtml5Qrcode(){
        if(window.Html5Qrcode || window.Html5QrcodeScanner){ return true; }
        for(const url of CDN_CANDIDATES){
          try{ await loadScript(url); if(window.Html5Qrcode || window.Html5QrcodeScanner){ return true; } }catch(_){ /* try next */ }
        }
        return !!(window.Html5Qrcode || window.Html5QrcodeScanner);
      }
      window.hs = window.hs || {};
      window.startScanner = async function(){
        const ok = await ensureHtml5Qrcode();
        if (ok && window.hs && typeof window.hs.startScanner === 'function') {
          window.hs.startScanner();
        } else {
          alert(window.hs?.t('cameraLibNotLoaded') || 'Camera library not loaded.');
        }
      };
      window.__ensureHtml5Qrcode = ensureHtml5Qrcode;
    })();
  </script>

  <!-- Main module -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ===== i18n =====
    const STRINGS = {
      en: {
        brand: 'HORMEZ SECURITY',
        scannerTitle: (ev)=>`Scanner — ${ev}`,
        eventLabel: 'Event:',
        startCamera: 'Start Camera',
        fullscreen: 'Fullscreen',
        lastCode: 'Last Scanned Code',
        ready: 'Ready to scan',
        allow: 'Access granted ✅',
        usedBefore: 'This code was used before',
        differentEvent: (ev)=>`Valid code but for a different event: ${ev}`,
        notFound: 'Code not found',
        invalid: 'Invalid code',
        checking: 'Checking…',
        undoUse: 'Undo use',
        manual: 'Manual input / lookup',
        placeholder: 'e.g. KH_001',
        check: 'Check',
        kpiTotal: 'Total invites',
        kpiUsed: 'Used',
        kpiLeft: 'Left',
        notes: 'Notes',
        notesDetail: 'The page accepts QR text like KH_001 or JSON {"code":"KH_001"}. Use HTTPS and allow camera.',
        testsTitle: 'Quick Tests',
        runTests: 'Run tests',
        testStartScanner: 'startScanner is globally available',
        testLibLoaded: 'Html5Qrcode library loaded',
        testFsOk: (n)=>`Firestore OK — total invites: ${n}`,
        testFsFail: 'Failed to access Firestore (rules/Internet)',
        testLS: 'LocalStorage save/restore of last code',
        cameraLibNotLoaded: 'Camera library not loaded. Check Internet/HTTPS and retry.',
        camFail: 'Could not start camera — requires HTTPS and permission.',
        revertOk: 'Status reverted to unused',
        revertFail: 'Failed to revert',
      },
      ar: {
        brand: 'HORMEZ SECURITY',
        scannerTitle: (ev)=>`ماسح — ${ev}`,
        eventLabel: 'الحدث:',
        startCamera: 'تشغيل الكاميرا',
        fullscreen: 'وضع ملء الشاشة',
        lastCode: 'آخر كود مقروء',
        ready: 'جاهز للمسح',
        allow: 'تم السماح بالدخول ✅',
        usedBefore: 'تم استخدام هذا الكود مسبقًا',
        differentEvent: (ev)=>`كود صحيح لكن لحدث مختلف: ${ev}`,
        notFound: 'الكود غير موجود',
        invalid: 'كود غير صالح',
        checking: 'جارِ التحقق...',
        undoUse: 'إلغاء الاستخدام',
        manual: 'بحث/إدخال يدوي',
        placeholder: 'مثال: KH_001',
        check: 'تحقق',
        kpiTotal: 'إجمالي الدعوات',
        kpiUsed: 'المستخدمة',
        kpiLeft: 'المتبقية',
        notes: 'ملاحظات',
        notesDetail: 'تقبل الصفحة QR يحتوي نص الكود مثل KH_001 أو JSON {"code":"KH_001"}. استخدم HTTPS واسمح للكاميرا.',
        testsTitle: 'اختبارات سريعة',
        runTests: 'تشغيل الاختبارات',
        testStartScanner: 'startScanner متوفر عالميًا',
        testLibLoaded: 'مكتبة Html5Qrcode محمّلة',
        testFsOk: (n)=>`اتصال Firestore ناجح — إجمالي الدعوات: ${n}`,
        testFsFail: 'فشل الوصول إلى Firestore (تحقق من القواعد/الإنترنت)',
        testLS: 'حفظ/استرجاع آخر كود في LocalStorage',
        cameraLibNotLoaded: 'مكتبة الكاميرا لم تُحمّل. تحقق من الإنترنت/HTTPS ثم أعد المحاولة.',
        camFail: 'تعذر تشغيل الكاميرا — يتطلب HTTPS وصلاحية الكاميرا.',
        revertOk: 'تم إرجاع الحالة إلى غير مستخدم',
        revertFail: 'تعذّر الإرجاع',
      }
    };

    const $ = (s, root=document) => root.querySelector(s);
    const params = new URLSearchParams(location.search);
    const EVENT_NAME = params.get('event') || 'زفاف خالد';

    // language state
    const LS_KEYS = { code:'hs:lastCode', kind:'hs:lastKind', details:'hs:lastDetails', docId:'hs:lastDocId', event:'hs:event', lang:'hs:lang' };
    let LANG = localStorage.getItem(LS_KEYS.lang) || (document.documentElement.lang || 'en');
    if(!['ar','en'].includes(LANG)) LANG='en';

    // expose translator on window.hs for early alerts
    window.hs.t = (key, ...args)=>{
      const dict = STRINGS[LANG] || STRINGS.en;
      const v = dict[key];
      return typeof v === 'function' ? v(...args) : v;
    };

    function applyLang(){
      const isAr = LANG==='ar';
      document.documentElement.lang = LANG;
      document.documentElement.dir = isAr? 'rtl' : 'ltr';
      // Brand & header
      $('#brandTxt').textContent = STRINGS[LANG].brand;
      $('#scannerTitle').textContent = STRINGS[LANG].scannerTitle(EVENT_NAME);
      $('#eventLabel').textContent = STRINGS[LANG].eventLabel;
      // Buttons
      $('#startBtn').textContent = STRINGS[LANG].startCamera;
      $('#fsBtn').textContent = STRINGS[LANG].fullscreen;
      $('#langBtn').textContent = isAr? 'EN' : 'AR';
      // Last code & status
      $('#lastCodeLabel').textContent = STRINGS[LANG].lastCode;
      const sb = $('#statusBox');
      const currentKind = (localStorage.getItem(LS_KEYS.kind) || 'neutral');
      sb.className = `status ${currentKind}`;
      sb.textContent = {
        ok: STRINGS[LANG].allow,
        warn: STRINGS[LANG].usedBefore,
        bad: STRINGS[LANG].invalid,
        neutral: STRINGS[LANG].ready
      }[currentKind] || STRINGS[LANG].ready;
      // Manual form
      $('#manualLabel').textContent = STRINGS[LANG].manual;
      $('#manualCode').placeholder = STRINGS[LANG].placeholder;
      $('#checkBtn').textContent = STRINGS[LANG].check;
      // KPIs
      $('#kpiTotalLabel').textContent = STRINGS[LANG].kpiTotal;
      $('#kpiUsedLabel').textContent  = STRINGS[LANG].kpiUsed;
      $('#kpiLeftLabel').textContent  = STRINGS[LANG].kpiLeft;
      // Notes
      $('#notesLabel').textContent = STRINGS[LANG].notes;
      $('#notesDetail').textContent = STRINGS[LANG].notesDetail;
      // Tests
      $('#testsLabel').textContent = STRINGS[LANG].testsTitle;
      $('#runTests').textContent = STRINGS[LANG].runTests;
      // Event pill
      $('#eventName').textContent = EVENT_NAME;
    }

    function setLang(l){ LANG = ['ar','en'].includes(l)? l : 'en'; localStorage.setItem(LS_KEYS.lang, LANG); applyLang(); }

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
      authDomain: "hormez-inv.firebaseapp.com",
      projectId: "hormez-inv",
      storageBucket: "hormez-inv.firebasestorage.app",
      messagingSenderId: "747519941805",
      appId: "1:747519941805:web:468fada2492700e9da3a24"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== Persistence for UI =====
    function persistUI({code, kind, details, docId}){
      try{
        if(code !== undefined) localStorage.setItem(LS_KEYS.code, code);
        if(kind) localStorage.setItem(LS_KEYS.kind, kind);
        if(details !== undefined) localStorage.setItem(LS_KEYS.details, details);
        if(docId !== undefined) localStorage.setItem(LS_KEYS.docId, docId);
        localStorage.setItem(LS_KEYS.event, EVENT_NAME);
      }catch(_){/* ignore */}
    }
    function restoreUI(){
      try{
        const savedEvent = localStorage.getItem(LS_KEYS.event);
        if(savedEvent && savedEvent !== EVENT_NAME) return;
        const code = localStorage.getItem(LS_KEYS.code) || '—';
        const kind = localStorage.getItem(LS_KEYS.kind) || 'neutral';
        const details = localStorage.getItem(LS_KEYS.details) || '—';
        const docId = localStorage.getItem(LS_KEYS.docId) || '';
        $('#lastCode').textContent = code;
        $('#statusBox').className = `status ${kind}`;
        $('#statusBox').textContent = {
          ok: STRINGS[LANG].allow,
          warn: STRINGS[LANG].usedBefore,
          bad: STRINGS[LANG].invalid,
          neutral: STRINGS[LANG].ready
        }[kind] || STRINGS[LANG].ready;
        $('#details').textContent = details;
        if(docId){ $('#undoWrap').style.display='inline-block'; $('#undoBtn').dataset.id = docId; }
      }catch(_){/* ignore */}
    }

    // ===== KPIs =====
    async function refreshKPIs(){
      const qAll = query(collection(db,'invites'), where('EventName','==', EVENT_NAME));
      const snapAll = await getDocs(qAll);
      const total = snapAll.size;
      let used = 0;
      snapAll.forEach(d => { if((d.data().Status||'').toLowerCase()==='yes') used++; });
      const left = Math.max(total - used, 0);
      $('#kpiTotal').textContent = total;
      $('#kpiUsed').textContent  = used;
      $('#kpiLeft').textContent  = left;
    }

    // ===== Scanner =====
    let html5QrcodeScanner = null; let lastDecoded = ''; let lastAt = 0;

    async function onScan(decodedText){
      const now = Date.now();
      if(decodedText === lastDecoded && now - lastAt < 2000){ return; }
      lastDecoded = decodedText; lastAt = now;
      $('#lastCode').textContent = decodedText;
      persistUI({code: decodedText});
      await handleCode(decodedText.trim());
    }

    function normalizeCode(s){
      if(!s) return '';
      s = s.trim();
      try{ const obj = JSON.parse(s); if(obj.code) return String(obj.code).trim(); }catch(_){/* ignore */}
      s = s.replace(/[-\s]/g,'_').toUpperCase();
      const m = s.match(/[A-Z]{2,}_[0-9]{3,}/);
      return m ? m[0] : s;
    }

    async function lookupInviteByCode(code){
      const d = doc(db,'invites', code); const ds = await getDoc(d);
      if(ds.exists()) return { ref: d, data: ds.data() };
      const q = query(collection(db,'invites'), where('Code','==', code));
      const snap = await getDocs(q);
      if(snap.empty) return null;
      const first = snap.docs[0]; return { ref: first.ref, data: first.data() };
    }

    function showStatus(kind, text){ const box = $('#statusBox'); box.className = `status ${kind}`; box.textContent = text; }
    function formatDetails(code, data){ const when = data.scannedAt?.toDate?.() ? data.scannedAt.toDate().toLocaleString(LANG==='ar'?'ar-EG':'en-GB') : '—'; return `${LANG==='ar' ? 'الكود' : 'Code'}: ${code} • ${LANG==='ar' ? 'الحالة' : 'Status'}: ${(data.Status||'no').toUpperCase()} • ${LANG==='ar' ? 'آخر مسح' : 'Last Scan'}: ${when}`; }

    function beep(kind='ok'){
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = 'sine'; o.frequency.value = kind==='ok' ? 880 : kind==='warn' ? 520 : 220;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.20);
      o.start(); o.stop(ctx.currentTime+0.21);
    }

    async function handleCode(raw){
      const code = normalizeCode(raw);
      if(!code){ showStatus('bad', STRINGS[LANG].invalid); persistUI({code: raw||'', kind:'bad', details: STRINGS[LANG].invalid, docId:''}); return; }
      showStatus('neutral', STRINGS[LANG].checking); $('#details').textContent = '—'; persistUI({code, kind:'neutral', details: STRINGS[LANG].checking, docId:''});
      try{
        const res = await lookupInviteByCode(code);
        if(!res){ beep('bad'); const det = `${STRINGS[LANG].notFound}: ${code}`; showStatus('bad', STRINGS[LANG].notFound); $('#details').textContent = det; persistUI({code, kind:'bad', details: det, docId:''}); return; }
        const { ref, data } = res;
        if(data.EventName && data.EventName !== EVENT_NAME){ beep('warn'); const det = STRINGS[LANG].differentEvent(data.EventName); showStatus('warn', det); $('#details').textContent = `Code: ${code} — Event: ${data.EventName}`; $('#undoWrap').style.display = 'inline-block'; $('#undoBtn').dataset.id = ref.id; persistUI({code, kind:'warn', details: det, docId: ref.id}); return; }
        if((data.Status||'').toLowerCase()==='yes'){ beep('warn'); const det = formatDetails(code, data); showStatus('warn', STRINGS[LANG].usedBefore); $('#details').textContent = det; $('#undoWrap').style.display = 'inline-block'; $('#undoBtn').dataset.id = ref.id; persistUI({code, kind:'warn', details: det, docId: ref.id}); return; }
        await updateDoc(ref, { Status: 'yes', scannedAt: serverTimestamp(), scannedBy: 'SEC-Device', EventName: data.EventName || EVENT_NAME });
        beep('ok'); const det = formatDetails(code, {...data, Status:'yes'}); showStatus('ok', STRINGS[LANG].allow); $('#details').textContent = det; $('#undoWrap').style.display = 'inline-block'; $('#undoBtn').dataset.id = ref.id; persistUI({code, kind:'ok', details: det, docId: ref.id}); refreshKPIs().catch(console.error);
      }catch(err){ console.error(err); beep('bad'); showStatus('bad', STRINGS[LANG].camFail); persistUI({code, kind:'bad', details: STRINGS[LANG].camFail, docId:''}); }
    }

    async function startScannerImpl(){
      const ok = await window.__ensureHtml5Qrcode?.(); if(!ok){ showStatus('bad', STRINGS[LANG].cameraLibNotLoaded); return; }
      const Html5QrcodeScanner = window.Html5QrcodeScanner; if(!Html5QrcodeScanner){ showStatus('bad', STRINGS[LANG].cameraLibNotLoaded); return; }
      if(html5QrcodeScanner){ await html5QrcodeScanner.clear().catch(()=>{}); html5QrcodeScanner = null; }
      try{
        html5QrcodeScanner = new Html5QrcodeScanner('reader', { fps: 12, qrbox: 260, rememberLastUsedCamera: true, aspectRatio: 1.0 }, false);
        html5QrcodeScanner.render((txt)=>onScan(txt),(err)=>{/* ignore */});
      }catch(e){ console.error(e); showStatus('bad', STRINGS[LANG].camFail); }
    }
    window.hs.startScanner = startScannerImpl;

    document.addEventListener('DOMContentLoaded', async () => {
      // Build static labels once
      $('#brandTxt').textContent = STRINGS[LANG].brand;
      applyLang(); restoreUI(); refreshKPIs().catch(console.error);
      await window.__ensureHtml5Qrcode?.();
      // Events
      $('#startBtn')?.addEventListener('click', ()=> window.startScanner());
      $('#fsBtn')?.addEventListener('click', ()=> document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen());
      $('#langBtn')?.addEventListener('click', ()=> setLang(LANG==='ar'?'en':'ar'));
      $('#manualForm')?.addEventListener('submit', async (e)=>{ e.preventDefault(); const code = normalizeCode($('#manualCode').value); $('#lastCode').textContent = code || '—'; persistUI({code}); if(code) await handleCode(code); });
      $('#undoBtn')?.addEventListener('click', async (e)=>{ const id = e.currentTarget.dataset.id; if(!id) return; try{ await updateDoc(doc(db,'invites', id), { Status: 'no' }); showStatus('neutral', STRINGS[LANG].revertOk); const currentCode = $('#lastCode').textContent || ''; $('#details').textContent = STRINGS[LANG].revertOk; persistUI({code: currentCode, kind:'neutral', details: STRINGS[LANG].revertOk, docId: id}); refreshKPIs().catch(console.error); }catch(err){ console.error(err); showStatus('bad', STRINGS[LANG].revertFail); persistUI({kind:'bad', details: STRINGS[LANG].revertFail}); } });
      $('#runTests')?.addEventListener('click', runTests);
    });

    function addTestResult(ok, msg){ const li = document.createElement('li'); li.textContent = (ok? '✔ ' : '✘ ') + msg; li.className = ok? 'pass' : 'fail'; $('#tests').appendChild(li); }
    async function runTests(){
      $('#tests').innerHTML='';
      addTestResult(typeof window.startScanner === 'function', STRINGS[LANG].testStartScanner);
      addTestResult(!!window.Html5Qrcode || !!window.Html5QrcodeScanner, STRINGS[LANG].testLibLoaded);
      try{ await refreshKPIs(); addTestResult(true, STRINGS[LANG].testFsOk($('#kpiTotal').textContent)); }catch(e){ addTestResult(false, STRINGS[LANG].testFsFail); }
      const token = 'TEST_123'; persistUI({code: token, kind:'neutral', details:'test', docId:''}); const restored = localStorage.getItem(LS_KEYS.code) === token; addTestResult(restored, STRINGS[LANG].testLS);
    }
  </script>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo"><span>HS</span></div>
      <div>
        <div id="brandTxt" class="muted small">HORMEZ SECURITY</div>
        <h1 id="scannerTitle">Scanner</h1>
      </div>
      <div style="margin-inline-start:auto" class="pill mono"><span id="eventLabel">Event:</span> <span id="eventName" style="margin-inline-start:6px">—</span></div>
      <div style="margin-inline-start:8px"><button id="langBtn" class="btn ghost" title="Toggle language">AR</button></div>
    </div>

    <div class="grid cols" style="margin-top:14px">
      <div class="card">
        <div class="row" style="align-items:center">
          <button id="startBtn" class="btn ok" onclick="startScanner()">Start Camera</button>
          <button id="fsBtn" class="btn ghost">Fullscreen</button>
        </div>
        <div id="reader" style="margin-top:12px"></div>
      </div>

      <div class="grid" style="gap:14px">
        <div class="card">
          <div id="lastCodeLabel" class="muted small">Last Scanned Code</div>
          <div class="mono" style="font-size:26px;font-weight:800" id="lastCode">—</div>
          <div style="margin-top:10px">
            <span id="statusBox" class="status neutral">Ready to scan</span>
            <span id="undoWrap" style="display:none;margin-inline-start:8px">
              <button id="undoBtn" class="btn warn small">Undo use</button>
            </span>
          </div>
          <div id="details" class="muted small" style="margin-top:8px">—</div>
        </div>

        <div class="card">
          <div id="manualLabel" class="muted small">Manual input / lookup</div>
          <form id="manualForm" class="row" autocomplete="off">
            <input id="manualCode" dir="ltr" class="mono" placeholder="e.g. KH_001" type="text" />
            <button id="checkBtn" class="btn" type="submit">Check</button>
          </form>
        </div>

        <div class="card">
          <div id="kpiTotalLabel" class="muted small">Total invites</div>
          <div class="kpi">
            <div class="box"><div class="muted small" id="kpiTotalLabelDup">&nbsp;</div><div id="kpiTotal" class="n">—</div></div>
            <div class="box"><div class="muted small" id="kpiUsedLabel">Used</div><div id="kpiUsed" class="n">—</div></div>
            <div class="box"><div class="muted small" id="kpiLeftLabel">Left</div><div id="kpiLeft" class="n">—</div></div>
          </div>
        </div>

        <div class="card">
          <div id="testsLabel" class="muted small">Quick Tests</div>
          <div class="row">
            <button id="runTests" class="btn">Run tests</button>
          </div>
          <ul id="tests" class="tests small" style="margin-top:8px"></ul>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <div id="notesLabel" class="muted small">Notes</div>
      <div id="notesDetail" class="small" style="margin-top:6px">The page accepts QR text like KH_001 or JSON {"code":"KH_001"}. Use HTTPS and allow camera.</div>
    </div>
  </div>
</body>
</html>
