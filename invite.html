<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>بوابة الدعوات | نسخة مستقرة (منع الشاشة السوداء)</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel (JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- SheetJS (اختياري) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
      * { box-sizing: border-box; }
      body { background:#0a0a0a; color:#eee; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Naskh Arabic UI", Arial, sans-serif; }
      .card { background:#111418; border:1px solid #23262b; border-radius:16px; }
      .btn { border-radius:14px; padding:.6rem 1rem; border:1px solid #2a2d33; }
      .btn-primary { background:#facc15; color:#111; border-color:#facc15; }
      .btn-ghost { background:#1a1e24; color:#e6e6e6; }
      .chip { background:#1c2128; color:#c9c9c9; border-radius:10px; padding:.25rem .6rem; border:1px solid #2a2d33; }
      table th, table td { padding:.6rem .4rem; }
      .thumb { width:56px; height:56px; object-fit:contain; border:1px solid #2a2d33; border-radius:8px; background:#0f1318; }
      a.link { color:#93c5fd; }
      code { background:#0f1318; padding:.2rem .35rem; border-radius:6px; border:1px solid #23262b }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef } = React;

      // ======= استقرار التخزين =======
      const SafeStorage = (() => {
        try { const t='__probe__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; } catch(e){
          const mem = {}; return { getItem:k=>mem[k]??null, setItem:(k,v)=>{mem[k]=String(v)}, removeItem:k=>{delete mem[k]} };
        }
      })();
      const trySetItem = (k,v) => { try { SafeStorage.setItem(k,v); return true; } catch(e){ console.warn('Storage save failed',k,e); return false; } };

      // ======= مفاتيح التخزين =======
      const LS_EVENTS = "hormez_events_meta";    // { [eventName]: { password } }
      const LS_AUTH   = "hormez_auth_event";     // { event }
      const LS_INV    = (event)=>`hormez_invites::${event}`; // دعوات
      const LS_QR     = (event)=>`hormez_qrcards::${event}`; // ميتاداتا للباركود فقط
      const LS_QR_VOL = (event)=>`hormez_qrimgs_volatile::${event}`; // علم بأن الصور في الذاكرة

      // ======= كاش صور الباركود (في الذاكرة) =======
      const QRDataCache = new Map(); // id -> dataUrl

      // ======= أدوات =======
      const normalizePhone = (p)=>String(p||'').replace(/\D/g,'');
      const hashString = (str)=>{ let h=5381,i=str.length; while(i){ h=(h*33) ^ str.charCodeAt(--i);} return (h>>>0).toString(36); };

      const makeInvite = ({ guestName, phone, count, eventName, qr }) => ({
        id: Date.now()+"_"+Math.random().toString(36).slice(2,8),
        guestName: (guestName||'').trim(),
        phone: normalizePhone(phone),
        count: Math.max(1, Number(count||1)),
        eventName: (eventName||'بدون اسم حدث').trim(),
        status: 'new',
        createdAt: new Date().toISOString(),
        qrId: qr?.id || null,
        qrName: qr?.name || null,
        qrNumber: qr?.cardNumber || null,
      });
      const computeStats = (invites)=>({
        total: invites.length,
        sent: invites.filter(i=>['sent','reminded','attended'].includes(i.status)).length,
        attended: invites.filter(i=>i.status==='attended').length,
      });

      const openWhatsApp = (phone, message) => {
        const digits = normalizePhone(phone); if(!digits){ alert('رقم الهاتف غير صالح'); return; }
        const url = `https://wa.me/${digits}?text=${encodeURIComponent(message)}`;
        try { const w = window.open(url,'_blank','noopener,noreferrer'); if(!w) alert('قد يكون مانع النوافذ مفعّل. افتح الرابط يدويًا:\n'+url); }
        catch(e){ alert('تعذر فتح واتساب. انسخ الرابط يدويًا:\n'+url); }
      };

      const saveInvites = (event, invites)=> trySetItem(LS_INV(event), JSON.stringify(invites));
      const loadInvites = (event)=>{ try { const s=SafeStorage.getItem(LS_INV(event)); return s? JSON.parse(s): []; } catch { return []; } };

      // نحفظ فقط الميتاداتا من الباركود (بدون الصورة)
      const saveQRCards = (event, cards) => {
        const metaOnly = cards.map(({id,name,used,cardNumber,contentHash})=>({id,name,used,cardNumber,contentHash}));
        const ok = trySetItem(LS_QR(event), JSON.stringify(metaOnly));
        if(!ok) alert('مساحة التخزين ممتلئة. سيتم حفظ الميتاداتا فقط وقد تفقد الصور بعد إعادة التحميل.');
      };
      const loadQRCards = (event)=>{ try { const s=SafeStorage.getItem(LS_QR(event)); return s? JSON.parse(s): []; } catch { return []; } };

      function readFileWithMeta(file){
        return new Promise((resolve,reject)=>{
          const fr = new FileReader();
          fr.onload = ()=>{
            const dataUrl = fr.result; const name=file.name||'qr';
            const m = name.match(/(\d{3,})/); const cardNumber = m? m[1] : null;
            const contentHash = hashString(String(dataUrl));
            const id = Date.now()+"_"+Math.random().toString(36).slice(2,8);
            QRDataCache.set(id, dataUrl); // صورة في الذاكرة فقط
            resolve({ id, name, cardNumber, contentHash });
          };
          fr.onerror = reject; fr.readAsDataURL(file);
        });
      }

      // ========= مصادقة =========
      const getEventMeta = ()=>{ try { return JSON.parse(SafeStorage.getItem(LS_EVENTS)||'{}'); } catch { return {}; } };
      const setEventMeta = (m)=>{ trySetItem(LS_EVENTS, JSON.stringify(m)); };

      function AuthView({ onAuthed }){
        const [eventName,setEventName] = useState('');
        const [password,setPassword] = useState('');
        const [err,setErr] = useState('');
        const login = ()=>{
          setErr(''); const name=eventName.trim(); if(!name){ setErr('ادخل اسم الحدث'); return; }
          const meta = getEventMeta(); const entry = meta[name];
          if(!entry){ meta[name] = { password }; setEventMeta(meta); SafeStorage.setItem(LS_AUTH, JSON.stringify({event:name})); onAuthed(name); return; }
          if((entry.password||'')!==password){ setErr('كلمة المرور غير صحيحة لهذا الحدث'); return; }
          SafeStorage.setItem(LS_AUTH, JSON.stringify({event:name})); onAuthed(name);
        };
        return (
          <div className="min-h-screen flex items-center justify-center p-6">
            <div className="card w-full max-w-md p-6">
              <h1 className="text-center text-2xl font-black mb-6">تسجيل الدخول بالحدث</h1>
              {err && <div className="mb-3 text-sm text-red-300 bg-red-600/20 border border-red-600/40 p-2 rounded">{err}</div>}
              <div className="space-y-4">
                <div>
                  <label className="block text-sm mb-1">اسم الحدث</label>
                  <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" placeholder="مثلاً: زفاف خالد" value={eventName} onChange={e=>setEventName(e.target.value)} />
                </div>
                <div>
                  <label className="block text-sm mb-1">كلمة المرور</label>
                  <input type="password" className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" placeholder="••••••••" value={password} onChange={e=>setPassword(e.target.value)} />
                  <p className="text-xs text-neutral-400 mt-1">إذا كان الحدث جديدًا، ستُسجّل هذه الكلمة له.</p>
                </div>
                <button onClick={login} className="btn btn-primary w-full font-bold">دخول</button>
              </div>
            </div>
          </div>
        );
      }

      function App(){
        const [event,setEvent] = useState(()=>{ try { return JSON.parse(SafeStorage.getItem(LS_AUTH)||'null')?.event || ''; } catch { return ''; } });
        if(!event) return <AuthView onAuthed={setEvent}/>;
        return <EventApp event={event} onLogout={()=>{ SafeStorage.removeItem(LS_AUTH); setEvent(''); }} />;
      }

      function EventApp({ event, onLogout }){
        const [invites, setInvites] = useState(()=>loadInvites(event));
        const [qrCards, setQrCards] = useState(()=>loadQRCards(event));
        const [active, setActive] = useState('home');
        const stats = useMemo(()=>computeStats(invites), [invites]);

        useEffect(()=>{ saveInvites(event, invites); }, [event, invites]);
        useEffect(()=>{ saveQRCards(event, qrCards); }, [event, qrCards]);

        const changePassword = ()=>{
          const meta=getEventMeta(); const entry=meta[event]||{password:''};
          const current=prompt('ادخل كلمة المرور الحالية:',''); if((entry.password||'')!==(current||'')) { alert('كلمة المرور الحالية غير صحيحة'); return; }
          const next=prompt('ادخل كلمة المرور الجديدة:',''); if(!next) return; meta[event]={password:next}; setEventMeta(meta); alert('تم تغيير كلمة المرور لهذا الحدث');
        };

        const takeNextQrCard = ()=>{ const idx=qrCards.findIndex(c=>!c.used); if(idx===-1) return null; const card={...qrCards[idx]}; const next=[...qrCards]; next[idx]={...card, used:true}; setQrCards(next); return card; };
        const returnQrToPool = (qrId)=>{ if(!qrId) return; setQrCards(prev=>prev.map(c=>c.id===qrId? {...c, used:false}: c)); };

        const addInvite = ({ guestName, phone, count, eventName })=>{
          const qr = takeNextQrCard(); if(!qr){ alert('لا توجد كروت باركود متاحة. ارفعها من تبويب "استيراد" أولاً.'); return; }
          const inv = makeInvite({ guestName, phone, count, eventName:eventName||event, qr }); setInvites(prev=>[inv, ...prev]);
        };
        const deleteInvite = (id)=>{ setInvites(prev=>{ const inv=prev.find(x=>x.id===id); if(inv?.qrId) returnQrToPool(inv.qrId); return prev.filter(x=>x.id!==id); }); };
        const markStatus = (id,status)=> setInvites(prev=> prev.map(i=> i.id===id? {...i, status}: i));

        const sendText = (inv)=>{
          const msg = `مرحبا ${inv.guestName}\n\nيشرفنا دعوتك لحضور الفعالية: ${event}\nعدد الكروت للمرافقين: ${inv.count}\n\nملاحظة: قم بتنزيل صورة الباركود من النظام وإرسالها.`;
          openWhatsApp(inv.phone, msg); markStatus(inv.id,'sent');
        };
        const bulkSend = (list)=>{ if(!confirm(`سيتم فتح ${list.length} رسالة/تبويب. قد يمنع المتصفح بعضها. متابعة؟`)) return; list.forEach((inv,i)=> setTimeout(()=>sendText(inv), i*350)); };

        const cardsRemaining = qrCards.filter(c=>!c.used).length;
        const bulkCandidates = invites.filter(i=> i.status==='new' || i.status==='reminded');

        return (
          <div>
            <header className="sticky top-0 z-20 card px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span className="font-black">لوحة حدث: <span className="text-yellow-400">{event}</span></span>
              </div>
              <div className="flex items-center gap-2">
                <span className="chip">الكروت المخزنة: {qrCards.length} • المتاح: {cardsRemaining}</span>
                <button className="btn btn-ghost" onClick={changePassword}>تغيير كلمة المرور</button>
                <button className="btn btn-ghost" onClick={onLogout}>خروج</button>
              </div>
            </header>

            <main className="max-w-6xl mx-auto p-4 md:p-8">
              <div className="card p-6">
                <div className="flex items-center justify-between flex-wrap gap-3">
                  <div>
                    <h2 className="text-xl md:text-2xl font-bold">إدارة الدعوات</h2>
                    <p className="text-neutral-400">ارفع مجموعة الباركود أولاً، ثم أنشئ الدعوات ليتم سحب كرت تلقائياً من المخزون مع منع التكرار.</p>
                  </div>
                  <span className="chip">الجاهزة للإرسال: {bulkCandidates.length}</span>
                </div>
                <div className="my-4 h-px bg-[#23262b]" />
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                  <Stat label="إجمالي الدعوات" value={stats.total} />
                  <Stat label="الدعوات المُرسلة" value={stats.sent} />
                  <Stat label="الحضور" value={stats.attended} />
                  <Stat label="الكروت المتبقية" value={cardsRemaining} />
                </div>
              </div>

              <div className="flex flex-wrap gap-2 mt-4">
                {NavBtn('home','الصفحة الرئيسية',()=>setActive('home'),active)}
                {NavBtn('new','دعوة جديدة',()=>setActive('new'),active)}
                {NavBtn('send','الإرسال',()=>setActive('send'),active)}
                {NavBtn('import','استيراد',()=>setActive('import'),active)}
                {NavBtn('diag','تشخيص',()=>setActive('diag'),active)}
              </div>

              {active==='home' && (
                <div className="card p-6 mt-3">
                  <InviteTable invites={invites} onMark={markStatus} onDelete={deleteInvite} />
                </div>
              )}

              {active==='new' && (
                <NewInviteForm onCreate={addInvite} forcedEventName={event} cardsRemaining={cardsRemaining} />
              )}

              {active==='send' && (
                <SendCenter invites={invites} onSend={sendText} onBulk={bulkSend} />
              )}

              {active==='import' && (
                <ImportCenter qrCards={qrCards} setQrCards={setQrCards} event={event} />
              )}

              {active==='diag' && (<DiagPanel event={event} />)}
            </main>
          </div>
        );
      }

      function Stat({ label, value }){ return (<div className="card p-4"><p className="text-neutral-400 text-sm">{label}</p><p className="text-2xl font-extrabold mt-1">{value}</p></div>); }
      function NavBtn(key,label,onClick,active){ return <button onClick={onClick} className={`btn ${active===key? 'btn-primary' : 'btn-ghost'}`}>{label}</button>; }

      function InviteTable({ invites, onMark, onDelete }){
        if(!invites.length) return <div className="text-neutral-400 text-sm">لا توجد دعوات بعد.</div>;
        return (
          <div className="overflow-x-auto">
            <table className="w-full text-right">
              <thead>
                <tr className="text-neutral-400 text-sm border-b border-[#23262b]">
                  <th>الاسم</th>
                  <th>الجوال</th>
                  <th>عدد الكروت</th>
                  <th>الباركود</th>
                  <th>رقم الكرت</th>
                  <th>الحالة</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody>
                {invites.map(inv => (
                  <tr key={inv.id} className="border-b border-[#1a1e24]">
                    <td>{inv.guestName}</td>
                    <td dir="ltr">{inv.phone}</td>
                    <td>{inv.count}</td>
                    <td>
                      {(inv.qrId && QRDataCache.get(inv.qrId)) ? (
                        <a className="link" href={QRDataCache.get(inv.qrId)} download={inv.qrName || 'qr.png'} title="تنزيل الباركود">
                          <img className="thumb" src={QRDataCache.get(inv.qrId)} alt="QR" />
                        </a>
                      ) : (<span className="chip">—</span>)}
                    </td>
                    <td>{inv.qrNumber || '—'}</td>
                    <td>
                      <span className={`chip ${inv.status==='new'?'':''} ${inv.status==='sent'?'!bg-blue-600 !text-white':''} ${inv.status==='reminded'?'!bg-purple-600 !text-white':''} ${inv.status==='attended'?'!bg-green-600 !text-white':''}`}>
                        {inv.status==='new'? 'جديدة' : inv.status==='sent'? 'مُرسلة' : inv.status==='reminded'? 'مُذكّر' : 'حضر'}
                      </span>
                    </td>
                    <td>
                      <div className="flex gap-2 justify-end">
                        <button className="btn btn-ghost" onClick={()=>onMark(inv.id,'reminded')}>تذكير</button>
                        <button className="btn btn-ghost" onClick={()=>onMark(inv.id,'attended')}>حضور</button>
                        <button className="btn btn-ghost" onClick={()=>onDelete(inv.id)}>حذف</button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      }

      function NewInviteForm({ onCreate, forcedEventName, cardsRemaining }){
        const [guestName, setGuestName] = useState('');
        const [phone, setPhone] = useState('');
        const [count, setCount] = useState(1);
        const [eventName, setEventName] = useState(forcedEventName || '');
        useEffect(()=>{ if(forcedEventName) setEventName(forcedEventName); },[forcedEventName]);
        const create = ()=>{ if(!guestName || !phone){ alert('يرجى إدخال الاسم ورقم الهاتف'); return; } if(cardsRemaining<=0){ alert('لا توجد كروت باركود متاحة. ارفعها أولاً من تبويب الاستيراد.'); return; } onCreate({ guestName, phone, count, eventName }); setGuestName(''); setPhone(''); setCount(1); };
        return (
          <div className="card p-6 mt-3">
            <div className="grid md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm mb-1">الاسم</label>
                <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={guestName} onChange={e=>setGuestName(e.target.value)} placeholder="اسم الضيف" />
              </div>
              <div>
                <label className="block text-sm mb-1">رقم الهاتف</label>
                <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={phone} onChange={e=>setPhone(e.target.value)} placeholder="05xxxxxxxx" />
              </div>
              <div>
                <label className="block text-sm mb-1">عدد الكروت للمرافقين</label>
                <input type="number" min="1" className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={count} onChange={e=>setCount(Number(e.target.value||1))} />
              </div>
              <div>
                <label className="block text-sm mb-1">اسم الحدث</label>
                <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={eventName} onChange={e=>setEventName(e.target.value)} placeholder="مثال: زفاف خالد" readOnly={Boolean(forcedEventName)} />
                <p className="text-xs text-neutral-400 mt-1">الكروت المتاحة حالياً: {cardsRemaining}</p>
              </div>
              <div className="md:col-span-2 flex items-center gap-2">
                <button className="btn btn-primary" onClick={create}>إضافة الدعوة (سحب كرت)</button>
              </div>
            </div>
          </div>
        );
      }

      function ImportCenter({ qrCards, setQrCards, event }){
        const qrInput = useRef(null);
        const onQrPick = async (e)=>{
          const files = Array.from(e.target.files||[]); if(!files.length) return;
          try {
            const BATCH=25; let added=0;
            for(let i=0;i<files.length;i+=BATCH){
              const slice = files.slice(i,i+BATCH);
              const results = await Promise.all(slice.map(readFileWithMeta));
              const existing = qrCards; // ميتاداتا حالية
              const hashSet = new Set(existing.map(c=>c.contentHash));
              const numSet  = new Set(existing.map(c=>c.cardNumber).filter(Boolean));
              const toAdd = [];
              for(const r of results){
                if(hashSet.has(r.contentHash)) continue;
                if(r.cardNumber && numSet.has(r.cardNumber)) continue;
                toAdd.push({ id:r.id, name:r.name, used:false, cardNumber:r.cardNumber, contentHash:r.contentHash });
                hashSet.add(r.contentHash); if(r.cardNumber) numSet.add(r.cardNumber);
              }
              if(toAdd.length){ setQrCards(prev=>[...toAdd, ...prev]); added+=toAdd.length; }
              await new Promise(res=>setTimeout(res,0)); // أعد الرسم
            }
            if(added){ trySetItem(LS_QR_VOL(event),'1'); alert(`تم تحميل ${added} باركود (بدون تكرار).`); }
            else { alert('كل الملفات التي رفعتها مكررة.'); }
          } catch(err){ console.error(err); alert('تعذر قراءة الملفات'); }
          e.target.value='';
        };
        const clearUsed = ()=>{ if(confirm('إعادة تعيين حالة جميع الكروت إلى "متاح"؟')) setQrCards(prev=>prev.map(c=>({...c, used:false}))); };
        const purgeAll  = ()=>{ if(confirm('مسح جميع الكروت المخزنة لهذا الحدث؟')) setQrCards([]); };
        return (
          <div className="card p-6 mt-3">
            <h3 className="font-bold">تحميل كل الباركود من الجهاز (منع التكرار)</h3>
            <p className="text-xs text-neutral-400 mt-1">سيتم حفظ <b>الصور في الذاكرة</b> لتجنّب امتلاء التخزين. سيتم حفظ الميتاداتا فقط.</p>
            <div className="mt-3 flex gap-2">
              <button className="btn btn-primary" onClick={()=>qrInput.current?.click()}>اختيار ملفات باركود</button>
              <input ref={qrInput} type="file" accept="image/png,image/jpeg,image/jpg,image/svg+xml,application/pdf" multiple className="hidden" onChange={onQrPick} />
              <button className="btn btn-ghost" onClick={clearUsed}>إعادة تعيين الاستخدام</button>
              <button className="btn btn-ghost" onClick={purgeAll}>مسح الكل</button>
            </div>
            <div className="mt-4 grid grid-cols-3 sm:grid-cols-5 md:grid-cols-6 gap-3">
              {qrCards.map(c=> (
                <div key={c.id} className="flex flex-col items-center gap-1">
                  {QRDataCache.get(c.id) ? (
                    <img className="thumb" src={QRDataCache.get(c.id)} alt={c.name} title={c.name} />
                  ) : (
                    <div className="thumb flex items-center justify-center text-[10px] text-neutral-500">صورة مؤقتة</div>
                  )}
                  <span className="text-[10px] text-neutral-400">{c.cardNumber ? `#${c.cardNumber}` : 'بدون رقم'}</span>
                  <span className={`text-[10px] ${c.used? 'text-yellow-400' : 'text-neutral-500'}`}>{c.used? 'مستخدم' : 'متاح'}</span>
                </div>
              ))}
            </div>
          </div>
        );
      }

      function SendCenter({ invites, onSend, onBulk }){
        const [filter,setFilter] = useState('');
        const list = invites.filter(i=> i.status==='new' || i.status==='reminded')
          .filter(i=> [i.guestName,i.phone,i.eventName].some(f=> (f||'').toLowerCase().includes(filter.toLowerCase())));
        return (
          <div className="card p-6 mt-3">
            <div className="flex flex-wrap items-center gap-2 mb-4">
              <input className="w-full md:w-80 rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" placeholder="بحث بالاسم أو الرقم" value={filter} onChange={e=>setFilter(e.target.value)} />
              <button disabled={!list.length} className="btn btn-primary" onClick={()=>onBulk(list)}>إرسال جماعي ({list.length})</button>
            </div>
            {!list.length ? (
              <p className="text-neutral-400 text-sm">لا توجد عناصر جاهزة للإرسال الآن.</p>
            ) : (
              <div className="grid md:grid-cols-2 gap-3">
                {list.map(inv => (
                  <div key={inv.id} className="card p-4 space-y-2">
                    <p><b>{inv.guestName}</b> — <span dir="ltr">{inv.phone}</span></p>
                    <p className="text-sm text-neutral-400">كروت: {inv.count} {inv.qrNumber? `• كرت #${inv.qrNumber}` : ''}</p>
                    {inv.qrId && QRDataCache.get(inv.qrId) && (
                      <a className="link" href={QRDataCache.get(inv.qrId)} download={inv.qrName||'qr.png'}>تنزيل الباركود</a>
                    )}
                    <div className="flex gap-2 justify-end">
                      <button className="btn btn-primary" onClick={()=>onSend(inv)}>إرسال فردي (نص)</button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }

      function DiagPanel({ event }){
        const [rows,setRows] = useState([]);
        useEffect(()=>{
          const r=[];
          // React/DOM
          r.push({k:'React موجود', ok: !!window.React});
          r.push({k:'ReactDOM موجود', ok: !!window.ReactDOM});
          // تخزين
          try { SafeStorage.setItem('__t','x'); const v=SafeStorage.getItem('__t'); SafeStorage.removeItem('__t'); r.push({k:'التخزين يعمل', ok: v==='x'}); } catch(e){ r.push({k:'التخزين يعمل', ok:false}); }
          // حجم دعوة
          const example = makeInvite({ guestName:'T', phone:'050', count:1, eventName:'E', qr:{id:'q1',name:'x',cardNumber:'1'} });
          r.push({k:'إنشاء دعوة', ok: example.qrId==='q1' && !('qrDataUrl' in example)});
          setRows(r);
        },[]);
        return (
          <div className="card p-6 mt-3">
            <h3 className="font-bold mb-3">تشخيص سريع</h3>
            <ul className="space-y-2">
              {rows.map((t,i)=> (
                <li key={i} className={`p-2 rounded border ${t.ok? 'border-green-700 bg-green-900/20' : 'border-red-700 bg-red-900/20'}`}>
                  <b>{t.k}</b> — {t.ok? 'نجح' : 'فشل'}
                </li>
              ))}
            </ul>
          </div>
        );
      }

      function Root(){
        const [event,setEvent] = useState(()=>{ try { return JSON.parse(SafeStorage.getItem(LS_AUTH)||'null')?.event || ''; } catch { return ''; } });
        if(!event) return <AuthView onAuthed={setEvent}/>;
        return <EventApp event={event} onLogout={()=>{ SafeStorage.removeItem(LS_AUTH); setEvent(''); }} />;
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<Root />);
    </script>
  </body>
</html>
