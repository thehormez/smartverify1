<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>بوابة الدعوات | مصادقة بالحدث</title>

    <!-- Tailwind (تصميم سريع) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React + ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel لتشغيل JSX مباشرة -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- SheetJS لقراءة ملفات Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
      * { box-sizing: border-box; }
      body { background:#0a0a0a; color:#eee; }
      .card { background:#111418; border:1px solid #23262b; border-radius:16px; }
      .btn { border-radius:14px; padding:.6rem 1rem; border:1px solid #2a2d33; }
      .btn-primary { background:#facc15; color:#111; border-color:#facc15; }
      .btn-ghost { background:#1a1e24; color:#e6e6e6; }
      .chip { background:#1c2128; color:#c9c9c9; border-radius:10px; padding:.25rem .6rem; border:1px solid #2a2d33; }
      table th, table td { padding:.6rem .4rem; }
      a.link { color:#93c5fd; }
      code { background:#0f1318; padding:.2rem .35rem; border-radius:6px; border:1px solid #23262b }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      // =========================
      // مفاتيح التخزين المحلي (لكل حدث على حدة)
      // =========================
      const LS_EVENTS = "hormez_events_meta";    // { [eventName]: { password: string } }
      const LS_AUTH   = "hormez_auth_event";     // { event: string }
      const LS_INV    = (event) => `hormez_invites::${event}`; // invites per event
      const LS_PREFS  = (event) => `hormez_prefs::${event}`;   // { autoOpenQR: bool }

      const QR_BASE = "https://thehormez.github.io/smartverify1/new-merge-qr.html";

      // =========================
      // أدوات مساعدة
      // =========================
      const { useState, useEffect, useMemo, useRef } = React;

      const normalizePhone = (p) => String(p || "").replace(/\D/g, "");
      const makeInvite = ({ guestName, phone, count, eventName }) => ({
        id: Date.now() + "_" + Math.random().toString(36).slice(2, 8),
        guestName: (guestName || "").trim(),
        phone: normalizePhone(phone),
        count: Math.max(1, Number(count || 1)),
        eventName: (eventName || "بدون اسم حدث").trim(),
        status: "new", // new | sent | reminded | attended
        createdAt: new Date().toISOString(),
      });
      const computeStats = (invites) => {
        const total = invites.length;
        const sent = invites.filter(i => ["sent","reminded","attended"].includes(i.status)).length;
        const attended = invites.filter(i => i.status === "attended").length;
        return { total, sent, attended };
      };

      const openWhatsApp = (phone, message) => {
        const digits = normalizePhone(phone);
        if (!digits) { alert("رقم الهاتف غير صالح"); return; }
        const url = `https://wa.me/${digits}?text=${encodeURIComponent(message)}`;
        window.open(url, "_blank", "noopener,noreferrer");
      };

      const saveInvites = (event, invites) => localStorage.setItem(LS_INV(event), JSON.stringify(invites));
      const loadInvites = (event) => {
        try { const s = localStorage.getItem(LS_INV(event)); return s ? JSON.parse(s) : []; } catch { return []; }
      };

      const getPrefs = (event) => { try { return JSON.parse(localStorage.getItem(LS_PREFS(event))||"null") || { autoOpenQR:false }; } catch { return { autoOpenQR:false }; } };
      const setPrefs = (event, prefs) => localStorage.setItem(LS_PREFS(event), JSON.stringify(prefs));

      // CSV / Clipboard / XLSX helpers
      function parseCSV(text) {
        const lines = text.trim().split(/\r?\n/).filter(Boolean);
        if (!lines.length) return [];
        const firstCells = lines[0].split(",").map(s=>s.trim().toLowerCase());
        const hasHeader = ["name","phone","count","event"].some(k => firstCells.includes(k));
        const rows = hasHeader ? lines.slice(1) : lines;
        return rows.map(line => {
          const cells = line.split(",").map(x=>x?.trim() ?? "");
          let name, phone, count, eventName;
          if (hasHeader) {
            const idx = {
              name: firstCells.indexOf("name"),
              phone: firstCells.indexOf("phone"),
              count: firstCells.indexOf("count"),
              event: firstCells.indexOf("event"),
            };
            name  = idx.name  >=0 ? cells[idx.name]  : "";
            phone = idx.phone >=0 ? cells[idx.phone] : "";
            count = idx.count >=0 ? Number(cells[idx.count]||1) : 1;
            eventName = idx.event>=0 ? cells[idx.event] : "";
          } else {
            const [a,b,c,d] = cells;
            name=a; phone=b; count=Number(c||1); eventName=d||"";
          }
          return { guestName:name, phone, count: Math.max(1, count), eventName };
        });
      }

      function parsePasted(text) {
        const lines = text.trim().split(/\r?\n/).filter(Boolean);
        const out = [];
        for (const line of lines) {
          const parts = line.split(/[,|\t]| {2,}/).map(s=>s.trim()).filter(Boolean);
          const p = parts.length >= 3 ? parts : line.split(/\s+/);
          const [name, phone, countStr, ...rest] = p;
          const count = Math.max(1, Number(countStr||1));
          out.push({ guestName: name||"", phone: phone||"", count, eventName: (rest?.[0]||"") });
        }
        return out;
      }

      async function readXLSX(file) {
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, { type: "array" });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
        const rows = json.filter(r => r && r.length);
        if (!rows.length) return [];
        const first = rows[0].map(v => String(v||"").trim().toLowerCase());
        const hasHeader = ["name","phone","count","event"].some(k => first.includes(k));
        const body = hasHeader ? rows.slice(1) : rows;
        return body.map(r => {
          const [a,b,c,d] = r;
          return {
            guestName: String(a||"").trim(),
            phone: String(b||"").trim(),
            count: Math.max(1, Number(c||1)),
            eventName: String(d||"").trim(),
          };
        });
      }

      // ملف كروت فقط: phone,count (يزيد عدّاد الضيف إن وُجد أو ينشئ دعوة جديدة بلا اسم)
      function parseCardsOnlyCSV(text) {
        const rows = text.trim().split(/\r?\n/).filter(Boolean);
        return rows.map(line => {
          const [phone, count] = line.split(/[,\t]/).map(s=>s.trim());
          return { phone, count: Math.max(1, Number(count||1)) };
        });
      }

      // =========================
      // مصادقة بالحدث (اسم حدث + كلمة مرور قابلة للتغيير)
      // =========================
      function getEventMeta() { try { return JSON.parse(localStorage.getItem(LS_EVENTS)||"{}"); } catch { return {}; } }
      function setEventMeta(meta) { localStorage.setItem(LS_EVENTS, JSON.stringify(meta)); }

      function AuthView({ onAuthed }) {
        const [eventName, setEventName] = useState("");
        const [password, setPassword] = useState("");
        const [err, setErr] = useState("");

        const login = () => {
          setErr("");
          const name = eventName.trim();
          if (!name) { setErr("ادخل اسم الحدث"); return; }
          const meta = getEventMeta();
          const entry = meta[name];
          if (!entry) {
            // أول مرة: أنشئ الحدث بهذه الباسورد
            meta[name] = { password };
            setEventMeta(meta);
            localStorage.setItem(LS_AUTH, JSON.stringify({ event: name }));
            onAuthed(name);
            return;
          }
          if ((entry.password||"") !== password) { setErr("كلمة المرور غير صحيحة لهذا الحدث"); return; }
          localStorage.setItem(LS_AUTH, JSON.stringify({ event: name }));
          onAuthed(name);
        };

        return (
          <div className="min-h-screen flex items-center justify-center p-6">
            <div className="card w-full max-w-md p-6">
              <h1 className="text-center text-2xl font-black mb-6">تسجيل الدخول بالحدث</h1>
              {err && <div className="mb-3 text-sm text-red-300 bg-red-600/20 border border-red-600/40 p-2 rounded">{err}</div>}
              <div className="space-y-4" dir="rtl">
                <div>
                  <label className="block text-sm mb-1">اسم الحدث</label>
                  <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" placeholder="مثلاً: زفاف خالد" value={eventName} onChange={e=>setEventName(e.target.value)} />
                </div>
                <div>
                  <label className="block text-sm mb-1">كلمة المرور</label>
                  <input type="password" className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" placeholder="••••••••" value={password} onChange={e=>setPassword(e.target.value)} />
                  <p className="text-xs text-neutral-400 mt-1">إذا كان الحدث جديدًا، ستُسجل هذه الكلمة ككلمة مرور له.</p>
                </div>
                <button onClick={login} className="btn btn-primary w-full font-bold">دخول</button>
              </div>
            </div>
          </div>
        );
      }

      function App() {
        const [event, setEvent] = useState(() => {
          try { return JSON.parse(localStorage.getItem(LS_AUTH)||"null")?.event || ""; } catch { return ""; }
        });
        const [ready, setReady] = useState(true);

        if (!event) return <AuthView onAuthed={setEvent} />;
        return <EventApp event={event} onLogout={() => { localStorage.removeItem(LS_AUTH); setEvent(""); }} />;
      }

      function EventApp({ event, onLogout }) {
        const [invites, setInvites] = useState(() => loadInvites(event));
        const [active, setActive] = useState("home");
        const stats = useMemo(() => computeStats(invites), [invites]);
        const prefs = getPrefs(event);

        useEffect(() => { saveInvites(event, invites); }, [event, invites]);

        const changePassword = () => {
          const meta = getEventMeta();
          const entry = meta[event] || { password:"" };
          const current = prompt("ادخل كلمة المرور الحالية:", "");
          if ((entry.password||"") !== (current||"")) { alert("كلمة المرور الحالية غير صحيحة"); return; }
          const next = prompt("ادخل كلمة المرور الجديدة:", "");
          if (!next) return;
          meta[event] = { password: next };
          setEventMeta(meta);
          alert("تم تغيير كلمة المرور لهذا الحدث");
        };

        const addInvite = (inv) => {
          setInvites(prev => [inv, ...prev]);
          if (prefs.autoOpenQR) openQR(inv);
        };

        const markStatus = (id, status) => setInvites(prev => prev.map(i => i.id === id ? { ...i, status } : i));

        const openQR = (inv) => {
          const url = `${QR_BASE}?guest=${encodeURIComponent(inv.guestName)}&count=${encodeURIComponent(inv.count)}&event=${encodeURIComponent(event)}`;
          window.open(url, "_blank", "noopener,noreferrer");
        };

        const sendText = (inv) => {
          const msg = `مرحبا ${inv.guestName}\n\nيشرفنا دعوتك لحضور الفعالية: ${event}\nعدد الكروت للمرافقين: ${inv.count}\n\nسيتم إرسال رمز الدخول (QR) لك.`; 
          if (navigator.share) { navigator.share({ title:`دعوة ${event}`, text: msg }).catch(()=>{}); }
          else { openWhatsApp(inv.phone, msg); }
          markStatus(inv.id, "sent");
        };

        const bulkSend = (list) => {
          // يفتح رسائل متعددة (قد يوقفها المتصفح؛ نعرض تأكيدًا)
          if (!confirm(`سيتم فتح ${list.length} رسالة/تبويب. المتصفح قد يمنع بعضها. متابعة؟`)) return;
          list.forEach((inv, idx) => {
            setTimeout(() => sendText(inv), idx * 350);
          });
        };

        const toggleAutoQR = () => {
          const next = { ...prefs, autoOpenQR: !prefs.autoOpenQR };
          setPrefs(event, next);
          alert(next.autoOpenQR ? "سيتم فتح صفحة الباركود تلقائيًا لكل دعوة جديدة" : "تم إيقاف الفتح التلقائي للباركود");
        };

        // استيراد: ملف أسماء+أرقام+عدد
        const onImportPeopleFile = async (file) => {
          try {
            let rows = [];
            if (/\.(xlsx|xlsm|xlsb|xls)$/i.test(file.name)) rows = await readXLSX(file);
            else rows = parseCSV(await file.text());
            if (!rows.length) { alert("لا توجد بيانات في الملف"); return; }
            const added = [];
            rows.forEach(r => {
              const inv = makeInvite({ guestName: r.guestName, phone: r.phone, count: r.count, eventName: event });
              added.push(inv);
            });
            setInvites(prev => [...added, ...prev]);
            alert(`تم استيراد ${added.length} دعوة`);
          } catch (e) {
            console.error(e); alert("تعذّر قراءة الملف. الصيغة: name,phone,count[,event]");
          }
        };

        // استيراد: ملف كروت فقط (phone,count) -> يزيد العدّاد للضيف إن وُجد وإلا ينشئ دعوة بدون اسم
        const onImportCardsOnlyFile = async (file) => {
          try {
            let rows = [];
            if (/\.(xlsx|xlsm|xlsb|xls)$/i.test(file.name)) {
              const list = await readXLSX(file);
              rows = list.map(r => ({ phone: r.phone, count: r.count }));
            } else {
              rows = parseCardsOnlyCSV(await file.text());
            }
            if (!rows.length) { alert("لا توجد بيانات في الملف"); return; }

            setInvites(prev => {
              const map = new Map(prev.map(i => [i.phone, i]));
              rows.forEach(({ phone, count }) => {
                const key = normalizePhone(phone);
                const existing = key && map.get(key);
                if (existing) {
                  existing.count = Math.max(1, Number(existing.count || 1)) + Math.max(1, Number(count||1));
                } else {
                  const inv = makeInvite({ guestName: "ضيف", phone: key, count: Math.max(1, Number(count||1)), eventName: event });
                  prev.unshift(inv);
                  map.set(key, inv);
                }
              });
              return [...prev];
            });
            alert(`تم تحديث/إضافة الكروت لعدد ${rows.length} رقم`);
          } catch (e) { console.error(e); alert("تعذّر قراءة ملف الكروت"); }
        };

        // إرسال جماعي: كل الجديدة + المذكّر
        const bulkCandidates = invites.filter(i => i.status === "new" || i.status === "reminded");

        return (
          <div>
            {/* Top bar */}
            <header className="sticky top-0 z-20 card px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div style={{width:28,height:28}} className="rounded-full"/>
                <span className="font-black">لوحة حدث: <span className="text-yellow-400">{event}</span></span>
              </div>
              <div className="flex items-center gap-2">
                <button className="btn btn-ghost" onClick={toggleAutoQR}>{getPrefs(event).autoOpenQR ? 'إيقاف فتح QR تلقائي' : 'تفعيل فتح QR تلقائي'}</button>
                <button className="btn btn-ghost" onClick={changePassword}>تغيير كلمة المرور</button>
                <button className="btn btn-ghost" onClick={onLogout}>خروج</button>
              </div>
            </header>

            {/* Greeting + stats */}
            <main className="max-w-6xl mx-auto p-4 md:p-8" dir="rtl">
              <div className="card p-6">
                <div className="flex items-center justify-between flex-wrap gap-3">
                  <div>
                    <h2 className="text-xl md:text-2xl font-bold">مرحباً! إدارة دعوات الحدث</h2>
                    <p className="text-neutral-400">يمكنك إنشاء الدعوات، توليد باركود، والاستيراد والإرسال الجماعي</p>
                  </div>
                  <span className="chip">المتبقي محلي (غير مرتبط بالرصيد المركزي)</span>
                </div>
                <div className="my-4 h-px bg-[#23262b]" />
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                  <Stat label="إجمالي الدعوات" value={stats.total} />
                  <Stat label="الدعوات المُرسلة" value={stats.sent} />
                  <Stat label="الحضور" value={stats.attended} />
                  <Stat label="الجاهزة للإرسال" value={bulkCandidates.length} />
                </div>
              </div>

              {/* Nav */}
              <div className="flex flex-wrap gap-2 mt-4">
                {NavBtn("home","الصفحة الرئيسية",()=>setActive("home"),active)}
                {NavBtn("new","دعوة جديدة",()=>setActive("new"),active)}
                {NavBtn("send","الإرسال",()=>setActive("send"),active)}
                {NavBtn("import","استيراد",()=>setActive("import"),active)}
              </div>

              {active === "home" && (
                <div className="card p-6 mt-3">
                  <InviteTable invites={invites} onMark={markStatus} onOpenQR={openQR} onSend={sendText} />
                </div>
              )}

              {active === "new" && (
                <NewInviteForm onCreate={(inv)=>addInvite(inv)} forcedEventName={event} />
              )}

              {active === "send" && (
                <SendCenter invites={invites} onSend={sendText} onBulk={bulkSend} />
              )}

              {active === "import" && (
                <ImportCenter onImportPeopleFile={onImportPeopleFile} onImportCardsOnlyFile={onImportCardsOnlyFile} />
              )}
            </main>
          </div>
        );
      }

      function Stat({ label, value }) {
        return (
          <div className="card p-4">
            <p className="text-neutral-400 text-sm">{label}</p>
            <p className="text-2xl font-extrabold mt-1">{value}</p>
          </div>
        );
      }

      function NavBtn(key,label,onClick,active){
        return <button onClick={onClick} className={`btn ${active===key? 'btn-primary' : 'btn-ghost'}`}>{label}</button>;
      }

      function InviteTable({ invites, onMark, onOpenQR, onSend }) {
        if (!invites.length) return <div className="text-neutral-400 text-sm">لا توجد دعوات بعد.</div>;
        return (
          <div className="overflow-x-auto">
            <table className="w-full text-right">
              <thead>
                <tr className="text-neutral-400 text-sm border-b border-[#23262b]">
                  <th>الاسم</th>
                  <th>الجوال</th>
                  <th>عدد الكروت</th>
                  <th>الحالة</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody>
                {invites.map(inv => (
                  <tr key={inv.id} className="border-b border-[#1a1e24]">
                    <td>{inv.guestName}</td>
                    <td dir="ltr">{inv.phone}</td>
                    <td>{inv.count}</td>
                    <td>
                      <span className={`chip ${inv.status==='new'?'':''} ${inv.status==='sent'?'!bg-blue-600 !text-white':''} ${inv.status==='reminded'?'!bg-purple-600 !text-white':''} ${inv.status==='attended'?'!bg-green-600 !text-white':''}`}>
                        {inv.status==='new'? 'جديدة' : inv.status==='sent'? 'مُرسلة' : inv.status==='reminded'? 'مُذكّر' : 'حضر'}
                      </span>
                    </td>
                    <td>
                      <div className="flex gap-2 justify-end">
                        <button className="btn btn-ghost" onClick={()=>onOpenQR(inv)}>توليد باركود</button>
                        <button className="btn btn-ghost" onClick={()=>onSend(inv)}>إرسال</button>
                        <button className="btn btn-ghost" onClick={()=>onMark(inv.id, 'reminded')}>تذكير</button>
                        <button className="btn btn-ghost" onClick={()=>onMark(inv.id, 'attended')}>حضور</button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      }

      function NewInviteForm({ onCreate, forcedEventName }) {
        const [guestName, setGuestName] = useState("");
        const [phone, setPhone] = useState("");
        const [count, setCount] = useState(1);
        const [eventName, setEventName] = useState(forcedEventName || "");
        const [autoQR, setAutoQR] = useState(getPrefs(eventName).autoOpenQR);

        useEffect(()=>{ setAutoQR(getPrefs(eventName).autoOpenQR); }, [eventName]);

        const importFromContacts = async () => {
          try {
            const supported = "contacts" in navigator && "select" in (navigator.contacts || {});
            if (!supported) { alert("قد لا يدعم متصفحك استيراد جهات الاتصال. جرّب كروم على أندرويد."); return; }
            const contacts = await navigator.contacts.select(["name","tel"], { multiple:false });
            if (contacts && contacts[0]) {
              const c = contacts[0];
              setGuestName((c.name && c.name[0]) || "");
              setPhone((c.tel && c.tel[0]) || "");
            }
          } catch { alert("تعذر الوصول لجهات الاتصال"); }
        };

        const create = () => {
          if (!guestName || !phone) { alert("يرجى إدخال الاسم ورقم الهاتف"); return; }
          const inv = makeInvite({ guestName, phone, count, eventName: forcedEventName || eventName });
          onCreate(inv);
          setGuestName(""); setPhone(""); setCount(1);
        };

        return (
          <div className="card p-6 mt-3">
            <div className="grid md:grid-cols-2 gap-4">
              <div className="md:col-span-2">
                <label className="mb-1 inline-block text-sm">استيراد من سجل الهاتف</label>
                <div className="flex gap-2">
                  <button className="btn btn-ghost" onClick={importFromContacts}>سجل الهاتف</button>
                  <span className="text-xs text-neutral-400">* يعمل غالبًا على كروم/أندرويد</span>
                </div>
              </div>

              <div>
                <label className="block text-sm mb-1">الاسم</label>
                <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={guestName} onChange={e=>setGuestName(e.target.value)} placeholder="اسم الضيف" />
              </div>
              <div>
                <label className="block text-sm mb-1">رقم الهاتف</label>
                <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={phone} onChange={e=>setPhone(e.target.value)} placeholder="05xxxxxxxx" />
              </div>
              <div>
                <label className="block text-sm mb-1">عدد الكروت للمرافقين</label>
                <input type="number" min="1" className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={count} onChange={e=>setCount(Number(e.target.value || 1))} />
              </div>
              <div>
                <label className="block text-sm mb-1">اسم الحدث</label>
                <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={eventName} onChange={e=>setEventName(e.target.value)} placeholder="مثال: زفاف خالد" readOnly={Boolean(forcedEventName)} title={forcedEventName ? "يتم تحديده من شاشة الدخول" : ""} />
              </div>

              <div className="md:col-span-2 flex items-center gap-2">
                <button className="btn btn-primary" onClick={create}>إضافة الدعوة</button>
                <span className="text-xs text-neutral-400">سيتم {autoQR? 'فتح' : 'عدم فتح'} صفحة الباركود تلقائياً حسب الإعدادات</span>
              </div>
            </div>
          </div>
        );
      }

      function ImportCenter({ onImportPeopleFile, onImportCardsOnlyFile }) {
        const peopleInput = useRef(null);
        const cardsInput = useRef(null);

        const onPeoplePick = (e)=>{ const f=e.target.files?.[0]; if (f) onImportPeopleFile(f); e.target.value=""; };
        const onCardsPick = (e)=>{ const f=e.target.files?.[0]; if (f) onImportCardsOnlyFile(f); e.target.value=""; };

        const [pasteText, setPasteText] = useState("");
        const pasteToInvites = () => {
          const rows = parsePasted(pasteText);
          if (!rows.length) { alert("لم يتم التعرف على أي سطر"); return; }
          // حدث سيتم ضبطه في EventApp عند الإنشاء؛ هنا فقط عرض تعليمي
          alert(`جاهز لإضافة ${rows.length} دعوة: ارجع لتبويب \"دعوة جديدة\" للصق الأفراد يدويًا أو استخدم رفع الملف.`);
        };

        return (
          <div className="grid md:grid-cols-2 gap-4 mt-3">
            <div className="card p-6">
              <h3 className="font-bold">تحميل الأسماء والأرقام وعدد الدعوات (CSV / XLSX)</h3>
              <p className="text-xs text-neutral-400 mt-1">صيغة الأعمدة: <code>name,phone,count[,event]</code> مع ترويسة اختيارية.</p>
              <div className="mt-3 flex gap-2">
                <button className="btn btn-ghost" onClick={()=>peopleInput.current?.click()}>اختيار ملف</button>
                <input ref={peopleInput} type="file" accept=".csv,.xlsx,.xls" className="hidden" onChange={onPeoplePick} />
              </div>
            </div>

            <div className="card p-6">
              <h3 className="font-bold">إضافة كروت الدعوة للضيوف يدوياً (CSV / XLSX)</h3>
              <p className="text-xs text-neutral-400 mt-1">صيغة الأعمدة: <code>phone,count</code> — سيزيد العدد للضيف إن وُجد وإلا ينشئ دعوة جديدة.</p>
              <div className="mt-3 flex gap-2">
                <button className="btn btn-ghost" onClick={()=>cardsInput.current?.click()}>اختيار ملف</button>
                <input ref={cardsInput} type="file" accept=".csv,.xlsx,.xls" className="hidden" onChange={onCardsPick} />
              </div>
            </div>

            <div className="card p-6 md:col-span-2">
              <h3 className="font-bold">لصق قائمة (اختياري)</h3>
              <textarea className="w-full h-28 rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2 mt-2" placeholder={"مثال:\nأحمد,0500000000,2\nسارة 0555555555 1\nعلي\t0511111111\t3"} value={pasteText} onChange={e=>setPasteText(e.target.value)} />
              <div className="mt-2 flex gap-2">
                <button className="btn btn-ghost" onClick={pasteToInvites}>تحويل (إرشادي)</button>
                <span className="text-xs text-neutral-400">* للاستخدام السريع فقط — الأفضل استخدام زر الملفات بالأعلى.</span>
              </div>
            </div>
          </div>
        );
      }

      function SendCenter({ invites, onSend, onBulk }) {
        const [filter, setFilter] = useState("");
        const list = invites
          .filter(i => i.status === "new" || i.status === "reminded")
          .filter(i => [i.guestName, i.phone, i.eventName].some(f => (f || "").toLowerCase().includes(filter.toLowerCase())));

        return (
          <div className="card p-6 mt-3">
            <div className="flex flex-wrap items-center gap-2 mb-4">
              <input className="w-full md:w-80 rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" placeholder="بحث بالاسم أو الرقم" value={filter} onChange={e=>setFilter(e.target.value)} />
              <button disabled={!list.length} className="btn btn-primary" onClick={()=>onBulk(list)}>إرسال جماعي ({list.length})</button>
            </div>
            {!list.length ? (
              <p className="text-neutral-400 text-sm">لا توجد عناصر جاهزة للإرسال الآن.</p>
            ) : (
              <div className="grid md:grid-cols-2 gap-3">
                {list.map(inv => (
                  <div key={inv.id} className="card p-4 space-y-2">
                    <p><b>{inv.guestName}</b> — <span dir="ltr">{inv.phone}</span></p>
                    <p className="text-sm text-neutral-400">كروت: {inv.count}</p>
                    <div className="flex gap-2 justify-end">
                      <button className="btn btn-primary" onClick={()=>onSend(inv)}>إرسال فردي</button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }

      // رندر
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
