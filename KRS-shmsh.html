<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ â€” Ø£Ø³ÙˆØ¯/Ø°Ù‡Ø¨ÙŠ (Ø«Ø§Ø¨Øª Ø§Ù„Ø±ØµÙŠØ¯ + Ù…ÙÙ†ØªÙ‚ÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯)</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700;900&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    :root{
      --bg:#0b0b0c; --panel:#14151a; --panel-2:#111217; --stroke:#2a2b32;
      --gold:#d4af37; --txt:#e7e7e7; --muted:#a7a7a7; --danger:#ef4444; --ok:#25d366;
      --solid-gold:#b48a18; --solid-blue:#1e40af; --solid-rose:#be123c; --solid-emerald:#047857;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent }
    html,body{ height:100% }
    body{ margin:0; font-family:'Noto Sans Arabic', system-ui, -apple-system, Segoe UI, Arial; background:var(--bg); color:var(--txt) }
    .container{ max-width:1200px; margin:0 auto; padding:16px }

    /* Topbar */
    .topbar{ position:sticky; top:0; z-index:50; background:#0a0a0c; border-bottom:1px solid var(--stroke) }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900 }
    .brand .dot{ width:12px; height:12px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #ffe8a3, var(--gold)) }
    .event-name{ font-weight:900; color:#ffe8a3 }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn{
      border:1px solid var(--stroke); background:#121318; color:#fff; padding:12px 14px; border-radius:12px;
      cursor:pointer; font-weight:800; font-size:16px; min-height:44px
    }
    .btn:active{ transform:scale(0.99) }
    .btn.warn{ border-color:#7a1f1f }
    .btn.ok{ border-color:#1b8c4f }
    .hint{ color:var(--muted); font-size:13px }

    /* Tabs */
    .tabs{ display:flex; gap:10px; padding:12px 0; flex-wrap:wrap }
    .tab{
      border:1px solid var(--stroke); background:#111217; color:#ddd; padding:12px 16px; border-radius:14px;
      cursor:pointer; font-weight:800; font-size:15px; min-height:44px
    }
    .tab.active{ border-color:var(--gold); color:#fff }
    .section{ display:none }
    .section.active{ display:block }

    /* Cards & KPI (Ø£Ù„ÙˆØ§Ù† ÙƒØ§Ù…Ù„Ø©) */
    .card{ background:#121318; border:1px solid var(--stroke); border-radius:16px; padding:14px }
    .card.gold{ background:var(--solid-gold); border-color:var(--solid-gold); color:#fff }
    .card.blue{ background:var(--solid-blue); border-color:var(--solid-blue); color:#fff }
    .card.rose{ background:var(--solid-rose); border-color:var(--solid-rose); color:#fff }
    .card.emerald{ background:var(--solid-emerald); border-color:var(--solid-emerald); color:#fff }
    .kpi{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px }
    .kpi .card h4{ margin:0; font-size:13px; color:#fff }
    .kpi .card .num{ font-size:22px; font-weight:900; margin-top:6px; color:#fff }

    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid rgba(255,255,255,.4); border-radius:999px; color:#fff; font-size:12px }
    .pill.light{ border-color:rgba(0,0,0,.15); background:rgba(255,255,255,.15) }

    /* Table -> Card on mobile */
    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:16px; margin-top:10px }
    thead th{
      background:#1a1b20; color:#f6f6f6; border-bottom:1px solid var(--stroke);
      padding:12px; text-align:right; font-weight:900; font-size:14px
    }
    tbody td{ padding:12px; border-bottom:1px solid var(--stroke); font-size:15px; background:#0f1013; color:#e9e9e9 }
    tbody tr:hover td{ background:#15161b }
    .editable{ cursor:pointer; color:#ffd76a; font-weight:800; text-decoration:underline dotted rgba(212,175,55,.6); text-underline-offset:3px }

    /* Auth modal */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.8); display:flex; align-items:center; justify-content:center; z-index:100 }
    .modal{ width:100%; max-width:520px; background:#16171b; border:1px solid var(--stroke); border-radius:18px; padding:18px }
    .title{ margin:0 0 10px; font-weight:900; font-size:22px }

    /* Assign modal */
    .assign-modal .modal{ max-width:680px }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; max-height:220px; overflow:auto; padding:8px; background:#0f1013; border:1px solid var(--stroke); border-radius:12px }
    .chip{ padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:#13141a; color:#e7e7e7; cursor:pointer; user-select:none }
    .chip.selected{ background:#ffe8a3; color:#111; border-color:#d4af37; font-weight:900 }

    /* Mobile adjustments */
    @media (max-width: 640px){
      .container{ padding:12px }
      .tabs{ gap:8px }
      .tab{ flex:1; text-align:center; padding:10px 8px; font-size:14px }
      .kpi{ grid-template-columns:1fr 1fr }
      .btn.block{ width:100% }
      table thead{ display:none }
      table, tbody, tr, td{ display:block; width:100% }
      tbody tr{ border:1px solid var(--stroke); border-radius:14px; margin-bottom:10px; overflow:hidden }
      tbody td{ display:flex; justify-content:space-between; gap:12px }
      tbody td::before{
        content:attr(data-label);
        color:#bdbdbd; font-weight:700
      }
      td.actions{ display:block }
      .actions .btn{ width:100%; margin-top:8px }
    }
  </style>
</head>
<body>
  <!-- Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="authGate" class="overlay" style="display:none">
    <div class="modal">
      <h3 class="title">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­Ø¯Ø«</h3>
      <div class="hint">Ø£Ø¯Ø®Ù„ <b>Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«</b> Ùˆ<b>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</b> Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ† Ù„Ù…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ ÙÙ‚Ø·.</div>
      <div class="row" style="margin-top:10px; flex-wrap:wrap">
        <input id="authEvent" class="btn" style="flex:1" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«" />
        <input id="authPass" type="password" class="btn" style="flex:1" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
        <button class="btn" style="width:100%" onclick="authLogin()">Ø¯Ø®ÙˆÙ„</button>
      </div>
      <div id="authErr" class="hint" style="color:#ffb3b3; margin-top:8px"></div>
    </div>
  </div>

  <!-- Ù…ÙÙ†ØªÙ‚ÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ -->
  <div id="assignGate" class="overlay assign-modal" style="display:none">
    <div class="modal">
      <h3 class="title">ğŸ¯ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h3>
      <div class="hint" id="assignHint">Ø§Ø®ØªØ± (0) ÙƒÙˆØ¯.</div>
      <div id="chipsContainer" class="chips" dir="ltr"></div>
      <div class="row" style="margin-top:10px; justify-content:flex-end">
        <button class="btn" onclick="closeAssign()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn ok" onclick="saveAssign()">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <div class="topbar">
    <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:12px">
      <div class="brand"><span class="dot"></span><span>Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span></div>
      <div class="row">
        <span id="currentEvent" class="event-name"></span>
        <button class="btn warn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª + Ø±ØµÙŠØ¯ (Ø«Ø§Ø¨Øª) -->
    <section class="kpi" style="margin:12px 0 16px">
      <div class="card blue">
        <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙŠÙ†</h4><div class="num" id="kpiTotal">0</div>
      </div>
      <div class="card gold">
        <h4>Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù…ÙØ±Ø³Ù„Ø©</h4><div class="num" id="kpiSent">0</div>
      </div>
      <div class="card rose">
        <h4>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</h4><div class="num" id="kpiRemain">0</div>
      </div>
      <div class="card emerald">
        <h4>Ø±ØµÙŠØ¯ Ø§Ù„ÙƒØ±ÙˆØª </h4>
        <div class="row" style="gap:8px; margin-top:8px; flex-wrap:wrap">
          <span class="pill light">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <b id="kpiStock">0</b></span>
          <span class="pill light">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <b id="kpiUsedCards">0</b></span>
          <span class="pill light">Ø§Ù„Ù…ØªØ§Ø­: <b id="kpiFreeCards">0</b></span>
        </div>
      </div>
    </section>

    <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <nav class="tabs" id="tabs">
      <button class="tab active" data-section="#sec-home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="tab" data-section="#sec-event">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯Ø«</button>
      <button class="tab" data-section="#sec-guests">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙŠÙˆÙ</button>
      <button class="tab" data-section="#sec-stock">Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</button>
      <button class="tab" data-section="#sec-list">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†</button>
    </nav>

    <!-- Ø§Ù„ØµÙØ­Ø§Øª -->
    <section id="sec-home" class="section active">
      <div class="card gold">
        <h3 style="margin:0 0 8px">Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹</h3>
        <div class="hint">Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ø³ØªØ®Ø¯Ù… ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙŠØ±ÙØ±).</div>
      </div>
    </section>

    <section id="sec-event" class="section">
      <div class="card blue">
        <h3 style="margin:0 0 8px">ğŸ·ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯Ø«</h3>
        <div class="row" style="flex-wrap:wrap">
          <input id="eventName" class="btn" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« (Ù„Ù€ JSON ÙÙ‚Ø·)" style="flex:1" />
          <button class="btn" onclick="exportJSON()">ğŸ’¾ ØªØµØ¯ÙŠØ± JSON</button>
          <input id="dataUpload" type="file" accept=".json" style="display:none" onchange="importJSONFile(this.files[0])" />
          <button class="btn" onclick="document.getElementById('dataUpload').click()">â†©ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
        </div>
        <div class="hint" style="margin-top:8px">Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§ Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„ØªØµØ¯ÙŠØ± ÙÙ‚Ø·Ø› Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯.</div>
      </div>
    </section>

    <section id="sec-guests" class="section">
      <div class="card emerald">
        <h3 style="margin:0 0 8px">ğŸ‘¥ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙŠÙˆÙ</h3>
        <div class="row" style="margin-bottom:8px; flex-wrap:wrap">
          <input id="guestListUpload" type="file" class="btn" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="flex:1" />
          <button class="btn" onclick="handleFileUpload()">âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¶ÙŠÙˆÙ</button>
          <button class="btn ok" onclick="importFromContacts()">ğŸ“± Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ù‡Ø§ØªÙ</button>
        </div>
        <div class="row" style="flex-wrap:wrap">
          <input id="newGuestName" class="btn" placeholder="Ø§Ù„Ø§Ø³Ù…" style="flex:1" />
          <input id="newGuestPhone" class="btn" placeholder="Ø§Ù„Ù‡Ø§ØªÙ (9665...)" style="flex:1" />
          <input id="newGuestTotalNeeded" class="btn" type="number" min="1" value="1" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª" style="flex:1" />
          <button class="btn" onclick="addGuestManually()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙŠÙ</button>
        </div>
        <div class="hint" style="margin-top:8px">ØªÙ… ØªØ­Ù…ÙŠÙ„ <b id="guestCount">0</b> Ø¶ÙŠÙ.</div>
      </div>
    </section>

    <section id="sec-stock" class="section">
      <div class="card rose">
        <h3 style="margin:0 0 8px">ğŸŸï¸ Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¯Ø¹ÙˆØ§Øª (ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯)</h3>
        <div class="row" style="flex-wrap:wrap">
          <input id="barcodeUpload" type="file" class="btn" accept="image/*" multiple style="flex:1" />
          <button class="btn" onclick="loadBarcodes()">ğŸ—‚ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
        </div>
        <div class="hint" style="margin-top:6px">Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©: <b id="barcodeCount">0</b> â€” Ø§Ù„Ø£ÙƒÙˆØ§Ø¯: <span id="importedQrCodes">â€”</span></div>
        <div id="qrMismatchAlert" class="hint" style="margin-top:6px; color:#ffb3b3; display:none"></div>
      </div>
    </section>

    <section id="sec-list" class="section">
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h3 style="margin:0 0 8px">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†</h3>
          <button class="btn ok" onclick="sendAllWhatsApp()">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ</th>
              <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
              <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®ØµØµØ©</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th style="text-align:left">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="guestTableBody"></tbody>
        </table>
        <div class="card gold" style="margin-top:12px">
          <h3 style="margin:0 0 6px">ğŸ–Šï¸ Ù†Øµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</h3>
          <p class="hint">Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª: <code>#{{GUEST_NAME}}#</code>ØŒ <code>#{{TOTAL_COUNT}}#</code></p>
          <textarea id="messageTemplate" class="btn" rows="4" style="width:100%; resize:vertical; line-height:1.9">Ù…Ø±Ø­Ø¨Ø§Ù‹ #{{GUEST_NAME}}#ØŒ
Ù†ØªØ´Ø±Ù Ø¨Ø¯Ø¹ÙˆØªÙƒÙ… Ù„Ø­Ø¶ÙˆØ± ÙØ¹Ø§Ù„ÙŠØªÙ†Ø§ (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª: #{{TOTAL_COUNT}}#).
Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø­Ø¶Ø§Ø±/Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø­Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„.</textarea>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø«Ø§Ø¨ØªØ© Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ =====
    const DEFAULT_EVENT = "Ø²ÙØ§Ù Ø´Ù…Ù‡";
    const DEFAULT_PASS  = "12345";
    const DEFAULT_CARD_STOCK = 300; // Ø±ØµÙŠØ¯ Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø«Ø§Ø¨Øª
    // =======================================

    // Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ†
    const LS_AUTH='hormez_auth_event';
    const LS_GUESTS='hormez_guests';
    const LS_QR='hormez_qrcards';
    const LS_MSG='hormez_message_template';
    const LS_EVENT_NAME='hormez_event_name';

    const getJSON=(k,fb)=>{ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(fb)) }catch{return fb} };
    const setJSON=(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)) }catch{} };

    // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    let guests = getJSON(LS_GUESTS, []);
    let barcodeImages = {};                   // dataURL Ù„ÙƒÙ„ ØµÙˆØ±Ø© (Ù„Ø§ Ù†Ø®Ø²Ù†Ù‡Ø§ Ù„Ø«Ù‚Ù„ Ø§Ù„Ø­Ø¬Ù…)
    let availableQrIds = getJSON(LS_QR, []);
    let internalGuestIdCounter = guests.reduce((m,g)=>Math.max(m,g.internalId||0), 0);
    const fixedStock = DEFAULT_CARD_STOCK;

    // Ù…ØµØ§Ø¯Ù‚Ø© ØµØ§Ø±Ù…Ø©
    function showAuth(){ document.getElementById('authGate').style.display='flex' }
    function hideAuth(){ document.getElementById('authGate').style.display='none' }
    function authLogin(){
      const name=document.getElementById('authEvent').value.trim();
      const pass=document.getElementById('authPass').value;
      const err=document.getElementById('authErr'); err.textContent='';
      if(name!==DEFAULT_EVENT || pass!==DEFAULT_PASS){ err.textContent='Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'; return }
      localStorage.setItem(LS_AUTH, JSON.stringify({event:DEFAULT_EVENT}));
      localStorage.setItem(LS_EVENT_NAME, DEFAULT_EVENT);
      document.getElementById('currentEvent').textContent = DEFAULT_EVENT;
      document.getElementById('eventName').value = DEFAULT_EVENT;
      hideAuth();
    }
    function logout(){ localStorage.removeItem(LS_AUTH); showAuth(); }

    // Ù…ÙÙ†ØªÙ‚ÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ (Modal)
    let assignGuestId = null;
    function openAssignModal(id){
      assignGuestId = id;
      const guest = guests.find(g=>g.internalId===id);
      if(!guest) return;

      const need = guest.totalNeeded;
      const cap = Math.min(fixedStock, availableQrIds.length);
      const allowed = availableQrIds.slice(0, cap);

      // Ø§Ù„Ù…Ø³ØªØ¹Ù…Ù„Ø© Ù…Ù† ØºÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø¶ÙŠÙ
      const usedByOthers = guests
        .filter(g=>g.internalId!==id)
        .flatMap(g=>g.assignedQrIds||[]);

      const container = document.getElementById('chipsContainer');
      container.innerHTML = '';
      allowed.forEach(code=>{
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = code;
        const selected = (guest.assignedQrIds||[]).includes(code);
        if(selected) chip.classList.add('selected');
        chip.onclick = ()=>{
          if(chip.classList.contains('selected')){
            chip.classList.remove('selected');
          }else{
            if(usedByOthers.includes(code)){
              alert(`Ø§Ù„ÙƒÙˆØ¯ "${code}" Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ø¶ÙŠÙ Ø¢Ø®Ø±.`);
              return;
            }
            const curSel = container.querySelectorAll('.chip.selected').length;
            if(curSel>=need){
              alert(`Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† ${need} ÙƒÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¶ÙŠÙ.`);
              return;
            }
            chip.classList.add('selected');
          }
          updateAssignHint();
        };
        container.appendChild(chip);
      });
      updateAssignHint();
      document.getElementById('assignGate').style.display='flex';
    }
    function updateAssignHint(){
      const guest = guests.find(g=>g.internalId===assignGuestId);
      if(!guest) return;
      const need = guest.totalNeeded;
      const curSel = document.querySelectorAll('#chipsContainer .chip.selected').length;
      document.getElementById('assignHint').textContent = `Ø§Ø®ØªØ± ${need} ÙƒÙˆØ¯ (Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹: ${curSel})`;
    }
    function closeAssign(){ assignGuestId=null; document.getElementById('assignGate').style.display='none'; }
    function saveAssign(){
      const guest = guests.find(g=>g.internalId===assignGuestId);
      if(!guest) return;
      const need = guest.totalNeeded;
      const sel = Array.from(document.querySelectorAll('#chipsContainer .chip.selected')).map(el=>el.textContent);
      if(sel.length!==need){ alert(`ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ${need} ÙƒÙˆØ¯ Ø¨Ø§Ù„Ø¶Ø¨Ø·.`); return }
      const others = guests
        .filter(g=>g.internalId!==guest.internalId)
        .flatMap(g=>g.assignedQrIds||[]);
      if(sel.some(c=>others.includes(c))){ alert('Ø£Ø­Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¶ÙŠÙ Ø¢Ø®Ø±.'); return }
      guest.assignedQrIds = sel;
      guest.isManuallyAssigned = true;
      persistAll();
      renderGuestTable(); updateKPIs(); refreshQrUI();
      closeAssign();
    }

    // Boot
    (function boot(){
      try{
        const s=JSON.parse(localStorage.getItem(LS_AUTH)||'null');
        if(!s?.event){ showAuth(); }
        else { document.getElementById('currentEvent').textContent = s.event; }
        document.getElementById('eventName').value = localStorage.getItem(LS_EVENT_NAME) || DEFAULT_EVENT;
        const savedMsg = localStorage.getItem(LS_MSG);
        if (savedMsg && document.getElementById('messageTemplate')) document.getElementById('messageTemplate').value = savedMsg;
        document.getElementById('kpiStock').textContent = fixedStock;
      }catch{ showAuth() }
      renderGuestTable(); updateKPIs(); refreshQrUI();
    })();

    // Tabs
    document.querySelectorAll('#tabs .tab').forEach(tab=>{
      tab.addEventListener('click',()=>{
        document.querySelectorAll('#tabs .tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const id=tab.dataset.section;
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        document.querySelector(id).classList.add('active');
      });
    });

    // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ
    function persistAll(){
      setJSON(LS_GUESTS, guests);
      setJSON(LS_QR, availableQrIds);
      const msgEl=document.getElementById('messageTemplate');
      if(msgEl) localStorage.setItem(LS_MSG, msgEl.value||'');
      const ev=document.getElementById('eventName')?.value||'';
      if(ev) localStorage.setItem(LS_EVENT_NAME, ev);
    }

    // ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON
    function exportJSON(){
      const payload = {
        version:3,
        eventName: document.getElementById('eventName').value || DEFAULT_EVENT,
        guests, availableQrIds, internalGuestIdCounter,
        fixedStock,
        messageTemplate: document.getElementById('messageTemplate')?.value || ''
      };
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      saveAs(blob, `invites_${payload.eventName||'event'}_${Date.now()}.json`);
    }
    function importJSONFile(file){
      if(!file) return;
      const r=new FileReader();
      r.onload=(e)=>{
        try{
          const data=JSON.parse(e.target.result);
          guests = Array.isArray(data.guests)? data.guests: [];
          availableQrIds = Array.isArray(data.availableQrIds)? data.availableQrIds: [];
          internalGuestIdCounter = data.internalGuestIdCounter || guests.reduce((m,g)=>Math.max(m,g.internalId||0),0);
          document.getElementById('eventName').value = data.eventName || DEFAULT_EVENT;
          document.getElementById('currentEvent').textContent = data.eventName || DEFAULT_EVENT;
          if (data.messageTemplate && document.getElementById('messageTemplate')) document.getElementById('messageTemplate').value = data.messageTemplate;
          renderGuestTable(); updateKPIs(); refreshQrUI(); persistAll();
          alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­. (ØªØ°ÙƒÙŠØ±: ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²)');
        }catch{ alert('Ù…Ù„Ù JSON ØºÙŠØ± ØµØ§Ù„Ø­') }
      };
      r.readAsText(file);
    }

    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¶ÙŠÙˆÙ
    function handleFileUpload(){
      const f=document.getElementById('guestListUpload').files[0];
      if(!f){ alert('Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§'); return }
      const ext=f.name.split('.').pop().toLowerCase();
      if(ext==='csv') readCSV(f);
      else if(['xlsx','xls'].includes(ext)) readExcel(f);
      else alert('Ø§Ø³ØªØ®Ø¯Ù… CSV Ø£Ùˆ XLSX')
    }
    function readCSV(file){
      Papa.parse(file,{ header:true, skipEmptyLines:true,
        complete:(res)=>processImportedData(res.data),
        error:(e)=>alert('CSV Ø®Ø·Ø£: '+e.message)
      })
    }
    function readExcel(file){
      const r=new FileReader();
      r.onload=(e)=>{
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const arr=XLSX.utils.sheet_to_json(ws);
        processImportedData(arr)
      };
      r.readAsArrayBuffer(file)
    }

    // âœ…âœ…âœ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§ (ÙŠØ¯Ø¹Ù… Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ + Ù„Ø§ ÙŠØªÙˆÙ‚Ù Ø¨Ø³Ø¨Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù) âœ…âœ…âœ…
    function processImportedData(data){
      if(!Array.isArray(data) || !data.length){ alert('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº'); return; }

      const alias = {
        name: ['name','full name','guest','guest name','Ø§Ù„Ø§Ø³Ù…','Ø§Ø³Ù…','Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ'],
        phone: ['phone','mobile','tel','number','Ø§Ù„Ø¬ÙˆØ§Ù„','Ø§Ù„Ù‡Ø§ØªÙ','Ø±Ù‚Ù…','Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ','Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„'],
        totalneeded: ['totalneeded','total needed','totalneeded ','total_needed','count','qty','tickets','invites','total','total cards','totalneeded(1)','Ø¹Ø¯Ø¯','Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª','Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª','Ø§Ù„Ø¹Ø¯Ø¯']
      };

      const keys = Object.keys(data[0] || {});
      const norm = (s)=>String(s ?? '').toLowerCase().trim();

      const findKey = (wanted) => {
        const list = alias[wanted].map(norm);
        return keys.find(k => list.includes(norm(k))) || null;
      };

      const kName  = findKey('name');
      const kPhone = findKey('phone');
      const kTotal = findKey('totalneeded');

      if(!kName || !kPhone || !kTotal){
        alert('Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ù…Ø³Ù…ÙˆØ­ Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ): name/Ø§Ù„Ø§Ø³Ù…, phone/Ø§Ù„Ù‡Ø§ØªÙ, totalNeeded/Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª');
        return;
      }

      internalGuestIdCounter = guests.reduce((m,g)=>Math.max(m,g.internalId||0),0);

      const newOnes=[];
      data.forEach(row=>{
        const name  = String(row[kName]  ?? '').trim();
        const phone = String(row[kPhone] ?? '').trim();
        const total = Math.max(1, parseInt(row[kTotal] ?? 1) || 1);

        if(!name || !phone) return;
        if(guests.some(x=>x.phone===phone)) return; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±

        internalGuestIdCounter++;
        newOnes.push({
          internalId: internalGuestIdCounter,
          name, phone,
          totalNeeded: total,
          assignedQrIds: [],
          isManuallyAssigned: false,
          status: 'new'
        });
      });

      guests = guests.concat(newOnes);
      persistAll();
      autoDistribute();
      renderGuestTable(); updateKPIs(); refreshQrUI();
      document.getElementById('guestCount').textContent=guests.length;
      alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${newOnes.length} Ø¶ÙŠÙ Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…ÙƒØ±Ø±).`);
    }

    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ù‡Ø§ØªÙ
    async function importFromContacts(){
      try{
        if (!('contacts' in navigator) || !('select' in navigator.contacts)){
          alert('Ù…ÙŠØ²Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. Ø¬Ø±Ø¨ Chrome Ø¹Ù„Ù‰ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ù…Ø¹ HTTPS.');
          return;
        }
        const picked = await navigator.contacts.select(['name','tel'], { multiple:true });
        if (!picked || !picked.length){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„'); return; }
        let added=0;
        picked.forEach(c=>{
          const name=(c.name && c.name[0])||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
          const phone=(c.tel && c.tel[0])||'';
          if(!phone) return;
          if(guests.some(x=>x.phone===phone)) return;
          internalGuestIdCounter++;
          guests.push({ internalId:internalGuestIdCounter, name, phone, totalNeeded:1, assignedQrIds:[], isManuallyAssigned:false, status:'new' });
          added++;
        });
        persistAll();
        autoDistribute();
        renderGuestTable(); updateKPIs(); refreshQrUI();
        alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${added} Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„.`);
      }catch(e){
        console.error(e);
        alert('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ (Ø±ÙØ¶ Ø¥Ø°Ù†/Ø¹Ø¯Ù… Ø¯Ø¹Ù…).');
      }
    }

    // Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠ
    function addGuestManually(){
      const n=document.getElementById('newGuestName').value.trim();
      const p=document.getElementById('newGuestPhone').value.trim();
      const c=Math.max(1, parseInt(document.getElementById('newGuestTotalNeeded').value)||1);
      if(!n||!p){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‡Ø§ØªÙ'); return }
      internalGuestIdCounter++;
      guests.push({ internalId:internalGuestIdCounter, name:n, phone:p, totalNeeded:c, assignedQrIds:[], isManuallyAssigned:false, status:'new' });
      persistAll();
      autoDistribute();
      renderGuestTable(); updateKPIs(); refreshQrUI();
      document.getElementById('newGuestName').value='';
      document.getElementById('newGuestPhone').value='';
      document.getElementById('newGuestTotalNeeded').value='1';
      document.getElementById('guestCount').textContent=guests.length;
    }

    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    function loadBarcodes(){
      const files=document.getElementById('barcodeUpload').files;
      if(!files.length){ alert('Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª'); return }
      barcodeImages={}; availableQrIds=[];
      let ok=0; const total=files.length;
      Array.from(files).forEach(file=>{
        const reader=new FileReader();
        reader.onload=(e)=>{
          const id=file.name.replace(/\.[^.]+$/,'').trim();
          barcodeImages[id]=e.target.result;
          if(!availableQrIds.includes(id)) availableQrIds.push(id);
          ok++;
          document.getElementById('barcodeCount').textContent=ok;
          document.getElementById('importedQrCodes').textContent=availableQrIds.join(', ');
          if(ok===total){
            availableQrIds.sort((a,b)=>{ const A=parseInt(a),B=parseInt(b); if(!isNaN(A)&&!isNaN(B)) return A-B; return a.localeCompare(b) });
            persistAll();
            autoDistribute();
            renderGuestTable(); updateKPIs(); refreshQrUI();
            alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${ok} ÙƒÙˆØ¯ ÙˆØªÙˆØ²ÙŠØ¹Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¶Ù…Ù† Ø­Ø¯ Ø§Ù„Ø±ØµÙŠØ¯.`);
          }
        };
        reader.readAsDataURL(file)
      });
    }

    // ØªÙˆØ²ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ù† Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡Ù… ØªØ¹ÙŠÙŠÙ† ÙŠØ¯ÙˆÙŠ
    function autoDistribute(){
      const cap = Math.min(fixedStock, availableQrIds.length);
      const allowed = availableQrIds.slice(0, cap);
      const usedByManual = guests.filter(g=>g.isManuallyAssigned).flatMap(g=>g.assignedQrIds);
      const free = allowed.filter(id=>!usedByManual.includes(id));
      guests.forEach(g=>{ if(!g.isManuallyAssigned) g.assignedQrIds=[] });
      let i=0;
      guests.forEach(g=>{
        if(!g.isManuallyAssigned){
          const need=g.totalNeeded;
          if(i+need<=free.length){ g.assignedQrIds=free.slice(i,i+need); i+=need }
          else { g.assignedQrIds=[] }
        }
      });
    }

    // Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø±ØµÙŠØ¯/Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… + mismatch
    function refreshQrUI(){
      const cap = Math.min(fixedStock, availableQrIds.length);
      const used = guests.reduce((s,g)=>s + (g.assignedQrIds?.length||0), 0);
      const free = Math.max(cap - used, 0);
      document.getElementById('kpiStock').textContent = fixedStock;
      document.getElementById('kpiUsedCards').textContent = used;
      document.getElementById('kpiFreeCards').textContent = free;

      const need=guests.reduce((s,g)=>s+g.totalNeeded,0);
      const el=document.getElementById('qrMismatchAlert');
      if(!el) return;
      if(cap<need){ el.style.display='block'; el.textContent=`ØªØ­Ø°ÙŠØ±: Ø§Ù„Ù…ØªØ§Ø­ Ø¶Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ (${cap}) Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (${need}).` }
      else if(cap>need){ el.style.display='block'; el.textContent=`Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…ØªØ§Ø­ (${cap}) Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (${need}). Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${cap-need}` }
      else { el.style.display='none' }
    }

    // ØªØ¹Ø¯ÙŠÙ„/ØªØ¹ÙŠÙŠÙ†/Ø­Ø°Ù
    function assignBarcode(id){ openAssignModal(id); }

    function editTotalNeeded(id){
      const g=guests.find(x=>x.internalId===id); if(!g) return;
      const s=prompt(`Ø¹Ø¯Ø¯ Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${g.name}:`, g.totalNeeded);
      if(s===null||s.trim()==='') return;
      const n=parseInt(s); if(isNaN(n)||n<1){ alert('Ø¹Ø¯Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­'); return }
      g.totalNeeded=n; g.isManuallyAssigned=false;
      persistAll(); autoDistribute(); renderGuestTable(); updateKPIs(); refreshQrUI();
    }

    function editGuestDetails(id, field){
      const g=guests.find(x=>x.internalId===id); if(!g) return;
      const s=prompt(field==='name'?`Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${g.name}:`:`Ù‡Ø§ØªÙ Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${g.name}:`, g[field]);
      if(s===null||s.trim()==='') return;
      g[field]=s.trim();
      persistAll(); renderGuestTable();
    }

    async function downloadBarcodeImage(guest){
      const ids=(guest.assignedQrIds||[]).map(x=>String(x).trim()).filter(Boolean);
      if(!ids.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ±ÙˆØª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¶ÙŠÙ'); return }
      const present=ids.filter(id=>barcodeImages[id]);
      if(!present.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¶ÙŠÙ â€” Ø£Ø¹Ø¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².'); return }
      if(ids.length===1){
        const id=present[0];
        const a=document.createElement('a');
        a.href=barcodeImages[id];
        a.download=`${guest.name}_${id}.png`;
        document.body.appendChild(a); a.click(); a.remove();
        return;
      }
      const zip=new JSZip(); let added=0;
      for(const id of present){ const b64=barcodeImages[id].split(',')[1]; zip.file(`${id}.png`, b64, {base64:true}); added++; }
      if(!added){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ±'); return }
      const blob=await zip.generateAsync({type:'blob'});
      saveAs(blob, `${guest.name}_${present.length}_Cards.zip`);
      if(present.length<ids.length){ alert(`ØªÙ… ØªÙ†Ø²ÙŠÙ„ ${present.length} Ù…Ù† Ø£ØµÙ„ ${ids.length}. Ø¨Ø¹Ø¶ Ø§Ù„ØµÙˆØ± ØºÙŠØ± Ù…Ø³ØªÙˆØ±Ø¯Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².`) }
    }

    function deleteGuest(id){
      if(!confirm('Ø­Ø°Ù Ø§Ù„Ø¶ÙŠÙØŸ')) return;
      guests = guests.filter(g=>g.internalId!==id);
      persistAll(); autoDistribute(); renderGuestTable(); updateKPIs(); refreshQrUI();
    }

    // ÙˆØ§ØªØ³Ø§Ø¨
    function sendWhatsAppMessage(guest){
      if(!guest.assignedQrIds.length){ alert('Ù„Ø§ ÙƒØ±ÙˆØª Ù„Ù„Ø¶ÙŠÙ'); return }
      const msgEl=document.getElementById('messageTemplate');
      let txt= msgEl? msgEl.value : `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${guest.name}`;
      txt=txt.replace(/#\{\{GUEST_NAME\}\}#/g, guest.name).replace(/#\{\{TOTAL_COUNT\}\}#/g, guest.totalNeeded);
      const url=`https://wa.me/${guest.phone}?text=${encodeURIComponent(txt)}`;
      window.open(url,'_blank');
      guest.status='sent'; persistAll(); updateKPIs(); renderGuestTable();
    }
    function sendAllWhatsApp(){
      if(!guests.length){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¶ÙŠÙˆÙ'); return }
      if(!confirm('Ø³ÙŠØªÙ… ÙØªØ­ Ø¹Ø¯Ø© Ù†ÙˆØ§ÙØ° ÙˆØ§ØªØ³Ø§Ø¨. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
      const template=document.getElementById('messageTemplate')?.value||'';
      let delay=0;
      guests.forEach((guest)=>{
        const txt=template.replace(/#\{\{GUEST_NAME\}\}#/g,guest.name).replace(/#\{\{TOTAL_COUNT\}\}#/g,guest.totalNeeded);
        const url=`https://wa.me/${guest.phone}?text=${encodeURIComponent(txt)}`;
        setTimeout(()=>{ window.open(url,'_blank'); guest.status='sent'; persistAll(); updateKPIs(); renderGuestTable(); }, delay);
        delay+=1400;
      });
    }

    // UI
    function updateKPIs(){
      const total=guests.length;
      const sent=guests.filter(g=>g.status==='sent').length;
      const remain=Math.max(total - sent, 0);
      document.getElementById('kpiTotal').textContent=total;
      document.getElementById('kpiSent').textContent=sent;
      document.getElementById('kpiRemain').textContent=remain;
    }
    function renderGuestTable(){
      const body=document.getElementById('guestTableBody'); if(!body) return;
      body.innerHTML='';
      document.getElementById('guestCount').textContent=guests.length;

      guests.forEach(guest=>{
        const tr=document.createElement('tr');

        const tdName=document.createElement('td');
        tdName.setAttribute('data-label','Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ');
        tdName.innerHTML=`<span class="editable" onclick="editGuestDetails(${guest.internalId||0}, 'name')">${guest.name||''}</span>`;
        tr.appendChild(tdName);

        const tdCount=document.createElement('td');
        tdCount.setAttribute('data-label','Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª');
        tdCount.innerHTML=`<span class="editable" onclick="editTotalNeeded(${guest.internalId||0})">${guest.totalNeeded||0}</span>`;
        tr.appendChild(tdCount);

        const tdPhone=document.createElement('td');
        tdPhone.setAttribute('data-label','Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ');
        tdPhone.innerHTML=`<span class="editable" onclick="editGuestDetails(${guest.internalId||0}, 'phone')">${guest.phone||''}</span>`;
        tr.appendChild(tdPhone);

        const tdQr=document.createElement('td');
        tdQr.setAttribute('data-label','Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯');
        tdQr.innerHTML=`<span class="editable" title="ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£ÙƒÙˆØ§Ø¯" onclick="assignBarcode(${guest.internalId||0})">${(guest.assignedQrIds||[]).join(', ')||'Ù„Ù… ÙŠØ®ØµÙ‘ÙØµ'}</span>`;
        tdQr.style.color = (guest.assignedQrIds||[]).length===guest.totalNeeded? '#b7ffc8' : '#ffb3b3';
        tdQr.style.fontWeight='800';
        tr.appendChild(tdQr);

        const tdStatus=document.createElement('td');
        tdStatus.setAttribute('data-label','Ø§Ù„Ø­Ø§Ù„Ø©');
        tdStatus.textContent = guest.status==='sent'? 'Ù…ÙØ±Ø³Ù„Ø©' : 'Ø¬Ø¯ÙŠØ¯Ø©';
        tr.appendChild(tdStatus);

        const tdAct=document.createElement('td'); tdAct.className='actions'; tdAct.style.textAlign='left';
        tdAct.setAttribute('data-label','Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª');
        const b1=document.createElement('button'); b1.className='btn block'; b1.textContent='ØªØ¹ÙŠÙŠÙ†/ØªØºÙŠÙŠØ±'; b1.onclick=()=>assignBarcode(guest.internalId);
        const b2=document.createElement('button'); b2.className='btn block'; b2.textContent= guest.totalNeeded===1? 'ğŸ’¾ PNG' : 'ğŸ’¾ ZIP'; b2.onclick=()=>downloadBarcodeImage(guest);
        const b3=document.createElement('button'); b3.className='btn ok block'; b3.textContent='ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨'; b3.onclick=()=>sendWhatsAppMessage(guest);
        const b4=document.createElement('button'); b4.className='btn warn block'; b4.textContent='ğŸ—‘ï¸ Ø­Ø°Ù'; b4.onclick=()=>deleteGuest(guest.internalId);
        [b1,b2,b3,b4].forEach(b=>{ b.style.marginInlineStart='0'; b.style.marginTop='8px'; tdAct.appendChild(b) });
        tr.appendChild(tdAct);

        body.appendChild(tr);
      });
      updateKPIs(); refreshQrUI(); persistAll();
    }

    // Ø­ÙØ¸ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    (function bindMsgAutoSave(){
      const el=document.getElementById('messageTemplate');
      if(!el) return;
      el.addEventListener('input', ()=>{ localStorage.setItem(LS_MSG, el.value||''); });
    })();
  </script>
</body>
</html>
