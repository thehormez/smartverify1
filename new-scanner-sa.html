<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez — ماسح مناسبة احترافي</title>
  <style>
    :root{--bg:#0b1020;--ink:#e5e7eb;--muted:#94a3b8;--line:#334155;--ok:#16a34a;--bad:#dc2626;--warn:#f59e0b;--card:#0e172a}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .container{max-width:1200px;margin:0 auto;padding:14px}
    .topbar{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid #243047}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .btn{appearance:none;border:1px solid var(--line);background:#0b1220;color:var(--ink);border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:#0d1528}
    .scanWrap{position:relative;width:100%;aspect-ratio:3/4;max-width:480px;margin-inline:auto;border-radius:14px;overflow:hidden;border:4px solid var(--line);transition:border-color 0.3s}
    #video{width:100%;height:100%;object-fit:cover}
    .corner{position:absolute;width:36px;height:36px;border:3px solid rgba(255,255,255,.7)}
    .corner.tl{top:10px;left:10px;border-right:none;border-bottom:none;border-radius:10px 0 0 0}
    .corner.tr{top:10px;right:10px;border-left:none;border-bottom:none;border-radius:0 10px 0 0}
    .corner.bl{bottom:10px;left:10px;border-right:none;border-top:none;border-radius:0 0 0 10px}
    .corner.br{bottom:10px;right:10px;border-left:none;border-top:none;border-radius:0 0 10px 0}
    .status{display:flex;gap:8px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container row" style="justify-content:space-between">
      <div class="row"><b>HS</b><div class="muted">ماسح الباركود</div></div>
      <div class="row"><span id="evTag" class="btn">—</span><button id="langBtn" class="btn">AR</button></div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="status"><div id="statusDot" class="dot" style="background:#9ca3af"></div><div id="statusText" class="muted">—</div></div>
        <div class="row"><button id="startBtn" class="btn">▶️ تشغيل</button><button id="stopBtn" class="btn">⏹️ إيقاف</button></div>
      </div>
      <div class="scanWrap" id="scanWrap">
        <video id="video" playsinline muted autoplay></video>
        <div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>
      </div>
      <div id="httpsWarn" class="card" style="display:none; margin-top:10px; border-color:#7f1d1d;background:#450a0a;color:#fecaca">⚠️ الكاميرا تتطلب HTTPS أو localhost.</div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script>
    const db=firebase.initializeApp({apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",authDomain:"hormez-inv.firebaseapp.com",projectId:"hormez-inv"}).firestore();
    const video=document.getElementById('video');
    const wrap=document.getElementById('scanWrap');

    let scanning=false, track=null;

    async function start(){
      if(location.protocol!=='https:'&&location.hostname!=='localhost'){document.getElementById('httpsWarn').style.display='block';return;}
      const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      video.srcObject=stream; await video.play();
      track=stream.getVideoTracks()[0]; scanning=true;
      scanLoop();
    }
    function stop(){if(track){track.stop();} scanning=false;}

    async function scanLoop(){
      if(!scanning) return;
      if('BarcodeDetector'in window){
        const det=new BarcodeDetector({formats:['qr_code']});
        try{
          const codes=await det.detect(video);
          if(codes.length){
            const code=codes[0].rawValue.trim();
            verify(code);
          }
        }catch{}
      }
      requestAnimationFrame(scanLoop);
    }

    async function verify(code){
      const q=await db.collection('invites').where('Code','==',code).limit(1).get();
      if(q.empty){setResult(false,'غير موجود');return;}
      const d=q.docs[0]; const data=d.data();
      if(data.Status==='yes'){setResult(false,'تم استخدامه');}
      else{await d.ref.update({Status:'yes'});setResult(true,'✅ مقبول');}
    }

    function setResult(ok,msg){
      document.getElementById('statusText').textContent=msg;
      wrap.style.borderColor=ok? 'var(--ok)':'var(--bad)';
    }

    document.getElementById('startBtn').onclick=start;
    document.getElementById('stopBtn').onclick=stop;
  </script>
</body>
</html>
