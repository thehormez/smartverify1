<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez â€” Event Scanner Pro (Inline Audio)</title>
  <style>
    :root{--bg:#0b1020;--ink:#e5e7eb;--muted:#94a3b8;--line:#334155;--ok:#16a34a;--bad:#dc2626;--warn:#f59e0b}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .container{max-width:1200px;margin:0 auto;padding:14px}
    .topbar{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid #243047}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .btn{appearance:none;border:1px solid var(--line);background:#0b1220;color:var(--ink);border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn:hover{background:#0d1528}
    .select,.input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
    .muted{color:var(--muted)}
    .status{display:flex;gap:8px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%}

    /* Scanner */
    .scanWrap{position:relative;width:100%;aspect-ratio:3/4;max-width:480px;margin-inline:auto;border-radius:14px;overflow:hidden;border:4px solid var(--line);transition:border-color .25s ease, box-shadow .25s ease}
    .scanWrap.ok{border-color:var(--ok); box-shadow:0 0 0 3px rgba(22,163,74,.25) inset}
    .scanWrap.err{border-color:var(--bad); box-shadow:0 0 0 3px rgba(220,38,38,.25) inset}
    #video{width:100%;height:100%;object-fit:cover}
    .corner{position:absolute;width:36px;height:36px;border:3px solid rgba(255,255,255,.7)}
    .corner.tl{top:10px;left:10px;border-right:none;border-bottom:none;border-radius:10px 0 0 0}
    .corner.tr{top:10px;right:10px;border-left:none;border-bottom:none;border-radius:0 10px 0 0}
    .corner.bl{bottom:10px;left:10px;border-right:none;border-top:none;border-radius:0 0 0 10px}
    .corner.br{bottom:10px;right:10px;border-left:none;border-top:none;border-radius:0 0 10px 0}

    .grid{display:grid;gap:12px}
    @media(min-width:1024px){.grid-2{grid-template-columns:2fr 1fr}}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .hist{max-height:300px;overflow:auto}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0b1220}
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="container row" style="justify-content:space-between">
      <div class="row"><b>HS</b><div id="tbTitle" class="muted" style="margin-inline-start:8px">Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ â€” Ù…Ù†Ø§Ø³Ø¨Ø© Ù…Ø­Ø¯Ø¯Ø©</div></div>
      <div class="row">
        <span class="tag"><span id="lblEventTop">Ø§Ù„Ø­Ø¯Ø«</span>: <b id="evTag">â€”</b></span>
        <button id="setEventBtn" class="btn">ØªØ¹ÙŠÙŠÙ†/ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¯Ø«</button>
        <button id="langBtn" class="btn">EN</button>
      </div>
    </div>
  </div>

  <div class="container grid grid-2">
    <!-- Left: Scanner -->
    <div class="card" id="dropZone">
      <div class="row" style="justify-content:space-between; gap:8px">
        <div class="status"><div id="statusDot" class="dot" style="background:#9ca3af"></div><div id="statusText" class="muted">â€”</div></div>
        <div class="row">
          <button id="startBtn" class="btn">â–¶ï¸ ØªØ´ØºÙŠÙ„</button>
          <button id="stopBtn" class="btn" disabled>â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
          <button id="switchBtn" class="btn">ğŸ”„ ØªØ¨Ø¯ÙŠÙ„</button>
          <button id="torchBtn" class="btn">ğŸ’¡ ÙÙ„Ø§Ø´</button>
        </div>
      </div>

      <div class="scanWrap" id="scanWrap">
        <video id="video" playsinline muted autoplay></video>
        <div class="corner tl"></div>
        <div class="corner tr"></div>
        <div class="corner bl"></div>
        <div class="corner br"></div>
      </div>

      <!-- Controls -->
      <div class="row" style="margin-top:10px">
        <div style="width:150px">
          <div id="lblPause" class="muted">ÙØªØ±Ø© Ø§Ù„ØªÙˆÙ‚Ù (Ù…Ù„Ù‘ÙŠ Ø«Ø§Ù†ÙŠØ©)</div>
          <input id="pauseMs" class="input" type="number" value="2000" />
        </div>
        <div style="width:140px">
          <div id="lblSound" class="muted">Ø§Ù„Ø£ØµÙˆØ§Øª</div>
          <select id="soundMode" class="select">
            <option value="on">ØªØ´ØºÙŠÙ„</option>
            <option value="off">Ø¥ÙŠÙ‚Ø§Ù</option>
          </select>
        </div>
        <div style="width:170px">
          <div id="lblScanSize" class="muted">Ø­Ø¬Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦</div>
          <select id="scanSize" class="select">
            <option value="360">ØµØºÙŠØ±</option>
            <option value="480" selected>Ù…ØªÙˆØ³Ø·</option>
            <option value="680">ÙƒØ¨ÙŠØ±</option>
          </select>
        </div>
        <div style="width:220px">
          <div id="lblRegex" class="muted">Ù†Ù…Ø· Ø§Ù„ÙƒÙˆØ¯ (Regex)</div>
          <input id="codeRegex" class="input mono" value="^[A-Z]{2}_[0-9]{3,}$" />
        </div>
        <div style="width:170px">
          <div id="lblStrict" class="muted">ÙˆØ¶Ø¹ ØµØ§Ø±Ù…</div>
          <select id="strictMode" class="select">
            <option value="on">Ù…Ø·Ø§Ø¨Ù‚ ÙÙ‚Ø·</option>
            <option value="off">Ø§Ù‚Ø¨Ù„ Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>
      </div>

      <!-- Inline sounds + manual input -->
      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <div id="lblManual" class="muted">Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</div>
          <div class="row">
            <input id="manualCode" class="input" placeholder="SA_001" />
            <button id="manualBtn" class="btn">ØªØ­Ù‚Ù‚</button>
          </div>
          <div class="muted" style="font-size:12px;margin-top:6px">ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ù‹Ø§ Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª Ù…Ù„ÙÙŠ Ø§Ù„ØµÙˆØª Ù‡Ù†Ø§ (success.wav / error.wav) Ù„Ø­ÙØ¸Ù‡Ù…Ø§ Ù…Ø­Ù„ÙŠÙ‹Ø§.</div>
        </div>
      </div>

      <div id="httpsWarn" class="card" style="display:none; margin-top:10px; border-color:#7f1d1d;background:#450a0a;color:#fecaca">
        âš ï¸ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØªØ·Ù„Ø¨ HTTPS Ø£Ùˆ localhost.
      </div>
    </div>

    <!-- Right: Last result + history -->
    <div class="card">
      <div id="lblLast" class="muted" style="font-size:12px">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©</div>
      <div class="row" style="margin-top:6px; align-items:center">
        <canvas id="qrCanvas" width="120" height="120" style="background:#fff;border-radius:10px"></canvas>
        <div>
          <div id="lastCode" class="mono" style="font-size:22px;font-weight:800">â€”</div>
          <div id="lastMsg" class="muted" style="font-size:12px;margin-top:4px">â€”</div>
        </div>
      </div>

      <div id="lblHist" class="muted" style="font-size:12px;margin-top:14px">Ø§Ù„Ø³Ø¬Ù„ (Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©)</div>
      <div id="hist" class="hist"></div>
      <div class="row" style="margin-top:8px"><button id="clearHist" class="btn">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button></div>
    </div>
  </div>

  <!-- QR lib for preview -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <!-- ZXing loader & native flag -->
  <script>
    (function(){
      const CANDS=[
        'https://unpkg.com/@zxing/browser@0.1.3/umd/index.min.js',
        'https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.3/umd/index.min.js',
        'https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js',
        'https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js'
      ];
      function load(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.async=true;s.onload=()=>res();s.onerror=rej;document.head.appendChild(s);});}
      window.ensureZXing=async()=>{if(window.ZXing&&(window.ZXing.BrowserMultiFormatReader||window.ZXing.BrowserQRCodeReader))return true;for(const u of CANDS){try{await load(u);if(window.ZXing&&(window.ZXing.BrowserMultiFormatReader||window.ZXing.BrowserQRCodeReader))return true;}catch(_){} }return !!(window.ZXing&&(window.ZXing.BrowserMultiFormatReader||window.ZXing.BrowserQRCodeReader))};
      window.hasNativeDetector = 'BarcodeDetector' in window;
    })();
  </script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
  (function(){
    const $=(s,root=document)=>root.querySelector(s);

    // ===== Embedded Audio (paste data URIs here if available) =====
    // NOTE: we also persist to localStorage when files are dropped/selected; on next load we auto-use stored versions.
    const EMBED_OK = '';
    const EMBED_ERR = '';

    // ===== i18n FULL =====
    const I18N={
      ar:{tbTitle:'Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ â€” Ù…Ù†Ø§Ø³Ø¨Ø© Ù…Ø­Ø¯Ø¯Ø©', eventTop:'Ø§Ù„Ø­Ø¯Ø«', setEvent:'ØªØ¹ÙŠÙŠÙ†/ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¯Ø«', langBtn:'EN',
          ready:'Ø¬Ø§Ù‡Ø²', checking:'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚â€¦', paused:'â¸ï¸ Ù…Ø¤Ù‚Øª', needEvent:'Ø­Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹', ok:'âœ… Ù…Ù‚Ø¨ÙˆÙ„', dupe:'âš ï¸ Ù…Ø³ØªØ®Ø¯Ù… Ø³Ø§Ø¨Ù‚Ù‹Ø§', mismatch:'âŒ ØºÙŠØ± ØªØ§Ø¨Ø¹ Ù„Ù„Ù…Ù†Ø§Ø³Ø¨Ø©', notfound:'âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯',
          start:'â–¶ï¸ ØªØ´ØºÙŠÙ„', stop:'â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù', switch:'ğŸ”„ ØªØ¨Ø¯ÙŠÙ„', torch:'ğŸ’¡ ÙÙ„Ø§Ø´', manual:'Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ', manualBtn:'ØªØ­Ù‚Ù‚', placeholderManual:'SA_001',
          pauseLbl:'ÙØªØ±Ø© Ø§Ù„ØªÙˆÙ‚Ù (Ù…Ù„Ù‘ÙŠ Ø«Ø§Ù†ÙŠØ©)', soundLbl:'Ø§Ù„Ø£ØµÙˆØ§Øª', scanSize:'Ø­Ø¬Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦', regex:'Ù†Ù…Ø· Ø§Ù„ÙƒÙˆØ¯ (Regex)', strict:'ÙˆØ¶Ø¹ ØµØ§Ø±Ù…', strictOn:'Ù…Ø·Ø§Ø¨Ù‚ ÙÙ‚Ø·', strictOff:'Ø§Ù‚Ø¨Ù„ Ø§Ù„ÙƒÙ„',
          last:'Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©', history:'Ø§Ù„Ø³Ø¬Ù„ (Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©)', clear:'Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„', httpsWarn:'âš ï¸ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØªØ·Ù„Ø¨ HTTPS Ø£Ùˆ localhost.'
      },
      en:{tbTitle:'Barcode Scanner â€” Event Locked', eventTop:'Event', setEvent:'Set/Change Event', langBtn:'AR',
          ready:'Ready', checking:'Checkingâ€¦', paused:'â¸ï¸ Paused', needEvent:'Set the event first', ok:'âœ… Accepted', dupe:'âš ï¸ Already used', mismatch:'âŒ Not this event', notfound:'âŒ Not found',
          start:'â–¶ï¸ Start', stop:'â¹ï¸ Stop', switch:'ğŸ”„ Switch', torch:'ğŸ’¡ Torch', manual:'Manual input', manualBtn:'Verify', placeholderManual:'SA_001',
          pauseLbl:'Pause (ms)', soundLbl:'Sounds', scanSize:'Scanner size', regex:'Code pattern (Regex)', strict:'Strict mode', strictOn:'Match only', strictOff:'Accept all',
          last:'Last result', history:'History (per event, local)', clear:'Clear history', httpsWarn:'âš ï¸ Camera requires HTTPS or localhost.'
      }
    }
    let LANG = localStorage.getItem('hs:evscan:lang') || 'ar';

    function applyLang(){
      const t=I18N[LANG]||I18N.ar; document.documentElement.lang=LANG; document.documentElement.dir=(LANG==='ar')?'rtl':'ltr';
      $('#tbTitle').textContent=t.tbTitle; $('#lblEventTop').textContent=t.eventTop; $('#setEventBtn').textContent=t.setEvent; $('#langBtn').textContent=t.langBtn;
      $('#startBtn').textContent=t.start; $('#stopBtn').textContent=t.stop; $('#switchBtn').textContent=t.switch; $('#torchBtn').textContent=t.torch;
      $('#lblPause').textContent=t.pauseLbl; $('#lblSound').textContent=t.soundLbl; $('#lblScanSize').textContent=t.scanSize; $('#lblRegex').textContent=t.regex; $('#lblStrict').textContent=t.strict;
      const strictSel=$('#strictMode'); if(strictSel){ strictSel.options[0].text=t.strictOn; strictSel.options[1].text=t.strictOff; }
      $('#lblLast').textContent=t.last; $('#lblHist').textContent=t.history; $('#clearHist').textContent=t.clear; $('#httpsWarn').textContent=t.httpsWarn;
      $('#lblManual').textContent=t.manual; $('#manualBtn').textContent=t.manualBtn; $('#manualCode')?.setAttribute('placeholder', t.placeholderManual);
      setStatus(t.ready,'#16a34a');
    }

    // ===== Firebase =====
    const cfg={ apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac", authDomain:"hormez-inv.firebaseapp.com", projectId:"hormez-inv" };
    if(!firebase.apps.length){ firebase.initializeApp(cfg); }
    const db=firebase.firestore();

    // ===== Event state =====
    const URL_EVENT = new URLSearchParams(location.search).get('event');
    let EVENT_LOCKED=false, EVENT_NAME='';
    function setEvent(name,locked=false){ EVENT_NAME=String(name||'').trim(); EVENT_LOCKED=!!locked; $('#evTag').textContent=EVENT_NAME||'â€”'; localStorage.setItem('hs:evscan:event',EVENT_NAME); renderHist(); refreshButtons(); }
    function initEvent(){ const saved=localStorage.getItem('hs:evscan:event')||''; if(URL_EVENT){ setEvent(URL_EVENT,true); } else if(saved){ setEvent(saved); } else { promptEvent(); } }
    function promptEvent(){ const name=prompt((LANG==='ar'?'Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© (Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù€ EventName):':'Enter event name (exact EventName):')); if(name){ setEvent(name,false); } }

    // ===== HTTPS guard =====
    function httpsOK(){ const isLocal=['localhost','127.0.0.1'].includes(location.hostname); const ok=location.protocol==='https:'||isLocal; $('#httpsWarn').style.display= ok? 'none':'block'; return ok; }

    // ===== Audio =====
    let audioCtx=null, okAudio=null, errAudio=null;
    function ensureAudio(){ try{ if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); } if(audioCtx.state==='suspended') audioCtx.resume(); }catch{} }

    function loadAudioFromDataURI(){
      // 1) hard-embedded
      if(EMBED_OK){ okAudio=new Audio(EMBED_OK); okAudio.preload='auto'; }
      if(EMBED_ERR){ errAudio=new Audio(EMBED_ERR); errAudio.preload='auto'; }
      // 2) localStorage (persisted after drop)
      try{
        if(!okAudio){ const s=localStorage.getItem('hs:evscan:okData'); if(s) { okAudio=new Audio(s); okAudio.preload='auto'; } }
        if(!errAudio){ const s=localStorage.getItem('hs:evscan:errData'); if(s) { errAudio=new Audio(s); errAudio.preload='auto'; } }
      }catch{}
    }

    function playTone(kind='ok'){
      if($('#soundMode')?.value==='off') return;
      ensureAudio();
      try{ const a=(kind==='ok')? okAudio: errAudio; if(a){ a.currentTime=0; a.play().catch(()=>{}); return; } }catch{}
      // fallback tone
      try{ if(!audioCtx) return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.value=(kind==='ok')?880:220; const now=audioCtx.currentTime; const dur=(kind==='ok')?0.12:0.22; o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0.0001,now); g.gain.exponentialRampToValueAtTime(0.25,now+0.02); g.gain.exponentialRampToValueAtTime(0.0001,now+dur); o.start(); o.stop(now+dur+0.02);}catch{}
    }

    // Drag & drop inline store
    function wireDrop(){
      const dz=document.getElementById('dropZone'); if(!dz) return;
      ['dragover','dragenter'].forEach(ev=> dz.addEventListener(ev, e=>{ e.preventDefault(); dz.style.outline='2px dashed #64748b'; }));
      ['dragleave','drop'].forEach(ev=> dz.addEventListener(ev, e=>{ e.preventDefault(); dz.style.outline=''; }));
      dz.addEventListener('drop', async (e)=>{
        const files=[...e.dataTransfer.files];
        for(const f of files){ const buf=await f.arrayBuffer(); const b64=btoa(String.fromCharCode(...new Uint8Array(buf))); const uri=`data:${f.type||'audio/wav'};base64,${b64}`;
          if(/success|ok/i.test(f.name)) { localStorage.setItem('hs:evscan:okData',uri); okAudio=new Audio(uri); okAudio.preload='auto'; }
          if(/error|err/i.test(f.name))   { localStorage.setItem('hs:evscan:errData',uri); errAudio=new Audio(uri); errAudio.preload='auto'; }
        }
        alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£ØµÙˆØ§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ØŒ Ø³ÙŠÙØ³ØªØ®Ø¯Ù…Ø§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.');
      });
    }

    // ===== History =====
    function hKey(){return `hs:evscan:hist:${EVENT_NAME||'__NONE__'}`}
    function getHist(){ try{return JSON.parse(localStorage.getItem(hKey())||'[]')}catch{return[]} }
    function pushHist(code,msg,good){ const h=getHist(); h.unshift({code,msg,good,at:Date.now()}); localStorage.setItem(hKey(),JSON.stringify(h.slice(0,80))); renderHist(); }
    function renderHist(){ const box=$('#hist'); const t=I18N[LANG]; box.innerHTML=''; const h=getHist(); if(!EVENT_NAME){ box.innerHTML=`<div class="muted">${t.needEvent}</div>`; return;} if(!h.length){ box.innerHTML=`<div class="muted">â€”</div>`; return;} h.forEach(x=>{ const d=document.createElement('div'); d.style.padding='6px'; d.style.borderTop='1px solid rgba(255,255,255,.08)'; d.innerHTML=`<div class="mono">${x.code}</div><div class="muted" style="font-size:12px">${new Date(x.at).toLocaleString(LANG==='ar'?'ar-EG':'en-GB')} â€” ${x.msg}</div>`; box.appendChild(d); }); }

    // ===== UI helpers =====
    function refreshButtons(){ const t=I18N[LANG]; $('#startBtn').textContent=t.start; $('#stopBtn').textContent=t.stop; $('#switchBtn').textContent=t.switch; $('#torchBtn').textContent=t.torch; $('#startBtn').disabled = !httpsOK() || !EVENT_NAME; $('#stopBtn').disabled = !scanning; }
    function setStatus(text,color){ $('#statusText').textContent=text; $('#statusDot').style.background=color; }
    function drawQR(text){ const c=$('#qrCanvas'); if(!c) return; const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,c.width,c.height); if(!text) return; try{ QRCode.toCanvas(c,text,{width:120,margin:1},()=>{});}catch{} }
    function highlight(ok){ const w=$('#scanWrap'); w.classList.remove('ok','err'); w.classList.add(ok?'ok':'err'); const ms=Math.max(300,parseInt($('#pauseMs')?.value||'2000',10)); setTimeout(()=>{ w.classList.remove('ok','err'); }, Math.min(ms, 2500)); }

    // ===== Scanner state =====
    let scanning=false, rafId=null, reader=null, ndet=null; let locked=false;
    function lockPause(){ locked=true; const ms=Math.max(300,parseInt($('#pauseMs')?.value||'2000',10)); setTimeout(()=>{ locked=false; }, ms); }
    function strictOn(){ return ($('#strictMode')?.value||'on')==='on'; }
    function codeRegex(){ try{ return new RegExp($('#codeRegex')?.value||''); }catch{ return null; } }

    async function start(){ ensureAudio(); loadAudioFromDataURI(); if(!EVENT_NAME){ alert(I18N[LANG].needEvent); return; } if(!httpsOK()){ alert(I18N[LANG].httpsWarn); return;} const v=$('#video'); const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}, audio:false}); v.srcObject=stream; await v.play().catch(()=>{}); scanning=true; refreshButtons(); setStatus(I18N[LANG].ready,'#16a34a');
      const zOk=await window.ensureZXing();
      if(zOk && window.ZXing && window.ZXing.BrowserMultiFormatReader){ let r; try{ if(window.ZXing.BarcodeFormat&&window.ZXing.DecodeHintType){ const hints=new Map(); hints.set(window.ZXing.DecodeHintType.POSSIBLE_FORMATS,[window.ZXing.BarcodeFormat.QR_CODE]); r=new window.ZXing.BrowserMultiFormatReader(hints);} else { r=new window.ZXing.BrowserMultiFormatReader(); } }catch{ r=new window.ZXing.BrowserMultiFormatReader(); }
        reader=r; reader.decodeFromVideoDevice(null, v, (res,err)=>{ if(res){ if(locked) return; const text=res.getText?res.getText():(res.text||''); handleRawScan(String(text||'').trim()); } });
      } else if('BarcodeDetector' in window){ ndet=new window.BarcodeDetector({formats:['qr_code']}); const loop=async()=>{ if(!scanning) return; try{ if(!locked){ const arr=await ndet.detect(v); if(arr&&arr.length){ handleRawScan(String(arr[0].rawValue||'').trim()); } } }catch{} rafId=requestAnimationFrame(loop); }; loop(); }
      else { alert('Camera library not loaded'); setStatus('âš ï¸', '#f59e0b'); }
    }

    async function stop(){ try{ if(reader){ try{reader.reset();}catch{} reader=null;} if(rafId){ cancelAnimationFrame(rafId); rafId=null;} const v=$('#video'); if(v.srcObject){ v.srcObject.getTracks().forEach(t=>t.stop()); v.srcObject=null; } }catch{} scanning=false; refreshButtons(); setStatus(I18N[LANG].paused,'#f59e0b'); }

    // ===== Verify =====
    async function verifyAndMark(code){ setStatus(I18N[LANG].checking,'#f59e0b');
      try{
        const q=await db.collection('invites').where('Code','==',code).where('EventName','==',EVENT_NAME).limit(1).get();
        if(q.empty){ show(false, I18N[LANG].mismatch, code); return; }
        const d=q.docs[0]; const data=d.data()||{};
        if(String(data.Status||'').toLowerCase()==='yes'){ show(false, I18N[LANG].dupe, code); }
        else { await d.ref.set({ Status:'yes', scannedAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true}); show(true, I18N[LANG].ok, code); }
      }catch(e){ show(false, e.message||'Error', code); }
    }

    function show(ok, msg, code){ $('#lastCode').textContent=code||'â€”'; $('#lastCode').style.color= ok? '#86efac':'#fca5a5'; $('#lastMsg').textContent=msg||''; drawQR(code||''); pushHist(code,msg,ok); navigator.vibrate?.(ok?60:120); playTone(ok?'ok':'err'); highlight(ok); }

    function onCode(text){ if(!text) return; if(locked) return; lockPause(); verifyAndMark(text); }
    function handleRawScan(raw){ const strict=strictOn(); const re=codeRegex(); if(strict){ if(!re) return; if(!re.test(raw)) return; } onCode(raw); }

    // ===== Wire =====
    document.addEventListener('DOMContentLoaded', ()=>{
      // Lang
      applyLang();
      $('#langBtn').addEventListener('click', ()=>{ LANG=(LANG==='ar')?'en':'ar'; localStorage.setItem('hs:evscan:lang',LANG); applyLang(); renderHist(); });

      // Event
      if(URL_EVENT){ setEvent(URL_EVENT,true); } else { const saved=localStorage.getItem('hs:evscan:event')||''; if(saved){ setEvent(saved); } else { promptEvent(); } }

      // Size control
      const savedW=localStorage.getItem('hs:evscan:scanw'); if(savedW && $('#scanSize')) $('#scanSize').value=savedW; applyScanSize(); $('#scanSize')?.addEventListener('change', applyScanSize);

      // Buttons
      $('#startBtn').addEventListener('click', ()=>{ ensureAudio(); start(); });
      $('#stopBtn').addEventListener('click', stop);
      $('#switchBtn').addEventListener('click', async ()=>{ await stop(); start(); });
      $('#torchBtn').addEventListener('click', ()=>{ alert('Use system torch if available (browser limits).'); });
      $('#clearHist').addEventListener('click', ()=>{ if(!EVENT_NAME) return; localStorage.removeItem(hKey()); renderHist(); });
      $('#manualBtn').addEventListener('click', ()=>{ ensureAudio(); const c=$('#manualCode').value.trim(); if(!c) return; handleRawScan(c); });

      // Drop audio to inline store
      wireDrop();
    });

    function applyScanSize(){ const wrap=$('#scanWrap'); if(!wrap) return; const w=$('#scanSize')?.value||'480'; wrap.style.maxWidth=w+'px'; localStorage.setItem('hs:evscan:scanw',w); }
  })();
  </script>
</body>
</html>
