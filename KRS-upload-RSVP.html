<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KRS RSVP</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#070a14;--card:rgba(255,255,255,.06);--b:rgba(255,255,255,.12);--ink:#eef2ff;--muted:#a8b0c2;--gold:#d6b15e;--ok:#10b981;--no:#ef4444}
    body{margin:0;font-family:"Noto Sans Arabic",system-ui;background:radial-gradient(800px 400px at 50% -10%, rgba(214,177,94,.22), transparent 60%),linear-gradient(180deg,#05070e,#0b1020);color:var(--ink)}
    .wrap{max-width:520px;margin:0 auto;padding:18px}
    .card{background:linear-gradient(180deg,var(--card),rgba(255,255,255,.03));border:1px solid var(--b);border-radius:18px;padding:16px}
    h1{margin:0 0 6px;font-size:18px}
    .muted{color:var(--muted);font-size:12px}
    label{display:block;margin:12px 0 6px;color:var(--muted);font-size:12px}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);color:var(--ink);outline:none}
    input:focus{border-color:rgba(214,177,94,.55);box-shadow:0 0 0 4px rgba(214,177,94,.12)}
    .row{display:flex;gap:10px;margin-top:14px}
    .btn{flex:1;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);color:var(--ink);padding:12px;border-radius:14px;font-weight:900;cursor:pointer}
    .btn.ok{border-color:rgba(16,185,129,.5);background:rgba(16,185,129,.10)}
    .btn.no{border-color:rgba(239,68,68,.5);background:rgba(239,68,68,.10)}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid rgba(214,177,94,.35);background:rgba(214,177,94,.10);color:var(--gold);padding:8px 10px;border-radius:999px;font-weight:900;font-size:12px}
    .err{margin-top:12px;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.22);color:#ffd6d6;padding:10px;border-radius:12px;font-size:12px;display:none}
    .okmsg{margin-top:12px;background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.22);color:#d9ffe9;padding:10px;border-radius:12px;font-size:12px;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="pill">KRS INVITE — RSVP</div>
      <h1 style="margin-top:12px">تأكيد الحضور</h1>
      <div class="muted" id="meta">—</div>

      <label>اسم الضيف</label>
      <input id="name" placeholder="اكتب اسمك">

      <label>رقم الهاتف (يفضل بدون مسافات)</label>
      <input id="phone" placeholder="9715xxxxxxxx" inputmode="numeric">

      <div class="row">
        <button class="btn ok" id="btnYes">✅ أوافق الحضور</button>
        <button class="btn no" id="btnNo">❌ أعتذر</button>
      </div>

      <div class="okmsg" id="okmsg">تم تسجيل ردّك ✅ شكراً لك</div>
      <div class="err" id="err"></div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    const config = {
      apiKey: "AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
      authDomain: "hormez-inv.firebaseapp.com",
      projectId: "hormez-inv",
      storageBucket: "hormez-inv.firebasestorage.app",
      messagingSenderId: "747519941805",
      appId: "1:747519941805:web:468fada2492700e9da3a24"
    };

    const $ = (id)=>document.getElementById(id);
    const params = new URLSearchParams(location.search);
    const code = (params.get("code") || "").trim().toUpperCase();
    const eventName = (params.get("event") || "").trim();

    $("meta").textContent = `الحدث: ${eventName || "—"} | الكود: ${code || "—"}`;

    function showErr(msg){ $("err").style.display = msg ? "block":"none"; $("err").textContent = msg||""; }
    function showOK(v){ $("okmsg").style.display = v ? "block":"none"; }

    if(!firebase.apps.length) firebase.initializeApp(config);
    const db = firebase.firestore();

    async function submitRSVP(newRSVP){
      showErr(""); showOK(false);

      const guestName = ($("name").value || "").trim();
      const phone = ($("phone").value || "").trim().replaceAll(" ","");

      if(!code) return showErr("الرابط ناقص: code");
      if(!eventName) return showErr("الرابط ناقص: event");
      if(!guestName) return showErr("اكتب اسم الضيف");
      if(!phone) return showErr("اكتب رقم الهاتف");

      try{
        // docId = code (لأن صفحتك تولد doc(code))
        const ref = db.collection("invites").doc(code);

        // نتأكد إن الدعوة موجودة + نفس الحدث
        const snap = await ref.get();
        if(!snap.exists) return showErr("هذا الكود غير موجود");
        const data = snap.data() || {};
        if((data.EventName||"") !== eventName) return showErr("الكود لا يطابق اسم الحدث");

        await ref.set({
          GuestName: guestName,
          Phone: phone,
          RSVP: newRSVP,
          RSVPAt: new Date()
        }, { merge:true });

        showOK(true);
        $("btnYes").disabled = true;
        $("btnNo").disabled = true;

      }catch(e){
        showErr("فشل الحفظ: " + (e.message || e));
      }
    }

    $("btnYes").onclick = ()=>submitRSVP("confirmed");
    $("btnNo").onclick  = ()=>submitRSVP("declined");
  </script>
</body>
</html>
