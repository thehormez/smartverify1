<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>توليد الأكواد وربطها — KRS</title>
  <style>
    :root{--bg:#0b1020;--ink:#e5e7eb;--muted:#9aa4b2;--card:#0e172a;--b:#233047}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;border-radius:10px;background:#111;border:1px solid #333;display:grid;place-items:center}
    .logo span{font-weight:900;color:#ffd700}
    .muted{color:var(--muted)}
    .input, .select, .ta{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:var(--ink)}
    .btn{appearance:none;border:1px solid #334155;background:#0b1220;color:var(--ink);border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:#0d1528}
    .btn.primary{border-color:rgba(255,215,0,.25)}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #243047;background:#0b1220;border-radius:10px;padding:8px 10px}
    .kpi{display:flex;gap:12px;align-items:center}
    .kpi .n{font-size:22px;font-weight:900}
    .grid{display:grid;gap:12px}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    .grid-2{grid-template-columns:1fr 1fr}
    @media(max-width:900px){.grid-3{grid-template-columns:1fr}.grid-2{grid-template-columns:1fr}}
    .qr{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .qr .box{background:#0b1220;border:1px solid #334155;border-radius:12px;padding:10px;text-align:center}
    .qr canvas{display:block;margin:0 auto}
    .log{white-space:pre-wrap;background:#0b1220;border:1px solid #334155;border-radius:12px;padding:10px;font-size:12px;max-height:260px;overflow:auto}
    .ok{color:#86efac} .err{color:#fca5a5}
    .banner{display:none;margin:10px 0;padding:10px;border-radius:10px;border:1px solid #7f1d1d;background:#450a0a;color:#fecaca}
    .banner.show{display:block}
    .disabled{opacity:.55;pointer-events:none}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="row" style="align-items:center">
      <div class="brand">
        <div class="logo"><span>KRS</span></div>
        <div>
          <div class="muted" style="font-size:12px">KRS INVITE</div>
          <div style="font-weight:800">توليد الأكواد وربطها بالفايربيس</div>
          <div class="muted" style="font-size:12px">صيغة الأكواد: PREFIX_001 (مثال: KH_001) + حفظ في invites + توليد QR مع اسم الكود داخل الصورة</div>
        </div>
      </div>

      <div style="margin-inline-start:auto" class="row">
        <button id="langBtn" class="btn" type="button">AR</button>
        <button id="selfTest" class="btn" type="button">تشغيل اختبار</button>

        <!-- Auth -->
        <button id="loginBtn" class="btn primary" type="button">تسجيل دخول Google</button>
        <button id="logoutBtn" class="btn" type="button" style="display:none">خروج</button>
        <span id="who" class="pill" style="font-size:12px">غير مسجل</span>
      </div>
    </div>

    <div id="fatalBanner" class="banner">⚠️ حدث خطأ منع تشغيل الأزرار. جرّب فتح الصفحة عبر HTTPS أو تعطيل إضافات الحظر. تفاصيل الخطأ ستظهر في السجل.</div>

    <!-- Controls -->
    <div class="grid grid-3" style="margin-top:12px" id="controlsWrap">
      <div class="card">
        <div class="muted" id="lblEvent" style="font-size:12px">الحدث</div>
        <input id="eventName" class="input" placeholder="مثال: زفاف خالد" value="زفاف سعيد" />
      </div>
      <div class="card">
        <div class="muted" id="lblPrefix" style="font-size:12px">بادئة الكود (Prefix)</div>
        <input id="prefix" class="input" placeholder="مثال: KH" value="KH" />
      </div>
      <div class="card">
        <div class="muted" id="lblPad" style="font-size:12px">عدد الأرقام (Padding)</div>
        <input id="pad" class="input" type="number" value="3" min="1" max="6" />
      </div>
      <div class="card">
        <div class="muted" id="lblStart" style="font-size:12px">من (Start)</div>
        <input id="start" class="input" type="number" value="1" />
      </div>
      <div class="card">
        <div class="muted" id="lblEnd" style="font-size:12px">إلى (End)</div>
        <input id="end" class="input" type="number" value="200" />
      </div>
      <div class="card" style="display:flex;align-items:flex-end;gap:8px">
        <button id="btnGenerate" class="btn" style="width:100%" type="button">توليد → تأكيد → حفظ & QR</button>
      </div>
    </div>

    <!-- Manual list -->
    <div class="card" style="margin-top:12px" id="listWrap">
      <div class="muted" id="lblList" style="font-size:12px">قائمة أكواد مخصصة (سطر لكل كود)، اختياري</div>
      <textarea id="list" class="ta" rows="4" placeholder="KH_001\nKH_002\nKH_003"></textarea>
      <div class="row" style="margin-top:8px">
        <button id="btnSaveList" class="btn" type="button">حفظ القائمة في Firebase (ثم توليد QR)</button>
        <button id="btnRenderQR" class="btn" type="button">توليد QR للأكواد المعروضة</button>
        <button id="btnZip" class="btn" type="button">تحميل كل صور QR كملف ZIP</button>
      </div>
      <div class="muted" style="font-size:12px;margin-top:8px">
        ملاحظة: سيتم إنشاء المستند داخل <b>invites</b> بالـ docId = نفس الكود (مثال: KH_001)
        مع الحقول الافتراضية: RSVP=pending, GuestName="", Phone=""
      </div>
    </div>

    <!-- KPIs & Log -->
    <div class="grid grid-2" style="margin-top:12px">
      <div class="card">
        <div class="muted" style="font-size:12px">النتيجة</div>
        <div class="kpi"><div>تم الإنشاء:</div><div class="n" id="kpiCreated">0</div></div>
        <div class="kpi"><div>أخطاء:</div><div class="n" id="kpiErrors">0</div></div>
      </div>
      <div class="card">
        <div class="muted" style="font-size:12px">السجل</div>
        <div id="log" class="log"></div>
      </div>
    </div>

    <!-- QR Grid -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="align-items:center">
        <div class="muted" id="lblQR" style="font-size:12px">أكواد QR المُولَّدة</div>
        <div class="pill" style="margin-inline-start:auto">تلميح: اضغط على صورة QR للتنزيل</div>
      </div>
      <div id="qrGrid" class="qr" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- 1) Robust QRCode loader with CDN fallbacks (non-module) -->
  <script>
    (function(){
      const CANDIDATES = [
        'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js',
        'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js',
        'https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js'
      ];
      function loadScript(src){
        return new Promise((res,rej)=>{
          const s=document.createElement('script');
          s.src=src; s.async=true;
          s.onload=()=>res(src);
          s.onerror=()=>rej(src);
          document.head.appendChild(s);
        });
      }
      window.__ensureQRCode = async function(){
        if(window.QRCode && window.QRCode.CorrectLevel) return true;
        for(const url of CANDIDATES){
          try{
            await loadScript(url);
            if(window.QRCode && window.QRCode.CorrectLevel) return true;
          }catch(_){}
        }
        return !!(window.QRCode && window.QRCode.CorrectLevel);
      };
    })();
  </script>

  <!-- 2) JSZip on demand -->
  <script>
    async function ensureZip(){
      if(window.JSZip) return window.JSZip;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';
        s.onload=()=>res();
        s.onerror=rej;
        document.head.appendChild(s);
      });
      return window.JSZip;
    }
  </script>

  <!-- 3) Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <!-- 4) Main logic -->
  <script>
    (function(){
      const $ = (s,root=document)=>root.querySelector(s);
      const logBox = ()=> $('#log');

      function log(m, cls){
        const box=logBox(); if(!box) return;
        const d=document.createElement('div');
        d.textContent=m;
        if(cls) d.className=cls;
        box.appendChild(d);
        box.scrollTop=box.scrollHeight;
      }

      function pad(n, w){ n=String(n); return n.length>=w ? n : '0'.repeat(w-n.length)+n; }
      function parseList(){ return (($('#list')?.value)||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }

      function setKPIs({created=0,errors=0}){
        const c=$('#kpiCreated'); const e=$('#kpiErrors');
        if(c) c.textContent=created;
        if(e) e.textContent=errors;
      }

      function downloadCanvasAsPng(canvas, filename){
        const a=document.createElement('a');
        a.download=filename;
        a.href=canvas.toDataURL('image/png');
        a.click();
      }

      // === Compose QR + label into one image ===
      function makeLabeledCanvas(qrCanvas, label){
        const qrW = qrCanvas.width, qrH = qrCanvas.height;
        const padOuter = 14;
        const gap = 8;
        const textH = 28;
        const W = qrW + padOuter*2;
        const H = qrH + padOuter*2 + gap + textH;

        const out = document.createElement('canvas');
        out.width = W; out.height = H;
        const ctx = out.getContext('2d');

        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0,0,W,H);

        const qrX = Math.floor((W - qrW)/2);
        const qrY = padOuter;
        ctx.drawImage(qrCanvas, qrX, qrY);

        ctx.fillStyle = '#000000';
        ctx.font = 'bold 16px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const textY = qrY + qrH + gap + Math.floor(textH/2);
        ctx.fillText(label, Math.floor(W/2), textY);

        return out;
      }

      async function renderQR(codes){
        const ok = await (window.__ensureQRCode ? window.__ensureQRCode() : false);
        if(!ok){
          alert('تعذر تحميل مكتبة QR. تحقق من الإنترنت أو جرب مرة أخرى.');
          return;
        }
        const grid = $('#qrGrid'); if(!grid) return;
        grid.innerHTML='';

        for(const code of codes){
          const box=document.createElement('div'); box.className='box';
          const title=document.createElement('div');
          title.className='muted';
          title.style.fontSize='12px';
          title.style.marginBottom='8px';
          title.textContent = code;
          box.appendChild(title);

          const holder=document.createElement('div');
          holder.style.width='170px';
          holder.style.margin='0 auto';
          box.appendChild(holder);

          grid.appendChild(box);

          // raw QR inside inner div
          const inner = document.createElement('div');
          holder.appendChild(inner);

          new window.QRCode(inner, {
            text: code,
            width:160,
            height:160,
            correctLevel: window.QRCode.CorrectLevel.M
          });

          await new Promise(r=>setTimeout(r,30));
          const raw = inner.querySelector('canvas');

          if(raw){
            const labeled = makeLabeledCanvas(raw, code);
            holder.innerHTML='';
            holder.appendChild(labeled);
            labeled.style.cursor='pointer';
            labeled.title='اضغط للتنزيل';
            labeled.addEventListener('click', ()=>downloadCanvasAsPng(labeled, `${code}.png`));
          } else {
            log(`❌ لم يتم العثور على كانفس QR لـ ${code}`,'err');
          }
        }
      }

      // ===== Firebase & Auth =====
      const firebaseConfig = {
        apiKey: "AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
        authDomain: "hormez-inv.firebaseapp.com",
        projectId: "hormez-inv",
        storageBucket: "hormez-inv.firebasestorage.app",
        messagingSenderId: "747519941805",
        appId: "1:747519941805:web:468fada2492700e9da3a24"
      };

      let db, auth;

      function lockUI(locked){
        const c = document.getElementById('controlsWrap');
        const l = document.getElementById('listWrap');
        if(c) c.classList.toggle('disabled', locked);
        if(l) l.classList.toggle('disabled', locked);
      }

async function ensureLogin(){
  if(auth.currentUser) return auth.currentUser;

  // 1) حاول Google أولاً (لو مفعّل)
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
    return auth.currentUser;
  }catch(e){
    // 2) fallback: Anonymous (يخلي الصفحة تشتغل حتى لو Google غير مفعّل)
    try{
      await auth.signInAnonymously();
      return auth.currentUser;
    }catch(e2){
      // لو حتى Anonymous فشل (نادر) ارجع برسالة واضحة
      throw new Error(
        "تعذر تسجيل الدخول (Google و Anonymous).\n" +
        "Google: " + (e?.message || e) + "\n" +
        "Anonymous: " + (e2?.message || e2)
      );
    }
  }
}

      // ===== Firestore write =====
      async function upsertCode(code, eventName){
        try{
          // docId = code (KH_001)
          await db.collection('invites').doc(code).set({
            Code: code,
            Status: "no",
            EventName: eventName,

            // NEW: defaults for RSVP & guest data
            RSVP: "pending",
            RSVPAt: null,
            GuestName: "",
            Phone: ""
          }, { merge:true });

          return {ok:true};
        }catch(err){
          return {ok:false, msg: err.message};
        }
      }

      function wire(){
        // Language toggle (simple)
        let LANG = localStorage.getItem('krs:gen:lang') || 'ar';
        function applyLang(){
          const btn=$('#langBtn');
          if(btn) btn.textContent = (LANG==='ar'? 'EN':'AR');
          document.documentElement.lang = LANG;
          document.documentElement.dir  = (LANG==='ar')?'rtl':'ltr';
        }
        $('#langBtn')?.addEventListener('click', ()=>{
          LANG = (LANG==='ar')?'en':'ar';
          localStorage.setItem('krs:gen:lang', LANG);
          applyLang();
        });
        applyLang();

        // Auth UI
        auth.onAuthStateChanged(u=>{
          const who = document.getElementById('who');
          const loginBtn = document.getElementById('loginBtn');
          const logoutBtn = document.getElementById('logoutBtn');

          if(who) who.textContent = u ? (u.email || u.uid) : "غير مسجل";
          if(loginBtn) loginBtn.style.display = u ? "none" : "inline-block";
          if(logoutBtn) logoutBtn.style.display = u ? "inline-block" : "none";

          // اقفل الأزرار لو مو مسجل
          lockUI(!u);
          if(u) log("✅ جاهز — تم تسجيل الدخول","ok");
        });

        document.getElementById('loginBtn')?.addEventListener('click', async ()=>{
          try{
            await ensureLogin();
          }catch(e){
            log("❌ فشل تسجيل الدخول: " + (e?.message || e), "err");
            alert("فشل تسجيل الدخول. تأكد من تفعيل Google Sign-in وإضافة الدومين ضمن Authorized domains.");
          }
        });

        document.getElementById('logoutBtn')?.addEventListener('click', async ()=>{
          try{
            await auth.signOut();
            log("تم تسجيل الخروج","ok");
          }catch(e){
            log("❌ فشل الخروج: " + (e?.message || e), "err");
          }
        });

        // Self test
        $('#selfTest')?.addEventListener('click', async ()=>{
          try{
            const ok = await (window.__ensureQRCode ? window.__ensureQRCode() : false);
            log(ok? '✔ مكتبة QR جاهزة' : '✘ فشل تحميل مكتبة QR', ok? 'ok':'err');
            if(ok){
              const tmp=document.createElement('div');
              tmp.style.width='120px'; tmp.style.height='120px';
              document.body.appendChild(tmp);
              new window.QRCode(tmp,{text:'TEST_001',width:120,height:120});
              log('✔ توليد QR تجريبي نجح','ok');
              setTimeout(()=>tmp.remove(),800);
            }
          }catch(e){
            log('✘ فشل الاختبار: '+(e?.message||e),'err');
          }
        });

        // Generate range
        $('#btnGenerate')?.addEventListener('click', async ()=>{
          try{
            await ensureLogin(); // ✅ مهم للصلاحيات

            const eventName = ($('#eventName')?.value||'').trim();
            const prefix = String($('#prefix')?.value||'').trim().toUpperCase();
            const start = parseInt($('#start')?.value,10);
            const end   = parseInt($('#end')?.value,10);
            const digits = Math.max(1, Math.min(6, parseInt($('#pad')?.value,10)||3));

            if(!eventName || !prefix || !start || !end){
              alert('أدخل: الحدث + البادئة + البداية + النهاية');
              return;
            }
            if(end < start){
              alert('النهاية يجب أن تكون ≥ البداية');
              return;
            }

            const codes=[];
            for(let i=start;i<=end;i++){
              codes.push(`${prefix}_${pad(i,digits)}`);
            }

            if(!confirm(`سيتم إنشاء ${codes.length} دعوة للحدث "${eventName}" بصيغة ${prefix}_XXX.\nمتابعة؟`)) return;

            log('جاري الحفظ...'); let created=0, errors=0;

            for(const code of codes){
              const r = await upsertCode(code, eventName);
              if(r.ok){
                created++;
                log(`✅ ${code}`,'ok');
              }else{
                errors++;
                log(`❌ ${code} — ${r.msg}`,'err');
              }
            }

            setKPIs({created, errors});
            if($('#list')) $('#list').value = codes.join('\n');

            await renderQR(codes);
            log('تم ✅','ok');
          }catch(e){
            log('✘ خطأ: '+(e?.message||e),'err');
          }
        });

        // Save manual list
        $('#btnSaveList')?.addEventListener('click', async ()=>{
          try{
            await ensureLogin(); // ✅ مهم للصلاحيات

            const eventName = ($('#eventName')?.value||'').trim();
            if(!eventName){ alert('أدخل اسم الحدث'); return; }

            const list = parseList().map(x=>x.toUpperCase());
            if(!list.length){ alert('أدخل أكواد في القائمة'); return; }

            if(!confirm(`سيتم حفظ ${list.length} كود للحدث "${eventName}".\nمتابعة؟`)) return;

            let created=0, errors=0;
            for(const code of list){
              const r = await upsertCode(code, eventName);
              if(r.ok){ created++; log(`✅ ${code}`,'ok'); }
              else { errors++; log(`❌ ${code} — ${r.msg}`,'err'); }
            }

            setKPIs({created, errors});
            await renderQR(list);
          }catch(e){
            log('✘ خطأ: '+(e?.message||e),'err');
          }
        });

        // Render QR only
        $('#btnRenderQR')?.addEventListener('click', async ()=>{
          try{
            const list = parseList().map(x=>x.toUpperCase());
            if(!list.length){ alert('ضع الأكواد داخل القائمة أولاً'); return; }
            await renderQR(list);
          }catch(e){
            log('✘ QR: '+(e?.message||e),'err');
          }
        });

        // ZIP download (labels are inside canvas already)
        $('#btnZip')?.addEventListener('click', async ()=>{
          try{
            const cvs = Array.from(document.querySelectorAll('#qrGrid canvas'));
            if(!cvs.length){ alert('لا توجد صور QR معروضة'); return; }

            await ensureZip();
            const zip = new window.JSZip();

            let i=1;
            for(const cv of cvs){
              // اسم الملف: خذ من أقرب عنوان (div.muted) داخل نفس box
              const box = cv.closest('.box');
              const title = (box?.querySelector('.muted')?.textContent || `code_${i}`).trim();
              const data = cv.toDataURL('image/png').split(',')[1];
              zip.file(`${title}.png`, data, {base64:true});
              i++;
            }

            const blob = await zip.generateAsync({type:'blob'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href=url;
            a.download='qr-codes.zip';
            a.click();
            URL.revokeObjectURL(url);
          }catch(e){
            log('✘ ZIP: '+(e?.message||e),'err');
          }
        });
      }

      function init(){
        try{
          if(!window.firebase?.apps?.length){
            window.firebase.initializeApp(firebaseConfig);
          }
          db = window.firebase.firestore();
          auth = window.firebase.auth();

          // اقفل الأزرار لين يسجل دخول
          lockUI(true);
          wire();

          log("جاهز. اضغط تسجيل دخول Google أولاً ✅","ok");
        }catch(e){
          document.getElementById('fatalBanner')?.classList.add('show');
          log('✘ فشل تهيئة Firebase/الصفحة: '+(e?.message||e),'err');
        }
      }

      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', init);
      }else{
        init();
      }
    })();
  </script>
</body>
</html>
