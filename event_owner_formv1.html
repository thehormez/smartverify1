<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدخال بيانات المدعوين للحدث</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary-color: #007bff; /* أزرق */
            --accent-color: #28a745; /* أخضر */
            --bg-light: #f8f9fa;
        }
        
        body { 
            font-family: 'Noto Sans Arabic', Tahoma, Arial, sans-serif; 
            background-color: var(--bg-light); 
            padding: 50px 20px; 
            text-align: center;
        }
        
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background-color: #ffffff; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); 
        }
        
        h1 { 
            color: var(--primary-color); 
            margin-bottom: 25px; 
        }

        .upload-section {
            border: 2px dashed #ccc;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #fff;
        }
        
        input[type="file"] {
            display: block;
            margin: 15px auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
        
        button { 
            padding: 12px 25px; 
            cursor: pointer; 
            border: none; 
            border-radius: 6px; 
            font-weight: 700; 
            background-color: var(--accent-color); 
            color: white;
            transition: background-color 0.3s;
        }

        button:hover { 
            background-color: #1e7e34;
        }

        .instructions {
            margin-top: 20px;
            text-align: right;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .instructions h3 {
            color: var(--primary-color);
        }

        .output-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background-color: #d4edda;
            color: #155724;
            display: none;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>📝 إدخال قائمة المدعوين للحدث</h1>
    <p>مرحباً، للمتابعة يرجى اتباع الخطوات التالية لتزويد المنظم بأسماء وأرقام المدعوين.</p>

    <div class="upload-section">
        <h3>الخطوة 1: استخراج قائمة جهات الاتصال</h3>
        <div class="instructions">
            <ol style="text-align: right; margin-right: 20px;">
                <li>في تطبيق جهات الاتصال بهاتفك، حدد جميع الأسماء التي ترغب في دعوتها.</li>
                <li>استخدم خيار **"تصدير"** أو **"مشاركة جهات الاتصال"** واحفظها كملف **VCF**.</li>
                <li>ارفع الملف أدناه.</li>
            </ol>
        </div>
        
        <input type="file" id="vcfUpload" accept=".vcf" onchange="checkFile(this.files)">
        <p style="color: red; font-weight: bold;">⚠️ يجب أن يكون الملف بصيغة VCF.</p>
    </div>

    <div class="upload-section" id="processingStep" style="display: none;">
        <h3>الخطوة 2: تجهيز الملف للارسال</h3>
        <p>بعد رفع ملف VCF، اضغط على الزر لتجهيز القائمة في صيغة CSV (العدد الافتراضي للدعوات: 1).</p>
        <button onclick="processAndDownload()">⬇️ تجهيز وتنزيل قائمة المدعوين (CSV)</button>
        <div class="output-message" id="successMessage"></div>
    </div>
</div>

<script>
    let rawVcfData = null;
    let eventName = 'Guests_List'; // اسم افتراضي للملف

    function checkFile(files) {
        if (files.length === 0) {
            document.getElementById('processingStep').style.display = 'none';
            return;
        }
        const file = files[0];
        if (file.name.toLowerCase().endsWith('.vcf')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                rawVcfData = e.target.result;
                document.getElementById('processingStep').style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
                alert('تم تحميل ملف VCF بنجاح. يرجى الضغط على زر التنزيل في الخطوة الثانية.');
            };
            reader.readAsText(file);
        } else {
            alert('خطأ: يرجى اختيار ملف بصيغة VCF فقط.');
            document.getElementById('processingStep').style.display = 'none';
        }
    }

    function processAndDownload() {
        if (!rawVcfData) {
            alert('يرجى أولاً رفع ملف VCF في الخطوة الأولى.');
            return;
        }

        const lines = rawVcfData.split(/\r\n|\n/);
        let contacts = [];
        let currentContact = null;
        
        // ******************** دالة تحليل VCF ********************
        lines.forEach(line => {
            if (line.includes('BEGIN:VCARD')) {
                currentContact = { name: '', phone: '', totalNeeded: 1 }; // تعيين 1 كعدد افتراضي
            } 
            else if (line.startsWith('FN:') || line.startsWith('N:')) {
                if (currentContact && currentContact.name === '') {
                    let namePart = line.substring(line.indexOf(':') + 1);
                    if (line.startsWith('N:')) {
                        // محاولة معالجة صيغة N: LAST;FIRST;;;
                        namePart = namePart.split(';').reverse().join(' ').trim().replace(/ {2,}/g, ' ');
                    }
                    currentContact.name = namePart.replace(/;/g, ' ').trim();
                }
            } 
            else if (line.startsWith('TEL;')) {
                if (currentContact && currentContact.phone === '') {
                    let phonePart = line.substring(line.indexOf(':') + 1);
                    phonePart = phonePart.replace(/[^0-9+]/g, '').trim();
                    
                    if (phonePart.startsWith('00966')) {
                        phonePart = '966' + phonePart.substring(5);
                    } else if (phonePart.startsWith('05') && phonePart.length === 10) {
                        phonePart = '966' + phonePart;
                    }

                    currentContact.phone = phonePart;
                }
            } 
            else if (line.includes('END:VCARD')) {
                if (currentContact && currentContact.name && currentContact.phone) {
                    contacts.push(currentContact);
                }
                currentContact = null;
            }
        });
        // ********************************************************
        
        if (contacts.length === 0) {
            alert('لم يتم العثور على أي أسماء وأرقام هواتف صالحة في ملف VCF.');
            return;
        }

        // تحويل البيانات إلى صيغة CSV
        const header = ['name', 'phone', 'totalNeeded'];
        const dataRows = contacts.map(c => [
            `"${c.name}"`, // وضع علامات اقتباس حول الاسم للتعامل مع الفواصل
            c.phone, 
            c.totalNeeded
        ]);
        
        const csvContent = [
            header.join(','),
            ...dataRows.map(e => e.join(','))
        ].join('\n');
        
        // تنزيل الملف
        const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const fileName = `Guests_For_Organizer_${new Date().toISOString().slice(0, 10)}.csv`;
        saveAs(blob, fileName);
        
        // رسالة النجاح
        const messageBox = document.getElementById('successMessage');
        messageBox.textContent = `✅ تم تجهيز ${contacts.length} ضيف. تم تنزيل الملف بنجاح باسم "${fileName}". يرجى إرسال هذا الملف إلى المنظم.`;
        messageBox.style.display = 'block';
    }
</script>
</body>
</html>
