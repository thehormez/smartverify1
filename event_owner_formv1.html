<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ† Ù„Ù„Ø­Ø¯Ø«</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary-color: #007bff; /* Ø£Ø²Ø±Ù‚ */
            --accent-color: #28a745; /* Ø£Ø®Ø¶Ø± */
            --bg-light: #f8f9fa;
        }
        
        body { 
            font-family: 'Noto Sans Arabic', Tahoma, Arial, sans-serif; 
            background-color: var(--bg-light); 
            padding: 50px 20px; 
            text-align: center;
        }
        
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background-color: #ffffff; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); 
        }
        
        h1 { 
            color: var(--primary-color); 
            margin-bottom: 25px; 
        }

        .upload-section {
            border: 2px dashed #ccc;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #fff;
        }
        
        input[type="file"] {
            display: block;
            margin: 15px auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
        
        button { 
            padding: 12px 25px; 
            cursor: pointer; 
            border: none; 
            border-radius: 6px; 
            font-weight: 700; 
            background-color: var(--accent-color); 
            color: white;
            transition: background-color 0.3s;
        }

        button:hover { 
            background-color: #1e7e34;
        }

        .instructions {
            margin-top: 20px;
            text-align: right;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .instructions h3 {
            color: var(--primary-color);
        }

        .output-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background-color: #d4edda;
            color: #155724;
            display: none;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ† Ù„Ù„Ø­Ø¯Ø«</h1>
    <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙŠØ±Ø¬Ù‰ Ø§ØªØ¨Ø§Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„ØªØ²ÙˆÙŠØ¯ Ø§Ù„Ù…Ù†Ø¸Ù… Ø¨Ø£Ø³Ù…Ø§Ø¡ ÙˆØ£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†.</p>

    <div class="upload-section">
        <h3>Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‚Ø§Ø¦Ù…Ø© Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h3>
        <div class="instructions">
            <ol style="text-align: right; margin-right: 20px;">
                <li>ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‡Ø§ØªÙÙƒØŒ Ø­Ø¯Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØªÙŠ ØªØ±ØºØ¨ ÙÙŠ Ø¯Ø¹ÙˆØªÙ‡Ø§.</li>
                <li>Ø§Ø³ØªØ®Ø¯Ù… Ø®ÙŠØ§Ø± **"ØªØµØ¯ÙŠØ±"** Ø£Ùˆ **"Ù…Ø´Ø§Ø±ÙƒØ© Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„"** ÙˆØ§Ø­ÙØ¸Ù‡Ø§ ÙƒÙ…Ù„Ù **VCF**.</li>
                <li>Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø£Ø¯Ù†Ø§Ù‡.</li>
            </ol>
        </div>
        
        <input type="file" id="vcfUpload" accept=".vcf" onchange="checkFile(this.files)">
        <p style="color: red; font-weight: bold;">âš ï¸ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© VCF.</p>
    </div>

    <div class="upload-section" id="processingStep" style="display: none;">
        <h3>Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø§Ø±Ø³Ø§Ù„</h3>
        <p>Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ù…Ù„Ù VCFØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ ØµÙŠØºØ© CSV (Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø¯Ø¹ÙˆØ§Øª: 1).</p>
        <button onclick="processAndDownload()">â¬‡ï¸ ØªØ¬Ù‡ÙŠØ² ÙˆØªÙ†Ø²ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ† (CSV)</button>
        <div class="output-message" id="successMessage"></div>
    </div>
</div>

<script>
    let rawVcfData = null;
    let eventName = 'Guests_List'; // Ø§Ø³Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù…Ù„Ù

    function checkFile(files) {
        if (files.length === 0) {
            document.getElementById('processingStep').style.display = 'none';
            return;
        }
        const file = files[0];
        if (file.name.toLowerCase().endsWith('.vcf')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                rawVcfData = e.target.result;
                document.getElementById('processingStep').style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
                alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù VCF Ø¨Ù†Ø¬Ø§Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªÙ†Ø²ÙŠÙ„ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©.');
            };
            reader.readAsText(file);
        } else {
            alert('Ø®Ø·Ø£: ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨ØµÙŠØºØ© VCF ÙÙ‚Ø·.');
            document.getElementById('processingStep').style.display = 'none';
        }
    }

    function processAndDownload() {
        if (!rawVcfData) {
            alert('ÙŠØ±Ø¬Ù‰ Ø£ÙˆÙ„Ø§Ù‹ Ø±ÙØ¹ Ù…Ù„Ù VCF ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰.');
            return;
        }

        const lines = rawVcfData.split(/\r\n|\n/);
        let contacts = [];
        let currentContact = null;
        
        // ******************** Ø¯Ø§Ù„Ø© ØªØ­Ù„ÙŠÙ„ VCF ********************
        lines.forEach(line => {
            if (line.includes('BEGIN:VCARD')) {
                currentContact = { name: '', phone: '', totalNeeded: 1 }; // ØªØ¹ÙŠÙŠÙ† 1 ÙƒØ¹Ø¯Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ
            } 
            else if (line.startsWith('FN:') || line.startsWith('N:')) {
                if (currentContact && currentContact.name === '') {
                    let namePart = line.substring(line.indexOf(':') + 1);
                    if (line.startsWith('N:')) {
                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙŠØºØ© N: LAST;FIRST;;;
                        namePart = namePart.split(';').reverse().join(' ').trim().replace(/ {2,}/g, ' ');
                    }
                    currentContact.name = namePart.replace(/;/g, ' ').trim();
                }
            } 
            else if (line.startsWith('TEL;')) {
                if (currentContact && currentContact.phone === '') {
                    let phonePart = line.substring(line.indexOf(':') + 1);
                    phonePart = phonePart.replace(/[^0-9+]/g, '').trim();
                    
                    if (phonePart.startsWith('00966')) {
                        phonePart = '966' + phonePart.substring(5);
                    } else if (phonePart.startsWith('05') && phonePart.length === 10) {
                        phonePart = '966' + phonePart;
                    }

                    currentContact.phone = phonePart;
                }
            } 
            else if (line.includes('END:VCARD')) {
                if (currentContact && currentContact.name && currentContact.phone) {
                    contacts.push(currentContact);
                }
                currentContact = null;
            }
        });
        // ********************************************************
        
        if (contacts.length === 0) {
            alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø£Ø³Ù…Ø§Ø¡ ÙˆØ£Ø±Ù‚Ø§Ù… Ù‡ÙˆØ§ØªÙ ØµØ§Ù„Ø­Ø© ÙÙŠ Ù…Ù„Ù VCF.');
            return;
        }

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ ØµÙŠØºØ© CSV
        const header = ['name', 'phone', 'totalNeeded'];
        const dataRows = contacts.map(c => [
            `"${c.name}"`, // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù‚ØªØ¨Ø§Ø³ Ø­ÙˆÙ„ Ø§Ù„Ø§Ø³Ù… Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ÙÙˆØ§ØµÙ„
            c.phone, 
            c.totalNeeded
        ]);
        
        const csvContent = [
            header.join(','),
            ...dataRows.map(e => e.join(','))
        ].join('\n');
        
        // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
        const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const fileName = `Guests_For_Organizer_${new Date().toISOString().slice(0, 10)}.csv`;
        saveAs(blob, fileName);
        
        // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        const messageBox = document.getElementById('successMessage');
        messageBox.textContent = `âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² ${contacts.length} Ø¶ÙŠÙ. ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø§Ø³Ù… "${fileName}". ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†Ø¸Ù….`;
        messageBox.style.display = 'block';
    }
</script>
</body>
</html>
