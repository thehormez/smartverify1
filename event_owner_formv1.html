<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù„ÙƒØ±ÙˆØª (Ù…Ø¹ Ø¯Ø¹Ù… VCF)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary-color: #3b5998; /* Ø£Ø²Ø±Ù‚ Ø¯Ø§ÙƒÙ† Ø§Ø­ØªØ±Ø§ÙÙŠ */
            --accent-color: #ff8c00; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ/Ø°Ù‡Ø¨ÙŠ Ù„Ù„Ø§ÙƒØ´Ù† */
            --success-color: #28a745; /* Ø£Ø®Ø¶Ø± Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨ */
            --danger-color: #dc3545; /* Ø£Ø­Ù…Ø± Ù„Ù„Ø­Ø°Ù */
            --bg-light: #f8f9fa; /* Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© */
            --text-dark: #343a40; /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
        }
        
        body { 
            font-family: 'Noto Sans Arabic', Tahoma, Arial, sans-serif; 
            background-color: var(--bg-light); 
            padding: 30px 10px; 
            color: var(--text-dark);
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background-color: #ffffff; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); 
        }
        
        h1 { 
            text-align: center; 
            color: var(--primary-color); 
            margin-bottom: 25px; 
            border-bottom: 3px solid var(--accent-color);
            padding-bottom: 15px;
        }
        
        h2 { 
            color: var(--primary-color); 
            margin-top: 40px; 
            font-weight: 700;
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„ÙƒØ§Ø±Ø¯Ø§Øª / Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª */
        .card-section {
            border: 1px solid #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            align-items: center;
        }
        
        .event-info-grid {
             display: grid;
             grid-template-columns: 2fr 1fr 1fr;
             gap: 15px;
             align-items: center;
        }

        .form-control, textarea { 
            padding: 10px; 
            border: 1px solid #ced4da; 
            border-radius: 6px; 
            transition: border-color 0.3s; 
            box-sizing: border-box;
            width: 100%;
        }
        
        .form-control:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(59, 89, 152, 0.25);
            outline: none;
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        button { 
            padding: 10px 20px; 
            margin: 5px 0; 
            cursor: pointer; 
            border: none; 
            border-radius: 6px; 
            font-weight: 700; 
            transition: all 0.3s ease; 
            min-width: 120px;
        }

        .btn-action { background-color: var(--accent-color); color: white; }
        .btn-action:hover { background-color: #e07b00; transform: translateY(-1px); }
        
        .btn-save { background-color: #6c757d; color: white; }
        .btn-save:hover { background-color: #5a6268; transform: translateY(-1px); }
        
        .btn-qr { background-color: #00bcd4; color: white; }
        .btn-qr:hover { background-color: #00a0af; transform: translateY(-1px); }

        .btn-whatsapp { background-color: var(--success-color); color: white; }
        .btn-whatsapp:hover { background-color: #1e7e34; transform: translateY(-1px); }
        
        .btn-delete { background-color: var(--danger-color); color: white; }
        .btn-delete:hover { background-color: #c82333; transform: translateY(-1px); }
        
        .btn-assign { background-color: var(--primary-color); color: white; }
        .btn-assign:hover { background-color: #304e7e; transform: translateY(-1px); }
        
        .btn-download-record { background-color: #3b5998; color: white; margin-top: 15px; width: 100%;}
        .btn-download-record:hover { background-color: #304e7e; }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        table { 
            margin-top: 25px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
        }
        
        th, td { 
            border: none; 
            border-bottom: 1px solid #dee2e6; 
            padding: 15px 10px; 
            vertical-align: middle;
        }
        
        th { 
            background-color: var(--primary-color); 
            color: white; 
            font-weight: 700;
        }
        
        tr:nth-child(even) { background-color: #f8f8fa; }
        tr:hover { background-color: #e9ecef; }

        .placeholder-note { color: var(--danger-color); font-weight: bold; margin-bottom: 15px; display: block; text-align: right; }
        .alert-error { background-color: #f8d7da; color: var(--danger-color); padding: 10px; border-radius: 5px; margin-top: 15px; border: 1px solid var(--danger-color); }
        .qr-list-cell { font-size: 0.9em; max-width: 250px; word-wrap: break-word; }
        
        /* ØªÙØ¹ÙŠÙ„ Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ù„Ù†Ù‚Ø± Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
        .editable-cell {
            cursor: pointer;
            text-decoration: underline;
            color: var(--primary-color);
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù„ÙƒØ±ÙˆØª</h1>

    <div class="card-section">
        <h2>ğŸ·ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯Ø« (Ù„Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„)</h2>
        <div class="event-info-grid">
            <input type="text" id="eventName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« (Ù…Ø«Ù„Ø§Ù‹: Ø²ÙˆØ§Ø¬ Ø¹Ù„ÙŠ 2024)" class="form-control">
            <button onclick="saveData()" class="btn-save">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
            <input type="file" id="dataUpload" accept=".json" onchange="loadDataFile(this.files[0])" style="display: none;">
            <button onclick="document.getElementById('dataUpload').click()" class="btn-save" style="background-color: #007bff;">â†©ï¸ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</button>
        </div>
    </div>
    
    <h2>âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ÙƒØ±ÙˆØª</h2>

    <div class="card-section">
        <h3>1. Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¶ÙŠÙˆÙ</h3>
        <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„ÙØ§Øª **CSV** (Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: name, phone, totalNeeded) Ø£Ùˆ Ù…Ù„ÙØ§Øª **VCF** (Ù…Ù„ÙØ§Øª Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„ Ø§Ù„Ù‡Ø§ØªÙ).</p>
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="file" id="guestListUpload" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel, .vcf" style="flex-grow: 1;">
            <button onclick="handleFileUpload()" class="btn-action">âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
        </div>
        <p style="margin-top: 10px; font-weight: bold;">ØªÙ… ØªØ­Ù…ÙŠÙ„ <span id="guestCount">0</span> Ø¶ÙŠÙ.</p>
    </div>

    <div class="card-section">
        <h3>2. Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø§Ù„ÙƒØ±ÙˆØª)</h3>
        <p>Ø§Ø®ØªØ± ÙƒÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©. ÙŠØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ **Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨**.</p>
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="file" id="barcodeUpload" accept="image/*" multiple style="flex-grow: 1;">
            <button onclick="loadBarcodes()" class="btn-action">ğŸ–¼ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
        </div>
        <p style="margin-top: 10px;">ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ <span id="barcodeCount">0</span> Ù…Ù„Ù Ø¨Ø§Ø±ÙƒÙˆØ¯.</p>
        <p style="color: var(--primary-color); font-weight: bold;">Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©: <span id="importedQrCodes" class="qr-list-cell">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span></p>
        <p class="alert-error" id="qrMismatchAlert" style="display:none;"></p>
    </div>
    
    <div class="card-section">
        <h2>â• Ø¥Ø¶Ø§ÙØ© Ø¶ÙŠÙ ÙŠØ¯ÙˆÙŠØ§Ù‹</h2>
        <div class="input-grid">
            <input type="text" id="newGuestName" placeholder="Ø§Ù„Ø§Ø³Ù…" class="form-control">
            <input type="text" id="newGuestPhone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ (9665...)" class="form-control">
            <input type="number" id="newGuestTotalNeeded" placeholder="Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ø¯Ø¹ÙˆØ§Øª" min="1" value="1" class="form-control">
            <button onclick="addGuestManually()" class="btn-assign">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙŠÙ</button>
        </div>
    </div>

    <div class="card-section">
        <h2>ğŸ–Šï¸ ØªØ¹Ø¯ÙŠÙ„ Ù†Øµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</h2>
        <span class="placeholder-note">
            Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª: <code>#{{GUEST_NAME}}#</code> (Ø§Ù„Ø§Ø³Ù…), <code>#{{TOTAL_COUNT}}#</code> (Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ø¯Ø¹ÙˆØ§Øª).
        </span>
        <textarea id="messageTemplate" class="form-control">
Ù…Ø±Ø­Ø¨Ø§Ù‹ #{{GUEST_NAME}}#ØŒ
Ù†ØªØ´Ø±Ù Ø¨Ø¯Ø¹ÙˆØªÙƒÙ… Ù„Ø­Ø¶ÙˆØ±... (Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª: #{{TOTAL_COUNT}}#).

Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø³Ø­ Ø£Ø­Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„.
        </textarea>
    </div>

    <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†</h2>
    <p style="text-align: right; color: var(--accent-color); font-weight: bold;">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ **Ø§Ù„Ø§Ø³Ù…** Ø£Ùˆ **Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ** Ø£Ùˆ **Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª** Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹.</p>
    <table>
        <thead>
            <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ</th>
                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®ØµØµØ©</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="guestTableBody">
            </tbody>
    </table>
    
    <button onclick="downloadFinalRecord()" class="btn-download-record">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (CSV)</button>

</div>

<script>
    let guests = [];
    let barcodeImages = {}; 
    let availableQrIds = []; 
    let internalGuestIdCounter = 0; 


    // ----------------------------------------------------------------------
    // 0. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
    // ----------------------------------------------------------------------

    function saveData() {
        const eventName = document.getElementById('eventName').value || 'Unnamed_Event';
        
        const dataToSave = {
            eventName: eventName,
            guests: guests,
            availableQrIds: availableQrIds, 
            internalGuestIdCounter: internalGuestIdCounter,
            messageTemplate: document.getElementById('messageTemplate').value
        };

        const jsonString = JSON.stringify(dataToSave, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const fileName = `${eventName}_Data_${new Date().toISOString().slice(0, 10)}.json`;
        saveAs(blob, fileName);
        alert(`ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯Ø« '${eventName}' Ø¨Ù†Ø¬Ø§Ø­. ØªØ°ÙƒØ± Ø£Ù† ØªØ¹ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„ÙØ§Øª ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯.`);
    }

    function loadDataFile(file) {
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const loadedData = JSON.parse(e.target.result);
                loadData(loadedData);
                alert(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯Ø« '${loadedData.eventName || 'Ù…Ø¬Ù‡ÙˆÙ„'}' Ø¨Ù†Ø¬Ø§Ø­.`);
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Ù…Ù„Ù JSON ØµØ­ÙŠØ­ ØªÙ… Ø­ÙØ¸Ù‡ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù….');
                console.error('Loading error:', error);
            }
        };
        reader.readAsText(file);
    }
    
    function loadData(data) {
        guests = data.guests || [];
        availableQrIds = data.availableQrIds || [];
        internalGuestIdCounter = data.internalGuestIdCounter || 0;
        
        document.getElementById('eventName').value = data.eventName || '';
        document.getElementById('messageTemplate').value = data.messageTemplate || document.getElementById('messageTemplate').value;

        barcodeImages = {}; 
        document.getElementById('barcodeCount').textContent = 0;
        document.getElementById('importedQrCodes').textContent = availableQrIds.join(', ') || 'Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ØµÙˆØ± Ø¨Ø¹Ø¯';
        
        renderGuestTable();
        checkQrMismatch();
    }


    // ----------------------------------------------------------------------
    // 1. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ù„ØªØ¹ÙŠÙŠÙ†
    // ----------------------------------------------------------------------

    function handleFileUpload() {
        const fileInput = document.getElementById('guestListUpload');
        const file = fileInput.files[0];
        if (!file) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹.');
            return;
        }
        const fileExtension = file.name.split('.').pop().toLowerCase();
        
        if (fileExtension === 'csv') {
            readCSV(file);
        } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
            readExcel(file);
        } else if (fileExtension === 'vcf') { // **Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù…Ù„ÙØ§Øª VCF**
            readVCF(file);
        } else {
            alert('ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… CSV Ø£Ùˆ XLSX Ø£Ùˆ VCF.');
        }
    }

    function readCSV(file) {
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                processImportedData(results.data);
            },
            error: function(error) {
                alert(`Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù CSV: ${error.message}`);
            }
        });
    }

    function readExcel(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const importedData = XLSX.utils.sheet_to_json(worksheet);
            processImportedData(importedData);
        };
        reader.readAsArrayBuffer(file);
    }
    
    /**
     * Ù‚Ø±Ø§Ø¡Ø© ÙˆØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù VCF
     */
    function readVCF(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const vcfContent = e.target.result;
            const lines = vcfContent.split(/\r\n|\n/);
            let importedContacts = [];
            let currentContact = null;
            
            lines.forEach(line => {
                // Ø¨Ø¯Ø§ÙŠØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ Ø¬Ø¯ÙŠØ¯Ø©
                if (line.includes('BEGIN:VCARD')) {
                    currentContact = { name: '', phone: '', totalNeeded: 1 };
                } 
                // Ø§Ø³Ù… Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                else if (line.startsWith('FN:') || line.startsWith('N:')) {
                    if (currentContact && currentContact.name === '') {
                        let namePart = line.substring(line.indexOf(':') + 1);
                        if (line.startsWith('N:')) {
                            namePart = namePart.split(';').reverse().join(' ').trim().replace(/ {2,}/g, ' ');
                        }
                        currentContact.name = namePart.replace(/;/g, ' ').trim();
                    }
                } 
                // Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
                else if (line.startsWith('TEL;')) {
                    if (currentContact && currentContact.phone === '') {
                        let phonePart = line.substring(line.indexOf(':') + 1);
                        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ù‚Ù… Ù…Ù† Ø§Ù„Ø£Ø­Ø±Ù ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª
                        phonePart = phonePart.replace(/[^0-9+]/g, '').trim();
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 00966 Ù†ØºÙŠØ±Ù‡ Ø¥Ù„Ù‰ 966
                        if (phonePart.startsWith('00966')) {
                            phonePart = '966' + phonePart.substring(5);
                        } 
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 Ù†ØºÙŠØ±Ù‡ Ø¥Ù„Ù‰ 9665
                        else if (phonePart.startsWith('05')) {
                            phonePart = '966' + phonePart;
                        }
                        currentContact.phone = phonePart;
                    }
                } 
                // Ù†Ù‡Ø§ÙŠØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„
                else if (line.includes('END:VCARD')) {
                    if (currentContact && currentContact.name && currentContact.phone) {
                        importedContacts.push(currentContact);
                    }
                    currentContact = null;
                }
            });
            
            if (importedContacts.length > 0) {
                const dataForProcessing = importedContacts.map(c => ({
                    name: c.name,
                    phone: c.phone,
                    totalNeeded: c.totalNeeded 
                }));
                
                alert('ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ù…Ù„Ù VCF. ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (1). ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹.');
                processImportedData(dataForProcessing, true); 
            } else {
                 alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø£Ø³Ù…Ø§Ø¡ ÙˆØ£Ø±Ù‚Ø§Ù… Ù‡ÙˆØ§ØªÙ ØµØ§Ù„Ø­Ø© ÙÙŠ Ù…Ù„Ù VCF.');
            }
        };
        reader.readAsText(file);
    }
    
    function processImportedData(data, isVcf = false) {
        const requiredFields = ['name', 'phone', 'totalNeeded']; 
        
        if (!isVcf && (data.length === 0 || !requiredFields.every(field => 
            Object.keys(data[0]).some(key => key.toLowerCase() === field.toLowerCase())
        ))) {
            alert('Ø®Ø·Ø£: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (name, phone, totalNeeded).');
            return;
        }

        internalGuestIdCounter = 0;
        
        let newGuests = data.map((guest) => {
            const getField = (field) => {
                if (isVcf) { 
                    return guest[field] || 'N/A';
                }
                const key = Object.keys(guest).find(k => k.toLowerCase() === field.toLowerCase());
                return key ? guest[key] : 'N/A';
            };
            
            internalGuestIdCounter++;
            const totalNeededCount = isVcf ? 1 : Math.max(1, parseInt(getField('totalNeeded')) || 1); 

            return {
                internalId: internalGuestIdCounter,
                name: String(getField('name')).trim() || 'N/A',
                phone: String(getField('phone')).trim() || 'N/A',
                totalNeeded: totalNeededCount, 
                assignedQrIds: [],
                isManuallyAssigned: false
            };
        });

        guests = newGuests;
        distributeBarcodesAutomatically();
        renderGuestTable();
        checkQrMismatch();
        alert(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${guests.length} Ø¶ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªÙˆØ²ÙŠØ¹ ${guests.reduce((sum, g) => sum + g.totalNeeded, 0)} ÙƒØ±Øª Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨.`);
    }

    function addGuestManually() {
        const nameInput = document.getElementById('newGuestName').value;
        const phoneInput = document.getElementById('newGuestPhone').value;
        const totalNeededInput = document.getElementById('newGuestTotalNeeded').value; 

        if (!nameInput || !phoneInput) {
            alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø­Ù‚Ù„ÙŠ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‡Ø§ØªÙ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
            return;
        }
        
        internalGuestIdCounter++;
        const totalNeededCount = Math.max(1, parseInt(totalNeededInput) || 1);


        const newGuest = {
            internalId: internalGuestIdCounter,
            name: nameInput,
            phone: phoneInput,
            totalNeeded: totalNeededCount,
            assignedQrIds: [],
            isManuallyAssigned: false
        };

        guests.push(newGuest);
        distributeBarcodesAutomatically(); 
        renderGuestTable();

        document.getElementById('newGuestName').value = '';
        document.getElementById('newGuestPhone').value = '';
        document.getElementById('newGuestTotalNeeded').value = '1';
        checkQrMismatch();
    }
    
    function deleteGuest(internalId) {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¶ÙŠÙØŸ')) {
            guests = guests.filter(guest => guest.internalId !== internalId);
            distributeBarcodesAutomatically();
            renderGuestTable();
            checkQrMismatch();
        }
    }

    function loadBarcodes() {
        const files = document.getElementById('barcodeUpload').files;
        if (files.length === 0) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹.');
            return;
        }

        barcodeImages = {}; 
        availableQrIds = []; 
        let loadedCount = 0;
        const totalFiles = files.length;

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const fileNameWithoutExtension = file.name.split('.').slice(0, -1).join(''); 
                barcodeImages[fileNameWithoutExtension] = e.target.result; 
                availableQrIds.push(fileNameWithoutExtension); 
                loadedCount++;
                document.getElementById('barcodeCount').textContent = loadedCount;
                
                document.getElementById('importedQrCodes').textContent = availableQrIds.join(', ');
                
                if (loadedCount === totalFiles) {
                    availableQrIds.sort((a, b) => {
                        const numA = parseInt(a);
                        const numB = parseInt(b);
                        if (!isNaN(numA) && !isNaN(numB)) {
                            return numA - numB;
                        }
                        return a.localeCompare(b);
                    });

                    distributeBarcodesAutomatically();
                    renderGuestTable();
                    checkQrMismatch();
                    alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${loadedCount} ÙƒÙˆØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­. ÙˆØªÙ… ØªÙˆØ²ÙŠØ¹Ù‡Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¶ÙŠÙˆÙ Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.`);
                }
            };
            reader.readAsDataURL(file); 
        });
    }

    function distributeBarcodesAutomatically() {
        
        let allUsedQrIds = guests.filter(g => g.isManuallyAssigned).flatMap(g => g.assignedQrIds);
        
        let availableForDistribution = availableQrIds.filter(id => !allUsedQrIds.includes(id));
        
        guests.forEach(guest => {
            if (!guest.isManuallyAssigned) {
                guest.assignedQrIds = []; 
            }
        });

        let qrIndex = 0;
        
        guests.forEach(guest => {
            if (!guest.isManuallyAssigned) {
                const needed = guest.totalNeeded;
                
                if (qrIndex + needed <= availableForDistribution.length) {
                    guest.assignedQrIds = availableForDistribution.slice(qrIndex, qrIndex + needed);
                    qrIndex += needed;
                } else {
                    guest.assignedQrIds = []; 
                }
            }
        });
    }

    function assignBarcode(internalId) {
        const currentGuest = guests.find(g => g.internalId === internalId);
        if (!currentGuest) return;

        const needed = currentGuest.totalNeeded;
        let promptMessage = `Ø£Ø¯Ø®Ù„ ${needed} ÙƒÙˆØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙØµÙˆÙ„ÙŠÙ† Ø¨ÙØ§ØµÙ„Ø© (ØŒ) Ù„Ù€ ${currentGuest.name}: (Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentGuest.assignedQrIds.join(', ') || 'Ù„Ù… ÙŠØ®ØµØµ'})\n\n`;
        promptMessage += `Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©: ${availableQrIds.join(', ')}`;
        
        const newQrIdsStr = prompt(promptMessage, currentGuest.assignedQrIds.join(', '));
        
        if (newQrIdsStr === null) return; 

        const newQrIds = newQrIdsStr.split(',').map(id => id.trim()).filter(id => id !== '');
        
        if (newQrIds.length !== needed) {
             alert(`Ø®Ø·Ø£: ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ${needed} ÙƒÙˆØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø§Ù„Ø¶Ø¨Ø· Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª (${needed}).`);
             return;
        }

        const currentGuestOldIds = currentGuest.assignedQrIds;
        
        const allAssignedIds = guests.flatMap(g => g.assignedQrIds || []).filter(id => !currentGuestOldIds.includes(id));
        for (const newId of newQrIds) {
             if (!barcodeImages[newId]) {
                alert(`ØªØ­Ø°ÙŠØ±: Ø§Ù„ÙƒÙˆØ¯ "${newId}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©! (Ø³ØªØ­ØªØ§Ø¬ Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØµÙˆØ± Ø§Ù„ÙƒØ±ÙˆØª)`);
             }
             if (allAssignedIds.includes(newId)) {
                 alert(`Ø®Ø·Ø£: ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ "${newId}" Ù…ÙØ¹ÙŠÙ‘Ù† Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ø¶ÙŠÙ Ø¢Ø®Ø±.`);
                 return;
             }
        }
        
        currentGuest.assignedQrIds = newQrIds;
        currentGuest.isManuallyAssigned = true; 
        
        distributeBarcodesAutomatically(); 
        renderGuestTable();
        checkQrMismatch();
    }


    // ----------------------------------------------------------------------
    // 2. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
    // ----------------------------------------------------------------------
    
    function editTotalNeeded(internalId) {
        const guest = guests.find(g => g.internalId === internalId);
        if (!guest) return;

        const newTotalStr = prompt(`Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¯Ø¹ÙˆØ§Øª Ù„Ù€ ${guest.name}:`, guest.totalNeeded);
        
        if (newTotalStr === null || newTotalStr.trim() === "") return;
        
        const newTotal = parseInt(newTotalStr);
        
        if (isNaN(newTotal) || newTotal < 1) {
            alert("ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù…ÙˆØ¬Ø¨ (1 ÙÙ…Ø§ ÙÙˆÙ‚).");
            return;
        }

        if (newTotal === guest.totalNeeded) return; 

        guest.totalNeeded = newTotal;
        // Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø¯ ÙŠØ¯ÙˆÙŠØ§Ù‹ØŒ Ù†Ø¹ÙŠØ¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙƒØ±ÙˆØª
        guest.isManuallyAssigned = false; 

        distributeBarcodesAutomatically();
        renderGuestTable();
        checkQrMismatch();
        alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ù„Ù€ ${guest.name} Ø¥Ù„Ù‰ ${newTotal}. ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙƒØ±ÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.`);
    }
    
    function editGuestDetails(internalId, field) {
        const guest = guests.find(g => g.internalId === internalId);
        if (!guest) return;

        let promptMessage = (field === 'name') ? `Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${guest.name}:` : `Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${guest.name} (9665...):`;
        
        const newValue = prompt(promptMessage, guest[field]);
        
        if (newValue === null || newValue.trim() === "") {
            alert("Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙØ§Ø±Øº Ø£Ùˆ ØªÙ… Ø¥Ù„ØºØ§Ø¤Ù‡.");
            return;
        }
        
        if (newValue === guest[field]) return;

        guest[field] = newValue.trim();
        
        renderGuestTable();
        alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ ${field === 'name' ? 'Ø§Ù„Ø§Ø³Ù…' : 'Ø§Ù„Ù‡Ø§ØªÙ'} Ù„Ù€ ${guest.name} Ø¨Ù†Ø¬Ø§Ø­.`);
    }
    
    function downloadFinalRecord() {
        if (guests.length === 0) {
            alert('Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©. Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„ØªÙ†Ø²ÙŠÙ„Ù‡.');
            return;
        }
        
        const eventName = document.getElementById('eventName').value || 'Ø§Ù„Ø³Ø¬Ù„_Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ';
        
        const header = ['Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ', 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', 'Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®ØµØµØ©', 'Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†'];
        
        const dataRows = guests.map(guest => [
            `"${guest.name}"`, 
            guest.phone, 
            guest.totalNeeded,
            `"${guest.assignedQrIds.join('ØŒ ')}"${guest.assignedQrIds.length === 0 ? ' (Ù„Ù… ÙŠØ®ØµØµ)' : ''}`,
            guest.isManuallyAssigned ? 'ÙŠØ¯ÙˆÙŠ' : 'ØªÙ„Ù‚Ø§Ø¦ÙŠ'
        ]);
        
        const csvContent = [
            header.join(','),
            ...dataRows.map(e => e.join(','))
        ].join('\n');
        
        const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const fileName = `${eventName}_Record_${new Date().toISOString().slice(0, 10)}.csv`;
        saveAs(blob, fileName);
        
        alert('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„ØªØ®ØµÙŠØµ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (CSV) Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.');
    }


    async function downloadBarcodeImage(guest) {
        const qrCodeIds = guest.assignedQrIds; 
        const totalNeeded = guest.totalNeeded;
        
        if (qrCodeIds.length === 0) {
             alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ø£ÙŠ ÙƒØ±Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¶ÙŠÙ Ø¨Ø¹Ø¯.');
             return;
        }
        
        const missingImages = qrCodeIds.filter(id => !barcodeImages[id]);
        if (missingImages.length > 0) {
            alert(`Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©: ${missingImages.join(', ')}. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØ±!`);
            return;
        }

        if (totalNeeded === 1) {
            const qrCodeId = qrCodeIds[0];
            const base64Data = barcodeImages[qrCodeId];
            
            const downloadLink = document.createElement('a');
            downloadLink.href = base64Data;
            downloadLink.download = `${guest.name}_${qrCodeId}.png`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            alert(`ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙƒØ±Øª Ø§Ù„Ù…ÙØ±Ø¯ (${qrCodeId}.png) Ø¨Ù†Ø¬Ø§Ø­.`);
            return;
        }

        const zip = new JSZip();
        let downloadCount = 0;

        for (const qrCodeId of qrCodeIds) {
            const base64Data = barcodeImages[qrCodeId];
            
            if (base64Data) {
                const base64Content = base64Data.split(',')[1]; 
                zip.file(`${qrCodeId}.png`, base64Content, {base64: true});
                downloadCount++;
            }
        }

        const zipFileName = `${guest.name}_${guest.totalNeeded}_Cards.zip`;

        zip.generateAsync({type:"blob"}).then(function(content) {
            saveAs(content, zipFileName);
            alert(`ØªÙ… ØªÙ†Ø²ÙŠÙ„ ${downloadCount} ÙƒØ±Øª Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù…Ù„Ù Ù…Ø¶ØºÙˆØ·: ${zipFileName}`);
        });
    }

    function checkQrMismatch() {
        const requiredCount = guests.reduce((sum, g) => sum + g.totalNeeded, 0);
        const availableCount = availableQrIds.length;
        const alertBox = document.getElementById('qrMismatchAlert');

        if (availableCount < requiredCount) {
             alertBox.style.display = 'block';
             alertBox.textContent = `ØªØ­Ø°ÙŠØ±: Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© (${availableCount}) Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${requiredCount}). Ù„Ù† ÙŠØªÙ… ØªØ®ØµÙŠØµ ÙƒÙ„ Ø§Ù„ÙƒØ±ÙˆØª.`;
        } else if (availableCount > requiredCount) {
             alertBox.style.display = 'block';
             alertBox.textContent = `Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© (${availableCount}) Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${requiredCount}). ${availableCount - requiredCount} ÙƒØ±Øª Ù„Ù… ÙŠØªÙ… ØªØ®ØµÙŠØµÙ‡.`;
        } else {
             alertBox.style.display = 'none';
        }
    }

    function sendWhatsAppMessage(guest) {
        if (guest.assignedQrIds.length === 0) {
             alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† ÙƒØ±ÙˆØª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¶ÙŠÙ.');
             return;
        }
        
        let messageText = document.getElementById('messageTemplate').value;

        messageText = messageText.replace(/#{{GUEST_NAME}}#/g, guest.name);
        messageText = messageText.replace(/#{{TOTAL_COUNT}}#/g, guest.totalNeeded);
        
        const waLink = `https://wa.me/${guest.phone}?text=${encodeURIComponent(messageText)}`;
        window.open(waLink, '_blank');
    }

    // ----------------------------------------------------------------------
    // 3. ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Render)
    // ----------------------------------------------------------------------
    
    function renderGuestTable() {
        const tableBody = document.getElementById('guestTableBody');
        tableBody.innerHTML = '';
        document.getElementById('guestCount').textContent = guests.length;
        
        guests.forEach(guest => {
            const row = tableBody.insertRow();
            
            const nameCell = row.insertCell();
            nameCell.innerHTML = `<span 
                onclick="editGuestDetails(${guest.internalId}, 'name')" 
                class="editable-cell"
                title="Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹">
                ${guest.name}
            </span>`;
            
            const totalNeededCell = row.insertCell();
            totalNeededCell.innerHTML = `<span 
                onclick="editTotalNeeded(${guest.internalId})" 
                class="editable-cell"
                title="Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹">
                ${guest.totalNeeded}
            </span>`;
            
            const phoneCell = row.insertCell();
            phoneCell.innerHTML = `<span 
                onclick="editGuestDetails(${guest.internalId}, 'phone')" 
                class="editable-cell"
                title="Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹">
                ${guest.phone}
            </span>`;
            
            const qrCodeCell = row.insertCell();
            qrCodeCell.classList.add('qr-list-cell');
            const qrList = guest.assignedQrIds.join(', ');
            qrCodeCell.textContent = qrList || 'Ù„Ù… ÙŠØ®ØµØµ';
            
            const isFullyAssigned = guest.assignedQrIds.length === guest.totalNeeded;
            qrCodeCell.style.color = isFullyAssigned ? 'var(--text-dark)' : 'var(--danger-color)'; 
            qrCodeCell.style.fontWeight = 'bold';
            
            if (guest.isManuallyAssigned) {
                 qrCodeCell.style.borderRight = '4px solid var(--accent-color)'; 
            }

            const actionsCell = row.insertCell();

            const assignButton = document.createElement('button');
            assignButton.textContent = 'ØªØ¹ÙŠÙŠÙ†/ØªØºÙŠÙŠØ± Ø§Ù„ÙƒØ±ÙˆØª';
            assignButton.className = 'btn-assign';
            assignButton.onclick = () => assignBarcode(guest.internalId); 
            actionsCell.appendChild(assignButton);
            
            const qrButton = document.createElement('button');
            qrButton.className = 'btn-qr';
            qrButton.onclick = () => downloadBarcodeImage(guest); 

            if (guest.totalNeeded === 1) {
                qrButton.textContent = 'ğŸ’¾ Ø³Ø­Ø¨ Ø§Ù„ÙƒØ±Øª (PNG)';
            } else {
                qrButton.textContent = 'ğŸ’¾ Ø³Ø­Ø¨ Ø§Ù„ÙƒØ±ÙˆØª (ZIP)';
            }
            
            const isImageLoaded = guest.assignedQrIds[0] && barcodeImages[guest.assignedQrIds[0]];
            
            if (!isFullyAssigned || !isImageLoaded) {
                 qrButton.disabled = true;
                 qrButton.textContent = `ğŸš« Ù†Ù‚Øµ (${guest.totalNeeded - guest.assignedQrIds.length})`;
                 if (isFullyAssigned && !isImageLoaded) {
                    qrButton.textContent = 'ğŸš« Ø§Ù„ØµÙˆØ± ØºÙŠØ± Ù…Ø³ØªÙˆØ±Ø¯Ø©';
                 }
            }
            actionsCell.appendChild(qrButton);
            
            const waButton = document.createElement('button');
            waButton.textContent = 'ğŸ’¬ Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨';
            waButton.className = 'btn-whatsapp';
            waButton.onclick = () => sendWhatsAppMessage(guest);
            
            if (!isFullyAssigned) {
                 waButton.disabled = true;
            }
            actionsCell.appendChild(waButton);
            
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'ğŸ—‘ï¸';
            deleteButton.className = 'btn-delete';
            deleteButton.onclick = () => deleteGuest(guest.internalId); 
            actionsCell.appendChild(deleteButton);
        });
    }

    document.addEventListener('DOMContentLoaded', renderGuestTable);
</script>
</body>
</html>
