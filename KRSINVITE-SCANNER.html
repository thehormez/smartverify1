<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez â€” Ù…Ø§Ø³Ø­ Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
  <style>
    :root{
      --bg:#0b1020;--ink:#e5e7eb;--muted:#94a3b8;--line:#334155;
      --ok:#22c55e;--bad:#ef4444;--warn:#f59e0b;--card:#0e172a
    }
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1d);
      color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial
    }
    .topbar{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid #243047}
    .container{max-width:1100px;margin:0 auto;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .btn{appearance:none;border:1px solid var(--line);background:#0b1220;color:var(--ink);border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn:hover{background:#0d1528}
    .select,.input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:2fr 1fr}
    @media(max-width:900px){.grid-2{grid-template-columns:1fr}}
    .muted{color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%}
    .status{display:flex;gap:8px;align-items:center}

    /* Scanner video */
    .scanWrap{position:relative;width:100%;aspect-ratio:3/4;max-width:480px;margin-inline:auto;border-radius:14px;overflow:hidden;background:#000;border:1px solid rgba(255,255,255,.08)}
    #video{width:100%;height:100%;object-fit:cover}
    .frame{position:absolute;inset:0;pointer-events:none}
    .corner{position:absolute;width:42px;height:42px;border:3px solid rgba(255,255,255,.7)}
    .corner.tl{top:12px;left:12px;border-right:none;border-bottom:none;border-radius:10px 0 0 0}
    .corner.tr{top:12px;right:12px;border-left:none;border-bottom:none;border-radius:0 10px 0 0}
    .corner.bl{bottom:12px;left:12px;border-right:none;border-top:none;border-radius:0 0 0 10px}
    .corner.br{bottom:12px;right:12px;border-left:none;border-top:none;border-radius:0 0 10px 0}

    /* Last result */
    .qrBox{display:grid;grid-template-columns:110px 1fr;gap:12px;align-items:center}
    .qrBox canvas{background:#fff;border-radius:10px}

    .hist{max-height:320px;overflow:auto}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0b1220}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    /* SUCCESS / ERROR OVERLAYS */
    .overlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      color:#fff; z-index:9999; text-align:center; padding:20px;
      animation:fadeIn .12s ease-out;
    }
    #okOverlay{ background:var(--ok); }
    #errOverlay{ background:var(--bad); }
    .overlay .code{
      font-size: clamp(28px, 9vw, 88px);
      font-weight: 900;
      letter-spacing: 2px;
      text-shadow: 0 2px 6px rgba(0,0,0,.25);
      word-break: break-all;
    }
    .overlay .msg{ margin-top:10px; font-size: clamp(14px, 3.5vw, 26px); font-weight:700 }
    @keyframes fadeIn { from{opacity:.0} to{opacity:1} }

    /* Settings accordion */
    .accordion{border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .acc-hd{background:#0b1220;padding:10px 14px;cursor:pointer;font-weight:700}
    .acc-bd{display:none;padding:12px;background:#0c1426;border-top:1px solid var(--line)}
    .acc-bd.open{display:block}

    /* Gate (event before enter) */
    #gate{position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;z-index:9998}
    #gate .panel{width:min(560px,92vw);background:#0d1426;border:1px solid #243047;border-radius:16px;padding:16px}
    #gate .panel h3{margin:0 0 8px 0}
  </style>
</head>
<body>

  <!-- âœ… Hidden input for keyboard wedge scanners -->
  <input id="scannerInput"
         class="input"
         style="position:fixed;left:-9999px;top:-9999px;opacity:0;width:1px;height:1px"
         autocomplete="off" autocapitalize="none" spellcheck="false" />

  <!-- Topbar -->
  <div class="topbar">
    <div class="container row" style="justify-content:space-between">
      <div class="row"><div style="font-weight:900">HS</div><div class="muted" id="titleSub">Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ â€” Ù…Ù†Ø§Ø³Ø¨Ø© Ù…Ø­Ø¯Ø¯Ø©</div></div>
      <div class="row">
        <span class="tag"><span id="lblEventTag">Ø§Ù„Ø­Ø¯Ø«</span>: <b id="evTag">â€”</b></span>
        <span class="tag"><span class="muted">Auth</span>: <b id="authTag">â€”</b></span>
        <button id="langBtn" class="btn">AR</button>
      </div>
    </div>
  </div>

  <!-- Gate asks for event BEFORE entering content -->
  <div id="gate">
    <div class="panel">
      <h3 id="gateTitle" style="font-weight:800">Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«</h3>
      <div class="muted" id="gateHint" style="margin-bottom:8px">ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø§Ø³Ø­</div>
      <div class="row">
        <input id="gateEvent" class="input" placeholder="Ù…Ø«Ø§Ù„: zafaf_khaled" />
        <button id="gateEnter" class="btn">Ø¯Ø®ÙˆÙ„</button>
      </div>
      <div class="muted" id="gateMsg" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- Green success overlay -->
  <div id="okOverlay" class="overlay">
    <div>
      <div class="code" id="okCode">â€”</div>
      <div class="msg" id="okMsg">ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„ âœ…</div>
    </div>
  </div>

  <!-- Red error overlay -->
  <div id="errOverlay" class="overlay">
    <div>
      <div class="code" id="errCode">â€”</div>
      <div class="msg" id="errMsg">Ù…Ø±ÙÙˆØ¶</div>
    </div>
  </div>

  <div class="container grid grid-2" id="content" style="display:none">
    <!-- Left: Scanner + controls -->
    <div class="card">
      <div class="row" style="justify-content:space-between; gap:8px">
        <div class="status"><div id="statusDot" class="dot" style="background:#9ca3af"></div><div id="statusText" class="muted">â€”</div></div>
        <div class="row">
          <button id="startBtn" class="btn" disabled>â–¶ï¸ ØªØ´ØºÙŠÙ„</button>
          <button id="stopBtn" class="btn" disabled>â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
          <button id="switchBtn" class="btn" disabled>ğŸ”„ ØªØ¨Ø¯ÙŠÙ„</button>
          <button id="torchBtn" class="btn" disabled>ğŸ’¡ ÙÙ„Ø§Ø´</button>
        </div>
      </div>

      <div class="scanWrap" id="scanWrap">
        <video id="video" playsinline muted autoplay></video>
        <div class="frame">
          <div class="corner tl"></div>
          <div class="corner tr"></div>
          <div class="corner bl"></div>
          <div class="corner br"></div>
        </div>
      </div>

      <!-- Settings (accordion) -->
      <div class="accordion" style="margin-top:12px">
        <div class="acc-hd" id="accToggle">âš™ï¸ <span id="lblSettings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
        <div class="acc-bd" id="accBody">
          <div class="row" style="margin-top:6px">
            <div style="width:160px">
              <div class="muted" id="lblPause">ÙØªØ±Ø© Ø§Ù„ØªÙˆÙ‚Ù (Ù…Ù„Ù‘ÙŠ Ø«Ø§Ù†ÙŠØ©)</div>
              <input id="pauseMs" class="input" type="number" value="650" />
            </div>
            <div style="width:150px">
              <div class="muted" id="lblSound">Ø§Ù„Ø£ØµÙˆØ§Øª</div>
              <select id="soundMode" class="select">
                <option value="on">ØªØ´ØºÙŠÙ„</option>
                <option value="off">Ø¥ÙŠÙ‚Ø§Ù</option>
              </select>
            </div>
            <div style="width:180px">
              <div class="muted" id="lblScanSize">Ø­Ø¬Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦</div>
              <select id="scanSize" class="select">
                <option value="360">ØµØºÙŠØ±</option>
                <option value="480" selected>Ù…ØªÙˆØ³Ø·</option>
                <option value="680">ÙƒØ¨ÙŠØ±</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div style="flex:1">
              <div class="muted" id="lblRegex">Ù†Ù…Ø· Ø§Ù„ÙƒÙˆØ¯ (Regex)</div>
              <input id="codeRegex" class="input mono" value="^[A-Z]{1,6}_[0-9]{1,6}$|^[A-Z0-9_]{4,64}$" />
            </div>
            <div style="width:170px">
              <div class="muted" id="lblStrict">ÙˆØ¶Ø¹ ØµØ§Ø±Ù…</div>
              <select id="strictMode" class="select">
                <option value="off" selected>Ø§Ù‚Ø¨Ù„ Ø§Ù„ÙƒÙ„</option>
                <option value="on">Ø§Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ ÙÙ‚Ø·</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Camera + manual -->
      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <div class="muted" id="lblCam">Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div>
          <select id="cameraSelect" class="select"></select>
        </div>
        <div style="flex:1">
          <div class="muted" id="lblManual">Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</div>
          <div class="row">
            <input id="manualCode" class="input" placeholder="KH_007" />
            <button id="manualBtn" class="btn" disabled>ØªØ­Ù‚Ù‚</button>
          </div>
        </div>
      </div>

      <div id="httpsWarn" class="card" style="display:none; margin-top:10px; border-color:#7f1d1d;background:#450a0a;color:#fecaca">
        âš ï¸ <span id="lblHttps">Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØªØ·Ù„Ø¨ HTTPS Ø£Ùˆ localhost</span>.
      </div>
    </div>

    <!-- Right: last result + history -->
    <div class="card">
      <div class="muted" id="lblLast" style="font-size:12px">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©</div>
      <div class="qrBox" style="margin-top:6px">
        <canvas id="qrCanvas" width="110" height="110"></canvas>
        <div>
          <div id="lastCode" class="mono" style="font-size:22px;font-weight:800">â€”</div>
          <div id="lastMsg" class="muted" style="font-size:12px;margin-top:4px">â€”</div>
        </div>
      </div>

      <div class="muted" id="lblHist" style="font-size:12px;margin-top:14px">Ø§Ù„Ø³Ø¬Ù„ (Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©)</div>
      <div id="hist" class="hist"></div>
      <div class="row" style="margin-top:8px"><button id="clearHist" class="btn">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button></div>
    </div>
  </div>

  <!-- QR lib for preview -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- ZXing dynamic loader -->
  <script>
    (function(){
      const CANDS=[
        'https://unpkg.com/@zxing/browser@0.1.3/umd/index.min.js',
        'https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.3/umd/index.min.js',
        'https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js',
        'https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js'
      ];
      function load(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.async=true;s.onload=()=>res();s.onerror=rej;document.head.appendChild(s);});}
      window.ensureZXing=async()=>{if(window.ZXing&&(window.ZXing.BrowserMultiFormatReader||window.ZXing.BrowserQRCodeReader))return true;for(const u of CANDS){try{await load(u);if(window.ZXing&&(window.ZXing.BrowserMultiFormatReader||window.ZXing.BrowserQRCodeReader))return true;}catch(_){} }return !!(window.ZXing&&(window.ZXing.BrowserMultiFormatReader||window.ZXing.BrowserQRCodeReader))};
    })();
  </script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <!-- âœ… REQUIRED -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

  <script>
  (function(){
    const $=(s,root=document)=>root.querySelector(s);

    // ===== i18n =====
    const T={
      ar:{
        titleSub:'Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ â€” Ù…Ù†Ø§Ø³Ø¨Ø© Ù…Ø­Ø¯Ø¯Ø©', eventTag:'Ø§Ù„Ø­Ø¯Ø«',
        ready:'Ø¬Ø§Ù‡Ø²',checking:'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚â€¦',start:'â–¶ï¸ ØªØ´ØºÙŠÙ„',stop:'â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù',switch:'ğŸ”„ ØªØ¨Ø¯ÙŠÙ„',flash:'ğŸ’¡ ÙÙ„Ø§Ø´',
        camera:'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§',manual:'Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ',ok:'âœ… Ù…Ù‚Ø¨ÙˆÙ„',dupe:'âš ï¸ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ø³Ø§Ø¨Ù‚Ù‹Ø§',mismatch:'âŒ Ù„Ø§ ÙŠØ®Øµ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©',notfound:'âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯',
        needHttps:'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØªØ·Ù„Ø¨ HTTPS Ø£Ùˆ localhost',camlib:'âš ï¸ Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù… ØªÙØ­Ù…Ù‘Ù„',paused:'â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª',needEvent:'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹ÙŠÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹',
        settings:'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',pause:'ÙØªØ±Ø© Ø§Ù„ØªÙˆÙ‚Ù (Ù…Ù„Ù‘ÙŠ Ø«Ø§Ù†ÙŠØ©)',sounds:'Ø§Ù„Ø£ØµÙˆØ§Øª',reader:'Ø­Ø¬Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦',regex:'Ù†Ù…Ø· Ø§Ù„ÙƒÙˆØ¯ (Regex)',strict:'ÙˆØ¶Ø¹ ØµØ§Ø±Ù…',
        last:'Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©',hist:'Ø§Ù„Ø³Ø¬Ù„ (Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©)',check:'ØªØ­Ù‚Ù‚',httpsWarn:'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØªØ·Ù„Ø¨ HTTPS Ø£Ùˆ localhost',
        accOpen:'ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', accClose:'Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
        accepted:'ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„ âœ…', rejected:'Ù…Ø±ÙÙˆØ¶',
        received:'ğŸ“¥ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙƒÙˆØ¯â€¦',
        auth:'Ù…ÙˆØ«Ù‘Ù‚'
      },
      en:{
        titleSub:'Barcode Scanner â€” Event Locked', eventTag:'Event',
        ready:'Ready',checking:'Checkingâ€¦',start:'â–¶ï¸ Start',stop:'â¹ï¸ Stop',switch:'ğŸ”„ Switch',flash:'ğŸ’¡ Torch',
        camera:'Camera',manual:'Manual input',ok:'âœ… Accepted',dupe:'âš ï¸ Already used',mismatch:'âŒ Not this event',notfound:'âŒ Code not found',
        needHttps:'Camera requires HTTPS or localhost',camlib:'âš ï¸ Camera library not loaded',paused:'â¸ï¸ Paused',needEvent:'Please set the event name first',
        settings:'Settings',pause:'Pause (ms)',sounds:'Sounds',reader:'Scan size',regex:'Code pattern (Regex)',strict:'Strict mode',
        last:'Last result',hist:'History (locally per event)',check:'Check',httpsWarn:'Camera requires HTTPS or localhost',
        accOpen:'Open settings', accClose:'Close settings',
        accepted:'Accepted âœ…', rejected:'Rejected',
        received:'ğŸ“¥ Code receivedâ€¦',
        auth:'Authed'
      }
    };

    let LANG=localStorage.getItem('hs:evscan:lang')||'ar';
    function applyDir(){ const isAr=LANG==='ar'; document.documentElement.lang=LANG; document.documentElement.dir=isAr?'rtl':'ltr'; }
    function i18n(){
      const L=T[LANG];
      $('#titleSub').textContent=L.titleSub; $('#lblEventTag').textContent=L.eventTag; $('#langBtn').textContent=(LANG==='ar'?'EN':'AR');
      $('#startBtn').textContent=L.start; $('#stopBtn').textContent=L.stop; $('#switchBtn').textContent=L.switch; $('#torchBtn').textContent=L.flash;
      $('#statusText').textContent=L.ready; $('#lblCam').textContent=L.camera; $('#lblManual').textContent=L.manual; $('#manualBtn').textContent=L.check; $('#lblHttps').textContent=L.httpsWarn;
      $('#lblSettings').textContent=L.settings; $('#accToggle').setAttribute('aria-label', L.accOpen); $('#lblPause').textContent=L.pause; $('#lblSound').textContent=L.sounds; $('#lblScanSize').textContent=L.reader; $('#lblRegex').textContent=L.regex; $('#lblStrict').textContent=L.strict;
      $('#lblLast').textContent=L.last; $('#lblHist').textContent=L.hist;
      $('#okMsg').textContent=L.accepted; $('#errMsg').textContent=L.rejected;
      $('#gateTitle').textContent = (LANG==='ar'?'Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«':'Enter event name');
      $('#gateHint').textContent  = (LANG==='ar'?'ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø§Ø³Ø­':'You must set the event name before using the scanner');
      $('#gateEnter').textContent = (LANG==='ar'?'Ø¯Ø®ÙˆÙ„':'Enter');
    }

    // ===== Firebase =====
    const cfg={
      apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
      authDomain:"hormez-inv.firebaseapp.com",
      projectId:"hormez-inv"
    };
    if(!firebase.apps.length){ firebase.initializeApp(cfg); }
    const db=firebase.firestore();

    // âœ… REQUIRED: Anonymous auth so rules (signedIn()) passes
    async function ensureAnonAuth(){
      try{
        const auth = firebase.auth();
        // wait for auth ready
        await new Promise((res)=>auth.onAuthStateChanged(()=>res(), ()=>res()));
        if(!auth.currentUser){
          await auth.signInAnonymously();
        }
        const uid = auth.currentUser?.uid || 'ok';
        $('#authTag').textContent = uid.slice(0,8);
        return true;
      }catch(e){
        console.error("Anonymous auth failed:", e);
        $('#authTag').textContent = 'FAIL';
        alert("âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„. ÙØ¹Ù„ Anonymous Auth Ù…Ù† Firebase Authentication.");
        return false;
      }
    }

    // ===== Event gate =====
    const URL_EVENT = new URLSearchParams(location.search).get('event');
    let EVENT_NAME = '';

    function allowUI(enable){
      $('#content').style.display = enable ? '' : 'none';
      $('#startBtn').disabled = !enable;
      $('#stopBtn').disabled = !enable;
      $('#switchBtn').disabled = !enable;
      $('#torchBtn').disabled = !enable;
      $('#manualBtn').disabled = !enable;
    }
    function setEvent(name){
      EVENT_NAME = String(name||'').trim();
      $('#evTag').textContent = EVENT_NAME || 'â€”';
      localStorage.setItem('hs:evscan:event', EVENT_NAME);
      renderHist();
      allowUI(!!EVENT_NAME);
    }
    function tryInitEvent(){
      const saved = localStorage.getItem('hs:evscan:event')||'';
      if(URL_EVENT){
        setEvent(URL_EVENT); $('#gate').style.display='none';
      }else if(saved){
        $('#gate').style.display='flex';
        $('#gateEvent').value = saved;
      }else{
        $('#gate').style.display='flex';
      }
    }

    // HTTPS guard
    function httpsOK(){
      const isLocal=['localhost','127.0.0.1'].includes(location.hostname);
      const ok=location.protocol==='https:'||isLocal;
      $('#httpsWarn').style.display=ok?'none':'block';
      if(!ok){ $('#startBtn').disabled=true; }
      return ok;
    }

    // History per event
    function hKey(){ return `hs:evscan:hist:${EVENT_NAME||'__NONE__'}` }
    function getHist(){ try{ return JSON.parse(localStorage.getItem(hKey())||'[]'); }catch{return []} }
    function pushHist(code,msg,good){ const h=getHist(); h.unshift({code,msg,at:Date.now(),good}); localStorage.setItem(hKey(), JSON.stringify(h.slice(0,80))); renderHist(); }
    function renderHist(){
      const box=$('#hist'); box.innerHTML='';
      if(!EVENT_NAME){ box.innerHTML=`<div class="muted">${T[LANG].needEvent}</div>`; return; }
      const h=getHist(); if(!h.length){ box.innerHTML = `<div class="muted">â€”</div>`; return; }
      h.forEach(x=>{
        const d=document.createElement('div');
        d.style.padding='6px';
        d.style.borderTop='1px solid var(--line)';
        d.innerHTML=`<div class="mono">${x.code}</div><div class="muted" style="font-size:12px">${new Date(x.at).toLocaleString(LANG==='ar'?'ar-EG':'en-GB')} â€” ${x.msg}</div>`;
        box.appendChild(d);
      });
    }

    // ===== Audio =====
    let audioCtx=null;
    function ensureAudio(){ try{ if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); } if(audioCtx.state==='suspended') audioCtx.resume(); }catch{} }
    function playTone(type='ok'){
      if($('#soundMode')?.value==='off') return;
      try{
        ensureAudio(); if(!audioCtx) return;
        const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
        o.type='sine'; o.frequency.value=(type==='ok')?880:220;
        const now=audioCtx.currentTime; const dur=(type==='ok')?0.12:0.22;
        o.connect(g); g.connect(audioCtx.destination);
        g.gain.setValueAtTime(0.0001,now);
        g.gain.exponentialRampToValueAtTime(0.2,now+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001,now+dur);
        o.start(); o.stop(now+dur+0.02);
      }catch{}
    }

    // UI helpers + overlays
    function setStatus(text,color){ $('#statusText').textContent=text; $('#statusDot').style.background=color; }
    function drawQRPreview(text){
      const c=$('#qrCanvas'); if(!c) return;
      try{
        if(!text){ const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,c.width,c.height); return; }
        QRCode.toCanvas(c, text, {width:110, margin:1}, ()=>{});
      }catch{}
    }
    function showGreenOverlay(code){ $('#okCode').textContent=code||'â€”'; const el=$('#okOverlay'); el.style.display='flex'; setTimeout(()=>{ el.style.display='none'; }, 1200); }
    function showRedOverlay(code,reason){ $('#errCode').textContent=code||'â€”'; $('#errMsg').textContent=reason||T[LANG].rejected; const el=$('#errOverlay'); el.style.display='flex'; setTimeout(()=>{ el.style.display='none'; }, 1400); }
    function showLast(code,msg,good){
      $('#lastCode').textContent=code||'â€”';
      $('#lastCode').style.color=good?'#86efac':'#fca5a5';
      $('#lastMsg').textContent=msg||'â€”';
      drawQRPreview(code||'');
      try{ playTone(good?'ok':'err'); navigator.vibrate?.(good?60:120); }catch{}
      if(good) showGreenOverlay(code);
      else showRedOverlay(code, msg);
    }

    // ===== Scanner input (keyboard wedge) =====
    const scannerInput = document.getElementById('scannerInput');
    let scannerEnabled = false;

    function focusScannerInput(){
      if(!scannerEnabled) return;
      const ae = document.activeElement;
      if(ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA' || ae.isContentEditable)) return;
      try{ scannerInput.focus({ preventScroll:true }); }catch(_){ }
    }
    setInterval(focusScannerInput, 500);
    document.addEventListener('click', focusScannerInput);
    document.addEventListener('touchstart', focusScannerInput);

    let scanTimer = null;
    function normalizeScanValue(v){
      return String(v || '')
        .replace(/[\r\n\t]/g, '')
        .replace(/\s+/g, '')
        .trim();
    }
    function commitScannerValue(){
      const raw = scannerInput.value;
      scannerInput.value = '';
      const code = normalizeScanValue(raw);
      if(!code) return;
      showLast(code, T[LANG].received, true);
      setStatus(T[LANG].received, '#22c55e');
      handleRawScan(code);
    }
    scannerInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === 'Tab'){
        e.preventDefault();
        if(scanTimer) clearTimeout(scanTimer);
        commitScannerValue();
      }
    });
    scannerInput.addEventListener('input', ()=>{
      if(scanTimer) clearTimeout(scanTimer);
      scanTimer = setTimeout(commitScannerValue, 70);
    });

    // ===== Lock =====
    let locked=false;
    function lockPause(){
      locked=true;
      const ms=Math.max(250, parseInt($('#pauseMs')?.value||'650',10));
      setTimeout(()=>{ locked=false; }, ms);
    }

    // Regex/Strict
    function strictOn(){ return ($('#strictMode')?.value||'off')==='on'; }
    function codeRegex(){ try{ return new RegExp($('#codeRegex')?.value||''); }catch{ return null; } }

    // ===== Firestore verification =====
    async function verifyAndMark(code){
      const L=T[LANG];
      setStatus(L.checking,'#f59e0b');

      try{
        // âœ… ensure signed in (anon)
        const ok = await ensureAnonAuth();
        if(!ok){
          showLast(code, "Auth failed", false);
          pushHist(code, "Auth failed", false);
          return;
        }

        const docRef = db.collection('invites').doc(code);
        const snap = await docRef.get();

        if(!snap.exists){
          showLast(code, L.notfound, false);
          pushHist(code, L.notfound, false);
          return;
        }

        const data = snap.data() || {};
        const ev = String(data.EventName || '').trim();
        const statusRaw = String(data.Status || '').trim().toLowerCase();

        if(ev !== EVENT_NAME){
          showLast(code, L.mismatch, false);
          pushHist(code, L.mismatch, false);
          return;
        }

        if(statusRaw === 'yes'){
          showLast(code, L.dupe, false);
          pushHist(code, L.dupe, false);
          return;
        }

        // âœ… update
        await docRef.set({
          Status:'yes',
          scannedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        showLast(code, L.ok, true);
        pushHist(code, L.ok, true);
        setStatus(L.ok,'#22c55e');

      }catch(e){
        console.error('Firestore error:', e);
        const msg = e?.message || 'Error';
        showLast(code, (LANG==='ar'?'Ø®Ø·Ø£: ':'Error: ') + msg, false);
        pushHist(code, (LANG==='ar'?'Ø®Ø·Ø£: ':'Error: ') + msg, false);
        setStatus((LANG==='ar'?'Ø®Ø·Ø£':'Error'),'#ef4444');
      }
    }

    function onCode(code){
      if(!code) return;
      if(locked) return;
      lockPause();
      verifyAndMark(code);
    }

    function handleRawScan(raw){
      const cleaned = String(raw||'').trim();
      if(!cleaned) return;

      if(!EVENT_NAME){
        showLast(cleaned, T[LANG].needEvent, false);
        return;
      }

      const strict=strictOn();
      const re=codeRegex();
      if(strict){
        if(!re) return;
        if(!re.test(cleaned)) return;
      }

      onCode(cleaned);
    }

    // ===== Camera =====
    let devices=[], currentDeviceId=null, track=null, scanning=false, rafId=null, reader=null, ndet=null;

    async function ensurePerm(){
      try{
        const tmp=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false});
        tmp.getTracks().forEach(t=>t.stop());
      }catch{}
    }
    async function listCams(){
      const all=await navigator.mediaDevices.enumerateDevices();
      devices=all.filter(d=>d.kind==='videoinput');
      const sel=$('#cameraSelect'); sel.innerHTML='';
      devices.forEach((d,i)=>{
        const o=document.createElement('option');
        o.value=d.deviceId;
        o.textContent=d.label||`Camera ${i+1}`;
        sel.appendChild(o);
      });
      if(devices.length){
        if(!currentDeviceId){
          const back=devices.find(d=>/back|rear|environment|Ø®Ù„Ù/i.test(d.label||''));
          currentDeviceId=back?back.deviceId:devices[0].deviceId;
        }
        sel.value=currentDeviceId;
      }
    }

    async function start(){
      const L=T[LANG];
      if(!EVENT_NAME){ alert(L.needEvent); return; }
      if(!httpsOK()){ alert(L.needHttps); return; }

      // âœ… Ensure auth before camera scanning too
      const ok = await ensureAnonAuth();
      if(!ok) return;

      await ensurePerm(); await listCams();

      const video=$('#video');
      const dev=$('#cameraSelect').value||currentDeviceId;
      currentDeviceId=dev;

      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          deviceId: dev ? { exact: dev } : undefined,
          facingMode: { ideal: "environment" },
          width:  { ideal: 640 },
          height: { ideal: 480 },
          frameRate: { ideal: 20, max: 30 }
        },
        audio:false
      });

      video.srcObject=stream;
      await video.play().catch(()=>{});
      track=stream.getVideoTracks()[0]||null;
      try{ await track.applyConstraints({ advanced: [{ focusMode: "continuous" }] }); }catch(_){}

      scanning=true;
      $('#startBtn').disabled=true;
      $('#stopBtn').disabled=false;
      $('#switchBtn').disabled=false;
      $('#torchBtn').disabled=false;
      setStatus(L.ready,'#22c55e');

      const zxingOk=await window.ensureZXing();

      if(zxingOk && window.ZXing && window.ZXing.BrowserMultiFormatReader){
        reader=new window.ZXing.BrowserMultiFormatReader();
        reader.decodeFromVideoDevice(dev||null, video, (res,err)=>{
          if(res){
            if(locked) return;
            const text=res.getText?res.getText():(res.text||'');
            handleRawScan(String(text||'').trim());
          }
        });
      } else if('BarcodeDetector' in window){
        ndet=new window.BarcodeDetector({formats:['qr_code']});
        const loop=async()=>{
          if(!scanning) return;
          try{
            if(!locked){
              const bar=await ndet.detect(video);
              if(bar && bar.length) handleRawScan(String(bar[0].rawValue||'').trim());
            }
          }catch{}
          rafId=requestAnimationFrame(loop);
        };
        loop();
      } else {
        alert(T[LANG].camlib);
        setStatus(T[LANG].camlib,'#f59e0b');
      }
    }

    async function stop(){
      try{
        if(reader){ try{reader.reset();}catch{} reader=null; }
        if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
        if(track){ try{track.stop();}catch{} track=null; }
        const v=$('#video');
        if(v.srcObject){
          v.srcObject.getTracks().forEach(t=>t.stop());
          v.srcObject=null;
        }
      }catch{}
      scanning=false;
      $('#startBtn').disabled=false;
      $('#stopBtn').disabled=true;
      setStatus(T[LANG].paused,'#f59e0b');
    }

    async function switchCam(){
      if(!devices.length) return;
      const idx=devices.findIndex(d=>d.deviceId===currentDeviceId);
      const next=devices[(idx+1)%devices.length];
      currentDeviceId=next.deviceId;
      $('#cameraSelect').value=currentDeviceId;
      if(scanning){ await stop(); await start(); }
    }

    async function toggleTorch(){
      try{
        if(!track) return;
        const caps=track.getCapabilities?.();
        if(!caps?.torch) return alert('No torch');
        const current = track.getConstraints()?.advanced?.[0]?.torch === true;
        await track.applyConstraints({advanced:[{torch: !current}]});
      }catch(e){ alert('Torch error'); }
    }

    // ===== Gate actions =====
    async function enterFromGate(){
      const v = ($('#gateEvent').value||'').trim();
      if(!v){ $('#gateMsg').textContent = (LANG==='ar'?'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«':'Enter event name'); return; }

      // âœ… ensure auth before entering
      const ok = await ensureAnonAuth();
      if(!ok) return;

      setEvent(v);
      $('#gate').style.display='none';
      allowUI(true);

      // enable scanner focus after entering event
      scannerEnabled = true;
      setTimeout(focusScannerInput, 120);
      setTimeout(focusScannerInput, 450);
    }

    // ===== Wire =====
    document.addEventListener('DOMContentLoaded', async ()=>{
      applyDir(); i18n(); httpsOK(); tryInitEvent(); renderHist(); drawQRPreview('');
      $('#authTag').textContent = '...';

      // start auth early
      await ensureAnonAuth();

      $('#gateEnter').addEventListener('click', enterFromGate);
      $('#gateEvent').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); enterFromGate(); } });

      $('#accToggle').addEventListener('click', ()=>{
        const bd=$('#accBody');
        const open=bd.classList.toggle('open');
        $('#accToggle').setAttribute('aria-label', open? T[LANG].accClose : T[LANG].accOpen);
      });

      const savedW=localStorage.getItem('hs:evscan:scanw');
      if(savedW) $('#scanSize').value=savedW;
      applyScanSize();
      $('#scanSize').addEventListener('change', applyScanSize);

      $('#langBtn').addEventListener('click', ()=>{
        LANG=(LANG==='ar')?'en':'ar';
        localStorage.setItem('hs:evscan:lang',LANG);
        applyDir(); i18n(); renderHist();
      });

      $('#startBtn').addEventListener('click', ()=>{ ensureAudio(); start(); focusScannerInput(); });
      $('#stopBtn').addEventListener('click', stop);
      $('#switchBtn').addEventListener('click', switchCam);
      $('#torchBtn').addEventListener('click', toggleTorch);

      $('#manualBtn').addEventListener('click', ()=>{
        ensureAudio();
        const c=$('#manualCode').value.trim();
        if(!c) return;
        showLast(c, T[LANG].received, true);
        handleRawScan(c);
      });

      $('#clearHist').addEventListener('click', ()=>{
        if(!EVENT_NAME) return;
        localStorage.removeItem(hKey());
        renderHist();
      });
    });

    function applyScanSize(){
      const wrap=$('#scanWrap'); if(!wrap) return;
      const w=$('#scanSize')?.value||'480';
      wrap.style.maxWidth=w+'px';
      localStorage.setItem('hs:evscan:scanw', w);
    }
  })();
  </script>
</body>
</html>
