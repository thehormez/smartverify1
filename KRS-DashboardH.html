<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KRS INVITE â€” Dashboard + Final Report</title>

  <style>
    :root{
      --bg:#070a12;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(0,0,0,.22);
      --stroke:rgba(255,255,255,.12);
      --ink:#eef2ff;
      --muted:#a8b3c7;

      --gold:#d4af37;
      --gold2:rgba(212,175,55,.22);

      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;

      --shadow:0 18px 55px rgba(0,0,0,.45);
      --r:20px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Tahoma, Arial, "Noto Sans Arabic", sans-serif;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); font-family:var(--font);
      background:
        radial-gradient(950px 520px at 82% -15%, rgba(212,175,55,.20), transparent 60%),
        radial-gradient(800px 440px at 12% 0%, rgba(99,102,241,.10), transparent 55%),
        linear-gradient(180deg,#050712,var(--bg));
    }

    .wrap{width:min(1180px,94vw); margin:18px auto 60px;}
    .topbar{
      position:sticky; top:0; z-index:15;
      background:rgba(7,10,18,.72);
      backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 22px;
      padding:12px;
      box-shadow:var(--shadow);
    }
    .toprow{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:46px; height:46px; border-radius:14px;
      display:grid; place-items:center;
      font-weight:1000;
      color:var(--gold);
      border:1px solid rgba(212,175,55,.35);
      background:linear-gradient(135deg, rgba(212,175,55,.22), rgba(255,255,255,.05));
    }
    .titles h1{margin:0; font-size:16px; letter-spacing:.2px}
    .titles .sub{margin-top:4px; color:var(--muted); font-size:12.5px}

    .tools{margin-inline-start:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    select, input, button{
      font-family:inherit;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--ink);
      padding:10px 12px;
      outline:none;
      font-weight:900;
    }
    input::placeholder{color:rgba(168,179,199,.7)}
    button{cursor:pointer}
    button:hover{transform:translateY(-1px)}
    button:active{transform:translateY(0px)}
    .btn-primary{
      border-color: rgba(212,175,55,.35);
      background: linear-gradient(135deg, rgba(212,175,55,.28), rgba(255,255,255,.06));
    }
    .btn-ghost{
      background: rgba(0,0,0,.20);
      border-color: rgba(255,255,255,.14);
    }

    .grid{display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px;}
    .card{
      padding:14px;
      border-radius:22px;
      border:1px solid var(--stroke);
      background:var(--panel);
      box-shadow:var(--shadow);
    }
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .sep{height:1px; margin:12px 0; background:linear-gradient(90deg,transparent, rgba(212,175,55,.22), rgba(255,255,255,.10), transparent);}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}

    .kpis{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:10px;}
    @media(max-width:900px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    @media(max-width:520px){ .kpis{grid-template-columns:1fr} }

    .kpi{
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
    }
    .kpi .t{font-size:12px; font-weight:1000; color:var(--muted)}
    .kpi .v{margin-top:8px; font-size:26px; font-weight:1000}
    .kpi .s{margin-top:8px; font-size:12px; color:var(--muted)}

    .bar{
      height:12px; border-radius:999px; overflow:hidden;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
    }
    .bar > div{
      height:100%; width:0%;
      background:linear-gradient(90deg, rgba(212,175,55,.96), rgba(255,255,255,.18));
    }

    table{width:100%; border-collapse:collapse; margin-top:10px; font-size:12.5px}
    th,td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); text-align:right}
    th{color:var(--muted); font-weight:1000; position:sticky; top:0; background:rgba(10,14,26,.95); backdrop-filter: blur(6px)}
    .tag{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      font-weight:1000; font-size:11px; white-space:nowrap;
    }
    .dot{width:8px; height:8px; border-radius:999px; background:var(--muted)}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    /* ===== PRINT REPORT ===== */
    #report{display:none;}
    @media print{
      body{background:#fff !important; color:#111 !important;}
      #app{display:none !important;}
      #report{display:block !important;}
      .wrap{width:100% !important; margin:0 !important;}
      .topbar,.card{box-shadow:none !important; background:#fff !important; border:1px solid #ddd !important;}
      th{background:#f5f5f5 !important; color:#111 !important;}
      .muted{color:#444 !important;}
      .kpi{background:#fff !important; border:1px solid #e8e8e8 !important;}
      .tag{border-color:#ddd !important; background:#f7f7f7 !important; color:#111 !important;}
      .bar{background:#eee !important; border-color:#ddd !important;}
      .bar > div{background:#111 !important;}
      .logo{border-color:#ddd !important; color:#111 !important; background:#fff !important;}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- ===================== APP (Dashboard) ===================== -->
    <section id="app">

      <div class="topbar">
        <div class="toprow">
          <div class="brand">
            <div class="logo">KRS</div>
            <div class="titles">
              <h1>KRS INVITE â€” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
              <div class="sub">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¯Ø« Ù…Ù† Ø§Ù„Ø³Ø³ØªÙ… (EventName) Ø«Ù… Ø§Ø·Ø¨Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div>
            </div>
          </div>

          <div class="tools">
            <button id="langBtn" class="btn-ghost">AR</button>
            <button id="refreshBtn" class="btn-ghost">â†» ØªØ­Ø¯ÙŠØ«</button>
          </div>
        </div>
      </div>

      <div class="grid">

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:1000" id="evTitle">â€”</div>
              <div class="muted" style="font-size:12px; margin-top:6px" id="evInfo">â€”</div>
            </div>
            <div class="muted mono" id="statusLine">â€”</div>
          </div>

          <div class="sep"></div>

          <!-- Filters -->
          <div class="row">
            <div style="flex:1; min-width:240px">
              <div class="muted" id="lblEvent" style="font-size:12px; margin-bottom:6px">Ø§Ù„Ø­Ø¯Ø«</div>
              <select id="eventSelect"></select>
            </div>

            <div style="flex:1; min-width:220px">
              <div class="muted" id="lblSearch" style="font-size:12px; margin-bottom:6px">Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯â€¦</div>
              <input id="searchInput" placeholder="KH_001" />
            </div>

            <div style="display:flex; gap:10px; align-items:end; flex-wrap:wrap">
              <button id="exportBtn" class="btn-ghost">â¤“ ØªØµØ¯ÙŠØ± CSV</button>
              <button id="printBtn" class="btn-primary">ğŸ–¨ï¸ ØªÙ‚Ø±ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ</button>
            </div>
          </div>

          <div class="sep"></div>

          <!-- Date filter -->
          <div class="row" style="align-items:end">
            <div style="flex:1; min-width:220px">
              <div class="muted" id="lblFrom" style="font-size:12px; margin-bottom:6px">Ù…Ù† ØªØ§Ø±ÙŠØ®</div>
              <input id="dateFrom" type="date" />
            </div>
            <div style="flex:1; min-width:220px">
              <div class="muted" id="lblTo" style="font-size:12px; margin-bottom:6px">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</div>
              <input id="dateTo" type="date" />
            </div>
            <div class="row">
              <button id="applyDate" class="btn-ghost">ØªØ·Ø¨ÙŠÙ‚</button>
              <button id="clearDate" class="btn-ghost">Ù…Ø³Ø­</button>
            </div>
            <div id="activeFilter" class="muted" style="margin-inline-start:auto; font-size:12px"></div>
          </div>

          <!-- KPIs -->
          <div class="kpis" style="margin-top:12px">
            <div class="kpi">
              <div class="t" id="kpiTotalLbl">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
              <div class="v" id="kpiTotal">â€”</div>
              <div class="s">Total invites</div>
            </div>
            <div class="kpi">
              <div class="t" id="kpiUsedLbl">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
              <div class="v" id="kpiUsed">â€”</div>
              <div class="s">Checked-in</div>
            </div>
            <div class="kpi">
              <div class="t" id="kpiLeftLbl">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
              <div class="v" id="kpiLeft">â€”</div>
              <div class="s">Remaining</div>
            </div>
            <div class="kpi">
              <div class="t" id="kpiRateLbl">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div>
              <div class="v" id="kpiRate">â€”%</div>
              <div class="s">Attendance</div>
            </div>
          </div>

          <div class="sep"></div>

          <!-- Attendance bar -->
          <div style="font-weight:1000; margin-bottom:8px">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div>
          <div class="bar"><div id="attBar"></div></div>
          <div class="muted" style="font-size:12px; margin-top:8px" id="attMeta">â€”</div>

          <div class="sep"></div>

          <!-- Table -->
          <div class="row" style="justify-content:space-between">
            <div style="font-weight:1000" id="recentLbl">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø­Ø§Øª (Ø¢Ø®Ø± 100)</div>
            <div class="muted mono" id="rowsMeta">â€”</div>
          </div>

          <div style="max-height:60vh; overflow:auto; margin-top:10px; border-radius:16px; border:1px solid rgba(255,255,255,.10)">
            <table>
              <thead>
                <tr>
                  <th id="thCode">Ø§Ù„ÙƒÙˆØ¯</th>
                  <th id="thStatus">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th id="thTime">Ø§Ù„ÙˆÙ‚Øª</th>
                  <th id="thEvent">Ø§Ù„Ø­Ø¯Ø«</th>
                </tr>
              </thead>
              <tbody id="rowsBody"></tbody>
            </table>
          </div>

          <div class="muted" style="font-size:12px; margin-top:10px">
            Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¹Ø±Ø¶ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„ÙˆØ­Ø© Ø¢Ø®Ø± 100 Ø³Ø¬Ù„ ÙÙ‚Ø· Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ â€” Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙŠØ·Ø¨Ø¹ Ø¢Ø®Ø± 200.
          </div>
        </div>

      </div>
    </section>

    <!-- ===================== REPORT (Print) ===================== -->
    <section id="report">
      <div class="topbar">
        <div class="toprow">
          <div class="brand">
            <div class="logo">KRS</div>
            <div class="titles">
              <h1>KRS INVITE â€” Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</h1>
              <div class="sub" id="rSub">Ù†Ø³Ø®Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© / PDF</div>
            </div>
          </div>
          <div class="muted mono" id="rGen">â€”</div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:1000; font-size:16px" id="rEventTitle">â€”</div>
            <div class="muted" style="font-size:12px; margin-top:6px" id="rInfo">â€”</div>
          </div>
          <div class="tag"><span class="dot good"></span> KRS INVITE</div>
        </div>

        <div class="kpis" id="rKpis" style="margin-top:12px"></div>

        <div class="sep"></div>
        <div style="font-weight:1000; margin-bottom:8px">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div>
        <div class="bar"><div id="rAttBar"></div></div>
        <div class="muted" style="font-size:12px; margin-top:8px" id="rAttMeta">â€”</div>

        <div class="sep"></div>
        <div class="row" style="justify-content:space-between">
          <div style="font-weight:1000">ØªÙØ§ØµÙŠÙ„ (Ø¢Ø®Ø± 200 Ø³Ø¬Ù„)</div>
          <div class="muted mono" id="rRowsCount">â€”</div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Ø§Ù„ÙƒÙˆØ¯</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th>Ø§Ù„Ø­Ø¯Ø«</th>
            </tr>
          </thead>
          <tbody id="rBody"></tbody>
        </table>

        <div class="muted" style="font-size:12px; margin-top:10px" id="rFooter">â€”</div>
      </div>
    </section>

  </div>

  <!-- Firebase SDKs (Module, same as your old dashboard) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot, getDocs, limit, orderBy, startAfter } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ===== i18n (from your old code, extended a bit) =====
    const STR = {
      en: {
        event:"Event", search:"Search codeâ€¦", export:"Export CSV", report:"Final Report",
        total:"Total", used:"Checked-in", left:"Remaining", rate:"Attendance",
        recent:"Recent scans (latest 100)", code:"Code", status:"Status", time:"Time", ev:"Event",
        all:"All events", refreshed:"Refreshed",
        from:"From", to:"To", apply:"Apply", clear:"Clear",
        filterActive:(f,t)=>`Filter: ${f} â†’ ${t}`,
        noScans:"No scans yet"
      },
      ar: {
        event:"Ø§Ù„Ø­Ø¯Ø«", search:"Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯â€¦", export:"ØªØµØ¯ÙŠØ± CSV", report:"ØªÙ‚Ø±ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ",
        total:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", used:"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", left:"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ", rate:"Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±",
        recent:"Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø­Ø§Øª (Ø¢Ø®Ø± 100)", code:"Ø§Ù„ÙƒÙˆØ¯", status:"Ø§Ù„Ø­Ø§Ù„Ø©", time:"Ø§Ù„ÙˆÙ‚Øª", ev:"Ø§Ù„Ø­Ø¯Ø«",
        all:"ÙƒÙ„ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª", refreshed:"ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«",
        from:"Ù…Ù† ØªØ§Ø±ÙŠØ®", to:"Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®", apply:"ØªØ·Ø¨ÙŠÙ‚", clear:"Ù…Ø³Ø­",
        filterActive:(f,t)=>`ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙÙ„ØªØ±: ${f} â†’ ${t}`,
        noScans:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø­Ø§Øª"
      }
    };

    const $ = (s, root=document)=>root.querySelector(s);

    const state = {
      lang: localStorage.getItem('krs:dash:lang') || 'ar',
      event: localStorage.getItem('krs:dash:event') || '__ALL__',
      from: '',
      to: ''
    };

    // ===== Firebase (same config you provided) =====
    const firebaseConfig = {
      apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
      authDomain:"hormez-inv.firebaseapp.com",
      projectId:"hormez-inv",
      storageBucket:"hormez-inv.firebasestorage.app",
      messagingSenderId:"747519941805",
      appId:"1:747519941805:web:468fada2492700e9da3a24"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const COL = 'invites';

    // ===== Helpers =====
    const nowStamp = ()=>{
      const d=new Date();
      const pad=(x)=>String(x).padStart(2,'0');
      const dd=pad(d.getDate()), mm=pad(d.getMonth()+1), yy=d.getFullYear();
      let hh=d.getHours(), ap=hh>=12?'PM':'AM'; hh=hh%12; if(hh===0) hh=12;
      return `${dd}-${mm}-${yy}  ${hh}:${pad(d.getMinutes())} ${ap}`;
    };

    function applyLang(){
      const L = STR[state.lang] || STR.en;
      const isAr = state.lang === 'ar';
      document.documentElement.lang = state.lang;
      document.documentElement.dir = isAr ? 'rtl' : 'ltr';

      $('#langBtn').textContent = isAr ? 'EN' : 'AR';

      $('#lblEvent').textContent = L.event;
      $('#lblSearch').textContent = L.search;
      $('#exportBtn').textContent = (isAr ? 'â¤“ ' : '') + L.export;
      $('#printBtn').textContent = 'ğŸ–¨ï¸ ' + (isAr ? L.report : L.report);

      $('#kpiTotalLbl').textContent = L.total;
      $('#kpiUsedLbl').textContent = L.used;
      $('#kpiLeftLbl').textContent = L.left;
      $('#kpiRateLbl').textContent = L.rate;

      $('#recentLbl').textContent = L.recent;

      $('#thCode').textContent = L.code;
      $('#thStatus').textContent = L.status;
      $('#thTime').textContent = L.time;
      $('#thEvent').textContent = L.ev;

      $('#lblFrom').textContent = L.from;
      $('#lblTo').textContent = L.to;
      $('#applyDate').textContent = L.apply;
      $('#clearDate').textContent = L.clear;

      renderActiveFilter();
    }

    function renderActiveFilter(){
      const L = STR[state.lang] || STR.en;
      const box = $('#activeFilter');
      if(state.from || state.to) box.textContent = L.filterActive(state.from||'â€”', state.to||'â€”');
      else box.textContent = '';
    }

    function isYes(status){
      return (status||'').toString().trim().toLowerCase() === 'yes';
    }

    function withinDateRange(d){
      if(!d) return false;
      const ts = d.getTime();
      if(state.from){
        const fromTs = new Date(state.from+"T00:00:00").getTime();
        if(ts < fromTs) return false;
      }
      if(state.to){
        const toTs = new Date(state.to+"T23:59:59").getTime();
        if(ts > toTs) return false;
      }
      return true;
    }

    function setStatusLine(msg){ $('#statusLine').textContent = msg; }

    function setEventTitle(){
      const L = STR[state.lang] || STR.en;
      $('#evTitle').textContent = (state.event==='__ALL__') ? (state.lang==='ar' ? 'ÙƒÙ„ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª' : 'All events') : state.event;
      $('#evInfo').textContent = (state.event==='__ALL__')
        ? (state.lang==='ar' ? 'Ø¹Ø±Ø¶ Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…' : 'Overall view for all invites in the system')
        : (state.lang==='ar' ? 'Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø­Ø¶ÙˆØ± ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª' : 'Live attendance & invite status');
    }

    function renderKPIs(total, used){
      const left = Math.max(total - used, 0);
      const rate = total > 0 ? Math.round((used/total)*1000)/10 : 0;

      $('#kpiTotal').textContent = total.toLocaleString();
      $('#kpiUsed').textContent = used.toLocaleString();
      $('#kpiLeft').textContent = left.toLocaleString();
      $('#kpiRate').textContent = rate + '%';

      const pct = Math.max(0, Math.min(100, rate));
      $('#attBar').style.width = pct + '%';
      $('#attMeta').textContent = `${state.lang==='ar'?'Ø­Ø¶ÙˆØ±':'Attendance'}: ${used.toLocaleString()} / ${total.toLocaleString()} Â· ${state.lang==='ar'?'Ø§Ù„Ù†Ø³Ø¨Ø©':'Rate'}: ${rate}%`;
    }

    function tagHTML(status){
      const s = (status||'no').toString().trim().toLowerCase();
      if(s==='yes') return `<span class="tag"><span class="dot good"></span>yes</span>`;
      return `<span class="tag"><span class="dot warn"></span>no</span>`;
    }

    // ===== Data =====
    let unsub = null;
    let rowsAll = [];   // all scans rows for current event selection (with scannedAt)
    let rowsView = [];  // filtered rows for UI

    // ===== Populate events (from your old dashboard approach) =====
    async function loadEvents(){
      const L = STR[state.lang] || STR.en;

      // Ù†Ø¬Ù…Ø¹ EventName Ù…Ù† Ø£ÙˆÙ„ 500 Ø¯Ø¹ÙˆØ© (Ù…Ø«Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
      const ref = collection(db, COL);
      const snap = await getDocs(query(ref, limit(500)));

      const setE = new Set();
      snap.forEach(d=>{
        const ev = (d.data()?.EventName || '').toString().trim();
        if(ev) setE.add(ev);
      });

      const list = ['__ALL__', ...Array.from(setE).sort((a,b)=>a.localeCompare(b, 'ar'))];

      const sel = $('#eventSelect');
      sel.innerHTML = '';
      for(const ev of list){
        const opt = document.createElement('option');
        opt.value = ev;
        opt.textContent = (ev==='__ALL__') ? L.all : ev;
        sel.appendChild(opt);
      }

      // Ø­ÙØ¸/Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± Ø§Ø®ØªÙŠØ§Ø±
      if(!list.includes(state.event)) state.event = '__ALL__';
      sel.value = state.event;
      localStorage.setItem('krs:dash:event', state.event);

      setEventTitle();
    }

    // ===== Live Stream =====
    function startStream(){
      if(unsub) unsub();

      setEventTitle();
      setStatusLine('Loadingâ€¦');

      const ref = collection(db, COL);
      const qAll = (state.event && state.event !== '__ALL__')
        ? query(ref, where('EventName','==', state.event))
        : query(ref);

      unsub = onSnapshot(qAll, snap=>{
        let total = 0, used = 0;
        const rec = [];

        snap.forEach(d=>{
          const x = d.data() || {};
          total++;

          const st = (x.Status || 'no');
          if(isYes(st)) used++;

          // table is based on scannedAt
          const dt = x.scannedAt?.toDate?.() ? x.scannedAt.toDate() : null;
          if(dt){
            rec.push({
              id: d.id,
              Code: x.Code || d.id,
              Status: st || 'no',
              EventName: x.EventName || '',
              scannedAt: dt
            });
          }
        });

        renderKPIs(total, used);

        rowsAll = rec.sort((a,b)=>(b.scannedAt?.getTime?.()||0)-(a.scannedAt?.getTime?.()||0));
        applyFilters();

        setStatusLine(`Updated: ${nowStamp()}`);
      }, err=>{
        console.error(err);
        setStatusLine('Error loading data');
      });
    }

    function applyFilters(){
      const s = ($('#searchInput').value||'').trim().toLowerCase();

      let list = rowsAll;
      if(state.from || state.to) list = list.filter(r=> withinDateRange(r.scannedAt));
      if(s) list = list.filter(r=> (r.Code||'').toLowerCase().includes(s));

      rowsView = list.slice(0,100);
      renderRows();

      $('#rowsMeta').textContent = `Rows: ${rowsView.length} / ${rowsAll.length}`;
      renderActiveFilter();
    }

    function renderRows(){
      const L = STR[state.lang] || STR.en;
      const tb = $('#rowsBody');
      tb.innerHTML = '';

      if(rowsView.length === 0){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 4;
        td.className = 'muted';
        td.style.textAlign = 'center';
        td.style.padding = '18px';
        td.textContent = L.noScans;
        tr.appendChild(td);
        tb.appendChild(tr);
        return;
      }

      const isAr = state.lang==='ar';
      for(const r of rowsView){
        const tr = document.createElement('tr');

        const td1=document.createElement('td');
        td1.className='mono';
        td1.textContent = r.Code;
        tr.appendChild(td1);

        const td2=document.createElement('td');
        td2.innerHTML = tagHTML(r.Status);
        tr.appendChild(td2);

        const td3=document.createElement('td');
        td3.className='mono';
        td3.textContent = r.scannedAt ? r.scannedAt.toLocaleString(isAr?'ar-EG':'en-GB') : 'â€”';
        tr.appendChild(td3);

        const td4=document.createElement('td');
        td4.textContent = r.EventName || (state.event==='__ALL__'?'ALL':'â€”');
        tr.appendChild(td4);

        tb.appendChild(tr);
      }
    }

    function exportCSV(){
      const L = STR[state.lang] || STR.en;
      const header = [L.code, L.status, 'EventName', L.time].join(',');

      // Ù†ØµØ¯Ø± Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ (100) â€” Ù„Ùˆ ØªØ¨ØºÙ‰ Ø§Ù„ÙƒÙ„ (rowsAll) Ù‚ÙˆÙ„ÙŠ
      const lines = rowsView.map(r=>[
        r.Code,
        (r.Status||'no'),
        r.EventName || (state.event==='__ALL__' ? 'ALL' : state.event),
        r.scannedAt ? new Date(r.scannedAt).toISOString() : ''
      ].join(','));

      const csv = [header, ...lines].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `KRS-${state.event||'all'}-scans.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ===== Final Report (Print) =====
    function makeKpiBox(title, value, sub){
      return `
        <div class="kpi">
          <div class="t">${title}</div>
          <div class="v">${value}</div>
          <div class="s">${sub}</div>
        </div>
      `;
    }

    function renderFinalReport(){
      // Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„ (Total/Used) Ù…Ù† Ø§Ù„Ù„ÙˆØ­Ø© â€” Ù‡Ù†Ø§ Ù†Ø¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø³Ø±ÙŠØ¹ Ù…Ù† DOM
      const total = parseInt(($('#kpiTotal').textContent||'0').replace(/,/g,''),10) || 0;
      const used  = parseInt(($('#kpiUsed').textContent||'0').replace(/,/g,''),10) || 0;
      const left  = Math.max(total - used, 0);
      const rate  = total>0 ? Math.round((used/total)*1000)/10 : 0;

      $('#rGen').textContent = 'Generated: ' + nowStamp();
      $('#rEventTitle').textContent = (state.event==='__ALL__')
        ? (state.lang==='ar'?'ÙƒÙ„ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª':'All events')
        : state.event;

      const filterLine = (state.from || state.to)
        ? ` Â· Filter: ${state.from||'â€”'} â†’ ${state.to||'â€”'}`
        : '';

      $('#rInfo').textContent =
        `Total: ${total.toLocaleString()} Â· Checked-in: ${used.toLocaleString()} Â· Remaining: ${left.toLocaleString()} Â· Rate: ${rate}%${filterLine}`;

      $('#rKpis').innerHTML =
        makeKpiBox(state.lang==='ar'?'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ':'Total', total.toLocaleString(), 'Total invites') +
        makeKpiBox(state.lang==='ar'?'ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„':'Checked-in', used.toLocaleString(), `Rate: ${rate}%`) +
        makeKpiBox(state.lang==='ar'?'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ':'Remaining', left.toLocaleString(), 'Not used') +
        makeKpiBox(state.lang==='ar'?'Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±':'Attendance', rate + '%', 'Attendance');

      $('#rAttBar').style.width = Math.max(0, Math.min(100, rate)) + '%';
      $('#rAttMeta').textContent = `${state.lang==='ar'?'Ø­Ø¶ÙˆØ±':'Attendance'}: ${used.toLocaleString()} / ${total.toLocaleString()} Â· ${state.lang==='ar'?'Ø§Ù„Ù†Ø³Ø¨Ø©':'Rate'}: ${rate}%`;

      // Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: Ø¢Ø®Ø± 200 Ø³Ø¬Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      const s = ($('#searchInput').value||'').trim().toLowerCase();
      let list = rowsAll;
      if(state.from || state.to) list = list.filter(r=> withinDateRange(r.scannedAt));
      if(s) list = list.filter(r=> (r.Code||'').toLowerCase().includes(s));

      const out = list.slice(0,200);
      $('#rRowsCount').textContent = `Rows: ${out.length}`;

      const isAr = state.lang==='ar';
      $('#rBody').innerHTML = out.map(r=>`
        <tr>
          <td class="mono">${r.Code||'â€”'}</td>
          <td>${tagHTML(r.Status)}</td>
          <td class="mono">${r.scannedAt ? r.scannedAt.toLocaleString(isAr?'ar-EG':'en-GB') : 'â€”'}</td>
          <td>${r.EventName || (state.event==='__ALL__'?'ALL':'â€”')}</td>
        </tr>
      `).join('');

      $('#rFooter').textContent = `KRS INVITE Â· Final Report Â· ${nowStamp()}`;
    }

    function printFinalReport(){
      renderFinalReport();
      setTimeout(()=>window.print(), 90);
    }

    // ===== Wire UI =====
    document.addEventListener('DOMContentLoaded', async ()=>{
      applyLang();

      // defaults
      $('#dateFrom').value = '';
      $('#dateTo').value = '';

      await loadEvents();
      startStream();
      setStatusLine('Ready Â· ' + nowStamp());

      $('#langBtn').addEventListener('click', async ()=>{
        state.lang = state.lang==='ar' ? 'en' : 'ar';
        localStorage.setItem('krs:dash:lang', state.lang);
        applyLang();
        await loadEvents();
        startStream();
        applyFilters();
      });

      $('#refreshBtn').addEventListener('click', ()=> location.reload());

      $('#eventSelect').addEventListener('change', (e)=>{
        state.event = e.target.value;
        localStorage.setItem('krs:dash:event', state.event);
        startStream();
      });

      $('#searchInput').addEventListener('input', ()=> applyFilters());

      $('#exportBtn').addEventListener('click', exportCSV);
      $('#printBtn').addEventListener('click', printFinalReport);

      $('#applyDate').addEventListener('click', ()=>{
        state.from = $('#dateFrom').value || '';
        state.to   = $('#dateTo').value || '';
        applyFilters();
      });

      $('#clearDate').addEventListener('click', ()=>{
        state.from = '';
        state.to   = '';
        $('#dateFrom').value = '';
        $('#dateTo').value   = '';
        applyFilters();
      });
    });
  </script>
</body>
</html>
