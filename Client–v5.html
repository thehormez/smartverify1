<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ â€” Ø£Ø³ÙˆØ¯/Ø°Ù‡Ø¨ÙŠ + Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700;900&display=swap" rel="stylesheet" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    :root{ --bg:#0b0b0c; --panel:#14151a; --panel-2:#111217; --stroke:#27282f; --gold:#d4af37; --txt:#e7e7e7; --muted:#a7a7a7; --danger:#ef4444; --ok:#25d366 }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family:'Noto Sans Arabic', system-ui, -apple-system, Segoe UI, Arial; background:var(--bg); color:var(--txt) }
    .container{ max-width:1280px; margin:0 auto; padding:16px }
    .topbar{ position:sticky; top:0; z-index:50; background:linear-gradient(180deg, rgba(10,10,12,.9), rgba(10,10,12,.75)); border-bottom:1px solid var(--stroke); backdrop-filter:blur(6px) }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900 }
    .brand .dot{ width:12px; height:12px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #ffe8a3, var(--gold)) }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .field{ width:auto; min-width:200px; padding:8px 10px; border-radius:10px; border:1px solid var(--stroke); background:#0f1013; color:var(--txt) }
    .btn{ border:1px solid var(--stroke); background:#0f1013; color:#fff; padding:9px 12px; border-radius:10px; cursor:pointer; font-weight:800 }
    .btn.gold{ background:linear-gradient(180deg, #2a2211, #1f1a0d); border-color:var(--gold) }
    .btn.warn{ border-color:#7a1f1f }
    .btn.ok{ border-color:#1b8c4f }
    .hint{ color:var(--muted); font-size:12px }
    .tabs{ display:flex; gap:8px; padding:10px 0; flex-wrap:wrap }
    .tab{ border:1px solid var(--stroke); background:#111217; color:#ddd; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:800 }
    .tab.active{ border-color:var(--gold); color:#fff }
    .section{ display:none }
    .section.active{ display:block }
    .card{ background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid var(--stroke); border-radius:16px; padding:16px }
    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; margin-top:10px }
    thead th{ background:linear-gradient(180deg, #222328, #1a1b20); color:#f6f6f6; border-bottom:1px solid var(--stroke); padding:12px; text-align:right; font-weight:900 }
    tbody td{ padding:12px; border-bottom:1px solid var(--stroke) }
    tbody tr:hover{ background:rgba(212,175,55,0.05) }
    .editable{ cursor:pointer; color:#ffd76a; font-weight:800; text-decoration:underline dotted rgba(212,175,55,.6); text-underline-offset:3px }
    .kpi{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px }
    .kpi .card{ text-align:center }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:12px">
      <div class="brand"><span class="dot"></span><span>Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span></div>
      <div class="row">
        <input id="topEvent" class="field" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«" />
        <input id="topPass" type="password" class="field" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
        <button class="btn gold" onclick="saveTopMeta()">Ø­ÙØ¸</button>
        <button class="btn warn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <main class="container">
    <section class="kpi" style="margin:10px 0 16px">
      <div class="card"><div class="hint">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</div><div style="font-size:22px; font-weight:900" id="kpiTotal">0</div></div>
      <div class="card"><div class="hint">Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù…ÙØ±Ø³Ù„Ø©</div><div style="font-size:22px; font-weight:900" id="kpiSent">0</div></div>
      <div class="card"><div class="hint">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</div><div style="font-size:22px; font-weight:900" id="kpiRemain">0</div></div>
    </section>

    <nav class="tabs" id="tabs">
      <button class="tab active" data-section="#sec-home">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="tab" data-section="#sec-event">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯Ø«</button>
      <button class="tab" data-section="#sec-guests">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙŠÙˆÙ</button>
      <button class="tab" data-section="#sec-stock">Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</button>
      <button class="tab" data-section="#sec-list">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†</button>
    </nav>

    <section id="sec-home" class="section active">
      <div class="card"><h3>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</h3></div>
    </section>

    <section id="sec-event" class="section">
      <div class="card">
        <h3>ğŸ·ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯Ø«</h3>
        <div class="row">
          <input id="eventName" class="field" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«" />
          <button class="btn gold" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸ (JSON)</button>
        </div>
      </div>
    </section>

    <section id="sec-guests" class="section">
      <div class="card">
        <h3>ğŸ‘¥ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙŠÙˆÙ</h3>
        <div class="row">
          <input id="newGuestName" class="field" placeholder="Ø§Ù„Ø§Ø³Ù…" />
          <input id="newGuestPhone" class="field" placeholder="Ø§Ù„Ù‡Ø§ØªÙ" />
          <input id="newGuestTotalNeeded" type="number" class="field" value="1" />
          <button class="btn gold" onclick="addGuestManually()">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
      </div>
    </section>

    <section id="sec-stock" class="section">
      <div class="card">
        <h3>ğŸŸï¸ Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</h3>
        <input id="barcodeUpload" type="file" class="field" accept="image/*" multiple />
        <button class="btn gold" onclick="loadBarcodes()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
      </div>
    </section>

    <section id="sec-list" class="section">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†</h3>
          <button class="btn ok" onclick="sendAllWhatsApp()">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ</button>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
          <tbody id="guestTableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (ØºÙŠÙ‘Ø±Ù‡ Ù‡Ù†Ø§)
    const DEFAULT_EVENT = "Ø²ÙØ§Ù_Ø®Ø§Ù„Ø¯";   // Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«
    const DEFAULT_PASS  = "12345";        // ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±

    const LS_EVENTS='hormez_events_meta';
    const LS_AUTH='hormez_auth_event';
    const getEventMeta=()=>JSON.parse(localStorage.getItem(LS_EVENTS)||'{}');
    const setEventMeta=(o)=>localStorage.setItem(LS_EVENTS, JSON.stringify(o||{}));

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    (function boot(){
      const meta=getEventMeta();
      meta[DEFAULT_EVENT]={password:DEFAULT_PASS};
      setEventMeta(meta);
      localStorage.setItem(LS_AUTH, JSON.stringify({event:DEFAULT_EVENT}));
      document.getElementById('topEvent').value=DEFAULT_EVENT;
      document.getElementById('topPass').value=DEFAULT_PASS;
      document.getElementById('eventName').value=DEFAULT_EVENT;
    })();

    // ØªÙ†Ù‚Ù„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    document.querySelectorAll('#tabs .tab').forEach(tab=>{
      tab.addEventListener('click',()=>{
        document.querySelectorAll('#tabs .tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const id=tab.dataset.section;
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        document.querySelector(id).classList.add('active');
      });
    });

    let guests=[]; let barcodeImages={}; let availableQrIds=[];

    function addGuestManually(){
      const n=document.getElementById('newGuestName').value;
      const p=document.getElementById('newGuestPhone').value;
      const c=parseInt(document.getElementById('newGuestTotalNeeded').value)||1;
      if(!n||!p){alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‡Ø§ØªÙ');return;}
      guests.push({name:n,phone:p,totalNeeded:c,status:'new'});
      renderGuestTable();
    }

    function renderGuestTable(){
      const body=document.getElementById('guestTableBody');
      body.innerHTML='';
      guests.forEach(g=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${g.name}</td><td>${g.phone}</td><td>${g.totalNeeded}</td>
          <td><button class='btn ok' onclick='sendWhatsApp("${g.phone}")'>ÙˆØ§ØªØ³Ø§Ø¨</button></td>`;
        body.appendChild(tr);
      });
      updateKPIs();
    }

    function sendWhatsApp(phone){
      const msg="Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ù†ØªØ´Ø±Ù Ø¨Ø¯Ø¹ÙˆØªÙƒÙ… Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø­Ø¯Ø« "+DEFAULT_EVENT;
      window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,'_blank');
    }

    function sendAllWhatsApp(){
      if(!guests.length){alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¶ÙŠÙˆÙ');return;}
      if(!confirm('Ø³ÙŠØªÙ… ÙØªØ­ Ø¹Ø¯Ø© Ù†ÙˆØ§ÙØ° ÙˆØ§ØªØ³Ø§Ø¨ØŒ Ù…ØªØ§Ø¨Ø¹Ø©ØŸ'))return;
      guests.forEach((g,i)=>{
        setTimeout(()=>sendWhatsApp(g.phone), i*1500);
      });
    }

    function saveData(){
      const ev=document.getElementById('eventName').value;
      const data={event:ev,guests};
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      saveAs(blob, ev+'.json');
    }

    function loadBarcodes(){
      const f=document.getElementById('barcodeUpload').files;
      alert(f.length+' ØµÙˆØ±Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡Ø§ (Ù†Ù…ÙˆØ°Ø¬)');
    }

    function updateKPIs(){
      document.getElementById('kpiTotal').textContent=guests.length;
      document.getElementById('kpiSent').textContent=0;
      document.getElementById('kpiRemain').textContent=guests.length;
    }

    function logout(){
      localStorage.removeItem(LS_AUTH);
      alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.');
      location.reload();
    }
  </script>
</body>
</html>
