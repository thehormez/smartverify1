<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ®Ù… â€” Ø£Ø³ÙˆØ¯/Ø°Ù‡Ø¨ÙŠ + Ø¯Ø®ÙˆÙ„</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700;900&display=swap" rel="stylesheet" />

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    :root{
      --bg:#0b0b0c; --panel:#14151a; --panel-2:#111217; --stroke:#27282f;
      --gold:#d4af37; --gold-2:#b8952f; --txt:#e7e7e7; --muted:#a7a7a7; --danger:#ef4444; --ok:#25d366;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family:'Noto Sans Arabic', system-ui, -apple-system, Segoe UI, Arial; background:var(--bg); color:var(--txt) }

    /* Topbar */
    .topbar{ position:sticky; top:0; z-index:50; background:linear-gradient(180deg, rgba(10,10,12,.9), rgba(10,10,12,.75)); border-bottom:1px solid var(--stroke); backdrop-filter:blur(6px) }
    .container{ max-width:1280px; margin:0 auto; padding:16px }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px }
    .brand .dot{ width:12px; height:12px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #ffe8a3, var(--gold)); box-shadow:0 0 0 2px rgba(212,175,55,.25) inset }

    /* Cards & buttons */
    .grid{ display:grid; gap:14px }
    .grid.cols-3{ grid-template-columns: 2fr 1fr 1.2fr }
    .grid.cols-2{ grid-template-columns: 1fr 1fr }
    .card{ background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid var(--stroke); border-radius:16px; padding:16px }
    .btn{ border:1px solid var(--stroke); background:#0f1013; color:var(--txt); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:800 }
    .btn.gold{ background:linear-gradient(180deg, #2a2211, #1f1a0d); border-color:var(--gold); color:#fff }
    .btn.ghost{ background:#0f1013 }
    .btn.warn{ border-color:#7a1f1f; color:#ffd9d9 }
    .btn.ok{ border-color:#1b8c4f; color:#dff7ea }
    .field{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--stroke); background:#0f1013; color:var(--txt) }
    .hint{ color:var(--muted); font-size:12px }

    /* Home menu (accordion tiles) */
    .tile{ border:1px solid var(--stroke); border-radius:16px; overflow:hidden; background:linear-gradient(180deg, #15161a, #111217) }
    .tile-h{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px; cursor:pointer }
    .tile-h:hover{ background:#17181d }
    .chev{ width:18px; height:18px; border:2px solid var(--gold); border-left:0; border-top:0; transform:rotate(-45deg); transition:.2s }
    .tile.open .chev{ transform:rotate(135deg) }
    .tile-b{ display:none; border-top:1px solid var(--stroke); padding:14px 16px }
    .tile.open .tile-b{ display:block }
    .menu-actions{ display:flex; flex-wrap:wrap; gap:8px }

    /* Table */
    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; margin-top:10px }
    thead th{ background:linear-gradient(180deg, #222328, #1a1b20); color:#f6f6f6; border-bottom:1px solid var(--stroke); padding:12px; text-align:right; font-weight:900 }
    tbody td{ padding:12px; border-bottom:1px solid var(--stroke) }
    tbody tr:hover{ background:rgba(212,175,55,0.05) }
    .editable{ cursor:pointer; color:#ffd76a; font-weight:800; text-decoration:underline dotted rgba(212,175,55,.6); text-underline-offset:3px }

    /* Auth modal */
    .overlay{ position:fixed; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.7), rgba(0,0,0,.8)); backdrop-filter:blur(3px); display:flex; align-items:center; justify-content:center; z-index:100 }
    .modal{ width:100%; max-width:460px; background:linear-gradient(180deg, #16171b, #121317); border:1px solid var(--stroke); border-radius:18px; padding:18px }
    .title{ margin:0 0 8px; font-weight:900; font-size:22px }

    /* KPIs */
    .kpi{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px }
    .kpi .card{ text-align:center }
  </style>
</head>
<body>
  <!-- Auth Gate -->
  <div id="authGate" class="overlay" style="display:none">
    <div class="modal">
      <h3 class="title">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­Ø¯Ø«</h3>
      <p class="hint">Ø£Ø¯Ø®Ù„ <b>Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«</b> Ùˆ<b>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</b> Ù„Ù„Ø¯Ø®ÙˆÙ„. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯Ù‹Ø§ ÙØ³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯Ø«.</p>
      <div class="grid" style="margin-top:10px">
        <input id="authEvent" class="field" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« (Ù…Ø«Ø§Ù„: Ø²ÙˆØ§Ø¬ Ø¹Ù„ÙŠ 2025)" />
        <input id="authPass" type="password" class="field" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
        <button class="btn gold" onclick="authLogin()">Ø¯Ø®ÙˆÙ„</button>
        <div id="authErr" class="hint" style="color:#ffb3b3"></div>
      </div>
    </div>
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:12px">
      <div class="brand"><span class="dot"></span><span>Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ®Ù…</span></div>
      <div class="hint" id="eventBadge">â€”</div>
    </div>
  </div>

  <main class="container">
    <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: Ù‚ÙˆØ§Ø¦Ù… Ù…Ù†Ø³Ø¯Ù„Ø© (accordions) -->
    <section class="grid">
      <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯Ø« -->
      <div class="tile" id="tile-event">
        <div class="tile-h" onclick="toggleTile(this)">
          <div><b>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯Ø«</b></div>
          <div class="chev"></div>
        </div>
        <div class="tile-b">
          <div class="grid cols-3">
            <input id="eventName" class="field" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«" />
            <button class="btn gold" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
            <div style="display:flex; gap:8px; align-items:center">
              <input id="dataUpload" type="file" accept=".json" style="display:none" onchange="loadDataFile(this.files[0])" />
              <button class="btn" onclick="document.getElementById('dataUpload').click()">â†©ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
          </div>
          <p class="hint" style="margin-top:6px">ØªØ°ÙƒÙŠØ±: ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ø§ ØªÙ†ØªÙ‚Ù„ Ø¹Ø¨Ø± JSON â€” Ø£Ø¹Ø¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡Ø§ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±.</p>
        </div>
      </div>

      <!-- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙŠÙˆÙ -->
      <div class="tile" id="tile-guests">
        <div class="tile-h" onclick="toggleTile(this)">
          <div><b>Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙŠÙˆÙ</b></div>
          <div class="chev"></div>
        </div>
        <div class="tile-b">
          <div class="menu-actions">
            <input id="guestListUpload" type="file" class="field" style="max-width:420px" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />
            <button class="btn gold" onclick="handleFileUpload()">âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¶ÙŠÙˆÙ</button>
            <button class="btn" onclick="uiShowManualAdd()">â• Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©</button>
            <button class="btn ok" onclick="importFromContacts()">ğŸ“± Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ù‡Ø§ØªÙ</button>
          </div>
          <div id="manualAdd" class="grid cols-2" style="margin-top:10px; display:none">
            <input id="newGuestName" class="field" placeholder="Ø§Ù„Ø§Ø³Ù…" />
            <input id="newGuestPhone" class="field" placeholder="Ø§Ù„Ù‡Ø§ØªÙ (9665...)" />
            <input id="newGuestTotalNeeded" class="field" type="number" min="1" value="1" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª" />
            <button class="btn gold" onclick="addGuestManually()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙŠÙ</button>
          </div>
          <div class="hint" style="margin-top:8px">ØªÙ… ØªØ­Ù…ÙŠÙ„ <b id="guestCount">0</b> Ø¶ÙŠÙ.</div>
        </div>
      </div>

      <!-- Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¯Ø¹ÙˆØ§Øª -->
      <div class="tile" id="tile-stock">
        <div class="tile-h" onclick="toggleTile(this)">
          <div><b>Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</b></div>
          <div class="chev"></div>
        </div>
        <div class="tile-b">
          <div class="grid cols-2">
            <div>
              <label class="hint">Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„ØªØ­ÙƒÙ…)</label>
              <input id="allowedCapacity" type="number" class="field" min="0" value="0" onchange="updateBadges()" />
              <div class="hint" id="capHint" style="margin-top:6px"></div>
            </div>
            <div>
              <label class="hint">Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
              <div style="display:flex; gap:8px; align-items:center">
                <input id="barcodeUpload" type="file" class="field" accept="image/*" multiple />
                <button class="btn gold" onclick="loadBarcodes()">ğŸ—‚ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
              </div>
              <div class="hint" style="margin-top:6px">Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©: <b id="barcodeCount">0</b> â€” Ø§Ù„Ø£ÙƒÙˆØ§Ø¯: <span id="importedQrCodes">â€”</span></div>
            </div>
          </div>
          <div id="qrMismatchAlert" class="hint" style="margin-top:8px; color:#ffb3b3; display:none"></div>
        </div>
      </div>

      <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ† -->
      <div class="tile" id="tile-list">
        <div class="tile-h" onclick="toggleTile(this)">
          <div><b>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†</b></div>
          <div class="chev"></div>
        </div>
        <div class="tile-b">
          <div class="kpi">
            <div class="card"><div class="hint">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶ÙŠÙˆÙ</div><div style="font-size:22px; font-weight:900" id="kpiTotal">0</div></div>
            <div class="card"><div class="hint">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„ÙƒØ±ÙˆØª</div><div style="font-size:22px; font-weight:900" id="kpiNeeded">0</div></div>
            <div class="card"><div class="hint">Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©</div><div style="font-size:22px; font-weight:900" id="kpiImported">0</div></div>
            <div class="card"><div class="hint">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ØªØ®ØµÙŠØµ</div><div style="font-size:22px; font-weight:900" id="kpiRemain">0</div></div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ</th>
                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®ØµØµØ©</th>
                <th style="text-align:left">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="guestTableBody"></tbody>
          </table>
          <div class="card" style="margin-top:12px">
            <h3 style="margin:0 0 6px">ğŸ–Šï¸ Ù†Øµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</h3>
            <p class="hint">Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª: <code>#{{GUEST_NAME}}#</code>ØŒ <code>#{{TOTAL_COUNT}}#</code></p>
            <textarea id="messageTemplate" class="field" rows="4" style="resize:vertical; line-height:1.9">Ù…Ø±Ø­Ø¨Ø§Ù‹ #{{GUEST_NAME}}#ØŒ
Ù†ØªØ´Ø±Ù Ø¨Ø¯Ø¹ÙˆØªÙƒÙ… Ù„Ø­Ø¶ÙˆØ± ÙØ¹Ø§Ù„ÙŠØªÙ†Ø§ (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª: #{{TOTAL_COUNT}}#).
Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø­Ø¶Ø§Ø±/Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø­Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„.</textarea>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===================== Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ =====================
    const LS_EVENTS='hormez_events_meta';
    const LS_AUTH='hormez_auth_event';
    const getEventMeta=()=>{ try{ return JSON.parse(localStorage.getItem(LS_EVENTS)||'{}') }catch{return{}} };
    const setEventMeta=(o)=>{ try{ localStorage.setItem(LS_EVENTS, JSON.stringify(o||{})) }catch{} };

    function showAuth(){ document.getElementById('authGate').style.display='flex'; }
    function hideAuth(){ document.getElementById('authGate').style.display='none'; }

    function authLogin(){
      const name = document.getElementById('authEvent').value.trim();
      const pass = document.getElementById('authPass').value;
      const err = document.getElementById('authErr'); err.textContent='';
      if(!name || !pass){ err.textContent='Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'; return }
      const meta=getEventMeta(); const entry=meta[name];
      if(!entry){ meta[name]={password:pass}; setEventMeta(meta); }
      else if((entry.password||'')!==pass){ err.textContent='ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯Ø«'; return }
      localStorage.setItem(LS_AUTH, JSON.stringify({event:name}));
      document.getElementById('eventBadge').textContent = `Ø§Ù„Ø­Ø¯Ø«: ${name}`;
      document.getElementById('eventName').value = name;
      hideAuth();
    }

    (function boot(){
      try{ const s=JSON.parse(localStorage.getItem(LS_AUTH)||'null'); if(!s?.event){ showAuth(); } else { document.getElementById('eventBadge').textContent=`Ø§Ù„Ø­Ø¯Ø«: ${s.event}`; document.getElementById('eventName').value=s.event; } }catch{ showAuth() }
    })();

    // ===================== Ù…Ù†Ø·Ù‚Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ù…Ø®ØªØµØ±) =====================
    let guests=[]; let barcodeImages={}; let availableQrIds=[]; let internalGuestIdCounter=0;

    function toggleTile(h){ const tile=h.parentElement; tile.classList.toggle('open'); }
    function uiShowManualAdd(){ document.getElementById('manualAdd').style.display='grid'; }

    function updateBadges(){
      const needed = guests.reduce((s,g)=>s+(parseInt(g.totalNeeded)||0),0);
      document.getElementById('kpiTotal').textContent = guests.length;
      document.getElementById('kpiNeeded').textContent = needed;
      document.getElementById('kpiImported').textContent = availableQrIds.length;
      document.getElementById('kpiRemain').textContent = Math.max(availableQrIds.length - needed, 0);
      const cap = parseInt(document.getElementById('allowedCapacity').value||0);
      const hint = document.getElementById('capHint');
      if(cap>0){ hint.textContent = needed>cap ? `âš ï¸ Ø§Ù„Ø·Ù„Ø¨ (${needed}) ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ (${cap}).` : `Ø§Ù„Ø·Ù„Ø¨ (${needed}) Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯ (${cap}).`; } else { hint.textContent=''; }
    }

    function saveData(){
      const eventName = document.getElementById('eventName').value || 'Unnamed_Event';
      const dataToSave = { eventName, guests, availableQrIds, internalGuestIdCounter, messageTemplate: document.getElementById('messageTemplate').value };
      const blob = new Blob([JSON.stringify(dataToSave,null,2)], {type:'application/json'});
      saveAs(blob, `${eventName}_Data_${new Date().toISOString().slice(0,10)}.json`);
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. (ØªØ°ÙƒÙŠØ±: ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ø§ ØªÙ†ØªÙ‚Ù„ Ø¹Ø¨Ø± JSON)');
    }
    function loadDataFile(file){ if(!file) return; const r=new FileReader(); r.onload=(e)=>{ try{ const d=JSON.parse(e.target.result); loadData(d); alert('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„. Ø£Ø¹Ø¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.'); }catch(err){ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); } }; r.readAsText(file); }
    function loadData(d){ guests=d.guests||[]; availableQrIds=d.availableQrIds||[]; internalGuestIdCounter=d.internalGuestIdCounter||0; document.getElementById('eventName').value=d.eventName||''; document.getElementById('messageTemplate').value=d.messageTemplate||document.getElementById('messageTemplate').value; barcodeImages={}; document.getElementById('barcodeCount').textContent=0; document.getElementById('importedQrCodes').textContent=availableQrIds.join(', ')||'â€”'; renderGuestTable(); checkQrMismatch(); updateBadges(); }

    // Guests import
    function handleFileUpload(){ const f=document.getElementById('guestListUpload').files[0]; if(!f){ alert('Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§'); return } const ext=f.name.split('.').pop().toLowerCase(); if(ext==='csv') readCSV(f); else if(['xlsx','xls'].includes(ext)) readExcel(f); else alert('Ø§Ø³ØªØ®Ø¯Ù… CSV Ø£Ùˆ XLSX'); }
    function readCSV(file){ Papa.parse(file,{ header:true, skipEmptyLines:true, complete:(res)=>processImportedData(res.data), error:(e)=>alert('CSV Ø®Ø·Ø£: '+e.message) }); }
    function readExcel(file){ const r=new FileReader(); r.onload=(e)=>{ const data=new Uint8Array(e.target.result); const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]]; const arr=XLSX.utils.sheet_to_json(ws); processImportedData(arr); }; r.readAsArrayBuffer(file); }
    function processImportedData(data){ const required=['name','phone','totalNeeded']; if(!data.length || !required.every(f=>Object.keys(data[0]).some(k=>k.toLowerCase()===f))){ alert('Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: name, phone, totalNeeded'); return } internalGuestIdCounter=0; guests=data.map(g=>{ const get=(f)=>{ const k=Object.keys(g).find(x=>x.toLowerCase()===f); return k? g[k]:'' }; internalGuestIdCounter++; const total=Math.max(1, parseInt(get('totalneeded'))||1); return { internalId:internalGuestIdCounter, name:String(get('name')).trim()||'â€”', phone:String(get('phone')).trim()||'â€”', totalNeeded:total, assignedQrIds:[], isManuallyAssigned:false }; }); distributeBarcodesAutomatically(); renderGuestTable(); checkQrMismatch(); updateBadges(); }

    // Manual add & contacts
    function addGuestManually(){ const n=document.getElementById('newGuestName').value.trim(); const p=document.getElementById('newGuestPhone').value.trim(); const c=Math.max(1, parseInt(document.getElementById('newGuestTotalNeeded').value)||1); if(!n||!p){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‡Ø§ØªÙ'); return } internalGuestIdCounter++; guests.push({ internalId:internalGuestIdCounter, name:n, phone:p, totalNeeded:c, assignedQrIds:[], isManuallyAssigned:false }); distributeBarcodesAutomatically(); renderGuestTable(); updateBadges(); document.getElementById('newGuestName').value=''; document.getElementById('newGuestPhone').value=''; document.getElementById('newGuestTotalNeeded').value='1'; }
    async function importFromContacts(){ try{ if(!('contacts' in navigator) || !('select' in navigator.contacts)){ alert('Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­. Ø¬Ø±Ù‘Ø¨ ÙƒØ±ÙˆÙ… Ø¹Ù„Ù‰ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯.'); return } const contacts = await navigator.contacts.select(['name','tel'], {multiple:true}); if(!contacts?.length) return; contacts.forEach(c=>{ const n=(c.name&&c.name[0])||''; const t=(c.tel&&c.tel[0])||''; if(n&&t){ internalGuestIdCounter++; guests.push({ internalId:internalGuestIdCounter, name:n, phone:t, totalNeeded:1, assignedQrIds:[], isManuallyAssigned:false }); } }); distributeBarcodesAutomatically(); renderGuestTable(); updateBadges(); }catch{ alert('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„'); } }

    // QRs
    function loadBarcodes(){ const files=document.getElementById('barcodeUpload').files; if(!files.length){ alert('Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª'); return } barcodeImages={}; availableQrIds=[]; let ok=0; const total=files.length; Array.from(files).forEach(file=>{ const reader=new FileReader(); reader.onload=(e)=>{ const id=file.name.split('.').slice(0,-1).join(''); barcodeImages[id]=e.target.result; availableQrIds.push(id); ok++; document.getElementById('barcodeCount').textContent=ok; document.getElementById('importedQrCodes').textContent=availableQrIds.join(', '); if(ok===total){ availableQrIds.sort((a,b)=>{ const A=parseInt(a), B=parseInt(b); if(!isNaN(A)&&!isNaN(B)) return A-B; return a.localeCompare(b) }); distributeBarcodesAutomatically(); renderGuestTable(); checkQrMismatch(); updateBadges(); alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${ok} ÙƒÙˆØ¯ ÙˆØªÙˆØ²ÙŠØ¹Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.`); } }; reader.readAsDataURL(file); }) }

    function distributeBarcodesAutomatically(){ const used=guests.filter(g=>g.isManuallyAssigned).flatMap(g=>g.assignedQrIds); const free=availableQrIds.filter(id=>!used.includes(id)); guests.forEach(g=>{ if(!g.isManuallyAssigned) g.assignedQrIds=[] }); let i=0; guests.forEach(g=>{ if(!g.isManuallyAssigned){ const need=g.totalNeeded; if(i+need<=free.length){ g.assignedQrIds=free.slice(i,i+need); i+=need } else { g.assignedQrIds=[] } } }); }

    function assignBarcode(id){ const g=guests.find(x=>x.internalId===id); if(!g) return; const need=g.totalNeeded; const val=prompt(`Ø£Ø¯Ø®Ù„ ${need} ÙƒÙˆØ¯ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„ Ù„Ù€ ${g.name}:`, g.assignedQrIds.join(', ')); if(val===null) return; const list=val.split(',').map(s=>s.trim()).filter(Boolean); if(list.length!==need){ alert(`ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ${need} ÙƒÙˆØ¯ Ø¨Ø§Ù„Ø¶Ø¨Ø·`); return } const others=guests.flatMap(x=>x.assignedQrIds||[]).filter(x=>!g.assignedQrIds.includes(x)); for(const k of list){ if(!barcodeImages[k]){ alert(`"${k}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙˆØ±`); return } if(others.includes(k)){ alert(`Ø§Ù„ÙƒÙˆØ¯ "${k}" Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¶ÙŠÙ Ø¢Ø®Ø±`); return } } g.assignedQrIds=list; g.isManuallyAssigned=true; distributeBarcodesAutomatically(); renderGuestTable(); updateBadges(); }

    function editTotalNeeded(id){ const g=guests.find(x=>x.internalId===id); if(!g) return; const s=prompt(`Ø¹Ø¯Ø¯ Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${g.name}:`, g.totalNeeded); if(s===null||s.trim()==='') return; const n=parseInt(s); if(isNaN(n)||n<1){ alert('Ø¹Ø¯Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­'); return } g.totalNeeded=n; g.isManuallyAssigned=false; distributeBarcodesAutomatically(); renderGuestTable(); updateBadges(); }
    function editGuestDetails(id, field){ const g=guests.find(x=>x.internalId===id); if(!g) return; const s=prompt(field==='name'?`Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${g.name}:`:`Ù‡Ø§ØªÙ Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${g.name}:`, g[field]); if(s===null||s.trim()==='') return; g[field]=s.trim(); renderGuestTable(); }

    async function downloadBarcodeImage(guest){ const ids=guest.assignedQrIds; const total=guest.totalNeeded; if(!ids.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ±ÙˆØª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¶ÙŠÙ'); return } const missing=ids.filter(id=>!barcodeImages[id]); if(missing.length){ alert('ØµÙˆØ± Ù†Ø§Ù‚ØµØ©: '+missing.join(', ')); return } if(total===1){ const id=ids[0]; const a=document.createElement('a'); a.href=barcodeImages[id]; a.download=`${guest.name}_${id}.png`; document.body.appendChild(a); a.click(); a.remove(); return } const zip=new JSZip(); for(const id of ids){ const b64=barcodeImages[id].split(',')[1]; zip.file(`${id}.png`, b64, {base64:true}); } const blob=await zip.generateAsync({type:'blob'}); saveAs(blob, `${guest.name}_${total}_Cards.zip`); }

    function deleteGuest(id){ if(!confirm('Ø­Ø°Ù Ø§Ù„Ø¶ÙŠÙØŸ')) return; guests = guests.filter(g=>g.internalId!==id); distributeBarcodesAutomatically(); renderGuestTable(); updateBadges(); }

    function sendWhatsAppMessage(guest){ if(!guest.assignedQrIds.length){ alert('Ù„Ø§ ÙƒØ±ÙˆØª Ù„Ù„Ø¶ÙŠÙ'); return } let txt=document.getElementById('messageTemplate').value; txt=txt.replace(/#\{\{GUEST_NAME\}\}#/g, guest.name).replace(/#\{\{TOTAL_COUNT\}\}#/g, guest.totalNeeded); const url=`https://wa.me/${guest.phone}?text=${encodeURIComponent(txt)}`; window.open(url,'_blank'); }

    function checkQrMismatch(){ const need=guests.reduce((s,g)=>s+g.totalNeeded,0); const available=availableQrIds.length; const el=document.getElementById('qrMismatchAlert'); if(available<need){ el.style.display='block'; el.textContent=`ØªØ­Ø°ÙŠØ±: Ø§Ù„Ù…ØªØ§Ø­ (${available}) Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (${need}).` } else if(available>need){ el.style.display='block'; el.textContent=`Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…ØªØ§Ø­ (${available}) Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (${need}). Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${available-need}` } else { el.style.display='none' } }

    function renderGuestTable(){ const body=document.getElementById('guestTableBody'); body.innerHTML=''; document.getElementById('guestCount').textContent=guests.length; guests.forEach(guest=>{ const tr=document.createElement('tr'); const tdName=document.createElement('td'); tdName.innerHTML=`<span class="editable" title="ØªØ¹Ø¯ÙŠÙ„" onclick="editGuestDetails(${guest.internalId}, 'name')">${guest.name}</span>`; tr.appendChild(tdName); const tdCount=document.createElement('td'); tdCount.innerHTML=`<span class="editable" title="ØªØ¹Ø¯ÙŠÙ„" onclick="editTotalNeeded(${guest.internalId})">${guest.totalNeeded}</span>`; tr.appendChild(tdCount); const tdPhone=document.createElement('td'); tdPhone.innerHTML=`<span class="editable" title="ØªØ¹Ø¯ÙŠÙ„" onclick="editGuestDetails(${guest.internalId}, 'phone')">${guest.phone}</span>`; tr.appendChild(tdPhone); const tdQr=document.createElement('td'); const list=guest.assignedQrIds.join(', '); tdQr.textContent=list||'Ù„Ù… ÙŠØ®ØµÙ‘ÙØµ'; tdQr.style.color = guest.assignedQrIds.length===guest.totalNeeded? '#cfd2d6' : '#ffb3b3'; tdQr.style.fontWeight='800'; tr.appendChild(tdQr); const tdAct=document.createElement('td'); tdAct.style.textAlign='left'; const b1=document.createElement('button'); b1.className='btn'; b1.textContent='ØªØ¹ÙŠÙŠÙ†/ØªØºÙŠÙŠØ±'; b1.onclick=()=>assignBarcode(guest.internalId); const b2=document.createElement('button'); b2.className='btn'; b2.textContent= guest.totalNeeded===1? 'ğŸ’¾ PNG' : 'ğŸ’¾ ZIP'; b2.onclick=()=>downloadBarcodeImage(guest); const b3=document.createElement('button'); b3.className='btn ok'; b3.textContent='ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨'; b3.onclick=()=>sendWhatsAppMessage(guest); const b4=document.createElement('button'); b4.className='btn warn'; b4.textContent='ğŸ—‘ï¸'; b4.onclick=()=>deleteGuest(guest.internalId); [b1,b2,b3,b4].forEach(b=>{ b.style.marginInlineStart='6px'; tdAct.appendChild(b) }); tr.appendChild(tdAct); body.appendChild(tr); }); checkQrMismatch(); }

    document.addEventListener('DOMContentLoaded', ()=>{ renderGuestTable(); });
  </script>
</body>
</html>
