<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª | ÙŠØ¹Ù…Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>


    <style>
      * { box-sizing: border-box; }
      body { background:#0a0a0a; color:#eee; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Naskh Arabic UI", Arial, sans-serif; }
      .card { background:#111418; border:1px solid #23262b; border-radius:16px; }
      .btn { border-radius:14px; padding:.6rem 1rem; border:1px solid #2a2d33; }
      .btn-primary { background:#facc15; color:#111; border-color:#facc15; }
      .btn-ghost { background:#1a1e24; color:#e6e6e6; }
      .chip { background:#1c2128; color:#c9c9c9; border-radius:10px; padding:.25rem .6rem; border:1px solid #2a2d33; }
      table th, table td { padding:.6rem .4rem; }
      .thumb { width:56px; height:56px; object-fit:contain; border:1px solid #2a2d33; border-radius:8px; background:#0f1318; }
      a.link { color:#93c5fd; }
      code { background:#0f1318; padding:.2rem .35rem; border-radius:6px; border:1px solid #23262b }
      /* Modal Styles */
      .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.75); display: flex; justify-content: center; align-items: center; z-index: 50; }
      .modal-content { background: #111418; padding: 1.5rem; border-radius: 16px; max-width: 90%; max-height: 90%; overflow-y: auto; position: relative; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef, useCallback } = React;

      // START: LOCAL STORAGE HANDLERS
      const SafeStorage = (() => {
        try { const t='__probe__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; } catch(e){
          const mem = {}; return { getItem:k=>mem[k]??null, setItem:(k,v)=>{mem[k]=String(v)}, removeItem:k=>{delete mem[k]} };
        }
      })();

      const LS_INVITES = 'hormez_invites';
      const LS_QR_CARDS = 'hormez_qr_cards';
      const LS_QR_CACHE = 'hormez_qr_cache'; 
      
      const loadInitialData = (key, defaultValue = []) => {
        try {
          const data = JSON.parse(SafeStorage.getItem(key));
          const loadedData = Array.isArray(data) ? data : defaultValue;
          return loadedData.map(inv => ({
              ...inv,
              qrIds: inv.qrIds || (inv.qrId ? [inv.qrId] : []),
              status: inv.status || 'new', 
              count: inv.count || 1 
          }));
        } catch (e) {
          console.warn(`Failed to load data for ${key}.`, e);
          return defaultValue;
        }
      };

      const QRDataCache = new Map(JSON.parse(SafeStorage.getItem(LS_QR_CACHE) || '[]')); 
      
      const updateQrCache = () => {
        SafeStorage.setItem(LS_QR_CACHE, JSON.stringify(Array.from(QRDataCache.entries())));
      };
      
      // END: LOCAL STORAGE HANDLERS

      // ======= UTILS =======
      const normalizePhone=(p)=>String(p||'').replace(/\D/g,'');
      const hashString=(str)=>{ let h=5381,i=str.length; while(i){ h=(h*33)^str.charCodeAt(--i);} return (h>>>0).toString(36); };
      
      // âš ï¸ ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø¥Ù„Ù‰ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø®Ø§Øµ Ø§Ù„Ø°ÙŠ Ø³ÙŠØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø±Ø¯ÙˆØ¯
      const ADMIN_PHONE_NUMBER = "971505296855"; // Ù…Ø«Ø§Ù„: 966555123456

      // ğŸŸ¢ Ø¯Ø§Ù„Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø¯ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
      const generateWhatsappLink = (inviteId, action, guestName) => {
          // Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø³Ø±ÙŠ ÙŠØ³Ù‡Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡ ÙÙŠ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
          const secretTag = `RSVP-${inviteId}`;
          let message = `*Ø±Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ©:* ${secretTag}\n\n`;
          
          if (action === 'confirm') {
              message += `Ø§Ù„Ø¶ÙŠÙ: *${guestName}*\nÙŠØ¤ÙƒØ¯ Ø­Ø¶ÙˆØ±Ù‡ Ø¨Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯.\n\n\n(Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©ØŒ Ù„Ø§ ØªØ­ØªØ§Ø¬ Ù„Ù„Ø±Ø¯)`;
          } else if (action === 'decline') {
              message += `Ø§Ù„Ø¶ÙŠÙ: *${guestName}*\nÙŠØ¹ØªØ°Ø± Ø¹Ù† Ø§Ù„Ø­Ø¶ÙˆØ±ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯Ø¹ÙˆØ©.\n\n\n(Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© Ø§Ø¹ØªØ°Ø§Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©ØŒ Ù„Ø§ ØªØ­ØªØ§Ø¬ Ù„Ù„Ø±Ø¯)`;
          }

          const url = `https://wa.me/${ADMIN_PHONE_NUMBER}?text=${encodeURIComponent(message)}`;
          return url;
      };


      const openWhatsApp = (phone, message) => {
        const digits = normalizePhone(phone); if(!digits){ alert('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­'); return; }
        const url = `https://wa.me/${digits}?text=${encodeURIComponent(message)}`;
        try { const w=window.open(url,'_blank','noopener,noreferrer'); if(!w) alert('Ù…ÙØ§Ù†Ø¹ Ø§Ù„Ù†ÙˆØ§ÙØ° Ù‚Ø¯ ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙØªØ­. Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠÙ‹Ø§:\n'+url); }
        catch{ alert('ØªØ¹Ø°Ø± ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨. Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠÙ‹Ø§:\n'+url); }
      };
      
      function getQrMetadata(file, dataUrl){
        const name=file.name||'qr';
        const m = name.match(/(\d{3,})/); const cardNumber = m? m[1]: null;
        const contentHash = hashString(dataUrl); 
        const id = Date.now()+"_"+Math.random().toString(36).slice(2,8);

        try {
            QRDataCache.set(id, dataUrl);
            updateQrCache();
        } catch (error) {
            console.error("Local storage limit hit or other cache error:", error);
            alert("ØªØ­Ø°ÙŠØ±: ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©. Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø¨Ø¹Ø¶ ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„.");
        }
        
        return { id, name, used:false, cardNumber, contentHash }; 
      }
      
      const readFileAsDataURL = (file) => {
          return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(file);
          });
      };
      
      const readFileAsText = (file) => {
          return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsText(file);
          });
      };

      const makeInvite=({guestName,phone,count,eventName,qrList=[]})=>({
        id: Date.now()+"_"+Math.random().toString(36).slice(2,8),
        guestName:(guestName||'').trim(),
        phone: normalizePhone(phone),
        count: Math.max(1, Number(count||1)),
        eventName:(eventName||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù… Ø­Ø¯Ø«').trim(),
        status: 'new', createdAt:new Date().toISOString(),
        qrIds: qrList.map(q=>q.id),
        qrId: qrList[0]?.id || null, 
        qrName: qrList[0]?.name || null,
        qrNumber: qrList[0]?.cardNumber || null,
      });
      
      const computeStats=(inv)=>({ 
          total:inv.length, 
          sent:inv.filter(i=>['sent','reminded','confirmed','attended'].includes(i.status)).length, 
          attended:inv.filter(i=>i.status==='attended').length,
          declined:inv.filter(i=>i.status==='declined').length,
          active:inv.filter(i=>!['declined'].includes(i.status)).length, 
      });

      function parseCSV(text){
        const lines=text.trim().split(/\r?\n/).filter(Boolean); if(!lines.length) return [];
        const first=lines[0].split(',').map(s=>s.trim().toLowerCase());
        const hasHeader=['name','phone','count','event'].some(k=>first.includes(k));
        const body = hasHeader? lines.slice(1): lines;
        return body.map(line=>{ const [a,b,c,d]=line.split(',').map(x=>x?.trim()??''); return { guestName:a||'', phone:b||'', count:Math.max(1,Number(c||1)), eventName:d||'' }; });
      }
      async function readXLSX(file){
        const data=await file.arrayBuffer(); const wb=XLSX.read(data,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]]; const arr=XLSX.utils.sheet_to_json(ws,{header:1});
        const rows=arr.filter(r=>r && r.length); if(!rows.length) return [];
        const first=rows[0].map(v=>String(v||'').trim().toLowerCase());
        const hasHeader=['name','phone','count','event'].some(k=>first.includes(k));
        const body=hasHeader? rows.slice(1): rows;
        return body.map(r=>{ const [a,b,c,d]=r; return { guestName:String(a||'').trim(), phone:String(b||'').trim(), count:Math.max(1,Number(c||1)), eventName:String(d||'').trim()}; });
      }
      
      function downloadJSON(data, filename) {
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      
      const downloadAllQRs = async (invite, qrCards) => {
          if (!invite.qrIds || invite.qrIds.length === 0) {
              alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ±ÙˆØª Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø®ØµØµØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø¹ÙˆØ©.');
              return;
          }

          const zip = new JSZip();
          const guestName = invite.guestName.replace(/[^a-z0-9]/gi, '_'); 
          let filesAdded = 0;

          const cardData = invite.qrIds.map(id => {
              const dataUrl = QRDataCache.get(id);
              const card = qrCards.find(c => c.id === id);
              return { dataUrl, card };
          }).filter(item => item.dataUrl); 

          if (cardData.length === 0) {
              alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ ØµÙˆØ± Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ.');
              return;
          }

          cardData.forEach((item, index) => {
              const dataUrl = item.dataUrl;
              const cardName = item.card?.cardNumber ? `QR_Card_${item.card.cardNumber}` : `QR_${index + 1}`;
              const base64Data = dataUrl.split(',')[1];
              
              zip.file(`${guestName}_${cardName}.png`, base64Data, { base64: true });
              filesAdded++;
          });

          if (filesAdded === 0) {
              alert('Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù„ÙØ§Øª. Ù‚Ø¯ ØªÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„ÙƒØ§Ø´.');
              return;
          }

          try {
              const content = await zip.generateAsync({ type: "blob" });
              const filename = `${guestName}_${invite.count}_QRs.zip`;
              saveAs(content, filename); 
          } catch (error) {
              console.error("ZIP creation or download failed:", error);
              alert('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù ZIP. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ Ø£Ø¶ÙØª Ù…ÙƒØªØ¨Ø© FileSaver.js ÙÙŠ ÙˆØ³Ù… <head> ÙˆØ§Ø³ØªÙˆØ±Ø¯Øª ØµÙˆØ± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯.');
          }
      };


      // ======= COMPONENTS =======
      function App(){
        
        // âš ï¸ ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù‡Ù†Ø§ - ÙŠØ±Ø¬Ù‰ ØªØºÙŠÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ…
        // ----------------------------------------------------
        const FIXED_EVENT_NAME = "Ø²ÙØ§Ù Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡"; // Ø¶Ø¹ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« Ù‡Ù†Ø§
        const FIXED_PASSWORD = "123"; // Ø¶Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‡Ù†Ø§
        // ----------------------------------------------------

        const [eventName, setEventName] = useState(FIXED_EVENT_NAME);
        const [password, setPassword] = useState('');
        const [isLoggedIn, setIsLoggedIn] = useState(false);

        const login = () => {
          if (!eventName) { alert('ÙŠØ¬Ø¨ ØªØ¹ÙŠÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ÙŠØ¯ÙˆÙŠØ§ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯.'); return; }
          if (password !== FIXED_PASSWORD) {
              alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
              return;
          }
          setIsLoggedIn(true);
        };
        
        const logout = () => {
          setIsLoggedIn(false);
          setPassword('');
        };
        
        if (!isLoggedIn) {
          return (
            <div className="min-h-screen flex items-center justify-center p-6">
              <div className="card w-full max-w-md p-6">
                <h1 className="text-center text-2xl font-black mb-6">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                <p className="text-sm text-neutral-400 mb-4">Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« Ø«Ø§Ø¨Øª ÙˆÙ…ÙØ¹ÙŠÙ‘Ù† ÙÙŠ Ø§Ù„ÙƒÙˆØ¯: **{eventName}**.</p>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm mb-1">Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« (Ù…Ø¹ÙŠÙ‘Ù† ÙŠØ¯ÙˆÙŠØ§Ù‹)</label>
                    <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2 text-neutral-400" value={eventName} readOnly />
                  </div>
                  <div>
                    <label className="block text-sm mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
                    <input type="password" className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value={password} onChange={e=>setPassword(e.target.value)} />
                    <p className="text-xs text-neutral-400 mt-1">ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙØ¹ÙŠÙ‘Ù†Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø¯Ø®ÙˆÙ„.</p>
                  </div>
                  <button onClick={login} className="btn btn-primary w-full font-bold">
                    Ø¯Ø®ÙˆÙ„
                  </button>
                </div>
              </div>
            </div>
          );
        }
        
        return <EventApp event={eventName} onLogout={logout} />;
      }


      function EventApp({ event, onLogout }){
        const [invites,setInvites]=useState(() => loadInitialData(LS_INVITES)); 
        const [qrCards,setQrCards]=useState(() => loadInitialData(LS_QR_CARDS)); 
        const [active,setActive]=useState('home');
        const [modalOpen, setModalOpen] = useState(null);
        const stats=useMemo(()=>computeStats(invites),[invites]);

        const saveInvites = useCallback((arr) => SafeStorage.setItem(LS_INVITES, JSON.stringify(arr)), []);
        const saveQRCards = useCallback((arr) => SafeStorage.setItem(LS_QR_CARDS, JSON.stringify(arr)), []);
        
        useEffect(()=>{ saveInvites(invites); },[invites, saveInvites]);
        useEffect(()=>{ saveQRCards(qrCards); },[qrCards, saveQRCards]);
        
        const takeNextQrCards=(k)=>{
          const available=qrCards.filter(c=>!c.used);
          if(available.length<k) return null;
          const chosen=available.slice(0,k);
          const next=qrCards.map(c=> chosen.find(x=>x.id===c.id)? { ...c, used:true }: c);
          setQrCards(next); 
          return chosen.map(c=>({ ...c }));
        };
        const returnQrToPool=(ids=[])=>{
          const list=Array.isArray(ids)? ids: (ids? [ids]: []);
          if(!list.length) return;
          setQrCards(prev=> prev.map(c=> list.includes(c.id)? { ...c, used:false }: c)); 
        };

        const addInvite=({guestName,phone,count,eventName})=>{
          const k=Math.max(1, Number(count||1));
          const qrList=takeNextQrCards(k);
          if(!qrList){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ±ÙˆØª ÙƒØ§ÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙØ¯Ø®Ù„. Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯.'); return; }
          const inv=makeInvite({ guestName, phone, count:k, eventName:eventName||event, qrList });
          setInvites(prev=>[inv, ...prev]); 
        };
        const deleteInvite=(id)=>{
          setInvites(prev=>{
            const inv=prev.find(x=>x.id===id);
            if(inv?.qrIds?.length) returnQrToPool(inv.qrIds);
            else if(inv?.qrId) returnQrToPool([inv.qrId]);
            return prev.filter(x=>x.id!==id);
          });
        };
        
        const markStatus=(id,status)=>{
             setInvites(prev=>{
                const inviteToUpdate = prev.find(i => i.id === id);
                if (!inviteToUpdate) return prev;

                if (status === 'declined') {
                    if (inviteToUpdate.qrIds.length > 0) {
                        returnQrToPool(inviteToUpdate.qrIds);
                    }
                } 
                
                return prev.map(i => i.id===id? { ...i, status }: i);
             });
        }
        
        // ğŸŸ¢ Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙØ­Ø¯Ù‘ÙØ«Ø© Ù…Ø¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø±Ø¯
        const sendText=(inv)=>{
          const confirmLink = generateWhatsappLink(inv.id, 'confirm', inv.guestName);
          const declineLink = generateWhatsappLink(inv.id, 'decline', inv.guestName);

          const msg=`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${inv.guestName}\n\nÙŠØ´Ø±ÙÙ†Ø§ Ø¯Ø¹ÙˆØªÙƒ Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©: *${event}*.\n\nØ¹Ø¯Ø¯ ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†: *${inv.count}*\n\nÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø© Ù„Ù„Ø­Ø¶ÙˆØ±.\n\n*Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ£ÙƒÙŠØ¯ Ø­Ø¶ÙˆØ±Ùƒ Ø£Ùˆ Ø§Ø¹ØªØ°Ø§Ø±Ùƒ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø£Ø¯Ù†Ø§Ù‡:*\n\nâœ… *Ø£Ø¤ÙƒØ¯ Ø­Ø¶ÙˆØ±ÙŠ:*\n${confirmLink}\n\nâŒ *Ø£Ø¹ØªØ°Ø± Ø¹Ù† Ø§Ù„Ø­Ø¶ÙˆØ±:*\n${declineLink}\n\nØ´ÙƒØ±Ø§Ù‹ Ù„Ùƒ.`;
          
          openWhatsApp(inv.phone,msg); markStatus(inv.id,'sent');
        };
        
        const bulkSend=(list)=>{ if(!confirm(`Ø³ÙŠØªÙ… ÙØªØ­ ${list.length} Ø±Ø³Ø§Ù„Ø©/ØªØ¨ÙˆÙŠØ¨. Ù‚Ø¯ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø¹Ø¶Ù‡Ø§. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) return; list.forEach((inv,i)=> setTimeout(()=>sendText(inv), i*350)); };
        
        const handleImportPeopleFile = async (file)=>{
          try {
            let rows=[];
            if(/\.(xlsx|xlsm|xlsb|xls)$/i.test(file.name)) rows = await readXLSX(file); else rows = parseCSV(await file.text());
            if(!rows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
            
            const added = rows.map(r => ({ guestName:r.guestName, phone:r.phone, count:r.count, eventName:event }));
            
            const existingPhones = new Set(invites.map(i => normalizePhone(i.phone)));
            const uniqueAdded = added.filter(x => {
              const normalizedPhone = normalizePhone(x.phone);
              if (normalizedPhone.length < 9) return false;
              if (existingPhones.has(normalizedPhone)) {
                console.warn(`Skipping duplicate phone: ${x.phone} for ${x.guestName}`);
                return false;
              }
              existingPhones.add(normalizedPhone);
              return true;
            });

            if (!uniqueAdded.length) {
              alert('Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙŠ Ø³Ø¬Ù„Ø§Øª ÙØ±ÙŠØ¯Ø© (Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…ÙƒØ±Ø±Ø© Ø£Ùˆ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ ØºÙŠØ± ØµØ§Ù„Ø­Ø©).');
              return;
            }

            const totalNeededCards = uniqueAdded.reduce((sum, item) => sum + Math.max(1, Number(item.count || 1)), 0);
            const cardsRemaining = qrCards.filter(c=>!c.used).length;
            
            let reservedCards = [];
            
            if (totalNeededCards > cardsRemaining) {
              alert(`ØªØ­Ø°ÙŠØ±: Ù„Ø§ ØªØªÙˆÙØ± ÙƒØ±ÙˆØª Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙƒØ§ÙÙŠØ©. Ù…Ø·Ù„ÙˆØ¨ ${totalNeededCards} ÙƒØ±ØªØŒ Ø§Ù„Ù…ØªØ§Ø­ ${cardsRemaining}. Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø¨Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙ‚Ø· ÙˆØ§Ù„Ø¨Ù‚ÙŠØ© Ø¨Ø¯ÙˆÙ† ÙƒØ±ÙˆØª.`);
              const allAvailable = qrCards.filter(c=>!c.used);
              reservedCards = takeNextQrCards(allAvailable.length);
            } else {
              reservedCards = takeNextQrCards(totalNeededCards);
            }
            
            let cardIndex = 0;
            const newInvites = uniqueAdded.map(x => {
                const k = Math.max(1, Number(x.count || 1));
                let qrListForInvite = [];

                if (reservedCards.length > cardIndex) {
                    qrListForInvite = reservedCards.slice(cardIndex, cardIndex + k);
                    cardIndex += k;
                }
                
                return makeInvite({ ...x, count: k, qrList: qrListForInvite });
            });

            setInvites(prev => [...newInvites.filter(i => i.qrId || i.count === 0), ...prev]); 
            
            alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${uniqueAdded.length} Ø³Ø¬Ù„. ÙˆØªÙ… ØªØ®ØµÙŠØµ ${reservedCards.length} ÙƒØ±Øª Ø¨Ø§Ø±ÙƒÙˆØ¯.`);

          } catch(e){ console.error(e); alert('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.'); }
        };

        const handleExportData = () => {
            const dataToExport = {
                eventName: event,
                invites: invites,
                qrCards: qrCards,
                qrDataCache: Array.from(QRDataCache.entries()) 
            };
            const filename = `hormez_export_${event}_${new Date().toISOString().slice(0, 10)}.json`;
            downloadJSON(dataToExport, filename);
        };

        const handleImportData = async (file) => {
            try {
                const text = await readFileAsText(file);
                const importedData = JSON.parse(text);

                if (!importedData || (!importedData.invites && !importedData.qrCards)) {
                    alert('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: Ù…Ù„Ù JSON ØºÙŠØ± Ù…ÙƒØªÙ…Ù„ Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.');
                    return;
                }

                if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯Ø« '${importedData.eventName || 'Ù…ÙØ³ØªÙˆØ±Ø¯'}'ØŸ Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.`)) {
                    
                    const importedQrCards = Array.isArray(importedData.qrCards) ? importedData.qrCards : [];
                    setQrCards(importedQrCards);

                    const importedCache = new Map(importedData.qrDataCache || []);
                    QRDataCache.clear();
                    importedCache.forEach((v, k) => QRDataCache.set(k, v));
                    updateQrCache();

                    const importedInvites = Array.isArray(importedData.invites) ? importedData.invites : [];
                    setInvites(importedInvites);
                    
                    alert(`ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… ØªØ­Ù…ÙŠÙ„ ${importedInvites.length} Ø¯Ø¹ÙˆØ© Ùˆ ${importedQrCards.length} ÙƒØ±Øª.`);
                    
                    window.location.reload(); 
                }

            } catch (e) {
                console.error("Failed to import JSON data:", e);
                alert('ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù JSON. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Ù…Ù„Ù Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„ØµØ­ÙŠØ­ ÙˆØºÙŠØ± ØªØ§Ù„Ù (Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù).');
            }
        };
        
        const updateInvite = (updatedInvite) => {
             setInvites(prevInvites => {
                const newInvites = prevInvites.map(inv => 
                    inv.id === updatedInvite.id ? updatedInvite : inv
                );
                return newInvites;
            });
            setModalOpen(null);
        };
        
        const cardsRemaining = qrCards.filter(c=>!c.used).length;
        const bulkCandidates = invites.filter(i=> (i.status==='new' || i.status==='reminded') && i.status !== 'declined');

        return (
          <div>
            <header className="sticky top-0 z-20 card px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span className="font-black">Ù„ÙˆØ­Ø© Ø­Ø¯Ø«: <span className="text-yellow-400">{event}</span></span>
              </div>
              <div className="flex items-center gap-2">
                <span className="chip">Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù…Ø­Ù„ÙŠØ§Ù‹: {cardsRemaining}</span>
                <button className="btn btn-ghost" onClick={() => onLogout()}>Ø®Ø±ÙˆØ¬/ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
              </div>
            </header>

            <main className="max-w-6xl mx-auto p-4 md:p-8">
              <div className="card p-6">
                <div className="flex items-center justify-between flex-wrap gap-3">
                  <div>
                    <h2 className="text-xl md:text-2xl font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª (ÙŠØ¹Ù…Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·)</h2>
                    <p className="text-neutral-400">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ÙƒØ±ÙˆØª ØªÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø· ÙˆÙ„Ø§ ØªÙØ²Ø§Ù…ÙÙ† Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹.</p>
                  </div>
                  <span className="chip">Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„: {bulkCandidates.length}</span>
                </div>
                <div className="my-4 h-px bg-[#23262b]" />
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
                  <Stat label="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª" value={stats.total} />
                  <Stat label="Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©" value={stats.active} />
                  <Stat label="Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¤ÙƒØ¯" value={stats.sent} />
                  <Stat label="Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙØ¹Ù„ÙŠ" value={stats.attended} />
                  <Stat label="Ø§Ø¹ØªØ°Ø§Ø±/Ù…Ù„ØºØ§Ø©" value={stats.declined} /> 
                </div>
              </div>

              <div className="flex flex-wrap gap-2 mt-4">
                {NavBtn('home','Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',()=>setActive('home'),active)}
                {NavBtn('new','Ø¯Ø¹ÙˆØ© Ø¬Ø¯ÙŠØ¯Ø©',()=>setActive('new'),active)}
                {NavBtn('send','Ø§Ù„Ø¥Ø±Ø³Ø§Ù„',()=>setActive('send'),active)}
                {NavBtn('import','Ø§Ø³ØªÙŠØ±Ø§Ø¯',()=>setActive('import'),active)}
              </div>

              {active==='home' && (
                <div className="card p-6 mt-3">
                  <InviteTable 
                    invites={invites} 
                    qrCards={qrCards} 
                    onMark={markStatus} 
                    onDelete={deleteInvite} 
                    onManage={(inv) => setModalOpen(inv)}
                  />
                </div>
              )}

              {active==='new' && (
                <NewInviteForm 
                  onCreate={addInvite} 
                  forcedEventName={event} 
                  cardsRemaining={cardsRemaining} 
                  onImportPeopleFile={handleImportPeopleFile}
                />
              )}

              {active==='send' && (
                <SendCenter invites={invites} onSend={sendText} onMark={markStatus} />
              )}

              {active==='import' && (
                <ImportCenter qrCards={qrCards} setQrCards={setQrCards} onImportPeopleFile={handleImportPeopleFile} onExportData={handleExportData} onImportData={handleImportData} />
              )}
            </main>

            {modalOpen && (
                <ManualCardAssigner 
                    invite={modalOpen}
                    qrCards={qrCards}
                    cardsRemaining={cardsRemaining}
                    onClose={() => setModalOpen(null)}
                    onUpdateInvite={updateInvite}
                    takeNextQrCards={takeNextQrCards}
                    returnQrToPool={returnQrToPool}
                    onMarkStatus={markStatus} 
                />
            )}
          </div>
        );
      }
      
      
      function ManualCardAssigner({ invite, qrCards, cardsRemaining, onClose, onUpdateInvite, takeNextQrCards, returnQrToPool, onMarkStatus }) {
          const [newCount, setNewCount] = useState(invite.count);
          
          const availableQrCards = useMemo(() => qrCards.filter(c => !c.used), [qrCards]);
          const currentAssignedCards = useMemo(() => 
             qrCards.filter(c => invite.qrIds.includes(c.id)), 
             [qrCards, invite.qrIds]
          );

          const handleCountChange = () => {
              const currentCount = invite.count;
              const diff = newCount - currentCount;

              if (newCount < 1) {
                  alert("ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ† 1 Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
                  setNewCount(currentCount);
                  return;
              }
              
              if (invite.status === 'declined') {
                  alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø¯ Ù„Ø¯Ø¹ÙˆØ© ØªÙ… Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± Ø¹Ù†Ù‡Ø§. ÙŠØ±Ø¬Ù‰ Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹.');
                  setNewCount(currentCount);
                  return;
              }

              if (diff > 0) {
                  if (diff > cardsRemaining) {
                      alert(`Ù„Ø§ ØªØªÙˆÙØ± ${diff} ÙƒØ±Øª Ø¥Ø¶Ø§ÙÙŠ. Ø§Ù„Ù…ØªØ§Ø­: ${cardsRemaining}.`);
                      setNewCount(currentCount);
                      return;
                  }
                  const newCards = takeNextQrCards(diff);
                  const updatedQrIds = [...invite.qrIds, ...newCards.map(c => c.id)];

                  const updatedInvite = {
                      ...invite,
                      count: newCount,
                      qrIds: updatedQrIds,
                      qrId: updatedQrIds[0] || null,
                      qrNumber: qrCards.find(c=>c.id===updatedQrIds[0])?.cardNumber || null,
                  };
                  onUpdateInvite(updatedInvite);
                  alert(`ØªÙ… Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø¯ Ø¥Ù„Ù‰ ${newCount} ÙˆØ³Ø­Ø¨ ${diff} ÙƒØ±Øª Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­.`);

              } else if (diff < 0) {
                  const cardsToReturn = invite.qrIds.slice(newCount);
                  const remainingCards = invite.qrIds.slice(0, newCount);

                  returnQrToPool(cardsToReturn);

                  const updatedInvite = {
                      ...invite,
                      count: newCount,
                      qrIds: remainingCards,
                      qrId: remainingCards[0] || null,
                      qrNumber: qrCards.find(c=>c.id===remainingCards[0])?.cardNumber || null,
                  };
                  onUpdateInvite(updatedInvite);
                  alert(`ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø¯ Ø¥Ù„Ù‰ ${newCount} ÙˆØ¥Ø¹Ø§Ø¯Ø© ${Math.abs(diff)} ÙƒØ±Øª Ù„Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­.`);
              } else {
                  onClose();
              }
          };

          const toggleCardAssignment = (cardId) => {
              const card = qrCards.find(c => c.id === cardId);
              const isAssignedToThisInvite = invite.qrIds.includes(cardId);
              const isUsedByAnother = card.used && !isAssignedToThisInvite;
              
              if (invite.status === 'declined') {
                  alert('Ø§Ù„Ø¯Ø¹ÙˆØ© Ù…Ù„ØºØ§Ø©/Ù…Ø¹ØªØ°Ø± Ø¹Ù†Ù‡Ø§. ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ± Ø­Ø§Ù„ØªÙ‡Ø§ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ ØªØ®ØµÙŠØµ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯.');
                  return;
              }

              if (isUsedByAnother) {
                  alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ®ØµÙŠØµ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ±ØªØŒ ÙÙ‡Ùˆ Ù…ÙØ³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ø¯Ø¹ÙˆØ© Ø£Ø®Ø±Ù‰.');
                  return;
              }
              
              let updatedQrIds;
              let successMessage = '';

              if (isAssignedToThisInvite) {
                  updatedQrIds = invite.qrIds.filter(id => id !== cardId);
                  returnQrToPool([cardId]);
                  successMessage = `ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ®ØµÙŠØµ Ø§Ù„ÙƒØ±Øª #${card.cardNumber} ÙˆØ¥Ø¹Ø§Ø¯ØªÙ‡ Ù„Ù„Ø±ØµÙŠØ¯.`;
                  
              } else {
                  updatedQrIds = [...invite.qrIds, cardId];
                   // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ qrCards ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ø¬Ø¹Ù„ Ø§Ù„ÙƒØ±Øª Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹
                   setQrCards(prev=> prev.map(c=> c.id === cardId ? { ...c, used:true } : c));
                  successMessage = `ØªÙ… ØªØ®ØµÙŠØµ Ø§Ù„ÙƒØ±Øª #${card.cardNumber} Ù„Ù„Ø¯Ø¹ÙˆØ©.`;
              }
              
              const newCountValue = Math.max(1, updatedQrIds.length);
              
              const updatedInvite = {
                  ...invite,
                  qrIds: updatedQrIds,
                  qrId: updatedQrIds[0] || null,
                  qrNumber: qrCards.find(c=>c.id===updatedQrIds[0])?.cardNumber || null,
                  count: newCountValue 
              };
              
              onUpdateInvite(updatedInvite);
              setNewCount(newCountValue);
              alert(`${successMessage} ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ ${newCountValue}.`);
          };
          
          const handleStatusUpdate = (status) => {
              if (status === 'declined' && invite.status !== 'declined') {
                  if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø¹ÙˆØ© (${invite.guestName}) ÙˆØ¥Ø¹Ø§Ø¯Ø© ${invite.qrIds.length} ÙƒØ±Øª Ù„Ù„Ø±ØµÙŠØ¯ØŸ`)) {
                      return;
                  }
              }
              onMarkStatus(invite.id, status);
              onClose();
          };

          const allRelevantCards = useMemo(() => {
              const assignedIds = new Set(invite.qrIds);
              const availableIds = new Set(availableQrCards.map(c => c.id));
              
              const uniqueCards = new Map();
              currentAssignedCards.forEach(c => uniqueCards.set(c.id, c));
              availableQrCards.forEach(c => {
                  if (!uniqueCards.has(c.id)) {
                      uniqueCards.set(c.id, c);
                  }
              });
              
              return Array.from(uniqueCards.values());
          }, [invite.qrIds, availableQrCards, currentAssignedCards]);
          
          
          return (
              <div className="modal-overlay" onClick={onClose}>
                  <div className="modal-content w-full md:w-[700px] lg:w-[900px]" onClick={e => e.stopPropagation()}>
                      <h2 className="text-xl font-bold mb-4 border-b border-[#23262b] pb-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø¹ÙˆØ©: {invite.guestName}</h2>
                      <p className="text-neutral-400 mb-4">
                        Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: **{invite.count}** ÙƒØ±Øª. 
                        Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙƒÙ„ÙŠ: **{cardsRemaining}**.
                      </p>
                      
                      <div className="space-y-6">
                          {/* 1. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø¹ÙˆØ© (Ø­Ø¶Ø±/Ø§Ø¹ØªØ°Ø±) */}
                          <div className="card p-4 bg-[#1a1e24]">
                              <h3 className="font-semibold mb-3">ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø¹ÙˆØ©</h3>
                              <div className="flex flex-wrap gap-2">
                                  <button onClick={() => handleStatusUpdate('confirmed')} className="btn btn-ghost !bg-blue-600/50">ØªØ£ÙƒÙŠØ¯ Ø­Ø¶ÙˆØ± (RSVP)</button>
                                  <button onClick={() => handleStatusUpdate('attended')} className="btn btn-ghost !bg-green-600/50">Ø­Ø¶Ø± ÙØ¹Ù„ÙŠØ§Ù‹</button>
                                  <button onClick={() => handleStatusUpdate('reminded')} className="btn btn-ghost">ØªØ°ÙƒÙŠØ±</button>
                                  <button onClick={() => handleStatusUpdate('declined')} className="btn btn-ghost !bg-red-600/50 !text-red-300">Ø§Ø¹ØªØ°Ø§Ø±/Ø¥Ù„ØºØ§Ø¡ (Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØ±ÙˆØª)</button>
                              </div>
                              <p className="text-xs text-yellow-400 mt-2">
                                  **Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± ÙŠÙ„ØºÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆÙŠØ¹ÙŠØ¯Ù‡ Ù„Ù„Ø±ØµÙŠØ¯.**
                                  Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span className={`chip ${invite.status==='declined' ? '!bg-red-600 !text-white' : ''}`}>{invite.status}</span>
                              </p>
                          </div>

                          {/* 2. ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ† */}
                          <div className="card p-4 bg-[#1a1e24]">
                              <h3 className="font-semibold mb-3">ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ† ÙŠØ¯ÙˆÙŠØ§Ù‹</h3>
                              <div className="flex flex-wrap items-center gap-4">
                                  <input 
                                      type="number" 
                                      min="1" 
                                      value={newCount} 
                                      onChange={e => setNewCount(Math.max(1, Number(e.target.value)))}
                                      className="w-24 rounded-lg bg-[#0f1318] border border-[#23262b] px-3 py-2" 
                                      readOnly={invite.status === 'declined'}
                                  />
                                  <button 
                                      onClick={handleCountChange} 
                                      disabled={newCount === invite.count || invite.status === 'declined'}
                                      className={`btn ${newCount === invite.count ? 'btn-ghost opacity-50' : 'btn-primary'}`}
                                  >
                                      ØªØ·Ø¨ÙŠÙ‚ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø¯Ø¯ 
                                  </button>
                                  <p className="text-sm text-neutral-400">
                                      {newCount > invite.count 
                                          ? `(Ø³ÙŠØªÙ… Ø³Ø­Ø¨ ${newCount - invite.count} ÙƒØ±Øª Ø¬Ø¯ÙŠØ¯)` 
                                          : newCount < invite.count 
                                          ? `(Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ${invite.count - newCount} ÙƒØ±Øª Ù„Ù„Ø±ØµÙŠØ¯)` 
                                          : `(Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ)`}
                                  </p>
                              </div>
                          </div>
                          
                          {/* 3. Ø§Ù„ØªØ®ØµÙŠØµ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ */}
                          <div className="card p-4 bg-[#1a1e24]">
                              <h3 className="font-semibold mb-3">Ø§Ù„ØªØ®ØµÙŠØµ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ({invite.qrIds.length} ÙƒØ±Øª Ù…ÙØ®ØµØµ Ø­Ø§Ù„ÙŠÙ‹Ø§)</h3>
                              <div className="flex justify-between items-center mb-3">
                                <p className="text-sm text-neutral-400">
                                    Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø§Ù„ÙƒØ±Øª Ù„ØªØ®ØµÙŠØµÙ‡ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ ØªØ®ØµÙŠØµÙ‡.
                                </p>
                                <button className="btn btn-ghost text-sm" onClick={() => downloadAllQRs(invite, qrCards)}>ØªÙ†Ø²ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
                              </div>
                              
                              <div className="grid grid-cols-5 sm:grid-cols-8 lg:grid-cols-10 gap-3 max-h-96 overflow-y-auto p-2">
                                  {allRelevantCards.map(c => {
                                      const isAssigned = invite.qrIds.includes(c.id);
                                      const dataUrl = QRDataCache.get(c.id);
                                      
                                      return (
                                          <div 
                                              key={c.id} 
                                              className={`flex flex-col items-center p-1 rounded-lg transition ${isAssigned ? 'border-2 border-green-500 bg-green-900/30' : c.used && !isAssigned ? 'opacity-50 cursor-not-allowed' : 'border border-transparent hover:border-yellow-500/50 cursor-pointer'}`}
                                              onClick={() => toggleCardAssignment(c.id)}
                                              title={isAssigned ? 'Ù…Ø®ØµØµ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø¹ÙˆØ© (Ø§Ø¶ØºØ· Ù„Ù„Ø¥Ø²Ø§Ù„Ø©)' : c.used ? 'Ù…Ø®ØµØµ Ù„Ø¯Ø¹ÙˆØ© Ø£Ø®Ø±Ù‰ (Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù†Ù‚Ù„)' : 'Ù…ØªØ§Ø­ (Ø§Ø¶ØºØ· Ù„Ù„ØªØ®ØµÙŠØµ)'}
                                          >
                                              {dataUrl 
                                                  ? (<img className="w-12 h-12 object-contain rounded-md" src={dataUrl} alt="QR" />)
                                                  : (<div className="w-12 h-12 flex items-center justify-center text-[8px] text-neutral-500 bg-[#0f1318] rounded-md">ØºÙŠØ± Ù…ØªÙˆÙØ±</div>)}
                                              <span className="text-[10px] mt-1 font-bold">{c.cardNumber || '??'}</span>
                                              <span className={`text-[8px] ${isAssigned ? 'text-green-400' : c.used ? 'text-red-400' : 'text-neutral-400'}`}>
                                                  {isAssigned ? 'Ù…Ø®ØµØµ' : c.used ? 'Ù…Ø³ØªØ®Ø¯Ù…' : 'Ù…ØªØ§Ø­'}
                                              </span>
                                          </div>
                                      );
                                  })}
                              </div>
                          </div>

                      </div>
                      
                      <div className="flex justify-end gap-3 mt-6 pt-4 border-t border-[#23262b]">
                          <button className="btn btn-ghost" onClick={onClose}>Ø¥ØºÙ„Ø§Ù‚</button>
                      </div>
                  </div>
              </div>
          );
      }


      function Stat({ label, value }){ return (<div className="card p-4"><p className="text-neutral-400 text-sm">{label}</p><p className="text-2xl font-extrabold mt-1">{value}</p></div>); }
      function NavBtn(key,label,onClick,active){ return <button onClick={onClick} className={`btn ${active===key? 'btn-primary' : 'btn-ghost'}`}>{label}</button>; }

      function InviteTable({ invites, qrCards, onMark, onDelete, onManage }){
        if(!invites.length) return <div className="text-neutral-400 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø¹ÙˆØ§Øª Ø¨Ø¹Ø¯.</div>;
        return (
          <div className="overflow-x-auto">
            <table className="w-full text-right">
              <thead>
                <tr className="text-neutral-400 text-sm border-b border-[#23262b]">
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                  <th>Ø§Ù„ÙƒØ±ÙˆØª</th>
                  <th>Ø£ÙˆÙ„ Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>Ø¥Ø¯Ø§Ø±Ø©</th>
                </tr>
              </thead>
              <tbody>
                {invites.map(inv => (
                  <tr key={inv.id} className="border-b border-[#1a1e24]">
                    <td>{inv.guestName}</td>
                    <td dir="ltr">{inv.phone}</td>
                    <td><span className="chip">{inv.count}</span></td>
                    <td>
                      {inv.qrId && QRDataCache.get(inv.qrId) ? (
                        <div className="flex flex-col items-start gap-1">
                          <img className="thumb" src={QRDataCache.get(inv.qrId)} alt="QR" title={`Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø±Ù‚Ù…: ${inv.qrNumber}`} />
                        </div>
                      ) : (<span className="chip">â€”</span>)}
                    </td>
                    <td>
                      <span className={`chip 
                          ${inv.status==='new'?'':''} 
                          ${inv.status==='sent'?'!bg-blue-600 !text-white':''} 
                          ${inv.status==='reminded'?'!bg-purple-600 !text-white':''} 
                          ${inv.status==='confirmed'?'!bg-sky-600 !text-white':''}
                          ${inv.status==='attended'?'!bg-green-600 !text-white':''}
                          ${inv.status==='declined'?'!bg-red-600 !text-white':''}
                          `}>
                        {inv.status==='new'? 'Ø¬Ø¯ÙŠØ¯Ø©' : inv.status==='sent'? 'Ù…ÙØ±Ø³Ù„Ø©' : inv.status==='reminded'? 'Ù…ÙØ°ÙƒÙ‘Ø±' : inv.status==='confirmed'? 'Ù…Ø¤ÙƒØ¯' : inv.status==='attended'? 'Ø­Ø¶Ø±' : 'Ø§Ø¹ØªØ°Ø§Ø±/Ù…Ù„ØºØ§Ø©'}
                      </span>
                    </td>
                    <td>
                      <div className="flex gap-2 justify-end items-center">
                        <button className="btn btn-primary text-sm whitespace-nowrap" onClick={() => onManage(inv)}>
                            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø¹ÙˆØ© ({inv.qrIds.length} ÙƒØ±Øª)
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      }
      
      // (Ø¨Ù‚ÙŠØ© Ù…ÙƒÙˆÙ†Ø§Øª NewInviteForm Ùˆ ImportCenter ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ù† Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚)
      function NewInviteForm({ onCreate, forcedEventName, cardsRemaining, onImportPeopleFile }){
        const [guestName,setGuestName]=useState('');
        const [phone,setPhone]=useState('');
        const [count,setCount]=useState(1);
        const [eventName,setEventName]=useState(forcedEventName||'');
        const peopleInput=useRef(null);
        useEffect(()=>{ if(forcedEventName) setEventName(forcedEventName); },[forcedEventName]);

        const importFromContacts = async () => {
          try {
            const supported = 'contacts' in navigator && 'select' in (navigator.contacts||{});
            if(!supported){ alert('Ù‚Ø¯ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù…ØªØµÙØ­Ùƒ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„. Ø¬Ø±Ù‘Ø¨ ÙƒØ±ÙˆÙ… Ø¹Ù„Ù‰ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯.'); return; }
            const contacts = await navigator.contacts.select(['name','tel'], { multiple:false });
            if(contacts && contacts[0]){
              const c = contacts[0];
              setGuestName((c.name && c.name[0]) || '');
              setPhone((c.tel && c.tel[0]) || '');
            }
          } catch { alert('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„'); }
        };

        const handlePeoplePick=(e)=>{ 
          const f=e.target.files?.[0]; 
          if(f) onImportPeopleFile(f); 
          e.target.value=''; 
        };

        const create=()=>{
          if(!guestName || !phone){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'); return; }
          if(count > cardsRemaining){ alert(`Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ±ÙˆØª Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙƒØ§ÙÙŠØ©. Ù…Ø·Ù„ÙˆØ¨ ${count}ØŒ Ø§Ù„Ù…ØªØ§Ø­ ${cardsRemaining}.`); return; }
          onCreate({ guestName, phone, count, eventName });
          setGuestName(''); setPhone(''); setCount(1);
        };

        return (
          <div className="card p-6 mt-3">
            <div className="grid md:grid-cols-2 gap-4">
              <div className="md:col-span-2">
                <label className="mb-1 inline-block text-sm">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
                <div className="flex flex-wrap gap-2">
                  <button className="btn btn-ghost" onClick={importFromContacts}>Ø³Ø¬Ù„ Ø§Ù„Ù‡Ø§ØªÙ</button>
                  <button className="btn btn-ghost" onClick={()=>peopleInput.current?.click()}>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ù…Ù„Ù (CSV/XLSX)</button>
                  <input ref={peopleInput} type="file" accept=".csv,.xlsx,.xls" className="hidden" onChange={handlePeoplePick} />
                  <span className="text-xs text-neutral-400 self-center">* Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¢Ù† ÙŠØ³Ø­Ø¨ Ø§Ù„ÙƒØ±ÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</span>
                </div>
              </div>
              <div>
                <label className="block text-sm mb-1">Ø§Ù„Ø§Ø³Ù…</label>
                <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={guestName} onChange={e=>setGuestName(e.target.value)} placeholder="Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ" />
              </div>
              <div>
                <label className="block text-sm mb-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={phone} onChange={e=>setPhone(e.target.value)} placeholder="05xxxxxxxx" />
              </div>
              <div>
                <label className="block text-sm mb-1">Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ±ÙˆØª Ù„Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†</label>
                <input type="number" min="1" className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={count} onChange={e=>setCount(Number(e.target.value||1))} />
              </div>
              <div>
                <label className="block text-sm mb-1">Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«</label>
                <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={eventName} onChange={e=>setEventName(e.target.value)} placeholder="Ù…Ø«Ø§Ù„: Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯" readOnly={Boolean(forcedEventName)} />
                <p className="text-xs text-neutral-400 mt-1">Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹: {cardsRemaining}</p>
              </div>
              <div className="md:col-span-2 flex items-center gap-2">
                <button className="btn btn-primary" onClick={create}>Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø¹ÙˆØ© (Ø³Ø­Ø¨ {""}{count} ÙƒØ±Øª)</button>
              </div>
            </div>
          </div>
        );
      }

      function ImportCenter({ qrCards, setQrCards, onImportPeopleFile, onExportData, onImportData }){
        const peopleInput=useRef(null); const qrInput=useRef(null); const jsonInput=useRef(null);
        const [uploading, setUploading] = useState(false);

        const handlePeoplePick=(e)=>{ const f=e.target.files?.[0]; if(f) onImportPeopleFile(f); e.target.value=''; };
        const handleJsonPick=(e)=>{ const f=e.target.files?.[0]; if(f) onImportData(f); e.target.value=''; };
        
        const onQrPick=async (e)=>{
          const files=Array.from(e.target.files||[]); if(!files.length) return;
          setUploading(true);
          try{
            const existing=qrCards; 
            const hashSet=new Set(existing.map(c=>c.contentHash)); 
            const toAdd=[];
            
            for(const file of files){
                try {
                    const dataUrl = await readFileAsDataURL(file); 
                    const r = getQrMetadata(file, dataUrl); 
                    
                    if(hashSet.has(r.contentHash)) continue;

                    toAdd.push(r); 
                    hashSet.add(r.contentHash); 

                } catch(readError) {
                    console.error(`Failed to read file ${file.name}:`, readError);
                }
            }
            
            if(toAdd.length){ 
              setQrCards(prev=>[...toAdd, ...prev]); 
              alert(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${toAdd.length} Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØ­ÙØ¸Ù‡Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±).`);
            } else {
              alert('ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…ÙƒØ±Ø±Ø© Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©.');
            }

          }catch(err){ 
            console.error(err); 
            alert('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª.'); 
          }
          setUploading(false);
          e.target.value='';
        };

        const clearUsed=()=>{ if(confirm('Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ±ÙˆØª Ø¥Ù„Ù‰ "Ù…ØªØ§Ø­"ØŸ')) setQrCards(prev=>prev.map(c=>({...c,used:false}))); };
        
        const purgeAll =()=>{ 
            if(confirm('Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„ÙƒØ±ÙˆØª) Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯Ø«ØŸ')) {
                setQrCards([]); 
                QRDataCache.clear(); 
                updateQrCache();
                SafeStorage.removeItem(LS_INVITES);
                alert('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ±ÙˆØª ÙˆØ§Ù„Ø¯Ø¹ÙˆØ§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø². (Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø§ Ø²Ø§Ù„Øª Ø«Ø§Ø¨ØªØ© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯).');
                window.location.reload(); 
            }
        };
        
        const cardsToDisplay = qrCards.map(c => ({
            ...c,
            dataUrl: QRDataCache.get(c.id) || null
        }));


        return (
          <div className="grid md:grid-cols-2 gap-4 mt-3">
            <div className="card p-6 md:col-span-2">
                <h3 className="font-bold">ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯Ø« (Ù†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©)</h3>
                <p className="text-xs text-neutral-400 mt-1">ÙŠÙØ³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£Ùˆ Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…ÙØ®ØµØµØ© Ø¥Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±.</p>
                <div className="mt-3 flex flex-wrap gap-2">
                    <button className="btn btn-primary" onClick={onExportData}>ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ€ JSON</button>
                    <button className="btn btn-ghost" onClick={()=>jsonInput.current?.click()}>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª JSON</button>
                    <input ref={jsonInput} type="file" accept=".json" className="hidden" onChange={handleJsonPick} />
                </div>
            </div>

            <div className="card p-6">
              <h3 className="font-bold">ØªØ­Ù…ÙŠÙ„ ÙƒØ±ÙˆØª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (ØµÙˆØ±)</h3>
              <p className="text-xs text-neutral-400 mt-1">ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ± **Ù…Ø­Ù„ÙŠØ§Ù‹** ÙˆÙ„Ø§ ØªÙØ²Ø§Ù…Ù†. Ù„Ù† ØªØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±.</p>
              <div className="mt-3 flex flex-wrap gap-2">
                <button disabled={uploading} className="btn btn-primary" onClick={()=>qrInput.current?.click()}>
                    {uploading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©...' : 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª Ø¨Ø§Ø±ÙƒÙˆØ¯'}
                </button>
                <input ref={qrInput} type="file" accept="image/png,image/jpeg,image/jpg,image/svg+xml" multiple className="hidden" onChange={onQrPick} />
                <button className="btn btn-ghost" onClick={clearUsed}>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</button>
                <button className="btn btn-ghost !bg-red-700/20 !text-red-400" onClick={purgeAll}>Ù…Ø³Ø­ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯Ø« Ù…Ø­Ù„ÙŠØ§Ù‹</button>
              </div>
              <div className="mt-4 grid grid-cols-3 sm:grid-cols-5 md:grid-cols-6 gap-3">
                {cardsToDisplay.map(c=> (
                  <div key={c.id} className="flex flex-col items-center gap-1">
                    {c.dataUrl
                      ? (<img className="thumb" src={c.dataUrl} alt={c.name} title={c.name} />)
                      : (<div className="thumb flex items-center justify-center text-[10px] text-neutral-500">ØºÙŠØ± Ù…ØªÙˆÙØ± Ù…Ø­Ù„ÙŠØ§Ù‹</div>)}
                    <span className="text-[10px] text-neutral-400">{c.cardNumber ? `#${c.cardNumber}` : 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…'}</span>
                    <span className={`text-[10px] ${c.used? 'text-yellow-400' : 'text-neutral-500'}`}>{c.used? 'Ù…Ø³ØªØ®Ø¯Ù…' : 'Ù…ØªØ§Ø­'}</span>
                  </div>
                ))}
              </div>
            </div>

            <div className="card p-6">
              <h3 className="font-bold">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ¹Ø¯Ø¯ Ø§Ù„ÙƒØ±ÙˆØª (CSV / XLSX)</h3>
              <p className="text-xs text-neutral-400 mt-1">Ø³ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø³Ø­Ø¨ Ø§Ù„ÙƒØ±ÙˆØª ÙˆØªØ®ØµÙŠØµÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.</p>
              <div className="mt-3 flex gap-2">
                <button className="btn btn-ghost" onClick={()=>peopleInput.current?.click()}>Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</button>
                <input ref={peopleInput} type="file" accept=".csv,.xlsx,.xls" className="hidden" onChange={handlePeoplePick} />
              </div>
              <p className="text-xs text-yellow-400 mt-3">* Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ Ù„Ù… ØªØªÙˆÙØ± ÙƒØ±ÙˆØª ÙƒØ§ÙÙŠØ©ØŒ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙŠÙˆÙ Ø¨Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙ‚Ø·.</p>
            </div>
          </div>
        );
      }

      function SendCenter({ invites, onSend, onMark }){
        const [filter,setFilter]=useState('');
        const list=invites.filter(i=> (i.status==='new' || i.status==='reminded') && i.status !== 'declined')
          .filter(i=> [i.guestName,i.phone,i.eventName].some(f=> (f||'').toLowerCase().includes(filter.toLowerCase())));
        
        // ğŸŸ¢ Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨
        const openAdminWhatsappSearch = () => {
             // Ø¨Ù…Ø§ Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø¯ÙˆØ¯ ØªØ¨Ø¯Ø£ Ø¨Ù€ "RSVP-"
            const searchTag = encodeURIComponent("RSVP-"); 
            const url = `https://wa.me/search?query=${searchTag}`;
            try { window.open(url,'_blank','noopener,noreferrer'); }
            catch { alert('ØªØ¹Ø°Ø± ÙØªØ­ Ù†Ø§ÙØ°Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¨Ø­Ø«. Ø§Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù†: RSVP-'); }
        };

        return (
          <div className="card p-6 mt-3">
            <div className="flex flex-wrap items-center gap-2 mb-4">
              <input className="w-full md:w-80 rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…" value={filter} onChange={e=>setFilter(e.target.value)} />
            </div>
            
            {/* ğŸŸ¢ Ù‚Ø³Ù… Ø§Ù„Ø±Ø¯ÙˆØ¯ */}
            <div className="card p-4 bg-[#1a1e24] mb-4">
                 <h3 className="font-bold mb-2">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø¢Ù„ÙŠØ©</h3>
                 <p className="text-sm text-neutral-400 mb-3">
                    Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ©ØŒ ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¨ØªØ£ÙƒÙŠØ¯ Ø£Ùˆ Ø§Ø¹ØªØ°Ø§Ø± Ø¹Ø¨Ø± Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ ØªØµÙ„Ùƒ Ø£Ù†Øª (Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙØ¹ÙŠÙ‘Ù† ÙÙŠ Ø§Ù„ÙƒÙˆØ¯).
                 </p>
                 <div className="flex flex-wrap gap-2">
                    <button className="btn btn-primary" onClick={openAdminWhatsappSearch}>
                        Ø§ÙØªØ­ Ø¨Ø­Ø« ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø±Ø¯ÙˆØ¯ RSVP
                    </button>
                    <p className="text-sm text-yellow-400 self-center">
                        Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ `RSVP-[Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹ÙˆØ©]` Ø«Ù… Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø¹ÙˆØ© ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ø¹Ù„Ø§Ù‡.
                    </p>
                 </div>
            </div>

            {!list.length ? (
              <p className="text-neutral-400 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†.</p>
            ) : (
              <div className="grid md:grid-cols-2 gap-3">
                {list.map(inv => (
                  <div key={inv.id} className="card p-4 space-y-2">
                    <p><b>{inv.guestName}</b> â€” <span dir="ltr">{inv.phone}</span></p>
                    <p className="text-sm text-neutral-400">ÙƒØ±ÙˆØª Ù„Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†: {inv.count}</p>
                    <div className="flex gap-2 justify-end">
                      <button className="btn btn-primary" onClick={()=>onSend(inv)}>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ© ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø·</button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }
      
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
