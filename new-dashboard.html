import React, { useEffect, useMemo, useRef, useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Download, RefreshCw, Percent, Users, ClipboardList, Globe } from "lucide-react";

// Firebase v10 modular
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import {
  getFirestore,
  collection,
  query,
  where,
  onSnapshot,
  getDocs,
  orderBy,
  limit,
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

// --- CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
  authDomain: "hormez-inv.firebaseapp.com",
  projectId: "hormez-inv",
  storageBucket: "hormez-inv.firebasestorage.app",
  messagingSenderId: "747519941805",
  appId: "1:747519941805:web:468fada2492700e9da3a24",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- i18n (en/ar) ---
const STR = {
  en: {
    title: "Hormez Dashboard",
    subtitle: "Live attendance & invite status",
    event: "Event",
    language: "Language",
    total: "Total",
    used: "Checked-in",
    left: "Remaining",
    rate: "Attendance",
    refresh: "Refresh",
    export: "Export CSV",
    search: "Search code…",
    lastScans: "Recent scans",
    code: "Code",
    status: "Status",
    time: "Time",
    yes: "yes",
    no: "no",
    all: "All events",
  },
  ar: {
    title: "لوحة هورميز",
    subtitle: "الحضور المباشر وحالة الدعوات",
    event: "الحدث",
    language: "اللغة",
    total: "الإجمالي",
    used: "المستخدم",
    left: "المتبقي",
    rate: "نسبة الحضور",
    refresh: "تحديث",
    export: "تصدير CSV",
    search: "ابحث عن كود…",
    lastScans: "أحدث المسحات",
    code: "الكود",
    status: "الحالة",
    time: "الوقت",
    yes: "yes",
    no: "no",
    all: "كل الفعاليات",
  },
};

function useLocalState(key, initial) {
  const [v, setV] = useState(() => {
    try {
      const s = localStorage.getItem(key);
      return s ? JSON.parse(s) : initial;
    } catch {
      return initial;
    }
  });
  useEffect(() => {
    try {
      localStorage.setItem(key, JSON.stringify(v));
    } catch {}
  }, [key, v]);
  return [v, setV];
}

export default function Dashboard() {
  const [lang, setLang] = useLocalState("hs:dash:lang", "ar");
  const T = STR[lang] || STR.en;
  const isAr = lang === "ar";

  // Events list
  const [events, setEvents] = useState([]);
  const [event, setEvent] = useLocalState("hs:dash:event", "زفاف خالد");

  // KPIs
  const [total, setTotal] = useState(0);
  const [used, setUsed] = useState(0);
  const left = Math.max(total - used, 0);
  const rate = total > 0 ? Math.round((used / total) * 100) : 0;

  // Table
  const [rows, setRows] = useState([]);
  const [qStr, setQStr] = useState("");

  // Load events (distinct EventName)
  useEffect(() => {
    let mounted = true;
    (async () => {
      const ref = collection(db, "invites");
      // Pull a sample to build a set of events (lightweight scan)
      const snap = await getDocs(query(ref, limit(500)));
      const setE = new Set();
      snap.forEach((d) => {
        const ev = d.data().EventName || "";
        if (ev) setE.add(ev);
      });
      const list = Array.from(setE).sort((a, b) => a.localeCompare(b));
      if (mounted) setEvents(list);
      if (mounted && list.length && !event) setEvent(list[0]);
    })();
    return () => (mounted = false);
  }, []);

  // Realtime KPIs for selected event
  useEffect(() => {
    const ref = collection(db, "invites");
    const qAll = event && event !== "__ALL__" ? query(ref, where("EventName", "==", event)) : query(ref);

    const unsub = onSnapshot(qAll, (snap) => {
      let t = 0;
      let u = 0;
      const recent = [];
      snap.forEach((d) => {
        const data = d.data();
        t += 1;
        if ((data.Status || "").toLowerCase() === "yes") u += 1;
        // collect last scans
        if (data.scannedAt?.toDate?.()) {
          recent.push({
            id: d.id,
            Code: data.Code || d.id,
            Status: data.Status || "no",
            scannedAt: data.scannedAt.toDate(),
            EventName: data.EventName || "",
          });
        }
      });
      // sort desc by time
      recent.sort((a, b) => (b.scannedAt?.getTime?.() || 0) - (a.scannedAt?.getTime?.() || 0));
      setRows(recent.slice(0, 100));
      setTotal(t);
      setUsed(u);
    });
    return () => unsub();
  }, [event]);

  // Filtered rows by search
  const filtered = useMemo(() => {
    const s = qStr.trim().toLowerCase();
    if (!s) return rows;
    return rows.filter((r) => (r.Code || "").toLowerCase().includes(s));
  }, [rows, qStr]);

  // Export CSV
  function exportCSV() {
    const header = ["Code", "Status", "EventName", "scannedAt"].join(",");
    const lines = rows.map((r) => {
      const t = r.scannedAt ? new Date(r.scannedAt).toISOString() : "";
      return [r.Code, r.Status, r.EventName, t].join(",");
    });
    const csv = [header, ...lines].join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `hormez-${event || "all"}-scans.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  return (
    <div className={`min-h-screen bg-[#0b1020] text-slate-200 ${isAr ? "rtl" : "ltr"}`} dir={isAr ? "rtl" : "ltr"}>
      <div className="max-w-6xl mx-auto p-4 space-y-4">
        {/* Header */}
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-xl bg-black/60 border border-white/10 grid place-items-center">
            <span className="font-extrabold text-yellow-400">HS</span>
          </div>
          <div className="leading-tight">
            <div className="text-xs text-slate-400">HORMEZ SECURITY</div>
            <h1 className="text-xl font-bold">{T.title}</h1>
            <div className="text-xs text-slate-400">{T.subtitle}</div>
          </div>
          <div className="ml-auto flex items-center gap-2">
            <Button variant="ghost" onClick={() => setLang(lang === "ar" ? "en" : "ar")}> <Globe className="w-4 h-4 mr-2"/> {T.language}: {lang.toUpperCase()}</Button>
            <Button variant="outline" onClick={() => location.reload()}><RefreshCw className="w-4 h-4 mr-2"/>{T.refresh}</Button>
          </div>
        </div>

        {/* Filters */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
          <Card className="bg-white/5 border-white/10">
            <CardContent className="p-3">
              <div className="text-xs text-slate-400 mb-1">{T.event}</div>
              <Select value={event} onValueChange={setEvent}>
                <SelectTrigger className="bg-black/40 border-white/10">
                  <SelectValue placeholder={T.all} />
                </SelectTrigger>
                <SelectContent className="bg-[#0b1220] border-white/10 text-slate-200">
                  <SelectItem value="__ALL__">{T.all}</SelectItem>
                  {events.map((e) => (
                    <SelectItem key={e} value={e}>{e}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </CardContent>
          </Card>

          <Card className="bg-white/5 border-white/10">
            <CardContent className="p-3">
              <div className="text-xs text-slate-400 mb-1">{T.search}</div>
              <Input value={qStr} onChange={(e) => setQStr(e.target.value)} className="bg-black/40 border-white/10"/>
            </CardContent>
          </Card>

          <div className="flex gap-3">
            <Card className="flex-1 bg-white/5 border-white/10">
              <CardContent className="p-3 h-full flex flex-col justify-between">
                <div className="text-xs text-slate-400">{T.export}</div>
                <Button onClick={exportCSV} className="mt-2"><Download className="w-4 h-4 mr-2"/>{T.export}</Button>
              </CardContent>
            </Card>
          </div>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          <KPI icon={<ClipboardList/>} label={T.total} value={total} />
          <KPI icon={<Users/>} label={T.used} value={used} />
          <KPI icon={<Users/>} label={T.left} value={left} />
          <KPI icon={<Percent/>} label={T.rate} value={`${rate}%`} />
        </div>

        {/* Table */}
        <Card className="bg-white/5 border-white/10">
          <CardContent className="p-0 overflow-x-auto">
            <div className="p-3 text-xs text-slate-400">{T.lastScans}</div>
            <table className="min-w-full text-sm">
              <thead className="bg-white/5">
                <tr>
                  <Th>{T.code}</Th>
                  <Th>{T.status}</Th>
                  <Th>{T.time}</Th>
                </tr>
              </thead>
              <tbody>
                {filtered.map((r) => (
                  <tr key={r.id} className="border-t border-white/5">
                    <Td mono>{r.Code}</Td>
                    <Td>{(r.Status || "no").toLowerCase()}</Td>
                    <Td>{r.scannedAt ? new Date(r.scannedAt).toLocaleString(lang === "ar" ? "ar-EG" : "en-GB") : "—"}</Td>
                  </tr>
                ))}
                {filtered.length === 0 && (
                  <tr>
                    <Td colSpan={3} className="text-center text-slate-400 py-6">—</Td>
                  </tr>
                )}
              </tbody>
            </table>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

function KPI({ icon, label, value }) {
  return (
    <Card className="bg-white/5 border-white/10">
      <CardContent className="p-4 flex items-center gap-3">
        <div className="w-10 h-10 rounded-xl bg-black/40 border border-white/10 grid place-items-center">
          <div className="opacity-80">{icon}</div>
        </div>
        <div>
          <div className="text-xs text-slate-400">{label}</div>
          <div className="text-xl font-extrabold">{value}</div>
        </div>
      </CardContent>
    </Card>
  );
}

function Th({ children }) {
  return <th className="text-left font-semibold px-3 py-2 text-slate-300">{children}</th>;
}
function Td({ children, mono=false, colSpan, className="" }) {
  return (
    <td colSpan={colSpan} className={`px-3 py-2 ${mono? "font-mono" : ""} ${className}`}>{children}</td>
  );
}
