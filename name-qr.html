<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>KRS INVITE â€” Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (QR Ø¨Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ±Øª)</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700;900&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#0b0b0c; --panel:#14151a; --panel-2:#111217; --stroke:#2a2b32;
      --gold:#d4af37; --txt:#e7e7e7; --muted:#a7a7a7; --danger:#ef4444; --ok:#25d366;
      --solid-gold:#b48a18; --solid-blue:#1e40af; --solid-rose:#be123c; --solid-emerald:#047857;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent }
    html,body{ height:100% }
    body{ margin:0; font-family:'Noto Sans Arabic', system-ui, -apple-system, Segoe UI, Arial; background:var(--bg); color:var(--txt) }
    .container{ max-width:1200px; margin:0 auto; padding:16px }

    .topbar{ position:sticky; top:0; z-index:50; background:#0a0a0c; border-bottom:1px solid var(--stroke) }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900 }
    .brand .dot{ width:12px; height:12px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #ffe8a3, var(--gold)) }
    .event-name{ font-weight:900; color:#ffe8a3 }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn{
      border:1px solid var(--stroke); background:#121318; color:#fff; padding:12px 14px; border-radius:12px;
      cursor:pointer; font-weight:800; font-size:16px; min-height:44px
    }
    .btn:active{ transform:scale(0.99) }
    .btn.warn{ border-color:#7a1f1f }
    .btn.ok{ border-color:#1b8c4f }
    .hint{ color:var(--muted); font-size:13px }

    .tabs{ display:flex; gap:10px; padding:12px 0; flex-wrap:wrap }
    .tab{
      border:1px solid var(--stroke); background:#111217; color:#ddd; padding:12px 16px; border-radius:14px;
      cursor:pointer; font-weight:800; font-size:15px; min-height:44px
    }
    .tab.active{ border-color:var(--gold); color:#fff }
    .section{ display:none }
    .section.active{ display:block }

    .card{ background:#121318; border:1px solid var(--stroke); border-radius:16px; padding:14px }
    .card.gold{ background:var(--solid-gold); border-color:var(--solid-gold); color:#fff }
    .card.blue{ background:var(--solid-blue); border-color:var(--solid-blue); color:#fff }
    .card.rose{ background:var(--solid-rose); border-color:var(--solid-rose); color:#fff }
    .card.emerald{ background:var(--solid-emerald); border-color:var(--solid-emerald); color:#fff }

    .kpi{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px }
    .kpi .card h4{ margin:0; font-size:13px; color:#fff }
    .kpi .card .num{ font-size:22px; font-weight:900; margin-top:6px; color:#fff }

    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid rgba(255,255,255,.4); border-radius:999px; color:#fff; font-size:12px }
    .pill.light{ border-color:rgba(0,0,0,.15); background:rgba(255,255,255,.15) }

    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:16px; margin-top:10px }
    thead th{
      background:#1a1b20; color:#f6f6f6; border-bottom:1px solid var(--stroke);
      padding:12px; text-align:right; font-weight:900; font-size:14px
    }
    tbody td{ padding:12px; border-bottom:1px solid var(--stroke); font-size:15px; background:#0f1013; color:#e9e9e9 }
    tbody tr:hover td{ background:#15161b }
    .editable{ cursor:pointer; color:#ffd76a; font-weight:800; text-decoration:underline dotted rgba(212,175,55,.6); text-underline-offset:3px }

    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.8); display:flex; align-items:center; justify-content:center; z-index:100 }
    .modal{ width:100%; max-width:520px; background:#16171b; border:1px solid var(--stroke); border-radius:18px; padding:18px }
    .title{ margin:0 0 10px; font-weight:900; font-size:22px }

    textarea{ width:100%; resize:vertical; line-height:1.9 }

    @media (max-width: 640px){
      .container{ padding:12px }
      .tabs{ gap:8px }
      .tab{ flex:1; text-align:center; padding:10px 8px; font-size:14px }
      .kpi{ grid-template-columns:1fr 1fr }
      .btn.block{ width:100% }
      table thead{ display:none }
      table, tbody, tr, td{ display:block; width:100% }
      tbody tr{ border:1px solid var(--stroke); border-radius:14px; margin-bottom:10px; overflow:hidden }
      tbody td{ display:flex; justify-content:space-between; gap:12px }
      tbody td::before{ content:attr(data-label); color:#bdbdbd; font-weight:700 }
      td.actions{ display:block }
      .actions .btn{ width:100%; margin-top:8px }
    }
  </style>
</head>

<body>
  <!-- Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="authGate" class="overlay" style="display:none">
    <div class="modal">
      <h3 class="title">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­Ø¯Ø«</h3>
      <div class="hint">Ø£Ø¯Ø®Ù„ <b>Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«</b> Ùˆ<b>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</b> Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ† Ù„Ù…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ ÙÙ‚Ø·.</div>
      <div class="row" style="margin-top:10px">
        <input id="authEvent" class="btn" style="flex:1" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø«" />
        <input id="authPass" type="password" class="btn" style="flex:1" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
        <button class="btn" style="width:100%" onclick="authLogin()">Ø¯Ø®ÙˆÙ„</button>
      </div>
      <div id="authErr" class="hint" style="color:#ffb3b3; margin-top:8px"></div>
    </div>
  </div>

  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <div class="topbar">
    <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:12px">
      <div class="brand"><span class="dot"></span><span>KRS INVITE â€” Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span></div>
      <div class="row">
        <span id="currentEvent" class="event-name"></span>
        <button class="btn warn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- KPIs -->
    <section class="kpi" style="margin:12px 0 16px">
      <div class="card blue">
        <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†</h4><div class="num" id="kpiTotal">0</div>
      </div>
      <div class="card gold">
        <h4>Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù…ÙØ±Ø³Ù„Ø©</h4><div class="num" id="kpiSent">0</div>
      </div>
      <div class="card rose">
        <h4>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</h4><div class="num" id="kpiRemain">0</div>
      </div>
      <div class="card emerald">
        <h4>Ø±ØµÙŠØ¯ Ø§Ù„ÙƒØ±ÙˆØª (Ø«Ø§Ø¨Øª)</h4>
        <div class="row" style="gap:8px; margin-top:8px">
          <span class="pill light">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <b id="kpiStock">0</b></span>
          <span class="pill light">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <b id="kpiUsedCards">0</b></span>
          <span class="pill light">Ø§Ù„Ù…ØªØ§Ø­: <b id="kpiFreeCards">0</b></span>
        </div>
      </div>
    </section>

    <!-- Tabs -->
    <nav class="tabs" id="tabs">
      <button class="tab active" data-section="#sec-home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="tab" data-section="#sec-event">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯Ø«</button>
      <button class="tab" data-section="#sec-guests">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙŠÙˆÙ</button>
      <button class="tab" data-section="#sec-list">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†</button>
    </nav>

    <!-- Sections -->
    <section id="sec-home" class="section active">
      <div class="card gold">
        <h3 style="margin:0 0 8px">Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹</h3>
        <div class="hint">Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© ØªÙˆÙ„Ù‘Ø¯ QR ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙˆØªØ¶Ø¹ <b>Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ±Øª</b>. Ù„Ø§ ØªØ­ØªØ§Ø¬ Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØµÙˆØ± Ø¨Ø§Ø±ÙƒÙˆØ¯.</div>
      </div>
    </section>

    <section id="sec-event" class="section">
      <div class="card blue">
        <h3 style="margin:0 0 8px">ğŸ·ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯Ø«</h3>
        <div class="row">
          <input id="eventName" class="btn" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« (Ù„Ù„Ù…Ù„ÙØ§Øª ÙÙ‚Ø·)" style="flex:1" />
          <button class="btn" onclick="exportJSON()">ğŸ’¾ ØªØµØ¯ÙŠØ± JSON</button>
          <input id="dataUpload" type="file" accept=".json" style="display:none" onchange="importJSONFile(this.files[0])" />
          <button class="btn" onclick="document.getElementById('dataUpload').click()">â†©ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
        </div>
        <div class="hint" style="margin-top:8px">Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ØŒ ÙˆÙ‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ÙÙ‚Ø· Ù„ØªØ³Ù…ÙŠØ© Ù…Ù„ÙØ§Øª Ø§Ù„ØªØµØ¯ÙŠØ±.</div>
      </div>
    </section>

    <section id="sec-guests" class="section">
      <div class="card emerald">
        <h3 style="margin:0 0 8px">ğŸ‘¥ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙŠÙˆÙ</h3>
        <div class="row" style="margin-bottom:8px">
          <input id="guestListUpload" type="file" class="btn"
                 accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"
                 style="flex:1" />
          <button class="btn" onclick="handleFileUpload()">âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¶ÙŠÙˆÙ</button>
          <button class="btn ok" onclick="importFromContacts()">ğŸ“± Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ù‡Ø§ØªÙ</button>
        </div>
        <div class="row">
          <input id="newGuestName" class="btn" placeholder="Ø§Ù„Ø§Ø³Ù…" style="flex:1" />
          <input id="newGuestPhone" class="btn" placeholder="Ø§Ù„Ù‡Ø§ØªÙ (Ø¨Ø¯ÙˆÙ† +)" style="flex:1" />
          <input id="newGuestTotalNeeded" class="btn" type="number" min="1" value="1" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª" style="flex:1" />
          <button class="btn" onclick="addGuestManually()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙŠÙ</button>
        </div>
        <div class="hint" style="margin-top:8px">ØªÙ… ØªØ­Ù…ÙŠÙ„ <b id="guestCount">0</b> Ø¶ÙŠÙ.</div>
        <div class="hint" style="margin-top:6px;color:#ffd76a">
          Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù: <b>name, phone, totalNeeded</b>
        </div>
      </div>
    </section>

    <section id="sec-list" class="section">
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h3 style="margin:0 0 8px">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†</h3>
          <button class="btn ok" onclick="sendAllWhatsApp()">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ</th>
              <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
              <th>Ø§Ù„ÙƒÙˆØ¯/Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th style="text-align:left">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="guestTableBody"></tbody>
        </table>

        <div class="card gold" style="margin-top:12px">
          <h3 style="margin:0 0 6px">ğŸ–Šï¸ Ù†Øµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</h3>
          <p class="hint">Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª: <code>#{{GUEST_NAME}}#</code>ØŒ <code>#{{TOTAL_COUNT}}#</code></p>
          <textarea id="messageTemplate" class="btn" rows="4">Ù…Ø±Ø­Ø¨Ø§Ù‹ #{{GUEST_NAME}}#ØŒ
Ù†ØªØ´Ø±Ù Ø¨Ø¯Ø¹ÙˆØªÙƒÙ… Ù„Ø­Ø¶ÙˆØ± ÙØ¹Ø§Ù„ÙŠØªÙ†Ø§ (Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª: #{{TOTAL_COUNT}}#).
Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯Ø¹ÙˆØ© (QR) Ù„ÙƒÙ… Ù…Ù† Ø®Ù„Ø§Ù„ Ù…Ù†Ø¸ÙˆÙ…Ø© KRS INVITE.</textarea>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===============================
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø«Ø§Ø¨ØªØ© Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯
    // ===============================
    const DEFAULT_EVENT = "Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯";
    const DEFAULT_PASS  = "12345";
    const DEFAULT_CARD_STOCK = 200; // Ø±ØµÙŠØ¯ Ø«Ø§Ø¨Øª Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ù…Ù† Ø§Ù„ØµÙØ­Ø©
    // Ø¯ÙˆÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: Ø¥Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù„Ø§ ÙŠØ¨Ø¯Ø£ Ø¨ÙƒÙˆØ¯ Ø¯ÙˆÙ„Ø©ØŒ Ø³Ù†Ø¶ÙŠÙÙ‡
    // Ù…Ø«Ø§Ù„: Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª 971ØŒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© 966ØŒ Ø§Ù„ÙƒÙˆÙŠØª 965 ...
    const DEFAULT_COUNTRY_CODE = "971"; // Ø¹Ø¯Ù‘Ù„Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ø­ØªÙŠØ§Ø¬Ùƒ
    // ===============================

    // LocalStorage keys
    const LS_AUTH='krs_auth_event';
    const LS_GUESTS='krs_guests';
    const LS_MSG='krs_message_template';
    const LS_EVENT_NAME='krs_event_name';

    const getJSON=(k,fb)=>{ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(fb)) }catch{return fb} };
    const setJSON=(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)) }catch{} };

    // State
    let guests = getJSON(LS_GUESTS, []);
    let internalGuestIdCounter = guests.reduce((m,g)=>Math.max(m,g.internalId||0), 0);
    const fixedStock = DEFAULT_CARD_STOCK;

    // ========= Helpers =========
    function normalizePhone(raw){
      // ÙŠÙ‚Ø¨Ù„: +9715..., 9715..., 05..., 5...
      let p = String(raw||'').trim();
      p = p.replace(/[^\d+]/g,'');          // remove spaces, dashes
      p = p.replace(/^\+/, '');             // remove leading +
      // remove 00 prefix
      if(p.startsWith('00')) p = p.slice(2);

      // Ø¥Ø°Ø§ ÙŠØ¨Ø¯Ø£ Ø¨ØµÙØ± Ù…Ø­Ù„ÙŠ (Ù…Ø«Ù„ 05xxxx) Ù†Ø²ÙŠÙ„Ù‡
      if(p.startsWith('0')) p = p.replace(/^0+/, '');

      // Ø¥Ø°Ø§ Ù…Ø§ ÙŠØ¨Ø¯Ø£ Ø¨ÙƒÙˆØ¯ Ø¯ÙˆÙ„Ø© Ù…Ø¹Ø±ÙˆÙØŒ Ù†Ø¶ÙŠÙ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
      // Ù‚Ø§Ø¹Ø¯Ø© Ø¨Ø³ÙŠØ·Ø©: Ø¥Ø°Ø§ Ø·ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù… <= 10 ØºØ§Ù„Ø¨Ø§Ù‹ Ù…Ø­Ù„ÙŠ
      if(p.length <= 10){
        p = DEFAULT_COUNTRY_CODE + p;
      }
      return p;
    }

    function genCode(prefix="KRS"){
      const rnd = Math.random().toString(36).slice(2,8).toUpperCase();
      const ts  = Date.now().toString(36).toUpperCase().slice(-4);
      return `${prefix}-${rnd}-${ts}`;
    }

    function allocCodes(totalNeeded){
      // ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø¶Ù…Ù† Ø­Ø¯ Ø§Ù„Ø±ØµÙŠØ¯
      const used = guests.reduce((s,g)=>s + ((g.codes||[]).length), 0);
      const free = Math.max(fixedStock - used, 0);
      if(totalNeeded > free) return null;

      const codes = [];
      for(let i=0;i<totalNeeded;i++) codes.push(genCode("KRS"));
      return codes;
    }

    // ========= Auth =========
    function showAuth(){ document.getElementById('authGate').style.display='flex' }
    function hideAuth(){ document.getElementById('authGate').style.display='none' }

    function authLogin(){
      const name=document.getElementById('authEvent').value.trim();
      const pass=document.getElementById('authPass').value;
      const err=document.getElementById('authErr'); err.textContent='';
      if(name!==DEFAULT_EVENT || pass!==DEFAULT_PASS){ err.textContent='Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'; return }
      localStorage.setItem(LS_AUTH, JSON.stringify({event:DEFAULT_EVENT}));
      localStorage.setItem(LS_EVENT_NAME, DEFAULT_EVENT);
      document.getElementById('currentEvent').textContent = DEFAULT_EVENT;
      document.getElementById('eventName').value = DEFAULT_EVENT;
      hideAuth();
    }
    function logout(){ localStorage.removeItem(LS_AUTH); showAuth(); }

    // ========= Boot =========
    (function boot(){
      try{
        const s=JSON.parse(localStorage.getItem(LS_AUTH)||'null');
        if(!s?.event){ showAuth(); }
        else { document.getElementById('currentEvent').textContent = s.event; }

        document.getElementById('eventName').value = localStorage.getItem(LS_EVENT_NAME) || DEFAULT_EVENT;

        const savedMsg = localStorage.getItem(LS_MSG);
        if (savedMsg && document.getElementById('messageTemplate')) document.getElementById('messageTemplate').value = savedMsg;

        document.getElementById('kpiStock').textContent = fixedStock;
      }catch{ showAuth() }

      renderGuestTable();
      updateKPIs();
      refreshStockKPIs();
      document.getElementById('guestCount').textContent=guests.length;
    })();

    // ========= Tabs =========
    document.querySelectorAll('#tabs .tab').forEach(tab=>{
      tab.addEventListener('click',()=>{
        document.querySelectorAll('#tabs .tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const id=tab.dataset.section;
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        document.querySelector(id).classList.add('active');
      });
    });

    function persistAll(){
      setJSON(LS_GUESTS, guests);
      const msgEl=document.getElementById('messageTemplate');
      if(msgEl) localStorage.setItem(LS_MSG, msgEl.value||'');
      const ev=document.getElementById('eventName')?.value||'';
      if(ev) localStorage.setItem(LS_EVENT_NAME, ev);
    }

    // ========= JSON Export/Import =========
    function exportJSON(){
      const payload = {
        version: 1,
        eventName: document.getElementById('eventName').value || DEFAULT_EVENT,
        fixedStock,
        guests,
        internalGuestIdCounter,
        messageTemplate: document.getElementById('messageTemplate')?.value || ''
      };
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      saveAs(blob, `KRS_INVITE_${payload.eventName||'event'}_${Date.now()}.json`);
    }

    function importJSONFile(file){
      if(!file) return;
      const r=new FileReader();
      r.onload=(e)=>{
        try{
          const data=JSON.parse(e.target.result);
          guests = Array.isArray(data.guests)? data.guests: [];
          internalGuestIdCounter = data.internalGuestIdCounter || guests.reduce((m,g)=>Math.max(m,g.internalId||0),0);
          document.getElementById('eventName').value = data.eventName || DEFAULT_EVENT;
          document.getElementById('currentEvent').textContent = data.eventName || DEFAULT_EVENT;
          if (data.messageTemplate && document.getElementById('messageTemplate')) document.getElementById('messageTemplate').value = data.messageTemplate;

          renderGuestTable(); updateKPIs(); refreshStockKPIs(); persistAll();
          alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.');
        }catch{ alert('Ù…Ù„Ù JSON ØºÙŠØ± ØµØ§Ù„Ø­') }
      };
      r.readAsText(file);
    }

    // ========= Import Guests =========
    function handleFileUpload(){
      const f=document.getElementById('guestListUpload').files[0];
      if(!f){ alert('Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§'); return }
      const ext=f.name.split('.').pop().toLowerCase();
      if(ext==='csv') readCSV(f);
      else if(['xlsx','xls'].includes(ext)) readExcel(f);
      else alert('Ø§Ø³ØªØ®Ø¯Ù… CSV Ø£Ùˆ XLSX')
    }

    function readCSV(file){
      Papa.parse(file,{ header:true, skipEmptyLines:true,
        complete:(res)=>processImportedData(res.data),
        error:(e)=>alert('CSV Ø®Ø·Ø£: '+e.message)
      })
    }

    function readExcel(file){
      const r=new FileReader();
      r.onload=(e)=>{
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const arr=XLSX.utils.sheet_to_json(ws);
        processImportedData(arr)
      };
      r.readAsArrayBuffer(file)
    }

    function processImportedData(data){
      const required=['name','phone','totalNeeded'];
      if(!data.length||!required.every(f=>Object.keys(data[0]).some(k=>k.toLowerCase()===f))){
        alert('Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: name, phone, totalNeeded'); return
      }

      let added=0;
      data.forEach(row=>{
        const get=(f)=>{ const k=Object.keys(row).find(x=>x.toLowerCase()===f); return k? row[k]:'' };
        const name=String(get('name')).trim();
        const phoneRaw=String(get('phone')).trim();
        const phone=normalizePhone(phoneRaw);
        const total=Math.max(1, parseInt(get('totalneeded'))||1);
        if(!name||!phone) return;

        if(guests.some(x=>normalizePhone(x.phone)===phone)) return;

        // ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯ Ø¶Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
        const codes = allocCodes(total);
        if(!codes){ return; }

        internalGuestIdCounter++;
        guests.push({ internalId:internalGuestIdCounter, name, phone, totalNeeded:total, codes, status:'new' });
        added++;
      });

      persistAll();
      renderGuestTable(); updateKPIs(); refreshStockKPIs();
      document.getElementById('guestCount').textContent=guests.length;
      alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${added} Ø¶ÙŠÙ Ø¬Ø¯ÙŠØ¯. (Ù…Ø¹ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…ÙƒØ±Ø±/Ø§Ù„Ø°ÙŠ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø±ØµÙŠØ¯)`);
    }

    async function importFromContacts(){
      try{
        if (!('contacts' in navigator) || !('select' in navigator.contacts)){
          alert('Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ù‡Ù†Ø§. Ø§Ø³ØªØ®Ø¯Ù… Chrome Ø¹Ù„Ù‰ Android Ù…Ø¹ HTTPS.');
          return;
        }
        const picked = await navigator.contacts.select(['name','tel'], { multiple:true });
        if (!picked || !picked.length){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„'); return; }

        let added=0;
        for(const c of picked){
          const name=(c.name && c.name[0])||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
          const phoneRaw=(c.tel && c.tel[0])||'';
          const phone=normalizePhone(phoneRaw);
          if(!phone) continue;
          if(guests.some(x=>normalizePhone(x.phone)===phone)) continue;

          const codes = allocCodes(1);
          if(!codes) continue;

          internalGuestIdCounter++;
          guests.push({ internalId:internalGuestIdCounter, name, phone, totalNeeded:1, codes, status:'new' });
          added++;
        }

        persistAll();
        renderGuestTable(); updateKPIs(); refreshStockKPIs();
        alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${added} Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„.`);
      }catch(e){
        console.error(e);
        alert('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„.');
      }
    }

    function addGuestManually(){
      const n=document.getElementById('newGuestName').value.trim();
      const pRaw=document.getElementById('newGuestPhone').value.trim();
      const p=normalizePhone(pRaw);
      const c=Math.max(1, parseInt(document.getElementById('newGuestTotalNeeded').value)||1);
      if(!n||!p){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‡Ø§ØªÙ'); return }

      if(guests.some(x=>normalizePhone(x.phone)===p)){ alert('Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹'); return }

      const codes = allocCodes(c);
      if(!codes){ alert('Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª'); return }

      internalGuestIdCounter++;
      guests.push({ internalId:internalGuestIdCounter, name:n, phone:p, totalNeeded:c, codes, status:'new' });
      persistAll();
      renderGuestTable(); updateKPIs(); refreshStockKPIs();

      document.getElementById('newGuestName').value='';
      document.getElementById('newGuestPhone').value='';
      document.getElementById('newGuestTotalNeeded').value='1';
      document.getElementById('guestCount').textContent=guests.length;
    }

    // ========= Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯Ø¹ÙˆØ© PNG / ZIP =========
    async function makeCardDataURL({ guestName, code }){
      // Canvas 1080x1080 â€” ØºÙŠÙ‘Ø± Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ø®Ù„ÙÙŠØ© Ø¬Ø§Ù‡Ø²Ø©
      const canvas = document.createElement('canvas');
      canvas.width = 1080; canvas.height = 1080;
      const ctx = canvas.getContext('2d');

      // Ø®Ù„ÙÙŠØ© ÙØ®Ù…Ø© (ØªØ¯Ø±Ø¬ Ø¨Ø³ÙŠØ·) â€” Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨ØµÙˆØ±Ø© ØªØµÙ…ÙŠÙ…Ùƒ Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ
      const g = ctx.createLinearGradient(0,0,1080,1080);
      g.addColorStop(0, '#0b0b0c');
      g.addColorStop(1, '#1a1b20');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,1080,1080);

      // Ø¥Ø·Ø§Ø± Ø°Ù‡Ø¨ÙŠ
      ctx.strokeStyle = '#d4af37';
      ctx.lineWidth = 10;
      ctx.strokeRect(40,40,1000,1000);

      // Ø¹Ù†ÙˆØ§Ù†
      ctx.fillStyle = '#d4af37';
      ctx.font = "900 54px 'Noto Sans Arabic', Arial";
      ctx.textAlign = 'center';
      ctx.fillText('KRS INVITE', 540, 130);

      // Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ
      ctx.fillStyle = '#ffffff';
      ctx.font = "900 60px 'Noto Sans Arabic', Arial";
      ctx.fillText(guestName, 540, 260);

      // QR
      const qrCanvas = document.createElement('canvas');
      await QRCode.toCanvas(qrCanvas, code, { width: 360, margin: 1 });
      ctx.drawImage(qrCanvas, 360, 360, 360, 360);

      // Ø§Ù„ÙƒÙˆØ¯ Ù†Øµ
      ctx.fillStyle = '#ffe8a3';
      ctx.font = "800 34px Arial";
      ctx.fillText(code, 540, 770);

      // Ù…Ù„Ø§Ø­Ø¸Ø©
      ctx.fillStyle = '#a7a7a7';
      ctx.font = "700 28px 'Noto Sans Arabic', Arial";
      ctx.fillText('ÙŠØ±Ø¬Ù‰ Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„ÙƒÙˆØ¯ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„', 540, 840);

      return canvas.toDataURL('image/png');
    }

    async function downloadInviteCards(guest){
      const codes = (guest.codes||[]);
      if(!codes.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯'); return; }

      if(codes.length===1){
        const dataUrl = await makeCardDataURL({ guestName: guest.name, code: codes[0] });
        const a=document.createElement('a');
        a.href=dataUrl;
        a.download=`${guest.name}_${codes[0]}.png`;
        document.body.appendChild(a); a.click(); a.remove();
        return;
      }

      const zip = new JSZip();
      for(const code of codes){
        const dataUrl = await makeCardDataURL({ guestName: guest.name, code });
        const base64 = dataUrl.split(',')[1];
        zip.file(`${guest.name}_${code}.png`, base64, {base64:true});
      }
      const blob = await zip.generateAsync({type:'blob'});
      saveAs(blob, `${guest.name}_${codes.length}_Cards.zip`);
    }

    // ========= WhatsApp Fix (iOS) =========
    function buildWhatsAppLinks(phone, text){
      const cleanPhone = String(phone||'').replace(/[^\d]/g,''); // digits only
      const encoded = encodeURIComponent(text||'');
      // universal (works in most cases)
      const waMe = `https://wa.me/${cleanPhone}?text=${encoded}`;
      // iOS deep link fallback
      const waApp = `whatsapp://send?phone=${cleanPhone}&text=${encoded}`;
      return { waMe, waApp };
    }

    function openWhatsApp(phone, text){
      const { waMe, waApp } = buildWhatsAppLinks(phone, text);

      // Try app scheme first (iOS)
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      if(isIOS){
        // Attempt deep link
        window.location.href = waApp;
        // Fallback after short delay
        setTimeout(()=>{ window.open(waMe, '_blank'); }, 600);
      }else{
        window.open(waMe, '_blank');
      }
    }

    function sendWhatsAppMessage(guest){
      if(!(guest.codes||[]).length){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ¯ Ù„Ù„Ø¶ÙŠÙ'); return }
      const msgEl=document.getElementById('messageTemplate');
      let txt= msgEl? msgEl.value : `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${guest.name}`;
      txt=txt.replace(/#\{\{GUEST_NAME\}\}#/g, guest.name)
             .replace(/#\{\{TOTAL_COUNT\}\}#/g, guest.totalNeeded);

      openWhatsApp(guest.phone, txt);

      guest.status='sent';
      persistAll(); updateKPIs(); renderGuestTable();
    }

    function sendAllWhatsApp(){
      if(!guests.length){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¶ÙŠÙˆÙ'); return }
      if(!confirm('Ø³ÙŠØªÙ… ÙØªØ­ Ø¹Ø¯Ø© Ù†ÙˆØ§ÙØ° ÙˆØ§ØªØ³Ø§Ø¨. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;

      const template=document.getElementById('messageTemplate')?.value||'';
      let delay=0;
      guests.forEach((guest)=>{
        const txt=template.replace(/#\{\{GUEST_NAME\}\}#/g,guest.name)
                          .replace(/#\{\{TOTAL_COUNT\}\}#/g,guest.totalNeeded);

        setTimeout(()=>{
          openWhatsApp(guest.phone, txt);
          guest.status='sent';
          persistAll(); updateKPIs(); renderGuestTable();
        }, delay);

        delay += 1400;
      });
    }

    // ========= Edit / Delete =========
    function editTotalNeeded(id){
      const g=guests.find(x=>x.internalId===id); if(!g) return;
      const s=prompt(`Ø¹Ø¯Ø¯ Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${g.name}:`, g.totalNeeded);
      if(s===null||s.trim()==='') return;
      const n=parseInt(s); if(isNaN(n)||n<1){ alert('Ø¹Ø¯Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­'); return }

      // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
      const old = (g.codes||[]).length;
      if(n === old){ g.totalNeeded=n; persistAll(); renderGuestTable(); refreshStockKPIs(); return; }

      if(n > old){
        const extra = n - old;
        const used = guests.reduce((sum,gg)=>sum + ((gg.codes||[]).length), 0);
        const free = Math.max(fixedStock - used, 0);
        if(extra > free){ alert('Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ'); return; }
        for(let i=0;i<extra;i++) g.codes.push(genCode("KRS"));
      }else{
        g.codes = g.codes.slice(0, n);
      }

      g.totalNeeded = n;
      persistAll(); renderGuestTable(); refreshStockKPIs();
    }

    function editGuestDetails(id, field){
      const g=guests.find(x=>x.internalId===id); if(!g) return;
      const s=prompt(field==='name'?`Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${g.name}:`:`Ù‡Ø§ØªÙ Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${g.name}:`, g[field]);
      if(s===null||s.trim()==='') return;

      if(field==='phone'){
        const np = normalizePhone(s.trim());
        if(guests.some(x=>x.internalId!==id && normalizePhone(x.phone)===np)){ alert('Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¶ÙŠÙ Ø¢Ø®Ø±'); return; }
        g.phone = np;
      }else{
        g.name = s.trim();
      }
      persistAll(); renderGuestTable();
    }

    function deleteGuest(id){
      if(!confirm('Ø­Ø°Ù Ø§Ù„Ø¶ÙŠÙØŸ')) return;
      guests = guests.filter(g=>g.internalId!==id);
      persistAll(); renderGuestTable(); updateKPIs(); refreshStockKPIs();
    }

    // ========= KPIs =========
    function updateKPIs(){
      const total=guests.length;
      const sent=guests.filter(g=>g.status==='sent').length;
      const remain=Math.max(total - sent, 0);
      document.getElementById('kpiTotal').textContent=total;
      document.getElementById('kpiSent').textContent=sent;
      document.getElementById('kpiRemain').textContent=remain;
    }

    function refreshStockKPIs(){
      const used = guests.reduce((s,g)=>s + ((g.codes||[]).length), 0);
      const free = Math.max(fixedStock - used, 0);
      document.getElementById('kpiStock').textContent = fixedStock;
      document.getElementById('kpiUsedCards').textContent = used;
      document.getElementById('kpiFreeCards').textContent = free;
    }

    // ========= Render Table =========
    function renderGuestTable(){
      const body=document.getElementById('guestTableBody'); if(!body) return;
      body.innerHTML='';
      document.getElementById('guestCount').textContent=guests.length;

      guests.forEach(guest=>{
        const tr=document.createElement('tr');

        const tdName=document.createElement('td');
        tdName.setAttribute('data-label','Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ');
        tdName.innerHTML=`<span class="editable" onclick="editGuestDetails(${guest.internalId||0}, 'name')">${guest.name||''}</span>`;
        tr.appendChild(tdName);

        const tdCount=document.createElement('td');
        tdCount.setAttribute('data-label','Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª');
        tdCount.innerHTML=`<span class="editable" onclick="editTotalNeeded(${guest.internalId||0})">${guest.totalNeeded||0}</span>`;
        tr.appendChild(tdCount);

        const tdPhone=document.createElement('td');
        tdPhone.setAttribute('data-label','Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ');
        tdPhone.innerHTML=`<span class="editable" onclick="editGuestDetails(${guest.internalId||0}, 'phone')">${guest.phone||''}</span>`;
        tr.appendChild(tdPhone);

        const tdCodes=document.createElement('td');
        tdCodes.setAttribute('data-label','Ø§Ù„Ø£ÙƒÙˆØ§Ø¯');
        tdCodes.textContent = (guest.codes||[]).join(', ') || 'â€”';
        tdCodes.style.fontWeight='800';
        tdCodes.style.color = '#b7ffc8';
        tr.appendChild(tdCodes);

        const tdStatus=document.createElement('td');
        tdStatus.setAttribute('data-label','Ø§Ù„Ø­Ø§Ù„Ø©');
        tdStatus.textContent = guest.status==='sent'? 'Ù…ÙØ±Ø³Ù„Ø©' : 'Ø¬Ø¯ÙŠØ¯Ø©';
        tr.appendChild(tdStatus);

        const tdAct=document.createElement('td'); tdAct.className='actions'; tdAct.style.textAlign='left';
        tdAct.setAttribute('data-label','Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª');

        const bPNG=document.createElement('button');
        bPNG.className='btn block';
        bPNG.textContent = guest.totalNeeded===1 ? 'ğŸ« ØªÙ†Ø²ÙŠÙ„ PNG' : 'ğŸ« ØªÙ†Ø²ÙŠÙ„ ZIP';
        bPNG.onclick=()=>downloadInviteCards(guest);

        const bWA=document.createElement('button');
        bWA.className='btn ok block';
        bWA.textContent='ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨';
        bWA.onclick=()=>sendWhatsAppMessage(guest);

        const bDel=document.createElement('button');
        bDel.className='btn warn block';
        bDel.textContent='ğŸ—‘ï¸ Ø­Ø°Ù';
        bDel.onclick=()=>deleteGuest(guest.internalId);

        [bPNG,bWA,bDel].forEach(b=>{ b.style.marginTop='8px'; tdAct.appendChild(b) });
        tr.appendChild(tdAct);

        body.appendChild(tr);
      });

      updateKPIs();
      refreshStockKPIs();
      persistAll();
    }

    // Ø­ÙØ¸ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    (function bindMsgAutoSave(){
      const el=document.getElementById('messageTemplate');
      if(!el) return;
      el.addEventListener('input', ()=>{ localStorage.setItem(LS_MSG, el.value||''); });
    })();
  </script>
</body>
</html>
