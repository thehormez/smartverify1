<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>KRS INVITE — RSVP Dashboard</title>
  <style>
    :root{
      --bg0:#06080f; --bg1:#0a0f1d;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --ink:#e9edf5; --muted:#a7b0c3;
      --gold:#d6b15e; --gold2:#b48a18;
      --green:#16a34a; --red:#ef4444; --amber:#f59e0b; --blue:#2563eb;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --r:18px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(214,177,94,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(37,99,235,.10), transparent 60%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
    }
    .wrap{max-width:1240px;margin:0 auto;padding:18px}
    .top{
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;
      justify-content:space-between;margin-bottom:12px
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg,#111827,#0b1220);
      border:1px solid rgba(214,177,94,.35);
      display:grid;place-items:center;box-shadow:var(--shadow)
    }
    .logo span{font-weight:900;color:var(--gold)}
    h1{font-size:16px;margin:0;font-weight:900;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:1.1fr .9fr}
    .grid-3{grid-template-columns:repeat(5,1fr)}
    @media(max-width:1100px){.grid-2{grid-template-columns:1fr}.grid-3{grid-template-columns:repeat(2,1fr)}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--stroke2);
      background:rgba(0,0,0,.18);
      color:var(--muted);font-size:12px
    }
    .input,.btn,select{
      border-radius:14px;border:1px solid var(--stroke2);
      background:rgba(0,0,0,.25);color:var(--ink);
      padding:10px 12px;font-size:13px;outline:none
    }
    .input{min-width:260px}
    .btn{cursor:pointer}
    .btn:hover{background:rgba(0,0,0,.34)}
    .btn.gold{
      border-color:rgba(214,177,94,.45);
      background:linear-gradient(180deg, rgba(214,177,94,.18), rgba(0,0,0,.25));
    }
    .kpi{
      display:flex;flex-direction:column;gap:6px;
      padding:12px;border-radius:16px;
      border:1px solid var(--stroke2);
      background:rgba(0,0,0,.20)
    }
    .kpi .n{font-size:26px;font-weight:900;line-height:1}
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi.green .n{color:rgba(34,197,94,.95)}
    .kpi.red .n{color:rgba(239,68,68,.95)}
    .kpi.amb .n{color:rgba(245,158,11,.95)}
    .kpi.blue .n{color:rgba(37,99,235,.95)}
    .tableWrap{overflow:auto;border-radius:16px;border:1px solid var(--stroke);background:rgba(0,0,0,.18)}
    table{width:100%;border-collapse:collapse;min-width:960px}
    thead th{
      text-align:right;font-size:12px;color:var(--muted);
      padding:12px;border-bottom:1px solid var(--stroke);
      background:rgba(0,0,0,.20)
    }
    tbody td{
      padding:12px;border-bottom:1px solid rgba(255,255,255,.06);
      font-size:13px;vertical-align:middle
    }
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--stroke2);font-size:12px
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--amber)}
    .tag.pending .dot{background:var(--amber)}
    .tag.confirmed .dot{background:var(--green)}
    .tag.declined .dot{background:var(--red)}
    .tag.yes .dot{background:var(--green)}
    .tag.no .dot{background:rgba(148,163,184,.9)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .mini{
      padding:8px 10px;border-radius:14px;font-size:12px;
      border:1px solid var(--stroke2);background:rgba(0,0,0,.25);color:var(--ink);
      cursor:pointer
    }
    .mini:hover{background:rgba(0,0,0,.34)}
    .mini.ok{border-color:rgba(34,197,94,.35)}
    .mini.no{border-color:rgba(239,68,68,.35)}
    .mini.ci{border-color:rgba(214,177,94,.35)}
    .muted{color:var(--muted)}
    .rightInfo{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .printOnly{display:none}
    @media print{
      body{background:#fff;color:#111}
      .noPrint{display:none !important}
      .printOnly{display:block}
      .card{box-shadow:none;border:1px solid #ddd;background:#fff}
      .tableWrap{border:1px solid #ddd;background:#fff}
      thead th{background:#f5f5f5;color:#333}
      tbody td{border-bottom:1px solid #eee}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"><span>KRS</span></div>
        <div>
          <h1>لوحة RSVP + تقرير نهائي — KRS INVITE</h1>
          <div class="sub">Confirmed / Declined / Pending + Check-in yes/no (Firestore: invites)</div>
        </div>
      </div>

      <div class="row noPrint">
        <span class="pill" id="pillConn">Database: Firestore</span>
        <input id="eventName" class="input" value="zafaf_khaled" placeholder="EventName مثل: zafaf_khaled" />
        <input id="q" class="input" placeholder="بحث بالكود / الاسم / الرقم" />
        <button id="btnLoad" class="btn gold">تحميل البيانات</button>
        <button id="btnPrint" class="btn">تقرير للطباعة</button>
      </div>
    </div>

    <div class="grid grid-2">
      <div class="card">
        <div class="rightInfo">
          <div class="pill">Event: <b id="evLabel">—</b></div>
          <div class="pill muted">آخر تحديث: <span id="lastAt">—</span></div>
        </div>

        <div class="grid grid-3" style="margin-top:12px">
          <div class="kpi blue"><div class="n" id="kTotal">0</div><div class="t">Total Invites</div></div>
          <div class="kpi amb"><div class="n" id="kPending">0</div><div class="t">Pending</div></div>
          <div class="kpi green"><div class="n" id="kConfirmed">0</div><div class="t">Confirmed</div></div>
          <div class="kpi red"><div class="n" id="kDeclined">0</div><div class="t">Declined</div></div>
          <div class="kpi"><div class="n" id="kCheckin">0</div><div class="t">Check-in YES</div></div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800;margin-bottom:8px">ملاحظات تشغيل</div>
        <div class="muted" style="font-size:13px;line-height:1.8">
          ✅ يعتمد على حقول داخل <b>invites</b>:<br/>
          <b>Code (doc id)</b>, <b>EventName</b>, <b>GuestName</b>, <b>Phone</b>, <b>RSVP</b>, <b>CheckIn</b><br/><br/>
          إذا كان Guest/Phone يظهر “—” فهذا يعني الدوكومنت ما فيه البيانات — والكود اللي فوق صار يكتبها تلقائيًا عند الإرسال.
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div style="font-weight:900">قائمة الضيوف</div>
        <div class="pill muted">النتائج: <span id="count">0</span></div>
      </div>

      <div class="tableWrap" style="margin-top:12px">
        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Guest</th>
              <th>Phone</th>
              <th>EventName</th>
              <th>RSVP</th>
              <th>Check-in</th>
              <th>Actions</th>
              <th class="noPrint">Times</th>
            </tr>
          </thead>
          <tbody id="tb"></tbody>
        </table>
      </div>
    </div>

    <div class="card printOnly" style="margin-top:12px">
      <div style="font-weight:900;font-size:18px">KRS INVITE — Final Report</div>
      <div class="muted" style="margin-top:6px">Event: <span id="printEvent">—</span> • Generated: <span id="printAt">—</span></div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    // ✅ ضع Firebase config لمشروعك (hormez-inv)
    const firebaseConfig = {
      apiKey: "AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
      authDomain: "hormez-inv.firebaseapp.com",
      projectId: "hormez-inv",
      storageBucket: "hormez-inv.firebasestorage.app",
      messagingSenderId: "747519941805",
      appId: "1:747519941805:web:468fada2492700e9da3a24"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const $ = (s)=>document.querySelector(s);
    const tb = $("#tb");

    let allRows = [];
    let unsub = null;

    function nowStr(){
      const d = new Date();
      return d.toLocaleString("ar-AE");
    }

    function norm(s){ return String(s||"").toLowerCase().trim(); }

    function tagRSVP(v){
      const x = norm(v);
      if(x==="confirmed") return `<span class="tag confirmed"><span class="dot"></span>Confirmed</span>`;
      if(x==="declined") return `<span class="tag declined"><span class="dot"></span>Declined</span>`;
      return `<span class="tag pending"><span class="dot"></span>Pending</span>`;
    }

    function tagCheck(v){
      const x = norm(v);
      if(x==="yes") return `<span class="tag yes"><span class="dot"></span>YES</span>`;
      return `<span class="tag no"><span class="dot"></span>NO</span>`;
    }

    function calcKPIs(rows){
      const total = rows.length;
      let pending=0, confirmed=0, declined=0, checkin=0;
      for(const r of rows){
        const rr = norm(r.RSVP);
        if(rr==="confirmed") confirmed++;
        else if(rr==="declined") declined++;
        else pending++;

        if(norm(r.CheckIn)==="yes") checkin++;
      }
      $("#kTotal").textContent = total;
      $("#kPending").textContent = pending;
      $("#kConfirmed").textContent = confirmed;
      $("#kDeclined").textContent = declined;
      $("#kCheckin").textContent = checkin;
      $("#count").textContent = total;
      $("#lastAt").textContent = nowStr();
      $("#printAt").textContent = nowStr();
      $("#printEvent").textContent = $("#eventName").value.trim();
    }

    async function setRSVP(code, val){
      await db.collection("invites").doc(code).set({ RSVP: val, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    }
    async function toggleCheckIn(code, toYes){
      await db.collection("invites").doc(code).set({ CheckIn: toYes ? "yes" : "no", Status: toYes ? "yes" : "no", checkInAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    }

    function render(rows){
      // filter by query
      const q = norm($("#q").value);
      const filtered = !q ? rows : rows.filter(r=>{
        return norm(r.Code).includes(q) || norm(r.GuestName).includes(q) || norm(r.Phone).includes(q);
      });

      tb.innerHTML = filtered.map(r=>{
        const code = r.Code || "—";
        const guest = r.GuestName || r.Name || "—";
        const phone = r.Phone || "—";
        const ev = r.EventName || "—";
        const rsvp = r.RSVP || "pending";
        const ci = r.CheckIn || r.Status || "no";

        const times = [
          r.RSVPAt ? ("RSVP: " + r.RSVPAt) : "",
          r.checkInAt ? ("Check-in: " + r.checkInAt) : ""
        ].filter(Boolean).join(" • ") || "—";

        return `
          <tr>
            <td><b>${code}</b></td>
            <td>${guest}</td>
            <td>${phone}</td>
            <td class="muted">${ev}</td>
            <td>${tagRSVP(rsvp)}</td>
            <td>${tagCheck(ci)}</td>
            <td>
              <div class="actions noPrint">
                <button class="mini ok" onclick="window.__setRSVP('${code}','confirmed')">تأكيد</button>
                <button class="mini no" onclick="window.__setRSVP('${code}','declined')">اعتذار</button>
                <button class="mini ci" onclick="window.__toggleCI('${code}', true)">تسجيل دخول</button>
                <button class="mini" onclick="window.__toggleCI('${code}', false)">إلغاء دخول</button>
              </div>
            </td>
            <td class="noPrint muted">${times}</td>
          </tr>
        `;
      }).join("");

      calcKPIs(filtered);
    }

    window.__setRSVP = async (code,val)=>{ try{ await setRSVP(code,val); }catch(e){ alert("خطأ: "+e.message); } };
    window.__toggleCI = async (code,toYes)=>{ try{ await toggleCheckIn(code,toYes); }catch(e){ alert("خطأ: "+e.message); } };

    function load(){
      const ev = $("#eventName").value.trim();
      $("#evLabel").textContent = ev || "—";
      if(unsub) unsub();

      // realtime
      unsub = db.collection("invites").where("EventName","==", ev).onSnapshot((snap)=>{
        allRows = snap.docs.map(d=>{
          const x = d.data() || {};
          // Convert timestamps to readable text (optional)
          const conv = (t)=> t && t.toDate ? t.toDate().toLocaleString("ar-AE") : null;
          return {
            ...x,
            Code: x.Code || d.id,
            RSVPAt: conv(x.RSVPAt),
            checkInAt: conv(x.checkInAt),
          };
        }).sort((a,b)=> (a.Code||"").localeCompare(b.Code||"", "en"));
        render(allRows);
      }, (err)=>{
        alert("فشل تحميل البيانات: " + err.message);
      });
    }

    $("#btnLoad").addEventListener("click", load);
    $("#q").addEventListener("input", ()=>render(allRows));
    $("#btnPrint").addEventListener("click", ()=>window.print());

    // auto load
    load();
  </script>
</body>
</html>
