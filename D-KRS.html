<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KRS INVITE â€” Dashboard + Final Report</title>

  <style>
    :root{
      --bg0:#050711; --bg1:#0a1020;
      --ink:#eef2ff; --muted:#a7b0c3;
      --card:rgba(255,255,255,.07);
      --card2:rgba(255,255,255,.045);
      --stroke:rgba(255,255,255,.11);
      --stroke2:rgba(255,255,255,.16);
      --gold:#d6b15e; --gold2:#b48a18;
      --blue:#1e40af; --rose:#be123c; --green:#047857;
      --shadow:0 20px 70px rgba(0,0,0,.50);
      --shadow2:0 14px 45px rgba(0,0,0,.30);
      --r20:20px; --r24:24px;
      --focus:0 0 0 4px rgba(214,177,94,.14);
    }

    [data-theme="light"]{
      --bg0:#f8fafc; --bg1:#eef2ff;
      --ink:#0b1220; --muted:#475569;
      --card:rgba(0,0,0,.05);
      --card2:rgba(0,0,0,.035);
      --stroke:rgba(0,0,0,.12);
      --stroke2:rgba(0,0,0,.16);
      --shadow:0 20px 70px rgba(2,6,23,.14);
      --shadow2:0 14px 45px rgba(2,6,23,.10);
      --focus:0 0 0 4px rgba(180,138,24,.16);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;
      background:
        radial-gradient(1200px 700px at 18% 6%, rgba(214,177,94,.18), transparent 55%),
        radial-gradient(900px 500px at 82% 15%, rgba(30,64,175,.14), transparent 60%),
        radial-gradient(900px 500px at 70% 92%, rgba(190,18,60,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .container{max-width:1120px;margin:0 auto;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .topbar{
      position:sticky;top:0;z-index:30;
      background: rgba(6,8,15,.70);
      border-bottom:1px solid var(--stroke);
      backdrop-filter: blur(12px);
    }
    [data-theme="light"] .topbar{background: rgba(248,250,252,.75)}

    .brand{display:flex;align-items:center;gap:12px}
    .logoWrap{
      width:46px;height:46px;border-radius:18px;
      border:1px solid rgba(214,177,94,.35);
      background:
        radial-gradient(12px 12px at 28% 30%, rgba(255,255,255,.22), transparent 55%),
        linear-gradient(145deg, rgba(214,177,94,.28), rgba(180,138,24,.10));
      box-shadow: 0 12px 34px rgba(0,0,0,.28);
      display:grid;place-items:center;position:relative;overflow:hidden;
    }
    .logoWrap:after{
      content:"";
      position:absolute; inset:-40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
      transform: rotate(25deg);
      animation: sheen 6.5s linear infinite;
      pointer-events:none;
    }
    @keyframes sheen{
      0%{transform:translateX(-32%) rotate(25deg)}
      100%{transform:translateX(32%) rotate(25deg)}
    }

    .logoImg{width:34px;height:34px;object-fit:contain;border-radius:999px;display:none}
    .logoFallback{font-weight:1100;letter-spacing:.8px;color:#1b1405;background:linear-gradient(180deg,#1b1405,#000);-webkit-background-clip:text;background-clip:text;color:transparent;font-size:12px}

    .hdrOrg{color:var(--muted);font-size:12px;letter-spacing:.8px}
    .hdrTitle{font-weight:1100;font-size:15px}
    .hdrSub{color:var(--muted);font-size:12px;margin-top:3px}

    .actions{margin-inline-start:auto;display:flex;gap:8px;flex-wrap:wrap}

    .btn{
      appearance:none;border:1px solid var(--stroke2);
      background:rgba(255,255,255,.06);
      color:var(--ink);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      min-height:42px;
      font-size:14px;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.09);border-color:rgba(214,177,94,.32);transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(214,177,94,.34), rgba(180,138,24,.12));
      border-color: rgba(214,177,94,.40);
    }

    .select,.input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      color:var(--ink);
      min-height:44px;
      font-size:14px;
      outline:none;
      transition: border-color .12s ease, background .12s ease, box-shadow .12s ease;
    }
    .select:focus,.input:focus{
      border-color: rgba(214,177,94,.46);
      background: rgba(255,255,255,.08);
      box-shadow: var(--focus);
    }

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r24);
      padding:14px;
      box-shadow: var(--shadow2);
    }
    .card.soft{background:var(--card2)}
    .muted{color:var(--muted);font-size:12px}
    .titleMini{font-weight:1100;font-size:12px;letter-spacing:.35px;color:var(--muted);margin-bottom:8px}

    .grid{display:grid;gap:12px}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    .grid-4{grid-template-columns:repeat(4,1fr)}
    .grid-2{grid-template-columns:1.1fr .9fr}
    @media(max-width:920px){.grid-3{grid-template-columns:1fr}.grid-4{grid-template-columns:1fr 1fr}.grid-2{grid-template-columns:1fr}}
    @media(max-width:560px){.grid-4{grid-template-columns:1fr}.container{padding:12px}}

    .kpi{
      position:relative; overflow:hidden;
      border:none;
      border-radius: var(--r24);
      padding:14px;
      min-height:98px;
      display:flex; flex-direction:column; justify-content:space-between;
      color:#fff;
      box-shadow: var(--shadow);
    }
    .kpi .t{font-weight:1100;font-size:12px;letter-spacing:.4px;opacity:.95}
    .kpi .n{font-size:28px;font-weight:1200}
    .kpi:before{
      content:"";
      position:absolute; inset:-65%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), transparent 55%);
      transform: rotate(15deg);
      pointer-events:none;
    }
    .kpi.blue{background:linear-gradient(135deg, rgba(30,64,175,1), rgba(30,64,175,.55))}
    .kpi.gold{background:linear-gradient(135deg, rgba(214,177,94,1), rgba(180,138,24,.42)); color:#1b1405}
    .kpi.gold .t,.kpi.gold .n{color:#1b1405}
    .kpi.rose{background:linear-gradient(135deg, rgba(190,18,60,1), rgba(190,18,60,.45))}
    .kpi.green{background:linear-gradient(135deg, rgba(4,120,87,1), rgba(4,120,87,.45))}

    .tableWrap{
      border-radius: var(--r24);
      overflow:auto;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      max-height:60vh;
      margin-top:10px;
    }
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px;border-top:1px solid rgba(255,255,255,.08);font-size:14px}
    thead th{
      position:sticky;top:0;
      background: rgba(255,255,255,.06);
      border-bottom:1px solid var(--stroke);
      font-weight:1100;
      text-align:start;
      backdrop-filter: blur(8px);
    }
    tbody tr:hover td{background: rgba(214,177,94,.06)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    .badge{
      padding:6px 10px;border-radius:999px;
      font-weight:1100;font-size:12px;
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
    }
    .badge.ok{border-color:rgba(34,197,94,.25);background:rgba(34,197,94,.10);color:rgba(34,197,94,.95)}
    .badge.no{border-color:rgba(244,63,94,.25);background:rgba(244,63,94,.10);color:rgba(244,63,94,.95)}

    .insGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:640px){.insGrid{grid-template-columns:1fr}}
    .insItem{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius: var(--r20);
      padding:12px;
    }
    .insK{font-size:12px;color:var(--muted);font-weight:1100}
    .insV{margin-top:6px;font-weight:1200}

    .hintPill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    /* Print dashboard (not report) */
    @media print{
      *{-webkit-print-color-adjust:exact !important; print-color-adjust:exact !important;}
      body{background:#fff;color:#000}
      .topbar,.noPrint{display:none !important}
      .card,.tableWrap{background:#fff;border:1px solid #ddd;box-shadow:none}
      thead th{background:#f5f5f5;color:#111}
      tbody td{color:#111}
    }

    .hiddenCanvases{position:absolute;left:-99999px;top:-99999px;opacity:0;pointer-events:none}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="container row">
      <div class="brand">
        <div class="logoWrap">
          <img id="logoImg" class="logoImg" alt="Logo" />
          <div id="logoFallback" class="logoFallback">KRS</div>
        </div>
        <div>
          <div class="hdrOrg" id="hdrOrg">KRS INVITE</div>
          <div class="hdrTitle"><span id="hdrMain">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” </span><span id="hdrEvent">â€”</span></div>
          <div class="hdrSub" id="hdrSub">Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª â€¢ Live attendance & status</div>
        </div>
      </div>

      <div class="actions noPrint">
        <span class="hintPill" id="printHint">ğŸ–¨ï¸ ÙØ¹Ù‘Ù„ (Print Backgrounds) Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù†</span>
        <button id="themeBtn" class="btn">ğŸŒ“</button>
        <button id="langBtn" class="btn">AR</button>
        <button id="refreshBtn" class="btn">â†» <span id="refreshTxt">ØªØ­Ø¯ÙŠØ«</span></button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="grid grid-3" style="margin-top:14px">
      <div class="card soft">
        <div class="titleMini" id="lblEvent">Ø§Ù„Ø­Ø¯Ø«</div>
        <select id="eventSelect" class="select"></select>
      </div>

      <div class="card soft">
        <div class="titleMini" id="lblSearch">Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯â€¦</div>
        <input id="searchInput" class="input" placeholder="KH_001" />
      </div>

      <div class="card soft noPrint" style="display:flex;align-items:end;gap:10px">
        <button id="exportBtn" class="btn primary" style="flex:1">â¤“ ØªØµØ¯ÙŠØ± CSV</button>
        <button id="printBtn" class="btn" style="flex:1">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        <button id="reportBtn" class="btn primary" style="flex:1">ğŸ“„ ØªÙ‚Ø±ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ ÙØ§Ø®Ø±</button>
      </div>
    </div>

    <div class="card soft" style="margin-top:12px">
      <div class="row" style="align-items:end">
        <div style="flex:1;min-width:200px">
          <div class="titleMini" id="lblFrom">Ù…Ù† ØªØ§Ø±ÙŠØ®</div>
          <input id="dateFrom" type="date" class="input" />
        </div>
        <div style="flex:1;min-width:200px">
          <div class="titleMini" id="lblTo">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</div>
          <input id="dateTo" type="date" class="input" />
        </div>
        <div class="noPrint" style="display:flex;gap:8px;align-items:end">
          <button id="applyDate" class="btn primary">ØªØ·Ø¨ÙŠÙ‚</button>
          <button id="clearDate" class="btn">Ù…Ø³Ø­</button>
        </div>
        <div id="activeFilter" class="hintPill" style="margin-inline-start:auto;display:none"></div>
      </div>
    </div>

    <div class="grid grid-4" style="margin-top:12px">
      <div class="kpi blue"><div class="t" id="kpiTotalLbl">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div><div id="kpiTotal" class="n">â€”</div></div>
      <div class="kpi gold"><div class="t" id="kpiUsedLbl">Ø§Ù„Ø­Ø¶ÙˆØ±</div><div id="kpiUsed" class="n">â€”</div></div>
      <div class="kpi rose"><div class="t" id="kpiLeftLbl">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div><div id="kpiLeft" class="n">â€”</div></div>
      <div class="kpi green"><div class="t" id="kpiRateLbl">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div><div id="kpiRate" class="n">â€”%</div></div>
    </div>

    <div class="grid grid-2" style="margin-top:12px">
      <div class="card soft">
        <div class="titleMini" id="insTitle">Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© ÙŠØ­Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ´ÙˆÙÙ‡Ø§</div>
        <div class="insGrid">
          <div class="insItem"><div class="insK" id="insFirstK">Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„</div><div class="insV" id="insFirstV">â€”</div></div>
          <div class="insItem"><div class="insK" id="insLastK">Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„</div><div class="insV" id="insLastV">â€”</div></div>
          <div class="insItem"><div class="insK" id="insPeakK">Ø£ÙƒØ«Ø± Ø³Ø§Ø¹Ø© Ø§Ø²Ø¯Ø­Ø§Ù…</div><div class="insV" id="insPeakV">â€”</div></div>
          <div class="insItem"><div class="insK" id="insTodayK">Ù…Ø³Ø­Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div><div class="insV" id="insTodayV">â€”</div></div>
        </div>
        <div class="muted" id="insNote" style="margin-top:10px;line-height:1.7">
          * Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„ÙØ§Ø®Ø± ÙŠØ¹Ø·ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØµÙˆØ±Ø© ÙƒØ§Ù…Ù„Ø©: Ø§Ù„Ù†Ø³Ø¨Ø©ØŒ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ØŒ ÙˆØ£Ù‡Ù… Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ + Ø±Ø³ÙˆÙ… Ù…Ù„ÙˆÙ†Ø©.
        </div>
      </div>

      <div class="card soft">
        <div class="titleMini" id="recentLbl">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø­Ø§Øª (Ø¢Ø®Ø± 100)</div>
        <div id="printArea" class="tableWrap">
          <table>
            <thead>
              <tr>
                <th id="thCode">Ø§Ù„ÙƒÙˆØ¯</th>
                <th id="thStatus">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th id="thTime">Ø§Ù„ÙˆÙ‚Øª</th>
              </tr>
            </thead>
            <tbody id="rowsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="hiddenCanvases">
      <canvas id="donut" width="900" height="520"></canvas>
      <canvas id="bars" width="900" height="520"></canvas>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    /* ========= Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø´Ø¹Ø§Ø± KRS INVITE (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ========= */
    const LOGO_URL = ""; // Ù…Ø«Ø§Ù„: "https://.../krs-invite.png"

    /* ========= i18n ========= */
    const STR = {
      en: {
        org:"KRS INVITE",
        hdrMain:"Dashboard â€” ",
        hdrSub:"Live attendance & invitation status",
        hint:"Enable Print Backgrounds for colors",
        event:"Event",
        search:"Search codeâ€¦",
        export:"Export CSV",
        print:"Print",
        report:"Final Luxury Report",
        total:"Total",
        used:"Attendance",
        left:"Remaining",
        rate:"Attendance rate",
        recent:"Recent scans (latest 100)",
        code:"Code",
        status:"Status",
        time:"Time",
        all:"All events",
        refresh:"Refresh",
        from:"From",
        to:"To",
        apply:"Apply",
        clear:"Clear",
        yes:"Checked-in",
        no:"Not yet",
        noRows:"No scans yet",
        insights:"Client-friendly insights",
        first:"First check-in",
        last:"Last check-in",
        peak:"Peak hour",
        today:"Today scans",
        filterActive:(f,t)=>`Filter: ${f||'â€”'} â†’ ${t||'â€”'}`,
        note:"* Final report includes KPIs + luxury charts + executive summary."
      },
      ar: {
        org:"KRS INVITE",
        hdrMain:"Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” ",
        hdrSub:"Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª â€¢ Live attendance & status",
        hint:"ğŸ–¨ï¸ ÙØ¹Ù‘Ù„ (Print Backgrounds) Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù†",
        event:"Ø§Ù„Ø­Ø¯Ø«",
        search:"Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒÙˆØ¯â€¦",
        export:"ØªØµØ¯ÙŠØ± CSV",
        print:"Ø·Ø¨Ø§Ø¹Ø©",
        report:"ØªÙ‚Ø±ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ ÙØ§Ø®Ø±",
        total:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
        used:"Ø§Ù„Ø­Ø¶ÙˆØ±",
        left:"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ",
        rate:"Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±",
        recent:"Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø³Ø­Ø§Øª (Ø¢Ø®Ø± 100)",
        code:"Ø§Ù„ÙƒÙˆØ¯",
        status:"Ø§Ù„Ø­Ø§Ù„Ø©",
        time:"Ø§Ù„ÙˆÙ‚Øª",
        all:"ÙƒÙ„ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª",
        refresh:"ØªØ­Ø¯ÙŠØ«",
        from:"Ù…Ù† ØªØ§Ø±ÙŠØ®",
        to:"Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®",
        apply:"ØªØ·Ø¨ÙŠÙ‚",
        clear:"Ù…Ø³Ø­",
        yes:"ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„",
        no:"Ù„Ù… ÙŠØ¯Ø®Ù„",
        noRows:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø­Ø§Øª",
        insights:"Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© ÙŠØ­Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ´ÙˆÙÙ‡Ø§",
        first:"Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„",
        last:"Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„",
        peak:"Ø£ÙƒØ«Ø± Ø³Ø§Ø¹Ø© Ø§Ø²Ø¯Ø­Ø§Ù…",
        today:"Ù…Ø³Ø­Ø§Øª Ø§Ù„ÙŠÙˆÙ…",
        filterActive:(f,t)=>`ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙÙ„ØªØ±: ${f||'â€”'} â†’ ${t||'â€”'}`,
        note:"* Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙŠØ­ØªÙˆÙŠ KPI + Ø±Ø³ÙˆÙ… ÙØ§Ø®Ø±Ø© + Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ."
      }
    };

    const $ = (s,root=document)=>root.querySelector(s);
    const state = {
      lang: localStorage.getItem('krs:dash:lang') || 'ar',
      theme: localStorage.getItem('krs:dash:theme') || 'dark',
      event: localStorage.getItem('krs:dash:event') || '',
      from:'', to:''
    };

    function setTheme(t){
      state.theme=t;
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('krs:dash:theme', t);
    }

    function applyLogo(){
      const img = $('#logoImg');
      const fb  = $('#logoFallback');
      if(LOGO_URL){
        img.src = LOGO_URL;
        img.style.display='block';
        fb.style.display='none';
      }else{
        img.style.display='none';
        fb.style.display='block';
      }
    }

    function applyLang(){
      const L = STR[state.lang] || STR.en;
      const isAr = state.lang==='ar';

      document.documentElement.lang = state.lang;
      document.documentElement.dir  = isAr ? 'rtl' : 'ltr';

      $('#hdrOrg').textContent = L.org;
      $('#hdrMain').textContent = L.hdrMain;
      $('#hdrSub').textContent = L.hdrSub;
      $('#printHint').textContent = L.hint;

      $('#langBtn').textContent = isAr ? 'EN' : 'AR';
      $('#refreshTxt').textContent = L.refresh;

      $('#lblEvent').textContent = L.event;
      $('#lblSearch').textContent = L.search;

      $('#exportBtn').textContent = 'â¤“ ' + L.export;
      $('#printBtn').textContent  = 'ğŸ–¨ï¸ ' + L.print;
      $('#reportBtn').textContent = 'ğŸ“„ ' + L.report;

      $('#lblFrom').textContent = L.from;
      $('#lblTo').textContent   = L.to;
      $('#applyDate').textContent = L.apply;
      $('#clearDate').textContent = L.clear;

      $('#kpiTotalLbl').textContent = L.total;
      $('#kpiUsedLbl').textContent  = L.used;
      $('#kpiLeftLbl').textContent  = L.left;
      $('#kpiRateLbl').textContent  = L.rate;

      $('#recentLbl').textContent = L.recent;
      $('#thCode').textContent    = L.code;
      $('#thStatus').textContent  = L.status;
      $('#thTime').textContent    = L.time;

      $('#insTitle').textContent  = L.insights;
      $('#insFirstK').textContent = L.first;
      $('#insLastK').textContent  = L.last;
      $('#insPeakK').textContent  = L.peak;
      $('#insTodayK').textContent = L.today;
      $('#insNote').textContent   = L.note;

      renderActiveFilter();
    }

    /* ========= Firebase ========= */
    const firebaseConfig = {
      apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
      authDomain:"hormez-inv.firebaseapp.com",
      projectId:"hormez-inv",
      storageBucket:"hormez-inv.firebasestorage.app",
      messagingSenderId:"747519941805",
      appId:"1:747519941805:web:468fada2492700e9da3a24"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ========= Data ========= */
    let unsub=null, rowsAll=[], rowsView=[];
    // rowsAll = only records that have scannedAt (for insights/report tables)
    // KPIs computed from full snapshot (total/used)

    async function loadEvents(){
      const ref = collection(db,'invites');
      const snap = await getDocs(query(ref, limit(1200)));

      const setE = new Set();
      snap.forEach(d=>{
        const ev = d.data().EventName || '';
        if(ev) setE.add(ev);
      });

      const list = ['__ALL__', ...Array.from(setE).sort((a,b)=>a.localeCompare(b))];
      const sel = $('#eventSelect');
      sel.innerHTML='';

      for(const ev of list){
        const opt = document.createElement('option');
        opt.value = ev;
        opt.textContent = (ev==='__ALL__') ? (STR[state.lang].all) : ev;
        sel.appendChild(opt);
      }

      sel.value = (state.event && list.includes(state.event)) ? state.event : '__ALL__';
      state.event = sel.value;
      localStorage.setItem('krs:dash:event', state.event);
      $('#hdrEvent').textContent = (state.event==='__ALL__') ? STR[state.lang].all : state.event;
    }

    function startStream(){
      if(unsub) unsub();

      const ref = collection(db,'invites');
      const qAll = (state.event && state.event!=='__ALL__')
        ? query(ref, where('EventName','==', state.event))
        : query(ref);

      unsub = onSnapshot(qAll, snap=>{
        let total=0, used=0;
        const rec=[];

        snap.forEach(d=>{
          const x=d.data();
          total++;
          if((x.Status||'').toLowerCase()==='yes') used++;

          if(x.scannedAt?.toDate?.()){
            rec.push({
              id:d.id,
              Code: x.Code || d.id,
              Status: String(x.Status || 'no'),
              scannedAt: x.scannedAt.toDate()
            });
          }
        });

        renderKPIs(total, used);

        rowsAll = rec.sort((a,b)=> (b.scannedAt?.getTime?.()||0) - (a.scannedAt?.getTime?.()||0));
        applyFilters();

        const ins = computeInsights(rowsAll);
        renderInsights(ins);
        drawCharts(total, used, rowsAll);
      });
    }

    function renderKPIs(total, used){
      const left = Math.max(total-used,0);
      const rate = total>0 ? Math.round((used/total)*100) : 0;

      $('#kpiTotal').textContent = total;
      $('#kpiUsed').textContent  = used;
      $('#kpiLeft').textContent  = left;
      $('#kpiRate').textContent  = rate + '%';
    }

    function withinDateRange(d){
      if(!d) return false;
      const ts = d.getTime();
      if(state.from){
        const fromTs = new Date(state.from+"T00:00:00").getTime();
        if(ts < fromTs) return false;
      }
      if(state.to){
        const toTs = new Date(state.to+"T23:59:59").getTime();
        if(ts > toTs) return false;
      }
      return true;
    }

    function applyFilters(){
      const q = ($('#searchInput').value || '').trim().toLowerCase();
      let list = rowsAll;

      if(state.from || state.to) list = list.filter(r=> withinDateRange(r.scannedAt));
      if(q) list = list.filter(r=> (r.Code||'').toLowerCase().includes(q));

      rowsView = list.slice(0,100);
      renderRows(rowsView);
      renderActiveFilter();
    }

    function renderActiveFilter(){
      const L = STR[state.lang] || STR.en;
      const box = $('#activeFilter');
      if(state.from || state.to){
        box.style.display = 'inline-flex';
        box.textContent = L.filterActive(state.from, state.to);
      }else{
        box.style.display = 'none';
        box.textContent = '';
      }
    }

    function renderRows(rows){
      const L = STR[state.lang] || STR.en;
      const isAr = state.lang==='ar';
      const tb = $('#rowsBody');
      tb.innerHTML='';

      if(rows.length===0){
        const tr=document.createElement('tr');
        const td=document.createElement('td');
        td.colSpan=3;
        td.className='muted';
        td.style.textAlign='center';
        td.style.padding='18px';
        td.textContent = L.noRows;
        tr.appendChild(td);
        tb.appendChild(tr);
        return;
      }

      for(const r of rows){
        const tr=document.createElement('tr');

        const td1=document.createElement('td');
        td1.className='mono';
        td1.textContent=r.Code;

        const td2=document.createElement('td');
        const b=document.createElement('span');
        const ok=(r.Status||'no').toLowerCase()==='yes';
        b.className='badge ' + (ok?'ok':'no');
        b.textContent = ok ? L.yes : L.no;
        td2.appendChild(b);

        const td3=document.createElement('td');
        td3.textContent = r.scannedAt ? r.scannedAt.toLocaleString(isAr?'ar-EG':'en-GB') : 'â€”';

        tr.append(td1,td2,td3);
        tb.appendChild(tr);
      }
    }

    function safeCSV(v){
      const s=String(v??'');
      if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    function exportCSV(){
      const L = STR[state.lang] || STR.en;
      const header=[L.code,L.status,'EventName',L.time].join(',');
      const evName = (state.event==='__ALL__') ? 'ALL' : state.event;

      const lines = rowsView.map(r=>[
        safeCSV(r.Code),
        safeCSV(r.Status),
        safeCSV(evName),
        safeCSV(r.scannedAt ? r.scannedAt.toISOString() : '')
      ].join(','));

      const csv=[header,...lines].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);

      const a=document.createElement('a');
      a.href=url;
      a.download=`krs-${evName}-scans.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function printDashboard(){ window.print(); }

    /* ========= Insights (SAFE) ========= */
    function fmtDate(d){
      if(!(d instanceof Date) || isNaN(d.getTime())) return 'â€”';
      return d.toLocaleString(state.lang==='ar'?'ar-EG':'en-GB');
    }

    function computeInsights(scans){
      const arr = (scans||[]).filter(r=>r.scannedAt instanceof Date && !isNaN(r.scannedAt.getTime()))
                             .sort((a,b)=>a.scannedAt-b.scannedAt);

      const first = arr[0]?.scannedAt || null;
      const last  = arr[arr.length-1]?.scannedAt || null;

      const byHour = new Map();
      for(const r of arr){
        const h = String(r.scannedAt.getHours()).padStart(2,'0');
        byHour.set(h, (byHour.get(h)||0)+1);
      }
      let peakHour='â€”', peakCount=0;
      for(const [h,c] of byHour.entries()){
        if(c>peakCount){ peakCount=c; peakHour=h; }
      }

      const start = new Date(); start.setHours(0,0,0,0);
      let today = 0;
      for(const r of arr){
        if(r.scannedAt >= start) today++;
      }

      return { first, last, peakHour, peakCount, today };
    }

    function renderInsights(ins){
      $('#insFirstV').textContent = fmtDate(ins.first);
      $('#insLastV').textContent  = fmtDate(ins.last);

      if(ins.peakHour==='â€”'){
        $('#insPeakV').textContent = 'â€”';
      }else{
        $('#insPeakV').textContent = (state.lang==='ar')
          ? `${ins.peakHour}:00 (Ø¹Ø¯Ø¯ ${ins.peakCount})`
          : `${ins.peakHour}:00 (count ${ins.peakCount})`;
      }

      $('#insTodayV').textContent = String(ins.today ?? 0);
    }

    /* ========= Charts (Canvas) ========= */
    function roundRect(ctx, x, y, w, h, r, fill, stroke){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
      if(fill) ctx.fill();
      if(stroke) ctx.stroke();
    }

    function drawDonut(total, used){
      const c = document.getElementById('donut');
      const ctx = c.getContext('2d');
      const W=c.width, H=c.height;
      ctx.clearRect(0,0,W,H);

      const left = Math.max(total-used,0);
      const rate = total>0 ? Math.round((used/total)*100) : 0;

      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,W,H);

      ctx.fillStyle = '#0b1220';
      ctx.font = '900 28px system-ui';
      ctx.textAlign = 'start';
      ctx.fillText(state.lang==='ar' ? 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø¶ÙˆØ±' : 'Attendance Distribution', 52, 70);

      ctx.fillStyle = '#475569';
      ctx.font = '700 14px system-ui';
      ctx.fillText(state.lang==='ar' ? 'Ø­Ø¶ÙˆØ± / Ù…ØªØ¨Ù‚ÙŠ' : 'Checked-in / Remaining', 52, 98);

      const cx = W*0.32, cy = H*0.58;
      const rOuter = 170, rInner = 105;

      const totalVal = Math.max(total, 1);
      const usedAng = (used/totalVal) * Math.PI*2;

      const start = -Math.PI/2;
      const end = start + usedAng;

      ctx.beginPath();
      ctx.arc(cx, cy, rOuter, 0, Math.PI*2);
      ctx.arc(cx, cy, rInner, Math.PI*2, 0, true);
      ctx.closePath();
      ctx.fillStyle = '#eef2f7';
      ctx.fill();

      ctx.beginPath();
      ctx.arc(cx, cy, rOuter, start, end);
      ctx.arc(cx, cy, rInner, end, start, true);
      ctx.closePath();
      ctx.fillStyle = '#d6b15e';
      ctx.fill();

      ctx.beginPath();
      ctx.arc(cx, cy, rOuter, end, start + Math.PI*2);
      ctx.arc(cx, cy, rInner, start + Math.PI*2, end, true);
      ctx.closePath();
      ctx.fillStyle = '#1e40af';
      ctx.globalAlpha = 0.22;
      ctx.fill();
      ctx.globalAlpha = 1;

      ctx.fillStyle = '#0b1220';
      ctx.font = '1000 44px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText(rate + '%', cx, cy+12);

      ctx.fillStyle = '#475569';
      ctx.font = '800 14px system-ui';
      ctx.fillText(state.lang==='ar' ? 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±' : 'Attendance', cx, cy+44);

      const bx = W*0.62, by = H*0.28;
      const boxW = W*0.33, boxH = 90, gap=16;
      const L = STR[state.lang] || STR.en;

      function kpiBox(y, title, val, color){
        ctx.fillStyle = 'rgba(2,6,23,.08)';
        roundRect(ctx, bx+4, y+4, boxW, boxH, 18, true, false);

        ctx.fillStyle = '#ffffff';
        roundRect(ctx, bx, y, boxW, boxH, 18, true, false);

        ctx.strokeStyle = 'rgba(15,23,42,.10)';
        ctx.lineWidth = 2;
        roundRect(ctx, bx, y, boxW, boxH, 18, false, true);

        ctx.fillStyle = color;
        roundRect(ctx, bx+14, y+18, 10, boxH-36, 10, true, false);

        ctx.fillStyle = '#475569';
        ctx.font = '900 14px system-ui';
        ctx.textAlign = 'start';
        ctx.fillText(title, bx+34, y+36);

        ctx.fillStyle = '#0b1220';
        ctx.font = '1000 30px system-ui';
        ctx.fillText(val, bx+34, y+70);
      }

      kpiBox(by, L.total, String(total), '#1e40af');
      kpiBox(by + boxH + gap, L.used, String(used), '#d6b15e');
      kpiBox(by + (boxH + gap)*2, L.left, String(left), '#be123c');

      ctx.save();
      ctx.globalAlpha = 0.06;
      ctx.translate(W*0.78, H*0.86);
      ctx.rotate(-0.22);
      ctx.fillStyle = '#0b1220';
      ctx.font = '1100 44px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText('KRS INVITE', 0, 0);
      ctx.restore();
    }

    function drawBars(scans){
      const c = document.getElementById('bars');
      const ctx = c.getContext('2d');
      const W=c.width, H=c.height;
      ctx.clearRect(0,0,W,H);

      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,W,H);

      ctx.fillStyle = '#0b1220';
      ctx.font = '900 28px system-ui';
      ctx.textAlign = 'start';
      ctx.fillText(state.lang==='ar' ? 'Ù†Ø´Ø§Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Check-in Activity', 52, 70);

      ctx.fillStyle = '#475569';
      ctx.font = '700 14px system-ui';
      ctx.fillText(state.lang==='ar' ? 'Ø¢Ø®Ø± 60 Ø¯Ù‚ÙŠÙ‚Ø© (ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚)' : 'Last 60 minutes (5-min bins)', 52, 98);

      const now = new Date();
      const bins = Array(12).fill(0);
      const start = new Date(now.getTime() - 60*60*1000);

      for(const r of (scans||[])){
        if(!(r.scannedAt instanceof Date)) continue;
        const t = r.scannedAt.getTime();
        if(t < start.getTime() || t > now.getTime()) continue;

        const minsAgo = Math.floor((now.getTime() - t)/60000);
        const idx = Math.max(0, Math.min(11, Math.floor((59 - minsAgo)/5)));
        bins[idx] += 1;
      }

      const maxV = Math.max(1, ...bins);
      const chartX=52, chartY=150, chartW=W-104, chartH=300;

      ctx.fillStyle = 'rgba(2,6,23,.04)';
      roundRect(ctx, chartX, chartY, chartW, chartH, 22, true, false);

      ctx.strokeStyle = 'rgba(15,23,42,.10)';
      ctx.lineWidth = 1;
      for(let i=0;i<=4;i++){
        const y = chartY + (chartH*(i/4));
        ctx.beginPath(); ctx.moveTo(chartX+20, y); ctx.lineTo(chartX+chartW-20, y); ctx.stroke();
      }

      const pad=18;
      const innerX = chartX + 20;
      const innerY = chartY + 18;
      const innerW = chartW - 40;
      const innerH = chartH - 36;

      const barW = innerW / 12;

      for(let i=0;i<12;i++){
        const v = bins[i];
        const h = Math.round((v/maxV)*innerH);
        const x = innerX + i*barW + pad*0.25;
        const y = innerY + (innerH - h);
        const w = barW - pad*0.5;

        const t = v/maxV;
        const color = t>0.55 ? '#d6b15e' : '#1e40af';
        const alpha = t>0.55 ? 0.95 : 0.35 + t*0.5;

        ctx.fillStyle = color;
        ctx.globalAlpha = alpha;
        roundRect(ctx, x, y, w, h, 14, true, false);
        ctx.globalAlpha = 1;

        ctx.fillStyle = '#0b1220';
        ctx.font = '900 13px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText(String(v), x + w/2, y - 8);
      }

      ctx.fillStyle = '#475569';
      ctx.font = '800 12px system-ui';
      ctx.textAlign = 'center';
      for(let i=0;i<=12;i+=3){
        const mins = 60 - i*5;
        const lbl = state.lang==='ar' ? `-${mins}Ø¯` : `-${mins}m`;
        const x = innerX + i*barW;
        ctx.fillText(lbl, x, chartY + chartH + 34);
      }

      ctx.save();
      ctx.globalAlpha = 0.06;
      ctx.translate(W*0.78, H*0.86);
      ctx.rotate(-0.22);
      ctx.fillStyle = '#0b1220';
      ctx.font = '1100 44px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText('KRS INVITE', 0, 0);
      ctx.restore();
    }

    function drawCharts(total, used, scans){
      drawDonut(total, used);
      drawBars(scans);
    }

    function canvasToImg(id){
      try{
        const c = document.getElementById(id);
        if(!c) return '';
        return c.toDataURL('image/png');
      }catch(e){
        return '';
      }
    }

    /* ========= Final Report (NO external dependencies / no errors) ========= */
    function buildFinalReportHTML(payload){
      const {
        lang, logoUrl,
        eventName, total, used, left, rate,
        firstStr, lastStr, peakStr, todayStr,
        donutImg, barImg,
        createdStr, filterStr
      } = payload;

      const isAr = lang==='ar';
      const reportTitle = isAr ? 'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„ÙØ¹Ø§Ù„ÙŠØ©' : 'Final Event Report';

      const css = `
        *{box-sizing:border-box;-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;background:#fff;color:#0b1220}
        .page{max-width:1040px;margin:0 auto;padding:22px}
        .cover{
          border:1px solid #e5e7eb;border-radius:28px;padding:22px;
          box-shadow:0 18px 55px rgba(2,6,23,.12);
          background:
            radial-gradient(950px 300px at 10% 0%, rgba(214,177,94,.22), transparent 60%),
            radial-gradient(900px 280px at 88% 60%, rgba(30,64,175,.12), transparent 62%),
            radial-gradient(900px 280px at 72% 100%, rgba(190,18,60,.10), transparent 62%),
            #fff;
          position:relative;overflow:hidden;
        }
        .wm{
          position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;
          opacity:.06;transform:rotate(-12deg);font-weight:1000;font-size:74px;letter-spacing:1px;
        }
        .top{display:flex;justify-content:space-between;gap:14px;align-items:flex-start;flex-wrap:wrap}
        .brand{display:flex;gap:12px;align-items:center}
        .logo{width:66px;height:66px;border-radius:20px;border:1px solid #e5e7eb;display:grid;place-items:center;overflow:hidden;background:#fff;box-shadow:0 12px 30px rgba(2,6,23,.10)}
        .logo img{width:52px;height:52px;object-fit:contain}
        h1{margin:0;font-size:20px;font-weight:1000}
        .sub{margin-top:6px;color:#475569;font-size:12px;line-height:1.7}
        .pillRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
        .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;border:1px solid #e5e7eb;background:rgba(214,177,94,.12);font-weight:900;font-size:12px}
        .hero{margin-top:16px;display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
        @media(max-width:880px){.hero{grid-template-columns:1fr}}
        .card{border:1px solid #e5e7eb;border-radius:24px;padding:16px;background:#fff;box-shadow:0 14px 40px rgba(2,6,23,.08)}
        .card h2{margin:0 0 10px;font-size:14px;font-weight:1100}
        .big{
          font-size:56px;font-weight:1100;margin:6px 0 0;letter-spacing:.4px;
          background:linear-gradient(135deg,#d6b15e,#b48a18);-webkit-background-clip:text;background-clip:text;color:transparent;
        }
        .meta{margin-top:8px;color:#475569;font-size:12px;line-height:1.8}
        .exec{
          margin-top:12px;border:1px dashed rgba(180,138,24,.55);background:rgba(214,177,94,.10);
          border-radius:22px;padding:14px;line-height:1.85;font-size:12px;color:#111827
        }
        .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px}
        @media(max-width:880px){.kpis{grid-template-columns:1fr 1fr}}
        .kpi{border-radius:22px;padding:14px;color:#fff;box-shadow:0 16px 44px rgba(2,6,23,.14);min-height:98px;display:flex;flex-direction:column;justify-content:space-between;position:relative;overflow:hidden}
        .kpi:before{content:"";position:absolute;inset:-60%;background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), transparent 55%);transform:rotate(15deg)}
        .kpi .t{font-size:12px;font-weight:1000;opacity:.95}
        .kpi .n{font-size:30px;font-weight:1100}
        .blue{background:linear-gradient(135deg,#1e40af,rgba(30,64,175,.55))}
        .gold{background:linear-gradient(135deg,#d6b15e,rgba(180,138,24,.40));color:#1b1405}
        .gold .t,.gold .n{color:#1b1405}
        .rose{background:linear-gradient(135deg,#be123c,rgba(190,18,60,.45))}
        .green{background:linear-gradient(135deg,#047857,rgba(4,120,87,.45))}
        .section{margin-top:14px;border-radius:26px;border:1px solid #e5e7eb;padding:16px;background:#fff;box-shadow:0 14px 40px rgba(2,6,23,.08)}
        .section h3{margin:0 0 12px;font-size:14px;font-weight:1100}
        .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        @media(max-width:880px){.grid2{grid-template-columns:1fr}}
        .imgbox{border:1px solid #e5e7eb;border-radius:22px;padding:10px;background:#fff}
        .imgbox img{width:100%;height:auto;display:block;border-radius:16px}
        .ins{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        @media(max-width:640px){.ins{grid-template-columns:1fr}}
        .insItem{border:1px solid #e5e7eb;border-radius:20px;padding:12px;background:rgba(2,6,23,.02)}
        .k{font-size:12px;color:#475569;font-weight:1000}
        .v{margin-top:6px;font-weight:1100}
        .footer{margin-top:14px;border-radius:26px;border:1px solid #e5e7eb;padding:14px;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;background:rgba(2,6,23,.02);color:#475569;font-size:12px;line-height:1.7}
        .sign{display:flex;gap:10px;align-items:center}
        .line{width:220px;border-bottom:1px solid #94a3b8}
        @page { margin: 14mm; }
      `;

      const execText = isAr
        ? `Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª <b>${total}</b>ØŒ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ± <b>${used}</b>ØŒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ <b>${left}</b>ØŒ ÙˆÙ†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± <b>${rate}%</b>.`
        : `Executive summary: Total invites <b>${total}</b>, checked-in <b>${used}</b>, remaining <b>${left}</b>, attendance rate <b>${rate}%</b>.`;

      return `
<!doctype html>
<html lang="${lang}" dir="${isAr?'rtl':'ltr'}">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${reportTitle} â€” KRS INVITE</title>
<style>${css}</style></head>
<body>
  <div class="page">
    <div class="cover">
      <div class="wm">KRS INVITE</div>

      <div class="top">
        <div class="brand">
          <div class="logo">
            ${logoUrl ? `<img src="${logoUrl}" alt="logo">` : `<div style="font-weight:1100">KRS</div>`}
          </div>
          <div>
            <h1>${reportTitle} â€” <span style="color:#111827">${eventName}</span></h1>
            <div class="sub">
              <div><b>KRS INVITE</b> â€¢ ${isAr?'ØªÙ‚Ø±ÙŠØ± ÙØ§Ø®Ø± ÙˆÙ…Ù„ÙˆÙ‘Ù† Ù„Ù„Ø­Ø¶ÙˆØ±':'Luxury colored attendance report'}</div>
              <div>${isAr?'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡':'Created'}: <b>${createdStr}</b> â€¢ ${filterStr}</div>
            </div>
          </div>
        </div>

        <div class="pillRow">
          <div class="pill">âœ¨ KRS INVITE</div>
          <div class="pill">ğŸ–¨ï¸ ${isAr?'Ø§Ø·Ø¨Ø¹ Ù…Ø¹ Ø§Ù„Ø®Ù„ÙÙŠØ§Øª Ù„Ù„Ø£Ù„ÙˆØ§Ù†':'Print with backgrounds for colors'}</div>
        </div>
      </div>

      <div class="hero">
        <div class="card">
          <h2>${isAr?'Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ø­Ø¶ÙˆØ±':'Final Attendance Rate'}</h2>
          <div class="big">${rate}%</div>
          <div class="meta">
            <div>${isAr?'Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±':'Checked-in'}: <b>${used}</b> / ${isAr?'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ':'Total'}: <b>${total}</b></div>
            <div>${isAr?'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ':'Remaining'}: <b>${left}</b></div>
          </div>
          <div class="exec">${execText}</div>
        </div>

        <div class="card">
          <h2>${isAr?'Ù…Ø¤Ø´Ø±Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„':'Client Insights'}</h2>
          <div class="ins">
            <div class="insItem"><div class="k">${isAr?'Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„':'First check-in'}</div><div class="v">${firstStr}</div></div>
            <div class="insItem"><div class="k">${isAr?'Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„':'Last check-in'}</div><div class="v">${lastStr}</div></div>
            <div class="insItem"><div class="k">${isAr?'Ø£ÙƒØ«Ø± Ø³Ø§Ø¹Ø© Ø§Ø²Ø¯Ø­Ø§Ù…':'Peak hour'}</div><div class="v">${peakStr}</div></div>
            <div class="insItem"><div class="k">${isAr?'Ù…Ø³Ø­Ø§Øª Ø§Ù„ÙŠÙˆÙ…':'Today scans'}</div><div class="v">${todayStr}</div></div>
          </div>
          <div class="sub" style="margin-top:10px">${isAr?'Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø´ÙƒÙ„ ÙØ§Ø®Ø±.':'This page is client-ready for luxury print.'}</div>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi blue"><div class="t">${isAr?'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ':'Total'}</div><div class="n">${total}</div></div>
        <div class="kpi gold"><div class="t">${isAr?'Ø§Ù„Ø­Ø¶ÙˆØ±':'Checked-in'}</div><div class="n">${used}</div></div>
        <div class="kpi rose"><div class="t">${isAr?'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ':'Remaining'}</div><div class="n">${left}</div></div>
        <div class="kpi green"><div class="t">${isAr?'Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±':'Attendance'}</div><div class="n">${rate}%</div></div>
      </div>
    </div>

    <div class="section">
      <h3>${isAr?'Ø±Ø³ÙˆÙ… Ù…Ù„ÙˆÙ†Ø© ÙØ§Ø®Ø±Ø©':'Luxury Colored Charts'}</h3>
      <div class="grid2">
        <div class="imgbox">${donutImg ? `<img src="${donutImg}" alt="donut">` : '<div style="color:#475569">â€”</div>'}</div>
        <div class="imgbox">${barImg ? `<img src="${barImg}" alt="bars">` : '<div style="color:#475569">â€”</div>'}</div>
      </div>
      <div class="sub" style="margin-top:10px">${isAr?'Ø§Ù„Ø±Ø³ÙˆÙ… ØªØ¹Ø·ÙŠ ÙÙ‡Ù… Ø³Ø±ÙŠØ¹ Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆÙ†Ø´Ø§Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„.':'Charts give quick understanding of attendance and activity.'}</div>
    </div>

    <div class="footer">
      <div><b>KRS INVITE</b><br/>${isAr?'ØªÙ‚Ø±ÙŠØ± Ø±Ø³Ù…ÙŠ Ù„Ù„Ø­Ø¶ÙˆØ± Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯':'Official attendance report based on barcode system'}</div>
      <div class="sign"><div>${isAr?'Ø§Ù„ØªÙˆÙ‚ÙŠØ¹':'Signature'}</div><div class="line"></div></div>
    </div>
  </div>

  <script>
    window.addEventListener('load', ()=>{ setTimeout(()=>window.print(), 240); });
  </script>
</body>
</html>`;
    }

    function openFinalReport(){
      const total = Number(($('#kpiTotal').textContent||'0').replace(/[^\d]/g,''))||0;
      const used  = Number(($('#kpiUsed').textContent||'0').replace(/[^\d]/g,''))||0;
      const left  = Number(($('#kpiLeft').textContent||'0').replace(/[^\d]/g,''))||0;
      const rate  = total>0 ? Math.round((used/total)*100) : 0;

      const ins = computeInsights(rowsAll || []);

      // update charts then export images
      drawCharts(total, used, rowsAll || []);
      const donutImg = canvasToImg('donut');
      const barImg   = canvasToImg('bars');

      const isAr = state.lang==='ar';
      const createdStr = new Date().toLocaleString(isAr?'ar-EG':'en-GB');

      const filterStr = (state.from || state.to)
        ? (isAr ? `ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®: ${state.from||'â€”'} â†’ ${state.to||'â€”'}` : `Date filter: ${state.from||'â€”'} â†’ ${state.to||'â€”'}`)
        : (isAr ? 'Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ± ØªØ§Ø±ÙŠØ®' : 'No date filter');

      const firstStr = ins.first ? fmtDate(ins.first) : 'â€”';
      const lastStr  = ins.last  ? fmtDate(ins.last)  : 'â€”';
      const peakStr  = (ins.peakHour==='â€”')
        ? 'â€”'
        : (isAr ? `${ins.peakHour}:00 (Ø¹Ø¯Ø¯ ${ins.peakCount})` : `${ins.peakHour}:00 (count ${ins.peakCount})`);
      const todayStr = String(ins.today ?? 0);

      const eventName = (state.event && state.event!=='__ALL__')
        ? state.event
        : (STR[state.lang].all || 'ALL');

      const html = buildFinalReportHTML({
        lang: state.lang,
        logoUrl: LOGO_URL,
        eventName, total, used, left, rate,
        firstStr, lastStr, peakStr, todayStr,
        donutImg, barImg,
        createdStr, filterStr
      });

      const w = window.open('', '_blank');
      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    /* ========= Wire UI ========= */
    document.addEventListener('DOMContentLoaded', async ()=>{
      setTheme(state.theme);
      applyLogo();
      applyLang();

      await loadEvents();
      startStream();

      $('#themeBtn').addEventListener('click', ()=>{
        setTheme(state.theme==='dark' ? 'light' : 'dark');
      });

      $('#langBtn').addEventListener('click', ()=>{
        state.lang = state.lang==='ar' ? 'en' : 'ar';
        localStorage.setItem('krs:dash:lang', state.lang);
        applyLang();
        loadEvents().then(()=>startStream());
        applyFilters();
      });

      $('#refreshBtn').addEventListener('click', ()=> location.reload());

      $('#eventSelect').addEventListener('change', (e)=>{
        state.event = e.target.value;
        localStorage.setItem('krs:dash:event', state.event);
        $('#hdrEvent').textContent = (state.event==='__ALL__') ? STR[state.lang].all : state.event;
        startStream();
      });

      $('#searchInput').addEventListener('input', applyFilters);

      $('#exportBtn').addEventListener('click', exportCSV);
      $('#printBtn').addEventListener('click', printDashboard);

      $('#applyDate').addEventListener('click', ()=>{
        state.from = $('#dateFrom').value || '';
        state.to   = $('#dateTo').value || '';
        applyFilters();
      });

      $('#clearDate').addEventListener('click', ()=>{
        state.from=''; state.to='';
        $('#dateFrom').value=''; $('#dateTo').value='';
        applyFilters();
      });

      $('#reportBtn').addEventListener('click', openFinalReport);
    });
  </script>
</body>
</html>
