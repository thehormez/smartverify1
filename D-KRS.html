<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KRS INVITE â€” Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</title>

  <style>
    :root{
      --bg1:#070A12;
      --bg2:#0B1020;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);
      --ink:#E9EEF7;
      --muted:#A8B3C6;

      --gold1:#F7D37A;
      --gold2:#CFA24A;
      --gold3:#8E6A2B;

      --good:#39d98a;
      --warn:#ffce4a;
      --bad:#ff5c7a;

      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 28px;

      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans Arabic", "Tahoma", Arial, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --g: linear-gradient(135deg, rgba(247,211,122,.18), rgba(207,162,74,.08), rgba(255,255,255,.02));
      --g2: linear-gradient(135deg, rgba(247,211,122,.26), rgba(207,162,74,.12), rgba(255,255,255,.03));
      --glow: 0 0 0 1px rgba(247,211,122,.08), 0 0 60px rgba(247,211,122,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 80% -10%, rgba(247,211,122,.20), transparent 60%),
        radial-gradient(900px 520px at 20% 0%, rgba(90,120,255,.12), transparent 55%),
        radial-gradient(900px 520px at 60% 110%, rgba(255,92,122,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    a{color:inherit}
    .wrap{
      width:min(1200px, 94vw);
      margin: 28px auto 60px;
    }

    /* Top header */
    .topbar{
      display:flex;
      gap:14px;
      align-items:stretch;
      justify-content:space-between;
      margin-bottom:18px;
    }
    .brandCard{
      flex:1;
      padding:18px 18px 16px;
      border-radius: var(--radius2);
      background: var(--g);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .brandCard:before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(600px 140px at 70% 0%, rgba(247,211,122,.35), transparent 60%),
        radial-gradient(500px 260px at 15% 110%, rgba(120,180,255,.18), transparent 65%);
      pointer-events:none;
      opacity:.8;
    }
    .brandRow{
      position:relative;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
    }
    .brandLeft{
      display:flex;
      align-items:center;
      gap:14px;
      min-width: 260px;
    }
    .logo{
      width:56px;height:56px;border-radius:18px;
      background: linear-gradient(135deg, rgba(247,211,122,.34), rgba(207,162,74,.16), rgba(255,255,255,.04));
      border: 1px solid rgba(247,211,122,.22);
      box-shadow: var(--glow);
      position:relative;
      display:grid; place-items:center;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(32px 32px at 30% 35%, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(80px 60px at 70% 80%, rgba(247,211,122,.18), transparent 60%);
      pointer-events:none;
    }
    .logo span{
      font-weight:900;
      letter-spacing:.6px;
      color:var(--gold1);
      text-shadow: 0 10px 25px rgba(0,0,0,.35);
      font-size:18px;
      position:relative;
    }
    .brandTitle{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .brandTitle h1{
      margin:0;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .brandTitle p{
      margin:0;
      color: var(--muted);
      font-size: 12.5px;
      line-height:1.3;
    }

    .brandRight{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      min-width: 260px;
    }
    .btn{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:800;
      font-size: 13px;
      display:flex;
      gap:8px;
      align-items:center;
      transition:.18s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); }
    .btn:active{ transform: translateY(0px); }
    .btn.primary{
      border-color: rgba(247,211,122,.30);
      background: linear-gradient(135deg, rgba(247,211,122,.26), rgba(207,162,74,.10));
      box-shadow: var(--glow);
    }
    .pill{
      padding:8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 12px;
      font-weight:800;
    }
    .pill strong{color:var(--ink)}
    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(247,211,122,.22), rgba(255,255,255,.10), transparent);
      margin: 14px 0 0;
      opacity:.9;
    }

    /* Summary grid */
    .grid{
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brandRight{justify-content:flex-start}
      .brandLeft{min-width:auto}
      .brandRight{min-width:auto}
    }

    .card{
      border-radius: var(--radius2);
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card .head{
      padding:16px 16px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(135deg, rgba(255,255,255,.05), rgba(247,211,122,.06));
    }
    .card .head h2{
      margin:0;
      font-size: 14.5px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .card .head p{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 12.5px;
      line-height:1.35;
    }
    .card .body{ padding:16px; }

    /* KPI cards */
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){ .kpis{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .kpis{grid-template-columns: 1fr;} }

    .kpi{
      border-radius: 18px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.10);
      padding: 14px;
      position:relative;
      overflow:hidden;
      min-height: 92px;
    }
    .kpi:before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(260px 140px at 10% 10%, rgba(247,211,122,.18), transparent 60%),
        radial-gradient(200px 120px at 90% 70%, rgba(120,180,255,.12), transparent 60%);
      opacity:.8;
      pointer-events:none;
    }
    .kpi .t{ position:relative; color:var(--muted); font-size:12px; font-weight:900; }
    .kpi .v{ position:relative; margin-top:8px; font-size:22px; font-weight:1000; letter-spacing:.2px; }
    .kpi .s{ position:relative; margin-top:6px; font-size:12px; color:var(--muted); }
    .kpi .badge{
      position:absolute; inset:auto 10px 10px auto;
      border-radius:999px;
      padding:6px 10px;
      font-size: 11px;
      font-weight:1000;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--ink);
    }
    .b-good{ border-color: rgba(57,217,138,.30)!important; background: rgba(57,217,138,.10)!important; }
    .b-warn{ border-color: rgba(255,206,74,.30)!important; background: rgba(255,206,74,.10)!important; }
    .b-bad{  border-color: rgba(255,92,122,.30)!important; background: rgba(255,92,122,.10)!important; }

    /* Charts */
    .charts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){ .charts{grid-template-columns:1fr;} }

    .chartBox{
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      padding: 14px;
      overflow:hidden;
    }
    .chartTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .chartTop .title{
      font-weight: 1000;
      font-size: 12.5px;
      color: var(--ink);
    }
    .chartTop .meta{
      font-weight: 900;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    canvas{ width:100%; height: 240px; display:block; }

    /* Details table */
    .tableWrap{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: rgba(0,0,0,.16);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size: 12.5px;
    }
    thead th{
      background: rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.10);
      text-align:start;
      padding: 12px 10px;
      font-weight: 1000;
      color: var(--ink);
    }
    tbody td{
      padding: 11px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      color: var(--ink);
      vertical-align:top;
    }
    tbody tr:hover{ background: rgba(255,255,255,.04); }
    .mono{ font-family: var(--mono); letter-spacing: .2px; }
    .tag{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:1000;
      font-size: 11px;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--muted);display:inline-block}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    /* Notes */
    .notes{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){ .notes{grid-template-columns:1fr;} }
    .note{
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      padding: 14px;
    }
    .note h3{ margin:0; font-size: 12.5px; font-weight:1000; }
    .note p{ margin:10px 0 0; color: var(--muted); font-size: 12.5px; line-height:1.5; }
    ul{ margin:10px 0 0; padding:0 18px; color: var(--muted); font-size: 12.5px; line-height:1.6; }
    li{ margin:6px 0; }

    /* Footer */
    .footer{
      margin-top: 14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
    }
    .footLeft{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .stamp{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(247,211,122,.22);
      background: rgba(247,211,122,.10);
      color: var(--gold1);
      font-weight:1000;
    }

    /* Print */
    @media print{
      body{
        background:white !important;
        color:#111 !important;
      }
      .btn, .pill, #langToggle, #printBtn, #exportBtn { display:none !important; }
      .wrap{ width: 100% !important; margin: 0 !important; }
      .card, .brandCard{
        box-shadow:none !important;
        border: 1px solid #ddd !important;
        background: white !important;
      }
      .kpi, .chartBox, .note{
        background: white !important;
        border: 1px solid #e6e6e6 !important;
      }
      thead th{ background: #f5f5f5 !important; color:#111 !important; }
      tbody td{ color:#111 !important; }
      .brandTitle p, .kpi .t, .kpi .s, .note p, ul, .footer{ color:#444 !important; }
      .stamp{ color:#111 !important; background:#f3f3f3 !important; border-color:#ddd !important; }
      .logo{ border-color:#ddd !important; box-shadow:none !important; }
      .logo span{ color:#111 !important; text-shadow:none !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Top -->
    <div class="topbar">
      <div class="brandCard">
        <div class="brandRow">
          <div class="brandLeft">
            <div class="logo" aria-label="KRS INVITE logo"><span>KRS</span></div>
            <div class="brandTitle">
              <h1 id="reportTitle">KRS INVITE â€” Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</h1>
              <p id="reportSub">ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØªØ­Ù‚Ù‚ â€” Ù†Ø³Ø®Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆPDF</p>
            </div>
          </div>

          <div class="brandRight">
            <span class="pill"><strong id="evNamePill">â€”</strong> Â· <span id="evDatePill">â€”</span></span>
            <button class="btn" id="langToggle" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©">ğŸŒ <span id="langLabel">English</span></button>
            <button class="btn primary" id="printBtn" title="Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF">ğŸ–¨ï¸ <span id="printLabel">Ø·Ø¨Ø§Ø¹Ø© / PDF</span></button>
            <button class="btn" id="exportBtn" title="ØªØµØ¯ÙŠØ± CSV">â¬‡ï¸ <span id="exportLabel">ØªØµØ¯ÙŠØ± CSV</span></button>
          </div>
        </div>
        <div class="divider"></div>
        <div class="footer" style="margin-top:12px">
          <div class="footLeft">
            <span class="stamp" id="generatedStamp">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: â€”</span>
            <span id="venueLine">â€”</span>
          </div>
          <div id="contactLine">â€”</div>
        </div>
      </div>
    </div>

    <!-- Main grid -->
    <div class="grid">
      <!-- Left: KPIs + Charts + Table -->
      <div class="card">
        <div class="head">
          <div>
            <h2 id="summaryHead">Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h2>
            <p id="summaryDesc">Ø£Ø±Ù‚Ø§Ù… Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆÙ†ÙØ³ÙØ¨ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ­Ù‚Ù‚.</p>
          </div>
          <span class="pill" id="statusPill">â€”</span>
        </div>

        <div class="body">
          <div class="kpis" id="kpiGrid"></div>

          <div style="height:12px"></div>

          <div class="charts">
            <div class="chartBox">
              <div class="chartTop">
                <div class="title" id="donutTitle">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± (Checked-in)</div>
                <div class="meta" id="donutMeta">â€”</div>
              </div>
              <canvas id="donut"></canvas>
            </div>

            <div class="chartBox">
              <div class="chartTop">
                <div class="title" id="barTitle">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª</div>
                <div class="meta" id="barMeta">â€”</div>
              </div>
              <canvas id="bars"></canvas>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="card" style="border-radius:18px; box-shadow:none; background:rgba(0,0,0,.14); border:1px solid rgba(255,255,255,.10);">
            <div class="head" style="border-bottom:1px solid rgba(255,255,255,.08)">
              <div>
                <h2 id="detailsHead">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª (Ø¹ÙŠÙ†Ø©)</h2>
                <p id="detailsDesc">ÙŠØ¹Ø±Ø¶ Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø£Ùˆ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ â€” ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„ÙƒØ§Ù…Ù„Ø©.</p>
              </div>
              <span class="pill" id="detailsCount">â€”</span>
            </div>
            <div class="body">
              <div class="tableWrap">
                <table>
                  <thead>
                    <tr>
                      <th id="thCode">Ø§Ù„ÙƒÙˆØ¯</th>
                      <th id="thOwner">Ø§Ù„Ø§Ø³Ù…</th>
                      <th id="thStatus">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                      <th id="thTime">ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                      <th id="thGate">Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©/Ø§Ù„Ù…ÙˆØ¸Ù</th>
                    </tr>
                  </thead>
                  <tbody id="tbody"></tbody>
                </table>
              </div>
              <div style="margin-top:10px; color:var(--muted); font-size:12px" id="tableHint">
                Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø¬Ø¯ÙˆÙ„ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙˆØ³Ø¹Ø©. Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ CSV/Excel Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ Ø£Ù‚ÙˆÙ„ Ù„Ùƒ ÙƒÙŠÙ ØªØ±Ø¨Ø·Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©.
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Right: Insights + Notes -->
      <div class="card">
        <div class="head">
          <div>
            <h2 id="insightsHead">Ø£Ù‡Ù… Ù…Ø§ ÙŠÙ‡Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
            <p id="insightsDesc">Ù…Ø¤Ø´Ø±Ø§Øª Ø°ÙƒÙŠØ©: Ø§Ù„Ø°Ø±ÙˆØ©ØŒ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§ØªØŒ ÙˆØ¬ÙˆØ¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„.</p>
          </div>
          <span class="pill" id="qualityPill">â€”</span>
        </div>
        <div class="body">
          <div class="notes" style="grid-template-columns:1fr; gap:12px;">
            <div class="note">
              <h3 id="peakHead">Ø°Ø±ÙˆØ© Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
              <p id="peakText">â€”</p>
            </div>

            <div class="note">
              <h3 id="speedHead">Ø³Ø±Ø¹Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
              <ul id="speedList"></ul>
            </div>

            <div class="note">
              <h3 id="exceptionsHead">Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h3>
              <ul id="exceptionsList"></ul>
            </div>

            <div class="note">
              <h3 id="opsHead">Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ´ØºÙŠÙ„ÙŠØ©</h3>
              <ul id="opsList"></ul>
            </div>
          </div>

          <div class="footer">
            <div class="footLeft">
              <span id="reportIdLine" class="mono">â€”</span>
              <span class="pill" id="versionLine">v1.0</span>
            </div>
            <div class="mono" id="signatureLine">KRS INVITE</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  Ø¹Ø¯Ù‘Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§ ÙÙ‚Ø·
 *  ========================= */
const REPORT_DATA = {
  brand: "KRS INVITE",
  reportId: "KRS-INVITE-REP-0001",
  version: "v1.0",
  languageDefault: "ar", // "ar" or "en"

  event: {
    name_ar: "Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯",
    name_en: "Khaled Wedding",
    date: "15-01-2026",
    timeRange: "5:30 PM â€“ 11:30 PM",
    venue_ar: "Ø¯Ø¨ÙŠ â€” Ù‚Ø§Ø¹Ø© Ù…Ø³ØªÙ‚Ù„Ø©",
    venue_en: "Dubai â€” Standalone Hall",
    contact: "WhatsApp: +971 XX XXX XXXX  Â·  Email: krs2.store@gmail.com"
  },

  totals: {
    totalInvites: 300,       // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯/Ø§Ù„Ø¯Ø¹ÙˆØ§Øª
    checkedIn: 214,          // ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„
    rejected: 6,             // Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø±ÙÙˆØ¶Ø© (Ù…ÙƒØ±Ø±/ØºÙŠØ± ØµØ§Ù„Ø­/Ù…ØºÙ„Ù‚)
    manualOverrides: 3,      // Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ/Ø§Ø³ØªØ«Ù†Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    staffCount: 2,           // Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    gates: 1                 // Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø§Øª/Ø§Ù„Ù…Ø¯Ø§Ø®Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  },

  // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª (ÙƒÙ„ Ø¹Ù†ØµØ± ÙŠÙ…Ø«Ù„ 15 Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø«Ù„Ø§Ù‹)
  timeline: [
    { label: "5:30", count: 6 },
    { label: "5:45", count: 14 },
    { label: "6:00", count: 22 },
    { label: "6:15", count: 28 },
    { label: "6:30", count: 33 },
    { label: "6:45", count: 29 },
    { label: "7:00", count: 26 },
    { label: "7:15", count: 18 },
    { label: "7:30", count: 14 },
    { label: "7:45", count: 10 },
    { label: "8:00", count: 8 },
    { label: "8:15", count: 6 }
  ],

  // Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„ (ØªÙ‚Ø¯Ø± ØªØ³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§ØªÙƒ)
  rowsSample: [
    { code:"KRS_001", owner_ar:"Ù…Ø­Ù…Ø¯", owner_en:"Mohammed", status:"checked", time:"5:36 PM", gate:"Gate 1 / Staff A" },
    { code:"KRS_017", owner_ar:"Ù†ÙˆØ±Ø§",  owner_en:"Noura",    status:"checked", time:"5:48 PM", gate:"Gate 1 / Staff A" },
    { code:"KRS_102", owner_ar:"Ø³Ø§Ù„Ù…",  owner_en:"Salem",    status:"checked", time:"6:07 PM", gate:"Gate 1 / Staff B" },
    { code:"KRS_144", owner_ar:"Ø´ÙŠØ®Ø©",  owner_en:"Sheikha",  status:"rejected_duplicate", time:"6:22 PM", gate:"Gate 1 / Staff A" },
    { code:"KRS_210", owner_ar:"Ø¹Ù„ÙŠ",   owner_en:"Ali",      status:"checked", time:"6:33 PM", gate:"Gate 1 / Staff B" },
    { code:"KRS_255", owner_ar:"ÙØ§Ø·Ù…Ø©", owner_en:"Fatima",   status:"manual", time:"6:55 PM", gate:"Gate 1 / Supervisor" }
  ],

  notes: {
    ops_ar: [
      "ØªÙ… ØªØ¬Ù‡ÙŠØ² Ù†Ù‚Ø·Ø© Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙˆØ§Ø­Ø¯Ø© Ù…Ø¹ Ø¬Ù‡Ø§Ø² Ù…Ø§Ø³Ø­ ÙˆØ±Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ø¨Ø§Ù„Ù†Ø¸Ø§Ù….",
      "ØªÙ… ØªÙØ¹ÙŠÙ„ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„.",
      "ÙŠÙˆØµÙ‰ Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø³Ø­ Ù„ØªØ­Ø³ÙŠÙ† Ø³Ø±Ø¹Ø© Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·."
    ],
    ops_en: [
      "Single reception point with scanner connected to the system.",
      "Duplicate attempts alerts enabled to prevent re-entry.",
      "Recommended: enhance lighting at scanning spot to improve speed."
    ],
    exceptions_ar: [
      "Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ÙƒØ±Ø±Ø©: 6",
      "Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª ÙŠØ¯ÙˆÙŠØ©: 3",
      "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù†Ù‚Ø·Ø§Ø¹Ø§Øª ÙƒØ¨ÙŠØ±Ø© Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø¯Ø«."
    ],
    exceptions_en: [
      "Duplicate attempts: 6",
      "Manual overrides: 3",
      "No major system downtime during the event."
    ],
    speed_ar: [
      "Ù…ØªÙˆØ³Ø· ØªØ¯ÙÙ‚ Ø§Ù„Ø­Ø¶ÙˆØ± ÙŠÙÙ‚Ø¯Ù‘Ø± Ø­Ø³Ø¨ Ø§Ù„Ø°Ø±ÙˆØ© ÙˆØ§Ù„Ø²Ù…Ù† Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶.",
      "ÙŠÙˆØµÙ‰ Ø¨ØªØ®ØµÙŠØµ Ù…ÙˆØ¸Ù Ø¥Ø¶Ø§ÙÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø°Ø±ÙˆØ© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø²Ø¯Ø­Ø§Ù…."
    ],
    speed_en: [
      "Average flow estimated based on peak window and timeline.",
      "Recommended: add one more staff during peak to reduce queue."
    ]
  }
};

/** =========================
 *  i18n
 *  ========================= */
const I18N = {
  ar: {
    reportTitle: "KRS INVITE â€” Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù†Ø§Ø³Ø¨Ø©",
    reportSub: "ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØªØ­Ù‚Ù‚ â€” Ù†Ø³Ø®Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆPDF",
    printLabel:"Ø·Ø¨Ø§Ø¹Ø© / PDF",
    exportLabel:"ØªØµØ¯ÙŠØ± CSV",
    summaryHead:"Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹",
    summaryDesc:"Ø£Ø±Ù‚Ø§Ù… Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆÙ†ÙØ³ÙØ¨ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ­Ù‚Ù‚.",
    donutTitle:"Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± (Checked-in)",
    barTitle:"ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª",
    detailsHead:"ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª (Ø¹ÙŠÙ†Ø©)",
    detailsDesc:"ÙŠØ¹Ø±Ø¶ Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø£Ùˆ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ â€” ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„ÙƒØ§Ù…Ù„Ø©.",
    thCode:"Ø§Ù„ÙƒÙˆØ¯",
    thOwner:"Ø§Ù„Ø§Ø³Ù…",
    thStatus:"Ø§Ù„Ø­Ø§Ù„Ø©",
    thTime:"ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„",
    thGate:"Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©/Ø§Ù„Ù…ÙˆØ¸Ù",
    insightsHead:"Ø£Ù‡Ù… Ù…Ø§ ÙŠÙ‡Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„",
    insightsDesc:"Ù…Ø¤Ø´Ø±Ø§Øª Ø°ÙƒÙŠØ©: Ø§Ù„Ø°Ø±ÙˆØ©ØŒ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§ØªØŒ ÙˆØ¬ÙˆØ¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„.",
    peakHead:"Ø°Ø±ÙˆØ© Ø§Ù„Ø­Ø¶ÙˆØ±",
    speedHead:"Ø³Ø±Ø¹Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„",
    exceptionsHead:"Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª",
    opsHead:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ´ØºÙŠÙ„ÙŠØ©",
    tableHint:"Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø¬Ø¯ÙˆÙ„ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙˆØ³Ø¹Ø©. Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ CSV/Excel Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ Ø£Ù‚ÙˆÙ„ Ù„Ùƒ ÙƒÙŠÙ ØªØ±Ø¨Ø·Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©.",
    langLabel:"English",
    statusLive:"Ø§Ù„Ø­Ø§Ù„Ø©: Ù…ÙƒØªÙ…Ù„",
    quality:"Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„"
  },
  en: {
    reportTitle: "KRS INVITE â€” Final Event Report",
    reportSub: "Attendance & verification summary â€” Print/PDF ready",
    printLabel:"Print / PDF",
    exportLabel:"Export CSV",
    summaryHead:"Quick Summary",
    summaryDesc:"Key numbers and performance ratios for entry verification.",
    donutTitle:"Attendance Ratio (Checked-in)",
    barTitle:"Attendance by Time",
    detailsHead:"Invites Details (Sample)",
    detailsDesc:"Shows recent activity or a sample â€” replace with full dataset.",
    thCode:"Code",
    thOwner:"Name",
    thStatus:"Status",
    thTime:"Check-in Time",
    thGate:"Gate/Staff",
    insightsHead:"Client Highlights",
    insightsDesc:"Smart indicators: peak, speed, exceptions, and operations quality.",
    peakHead:"Peak Window",
    speedHead:"Entry Speed",
    exceptionsHead:"Exceptions & Alerts",
    opsHead:"Operational Notes",
    tableHint:"Note: This table is expandable. If you have CSV/Excel from your system, tell me and Iâ€™ll connect it.",
    langLabel:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
    statusLive:"Status: Completed",
    quality:"Operations Quality"
  }
};

let LANG = REPORT_DATA.languageDefault === "en" ? "en" : "ar";

/** =========================
 *  Helpers
 *  ========================= */
const $ = (id)=>document.getElementById(id);

function nowStamp(){
  const d = new Date();
  const pad=(n)=>String(n).padStart(2,"0");
  const dd = pad(d.getDate());
  const mm = pad(d.getMonth()+1);
  const yyyy = d.getFullYear();
  let hh = d.getHours(); const min = pad(d.getMinutes());
  const ampm = hh>=12 ? "PM":"AM";
  hh = hh%12; if(hh===0) hh=12;
  return `${dd}-${mm}-${yyyy}  ${hh}:${min} ${ampm}`;
}

function pct(n, d){
  if(!d) return 0;
  return Math.round((n/d)*1000)/10; // 1 decimal
}

function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

function statusLabel(s){
  if(LANG==="ar"){
    if(s==="checked") return `<span class="tag"><span class="dot good"></span> ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„</span>`;
    if(s==="manual") return `<span class="tag"><span class="dot warn"></span> Ø§Ø³ØªØ«Ù†Ø§Ø¡ ÙŠØ¯ÙˆÙŠ</span>`;
    if(s==="rejected_duplicate") return `<span class="tag"><span class="dot bad"></span> Ù…ÙƒØ±Ø±</span>`;
    if(s==="rejected_invalid") return `<span class="tag"><span class="dot bad"></span> ØºÙŠØ± ØµØ§Ù„Ø­</span>`;
    return `<span class="tag"><span class="dot"></span> â€”</span>`;
  } else {
    if(s==="checked") return `<span class="tag"><span class="dot good"></span> Checked-in</span>`;
    if(s==="manual") return `<span class="tag"><span class="dot warn"></span> Manual</span>`;
    if(s==="rejected_duplicate") return `<span class="tag"><span class="dot bad"></span> Duplicate</span>`;
    if(s==="rejected_invalid") return `<span class="tag"><span class="dot bad"></span> Invalid</span>`;
    return `<span class="tag"><span class="dot"></span> â€”</span>`;
  }
}

function kpiBadgeStyle(type){
  if(type==="good") return "badge b-good";
  if(type==="warn") return "badge b-warn";
  if(type==="bad") return "badge b-bad";
  return "badge";
}

function formatNumber(n){
  return (n??0).toLocaleString("en-US");
}

/** =========================
 *  Compute metrics
 *  ========================= */
function compute(){
  const T = REPORT_DATA.totals;
  const total = Math.max(0, Number(T.totalInvites||0));
  const checked = clamp(Number(T.checkedIn||0), 0, total);
  const rejected = Math.max(0, Number(T.rejected||0));
  const manual = Math.max(0, Number(T.manualOverrides||0));
  const notUsed = Math.max(0, total - checked);

  const attendancePct = pct(checked, total);
  const notUsedPct = pct(notUsed, total);

  const timeline = Array.isArray(REPORT_DATA.timeline) ? REPORT_DATA.timeline : [];
  const sumTimeline = timeline.reduce((a,x)=>a+(Number(x.count)||0),0);
  // Peak window
  let peak = {label:"â€”", count:0};
  for(const x of timeline){
    const c = Number(x.count)||0;
    if(c > peak.count) peak = {label:x.label, count:c};
  }
  const peakPctOfChecked = checked ? pct(peak.count, checked) : 0;

  // Simple quality scoring (0..100)
  const dupPenalty = Math.min(20, rejected*2);
  const coverageBonus = Math.min(60, attendancePct*0.6);
  const stabilityBonus = 20;
  const quality = clamp(Math.round(coverageBonus + stabilityBonus - dupPenalty), 0, 100);

  // Flow estimate
  const windows = Math.max(1, timeline.length);
  const avgPerWindow = (sumTimeline||checked) / windows;
  const estPerHour = avgPerWindow * 4; // assuming 15-min windows
  return {
    total, checked, rejected, manual, notUsed,
    attendancePct, notUsedPct,
    timeline, sumTimeline,
    peak, peakPctOfChecked,
    quality,
    avgPerWindow: Math.round(avgPerWindow),
    estPerHour: Math.round(estPerHour)
  };
}

/** =========================
 *  Render
 *  ========================= */
function applyLang(){
  const t = I18N[LANG];
  document.documentElement.lang = LANG;
  document.documentElement.dir = (LANG==="ar") ? "rtl" : "ltr";

  $("reportTitle").textContent = t.reportTitle;
  $("reportSub").textContent = t.reportSub;

  $("printLabel").textContent = t.printLabel;
  $("exportLabel").textContent = t.exportLabel;

  $("summaryHead").textContent = t.summaryHead;
  $("summaryDesc").textContent = t.summaryDesc;

  $("donutTitle").textContent = t.donutTitle;
  $("barTitle").textContent = t.barTitle;

  $("detailsHead").textContent = t.detailsHead;
  $("detailsDesc").textContent = t.detailsDesc;

  $("thCode").textContent = t.thCode;
  $("thOwner").textContent = t.thOwner;
  $("thStatus").textContent = t.thStatus;
  $("thTime").textContent = t.thTime;
  $("thGate").textContent = t.thGate;

  $("insightsHead").textContent = t.insightsHead;
  $("insightsDesc").textContent = t.insightsDesc;

  $("peakHead").textContent = t.peakHead;
  $("speedHead").textContent = t.speedHead;
  $("exceptionsHead").textContent = t.exceptionsHead;
  $("opsHead").textContent = t.opsHead;

  $("tableHint").textContent = t.tableHint;

  $("langLabel").textContent = t.langLabel;

  $("statusPill").textContent = t.statusLive;
  $("qualityPill").textContent = `${t.quality}: â€”`;

  // Event pills
  const ev = REPORT_DATA.event;
  $("evNamePill").textContent = (LANG==="ar") ? (ev.name_ar||"â€”") : (ev.name_en||"â€”");
  $("evDatePill").textContent = `${ev.date||"â€”"} Â· ${ev.timeRange||"â€”"}`;

  $("venueLine").textContent = (LANG==="ar") ? (ev.venue_ar||"â€”") : (ev.venue_en||"â€”");
  $("contactLine").textContent = ev.contact || "â€”";

  $("generatedStamp").textContent = (LANG==="ar") ? `ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${nowStamp()}` : `Generated: ${nowStamp()}`;
  $("reportIdLine").textContent = `REPORT ID: ${REPORT_DATA.reportId || "â€”"}`;
  $("versionLine").textContent = REPORT_DATA.version || "v1.0";
  $("signatureLine").textContent = REPORT_DATA.brand || "KRS INVITE";
}

function renderKPIs(m){
  const kpiDefs = [
    {
      key:"total",
      t_ar:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª",
      t_en:"Total Invites",
      v: formatNumber(m.total),
      s_ar:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙˆÙ„Ø¯Ø©",
      s_en:"Total generated codes",
      badge: "â€”",
      tone:""
    },
    {
      key:"checked",
      t_ar:"ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„",
      t_en:"Checked-in",
      v: formatNumber(m.checked),
      s_ar:`Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±: ${m.attendancePct}%`,
      s_en:`Attendance: ${m.attendancePct}%`,
      badge: (m.attendancePct>=80) ? ((LANG==="ar")?"Ù…Ù…ØªØ§Ø²":"Excellent") : (m.attendancePct>=60 ? ((LANG==="ar")?"Ø¬ÙŠØ¯":"Good") : ((LANG==="ar")?"Ù…ØªÙˆØ³Ø·":"Average")),
      tone: (m.attendancePct>=80) ? "good" : (m.attendancePct>=60 ? "warn" : "bad")
    },
    {
      key:"notUsed",
      t_ar:"Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡",
      t_en:"Not used",
      v: formatNumber(m.notUsed),
      s_ar:`Ù†Ø³Ø¨Ø© ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${m.notUsedPct}%`,
      s_en:`Unused: ${m.notUsedPct}%`,
      badge: (m.notUsedPct<=20) ? ((LANG==="ar")?"Ù…Ù†Ø®ÙØ¶":"Low") : (m.notUsedPct<=40 ? ((LANG==="ar")?"Ø·Ø¨ÙŠØ¹ÙŠ":"Normal") : ((LANG==="ar")?"Ù…Ø±ØªÙØ¹":"High")),
      tone: (m.notUsedPct<=20) ? "good" : (m.notUsedPct<=40 ? "warn" : "bad")
    },
    {
      key:"rejected",
      t_ar:"Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø±ÙÙˆØ¶Ø©",
      t_en:"Rejected attempts",
      v: formatNumber(m.rejected),
      s_ar:`Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª ÙŠØ¯ÙˆÙŠØ©: ${formatNumber(m.manual)}`,
      s_en:`Manual overrides: ${formatNumber(m.manual)}`,
      badge: (m.rejected<=5) ? ((LANG==="ar")?"Ù…Ø³ÙŠØ·Ø±":"Controlled") : (m.rejected<=12 ? ((LANG==="ar")?"ØªÙ†Ø¨ÙŠÙ‡":"Attention") : ((LANG==="ar")?"Ù…Ø±ØªÙØ¹":"High")),
      tone: (m.rejected<=5) ? "good" : (m.rejected<=12 ? "warn" : "bad")
    },
  ];

  const grid = $("kpiGrid");
  grid.innerHTML = "";
  for(const k of kpiDefs){
    const title = (LANG==="ar") ? k.t_ar : k.t_en;
    const sub = (LANG==="ar") ? k.s_ar : k.s_en;
    const badgeCls = kpiBadgeStyle(k.tone);
    const el = document.createElement("div");
    el.className = "kpi";
    el.innerHTML = `
      <div class="t">${title}</div>
      <div class="v">${k.v}</div>
      <div class="s">${sub}</div>
      <div class="${badgeCls}">${k.badge}</div>
    `;
    grid.appendChild(el);
  }

  // Quality pill
  const qText = (LANG==="ar") ? `Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„: ${m.quality}/100` : `Operations Quality: ${m.quality}/100`;
  $("qualityPill").textContent = qText;

  // Status pill details
  const staff = REPORT_DATA.totals.staffCount ?? "â€”";
  const gates = REPORT_DATA.totals.gates ?? "â€”";
  $("statusPill").textContent = (LANG==="ar")
    ? `Ø§Ù„Ø­Ø§Ù„Ø©: Ù…ÙƒØªÙ…Ù„ Â· Ø¨ÙˆØ§Ø¨Ø§Øª: ${gates} Â· Ø·Ø§Ù‚Ù…: ${staff}`
    : `Status: Completed Â· Gates: ${gates} Â· Staff: ${staff}`;
}

function renderTable(){
  const rows = Array.isArray(REPORT_DATA.rowsSample) ? REPORT_DATA.rowsSample : [];
  $("detailsCount").textContent = (LANG==="ar") ? `Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${rows.length}` : `Shown rows: ${rows.length}`;
  const tb = $("tbody");
  tb.innerHTML = "";
  for(const r of rows){
    const tr = document.createElement("tr");
    const owner = (LANG==="ar") ? (r.owner_ar||"â€”") : (r.owner_en||"â€”");
    tr.innerHTML = `
      <td class="mono">${escapeHtml(r.code||"â€”")}</td>
      <td>${escapeHtml(owner)}</td>
      <td>${statusLabel(r.status||"")}</td>
      <td class="mono">${escapeHtml(r.time||"â€”")}</td>
      <td>${escapeHtml(r.gate||"â€”")}</td>
    `;
    tb.appendChild(tr);
  }
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/** =========================
 *  Canvas charts (no libs)
 *  ========================= */
function setupCanvas(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.max(1, Math.floor(rect.width * dpr));
  canvas.height = Math.max(1, Math.floor(rect.height * dpr));
  const ctx = canvas.getContext("2d");
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return ctx;
}

function getCssVar(name){
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}

function drawDonut(m){
  const canvas = $("donut");
  const ctx = setupCanvas(canvas);
  const w = canvas.getBoundingClientRect().width;
  const h = canvas.getBoundingClientRect().height;
  ctx.clearRect(0,0,w,h);

  const cx = w/2, cy = h/2;
  const r = Math.min(w,h)*0.34;
  const thick = Math.max(16, r*0.30);

  const used = m.checked;
  const total = Math.max(1, m.total);
  const ratio = used/total;

  // background ring
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI*2);
  ctx.strokeStyle = "rgba(255,255,255,.10)";
  ctx.lineWidth = thick;
  ctx.lineCap = "round";
  ctx.stroke();

  // gradient stroke
  const grad = ctx.createLinearGradient(cx-r, cy-r, cx+r, cy+r);
  grad.addColorStop(0, "rgba(247,211,122,.95)");
  grad.addColorStop(1, "rgba(207,162,74,.60)");

  const start = -Math.PI/2;
  const end = start + (Math.PI*2*ratio);

  ctx.beginPath();
  ctx.arc(cx, cy, r, start, end);
  ctx.strokeStyle = grad;
  ctx.lineWidth = thick;
  ctx.lineCap = "round";
  ctx.shadowColor = "rgba(247,211,122,.20)";
  ctx.shadowBlur = 18;
  ctx.stroke();
  ctx.shadowBlur = 0;

  // center text
  ctx.fillStyle = "rgba(233,238,247,.95)";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.font = "800 34px " + getCssVar("--font");
  ctx.fillText(`${m.attendancePct}%`, cx, cy - 10);

  ctx.fillStyle = "rgba(168,179,198,.95)";
  ctx.font = "800 13px " + getCssVar("--font");
  const sub = (LANG==="ar") ? `ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ ${formatNumber(m.checked)} Ù…Ù† ${formatNumber(m.total)}` : `${formatNumber(m.checked)} of ${formatNumber(m.total)} checked`;
  ctx.fillText(sub, cx, cy + 22);

  $("donutMeta").textContent = (LANG==="ar")
    ? `Ø­Ø¶ÙˆØ±: ${formatNumber(m.checked)} Â· ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…: ${formatNumber(m.notUsed)}`
    : `Checked: ${formatNumber(m.checked)} Â· Unused: ${formatNumber(m.notUsed)}`;
}

function drawBars(m){
  const canvas = $("bars");
  const ctx = setupCanvas(canvas);
  const w = canvas.getBoundingClientRect().width;
  const h = canvas.getBoundingClientRect().height;
  ctx.clearRect(0,0,w,h);

  const pad = 18;
  const chartW = w - pad*2;
  const chartH = h - pad*2 - 18;

  const tl = m.timeline || [];
  const maxV = Math.max(1, ...tl.map(x=>Number(x.count)||0));
  const barCount = tl.length || 1;
  const gap = 8;
  const barW = (chartW - gap*(barCount-1)) / barCount;

  // axis baseline
  ctx.strokeStyle = "rgba(255,255,255,.10)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pad, pad + chartH);
  ctx.lineTo(pad + chartW, pad + chartH);
  ctx.stroke();

  // bars
  for(let i=0;i<tl.length;i++){
    const v = Number(tl[i].count)||0;
    const x = pad + i*(barW+gap);
    const bh = (v/maxV) * (chartH - 8);
    const y = pad + chartH - bh;

    // gradient
    const g = ctx.createLinearGradient(x, y, x, y+bh);
    g.addColorStop(0, "rgba(247,211,122,.75)");
    g.addColorStop(1, "rgba(255,255,255,.08)");

    roundRect(ctx, x, y, barW, bh, 10);
    ctx.fillStyle = g;
    ctx.fill();

    // top value
    ctx.fillStyle = "rgba(233,238,247,.9)";
    ctx.font = "900 11px " + getCssVar("--font");
    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";
    ctx.fillText(String(v), x + barW/2, y - 6);

    // bottom label (sparse)
    if(i % 2 === 0){
      ctx.fillStyle = "rgba(168,179,198,.9)";
      ctx.font = "900 11px " + getCssVar("--font");
      ctx.textBaseline = "top";
      ctx.fillText(tl[i].label || "", x + barW/2, pad + chartH + 6);
    }
  }

  $("barMeta").textContent = (LANG==="ar")
    ? `Ù…ØªÙˆØ³Ø·/Ù†Ø§ÙØ°Ø©: ${formatNumber(m.avgPerWindow)} Â· ØªÙ‚Ø¯ÙŠØ±ÙŠ/Ø³Ø§Ø¹Ø©: ${formatNumber(m.estPerHour)}`
    : `Avg/window: ${formatNumber(m.avgPerWindow)} Â· Est/hour: ${formatNumber(m.estPerHour)}`;
}

function roundRect(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}

/** =========================
 *  Insights
 *  ========================= */
function renderInsights(m){
  // Peak
  const peakLine = (LANG==="ar")
    ? `Ø£Ø¹Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ø­Ø¶ÙˆØ± ÙƒØ§Ù†Øª Ø¹Ù†Ø¯ <strong>${m.peak.label}</strong> Ø¨Ø¹Ø¯Ø¯ <strong>${formatNumber(m.peak.count)}</strong> Ø¯Ø®ÙˆÙ„ (${m.peakPctOfChecked}% Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¶ÙˆØ±).`
    : `Peak window was <strong>${m.peak.label}</strong> with <strong>${formatNumber(m.peak.count)}</strong> entries (${m.peakPctOfChecked}% of total checked-in).`;
  $("peakText").innerHTML = peakLine;

  // Speed
  const speed = $("speedList");
  speed.innerHTML = "";
  const speedItems = (LANG==="ar")
    ? [
        `ØªÙ‚Ø¯ÙŠØ± Ø§Ù„ØªØ¯ÙÙ‚: <strong>${formatNumber(m.estPerHour)}</strong> Ø¶ÙŠÙ/Ø³Ø§Ø¹Ø© (ØªÙ‚Ø±ÙŠØ¨ÙŠ).`,
        `Ù…ØªÙˆØ³Ø· ÙƒÙ„ Ù†Ø§ÙØ°Ø©: <strong>${formatNumber(m.avgPerWindow)}</strong> Ø¯Ø®ÙˆÙ„.`,
        ...(REPORT_DATA.notes.speed_ar || [])
      ]
    : [
        `Estimated flow: <strong>${formatNumber(m.estPerHour)}</strong> guests/hour (approx).`,
        `Average per window: <strong>${formatNumber(m.avgPerWindow)}</strong> entries.`,
        ...(REPORT_DATA.notes.speed_en || [])
      ];
  for(const it of speedItems){
    const li = document.createElement("li");
    li.innerHTML = it;
    speed.appendChild(li);
  }

  // Exceptions
  const ex = $("exceptionsList");
  ex.innerHTML = "";
  const exItems = (LANG==="ar")
    ? [
        `Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø±ÙÙˆØ¶Ø©: <strong>${formatNumber(m.rejected)}</strong>`,
        `Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª ÙŠØ¯ÙˆÙŠØ©: <strong>${formatNumber(m.manual)}</strong>`,
        ...(REPORT_DATA.notes.exceptions_ar || [])
      ]
    : [
        `Rejected attempts: <strong>${formatNumber(m.rejected)}</strong>`,
        `Manual overrides: <strong>${formatNumber(m.manual)}</strong>`,
        ...(REPORT_DATA.notes.exceptions_en || [])
      ];
  for(const it of exItems){
    const li = document.createElement("li");
    li.innerHTML = it;
    ex.appendChild(li);
  }

  // Ops
  const ops = $("opsList");
  ops.innerHTML = "";
  const opsItems = (LANG==="ar")
    ? [
        `Ù†Ù‚Ø·Ø© Ø¯Ø®ÙˆÙ„/Ø¨ÙˆØ§Ø¨Ø©: <strong>${formatNumber(REPORT_DATA.totals.gates||1)}</strong>`,
        `Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø§Ù‚Ù…: <strong>${formatNumber(REPORT_DATA.totals.staffCount||1)}</strong>`,
        ...(REPORT_DATA.notes.ops_ar || [])
      ]
    : [
        `Gate(s): <strong>${formatNumber(REPORT_DATA.totals.gates||1)}</strong>`,
        `Staff: <strong>${formatNumber(REPORT_DATA.totals.staffCount||1)}</strong>`,
        ...(REPORT_DATA.notes.ops_en || [])
      ];
  for(const it of opsItems){
    const li = document.createElement("li");
    li.innerHTML = it;
    ops.appendChild(li);
  }
}

/** =========================
 *  Export CSV
 *  ========================= */
function exportCSV(){
  const rows = Array.isArray(REPORT_DATA.rowsSample) ? REPORT_DATA.rowsSample : [];
  const header = (LANG==="ar")
    ? ["Code","Owner","Status","Time","Gate"]
    : ["Code","Owner","Status","Time","Gate"];
  const lines = [header.join(",")];

  for(const r of rows){
    const owner = (LANG==="ar") ? (r.owner_ar||"") : (r.owner_en||"");
    const status = r.status||"";
    const cols = [
      safeCsv(r.code||""),
      safeCsv(owner),
      safeCsv(status),
      safeCsv(r.time||""),
      safeCsv(r.gate||"")
    ];
    lines.push(cols.join(","));
  }

  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  const ev = (LANG==="ar") ? (REPORT_DATA.event.name_ar||"event") : (REPORT_DATA.event.name_en||"event");
  a.download = `${REPORT_DATA.brand}-report-${ev}-${REPORT_DATA.event.date}.csv`.replace(/\s+/g,"_");
  a.href = URL.createObjectURL(blob);
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);
}
function safeCsv(v){
  const s = String(v).replace(/"/g,'""');
  return `"${s}"`;
}

/** =========================
 *  Boot
 *  ========================= */
function renderAll(){
  applyLang();

  const ev = REPORT_DATA.event;
  $("evNamePill").textContent = (LANG==="ar") ? (ev.name_ar||"â€”") : (ev.name_en||"â€”");
  $("evDatePill").textContent = `${ev.date||"â€”"} Â· ${ev.timeRange||"â€”"}`;

  $("reportIdLine").textContent = `REPORT ID: ${REPORT_DATA.reportId || "â€”"}`;

  const m = compute();
  renderKPIs(m);
  renderTable();
  renderInsights(m);

  // Redraw charts after layout settles
  requestAnimationFrame(()=>{
    drawDonut(m);
    drawBars(m);
  });
}

$("printBtn").addEventListener("click", ()=> window.print());
$("exportBtn").addEventListener("click", exportCSV);
$("langToggle").addEventListener("click", ()=>{
  LANG = (LANG==="ar") ? "en" : "ar";
  renderAll();
});

// Responsive redraw on resize (debounced)
let tmr=null;
window.addEventListener("resize", ()=>{
  clearTimeout(tmr);
  tmr=setTimeout(()=>renderAll(), 160);
});

// Start
renderAll();
</script>
</body>
</html>
