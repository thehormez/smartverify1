<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KRS INVITE â€” Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</title>

  <style>
    :root{
      --bg1:#070A12;
      --bg2:#0B1020;
      --panel: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);
      --ink:#E9EEF7;
      --muted:#A8B3C6;

      --gold1:#F7D37A;
      --gold2:#CFA24A;

      --good:#39d98a;
      --warn:#ffce4a;
      --bad:#ff5c7a;

      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 28px;

      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans Arabic", "Tahoma", Arial, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --g: linear-gradient(135deg, rgba(247,211,122,.18), rgba(207,162,74,.08), rgba(255,255,255,.02));
      --glow: 0 0 0 1px rgba(247,211,122,.08), 0 0 60px rgba(247,211,122,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 80% -10%, rgba(247,211,122,.20), transparent 60%),
        radial-gradient(900px 520px at 20% 0%, rgba(90,120,255,.12), transparent 55%),
        radial-gradient(900px 520px at 60% 110%, rgba(255,92,122,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    .wrap{ width:min(1200px, 94vw); margin: 28px auto 60px; }

    .brandCard{
      padding:18px 18px 16px;
      border-radius: var(--radius2);
      background: var(--g);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .brandCard:before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(600px 140px at 70% 0%, rgba(247,211,122,.35), transparent 60%),
        radial-gradient(500px 260px at 15% 110%, rgba(120,180,255,.18), transparent 65%);
      pointer-events:none;
      opacity:.85;
    }
    .brandRow{
      position:relative;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brandLeft{display:flex;align-items:center;gap:14px;min-width:260px}
    .logo{
      width:56px;height:56px;border-radius:18px;
      background: linear-gradient(135deg, rgba(247,211,122,.34), rgba(207,162,74,.16), rgba(255,255,255,.04));
      border: 1px solid rgba(247,211,122,.22);
      box-shadow: var(--glow);
      display:grid; place-items:center;
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(32px 32px at 30% 35%, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(80px 60px at 70% 80%, rgba(247,211,122,.18), transparent 60%);
      pointer-events:none;
    }
    .logo span{ position:relative; font-weight:1000; color:var(--gold1); letter-spacing:.6px; }
    .brandTitle{display:flex;flex-direction:column;gap:4px}
    .brandTitle h1{margin:0;font-size:18px;font-weight:1000}
    .brandTitle p{margin:0;color:var(--muted);font-size:12.5px;line-height:1.35}

    .brandRight{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:flex-end}
    .pill{
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 12px;
      font-weight:900;
      white-space:nowrap;
    }
    .pill strong{color:var(--ink)}
    .btn{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:1000;
      font-size: 13px;
      display:flex;
      gap:8px;
      align-items:center;
      transition:.18s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); }
    .btn.primary{
      border-color: rgba(247,211,122,.30);
      background: linear-gradient(135deg, rgba(247,211,122,.26), rgba(207,162,74,.10));
      box-shadow: var(--glow);
    }
    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(247,211,122,.22), rgba(255,255,255,.10), transparent);
      margin: 14px 0 0;
      opacity:.9;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      border-radius: var(--radius2);
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding:16px 16px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(135deg, rgba(255,255,255,.05), rgba(247,211,122,.06));
    }
    .card .head h2{ margin:0; font-size: 14.5px; font-weight: 1000; }
    .card .head p{ margin:6px 0 0; color: var(--muted); font-size: 12.5px; line-height:1.35; }
    .card .body{ padding:16px; }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){ .kpis{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .kpis{grid-template-columns: 1fr;} }

    .kpi{
      border-radius: 18px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.10);
      padding: 14px;
      position:relative;
      overflow:hidden;
      min-height: 92px;
    }
    .kpi:before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(260px 140px at 10% 10%, rgba(247,211,122,.18), transparent 60%),
        radial-gradient(200px 120px at 90% 70%, rgba(120,180,255,.12), transparent 60%);
      opacity:.8;
      pointer-events:none;
    }
    .kpi .t{ position:relative; color:var(--muted); font-size:12px; font-weight:1000; }
    .kpi .v{ position:relative; margin-top:8px; font-size:22px; font-weight:1000; letter-spacing:.2px; }
    .kpi .s{ position:relative; margin-top:6px; font-size:12px; color:var(--muted); }

    .charts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){ .charts{grid-template-columns:1fr;} }

    .chartBox{
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      padding: 14px;
      overflow:hidden;
    }
    .chartTop{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .chartTop .title{font-weight:1000;font-size:12.5px}
    .chartTop .meta{font-weight:900;font-size:12px;color:var(--muted);white-space:nowrap}
    canvas{ width:100%; height:240px; display:block; }

    .tableWrap{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: rgba(0,0,0,.16);
    }
    table{width:100%;border-collapse:collapse;font-size:12.5px}
    thead th{
      background: rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.10);
      text-align:start;
      padding: 12px 10px;
      font-weight: 1000;
    }
    tbody td{
      padding: 11px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
    }
    tbody tr:hover{ background: rgba(255,255,255,.04); }
    .mono{ font-family: var(--mono); letter-spacing:.2px; }

    .tag{
      display:inline-flex; gap:6px; align-items:center;
      padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:1000; font-size: 11px; white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--muted);display:inline-block}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .note{
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      padding: 14px;
      margin-bottom: 12px;
    }
    .note h3{margin:0;font-size:12.5px;font-weight:1000}
    .note p, .note ul{margin:10px 0 0;color:var(--muted);font-size:12.5px;line-height:1.55}
    ul{padding:0 18px}

    .footer{
      margin-top: 14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
    }
    .stamp{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(247,211,122,.22);
      background: rgba(247,211,122,.10);
      color: var(--gold1);
      font-weight:1000;
    }

    @media print{
      body{ background:white !important; color:#111 !important; }
      .btn, #langToggle, #printBtn { display:none !important; }
      .wrap{ width:100% !important; margin:0 !important; }
      .brandCard, .card{ box-shadow:none !important; border: 1px solid #ddd !important; background: white !important; }
      .kpi, .chartBox, .note{ background:white !important; border: 1px solid #e6e6e6 !important; }
      thead th{ background:#f5f5f5 !important; color:#111 !important; }
      tbody td{ color:#111 !important; }
      .brandTitle p, .kpi .t, .kpi .s, .note p, .note ul, .footer{ color:#444 !important; }
      .stamp{ color:#111 !important; background:#f3f3f3 !important; border-color:#ddd !important; }
      .logo{ border-color:#ddd !important; box-shadow:none !important; }
      .logo span{ color:#111 !important; text-shadow:none !important; }
      .pill{ color:#333 !important; border-color:#ddd !important; background:#f7f7f7 !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="brandCard">
      <div class="brandRow">
        <div class="brandLeft">
          <div class="logo"><span>KRS</span></div>
          <div class="brandTitle">
            <h1 id="reportTitle">KRS INVITE â€” Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</h1>
            <p id="reportSub">ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØªØ­Ù‚Ù‚ â€” Ù†Ø³Ø®Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆPDF</p>
          </div>
        </div>
        <div class="brandRight">
          <span class="pill"><strong id="evNamePill">â€”</strong> Â· <span id="evDatePill">â€”</span></span>
          <button class="btn" id="langToggle">ğŸŒ <span id="langLabel">English</span></button>
          <button class="btn primary" id="printBtn">ğŸ–¨ï¸ <span id="printLabel">Ø·Ø¨Ø§Ø¹Ø© / PDF</span></button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="footer" style="margin-top:12px">
        <div class="stamp" id="generatedStamp">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: â€”</div>
        <div id="venueLine">â€”</div>
        <div id="contactLine" class="mono">â€”</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="head">
          <div>
            <h2 id="summaryHead">Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h2>
            <p id="summaryDesc">Ø£Ø±Ù‚Ø§Ù… Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆÙ†ÙØ³ÙØ¨ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ­Ù‚Ù‚.</p>
          </div>
          <span class="pill" id="qualityPill">â€”</span>
        </div>
        <div class="body">
          <div class="kpis" id="kpiGrid"></div>

          <div style="height:12px"></div>

          <div class="charts">
            <div class="chartBox">
              <div class="chartTop">
                <div class="title" id="donutTitle">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± (Checked-in)</div>
                <div class="meta" id="donutMeta">â€”</div>
              </div>
              <canvas id="donut"></canvas>
            </div>

            <div class="chartBox">
              <div class="chartTop">
                <div class="title" id="barTitle">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª</div>
                <div class="meta" id="barMeta">â€”</div>
              </div>
              <canvas id="bars"></canvas>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="card" style="border-radius:18px; box-shadow:none; background:rgba(0,0,0,.14); border:1px solid rgba(255,255,255,.10);">
            <div class="head" style="border-bottom:1px solid rgba(255,255,255,.08)">
              <div>
                <h2 id="detailsHead">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª (Ø¹ÙŠÙ†Ø©)</h2>
                <p id="detailsDesc">ÙŠØ¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù„ÙˆØ­Ø© â€” ÙˆÙŠÙ…ÙƒÙ† ØªÙˆØ³ÙŠØ¹Ù‡ Ø­Ø³Ø¨ Ø­Ø§Ø¬ØªÙƒ.</p>
              </div>
              <span class="pill" id="detailsCount">â€”</span>
            </div>
            <div class="body">
              <div class="tableWrap">
                <table>
                  <thead>
                    <tr>
                      <th id="thCode">Ø§Ù„ÙƒÙˆØ¯</th>
                      <th id="thOwner">Ø§Ù„Ø§Ø³Ù…</th>
                      <th id="thStatus">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                      <th id="thTime">ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                      <th id="thGate">Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©/Ø§Ù„Ù…ÙˆØ¸Ù</th>
                    </tr>
                  </thead>
                  <tbody id="tbody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="footer">
            <div class="mono" id="reportIdLine">â€”</div>
            <div class="mono" id="signatureLine">KRS INVITE</div>
          </div>

        </div>
      </div>

      <div class="card">
        <div class="head">
          <div>
            <h2 id="insightsHead">Ø£Ù‡Ù… Ù…Ø§ ÙŠÙ‡Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
            <p id="insightsDesc">Ø§Ù„Ø°Ø±ÙˆØ©ØŒ Ø§Ù„Ø¬ÙˆØ¯Ø©ØŒ ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­.</p>
          </div>
          <span class="pill" id="statusPill">â€”</span>
        </div>
        <div class="body">
          <div class="note">
            <h3 id="peakHead">Ø°Ø±ÙˆØ© Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
            <p id="peakText">â€”</p>
          </div>

          <div class="note">
            <h3 id="opsHead">Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ´ØºÙŠÙ„ÙŠØ©</h3>
            <ul id="opsList"></ul>
          </div>

          <div class="note">
            <h3 id="alertsHead">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h3>
            <ul id="alertsList"></ul>
          </div>

          <div class="footer">
            <div class="stamp" id="verLine">v1.1</div>
            <div class="mono" id="genLine">â€”</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const REPORT_STORE = "KRS_INVITE_REPORT_V1";
  let DATA = null;

  const $ = (id)=>document.getElementById(id);
  const getFont = ()=>getComputedStyle(document.documentElement).getPropertyValue("--font").trim();
  const formatNumber = (n)=> (n??0).toLocaleString("en-US");
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const pct=(n,d)=>!d?0:Math.round((n/d)*1000)/10;

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function setupCanvas(canvas){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(1, Math.floor(rect.width * dpr));
    canvas.height = Math.max(1, Math.floor(rect.height * dpr));
    const ctx = canvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return ctx;
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  const I18N = {
    ar: {
      reportTitle:"KRS INVITE â€” Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù†Ø§Ø³Ø¨Ø©",
      reportSub:"ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØªØ­Ù‚Ù‚ â€” Ù†Ø³Ø®Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆPDF",
      printLabel:"Ø·Ø¨Ø§Ø¹Ø© / PDF",
      langLabel:"English",
      summaryHead:"Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹",
      summaryDesc:"Ø£Ø±Ù‚Ø§Ù… Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆÙ†ÙØ³ÙØ¨ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ­Ù‚Ù‚.",
      donutTitle:"Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± (Checked-in)",
      barTitle:"ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª",
      detailsHead:"ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª (Ø¹ÙŠÙ†Ø©)",
      detailsDesc:"ÙŠØ¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù„ÙˆØ­Ø© â€” ÙˆÙŠÙ…ÙƒÙ† ØªÙˆØ³ÙŠØ¹Ù‡ Ø­Ø³Ø¨ Ø­Ø§Ø¬ØªÙƒ.",
      thCode:"Ø§Ù„ÙƒÙˆØ¯", thOwner:"Ø§Ù„Ø§Ø³Ù…", thStatus:"Ø§Ù„Ø­Ø§Ù„Ø©", thTime:"ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„", thGate:"Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©/Ø§Ù„Ù…ÙˆØ¸Ù",
      insightsHead:"Ø£Ù‡Ù… Ù…Ø§ ÙŠÙ‡Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„",
      insightsDesc:"Ø§Ù„Ø°Ø±ÙˆØ©ØŒ Ø§Ù„Ø¬ÙˆØ¯Ø©ØŒ ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­.",
      peakHead:"Ø°Ø±ÙˆØ© Ø§Ù„Ø­Ø¶ÙˆØ±",
      opsHead:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ´ØºÙŠÙ„ÙŠØ©",
      alertsHead:"ØªÙ†Ø¨ÙŠÙ‡Ø§Øª"
    },
    en: {
      reportTitle:"KRS INVITE â€” Final Event Report",
      reportSub:"Attendance & verification summary â€” Print/PDF ready",
      printLabel:"Print / PDF",
      langLabel:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
      summaryHead:"Quick Summary",
      summaryDesc:"Key numbers and performance ratios for entry verification.",
      donutTitle:"Attendance Ratio (Checked-in)",
      barTitle:"Attendance by Time",
      detailsHead:"Invites Details (Sample)",
      detailsDesc:"Loaded from dashboard â€” expandable as needed.",
      thCode:"Code", thOwner:"Name", thStatus:"Status", thTime:"Check-in Time", thGate:"Gate/Staff",
      insightsHead:"Client Highlights",
      insightsDesc:"Peak, quality, and alerts â€” clearly presented.",
      peakHead:"Peak Window",
      opsHead:"Operational Notes",
      alertsHead:"Alerts"
    }
  };

  let LANG = "ar";

  function statusTag(status){
    const s = String(status||"").toLowerCase();
    const tag = (txt, cls)=>`<span class="tag"><span class="dot ${cls}"></span>${txt}</span>`;
    if(LANG==="ar"){
      if(s==="checked") return tag("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„","good");
      if(s==="unused") return tag("ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…","warn");
      if(s==="manual") return tag("ÙŠØ¯ÙˆÙŠ","warn");
      if(s.startsWith("rejected")||s==="rejected") return tag("Ù…Ø±ÙÙˆØ¶","bad");
      return tag("â€”","");
    }else{
      if(s==="checked") return tag("Checked","good");
      if(s==="unused") return tag("Unused","warn");
      if(s==="manual") return tag("Manual","warn");
      if(s.startsWith("rejected")||s==="rejected") return tag("Rejected","bad");
      return tag("â€”","");
    }
  }

  function applyLang(){
    const t = I18N[LANG];
    document.documentElement.lang = LANG;
    document.documentElement.dir = (LANG==="ar") ? "rtl" : "ltr";

    $("reportTitle").textContent = t.reportTitle;
    $("reportSub").textContent = t.reportSub;
    $("printLabel").textContent = t.printLabel;
    $("langLabel").textContent = t.langLabel;

    $("summaryHead").textContent = t.summaryHead;
    $("summaryDesc").textContent = t.summaryDesc;
    $("donutTitle").textContent = t.donutTitle;
    $("barTitle").textContent = t.barTitle;
    $("detailsHead").textContent = t.detailsHead;
    $("detailsDesc").textContent = t.detailsDesc;

    $("thCode").textContent = t.thCode;
    $("thOwner").textContent = t.thOwner;
    $("thStatus").textContent = t.thStatus;
    $("thTime").textContent = t.thTime;
    $("thGate").textContent = t.thGate;

    $("insightsHead").textContent = t.insightsHead;
    $("insightsDesc").textContent = t.insightsDesc;
    $("peakHead").textContent = t.peakHead;
    $("opsHead").textContent = t.opsHead;
    $("alertsHead").textContent = t.alertsHead;
  }

  function renderHeader(){
    const ev = DATA.event || {};
    $("evNamePill").textContent = (LANG==="ar") ? (ev.name_ar||"â€”") : (ev.name_en||"â€”");
    $("evDatePill").textContent = `${ev.date||"â€”"}`;
    $("generatedStamp").textContent = (LANG==="ar") ? `ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${DATA.generatedAt||"â€”"}` : `Generated: ${DATA.generatedAt||"â€”"}`;
    $("venueLine").textContent = (LANG==="ar") ? (ev.venue_ar||"â€”") : (ev.venue_en||"â€”");
    $("contactLine").textContent = ev.contact || "â€”";

    $("signatureLine").textContent = DATA.brand || "KRS INVITE";
    $("reportIdLine").textContent = `REPORT ID: ${DATA.reportId || "â€”"}`;
    $("verLine").textContent = DATA.version || "v1.1";
    $("genLine").textContent = DATA.generatedAt || "â€”";
  }

  function renderKPIs(){
    const T = DATA.totals || {};
    const total = Math.max(0, Number(T.totalInvites||0));
    const checked = clamp(Number(T.checkedIn||0), 0, total);
    const rejected = Math.max(0, Number(T.rejected||0));
    const manual = Math.max(0, Number(T.manualOverrides||0));
    const unused = Math.max(0, total - checked);

    const attendancePct = pct(checked,total);
    const unusedPct = pct(unused,total);

    const kpiDefs = (LANG==="ar") ? [
      {t:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª", v:formatNumber(total), s:"Total codes"},
      {t:"ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„", v:formatNumber(checked), s:`Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±: ${attendancePct}%`},
      {t:"ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…", v:formatNumber(unused), s:`Ù†Ø³Ø¨Ø© ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${unusedPct}%`},
      {t:"Ù…Ø±ÙÙˆØ¶/ØªÙ†Ø¨ÙŠÙ‡Ø§Øª", v:formatNumber(rejected), s:`Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª ÙŠØ¯ÙˆÙŠØ©: ${formatNumber(manual)}`}
    ] : [
      {t:"Total Invites", v:formatNumber(total), s:"Total codes"},
      {t:"Checked-in", v:formatNumber(checked), s:`Attendance: ${attendancePct}%`},
      {t:"Unused", v:formatNumber(unused), s:`Unused: ${unusedPct}%`},
      {t:"Rejected/Alerts", v:formatNumber(rejected), s:`Manual overrides: ${formatNumber(manual)}`}
    ];

    const grid = $("kpiGrid");
    grid.innerHTML = "";
    for(const k of kpiDefs){
      const el = document.createElement("div");
      el.className = "kpi";
      el.innerHTML = `
        <div class="t">${escapeHtml(k.t)}</div>
        <div class="v">${escapeHtml(k.v)}</div>
        <div class="s">${escapeHtml(k.s)}</div>
      `;
      grid.appendChild(el);
    }

    const q = Number(DATA.insights?.quality ?? 0);
    $("qualityPill").textContent = (LANG==="ar") ? `Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„: ${q}/100` : `Ops Quality: ${q}/100`;
    $("statusPill").textContent = (LANG==="ar") ? "Ø§Ù„Ø­Ø§Ù„Ø©: Ù…ÙƒØªÙ…Ù„" : "Status: Completed";

    $("donutMeta").textContent = (LANG==="ar")
      ? `Ø­Ø¶ÙˆØ±: ${formatNumber(checked)} Â· ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…: ${formatNumber(unused)}`
      : `Checked: ${formatNumber(checked)} Â· Unused: ${formatNumber(unused)}`;

    return { total, checked, rejected, manual, unused, attendancePct };
  }

  function drawDonut(m){
    const canvas = $("donut");
    const ctx = setupCanvas(canvas);
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;
    ctx.clearRect(0,0,w,h);

    const cx = w/2, cy = h/2;
    const r = Math.min(w,h)*0.34;
    const thick = Math.max(16, r*0.30);

    const ratio = m.total ? m.checked/m.total : 0;

    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI*2);
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = thick;
    ctx.lineCap = "round";
    ctx.stroke();

    const grad = ctx.createLinearGradient(cx-r, cy-r, cx+r, cy+r);
    grad.addColorStop(0, "rgba(247,211,122,.95)");
    grad.addColorStop(1, "rgba(207,162,74,.60)");

    const start = -Math.PI/2;
    const end = start + (Math.PI*2*ratio);

    ctx.beginPath();
    ctx.arc(cx, cy, r, start, end);
    ctx.strokeStyle = grad;
    ctx.lineWidth = thick;
    ctx.lineCap = "round";
    ctx.shadowColor = "rgba(247,211,122,.20)";
    ctx.shadowBlur = 18;
    ctx.stroke();
    ctx.shadowBlur = 0;

    ctx.fillStyle = "rgba(233,238,247,.95)";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.font = "1000 34px " + getFont();
    ctx.fillText(`${m.attendancePct}%`, cx, cy - 10);

    ctx.fillStyle = "rgba(168,179,198,.95)";
    ctx.font = "1000 13px " + getFont();
    const sub = (LANG==="ar") ? `ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ ${formatNumber(m.checked)} Ù…Ù† ${formatNumber(m.total)}` : `${formatNumber(m.checked)} of ${formatNumber(m.total)} checked`;
    ctx.fillText(sub, cx, cy + 22);
  }

  function drawBars(){
    const canvas = $("bars");
    const ctx = setupCanvas(canvas);
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;
    ctx.clearRect(0,0,w,h);

    const pad = 18;
    const chartW = w - pad*2;
    const chartH = h - pad*2 - 18;

    const tl = Array.isArray(DATA.timeline) ? DATA.timeline : [];
    const maxV = Math.max(1, ...tl.map(x=>Number(x.count)||0));
    const barCount = Math.max(1, tl.length);
    const gap = 8;
    const barW = (chartW - gap*(barCount-1)) / barCount;

    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(pad, pad + chartH);
    ctx.lineTo(pad + chartW, pad + chartH);
    ctx.stroke();

    for(let i=0;i<tl.length;i++){
      const v = Number(tl[i].count)||0;
      const x = pad + i*(barW+gap);
      const bh = (v/maxV) * (chartH - 8);
      const y = pad + chartH - bh;

      const g = ctx.createLinearGradient(x, y, x, y+bh);
      g.addColorStop(0, "rgba(247,211,122,.75)");
      g.addColorStop(1, "rgba(255,255,255,.08)");

      roundRect(ctx, x, y, barW, bh, 10);
      ctx.fillStyle = g;
      ctx.fill();

      ctx.fillStyle = "rgba(233,238,247,.9)";
      ctx.font = "1000 11px " + getFont();
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.fillText(String(v), x + barW/2, y - 6);

      if(i % 2 === 0){
        ctx.fillStyle = "rgba(168,179,198,.9)";
        ctx.font = "1000 11px " + getFont();
        ctx.textBaseline = "top";
        ctx.fillText(String(tl[i].label||""), x + barW/2, pad + chartH + 6);
      }
    }

    const sum = tl.reduce((a,x)=>a+(Number(x.count)||0),0);
    const windows = Math.max(1, tl.length);
    const avgPerWindow = Math.round(sum/windows);
    const estPerHour = Math.round(avgPerWindow*4);

    $("barMeta").textContent = (LANG==="ar")
      ? `Ù…ØªÙˆØ³Ø·/Ù†Ø§ÙØ°Ø©: ${formatNumber(avgPerWindow)} Â· ØªÙ‚Ø¯ÙŠØ±ÙŠ/Ø³Ø§Ø¹Ø©: ${formatNumber(estPerHour)}`
      : `Avg/window: ${formatNumber(avgPerWindow)} Â· Est/hour: ${formatNumber(estPerHour)}`;
  }

  function renderTable(){
    const rows = Array.isArray(DATA.rowsSample) ? DATA.rowsSample : [];
    $("detailsCount").textContent = (LANG==="ar") ? `Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${rows.length}` : `Rows: ${rows.length}`;
    const tb = $("tbody");
    tb.innerHTML = "";
    for(const r of rows){
      const owner = (LANG==="ar") ? (r.owner_ar||"â€”") : (r.owner_en||"â€”");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(r.code||"â€”")}</td>
        <td>${escapeHtml(owner)}</td>
        <td>${statusTag(r.status)}</td>
        <td class="mono">${escapeHtml(r.time||"â€”")}</td>
        <td>${escapeHtml(r.gate||"â€”")}</td>
      `;
      tb.appendChild(tr);
    }
  }

  function renderInsights(){
    const peak = DATA.insights?.peak || {label:"â€”", count:0};
    $("peakText").innerHTML = (LANG==="ar")
      ? `Ø£Ø¹Ù„Ù‰ Ø°Ø±ÙˆØ© ÙƒØ§Ù†Øª Ø¹Ù†Ø¯ <strong>${escapeHtml(peak.label||"â€”")}</strong> Ø¨Ø¹Ø¯Ø¯ <strong>${formatNumber(peak.count||0)}</strong> Ø¯Ø®ÙˆÙ„.`
      : `Peak window: <strong>${escapeHtml(peak.label||"â€”")}</strong> with <strong>${formatNumber(peak.count||0)}</strong> entries.`;

    const ops = $("opsList");
    ops.innerHTML = "";
    const opsItems = (LANG==="ar")
      ? ["ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø­Ø¯Ø« Ø§Ù„Ù…Ø®ØªØ§Ø± Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….", "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø­ÙØ¸ PDF.", "ÙŠÙˆØµÙ‰ Ø¨Ø­ÙØ¸ Ù†Ø³Ø®Ø© PDF Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©."]
      : ["Report generated for the selected event from dashboard.", "Print/PDF ready layout.", "Recommended: save as PDF right after the event."];
    for(const it of opsItems){
      const li = document.createElement("li");
      li.innerHTML = it;
      ops.appendChild(li);
    }

    const alerts = $("alertsList");
    alerts.innerHTML = "";
    const T = DATA.totals || {};
    const rejected = Number(T.rejected||0);
    const manual = Number(T.manualOverrides||0);

    const alertsItems = (LANG==="ar")
      ? [`Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø±ÙÙˆØ¶Ø©: <strong>${formatNumber(rejected)}</strong>`, `Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª ÙŠØ¯ÙˆÙŠØ©: <strong>${formatNumber(manual)}</strong>`]
      : [`Rejected attempts: <strong>${formatNumber(rejected)}</strong>`, `Manual overrides: <strong>${formatNumber(manual)}</strong>`];
    for(const it of alertsItems){
      const li = document.createElement("li");
      li.innerHTML = it;
      alerts.appendChild(li);
    }
  }

  function load(){
    try{
      const raw = localStorage.getItem(REPORT_STORE);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || typeof obj !== "object") return null;
      return obj;
    }catch(e){ return null; }
  }

  function renderAll(){
    applyLang();
    renderHeader();
    const metrics = renderKPIs();
    requestAnimationFrame(()=>{
      drawDonut(metrics);
      drawBars();
    });
    renderTable();
    renderInsights();
  }

  function boot(){
    DATA = load();
    if(!DATA){
      document.body.innerHTML = `
        <div style="min-height:100vh;display:grid;place-items:center;padding:24px;color:#111;">
          <div style="width:min(800px,96vw);background:#fff;border:1px solid #ddd;border-radius:18px;padding:18px;font-family:system-ui;">
            <h2 style="margin:0 0 8px;">No report data found</h2>
            <p style="margin:0;color:#444;line-height:1.6;">
              Ø§ÙØªØ­ <b>krs-dashboard.html</b> ÙˆØ§Ø®ØªØ± Ø§Ù„Ø­Ø¯Ø« Ø«Ù… Ø§Ø¶ØºØ· <b>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¯Ø«</b>.<br>
              Open <b>krs-dashboard.html</b>, select an event, then click <b>Event Report</b>.
            </p>
          </div>
        </div>
      `;
      return;
    }

    LANG = (DATA.languageDefault === "en") ? "en" : "ar";
    $("langToggle").addEventListener("click", ()=>{
      LANG = (LANG==="ar") ? "en" : "ar";
      DATA.languageDefault = LANG;
      localStorage.setItem(REPORT_STORE, JSON.stringify(DATA));
      renderAll();
    });
    $("printBtn").addEventListener("click", ()=> window.print());

    renderAll();

    let t=null;
    window.addEventListener("resize", ()=>{
      clearTimeout(t);
      t=setTimeout(()=>renderAll(), 180);
    });
  }

  boot();
})();
</script>
</body>
</html>
