<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KRS INVITE â€” Dashboard</title>
  <style>
    :root{
      --bg1:#070A12; --bg2:#0B1020;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);
      --ink:#E9EEF7; --muted:#A8B3C6;

      --gold1:#F7D37A; --gold2:#CFA24A;
      --good:#39d98a; --warn:#ffce4a; --bad:#ff5c7a;

      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 18px; --radius2: 28px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans Arabic", "Tahoma", Arial, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --g: linear-gradient(135deg, rgba(247,211,122,.18), rgba(207,162,74,.08), rgba(255,255,255,.02));
      --glow: 0 0 0 1px rgba(247,211,122,.08), 0 0 60px rgba(247,211,122,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font); color:var(--ink);
      background:
        radial-gradient(1200px 700px at 80% -10%, rgba(247,211,122,.20), transparent 60%),
        radial-gradient(900px 520px at 20% 0%, rgba(90,120,255,.12), transparent 55%),
        radial-gradient(900px 520px at 60% 110%, rgba(255,92,122,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    .wrap{ width:min(1280px, 94vw); margin: 26px auto 60px; }
    .topbar{
      display:flex; gap:14px; align-items:stretch; justify-content:space-between; margin-bottom:16px;
    }
    .brandCard{
      flex:1; padding:18px; border-radius: var(--radius2);
      background: var(--g); border: 1px solid var(--stroke); box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    .brandCard:before{
      content:""; position:absolute; inset:-1px;
      background:
        radial-gradient(600px 140px at 70% 0%, rgba(247,211,122,.35), transparent 60%),
        radial-gradient(500px 260px at 15% 110%, rgba(120,180,255,.18), transparent 65%);
      opacity:.85; pointer-events:none;
    }
    .brandRow{ position:relative; display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brandLeft{ display:flex; align-items:center; gap:14px; min-width: 280px;}
    .logo{
      width:56px;height:56px;border-radius:18px;
      background: linear-gradient(135deg, rgba(247,211,122,.34), rgba(207,162,74,.16), rgba(255,255,255,.04));
      border: 1px solid rgba(247,211,122,.22);
      box-shadow: var(--glow);
      display:grid; place-items:center; overflow:hidden;
      position:relative;
    }
    .logo:after{
      content:""; position:absolute; inset:0;
      background:
        radial-gradient(32px 32px at 30% 35%, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(80px 60px at 70% 80%, rgba(247,211,122,.18), transparent 60%);
      pointer-events:none;
    }
    .logo span{ position:relative; font-weight:1000; color:var(--gold1); letter-spacing:.6px; }
    .brandTitle h1{ margin:0; font-size:18px; font-weight:1000;}
    .brandTitle p{ margin:6px 0 0; color:var(--muted); font-size:12.5px; line-height:1.35;}
    .brandRight{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-end; }
    .pill{
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      color: var(--muted); font-size: 12px; font-weight:900;
      white-space:nowrap;
    }
    .pill strong{ color: var(--ink); }
    .btn{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      padding:10px 12px; border-radius: 14px;
      cursor:pointer; font-weight:1000; font-size: 13px;
      display:flex; gap:8px; align-items:center;
      transition:.18s ease; user-select:none; white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); }
    .btn.primary{
      border-color: rgba(247,211,122,.30);
      background: linear-gradient(135deg, rgba(247,211,122,.26), rgba(207,162,74,.10));
      box-shadow: var(--glow);
    }
    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(247,211,122,.22), rgba(255,255,255,.10), transparent);
      margin: 14px 0 0;
      opacity:.9;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      border-radius: var(--radius2);
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding:16px 16px 12px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(135deg, rgba(255,255,255,.05), rgba(247,211,122,.06));
    }
    .card .head h2{ margin:0; font-size:14.5px; font-weight:1000;}
    .card .head p{ margin:6px 0 0; color:var(--muted); font-size:12.5px; line-height:1.35;}
    .card .body{ padding:16px; }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){ .kpis{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .kpis{grid-template-columns: 1fr;} }

    .kpi{
      border-radius: 18px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.10);
      padding: 14px;
      position:relative;
      overflow:hidden;
      min-height: 92px;
    }
    .kpi:before{
      content:""; position:absolute; inset:-1px;
      background:
        radial-gradient(260px 140px at 10% 10%, rgba(247,211,122,.18), transparent 60%),
        radial-gradient(200px 120px at 90% 70%, rgba(120,180,255,.12), transparent 60%);
      opacity:.8; pointer-events:none;
    }
    .kpi .t{ position:relative; color:var(--muted); font-size:12px; font-weight:1000; }
    .kpi .v{ position:relative; margin-top:8px; font-size:22px; font-weight:1000; letter-spacing:.2px; }
    .kpi .s{ position:relative; margin-top:6px; font-size:12px; color:var(--muted); }
    .kpi .badge{
      position:absolute; inset:auto 10px 10px auto;
      border-radius:999px;
      padding:6px 10px;
      font-size: 11px;
      font-weight:1000;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--ink);
    }
    .b-good{ border-color: rgba(57,217,138,.30)!important; background: rgba(57,217,138,.10)!important; }
    .b-warn{ border-color: rgba(255,206,74,.30)!important; background: rgba(255,206,74,.10)!important; }
    .b-bad{  border-color: rgba(255,92,122,.30)!important; background: rgba(255,92,122,.10)!important; }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 980px){ .controls{grid-template-columns:1fr} }

    .field{
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
    }
    .field label{
      display:block; font-size:12px; color:var(--muted); font-weight:1000; margin-bottom:8px;
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input[type="text"], input[type="number"], select{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      outline:none;
      font-weight:900;
    }
    input::placeholder{ color: rgba(168,179,198,.7); }
    .small{ font-size:12px; color:var(--muted); line-height:1.4; margin-top:8px; }
    .mono{ font-family: var(--mono); }

    .charts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top: 12px;
    }
    @media (max-width: 980px){ .charts{grid-template-columns:1fr;} }
    .chartBox{
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      padding: 14px;
      overflow:hidden;
    }
    .chartTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; }
    .chartTop .title{ font-weight: 1000; font-size: 12.5px; color: var(--ink); }
    .chartTop .meta{ font-weight: 900; font-size: 12px; color: var(--muted); white-space:nowrap; }

    canvas{ width:100%; height: 220px; display:block; }

    .tableWrap{
      margin-top: 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: rgba(0,0,0,.16);
    }
    table{ width:100%; border-collapse:collapse; font-size: 12.5px; }
    thead th{
      background: rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.10);
      text-align:start;
      padding: 12px 10px;
      font-weight: 1000;
      color: var(--ink);
    }
    tbody td{
      padding: 11px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      color: var(--ink);
      vertical-align:top;
    }
    tbody tr:hover{ background: rgba(255,255,255,.04); }

    .tag{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:1000;
      font-size: 11px;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--muted);display:inline-block}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .footer{
      margin-top: 14px;
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center; justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
    }
    .stamp{
      padding: 8px 12px; border-radius: 999px;
      border: 1px solid rgba(247,211,122,.22);
      background: rgba(247,211,122,.10);
      color: var(--gold1);
      font-weight:1000;
    }

    .toast{
      position:fixed;
      inset:auto 18px 18px 18px;
      max-width: 680px;
      margin:auto;
      background: rgba(0,0,0,.70);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding: 12px 14px;
      color: var(--ink);
      box-shadow: var(--shadow);
      display:none;
      z-index: 9999;
    }
    .toast.show{ display:block; }
    .toast b{ color: var(--gold1); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brandCard">
        <div class="brandRow">
          <div class="brandLeft">
            <div class="logo"><span>KRS</span></div>
            <div class="brandTitle">
              <h1 id="title">KRS INVITE â€” Dashboard</h1>
              <p id="subtitle">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ÙØ§Ø®Ø±Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„Ø­Ø¶ÙˆØ± + ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©</p>
            </div>
          </div>
          <div class="brandRight">
            <span class="pill"><strong id="evPill">â€”</strong> Â· <span id="datePill">â€”</span></span>
            <button class="btn" id="langBtn">ğŸŒ <span id="langText">English</span></button>
            <button class="btn" id="resetBtn" title="Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">ğŸ§¹ <span id="resetText">Reset</span></button>
            <button class="btn primary" id="reportBtn" title="ÙØªØ­ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ">ğŸ“„ <span id="reportText">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span></button>
          </div>
        </div>
        <div class="divider"></div>
        <div class="footer" style="margin-top:12px">
          <div class="stamp" id="stamp">ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: â€”</div>
          <div class="mono" id="storeKey">STORE: â€”</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Left -->
      <div class="card">
        <div class="head">
          <div>
            <h2 id="summaryHead">Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
            <p id="summaryDesc">Ø£Ø±Ù‚Ø§Ù… Ø­ÙŠØ© + Ø±Ø³ÙˆÙ… + Ø¬Ø¯ÙˆÙ„ØŒ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV ÙˆØªØµØ¯ÙŠØ±.</p>
          </div>
          <span class="pill" id="qualityPill">â€”</span>
        </div>

        <div class="body">
          <div class="kpis" id="kpiGrid"></div>

          <div class="charts">
            <div class="chartBox">
              <div class="chartTop">
                <div class="title" id="donutTitle">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div>
                <div class="meta" id="donutMeta">â€”</div>
              </div>
              <canvas id="donut"></canvas>
            </div>
            <div class="chartBox">
              <div class="chartTop">
                <div class="title" id="barTitle">Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª</div>
                <div class="meta" id="barMeta">â€”</div>
              </div>
              <canvas id="bars"></canvas>
            </div>
          </div>

          <div class="controls">
            <div class="field">
              <label id="evLabel">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</label>
              <div class="row">
                <div style="flex:1; min-width:220px">
                  <input id="eventName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯" />
                </div>
                <div style="flex:1; min-width:220px">
                  <input id="eventDate" type="text" placeholder="15-01-2026 Â· 5:30 PM â€“ 11:30 PM" />
                </div>
              </div>
              <div class="row" style="margin-top:10px">
                <div style="flex:1; min-width:220px">
                  <input id="venue" type="text" placeholder="Ø¯Ø¨ÙŠ â€” Ù‚Ø§Ø¹Ø© ..." />
                </div>
                <div style="flex:1; min-width:220px">
                  <input id="contact" type="text" placeholder="WhatsApp / Email" />
                </div>
              </div>
              <div class="small" id="evHint">Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
            </div>

            <div class="field">
              <label id="dataLabel">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ±)</label>
              <div class="row">
                <input id="csvFile" type="file" accept=".csv,text/csv" style="flex:1" />
                <button class="btn" id="importBtn">â¬†ï¸ <span id="importText">Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV</span></button>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn" id="sampleBtn">âœ¨ <span id="sampleText">ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</span></button>
                <button class="btn" id="exportBtn">â¬‡ï¸ <span id="exportText">ØªØµØ¯ÙŠØ± CSV</span></button>
                <button class="btn" id="saveBtn">ğŸ’¾ <span id="saveText">Ø­ÙØ¸</span></button>
              </div>
              <div class="small mono" id="csvHint">
                CSV columns (recommended): Code,Owner,Status,Time,Gate,EventName
              </div>
            </div>
          </div>

          <div class="field" style="margin-top:12px">
            <label id="filterLabel">ÙÙ„ØªØ±Ø© / Ø¨Ø­Ø«</label>
            <div class="row">
              <input id="search" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…..." style="flex:1; min-width:240px" />
              <select id="statusFilter" style="width:220px">
                <option value="all">Ø§Ù„ÙƒÙ„</option>
                <option value="checked">ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„</option>
                <option value="unused">ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…</option>
                <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
                <option value="manual">ÙŠØ¯ÙˆÙŠ</option>
              </select>
            </div>
            <div class="small" id="filterHint">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ø¯Ù†Ø§Ù‡ ÙŠØªØºÙŠØ± Ù…Ø¨Ø§Ø´Ø±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ±.</div>
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th id="thCode">Ø§Ù„ÙƒÙˆØ¯</th>
                  <th id="thOwner">Ø§Ù„Ø§Ø³Ù…</th>
                  <th id="thStatus">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th id="thTime">ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                  <th id="thGate">Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©/Ø§Ù„Ù…ÙˆØ¸Ù</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="footer">
            <div class="stamp" id="countLine">â€”</div>
            <div class="mono" id="noteLine">KRS INVITE</div>
          </div>
        </div>
      </div>

      <!-- Right -->
      <div class="card">
        <div class="head">
          <div>
            <h2 id="opsHead">Ø£Ø¯ÙˆØ§Øª Ø³Ø±ÙŠØ¹Ø©</h2>
            <p id="opsDesc">Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø© + ØªÙˆÙ„ÙŠØ¯ Ø£ÙˆÙ‚Ø§Øª + ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª.</p>
          </div>
          <span class="pill" id="opsPill">â€”</span>
        </div>
        <div class="body">
          <div class="field">
            <label id="addLabel">Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø³Ø±ÙŠØ¹</label>
            <div class="row">
              <input id="addCode" type="text" placeholder="Code (Ù…Ø«Ø§Ù„: KRS_301)" style="flex:1; min-width:220px" />
              <input id="addOwner" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ" style="flex:1; min-width:220px" />
            </div>
            <div class="row" style="margin-top:10px">
              <select id="addStatus" style="flex:1; min-width:220px">
                <option value="checked">ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„</option>
                <option value="unused">ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…</option>
                <option value="rejected_duplicate">Ù…ÙƒØ±Ø±</option>
                <option value="rejected_invalid">ØºÙŠØ± ØµØ§Ù„Ø­</option>
                <option value="manual">ÙŠØ¯ÙˆÙŠ</option>
              </select>
              <input id="addTime" type="text" placeholder="Time (Ù…Ø«Ø§Ù„: 6:22 PM)" style="flex:1; min-width:220px" />
            </div>
            <div class="row" style="margin-top:10px">
              <input id="addGate" type="text" placeholder="Gate/Staff" style="flex:1; min-width:220px" />
              <button class="btn primary" id="addBtn">â• <span id="addText">Ø¥Ø¶Ø§ÙØ©</span></button>
            </div>
            <div class="small" id="addHint">Ø¹Ù†Ø¯ ØªØ±Ùƒ Ø§Ù„ÙˆÙ‚Øª ÙØ§Ø±ØºØ§Ù‹ Ø³ÙŠØªÙ… ÙˆØ¶Ø¹ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
          </div>

          <div class="field" style="margin-top:12px">
            <label id="toolsLabel">Ø£Ø¯ÙˆØ§Øª</label>
            <div class="row">
              <button class="btn" id="normalizeBtn">ğŸ§¼ <span id="normalizeText">ØªÙ†Ø¸ÙŠÙ/ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span></button>
              <button class="btn" id="autoTimeBtn">â±ï¸ <span id="autoTimeText">ØªÙˆÙ„ÙŠØ¯ Timeline ØªÙ„Ù‚Ø§Ø¦ÙŠ</span></button>
            </div>
            <div class="small" id="toolsHint">
              "Timeline" ÙŠØ³ØªØ®Ø¯Ù… Ù„Ø±Ø³ÙˆÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.
            </div>
          </div>

          <div class="field" style="margin-top:12px">
            <label id="aboutLabel">Ù…Ù‡Ù…</label>
            <div class="small" id="aboutText">
              - Ø§ÙØªØ­ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø²Ø± ğŸ“„ ÙˆØ³ÙŠÙ‚Ø±Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù„ÙˆØ­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.<br>
              - Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù…Ù„Ù Excel: Ø§Ø­ÙØ¸Ù‡ CSV Ø«Ù… Ø§Ø³ØªÙˆØ±Ø¯Ù‡ Ù‡Ù†Ø§.<br>
              - Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©: Code,Owner,Status,Time,Gate,EventName
            </div>
          </div>

          <div class="footer">
            <div class="mono" id="versionLine">v1.0</div>
            <div class="mono" id="storageLine">localStorage</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  "use strict";

  const STORE_KEY = "KRS_INVITE_DATA_V1";
  const DEFAULT_LANG = "ar";
  let LANG = DEFAULT_LANG;

  const $ = (id) => document.getElementById(id);

  const I18N = {
    ar: {
      title: "KRS INVITE â€” Dashboard",
      subtitle: "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ÙØ§Ø®Ø±Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆØ§Ù„Ø­Ø¶ÙˆØ± + ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©",
      summaryHead: "Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª",
      summaryDesc: "Ø£Ø±Ù‚Ø§Ù… Ø­ÙŠØ© + Ø±Ø³ÙˆÙ… + Ø¬Ø¯ÙˆÙ„ØŒ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV ÙˆØªØµØ¯ÙŠØ±.",
      donutTitle: "Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±",
      barTitle: "Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª",
      evLabel: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©",
      evHint: "Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.",
      dataLabel: "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ±)",
      importText: "Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV",
      sampleText: "ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©",
      exportText: "ØªØµØ¯ÙŠØ± CSV",
      saveText: "Ø­ÙØ¸",
      filterLabel: "ÙÙ„ØªØ±Ø© / Ø¨Ø­Ø«",
      filterHint: "Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ø¯Ù†Ø§Ù‡ ÙŠØªØºÙŠØ± Ù…Ø¨Ø§Ø´Ø±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ±.",
      thCode: "Ø§Ù„ÙƒÙˆØ¯",
      thOwner: "Ø§Ù„Ø§Ø³Ù…",
      thStatus: "Ø§Ù„Ø­Ø§Ù„Ø©",
      thTime: "ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„",
      thGate: "Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©/Ø§Ù„Ù…ÙˆØ¸Ù",
      opsHead: "Ø£Ø¯ÙˆØ§Øª Ø³Ø±ÙŠØ¹Ø©",
      opsDesc: "Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø© + ØªÙˆÙ„ÙŠØ¯ Ø£ÙˆÙ‚Ø§Øª + ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª.",
      addLabel: "Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø³Ø±ÙŠØ¹",
      addText: "Ø¥Ø¶Ø§ÙØ©",
      addHint: "Ø¹Ù†Ø¯ ØªØ±Ùƒ Ø§Ù„ÙˆÙ‚Øª ÙØ§Ø±ØºØ§Ù‹ Ø³ÙŠØªÙ… ÙˆØ¶Ø¹ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.",
      toolsLabel: "Ø£Ø¯ÙˆØ§Øª",
      normalizeText: "ØªÙ†Ø¸ÙŠÙ/ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
      autoTimeText: "ØªÙˆÙ„ÙŠØ¯ Timeline ØªÙ„Ù‚Ø§Ø¦ÙŠ",
      toolsHint: "\"Timeline\" ÙŠØ³ØªØ®Ø¯Ù… Ù„Ø±Ø³ÙˆÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.",
      aboutLabel: "Ù…Ù‡Ù…",
      reportText: "ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ",
      resetText: "Reset",
      langText: "English"
    },
    en: {
      title: "KRS INVITE â€” Dashboard",
      subtitle: "Luxury dashboard for invites & attendance + final report generator (Print/PDF)",
      summaryHead: "Live Summary",
      summaryDesc: "KPIs + charts + table, with CSV import/export support.",
      donutTitle: "Attendance Ratio",
      barTitle: "Attendance by Time",
      evLabel: "Event Info",
      evHint: "This information will appear automatically in the final report.",
      dataLabel: "Data (Import/Export)",
      importText: "Import CSV",
      sampleText: "Load sample data",
      exportText: "Export CSV",
      saveText: "Save",
      filterLabel: "Filter / Search",
      filterHint: "The table updates instantly based on filters.",
      thCode: "Code",
      thOwner: "Name",
      thStatus: "Status",
      thTime: "Check-in Time",
      thGate: "Gate/Staff",
      opsHead: "Quick Tools",
      opsDesc: "Quick add + timeline + clean data.",
      addLabel: "Quick Add Row",
      addText: "Add",
      addHint: "If time is empty, current time will be used.",
      toolsLabel: "Tools",
      normalizeText: "Normalize/Clean Data",
      autoTimeText: "Auto-generate Timeline",
      toolsHint: "Timeline is used for time distribution charts in the report.",
      aboutLabel: "Important",
      reportText: "Generate Final Report",
      resetText: "Reset",
      langText: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"
    }
  };

  function toast(msg){
    const el = $("toast");
    el.innerHTML = msg;
    el.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> el.classList.remove("show"), 2400);
  }

  function nowStamp(){
    const d = new Date();
    const pad=(n)=>String(n).padStart(2,"0");
    const dd=pad(d.getDate()), mm=pad(d.getMonth()+1), yyyy=d.getFullYear();
    let hh=d.getHours(); const min=pad(d.getMinutes());
    const ampm = hh>=12 ? "PM":"AM";
    hh = hh%12; if(hh===0) hh=12;
    return `${dd}-${mm}-${yyyy}  ${hh}:${min} ${ampm}`;
  }
  function formatNumber(n){ return (n??0).toLocaleString("en-US"); }
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function pct(n,d){ if(!d) return 0; return Math.round((n/d)*1000)/10; }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function statusTag(status){
    const ar = (t, cls) => `<span class="tag"><span class="dot ${cls}"></span>${t}</span>`;
    const en = (t, cls) => `<span class="tag"><span class="dot ${cls}"></span>${t}</span>`;
    const s = String(status||"").toLowerCase();

    if(LANG==="ar"){
      if(s==="checked") return ar("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„","good");
      if(s==="unused") return ar("ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…","warn");
      if(s==="manual") return ar("ÙŠØ¯ÙˆÙŠ","warn");
      if(s==="rejected_duplicate") return ar("Ù…ÙƒØ±Ø±","bad");
      if(s==="rejected_invalid") return ar("ØºÙŠØ± ØµØ§Ù„Ø­","bad");
      if(s==="rejected") return ar("Ù…Ø±ÙÙˆØ¶","bad");
      return ar("â€”","");
    }else{
      if(s==="checked") return en("Checked","good");
      if(s==="unused") return en("Unused","warn");
      if(s==="manual") return en("Manual","warn");
      if(s==="rejected_duplicate") return en("Duplicate","bad");
      if(s==="rejected_invalid") return en("Invalid","bad");
      if(s==="rejected") return en("Rejected","bad");
      return en("â€”","");
    }
  }

  function normalizeStatus(s){
    s = String(s||"").trim().toLowerCase();
    if(!s) return "unused";
    if(["yes","y","checked","check","checkin","checked-in","in","used"].includes(s)) return "checked";
    if(["no","n","unused","notused","not-used","pending"].includes(s)) return "unused";
    if(["manual","override"].includes(s)) return "manual";
    if(["dup","duplicate","rejected_duplicate"].includes(s)) return "rejected_duplicate";
    if(["invalid","rejected_invalid"].includes(s)) return "rejected_invalid";
    if(["rejected","Ø±ÙØ¶","Ù…Ø±ÙÙˆØ¶"].includes(s)) return "rejected";
    return s;
  }

  function safeText(s){ return String(s ?? "").trim(); }

  function parseTimeToMinutes(t){
    // expects like "6:22 PM" or "18:22"
    const s = String(t||"").trim();
    if(!s) return null;
    let m = s.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
    if(m){
      let hh = parseInt(m[1],10);
      const mm = parseInt(m[2],10);
      const ap = m[3].toUpperCase();
      if(ap==="PM" && hh!==12) hh+=12;
      if(ap==="AM" && hh===12) hh=0;
      return hh*60 + mm;
    }
    m = s.match(/^(\d{1,2}):(\d{2})$/);
    if(m){
      const hh=parseInt(m[1],10), mm=parseInt(m[2],10);
      return hh*60 + mm;
    }
    return null;
  }

  function minutesToLabel(min){
    min = Math.max(0, Math.min(24*60-1, min));
    let hh = Math.floor(min/60);
    const mm = String(min%60).padStart(2,"0");
    const ap = hh>=12 ? "PM":"AM";
    hh = hh%12; if(hh===0) hh=12;
    return `${hh}:${mm} ${ap}`;
  }

  function setupCanvas(canvas){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(1, Math.floor(rect.width * dpr));
    canvas.height = Math.max(1, Math.floor(rect.height * dpr));
    const ctx = canvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return ctx;
  }

  function drawDonut({checked,total,unused}){
    const canvas = $("donut");
    const ctx = setupCanvas(canvas);
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;
    ctx.clearRect(0,0,w,h);

    const cx = w/2, cy = h/2;
    const r = Math.min(w,h)*0.33;
    const thick = Math.max(14, r*0.30);

    const ratio = total ? checked/total : 0;

    // bg ring
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI*2);
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = thick;
    ctx.lineCap = "round";
    ctx.stroke();

    const grad = ctx.createLinearGradient(cx-r, cy-r, cx+r, cy+r);
    grad.addColorStop(0, "rgba(247,211,122,.95)");
    grad.addColorStop(1, "rgba(207,162,74,.55)");

    const start = -Math.PI/2;
    const end = start + (Math.PI*2*ratio);

    ctx.beginPath();
    ctx.arc(cx, cy, r, start, end);
    ctx.strokeStyle = grad;
    ctx.lineWidth = thick;
    ctx.lineCap = "round";
    ctx.shadowColor = "rgba(247,211,122,.20)";
    ctx.shadowBlur = 16;
    ctx.stroke();
    ctx.shadowBlur = 0;

    const attendancePct = pct(checked,total);

    ctx.fillStyle = "rgba(233,238,247,.95)";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.font = "1000 34px " + getComputedStyle(document.documentElement).getPropertyValue("--font").trim();
    ctx.fillText(`${attendancePct}%`, cx, cy - 8);

    ctx.fillStyle = "rgba(168,179,198,.95)";
    ctx.font = "1000 12.5px " + getComputedStyle(document.documentElement).getPropertyValue("--font").trim();
    const sub = (LANG==="ar") ? `ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ ${formatNumber(checked)} Ù…Ù† ${formatNumber(total)}` : `${formatNumber(checked)} of ${formatNumber(total)} checked`;
    ctx.fillText(sub, cx, cy + 22);

    $("donutMeta").textContent = (LANG==="ar")
      ? `Ø­Ø¶ÙˆØ±: ${formatNumber(checked)} Â· ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…: ${formatNumber(unused)}`
      : `Checked: ${formatNumber(checked)} Â· Unused: ${formatNumber(unused)}`;
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function drawBars(timeline){
    const canvas = $("bars");
    const ctx = setupCanvas(canvas);
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;
    ctx.clearRect(0,0,w,h);

    const pad = 18;
    const chartW = w - pad*2;
    const chartH = h - pad*2 - 18;

    const tl = Array.isArray(timeline) ? timeline : [];
    const maxV = Math.max(1, ...tl.map(x=>Number(x.count)||0));
    const barCount = Math.max(1, tl.length);
    const gap = 8;
    const barW = (chartW - gap*(barCount-1)) / barCount;

    // baseline
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(pad, pad + chartH);
    ctx.lineTo(pad + chartW, pad + chartH);
    ctx.stroke();

    for(let i=0;i<tl.length;i++){
      const v = Number(tl[i].count)||0;
      const x = pad + i*(barW+gap);
      const bh = (v/maxV) * (chartH - 8);
      const y = pad + chartH - bh;

      const g = ctx.createLinearGradient(x, y, x, y+bh);
      g.addColorStop(0, "rgba(247,211,122,.75)");
      g.addColorStop(1, "rgba(255,255,255,.08)");

      roundRect(ctx, x, y, barW, bh, 10);
      ctx.fillStyle = g;
      ctx.fill();

      ctx.fillStyle = "rgba(233,238,247,.9)";
      ctx.font = "1000 11px " + getComputedStyle(document.documentElement).getPropertyValue("--font").trim();
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.fillText(String(v), x + barW/2, y - 6);

      if(i % 2 === 0){
        ctx.fillStyle = "rgba(168,179,198,.9)";
        ctx.font = "1000 11px " + getComputedStyle(document.documentElement).getPropertyValue("--font").trim();
        ctx.textBaseline = "top";
        ctx.fillText(String(tl[i].label||""), x + barW/2, pad + chartH + 6);
      }
    }

    const sum = tl.reduce((a,x)=>a+(Number(x.count)||0),0);
    const windows = Math.max(1, tl.length);
    const avgPerWindow = Math.round(sum/windows);
    const estPerHour = Math.round(avgPerWindow*4);

    $("barMeta").textContent = (LANG==="ar")
      ? `Ù…ØªÙˆØ³Ø·/Ù†Ø§ÙØ°Ø©: ${formatNumber(avgPerWindow)} Â· ØªÙ‚Ø¯ÙŠØ±ÙŠ/Ø³Ø§Ø¹Ø©: ${formatNumber(estPerHour)}`
      : `Avg/window: ${formatNumber(avgPerWindow)} Â· Est/hour: ${formatNumber(estPerHour)}`;
  }

  function computeMetrics(data){
    const rows = data.rows || [];
    const total = Math.max(0, Number(data.totals?.totalInvites || rows.length || 0));
    const checked = rows.filter(r=>r.status==="checked").length;
    const rejected = rows.filter(r=>String(r.status).startsWith("rejected") || r.status==="rejected").length;
    const manual = rows.filter(r=>r.status==="manual").length;
    const unused = Math.max(0, total - checked);

    const attendancePct = pct(checked,total);
    const unusedPct = pct(unused,total);

    // quality score
    const dupPenalty = Math.min(20, rejected*2);
    const coverageBonus = Math.min(60, attendancePct*0.6);
    const stabilityBonus = 20;
    const quality = clamp(Math.round(coverageBonus + stabilityBonus - dupPenalty), 0, 100);

    return { total, checked, rejected, manual, unused, attendancePct, unusedPct, quality };
  }

  function computeTimelineFromRows(rows){
    // build 15-min buckets from check-in times of checked rows
    const mins = rows
      .filter(r=>r.status==="checked" && r.time)
      .map(r=>parseTimeToMinutes(r.time))
      .filter(v=>v!==null);

    if(mins.length < 3){
      // fallback small default
      return [
        {label:"5:30",count:6},{label:"5:45",count:14},{label:"6:00",count:22},
        {label:"6:15",count:28},{label:"6:30",count:33},{label:"6:45",count:29},
      ];
    }

    const minM = Math.min(...mins);
    const maxM = Math.max(...mins);
    const start = Math.floor(minM/15)*15;
    const end = Math.ceil((maxM+1)/15)*15;

    const buckets = new Map();
    for(let t=start; t<=end; t+=15){
      buckets.set(t, 0);
    }
    for(const m of mins){
      const b = Math.floor(m/15)*15;
      buckets.set(b, (buckets.get(b)||0) + 1);
    }

    const arr = Array.from(buckets.entries()).map(([k,v])=>({ label: minutesToLabel(k).replace(":00",""), count: v }));
    // keep max 14 buckets for nice view
    if(arr.length > 14){
      const step = Math.ceil(arr.length/14);
      const compact = [];
      for(let i=0;i<arr.length;i+=step){
        const slice = arr.slice(i, i+step);
        compact.push({
          label: slice[0].label,
          count: slice.reduce((a,x)=>a+x.count,0)
        });
      }
      return compact;
    }
    return arr;
  }

  function defaultData(){
    return {
      brand: "KRS INVITE",
      version: "v1.0",
      languageDefault: "ar",
      event: {
        name: "Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯",
        date: "15-01-2026 Â· 5:30 PM â€“ 11:30 PM",
        venue: "Dubai â€” Standalone Hall",
        contact: "WhatsApp: +971 XX XXX XXXX Â· Email: krs2.store@gmail.com"
      },
      totals: { totalInvites: 300 },
      rows: [
        { code:"KRS_001", owner:"Ù…Ø­Ù…Ø¯", status:"checked", time:"5:36 PM", gate:"Gate 1 / Staff A", eventName:"Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯" },
        { code:"KRS_017", owner:"Ù†ÙˆØ±Ø§",  status:"checked", time:"5:48 PM", gate:"Gate 1 / Staff A", eventName:"Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯" },
        { code:"KRS_102", owner:"Ø³Ø§Ù„Ù…",  status:"checked", time:"6:07 PM", gate:"Gate 1 / Staff B", eventName:"Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯" },
        { code:"KRS_144", owner:"Ø´ÙŠØ®Ø©",  status:"rejected_duplicate", time:"6:22 PM", gate:"Gate 1 / Staff A", eventName:"Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯" },
        { code:"KRS_210", owner:"Ø¹Ù„ÙŠ",   status:"checked", time:"6:33 PM", gate:"Gate 1 / Staff B", eventName:"Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯" },
        { code:"KRS_255", owner:"ÙØ§Ø·Ù…Ø©", status:"manual", time:"6:55 PM", gate:"Gate 1 / Supervisor", eventName:"Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯" },
      ],
      timeline: []
    };
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return defaultData();
      const obj = JSON.parse(raw);
      // basic shape safety
      if(!obj || typeof obj !== "object") return defaultData();
      obj.rows = Array.isArray(obj.rows) ? obj.rows : [];
      obj.event = obj.event || {};
      obj.totals = obj.totals || {};
      obj.timeline = Array.isArray(obj.timeline) ? obj.timeline : [];
      return obj;
    }catch(e){
      console.warn(e);
      return defaultData();
    }
  }

  function save(data){
    localStorage.setItem(STORE_KEY, JSON.stringify(data));
    $("stamp").textContent = (LANG==="ar") ? `ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${nowStamp()}` : `Updated: ${nowStamp()}`;
    toast(`âœ… <b>${LANG==="ar" ? "ØªÙ… Ø§Ù„Ø­ÙØ¸" : "Saved"}</b>`);
  }

  function applyLang(){
    const t = I18N[LANG];
    document.documentElement.lang = LANG;
    document.documentElement.dir = (LANG==="ar") ? "rtl" : "ltr";

    $("title").textContent = t.title;
    $("subtitle").textContent = t.subtitle;
    $("summaryHead").textContent = t.summaryHead;
    $("summaryDesc").textContent = t.summaryDesc;
    $("donutTitle").textContent = t.donutTitle;
    $("barTitle").textContent = t.barTitle;
    $("evLabel").textContent = t.evLabel;
    $("evHint").textContent = t.evHint;
    $("dataLabel").textContent = t.dataLabel;
    $("importText").textContent = t.importText;
    $("sampleText").textContent = t.sampleText;
    $("exportText").textContent = t.exportText;
    $("saveText").textContent = t.saveText;
    $("filterLabel").textContent = t.filterLabel;
    $("filterHint").textContent = t.filterHint;

    $("thCode").textContent = t.thCode;
    $("thOwner").textContent = t.thOwner;
    $("thStatus").textContent = t.thStatus;
    $("thTime").textContent = t.thTime;
    $("thGate").textContent = t.thGate;

    $("opsHead").textContent = t.opsHead;
    $("opsDesc").textContent = t.opsDesc;
    $("addLabel").textContent = t.addLabel;
    $("addText").textContent = t.addText;
    $("addHint").textContent = t.addHint;
    $("toolsLabel").textContent = t.toolsLabel;
    $("normalizeText").textContent = t.normalizeText;
    $("autoTimeText").textContent = t.autoTimeText;
    $("toolsHint").textContent = t.toolsHint;
    $("aboutLabel").textContent = t.aboutLabel;

    $("reportText").textContent = t.reportText;
    $("resetText").textContent = t.resetText;
    $("langText").textContent = t.langText;

    // status filter options
    const sf = $("statusFilter");
    sf.innerHTML = "";
    const opts = (LANG==="ar")
      ? [
        ["all","Ø§Ù„ÙƒÙ„"],
        ["checked","ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„"],
        ["unused","ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…"],
        ["rejected","Ù…Ø±ÙÙˆØ¶"],
        ["manual","ÙŠØ¯ÙˆÙŠ"],
      ]
      : [
        ["all","All"],
        ["checked","Checked"],
        ["unused","Unused"],
        ["rejected","Rejected"],
        ["manual","Manual"],
      ];
    for(const [v,l] of opts){
      const o = document.createElement("option");
      o.value=v; o.textContent=l;
      sf.appendChild(o);
    }

    // placeholder updates
    $("search").placeholder = (LANG==="ar") ? "Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…..." : "Search code or name...";
  }

  function renderKPIs(metrics){
    const grid = $("kpiGrid");
    grid.innerHTML = "";

    const items = (LANG==="ar") ? [
      {t:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª", v:formatNumber(metrics.total), s:"Total codes", badge:"â€”", tone:""},
      {t:"ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„", v:formatNumber(metrics.checked), s:`Ù†Ø³Ø¨Ø©: ${metrics.attendancePct}%`, badge: metrics.attendancePct>=80?"Ù…Ù…ØªØ§Ø²":(metrics.attendancePct>=60?"Ø¬ÙŠØ¯":"Ù…ØªÙˆØ³Ø·"), tone: metrics.attendancePct>=80?"good":(metrics.attendancePct>=60?"warn":"bad")},
      {t:"ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…", v:formatNumber(metrics.unused), s:`Ù†Ø³Ø¨Ø©: ${metrics.unusedPct}%`, badge: metrics.unusedPct<=20?"Ù…Ù†Ø®ÙØ¶":(metrics.unusedPct<=40?"Ø·Ø¨ÙŠØ¹ÙŠ":"Ù…Ø±ØªÙØ¹"), tone: metrics.unusedPct<=20?"good":(metrics.unusedPct<=40?"warn":"bad")},
      {t:"Ù…Ø±ÙÙˆØ¶/ØªÙ†Ø¨ÙŠÙ‡Ø§Øª", v:formatNumber(metrics.rejected), s:`ÙŠØ¯ÙˆÙŠ: ${formatNumber(metrics.manual)}`, badge: metrics.rejected<=5?"Ù…Ø³ÙŠØ·Ø±":(metrics.rejected<=12?"ØªÙ†Ø¨ÙŠÙ‡":"Ù…Ø±ØªÙØ¹"), tone: metrics.rejected<=5?"good":(metrics.rejected<=12?"warn":"bad")},
    ] : [
      {t:"Total Invites", v:formatNumber(metrics.total), s:"Total codes", badge:"â€”", tone:""},
      {t:"Checked-in", v:formatNumber(metrics.checked), s:`Rate: ${metrics.attendancePct}%`, badge: metrics.attendancePct>=80?"Excellent":(metrics.attendancePct>=60?"Good":"Average"), tone: metrics.attendancePct>=80?"good":(metrics.attendancePct>=60?"warn":"bad")},
      {t:"Unused", v:formatNumber(metrics.unused), s:`Rate: ${metrics.unusedPct}%`, badge: metrics.unusedPct<=20?"Low":(metrics.unusedPct<=40?"Normal":"High"), tone: metrics.unusedPct<=20?"good":(metrics.unusedPct<=40?"warn":"bad")},
      {t:"Rejected/Alerts", v:formatNumber(metrics.rejected), s:`Manual: ${formatNumber(metrics.manual)}`, badge: metrics.rejected<=5?"Controlled":(metrics.rejected<=12?"Attention":"High"), tone: metrics.rejected<=5?"good":(metrics.rejected<=12?"warn":"bad")},
    ];

    for(const it of items){
      const el = document.createElement("div");
      el.className = "kpi";
      const badgeCls = it.tone==="good" ? "badge b-good" : (it.tone==="warn" ? "badge b-warn" : (it.tone==="bad" ? "badge b-bad" : "badge"));
      el.innerHTML = `
        <div class="t">${escapeHtml(it.t)}</div>
        <div class="v">${escapeHtml(it.v)}</div>
        <div class="s">${escapeHtml(it.s)}</div>
        <div class="${badgeCls}">${escapeHtml(it.badge)}</div>
      `;
      grid.appendChild(el);
    }

    $("qualityPill").textContent = (LANG==="ar")
      ? `Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„: ${metrics.quality}/100`
      : `Ops Quality: ${metrics.quality}/100`;
  }

  function renderTable(data){
    const rows = data.rows || [];
    const q = safeText($("search").value).toLowerCase();
    const sf = $("statusFilter").value;

    const filtered = rows.filter(r => {
      const code = String(r.code||"").toLowerCase();
      const owner = String(r.owner||"").toLowerCase();
      const status = String(r.status||"").toLowerCase();

      const matchQ = !q || code.includes(q) || owner.includes(q);
      let matchS = true;
      if(sf==="checked") matchS = (status==="checked");
      else if(sf==="unused") matchS = (status==="unused");
      else if(sf==="manual") matchS = (status==="manual");
      else if(sf==="rejected") matchS = (status.startsWith("rejected") || status==="rejected");
      return matchQ && matchS;
    });

    const tb = $("tbody");
    tb.innerHTML = "";
    for(const r of filtered){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(r.code||"â€”")}</td>
        <td>${escapeHtml(r.owner||"â€”")}</td>
        <td>${statusTag(r.status)}</td>
        <td class="mono">${escapeHtml(r.time||"â€”")}</td>
        <td>${escapeHtml(r.gate||"â€”")}</td>
      `;
      tb.appendChild(tr);
    }

    $("countLine").textContent = (LANG==="ar")
      ? `Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${formatNumber(filtered.length)}`
      : `Shown rows: ${formatNumber(filtered.length)}`;
  }

  function renderHeader(data){
    const ev = data.event || {};
    const name = ev.name || "â€”";
    const date = ev.date || "â€”";
    $("evPill").textContent = name;
    $("datePill").textContent = date;

    $("eventName").value = name;
    $("eventDate").value = date;
    $("venue").value = ev.venue || "";
    $("contact").value = ev.contact || "";

    $("stamp").textContent = (LANG==="ar") ? `ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${nowStamp()}` : `Updated: ${nowStamp()}`;
    $("storeKey").textContent = `STORE: ${STORE_KEY}`;
    $("opsPill").textContent = (LANG==="ar") ? "KRS INVITE" : "KRS INVITE";
  }

  function exportCSV(data){
    const rows = data.rows || [];
    const header = ["Code","Owner","Status","Time","Gate","EventName"];
    const lines = [header.join(",")];
    for(const r of rows){
      lines.push([
        csvCell(r.code),
        csvCell(r.owner),
        csvCell(r.status),
        csvCell(r.time),
        csvCell(r.gate),
        csvCell(r.eventName || (data.event?.name || ""))
      ].join(","));
    }
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `KRS_INVITE_${(data.event?.name||"event").replace(/\s+/g,"_")}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
    toast(`â¬‡ï¸ <b>${LANG==="ar" ? "ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±" : "Exported"}</b>`);
  }
  function csvCell(v){
    const s = String(v ?? "").replace(/"/g,'""');
    return `"${s}"`;
  }

  function parseCSV(text){
    // Simple robust CSV parser (supports quoted commas/newlines)
    const rows = [];
    let cur = "", inQ = false;
    const out = [[]];
    for(let i=0;i<text.length;i++){
      const ch = text[i];
      const next = text[i+1];
      if(ch === '"' ){
        if(inQ && next === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      } else if(ch === "," && !inQ){
        out[out.length-1].push(cur);
        cur = "";
      } else if((ch === "\n" || ch === "\r") && !inQ){
        if(ch === "\r" && next === "\n") i++;
        out[out.length-1].push(cur);
        cur = "";
        out.push([]);
      } else {
        cur += ch;
      }
    }
    out[out.length-1].push(cur);

    // remove empty tail rows
    const clean = out.filter(r => r.some(c => String(c||"").trim() !== ""));
    if(clean.length === 0) return { headers: [], rows: [] };
    const headers = clean[0].map(h => String(h||"").trim());
    const body = clean.slice(1).map(r => {
      const obj = {};
      headers.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
      return obj;
    });
    return { headers, rows: body };
  }

  function importCSVToData(data, csvText){
    const parsed = parseCSV(csvText);
    if(parsed.rows.length === 0){
      toast(`âš ï¸ <b>${LANG==="ar" ? "CSV ÙØ§Ø±Øº" : "Empty CSV"}</b>`);
      return data;
    }

    // map columns flexibly
    const get = (obj, keys) => {
      for(const k of keys){
        const found = Object.keys(obj).find(h => h.toLowerCase() === k.toLowerCase());
        if(found) return obj[found];
      }
      return "";
    };

    const rows = parsed.rows.map(o => {
      const code = safeText(get(o, ["Code","code","CODE","InviteCode","invite_code"]));
      const owner = safeText(get(o, ["Owner","owner","Name","name","Guest","guest"]));
      const status = normalizeStatus(get(o, ["Status","status","Used","used","Checkin","checkin"]));
      const time = safeText(get(o, ["Time","time","CheckinTime","checkin_time"]));
      const gate = safeText(get(o, ["Gate","gate","Staff","staff","Device","device"]));
      const eventName = safeText(get(o, ["EventName","eventname","Event","event"]));
      return {
        code: code || "",
        owner: owner || "",
        status,
        time: time || "",
        gate: gate || "",
        eventName: eventName || ""
      };
    }).filter(r => r.code || r.owner);

    data.rows = rows;
    data.totals = data.totals || {};
    // If totalInvites is missing, set to rows length
    if(!data.totals.totalInvites || Number(data.totals.totalInvites) < rows.length){
      data.totals.totalInvites = rows.length;
    }
    toast(`âœ… <b>${LANG==="ar" ? "ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯" : "Imported"}</b> Â· ${formatNumber(rows.length)}`);
    return data;
  }

  function normalizeData(data){
    data.event = data.event || {};
    data.totals = data.totals || {};
    data.rows = Array.isArray(data.rows) ? data.rows : [];
    data.timeline = Array.isArray(data.timeline) ? data.timeline : [];

    // trim fields + normalize status
    const seen = new Set();
    const cleaned = [];
    for(const r of data.rows){
      const code = safeText(r.code);
      const key = code.toLowerCase();
      if(code && seen.has(key)) continue;
      if(code) seen.add(key);

      cleaned.push({
        code,
        owner: safeText(r.owner),
        status: normalizeStatus(r.status),
        time: safeText(r.time),
        gate: safeText(r.gate),
        eventName: safeText(r.eventName || data.event.name || "")
      });
    }
    data.rows = cleaned;

    // ensure totals at least rows count
    const total = Number(data.totals.totalInvites || 0);
    if(total < cleaned.length) data.totals.totalInvites = cleaned.length;

    toast(`ğŸ§¼ <b>${LANG==="ar" ? "ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" : "Normalized"}</b>`);
    return data;
  }

  function setEventInfoToData(data){
    data.event = data.event || {};
    data.event.name = safeText($("eventName").value) || data.event.name || "â€”";
    data.event.date = safeText($("eventDate").value) || data.event.date || "â€”";
    data.event.venue = safeText($("venue").value) || data.event.venue || "";
    data.event.contact = safeText($("contact").value) || data.event.contact || "";
    return data;
  }

  function generateReportPayload(data){
    // This payload is read by krs-report.html
    const rows = data.rows || [];
    const metrics = computeMetrics(data);

    // timeline: prefer stored; otherwise compute
    let timeline = (Array.isArray(data.timeline) && data.timeline.length) ? data.timeline : computeTimelineFromRows(rows);

    // peak
    let peak = {label:"â€”", count:0};
    for(const x of timeline){
      const c = Number(x.count)||0;
      if(c > peak.count) peak = {label:x.label, count:c};
    }

    const payload = {
      brand: "KRS INVITE",
      reportId: `KRS-INVITE-${new Date().toISOString().slice(0,10)}`,
      version: "v1.0",
      languageDefault: LANG,
      generatedAt: nowStamp(),
      event: {
        name_ar: data.event?.name || "â€”",
        name_en: data.event?.name || "â€”",
        date: (data.event?.date || "â€”"),
        timeRange: "",
        venue_ar: data.event?.venue || "",
        venue_en: data.event?.venue || "",
        contact: data.event?.contact || ""
      },
      totals: {
        totalInvites: metrics.total,
        checkedIn: metrics.checked,
        rejected: metrics.rejected,
        manualOverrides: metrics.manual,
        staffCount: 1,
        gates: 1
      },
      timeline,
      rowsSample: rows.slice(0, 80).map(r => ({
        code: r.code,
        owner_ar: r.owner,
        owner_en: r.owner,
        status: r.status,
        time: r.time,
        gate: r.gate
      })),
      insights: {
        quality: metrics.quality,
        attendancePct: metrics.attendancePct,
        peak
      }
    };
    return payload;
  }

  function openReport(data){
    const payload = generateReportPayload(data);
    localStorage.setItem("KRS_INVITE_REPORT_V1", JSON.stringify(payload));
    window.open("krs-report.html", "_blank");
  }

  function init(){
    let data = load();

    // initial lang from stored data if exists
    LANG = (data.languageDefault === "en") ? "en" : "ar";
    applyLang();

    // render header
    renderHeader(data);

    // if no timeline, compute (for charts)
    if(!Array.isArray(data.timeline) || data.timeline.length===0){
      data.timeline = computeTimelineFromRows(data.rows||[]);
    }

    // render metrics/charts/table
    const metrics = computeMetrics(data);
    renderKPIs(metrics);
    drawDonut(metrics);
    drawBars(data.timeline);
    renderTable(data);

    $("noteLine").textContent = `KRS INVITE Â· ${nowStamp()}`;

    // events
    $("langBtn").addEventListener("click", ()=>{
      LANG = (LANG==="ar") ? "en" : "ar";
      data.languageDefault = LANG;
      applyLang();
      renderHeader(data);
      renderKPIs(computeMetrics(data));
      drawDonut(computeMetrics(data));
      drawBars(data.timeline);
      renderTable(data);
      save(data);
    });

    $("saveBtn").addEventListener("click", ()=>{
      data = setEventInfoToData(data);
      data.languageDefault = LANG;
      // refresh pill
      renderHeader(data);
      save(data);
      // re-render (no heavy)
      renderKPIs(computeMetrics(data));
      renderTable(data);
    });

    $("resetBtn").addEventListener("click", ()=>{
      localStorage.removeItem(STORE_KEY);
      data = defaultData();
      data.languageDefault = LANG;
      data.timeline = computeTimelineFromRows(data.rows||[]);
      save(data);
      renderHeader(data);
      renderKPIs(computeMetrics(data));
      drawDonut(computeMetrics(data));
      drawBars(data.timeline);
      renderTable(data);
      toast(`ğŸ§¹ <b>${LANG==="ar" ? "ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·" : "Reset done"}</b>`);
    });

    $("sampleBtn").addEventListener("click", ()=>{
      data = defaultData();
      data.languageDefault = LANG;
      data.timeline = computeTimelineFromRows(data.rows||[]);
      save(data);
      renderHeader(data);
      renderKPIs(computeMetrics(data));
      drawDonut(computeMetrics(data));
      drawBars(data.timeline);
      renderTable(data);
    });

    $("exportBtn").addEventListener("click", ()=> exportCSV(data));

    $("importBtn").addEventListener("click", async ()=>{
      const f = $("csvFile").files?.[0];
      if(!f){
        toast(`âš ï¸ <b>${LANG==="ar" ? "Ø§Ø®ØªØ± Ù…Ù„Ù CSV" : "Select a CSV file"}</b>`);
        return;
      }
      const text = await f.text();
      data = importCSVToData(data, text);
      data = normalizeData(data);
      data = setEventInfoToData(data);
      data.timeline = computeTimelineFromRows(data.rows||[]);
      save(data);

      renderHeader(data);
      renderKPIs(computeMetrics(data));
      drawDonut(computeMetrics(data));
      drawBars(data.timeline);
      renderTable(data);
    });

    $("search").addEventListener("input", ()=> renderTable(data));
    $("statusFilter").addEventListener("change", ()=> renderTable(data));

    $("normalizeBtn").addEventListener("click", ()=>{
      data = normalizeData(data);
      data = setEventInfoToData(data);
      data.timeline = computeTimelineFromRows(data.rows||[]);
      save(data);
      renderKPIs(computeMetrics(data));
      drawDonut(computeMetrics(data));
      drawBars(data.timeline);
      renderTable(data);
    });

    $("autoTimeBtn").addEventListener("click", ()=>{
      data.timeline = computeTimelineFromRows(data.rows||[]);
      save(data);
      drawBars(data.timeline);
      toast(`â±ï¸ <b>${LANG==="ar" ? "ØªÙ… ØªÙˆÙ„ÙŠØ¯ Timeline" : "Timeline generated"}</b>`);
    });

    $("addBtn").addEventListener("click", ()=>{
      const code = safeText($("addCode").value);
      const owner = safeText($("addOwner").value);
      const status = normalizeStatus($("addStatus").value);
      let time = safeText($("addTime").value);
      const gate = safeText($("addGate").value);

      if(!code){
        toast(`âš ï¸ <b>${LANG==="ar" ? "Ø§Ù„ÙƒÙˆØ¯ Ù…Ø·Ù„ÙˆØ¨" : "Code is required"}</b>`);
        return;
      }
      if(!time){
        // current time label
        const d = new Date();
        const min = String(d.getMinutes()).padStart(2,"0");
        let hh = d.getHours();
        const ap = hh>=12 ? "PM":"AM";
        hh = hh%12; if(hh===0) hh=12;
        time = `${hh}:${min} ${ap}`;
      }

      data = setEventInfoToData(data);
      const evName = data.event?.name || "";
      data.rows.unshift({
        code, owner, status, time, gate,
        eventName: evName
      });

      // keep totals >= rows
      data.totals = data.totals || {};
      if(Number(data.totals.totalInvites||0) < data.rows.length){
        data.totals.totalInvites = data.rows.length;
      }

      data = normalizeData(data);
      data.timeline = computeTimelineFromRows(data.rows||[]);
      save(data);

      // clear quick add
      $("addCode").value=""; $("addOwner").value=""; $("addTime").value=""; $("addGate").value="";
      renderKPIs(computeMetrics(data));
      drawDonut(computeMetrics(data));
      drawBars(data.timeline);
      renderTable(data);
      toast(`â• <b>${LANG==="ar" ? "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©" : "Added"}</b>`);
    });

    $("reportBtn").addEventListener("click", ()=>{
      data = setEventInfoToData(data);
      data.languageDefault = LANG;
      save(data);
      openReport(data);
    });

    // live header updates
    ["eventName","eventDate","venue","contact"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        // reflect in pill only (no save)
        const name = safeText($("eventName").value) || "â€”";
        const date = safeText($("eventDate").value) || "â€”";
        $("evPill").textContent = name;
        $("datePill").textContent = date;
      });
    });

    // resize redraw
    let t=null;
    window.addEventListener("resize", ()=>{
      clearTimeout(t);
      t = setTimeout(()=>{
        drawDonut(computeMetrics(data));
        drawBars(data.timeline);
      }, 160);
    });
  }

  init();
})();
</script>
</body>
</html>
