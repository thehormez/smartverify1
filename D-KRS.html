<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KRS INVITE â€” Dashboard + Final Report (One File)</title>

  <style>
    :root{
      --bg1:#070A12; --bg2:#0B1020;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);
      --ink:#E9EEF7; --muted:#A8B3C6;

      --gold1:#F7D37A; --gold2:#CFA24A;
      --good:#39d98a; --warn:#ffce4a; --bad:#ff5c7a;

      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 18px; --radius2: 28px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans Arabic", "Tahoma", Arial, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --g: linear-gradient(135deg, rgba(247,211,122,.18), rgba(207,162,74,.08), rgba(255,255,255,.02));
      --glow: 0 0 0 1px rgba(247,211,122,.08), 0 0 60px rgba(247,211,122,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font); color:var(--ink);
      background:
        radial-gradient(1200px 700px at 80% -10%, rgba(247,211,122,.20), transparent 60%),
        radial-gradient(900px 520px at 20% 0%, rgba(90,120,255,.12), transparent 55%),
        radial-gradient(900px 520px at 60% 110%, rgba(255,92,122,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    .wrap{ width:min(1280px, 94vw); margin: 26px auto 60px; }
    .topbar{ display:flex; gap:14px; align-items:stretch; justify-content:space-between; margin-bottom:16px; }
    .brandCard{
      flex:1; padding:18px; border-radius: var(--radius2);
      background: var(--g); border: 1px solid var(--stroke); box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    .brandCard:before{
      content:""; position:absolute; inset:-1px;
      background:
        radial-gradient(600px 140px at 70% 0%, rgba(247,211,122,.35), transparent 60%),
        radial-gradient(500px 260px at 15% 110%, rgba(120,180,255,.18), transparent 65%);
      opacity:.85; pointer-events:none;
    }
    .brandRow{ position:relative; display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brandLeft{ display:flex; align-items:center; gap:14px; min-width: 280px;}
    .logo{
      width:56px;height:56px;border-radius:18px;
      background: linear-gradient(135deg, rgba(247,211,122,.34), rgba(207,162,74,.16), rgba(255,255,255,.04));
      border: 1px solid rgba(247,211,122,.22);
      box-shadow: var(--glow);
      display:grid; place-items:center; overflow:hidden;
      position:relative;
    }
    .logo:after{
      content:""; position:absolute; inset:0;
      background:
        radial-gradient(32px 32px at 30% 35%, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(80px 60px at 70% 80%, rgba(247,211,122,.18), transparent 60%);
      pointer-events:none;
    }
    .logo span{ position:relative; font-weight:1000; color:var(--gold1); letter-spacing:.6px; }
    .brandTitle h1{ margin:0; font-size:18px; font-weight:1000;}
    .brandTitle p{ margin:6px 0 0; color:var(--muted); font-size:12.5px; line-height:1.35;}
    .brandRight{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-end; }

    .pill{
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      color: var(--muted); font-size: 12px; font-weight:900;
      white-space:nowrap;
    }
    .pill strong{ color: var(--ink); }
    .btn{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      padding:10px 12px; border-radius: 14px;
      cursor:pointer; font-weight:1000; font-size: 13px;
      display:flex; gap:8px; align-items:center;
      transition:.18s ease; user-select:none; white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); }
    .btn.primary{
      border-color: rgba(247,211,122,.30);
      background: linear-gradient(135deg, rgba(247,211,122,.26), rgba(207,162,74,.10));
      box-shadow: var(--glow);
    }
    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(247,211,122,.22), rgba(255,255,255,.10), transparent);
      margin: 14px 0 0;
      opacity:.9;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      border-radius: var(--radius2);
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding:16px 16px 12px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(135deg, rgba(255,255,255,.05), rgba(247,211,122,.06));
    }
    .card .head h2{ margin:0; font-size:14.5px; font-weight:1000;}
    .card .head p{ margin:6px 0 0; color:var(--muted); font-size:12.5px; line-height:1.35;}
    .card .body{ padding:16px; }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){ .kpis{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .kpis{grid-template-columns: 1fr;} }

    .kpi{
      border-radius: 18px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.10);
      padding: 14px;
      position:relative;
      overflow:hidden;
      min-height: 92px;
    }
    .kpi:before{
      content:""; position:absolute; inset:-1px;
      background:
        radial-gradient(260px 140px at 10% 10%, rgba(247,211,122,.18), transparent 60%),
        radial-gradient(200px 120px at 90% 70%, rgba(120,180,255,.12), transparent 60%);
      opacity:.8; pointer-events:none;
    }
    .kpi .t{ position:relative; color:var(--muted); font-size:12px; font-weight:1000; }
    .kpi .v{ position:relative; margin-top:8px; font-size:22px; font-weight:1000; letter-spacing:.2px; }
    .kpi .s{ position:relative; margin-top:6px; font-size:12px; color:var(--muted); }

    .charts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top: 12px;
    }
    @media (max-width: 980px){ .charts{grid-template-columns:1fr;} }
    .chartBox{
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      padding: 14px;
      overflow:hidden;
    }
    .chartTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; }
    .chartTop .title{ font-weight: 1000; font-size: 12.5px; color: var(--ink); }
    .chartTop .meta{ font-weight: 900; font-size: 12px; color: var(--muted); white-space:nowrap; }
    canvas{ width:100%; height: 220px; display:block; }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 980px){ .controls{grid-template-columns:1fr} }

    .field{
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
    }
    .field label{
      display:block; font-size:12px; color:var(--muted); font-weight:1000; margin-bottom:8px;
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input[type="text"], input[type="number"], select{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      outline:none;
      font-weight:900;
    }
    input::placeholder{ color: rgba(168,179,198,.7); }
    .small{ font-size:12px; color:var(--muted); line-height:1.4; margin-top:8px; }
    .mono{ font-family: var(--mono); }

    .tableWrap{
      margin-top: 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: rgba(0,0,0,.16);
      max-height: 520px;
      overflow:auto;
    }
    table{ width:100%; border-collapse:collapse; font-size: 12.5px; }
    thead th{
      position:sticky; top:0;
      background: rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.10);
      text-align:start;
      padding: 12px 10px;
      font-weight: 1000;
      color: var(--ink);
      z-index: 2;
    }
    tbody td{
      padding: 11px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      color: var(--ink);
      vertical-align:top;
    }
    tbody tr:hover{ background: rgba(255,255,255,.04); }

    .tag{
      display:inline-flex; gap:6px; align-items:center;
      padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:1000; font-size: 11px; white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--muted);display:inline-block}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .footer{
      margin-top: 14px;
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center; justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
    }
    .stamp{
      padding: 8px 12px; border-radius: 999px;
      border: 1px solid rgba(247,211,122,.22);
      background: rgba(247,211,122,.10);
      color: var(--gold1);
      font-weight:1000;
    }

    .toast{
      position:fixed;
      inset:auto 18px 18px 18px;
      max-width: 680px;
      margin:auto;
      background: rgba(0,0,0,.70);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding: 12px 14px;
      color: var(--ink);
      box-shadow: var(--shadow);
      display:none;
      z-index: 9999;
    }
    .toast.show{ display:block; }
    .toast b{ color: var(--gold1); }

    /* ===== Print Mode: show only report section ===== */
    #reportSection{ display:none; }

    @media print{
      body{ background:white !important; color:#111 !important; }
      .noPrint{ display:none !important; }
      #dashboardSection{ display:none !important; }
      #reportSection{ display:block !important; }
      .wrap{ width:100% !important; margin:0 !important; }
      .brandCard, .card{ box-shadow:none !important; border: 1px solid #ddd !important; background: white !important; }
      .kpi, .chartBox, .field{ background:white !important; border: 1px solid #e6e6e6 !important; }
      thead th{ background:#f5f5f5 !important; color:#111 !important; }
      tbody td{ color:#111 !important; }
      .brandTitle p, .kpi .t, .kpi .s, .small, .footer{ color:#444 !important; }
      .stamp{ color:#111 !important; background:#f3f3f3 !important; border-color:#ddd !important; }
      .pill{ color:#333 !important; border-color:#ddd !important; background:#f7f7f7 !important; }
      .logo{ border-color:#ddd !important; box-shadow:none !important; }
      .logo span{ color:#111 !important; }
      canvas{ height:240px !important; }
      .tableWrap{ max-height:none !important; overflow:visible !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- ================= DASHBOARD ================= -->
    <section id="dashboardSection">
      <div class="topbar">
        <div class="brandCard">
          <div class="brandRow">
            <div class="brandLeft">
              <div class="logo"><span>KRS</span></div>
              <div class="brandTitle">
                <h1 id="title">KRS INVITE â€” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                <p id="subtitle">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¯Ø« Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â€” Ø«Ù… ØªØ§Ø¨Ø¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ùˆ Ø§Ø·Ø¨Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</p>
              </div>
            </div>
            <div class="brandRight noPrint">
              <span class="pill"><strong id="evPill">â€”</strong> Â· <span id="datePill">â€”</span></span>
              <button class="btn" id="langBtn">ğŸŒ <span id="langText">English</span></button>
              <button class="btn" id="resetBtn">ğŸ§¹ <span id="resetText">Reset</span></button>
              <button class="btn primary" id="printReportBtn">ğŸ–¨ï¸ <span id="printText">Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ</span></button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="footer" style="margin-top:12px">
            <div class="stamp" id="stamp">ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: â€”</div>
            <div class="mono" id="storeKey">STORE: â€”</div>
          </div>
        </div>
      </div>

      <div class="grid">
        <!-- Left -->
        <div class="card">
          <div class="head">
            <div>
              <h2 id="summaryHead">Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
              <p id="summaryDesc">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø±Ø³ÙˆÙ… ØªØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù…Ø®ØªØ§Ø±.</p>
            </div>
            <span class="pill" id="qualityPill">â€”</span>
          </div>

          <div class="body">
            <div class="kpis" id="kpiGrid"></div>

            <div class="charts">
              <div class="chartBox">
                <div class="chartTop">
                  <div class="title" id="donutTitle">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div>
                  <div class="meta" id="donutMeta">â€”</div>
                </div>
                <canvas id="donut"></canvas>
              </div>
              <div class="chartBox">
                <div class="chartTop">
                  <div class="title" id="barTitle">Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª</div>
                  <div class="meta" id="barMeta">â€”</div>
                </div>
                <canvas id="bars"></canvas>
              </div>
            </div>

            <div class="controls">
              <div class="field">
                <label id="evSelectLabel">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø¯Ø«</label>
                <div class="row">
                  <select id="eventSelect" style="flex:1; min-width:260px"></select>
                  <button class="btn noPrint" id="newEventBtn">â• <span id="newEventText">Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯</span></button>
                  <button class="btn noPrint" id="deleteEventBtn">ğŸ—‘ï¸ <span id="deleteEventText">Ø­Ø°Ù Ø§Ù„Ø­Ø¯Ø«</span></button>
                </div>
                <div class="small" id="evSelectHint">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªØªØ¹Ø¨Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø£Ùˆ Ù…Ù† CSV.</div>
              </div>

              <div class="field">
                <label id="evLabel">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù…Ø®ØªØ§Ø±</label>
                <div class="row">
                  <div style="flex:1; min-width:220px">
                    <input id="eventName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯" />
                  </div>
                  <div style="flex:1; min-width:220px">
                    <input id="eventDate" type="text" placeholder="15-01-2026 Â· 5:30 PM â€“ 11:30 PM" />
                  </div>
                </div>
                <div class="row" style="margin-top:10px">
                  <div style="flex:1; min-width:220px">
                    <input id="venue" type="text" placeholder="Ø¯Ø¨ÙŠ â€” Ù‚Ø§Ø¹Ø© ..." />
                  </div>
                  <div style="flex:1; min-width:220px">
                    <input id="contact" type="text" placeholder="WhatsApp / Email" />
                  </div>
                </div>
                <div class="row" style="margin-top:10px">
                  <div style="flex:1; min-width:220px">
                    <input id="totalInvites" type="number" min="0" placeholder="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ù„Ù„Ø­Ø¯Ø«" />
                  </div>
                  <button class="btn noPrint" id="saveBtn">ğŸ’¾ <span id="saveText">Ø­ÙØ¸</span></button>
                </div>
                <div class="small" id="evHint">ÙƒÙ„ Ø­Ø¯Ø« Ù„Ù‡ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙ‡ ÙˆØªÙ‚Ø±ÙŠØ±Ù‡.</div>
              </div>
            </div>

            <div class="controls" style="margin-top:12px">
              <div class="field">
                <label id="dataLabel">Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ±) Ù„Ù„Ø­Ø¯Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ</label>
                <div class="row noPrint">
                  <input id="csvFile" type="file" accept=".csv,text/csv" style="flex:1" />
                  <button class="btn" id="importBtn">â¬†ï¸ <span id="importText">Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV</span></button>
                </div>
                <div class="row" style="margin-top:10px" class="noPrint">
                  <button class="btn noPrint" id="sampleBtn">âœ¨ <span id="sampleText">Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</span></button>
                  <button class="btn noPrint" id="exportBtn">â¬‡ï¸ <span id="exportText">ØªØµØ¯ÙŠØ± CSV</span></button>
                </div>
                <div class="small mono" id="csvHint">Recommended columns: Code,Owner,Status,Time,Gate,EventName</div>
              </div>

              <div class="field">
                <label id="filterLabel">ÙÙ„ØªØ±Ø© / Ø¨Ø­Ø«</label>
                <div class="row">
                  <input id="search" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…..." style="flex:1; min-width:240px" />
                  <select id="statusFilter" style="width:220px"></select>
                </div>
                <div class="small" id="filterHint">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªØ®Øµ Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙ‚Ø·.</div>
              </div>
            </div>

            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th id="thCode">Ø§Ù„ÙƒÙˆØ¯</th>
                    <th id="thOwner">Ø§Ù„Ø§Ø³Ù…</th>
                    <th id="thStatus">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th id="thTime">ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                    <th id="thGate">Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©/Ø§Ù„Ù…ÙˆØ¸Ù</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>

            <div class="footer">
              <div class="stamp" id="countLine">â€”</div>
              <div class="mono" id="noteLine">KRS INVITE</div>
            </div>
          </div>
        </div>

        <!-- Right -->
        <div class="card">
          <div class="head">
            <div>
              <h2 id="opsHead">Ø¥Ø¶Ø§ÙØ©/Ø£Ø¯ÙˆØ§Øª</h2>
              <p id="opsDesc">Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù‡Ù†Ø§ ØªÙ†Ø¶Ø§Ù Ù„Ù„Ø­Ø¯Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·.</p>
            </div>
            <span class="pill">KRS INVITE</span>
          </div>
          <div class="body">
            <div class="field">
              <label id="addLabel">Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø³Ø±ÙŠØ¹ (Ù„Ù„Ø­Ø¯Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ)</label>
              <div class="row">
                <input id="addCode" type="text" placeholder="Code (Ù…Ø«Ø§Ù„: KRS_301)" style="flex:1; min-width:220px" />
                <input id="addOwner" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¶ÙŠÙ" style="flex:1; min-width:220px" />
              </div>
              <div class="row" style="margin-top:10px">
                <select id="addStatus" style="flex:1; min-width:220px"></select>
                <input id="addTime" type="text" placeholder="Time (Ù…Ø«Ø§Ù„: 6:22 PM)" style="flex:1; min-width:220px" />
              </div>
              <div class="row" style="margin-top:10px">
                <input id="addGate" type="text" placeholder="Gate/Staff" style="flex:1; min-width:220px" />
                <button class="btn primary noPrint" id="addBtn">â• <span id="addText">Ø¥Ø¶Ø§ÙØ©</span></button>
              </div>
              <div class="small" id="addHint">Ø¥Ø°Ø§ ØªØ±ÙƒØª Ø§Ù„ÙˆÙ‚Øª ÙØ§Ø±ØºØ§Ù‹ØŒ Ù†Ø³ØªØ®Ø¯Ù… ÙˆÙ‚Øª Ø§Ù„Ø¢Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
            </div>

            <div class="field" style="margin-top:12px">
              <label id="toolsLabel">Ø£Ø¯ÙˆØ§Øª</label>
              <div class="row noPrint">
                <button class="btn" id="normalizeBtn">ğŸ§¼ <span id="normalizeText">ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span></button>
                <button class="btn" id="autoTimeBtn">â±ï¸ <span id="autoTimeText">ØªÙˆÙ„ÙŠØ¯ Timeline</span></button>
              </div>
              <div class="small" id="toolsHint">Timeline Ù„Ù„Ø±Ø³ÙˆÙ… (Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª) Ù„Ù„Ø­Ø¯Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ.</div>
            </div>

            <div class="field" style="margin-top:12px">
              <label id="aboutLabel">Ù…Ù‡Ù…</label>
              <div class="small" id="aboutText">
                - Ø¥Ø°Ø§ CSV ÙÙŠÙ‡ EventName Ù…ØªØ¹Ø¯Ø¯: Ø±Ø§Ø­ ÙŠÙˆØ²Ù‘Ø¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø§Ø«Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.<br>
                - Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠÙ‡ EventName: ÙŠØ¯Ø®Ù„ ÙƒÙ„Ù‡ ÙÙŠ Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ.<br>
                - Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ·Ù„Ø¹ ØªÙ‚Ø±ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ ÙØ§Ø®Ø± Ù„Ù„Ø­Ø¯Ø« Ø§Ù„Ù…Ø®ØªØ§Ø±.
              </div>
            </div>

            <div class="footer">
              <div class="mono">v1.2 One-File</div>
              <div class="mono">localStorage</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ================= REPORT (PRINT ONLY) ================= -->
    <section id="reportSection">
      <div class="brandCard" style="margin: 0 0 16px;">
        <div class="brandRow">
          <div class="brandLeft">
            <div class="logo"><span>KRS</span></div>
            <div class="brandTitle">
              <h1 id="rTitle">KRS INVITE â€” Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</h1>
              <p id="rSub">ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØªØ­Ù‚Ù‚ â€” Ù†Ø³Ø®Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆPDF</p>
            </div>
          </div>
          <div class="brandRight">
            <span class="pill"><strong id="rEvent">â€”</strong> Â· <span id="rDate">â€”</span></span>
            <span class="pill"><strong id="rGen">â€”</strong></span>
          </div>
        </div>
        <div class="divider"></div>
        <div class="footer" style="margin-top:12px">
          <div class="stamp" id="rVenue">â€”</div>
          <div class="mono" id="rContact">â€”</div>
          <div class="mono" id="rReportId">â€”</div>
        </div>
      </div>

      <div class="grid" style="grid-template-columns: 1.3fr .7fr;">
        <div class="card">
          <div class="head">
            <div>
              <h2 id="rSummaryHead">Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h2>
              <p id="rSummaryDesc">Ø£Ø±Ù‚Ø§Ù… Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆÙ†ÙØ³ÙØ¨ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ­Ù‚Ù‚.</p>
            </div>
            <span class="pill" id="rQuality">â€”</span>
          </div>
          <div class="body">
            <div class="kpis" id="rKpiGrid"></div>

            <div class="charts">
              <div class="chartBox">
                <div class="chartTop">
                  <div class="title" id="rDonutTitle">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± (Checked-in)</div>
                  <div class="meta" id="rDonutMeta">â€”</div>
                </div>
                <canvas id="rDonut"></canvas>
              </div>

              <div class="chartBox">
                <div class="chartTop">
                  <div class="title" id="rBarTitle">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª</div>
                  <div class="meta" id="rBarMeta">â€”</div>
                </div>
                <canvas id="rBars"></canvas>
              </div>
            </div>

            <div class="footer">
              <div class="stamp" id="rCountLine">â€”</div>
              <div class="mono">KRS INVITE</div>
            </div>

            <div class="card" style="border-radius:18px; box-shadow:none; background:rgba(0,0,0,.14); border:1px solid rgba(255,255,255,.10); margin-top:12px;">
              <div class="head" style="border-bottom:1px solid rgba(255,255,255,.08)">
                <div>
                  <h2 id="rDetailsHead">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª (Ø¢Ø®Ø± 150 Ø³Ø¬Ù„)</h2>
                  <p id="rDetailsDesc">Ù‚Ø§Ø¦Ù…Ø© Ù…Ø®ØªØµØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© (ÙŠÙ…ÙƒÙ† Ø²ÙŠØ§Ø¯ØªÙ‡Ø§ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯).</p>
                </div>
                <span class="pill" id="rDetailsCount">â€”</span>
              </div>
              <div class="body">
                <div class="tableWrap" style="max-height:none; overflow:visible;">
                  <table>
                    <thead>
                      <tr>
                        <th>Ø§Ù„ÙƒÙˆØ¯</th>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                        <th>Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©/Ø§Ù„Ù…ÙˆØ¸Ù</th>
                      </tr>
                    </thead>
                    <tbody id="rTbody"></tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="head">
            <div>
              <h2 id="rClientHead">Ø£Ù‡Ù… Ù…Ø§ ÙŠÙ‡Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
              <p id="rClientDesc">Ø§Ù„Ø°Ø±ÙˆØ©ØŒ Ø§Ù„Ø¬ÙˆØ¯Ø©ØŒ ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­.</p>
            </div>
            <span class="pill" id="rStatusPill">Ø§Ù„Ø­Ø§Ù„Ø©: Ù…ÙƒØªÙ…Ù„</span>
          </div>
          <div class="body">
            <div class="field" style="margin-bottom:12px">
              <label id="rPeakHead">Ø°Ø±ÙˆØ© Ø§Ù„Ø­Ø¶ÙˆØ±</label>
              <div class="small" id="rPeakText">â€”</div>
            </div>

            <div class="field" style="margin-bottom:12px">
              <label id="rOpsHead">Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ´ØºÙŠÙ„ÙŠØ©</label>
              <div class="small" id="rOpsText">â€”</div>
            </div>

            <div class="field">
              <label id="rAlertsHead">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</label>
              <div class="small" id="rAlertsText">â€”</div>
            </div>

            <div class="footer">
              <div class="stamp">Final Report</div>
              <div class="mono" id="rFooterStamp">â€”</div>
            </div>
          </div>
        </div>

      </div>
    </section>

  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  "use strict";

  // ========= Storage =========
  const STORE_KEY = "KRS_INVITE_ONEFILE_V1";
  let STATE = null;
  let ACTIVE_EVENT_ID = null;
  let LANG = "ar";

  const $ = (id) => document.getElementById(id);

  // ========= I18N (minimal) =========
  const I18N = {
    ar:{
      title:"KRS INVITE â€” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",
      subtitle:"Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¯Ø« Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â€” Ø«Ù… ØªØ§Ø¨Ø¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ùˆ Ø§Ø·Ø¨Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ",
      printText:"Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ",
      resetText:"Reset",
      langText:"English",
      newEventText:"Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯",
      deleteEventText:"Ø­Ø°Ù Ø§Ù„Ø­Ø¯Ø«",
      saveText:"Ø­ÙØ¸",
      donutTitle:"Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±",
      barTitle:"Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª",
      filterPH:"Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…..."
    },
    en:{
      title:"KRS INVITE â€” Dashboard",
      subtitle:"Select an event â€” monitor analytics or print the final report",
      printText:"Print Final Report",
      resetText:"Reset",
      langText:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
      newEventText:"New Event",
      deleteEventText:"Delete Event",
      saveText:"Save",
      donutTitle:"Attendance Ratio",
      barTitle:"Attendance by Time",
      filterPH:"Search code or name..."
    }
  };

  // ========= Helpers =========
  function toast(msg){
    const el = $("toast");
    el.innerHTML = msg;
    el.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> el.classList.remove("show"), 2400);
  }
  function nowStamp(){
    const d=new Date();
    const pad=(n)=>String(n).padStart(2,"0");
    const dd=pad(d.getDate()), mm=pad(d.getMonth()+1), yyyy=d.getFullYear();
    let hh=d.getHours(); const min=pad(d.getMinutes());
    const ampm = hh>=12 ? "PM":"AM";
    hh = hh%12; if(hh===0) hh=12;
    return `${dd}-${mm}-${yyyy}  ${hh}:${min} ${ampm}`;
  }
  function formatNumber(n){ return (n??0).toLocaleString("en-US"); }
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function pct(n,d){ if(!d) return 0; return Math.round((n/d)*1000)/10; }
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  function safeText(s){ return String(s ?? "").trim(); }

  function normalizeStatus(s){
    s = String(s||"").trim().toLowerCase();
    if(!s) return "unused";
    if(["yes","y","checked","check","checkin","checked-in","in","used"].includes(s)) return "checked";
    if(["no","n","unused","notused","not-used","pending"].includes(s)) return "unused";
    if(["manual","override"].includes(s)) return "manual";
    if(["dup","duplicate","rejected_duplicate"].includes(s)) return "rejected_duplicate";
    if(["invalid","rejected_invalid"].includes(s)) return "rejected_invalid";
    if(["rejected","Ø±ÙØ¶","Ù…Ø±ÙÙˆØ¶"].includes(s)) return "rejected";
    return s;
  }

  function statusTag(status, lang){
    const s = String(status||"").toLowerCase();
    const tag = (txt, cls)=>`<span class="tag"><span class="dot ${cls}"></span>${txt}</span>`;
    if(lang==="ar"){
      if(s==="checked") return tag("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„","good");
      if(s==="unused") return tag("ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…","warn");
      if(s==="manual") return tag("ÙŠØ¯ÙˆÙŠ","warn");
      if(s==="rejected_duplicate") return tag("Ù…ÙƒØ±Ø±","bad");
      if(s==="rejected_invalid") return tag("ØºÙŠØ± ØµØ§Ù„Ø­","bad");
      if(s==="rejected") return tag("Ù…Ø±ÙÙˆØ¶","bad");
      if(s.startsWith("rejected")) return tag("Ù…Ø±ÙÙˆØ¶","bad");
      return tag("â€”","");
    }else{
      if(s==="checked") return tag("Checked","good");
      if(s==="unused") return tag("Unused","warn");
      if(s==="manual") return tag("Manual","warn");
      if(s==="rejected_duplicate") return tag("Duplicate","bad");
      if(s==="rejected_invalid") return tag("Invalid","bad");
      if(s==="rejected") return tag("Rejected","bad");
      if(s.startsWith("rejected")) return tag("Rejected","bad");
      return tag("â€”","");
    }
  }

  function parseTimeToMinutes(t){
    const s = String(t||"").trim();
    if(!s) return null;
    let m = s.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
    if(m){
      let hh=parseInt(m[1],10);
      const mm=parseInt(m[2],10);
      const ap=m[3].toUpperCase();
      if(ap==="PM" && hh!==12) hh+=12;
      if(ap==="AM" && hh===12) hh=0;
      return hh*60+mm;
    }
    m = s.match(/^(\d{1,2}):(\d{2})$/);
    if(m){
      const hh=parseInt(m[1],10), mm=parseInt(m[2],10);
      return hh*60+mm;
    }
    return null;
  }
  function minutesToLabel(min){
    min = Math.max(0, Math.min(24*60-1, min));
    let hh=Math.floor(min/60);
    const mm=String(min%60).padStart(2,"0");
    const ap=hh>=12 ? "PM":"AM";
    hh=hh%12; if(hh===0) hh=12;
    return `${hh}:${mm} ${ap}`;
  }

  function setupCanvas(canvas){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(1, Math.floor(rect.width * dpr));
    canvas.height = Math.max(1, Math.floor(rect.height * dpr));
    const ctx = canvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return ctx;
  }
  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  // ========= Multi-event model =========
  function uid(){ return "EVT_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }

  function defaultState(){
    const id = uid();
    return {
      version:"v1.2",
      languageDefault:"ar",
      activeEventId:id,
      events:{
        [id]:{
          id,
          name:"Ø²ÙØ§Ù Ø®Ø§Ù„Ø¯",
          date:"15-01-2026 Â· 5:30 PM â€“ 11:30 PM",
          venue:"Dubai â€” Standalone Hall",
          contact:"Email: krs2.store@gmail.com",
          totalInvites:300,
          rows:[
            { code:"KRS_001", owner:"Ù…Ø­Ù…Ø¯", status:"checked", time:"5:36 PM", gate:"Gate 1 / Staff A" },
            { code:"KRS_017", owner:"Ù†ÙˆØ±Ø§",  status:"checked", time:"5:48 PM", gate:"Gate 1 / Staff A" },
            { code:"KRS_102", owner:"Ø³Ø§Ù„Ù…",  status:"checked", time:"6:07 PM", gate:"Gate 1 / Staff B" },
            { code:"KRS_144", owner:"Ø´ÙŠØ®Ø©",  status:"rejected_duplicate", time:"6:22 PM", gate:"Gate 1 / Staff A" },
            { code:"KRS_210", owner:"Ø¹Ù„ÙŠ",   status:"checked", time:"6:33 PM", gate:"Gate 1 / Staff B" },
            { code:"KRS_255", owner:"ÙØ§Ø·Ù…Ø©", status:"manual", time:"6:55 PM", gate:"Gate 1 / Supervisor" },
          ],
          timeline:[]
        }
      }
    };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return defaultState();
      const obj = JSON.parse(raw);
      if(!obj || typeof obj!=="object") return defaultState();
      obj.events = obj.events && typeof obj.events==="object" ? obj.events : {};
      const ids = Object.keys(obj.events);
      if(ids.length===0) return defaultState();
      obj.activeEventId = obj.activeEventId && obj.events[obj.activeEventId] ? obj.activeEventId : ids[0];
      obj.languageDefault = obj.languageDefault==="en" ? "en" : "ar";
      for(const id of Object.keys(obj.events)){
        const e = obj.events[id] || {};
        e.id = id;
        e.name = String(e.name||"").trim() || "â€”";
        e.date = String(e.date||"").trim() || "â€”";
        e.venue = String(e.venue||"").trim();
        e.contact = String(e.contact||"").trim();
        e.totalInvites = Number(e.totalInvites||0);
        e.rows = Array.isArray(e.rows) ? e.rows : [];
        e.timeline = Array.isArray(e.timeline) ? e.timeline : [];
        obj.events[id] = e;
      }
      return obj;
    }catch(e){
      return defaultState();
    }
  }

  function saveState(){
    localStorage.setItem(STORE_KEY, JSON.stringify(STATE));
    $("stamp").textContent = (LANG==="ar") ? `ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${nowStamp()}` : `Updated: ${nowStamp()}`;
    $("storeKey").textContent = `STORE: ${STORE_KEY}`;
  }

  function getActiveEvent(){ return STATE.events[ACTIVE_EVENT_ID]; }

  function normalizeRowsUniqueByCode(rows){
    const seen = new Set();
    const out = [];
    for(const r of rows){
      const code = safeText(r.code);
      if(!code) continue;
      const key = code.toLowerCase();
      if(seen.has(key)) continue;
      seen.add(key);
      out.push({
        code,
        owner: safeText(r.owner),
        status: normalizeStatus(r.status),
        time: safeText(r.time),
        gate: safeText(r.gate),
      });
    }
    return out;
  }

  function computeTimelineFromRows(rows){
    const mins = rows
      .filter(r=>r.status==="checked" && r.time)
      .map(r=>parseTimeToMinutes(r.time))
      .filter(v=>v!==null);

    if(mins.length < 3){
      return [
        {label:"5:30",count:6},{label:"5:45",count:14},{label:"6:00",count:22},
        {label:"6:15",count:28},{label:"6:30",count:33},{label:"6:45",count:29},
      ];
    }

    const minM = Math.min(...mins);
    const maxM = Math.max(...mins);
    const start = Math.floor(minM/15)*15;
    const end = Math.ceil((maxM+1)/15)*15;

    const buckets = new Map();
    for(let t=start; t<=end; t+=15) buckets.set(t, 0);
    for(const m of mins){
      const b = Math.floor(m/15)*15;
      buckets.set(b, (buckets.get(b)||0) + 1);
    }

    let arr = Array.from(buckets.entries()).map(([k,v])=>({ label: minutesToLabel(k).replace(":00",""), count: v }));
    if(arr.length > 14){
      const step = Math.ceil(arr.length/14);
      const compact = [];
      for(let i=0;i<arr.length;i+=step){
        const slice = arr.slice(i, i+step);
        compact.push({ label: slice[0].label, count: slice.reduce((a,x)=>a+x.count,0) });
      }
      arr = compact;
    }
    return arr;
  }

  function computeMetrics(ev){
    const rows = ev.rows || [];
    const total = Math.max(0, Number(ev.totalInvites || rows.length || 0));
    const checked = rows.filter(r=>r.status==="checked").length;
    const rejected = rows.filter(r=>String(r.status).startsWith("rejected") || r.status==="rejected").length;
    const manual = rows.filter(r=>r.status==="manual").length;
    const unused = Math.max(0, total - checked);

    const attendancePct = pct(checked,total);
    const unusedPct = pct(unused,total);

    const dupPenalty = Math.min(20, rejected*2);
    const coverageBonus = Math.min(60, attendancePct*0.6);
    const stabilityBonus = 20;
    const quality = clamp(Math.round(coverageBonus + stabilityBonus - dupPenalty), 0, 100);

    return { total, checked, rejected, manual, unused, attendancePct, unusedPct, quality };
  }

  function applyLang(){
    const t = I18N[LANG];
    document.documentElement.lang = LANG;
    document.documentElement.dir = (LANG==="ar") ? "rtl" : "ltr";

    $("title").textContent = t.title;
    $("subtitle").textContent = t.subtitle;
    $("printText").textContent = t.printText;
    $("resetText").textContent = t.resetText;
    $("langText").textContent = t.langText;
    $("newEventText").textContent = t.newEventText;
    $("deleteEventText").textContent = t.deleteEventText;
    $("saveText").textContent = t.saveText;
    $("donutTitle").textContent = t.donutTitle;
    $("barTitle").textContent = t.barTitle;
    $("search").placeholder = t.filterPH;

    // Filters
    const sf = $("statusFilter");
    sf.innerHTML = "";
    const opts = (LANG==="ar")
      ? [["all","Ø§Ù„ÙƒÙ„"],["checked","ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„"],["unused","ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…"],["rejected","Ù…Ø±ÙÙˆØ¶"],["manual","ÙŠØ¯ÙˆÙŠ"]]
      : [["all","All"],["checked","Checked"],["unused","Unused"],["rejected","Rejected"],["manual","Manual"]];
    for(const [v,l] of opts){
      const o=document.createElement("option"); o.value=v; o.textContent=l; sf.appendChild(o);
    }

    const as = $("addStatus");
    as.innerHTML = "";
    const addOpts = (LANG==="ar")
      ? [["checked","ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„"],["unused","ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…"],["rejected_duplicate","Ù…ÙƒØ±Ø±"],["rejected_invalid","ØºÙŠØ± ØµØ§Ù„Ø­"],["manual","ÙŠØ¯ÙˆÙŠ"]]
      : [["checked","Checked"],["unused","Unused"],["rejected_duplicate","Duplicate"],["rejected_invalid","Invalid"],["manual","Manual"]];
    for(const [v,l] of addOpts){
      const o=document.createElement("option"); o.value=v; o.textContent=l; as.appendChild(o);
    }

    // Report labels
    $("rTitle").textContent = (LANG==="ar") ? "KRS INVITE â€” Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù†Ø§Ø³Ø¨Ø©" : "KRS INVITE â€” Final Event Report";
    $("rSub").textContent = (LANG==="ar") ? "ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØªØ­Ù‚Ù‚ â€” Ù†Ø³Ø®Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆPDF" : "Attendance & verification summary â€” Print/PDF ready";
    $("rSummaryHead").textContent = (LANG==="ar") ? "Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹" : "Quick Summary";
    $("rSummaryDesc").textContent = (LANG==="ar") ? "Ø£Ø±Ù‚Ø§Ù… Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆÙ†ÙØ³ÙØ¨ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ­Ù‚Ù‚." : "Key numbers and performance ratios for entry verification.";
    $("rDonutTitle").textContent = (LANG==="ar") ? "Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± (Checked-in)" : "Attendance Ratio (Checked-in)";
    $("rBarTitle").textContent = (LANG==="ar") ? "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª" : "Attendance by Time";
    $("rClientHead").textContent = (LANG==="ar") ? "Ø£Ù‡Ù… Ù…Ø§ ÙŠÙ‡Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" : "Client Highlights";
    $("rClientDesc").textContent = (LANG==="ar") ? "Ø§Ù„Ø°Ø±ÙˆØ©ØŒ Ø§Ù„Ø¬ÙˆØ¯Ø©ØŒ ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­." : "Peak, quality, and alerts â€” clearly presented.";
    $("rPeakHead").textContent = (LANG==="ar") ? "Ø°Ø±ÙˆØ© Ø§Ù„Ø­Ø¶ÙˆØ±" : "Peak Window";
    $("rOpsHead").textContent = (LANG==="ar") ? "Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ´ØºÙŠÙ„ÙŠØ©" : "Operational Notes";
    $("rAlertsHead").textContent = (LANG==="ar") ? "ØªÙ†Ø¨ÙŠÙ‡Ø§Øª" : "Alerts";
  }

  function buildEventList(){
    const sel = $("eventSelect");
    sel.innerHTML = "";
    const events = Object.values(STATE.events).sort((a,b)=> String(a.name).localeCompare(String(b.name)));
    for(const e of events){
      const opt = document.createElement("option");
      opt.value = e.id;
      opt.textContent = e.name || e.id;
      sel.appendChild(opt);
    }
    if(!ACTIVE_EVENT_ID || !STATE.events[ACTIVE_EVENT_ID]){
      ACTIVE_EVENT_ID = events[0]?.id || null;
      STATE.activeEventId = ACTIVE_EVENT_ID;
    }
    sel.value = ACTIVE_EVENT_ID || "";
  }

  function setHeaderPills(ev){
    $("evPill").textContent = ev?.name || "â€”";
    $("datePill").textContent = ev?.date || "â€”";
  }

  function loadEventToForm(ev){
    $("eventName").value = ev.name || "";
    $("eventDate").value = ev.date || "";
    $("venue").value = ev.venue || "";
    $("contact").value = ev.contact || "";
    $("totalInvites").value = (ev.totalInvites ?? "");
  }

  function saveFormToEvent(ev){
    ev.name = safeText($("eventName").value) || ev.name || "â€”";
    ev.date = safeText($("eventDate").value) || ev.date || "â€”";
    ev.venue = safeText($("venue").value);
    ev.contact = safeText($("contact").value);
    ev.totalInvites = Math.max(0, Number($("totalInvites").value || ev.totalInvites || 0));
  }

  function renderKPIs(metrics){
    const grid = $("kpiGrid");
    grid.innerHTML = "";

    const items = (LANG==="ar") ? [
      {t:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª", v:formatNumber(metrics.total), s:"Total codes"},
      {t:"ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„", v:formatNumber(metrics.checked), s:`Ù†Ø³Ø¨Ø©: ${metrics.attendancePct}%`},
      {t:"ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…", v:formatNumber(metrics.unused), s:`Ù†Ø³Ø¨Ø©: ${metrics.unusedPct}%`},
      {t:"Ù…Ø±ÙÙˆØ¶/ØªÙ†Ø¨ÙŠÙ‡Ø§Øª", v:formatNumber(metrics.rejected), s:`ÙŠØ¯ÙˆÙŠ: ${formatNumber(metrics.manual)}`},
    ] : [
      {t:"Total Invites", v:formatNumber(metrics.total), s:"Total codes"},
      {t:"Checked-in", v:formatNumber(metrics.checked), s:`Rate: ${metrics.attendancePct}%`},
      {t:"Unused", v:formatNumber(metrics.unused), s:`Rate: ${metrics.unusedPct}%`},
      {t:"Rejected/Alerts", v:formatNumber(metrics.rejected), s:`Manual: ${formatNumber(metrics.manual)}`},
    ];

    for(const it of items){
      const el = document.createElement("div");
      el.className = "kpi";
      el.innerHTML = `
        <div class="t">${escapeHtml(it.t)}</div>
        <div class="v">${escapeHtml(it.v)}</div>
        <div class="s">${escapeHtml(it.s)}</div>
      `;
      grid.appendChild(el);
    }

    $("qualityPill").textContent = (LANG==="ar")
      ? `Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„: ${metrics.quality}/100`
      : `Ops Quality: ${metrics.quality}/100`;
  }

  function renderTable(ev){
    const rows = ev.rows || [];
    const q = safeText($("search").value).toLowerCase();
    const sf = $("statusFilter").value;

    const filtered = rows.filter(r => {
      const code = String(r.code||"").toLowerCase();
      const owner = String(r.owner||"").toLowerCase();
      const status = String(r.status||"").toLowerCase();

      const matchQ = !q || code.includes(q) || owner.includes(q);
      let matchS = true;
      if(sf==="checked") matchS = (status==="checked");
      else if(sf==="unused") matchS = (status==="unused");
      else if(sf==="manual") matchS = (status==="manual");
      else if(sf==="rejected") matchS = (status.startsWith("rejected") || status==="rejected");
      return matchQ && matchS;
    });

    const tb = $("tbody");
    tb.innerHTML = "";
    for(const r of filtered){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(r.code||"â€”")}</td>
        <td>${escapeHtml(r.owner||"â€”")}</td>
        <td>${statusTag(r.status, LANG)}</td>
        <td class="mono">${escapeHtml(r.time||"â€”")}</td>
        <td>${escapeHtml(r.gate||"â€”")}</td>
      `;
      tb.appendChild(tr);
    }

    $("countLine").textContent = (LANG==="ar")
      ? `Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${formatNumber(filtered.length)}`
      : `Shown rows: ${formatNumber(filtered.length)}`;

    $("noteLine").textContent = `KRS INVITE Â· ${nowStamp()}`;
  }

  function drawDonut(canvasId, metaId, metrics){
    const canvas = $(canvasId);
    const ctx = setupCanvas(canvas);
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;
    ctx.clearRect(0,0,w,h);

    const cx = w/2, cy = h/2;
    const r = Math.min(w,h)*0.33;
    const thick = Math.max(14, r*0.30);

    const ratio = metrics.total ? metrics.checked/metrics.total : 0;

    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI*2);
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = thick;
    ctx.lineCap = "round";
    ctx.stroke();

    const grad = ctx.createLinearGradient(cx-r, cy-r, cx+r, cy+r);
    grad.addColorStop(0, "rgba(247,211,122,.95)");
    grad.addColorStop(1, "rgba(207,162,74,.55)");

    const start = -Math.PI/2;
    const end = start + (Math.PI*2*ratio);

    ctx.beginPath();
    ctx.arc(cx, cy, r, start, end);
    ctx.strokeStyle = grad;
    ctx.lineWidth = thick;
    ctx.lineCap = "round";
    ctx.shadowColor = "rgba(247,211,122,.20)";
    ctx.shadowBlur = 16;
    ctx.stroke();
    ctx.shadowBlur = 0;

    ctx.fillStyle = "rgba(233,238,247,.95)";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.font = "1000 34px " + getComputedStyle(document.documentElement).getPropertyValue("--font").trim();
    ctx.fillText(`${metrics.attendancePct}%`, cx, cy - 8);

    ctx.fillStyle = "rgba(168,179,198,.95)";
    ctx.font = "1000 12.5px " + getComputedStyle(document.documentElement).getPropertyValue("--font").trim();
    const sub = (LANG==="ar") ? `ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ ${formatNumber(metrics.checked)} Ù…Ù† ${formatNumber(metrics.total)}` : `${formatNumber(metrics.checked)} of ${formatNumber(metrics.total)} checked`;
    ctx.fillText(sub, cx, cy + 22);

    if(metaId){
      $(metaId).textContent = (LANG==="ar")
        ? `Ø­Ø¶ÙˆØ±: ${formatNumber(metrics.checked)} Â· ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…: ${formatNumber(metrics.unused)}`
        : `Checked: ${formatNumber(metrics.checked)} Â· Unused: ${formatNumber(metrics.unused)}`;
    }
  }

  function drawBars(canvasId, metaId, timeline){
    const canvas = $(canvasId);
    const ctx = setupCanvas(canvas);
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;
    ctx.clearRect(0,0,w,h);

    const pad = 18;
    const chartW = w - pad*2;
    const chartH = h - pad*2 - 18;

    const tl = Array.isArray(timeline) ? timeline : [];
    const maxV = Math.max(1, ...tl.map(x=>Number(x.count)||0));
    const barCount = Math.max(1, tl.length);
    const gap = 8;
    const barW = (chartW - gap*(barCount-1)) / barCount;

    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(pad, pad + chartH);
    ctx.lineTo(pad + chartW, pad + chartH);
    ctx.stroke();

    for(let i=0;i<tl.length;i++){
      const v = Number(tl[i].count)||0;
      const x = pad + i*(barW+gap);
      const bh = (v/maxV) * (chartH - 8);
      const y = pad + chartH - bh;

      const g = ctx.createLinearGradient(x, y, x, y+bh);
      g.addColorStop(0, "rgba(247,211,122,.75)");
      g.addColorStop(1, "rgba(255,255,255,.08)");

      roundRect(ctx, x, y, barW, bh, 10);
      ctx.fillStyle = g;
      ctx.fill();

      ctx.fillStyle = "rgba(233,238,247,.9)";
      ctx.font = "1000 11px " + getComputedStyle(document.documentElement).getPropertyValue("--font").trim();
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.fillText(String(v), x + barW/2, y - 6);

      if(i % 2 === 0){
        ctx.fillStyle = "rgba(168,179,198,.9)";
        ctx.font = "1000 11px " + getComputedStyle(document.documentElement).getPropertyValue("--font").trim();
        ctx.textBaseline = "top";
        ctx.fillText(String(tl[i].label||""), x + barW/2, pad + chartH + 6);
      }
    }

    const sum = tl.reduce((a,x)=>a+(Number(x.count)||0),0);
    const windows = Math.max(1, tl.length);
    const avgPerWindow = Math.round(sum/windows);
    const estPerHour = Math.round(avgPerWindow*4);

    if(metaId){
      $(metaId).textContent = (LANG==="ar")
        ? `Ù…ØªÙˆØ³Ø·/Ù†Ø§ÙØ°Ø©: ${formatNumber(avgPerWindow)} Â· ØªÙ‚Ø¯ÙŠØ±ÙŠ/Ø³Ø§Ø¹Ø©: ${formatNumber(estPerHour)}`
        : `Avg/window: ${formatNumber(avgPerWindow)} Â· Est/hour: ${formatNumber(estPerHour)}`;
    }
  }

  function refreshDashboard(){
    if(!ACTIVE_EVENT_ID || !STATE.events[ACTIVE_EVENT_ID]) return;
    const ev = getActiveEvent();

    // timeline
    if(!Array.isArray(ev.timeline) || ev.timeline.length===0){
      ev.timeline = computeTimelineFromRows(ev.rows||[]);
    }

    setHeaderPills(ev);
    loadEventToForm(ev);

    const m = computeMetrics(ev);
    renderKPIs(m);
    drawDonut("donut","donutMeta",m);
    drawBars("bars","barMeta",ev.timeline);
    renderTable(ev);

    saveState();
  }

  // ========= REPORT BUILD (for print) =========
  function buildReport(){
    const ev = getActiveEvent();
    const m = computeMetrics(ev);

    // peak window
    let peak = {label:"â€”", count:0};
    for(const x of (ev.timeline||[])){
      const c = Number(x.count)||0;
      if(c > peak.count) peak = {label:x.label, count:c};
    }

    // header
    $("rEvent").textContent = ev.name || "â€”";
    $("rDate").textContent = ev.date || "â€”";
    $("rGen").textContent = (LANG==="ar") ? `ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${nowStamp()}` : `Generated: ${nowStamp()}`;
    $("rVenue").textContent = ev.venue ? (LANG==="ar" ? `Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${ev.venue}` : `Venue: ${ev.venue}`) : (LANG==="ar" ? "Ø§Ù„Ù…ÙˆÙ‚Ø¹: â€”" : "Venue: â€”");
    $("rContact").textContent = ev.contact ? ev.contact : "â€”";
    const repId = `KRS-INVITE-${(ev.name||"EVENT").replace(/\s+/g,"-")}-${new Date().toISOString().slice(0,10)}`;
    $("rReportId").textContent = `REPORT ID: ${repId}`;

    $("rQuality").textContent = (LANG==="ar") ? `Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„: ${m.quality}/100` : `Ops Quality: ${m.quality}/100`;
    $("rDonutMeta").textContent = (LANG==="ar")
      ? `Ø­Ø¶ÙˆØ±: ${formatNumber(m.checked)} Â· ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…: ${formatNumber(m.unused)}`
      : `Checked: ${formatNumber(m.checked)} Â· Unused: ${formatNumber(m.unused)}`;

    // KPIs in report
    const rg = $("rKpiGrid");
    rg.innerHTML = "";
    const items = (LANG==="ar") ? [
      {t:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª", v:formatNumber(m.total), s:"Total codes"},
      {t:"ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„", v:formatNumber(m.checked), s:`Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±: ${m.attendancePct}%`},
      {t:"ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…", v:formatNumber(m.unused), s:`Ù†Ø³Ø¨Ø© ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${m.unusedPct}%`},
      {t:"Ù…Ø±ÙÙˆØ¶/ØªÙ†Ø¨ÙŠÙ‡Ø§Øª", v:formatNumber(m.rejected), s:`Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª ÙŠØ¯ÙˆÙŠØ©: ${formatNumber(m.manual)}`},
    ] : [
      {t:"Total Invites", v:formatNumber(m.total), s:"Total codes"},
      {t:"Checked-in", v:formatNumber(m.checked), s:`Attendance: ${m.attendancePct}%`},
      {t:"Unused", v:formatNumber(m.unused), s:`Unused: ${m.unusedPct}%`},
      {t:"Rejected/Alerts", v:formatNumber(m.rejected), s:`Manual overrides: ${formatNumber(m.manual)}`},
    ];
    for(const it of items){
      const el = document.createElement("div");
      el.className = "kpi";
      el.innerHTML = `
        <div class="t">${escapeHtml(it.t)}</div>
        <div class="v">${escapeHtml(it.v)}</div>
        <div class="s">${escapeHtml(it.s)}</div>
      `;
      rg.appendChild(el);
    }

    // charts
    drawDonut("rDonut", null, m);
    drawBars("rBars", "rBarMeta", ev.timeline || []);

    $("rCountLine").textContent = (LANG==="ar")
      ? `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${formatNumber((ev.rows||[]).length)}`
      : `Total rows: ${formatNumber((ev.rows||[]).length)}`;

    // details (last 150)
    const rows = (ev.rows||[]).slice(0,150);
    $("rDetailsCount").textContent = (LANG==="ar") ? `Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${rows.length}` : `Rows: ${rows.length}`;
    const tb = $("rTbody");
    tb.innerHTML = "";
    for(const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(r.code||"â€”")}</td>
        <td>${escapeHtml(r.owner||"â€”")}</td>
        <td>${statusTag(r.status, LANG)}</td>
        <td class="mono">${escapeHtml(r.time||"â€”")}</td>
        <td>${escapeHtml(r.gate||"â€”")}</td>
      `;
      tb.appendChild(tr);
    }

    // right insights
    $("rPeakText").innerHTML = (LANG==="ar")
      ? `Ø£Ø¹Ù„Ù‰ Ø°Ø±ÙˆØ© ÙƒØ§Ù†Øª Ø¹Ù†Ø¯ <b>${escapeHtml(peak.label||"â€”")}</b> Ø¨Ø¹Ø¯Ø¯ <b>${formatNumber(peak.count||0)}</b> Ø¯Ø®ÙˆÙ„.`
      : `Peak window: <b>${escapeHtml(peak.label||"â€”")}</b> with <b>${formatNumber(peak.count||0)}</b> entries.`;

    const ops = (LANG==="ar")
      ? `â€¢ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ Ù„Ù„Ø­Ø¯Ø« Ø§Ù„Ù…Ø®ØªØ§Ø± Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….<br>â€¢ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø­ÙØ¸ PDF.<br>â€¢ ÙŠÙˆØµÙ‰ Ø¨Ø­ÙØ¸ Ù†Ø³Ø®Ø© PDF Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©.`
      : `â€¢ Report generated for selected event.<br>â€¢ Print/PDF ready layout.<br>â€¢ Recommended: save PDF right after the event.`;
    $("rOpsText").innerHTML = ops;

    const alerts = (LANG==="ar")
      ? `â€¢ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø±ÙÙˆØ¶Ø©: <b>${formatNumber(m.rejected)}</b><br>â€¢ Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª ÙŠØ¯ÙˆÙŠØ©: <b>${formatNumber(m.manual)}</b>`
      : `â€¢ Rejected attempts: <b>${formatNumber(m.rejected)}</b><br>â€¢ Manual overrides: <b>${formatNumber(m.manual)}</b>`;
    $("rAlertsText").innerHTML = alerts;

    $("rFooterStamp").textContent = nowStamp();
  }

  // ========= CSV Import / Export =========
  function parseCSV(text){
    const out = [[]];
    let cur="", inQ=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i], next=text[i+1];
      if(ch === '"'){
        if(inQ && next === '"'){ cur+='"'; i++; }
        else inQ = !inQ;
      } else if(ch === "," && !inQ){
        out[out.length-1].push(cur); cur="";
      } else if((ch === "\n" || ch === "\r") && !inQ){
        if(ch === "\r" && next === "\n") i++;
        out[out.length-1].push(cur); cur="";
        out.push([]);
      } else {
        cur += ch;
      }
    }
    out[out.length-1].push(cur);

    const clean = out.filter(r => r.some(c => String(c||"").trim() !== ""));
    if(clean.length===0) return {headers:[], rows:[]};
    const headers = clean[0].map(h=>String(h||"").trim());
    const body = clean.slice(1).map(r=>{
      const obj={};
      headers.forEach((h,idx)=> obj[h]= (r[idx] ?? "").trim());
      return obj;
    });
    return {headers, rows: body};
  }

  function importCSV(csvText){
    const parsed = parseCSV(csvText);
    if(parsed.rows.length===0){
      toast(`âš ï¸ <b>${LANG==="ar" ? "CSV ÙØ§Ø±Øº" : "Empty CSV"}</b>`);
      return;
    }

    const get = (obj, keys) => {
      for(const k of keys){
        const found = Object.keys(obj).find(h => h.toLowerCase() === k.toLowerCase());
        if(found) return obj[found];
      }
      return "";
    };

    const currentEv = getActiveEvent();
    let addedCount = 0;

    for(const o of parsed.rows){
      const code = safeText(get(o, ["Code","code","InviteCode","invite_code"]));
      const owner = safeText(get(o, ["Owner","owner","Name","name","Guest","guest"]));
      const status = normalizeStatus(get(o, ["Status","status","Used","used","Checkin","checkin"]));
      const time = safeText(get(o, ["Time","time","CheckinTime","checkin_time"]));
      const gate = safeText(get(o, ["Gate","gate","Staff","staff","Device","device"]));
      const eventName = safeText(get(o, ["EventName","eventname","Event","event"])) || currentEv.name;

      if(!code && !owner) continue;

      // find/create event by name
      const existing = Object.values(STATE.events).find(e => (e.name||"").trim().toLowerCase() === eventName.trim().toLowerCase());
      let ev = existing;
      if(!ev){
        const id = uid();
        ev = { id, name:eventName || `Event ${Object.keys(STATE.events).length+1}`, date:"â€”", venue:"", contact:"", totalInvites:0, rows:[], timeline:[] };
        STATE.events[id] = ev;
      }
      ev.rows.push({ code, owner, status, time, gate });
      addedCount++;
    }

    // normalize & compute timeline
    for(const id of Object.keys(STATE.events)){
      const ev = STATE.events[id];
      ev.rows = normalizeRowsUniqueByCode(ev.rows || []);
      if(Number(ev.totalInvites||0) < ev.rows.length) ev.totalInvites = ev.rows.length;
      ev.timeline = computeTimelineFromRows(ev.rows);
    }

    toast(`âœ… <b>${LANG==="ar" ? "ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯" : "Imported"}</b> Â· ${formatNumber(addedCount)}`);
    buildEventList();
    saveState();
    refreshDashboard();
  }

  function exportCSVForActiveEvent(){
    const ev = getActiveEvent();
    const header = ["Code","Owner","Status","Time","Gate","EventName"];
    const lines = [header.join(",")];
    for(const r of (ev.rows||[])){
      lines.push([
        csvCell(r.code),
        csvCell(r.owner),
        csvCell(r.status),
        csvCell(r.time),
        csvCell(r.gate),
        csvCell(ev.name)
      ].join(","));
    }
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `KRS_INVITE_${(ev.name||"event").replace(/\s+/g,"_")}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
    toast(`â¬‡ï¸ <b>${LANG==="ar" ? "ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±" : "Exported"}</b>`);
  }
  function csvCell(v){
    const s = String(v ?? "").replace(/"/g,'""');
    return `"${s}"`;
  }

  // ========= Event CRUD =========
  function createNewEvent(){
    const name = prompt(LANG==="ar" ? "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯:" : "Enter new event name:");
    if(!name || !String(name).trim()){
      toast(`âš ï¸ <b>${LANG==="ar" ? "Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« Ù…Ø·Ù„ÙˆØ¨" : "Event name required"}</b>`);
      return;
    }
    const id = uid();
    STATE.events[id] = { id, name:String(name).trim(), date:"â€”", venue:"", contact:"", totalInvites:0, rows:[], timeline:[] };
    ACTIVE_EVENT_ID = id;
    STATE.activeEventId = id;
    buildEventList();
    saveState();
    refreshDashboard();
    toast(`â• <b>${LANG==="ar" ? "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¯Ø«" : "Event created"}</b>`);
  }

  function deleteActiveEvent(){
    const ev = getActiveEvent();
    const ok = confirm(LANG==="ar"
      ? `ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø­Ø¯Ø«: "${ev.name}" ØŸ (Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)`
      : `Delete event "${ev.name}"? This will remove all its data.`);
    if(!ok) return;

    delete STATE.events[ACTIVE_EVENT_ID];
    const ids = Object.keys(STATE.events);
    if(ids.length===0){
      STATE = defaultState();
    }
    ACTIVE_EVENT_ID = Object.keys(STATE.events)[0];
    STATE.activeEventId = ACTIVE_EVENT_ID;

    buildEventList();
    saveState();
    refreshDashboard();
    toast(`ğŸ—‘ï¸ <b>${LANG==="ar" ? "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø¯Ø«" : "Event deleted"}</b>`);
  }

  // ========= Print Report =========
  function printFinalReport(){
    const ev = getActiveEvent();

    // save form + normalize before report
    saveFormToEvent(ev);
    ev.rows = normalizeRowsUniqueByCode(ev.rows||[]);
    if(Number(ev.totalInvites||0) < ev.rows.length) ev.totalInvites = ev.rows.length;
    ev.timeline = computeTimelineFromRows(ev.rows||[]);

    buildReport();
    saveState();

    // give browser a moment to paint canvases
    setTimeout(()=> window.print(), 120);
  }

  // ========= Wiring =========
  function init(){
    STATE = loadState();
    LANG = STATE.languageDefault === "en" ? "en" : "ar";
    ACTIVE_EVENT_ID = STATE.activeEventId;

    applyLang();
    buildEventList();

    // initial compute timeline for all
    for(const id of Object.keys(STATE.events)){
      const ev = STATE.events[id];
      ev.rows = normalizeRowsUniqueByCode(ev.rows||[]);
      if(Number(ev.totalInvites||0) < ev.rows.length) ev.totalInvites = ev.rows.length;
      if(!Array.isArray(ev.timeline) || ev.timeline.length===0) ev.timeline = computeTimelineFromRows(ev.rows);
    }

    saveState();
    refreshDashboard();

    $("eventSelect").addEventListener("change", ()=>{
      ACTIVE_EVENT_ID = $("eventSelect").value;
      STATE.activeEventId = ACTIVE_EVENT_ID;
      saveState();
      refreshDashboard();
    });

    $("langBtn").addEventListener("click", ()=>{
      LANG = (LANG==="ar") ? "en" : "ar";
      STATE.languageDefault = LANG;
      applyLang();
      buildEventList();
      saveState();
      refreshDashboard();
      toast(`ğŸŒ <b>${LANG==="ar" ? "ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©" : "Language switched"}</b>`);
    });

    $("saveBtn").addEventListener("click", ()=>{
      const ev = getActiveEvent();
      saveFormToEvent(ev);
      buildEventList();
      saveState();
      refreshDashboard();
      toast(`âœ… <b>${LANG==="ar" ? "ØªÙ… Ø§Ù„Ø­ÙØ¸" : "Saved"}</b>`);
    });

    $("newEventBtn").addEventListener("click", createNewEvent);
    $("deleteEventBtn").addEventListener("click", deleteActiveEvent);

    $("resetBtn").addEventListener("click", ()=>{
      const ok = confirm(LANG==="ar"
        ? "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ"
        : "This will erase ALL events and data. Continue?");
      if(!ok) return;
      localStorage.removeItem(STORE_KEY);
      STATE = defaultState();
      LANG = STATE.languageDefault;
      ACTIVE_EVENT_ID = STATE.activeEventId;
      applyLang();
      buildEventList();
      saveState();
      refreshDashboard();
      toast(`ğŸ§¹ <b>${LANG==="ar" ? "ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·" : "Reset done"}</b>`);
    });

    $("printReportBtn").addEventListener("click", printFinalReport);

    $("search").addEventListener("input", ()=> renderTable(getActiveEvent()));
    $("statusFilter").addEventListener("change", ()=> renderTable(getActiveEvent()));

    $("normalizeBtn").addEventListener("click", ()=>{
      const ev = getActiveEvent();
      ev.rows = normalizeRowsUniqueByCode(ev.rows||[]);
      if(Number(ev.totalInvites||0) < ev.rows.length) ev.totalInvites = ev.rows.length;
      ev.timeline = computeTimelineFromRows(ev.rows||[]);
      saveState();
      refreshDashboard();
      toast(`ğŸ§¼ <b>${LANG==="ar" ? "ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" : "Normalized"}</b>`);
    });

    $("autoTimeBtn").addEventListener("click", ()=>{
      const ev = getActiveEvent();
      ev.timeline = computeTimelineFromRows(ev.rows||[]);
      saveState();
      refreshDashboard();
      toast(`â±ï¸ <b>${LANG==="ar" ? "ØªÙ… ØªÙˆÙ„ÙŠØ¯ Timeline" : "Timeline generated"}</b>`);
    });

    $("addBtn").addEventListener("click", ()=>{
      const ev = getActiveEvent();
      const code = safeText($("addCode").value);
      const owner = safeText($("addOwner").value);
      const status = normalizeStatus($("addStatus").value);
      let time = safeText($("addTime").value);
      const gate = safeText($("addGate").value);

      if(!code){
        toast(`âš ï¸ <b>${LANG==="ar" ? "Ø§Ù„ÙƒÙˆØ¯ Ù…Ø·Ù„ÙˆØ¨" : "Code is required"}</b>`);
        return;
      }
      if(!time){
        const d=new Date();
        const min=String(d.getMinutes()).padStart(2,"0");
        let hh=d.getHours();
        const ap=hh>=12 ? "PM":"AM";
        hh=hh%12; if(hh===0) hh=12;
        time = `${hh}:${min} ${ap}`;
      }

      ev.rows.unshift({code, owner, status, time, gate});
      ev.rows = normalizeRowsUniqueByCode(ev.rows||[]);
      if(Number(ev.totalInvites||0) < ev.rows.length) ev.totalInvites = ev.rows.length;
      ev.timeline = computeTimelineFromRows(ev.rows||[]);
      saveState();
      refreshDashboard();

      $("addCode").value=""; $("addOwner").value=""; $("addTime").value=""; $("addGate").value="";
      toast(`â• <b>${LANG==="ar" ? "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©" : "Added"}</b>`);
    });

    $("sampleBtn").addEventListener("click", ()=>{
      STATE = defaultState();
      // add second event sample
      const id2 = uid();
      STATE.events[id2] = {
        id:id2,
        name:"Ø²ÙØ§Ù Ø´Ù…Ù‡",
        date:"20-01-2026 Â· 6:00 PM â€“ 11:00 PM",
        venue:"Dubai â€” Venue 2",
        contact:"krs2.store@gmail.com",
        totalInvites: 350,
        rows:[
          {code:"MS_001", owner:"Ahmed", status:"checked", time:"6:10 PM", gate:"Gate 1 / Staff A"},
          {code:"MS_002", owner:"Sara", status:"checked", time:"6:12 PM", gate:"Gate 1 / Staff A"},
          {code:"MS_003", owner:"Huda", status:"unused", time:"", gate:""},
          {code:"MS_004", owner:"Khalid", status:"rejected_invalid", time:"6:20 PM", gate:"Gate 1 / Staff B"},
        ],
        timeline:[]
      };
      for(const id of Object.keys(STATE.events)){
        const ev = STATE.events[id];
        ev.rows = normalizeRowsUniqueByCode(ev.rows||[]);
        ev.timeline = computeTimelineFromRows(ev.rows||[]);
        if(Number(ev.totalInvites||0) < ev.rows.length) ev.totalInvites = ev.rows.length;
      }
      ACTIVE_EVENT_ID = STATE.activeEventId;
      LANG = STATE.languageDefault;
      applyLang();
      buildEventList();
      saveState();
      refreshDashboard();
      toast(`âœ¨ <b>${LANG==="ar" ? "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©" : "Sample loaded"}</b>`);
    });

    $("exportBtn").addEventListener("click", exportCSVForActiveEvent);

    $("importBtn").addEventListener("click", async ()=>{
      const f = $("csvFile").files?.[0];
      if(!f){
        toast(`âš ï¸ <b>${LANG==="ar" ? "Ø§Ø®ØªØ± Ù…Ù„Ù CSV" : "Select a CSV file"}</b>`);
        return;
      }
      const text = await f.text();
      importCSV(text);
    });

    // fast update pills while typing
    ["eventName","eventDate"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        $("evPill").textContent = safeText($("eventName").value) || "â€”";
        $("datePill").textContent = safeText($("eventDate").value) || "â€”";
      });
    });

    // redraw on resize
    let rt=null;
    window.addEventListener("resize", ()=>{
      clearTimeout(rt);
      rt=setTimeout(()=> refreshDashboard(), 180);
    });
  }

  init();
})();
</script>
</body>
</html>
