<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ุจูุงุจุฉ ุงูุฏุนูุงุช | ูุนูู ูุญูููุง ุจุงููุงูู</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
      * { box-sizing: border-box; }
      body { background:#0a0a0a; color:#eee; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Naskh Arabic UI", Arial, sans-serif; }
      .card { background:#111418; border:1px solid #23262b; border-radius:16px; }
      .btn { border-radius:14px; padding:.6rem 1rem; border:1px solid #2a2d33; }
      .btn-primary { background:#facc15; color:#111; border-color:#facc15; }
      .btn-ghost { background:#1a1e24; color:#e6e6e6; }
      .chip { background:#1c2128; color:#c9c9c9; border-radius:10px; padding:.25rem .6rem; border:1px solid #2a2d33; }
      table th, table td { padding:.6rem .4rem; }
      .thumb { width:56px; height:56px; object-fit:contain; border:1px solid #2a2d33; border-radius:8px; background:#0f1318; }
      a.link { color:#93c5fd; }
      code { background:#0f1318; padding:.2rem .35rem; border-radius:6px; border:1px solid #23262b }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef, useCallback } = React;

      // START: LOCAL STORAGE HANDLERS
      const SafeStorage = (() => {
        try { const t='__probe__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; } catch(e){
          const mem = {}; return { getItem:k=>mem[k]??null, setItem:(k,v)=>{mem[k]=String(v)}, removeItem:k=>{delete mem[k]} };
        }
      })();

      const LS_INVITES = 'hormez_invites';
      const LS_QR_CARDS = 'hormez_qr_cards';
      const LS_QR_CACHE = 'hormez_qr_cache'; 
      
      const loadInitialData = (key, defaultValue = []) => {
        try {
          const data = JSON.parse(SafeStorage.getItem(key));
          return Array.isArray(data) ? data : defaultValue;
        } catch (e) {
          console.warn(`Failed to load data for ${key}.`, e);
          return defaultValue;
        }
      };

      const QRDataCache = new Map(JSON.parse(SafeStorage.getItem(LS_QR_CACHE) || '[]')); 
      
      const updateQrCache = () => {
        SafeStorage.setItem(LS_QR_CACHE, JSON.stringify(Array.from(QRDataCache.entries())));
      };
      
      // END: LOCAL STORAGE HANDLERS

      // ======= utils =======
      const normalizePhone=(p)=>String(p||'').replace(/\D/g,'');
      const hashString=(str)=>{ let h=5381,i=str.length; while(i){ h=(h*33)^str.charCodeAt(--i);} return (h>>>0).toString(36); };

      const openWhatsApp = (phone, message) => {
        const digits = normalizePhone(phone); if(!digits){ alert('ุฑูู ุงููุงุชู ุบูุฑ ุตุงูุญ'); return; }
        const url = `https://wa.me/${digits}?text=${encodeURIComponent(message)}`;
        try { const w=window.open(url,'_blank','noopener,noreferrer'); if(!w) alert('ููุงูุน ุงูููุงูุฐ ูุฏ ูููุน ุงููุชุญ. ุงูุชุญ ุงูุฑุงุจุท ูุฏูููุง:\n'+url); }
        catch{ alert('ุชุนุฐุฑ ูุชุญ ูุงุชุณุงุจ. ุงูุณุฎ ุงูุฑุงุจุท ูุฏูููุง:\n'+url); }
      };
      
      function getQrMetadata(file, dataUrl){
        const name=file.name||'qr';
        const m = name.match(/(\d{3,})/); const cardNumber = m? m[1]: null;
        const contentHash = hashString(dataUrl); 
        const id = Date.now()+"_"+Math.random().toString(36).slice(2,8);

        try {
            QRDataCache.set(id, dataUrl);
            updateQrCache();
        } catch (error) {
            console.error("Local storage limit hit or other cache error:", error);
            alert("ุชุญุฐูุฑ: ุชุฌุงูุฒ ุญุฏ ุงูุฐุงูุฑุฉ ุงููุญููุฉ. ูู ูุชู ุญูุธ ุจุนุถ ุตูุฑ ุงูุจุงุฑููุฏ ุจุดูู ูุงูู.");
        }
        
        return { id, name, used:false, cardNumber, contentHash }; 
      }
      
      const readFileAsDataURL = (file) => {
          return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(file);
          });
      };
      
      const readFileAsText = (file) => {
          return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsText(file);
          });
      };

      const makeInvite=({guestName,phone,count,eventName,qrList=[]})=>({
        id: Date.now()+"_"+Math.random().toString(36).slice(2,8),
        guestName:(guestName||'').trim(),
        phone: normalizePhone(phone),
        count: Math.max(1, Number(count||1)),
        eventName:(eventName||'ุจุฏูู ุงุณู ุญุฏุซ').trim(),
        status: 'new', createdAt:new Date().toISOString(),
        qrIds: qrList.map(q=>q.id),
        qrId: qrList[0]?.id || null,
        qrName: qrList[0]?.name || null,
        qrNumber: qrList[0]?.cardNumber || null,
      });
      const computeStats=(inv)=>({ total:inv.length, sent:inv.filter(i=>['sent','reminded','attended'].includes(i.status)).length, attended:inv.filter(i=>i.status==='attended').length });

      function parseCSV(text){
        const lines=text.trim().split(/\r?\n/).filter(Boolean); if(!lines.length) return [];
        const first=lines[0].split(',').map(s=>s.trim().toLowerCase());
        const hasHeader=['name','phone','count','event'].some(k=>first.includes(k));
        const body = hasHeader? lines.slice(1): lines;
        return body.map(line=>{ const [a,b,c,d]=line.split(',').map(x=>x?.trim()??''); return { guestName:a||'', phone:b||'', count:Math.max(1,Number(c||1)), eventName:d||'' }; });
      }
      async function readXLSX(file){
        const data=await file.arrayBuffer(); const wb=XLSX.read(data,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]]; const arr=XLSX.utils.sheet_to_json(ws,{header:1});
        const rows=arr.filter(r=>r && r.length); if(!rows.length) return [];
        const first=rows[0].map(v=>String(v||'').trim().toLowerCase());
        const hasHeader=['name','phone','count','event'].some(k=>first.includes(k));
        const body=hasHeader? rows.slice(1): rows;
        return body.map(r=>{ const [a,b,c,d]=r; return { guestName:String(a||'').trim(), phone:String(b||'').trim(), count:Math.max(1,Number(c||1)), eventName:String(d||'').trim()}; });
      }
      
      function downloadJSON(data, filename) {
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function App(){
        
        // โ๏ธ ุชุนุฏูู ูุฏูู ููุง
        // ----------------------------------------------------
        const FIXED_EVENT_NAME = "ุฒูุงู ุนุจุฏุงููู"; // ุถุน ุงุณู ุงูุญุฏุซ ููุง
        const FIXED_PASSWORD = "123"; // ุถุน ูููุฉ ุงููุฑูุฑ ููุง
        // ----------------------------------------------------

        const [eventName, setEventName] = useState(FIXED_EVENT_NAME);
        const [password, setPassword] = useState(''); // ููุท ูุฃุบุฑุงุถ ุงูุฅุฏุฎุงู ูู ุงููุงุฌูุฉ
        const [isLoggedIn, setIsLoggedIn] = useState(false);

        const login = () => {
          if (!eventName) { alert('ูุฌุจ ุชุนููู ุงุณู ุงูุญุฏุซ ูุฏููุง ุฏุงุฎู ุงูููุฏ.'); return; }
          if (password !== FIXED_PASSWORD) {
              alert('ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ.');
              return;
          }
          setIsLoggedIn(true);
        };
        
        const logout = () => {
          setIsLoggedIn(false);
          setPassword('');
        };
        
        if (!isLoggedIn) {
          return (
            <div className="min-h-screen flex items-center justify-center p-6">
              <div className="card w-full max-w-md p-6">
                <h1 className="text-center text-2xl font-black mb-6">ุงูุฏุฎูู ูููุญุฉ ุงูุชุญูู</h1>
                <p className="text-sm text-neutral-400 mb-4">ุงุณู ุงูุญุฏุซ ุซุงุจุช ูููุนููู ูู ุงูููุฏ: **{eventName}**.</p>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm mb-1">ุงุณู ุงูุญุฏุซ (ูุนููู ูุฏููุงู)</label>
                    <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2 text-neutral-400" value={eventName} readOnly />
                  </div>
                  <div>
                    <label className="block text-sm mb-1">ูููุฉ ุงููุฑูุฑ ุงููุทููุจุฉ</label>
                    <input type="password" className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" placeholder="โขโขโขโขโขโขโขโข" value={password} onChange={e=>setPassword(e.target.value)} />
                    <p className="text-xs text-neutral-400 mt-1">ูุฌุจ ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ ุงูููุนูููุฉ ูุฏููุงู ูู ุงูููุฏ ููุฏุฎูู.</p>
                  </div>
                  <button onClick={login} className="btn btn-primary w-full font-bold">
                    ุฏุฎูู
                  </button>
                </div>
              </div>
            </div>
          );
        }
        
        return <EventApp event={eventName} onLogout={logout} />;
      }


      function EventApp({ event, onLogout }){
        const [invites,setInvites]=useState(() => loadInitialData(LS_INVITES)); 
        const [qrCards,setQrCards]=useState(() => loadInitialData(LS_QR_CARDS)); 
        const [active,setActive]=useState('home');
        const stats=useMemo(()=>computeStats(invites),[invites]);

        const saveInvites = useCallback((arr) => SafeStorage.setItem(LS_INVITES, JSON.stringify(arr)), []);
        const saveQRCards = useCallback((arr) => SafeStorage.setItem(LS_QR_CARDS, JSON.stringify(arr)), []);
        
        useEffect(()=>{ saveInvites(invites); },[invites, saveInvites]);
        useEffect(()=>{ saveQRCards(qrCards); },[qrCards, saveQRCards]);
        
        const takeNextQrCards=(k)=>{
          const available=qrCards.filter(c=>!c.used);
          if(available.length<k) return null;
          const chosen=available.slice(0,k);
          const next=qrCards.map(c=> chosen.find(x=>x.id===c.id)? { ...c, used:true }: c);
          setQrCards(next); 
          return chosen.map(c=>({ ...c }));
        };
        const returnQrToPool=(ids=[])=>{
          const list=Array.isArray(ids)? ids: (ids? [ids]: []);
          if(!list.length) return;
          setQrCards(prev=> prev.map(c=> list.includes(c.id)? { ...c, used:false }: c)); 
        };

        const addInvite=({guestName,phone,count,eventName})=>{
          const k=Math.max(1, Number(count||1));
          const qrList=takeNextQrCards(k);
          if(!qrList){ alert('ูุง ุชูุฌุฏ ูุฑูุช ูุงููุฉ ุญุณุจ ุงูุนุฏุฏ ุงูููุฏุฎู. ูู ุจุชุญููู ุงููุฒูุฏ.'); return; }
          const inv=makeInvite({ guestName, phone, count:k, eventName:eventName||event, qrList });
          setInvites(prev=>[inv, ...prev]); 
        };
        const deleteInvite=(id)=>{
          setInvites(prev=>{
            const inv=prev.find(x=>x.id===id);
            if(inv?.qrIds?.length) returnQrToPool(inv.qrIds);
            else if(inv?.qrId) returnQrToPool([inv.qrId]);
            return prev.filter(x=>x.id!==id);
          });
        };
        const markStatus=(id,status)=> setInvites(prev=> prev.map(i=> i.id===id? { ...i, status }: i)); 

        const sendText=(inv)=>{
          const msg=`ูุฑุญุจุง ${inv.guestName}\n\nูุดุฑููุง ุฏุนูุชู ูุญุถูุฑ ุงููุนุงููุฉ: ${event}\nุนุฏุฏ ูุฑูุช ุงููุฑุงูููู: ${inv.count}\n\nโ๏ธ ููุงุญุธุฉ: ูุฌุจ ุนููู ุฅุฑุณุงู ุตูุฑุฉ ุงูุจุงุฑููุฏ ูุฏููุงู ุฅูู ุงูุถูู.`;
          openWhatsApp(inv.phone,msg); markStatus(inv.id,'sent');
        };
        const bulkSend=(list)=>{ if(!confirm(`ุณูุชู ูุชุญ ${list.length} ุฑุณุงูุฉ/ุชุจููุจ. ูุฏ ูููุน ุงููุชุตูุญ ุจุนุถูุง. ูุชุงุจุนุฉุ`)) return; list.forEach((inv,i)=> setTimeout(()=>sendText(inv), i*350)); };
        
        // ๐จ ุชู ุชุนุฏูู ูุฐู ุงูุฏุงูุฉ ูุญู ูุดููุฉ ุชุฎุตูุต ุงูุจุงุฑููุฏ ุนูุฏ ุงูุงุณุชูุฑุงุฏ ุงูุฌูุงุนู
        const handleImportPeopleFile = async (file)=>{
          try {
            let rows=[];
            if(/\.(xlsx|xlsm|xlsb|xls)$/i.test(file.name)) rows = await readXLSX(file); else rows = parseCSV(await file.text());
            if(!rows.length){ alert('ูุง ุชูุฌุฏ ุจูุงูุงุช'); return; }
            
            const added = rows.map(r => ({ guestName:r.guestName, phone:r.phone, count:r.count, eventName:event }));
            
            // 1. ุชุตููุฉ ุงูุจูุงูุงุช ุงูููุฑุฑุฉ ุจูุงุกู ุนูู ุฑูู ุงููุงุชู
            const existingPhones = new Set(invites.map(i => normalizePhone(i.phone)));
            const uniqueAdded = added.filter(x => {
              const normalizedPhone = normalizePhone(x.phone);
              if (normalizedPhone.length < 9) return false; // ุชุฌุงูู ุงูุฃุฑูุงู ุบูุฑ ุงููุงููุฉ
              if (existingPhones.has(normalizedPhone)) {
                console.warn(`Skipping duplicate phone: ${x.phone} for ${x.guestName}`);
                return false;
              }
              existingPhones.add(normalizedPhone);
              return true;
            });

            if (!uniqueAdded.length) {
              alert('ูู ูุชู ุงุณุชูุฑุงุฏ ุฃู ุณุฌูุงุช ูุฑูุฏุฉ (ูุฏ ุชููู ููุฑุฑุฉ ุฃู ุฃุฑูุงู ุงูููุงุชู ุบูุฑ ุตุงูุญุฉ).');
              return;
            }

            // 2. ุญุณุงุจ ุฅุฌูุงูู ุงููุฑูุช ุงููุทููุจุฉ
            const totalNeededCards = uniqueAdded.reduce((sum, item) => sum + Math.max(1, Number(item.count || 1)), 0);
            const cardsRemaining = qrCards.filter(c=>!c.used).length;
            
            let reservedCards = [];
            
            if (totalNeededCards > cardsRemaining) {
              alert(`ุชุญุฐูุฑ: ูุง ุชุชููุฑ ูุฑูุช ุจุงุฑููุฏ ูุงููุฉ. ูุทููุจ ${totalNeededCards} ูุฑุชุ ุงููุชุงุญ ${cardsRemaining}. ุณูุชู ุฅุถุงูุฉ ุงูุฏุนูุงุช ุจุงููุฑูุช ุงููุชุงุญุฉ ููุท ูุงูุจููุฉ ุจุฏูู ูุฑูุช.`);
              // ุณุญุจ ุฌููุน ุงููุฑูุช ุงููุชุงุญุฉ ููุท
              const allAvailable = qrCards.filter(c=>!c.used);
              reservedCards = takeNextQrCards(allAvailable.length);
            } else {
              // 3. ุณุญุจ ุงููุฑูุช ุงููุทููุจุฉ ูุชุญุฏูุซ ุฑุตูุฏ ุงููุฑูุช
              reservedCards = takeNextQrCards(totalNeededCards);
            }
            
            let cardIndex = 0;
            const newInvites = uniqueAdded.map(x => {
                const k = Math.max(1, Number(x.count || 1));
                let qrListForInvite = [];

                if (reservedCards.length > cardIndex) {
                    // ุชุฎุตูุต ุงููุฑูุช ูู ุงููุฑูุช ุงููุณุญูุจุฉ
                    qrListForInvite = reservedCards.slice(cardIndex, cardIndex + k);
                    cardIndex += k;
                }
                
                // ุฅูุดุงุก ุงูุฏุนูุฉ ูุน ุงููุฑูุช ุงููุฑููุฉ
                // ุงูุนุฏุฏ ุงูุญูููู ููุฏุนูุฉ ุณูููู ูุณุงููุงู ูุนุฏุฏ ุงููุฑูุช ุงููุฑููุฉ ุฅุฐุง ูุงู ุฃูู ูู ุงููุทููุจ
                return makeInvite({ ...x, count: k, qrList: qrListForInvite });
            });

            // 4. ุฏูุฌ ุงูุฏุนูุงุช ุงูุฌุฏูุฏุฉ
            setInvites(prev => [...newInvites.filter(i => i.qrId || i.count === 0), ...prev]); // ููุชุฑุฉ ุงูุฏุนูุงุช ุงูุชู ูู ูุชู ุชุฎุตูุต ุฃู ูุฑุช ููุง ุฅุฐุง ูู ุชูู ููุงู ูุฑูุช ูุชุงุญุฉ
            
            alert(`ุชู ุงุณุชูุฑุงุฏ ${uniqueAdded.length} ุณุฌู. ูุชู ุชุฎุตูุต ${reservedCards.length} ูุฑุช ุจุงุฑููุฏ.`);

          } catch(e){ console.error(e); alert('ุชุนุฐุฑ ูุฑุงุกุฉ ุงูููู.'); }
        };
        
        // ุจููุฉ ุงูุฏูุงู (handleExportData, handleImportData) ููุง ูู ูุถูุงู ุณุญุจ JSON ูุงูู...
        const handleExportData = () => {
            const dataToExport = {
                eventName: event,
                invites: invites,
                qrCards: qrCards,
                qrDataCache: Array.from(QRDataCache.entries()) 
            };
            const filename = `hormez_export_${event}_${new Date().toISOString().slice(0, 10)}.json`;
            downloadJSON(dataToExport, filename);
        };

        const handleImportData = async (file) => {
            try {
                const text = await readFileAsText(file);
                const importedData = JSON.parse(text);

                if (!importedData || (!importedData.invites && !importedData.qrCards)) {
                    alert('ูุดู ูู ุงูุงุณุชูุฑุงุฏ: ููู JSON ุบูุฑ ููุชูู ุฃู ูุง ูุญุชูู ุนูู ุจูุงูุงุช ุงูุฏุนูุงุช ูุงููุฑูุช ุงูุฃุณุงุณูุฉ.');
                    return;
                }

                if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุงุณุชูุฑุงุฏ ุจูุงูุงุช ุงูุญุฏุซ '${importedData.eventName || 'ููุณุชูุฑุฏ'}'ุ ุณูุคุฏู ูุฐุง ุฅูู ูุณุญ ุงูุจูุงูุงุช ุงูุญุงููุฉ ูุญูููุง ูุงุณุชุจุฏุงููุง ุจุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ.`)) {
                    
                    // 1. ุชุญุฏูุซ ุงููุฑูุช
                    const importedQrCards = Array.isArray(importedData.qrCards) ? importedData.qrCards : [];
                    setQrCards(importedQrCards);

                    // 2. ุชุญุฏูุซ ุงููุงุด (ูุญุชูู ุงูุตูุฑ - ููู ุงูุฃูู ูุธููุฑ ุงูุจุงุฑููุฏ)
                    const importedCache = new Map(importedData.qrDataCache || []);
                    QRDataCache.clear();
                    importedCache.forEach((v, k) => QRDataCache.set(k, v));
                    updateQrCache();

                    // 3. ุชุญุฏูุซ ุงูุฏุนูุงุช
                    const importedInvites = Array.isArray(importedData.invites) ? importedData.invites : [];
                    setInvites(importedInvites);
                    
                    alert(`ุชู ุงูุงุณุชูุฑุงุฏ ุจูุฌุงุญ! ุชู ุชุญููู ${importedInvites.length} ุฏุนูุฉ ู ${importedQrCards.length} ูุฑุช.`);
                    
                    window.location.reload(); 
                }

            } catch (e) {
                console.error("Failed to import JSON data:", e);
                alert('ูุดู ูู ูุฑุงุกุฉ ููู JSON. ุชุฃูุฏ ูู ุฃูู ููู ุงูุชุตุฏูุฑ ุงูุตุญูุญ ูุบูุฑ ุชุงูู (ูุฏ ุชููู ุงููุดููุฉ ูู ุชูุณูู ุงูููู).');
            }
        };

        const cardsRemaining = qrCards.filter(c=>!c.used).length;
        const bulkCandidates = invites.filter(i=> i.status==='new' || i.status==='reminded');

        return (
          <div>
            <header className="sticky top-0 z-20 card px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span className="font-black">ููุญุฉ ุญุฏุซ: <span className="text-yellow-400">{event}</span></span>
              </div>
              <div className="flex items-center gap-2">
                <span className="chip">ุงููุฑูุช ุงููุชุงุญุฉ ูุญููุงู: {cardsRemaining}</span>
                <button className="btn btn-ghost" onClick={() => onLogout()}>ุฎุฑูุฌ/ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</button>
              </div>
            </header>

            <main className="max-w-6xl mx-auto p-4 md:p-8">
              <div className="card p-6">
                <div className="flex items-center justify-between flex-wrap gap-3">
                  <div>
                    <h2 className="text-xl md:text-2xl font-bold">ุฅุฏุงุฑุฉ ุงูุฏุนูุงุช (ูุนูู ูุญููุงู ููุท)</h2>
                    <p className="text-neutral-400">ุฌููุน ุงูุจูุงูุงุช ูุงููุฑูุช ุชูุญูุธ ุนูู ูุฐุง ุงูุฌูุงุฒ ููุท ููุง ุชูุฒุงููู ุณุญุงุจูุงู.</p>
                  </div>
                  <span className="chip">ุงูุฌุงูุฒุฉ ููุฅุฑุณุงู: {bulkCandidates.length}</span>
                </div>
                <div className="my-4 h-px bg-[#23262b]" />
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                  <Stat label="ุฅุฌูุงูู ุงูุฏุนูุงุช" value={stats.total} />
                  <Stat label="ุงูุฏุนูุงุช ุงูููุฑุณูุฉ" value={stats.sent} />
                  <Stat label="ุงูุญุถูุฑ" value={stats.attended} />
                  <Stat label="ุงููุฑูุช ุงููุชุจููุฉ" value={cardsRemaining} />
                </div>
              </div>

              <div className="flex flex-wrap gap-2 mt-4">
                {NavBtn('home','ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ',()=>setActive('home'),active)}
                {NavBtn('new','ุฏุนูุฉ ุฌุฏูุฏุฉ',()=>setActive('new'),active)}
                {NavBtn('send','ุงูุฅุฑุณุงู',()=>setActive('send'),active)}
                {NavBtn('import','ุงุณุชูุฑุงุฏ',()=>setActive('import'),active)}
              </div>

              {active==='home' && (
                <div className="card p-6 mt-3">
                  <InviteTable invites={invites} onMark={markStatus} onDelete={deleteInvite} />
                </div>
              )}

              {active==='new' && (
                <NewInviteForm 
                  onCreate={addInvite} 
                  forcedEventName={event} 
                  cardsRemaining={cardsRemaining} 
                  onImportPeopleFile={handleImportPeopleFile}
                />
              )}

              {active==='send' && (
                <SendCenter invites={invites} onSend={sendText} onBulk={bulkSend} />
              )}

              {active==='import' && (
                <ImportCenter qrCards={qrCards} setQrCards={setQrCards} onImportPeopleFile={handleImportPeopleFile} onExportData={handleExportData} onImportData={handleImportData} />
              )}
            </main>
          </div>
        );
      }

      function Stat({ label, value }){ return (<div className="card p-4"><p className="text-neutral-400 text-sm">{label}</p><p className="text-2xl font-extrabold mt-1">{value}</p></div>); }
      function NavBtn(key,label,onClick,active){ return <button onClick={onClick} className={`btn ${active===key? 'btn-primary' : 'btn-ghost'}`}>{label}</button>; }

      function InviteTable({ invites, onMark, onDelete }){
        if(!invites.length) return <div className="text-neutral-400 text-sm">ูุง ุชูุฌุฏ ุฏุนูุงุช ุจุนุฏ.</div>;
        return (
          <div className="overflow-x-auto">
            <table className="w-full text-right">
              <thead>
                <tr className="text-neutral-400 text-sm border-b border-[#23262b]">
                  <th>ุงูุงุณู</th>
                  <th>ุงูุฌูุงู</th>
                  <th>ุนุฏุฏ ุงููุฑูุช</th>
                  <th>ุงูุจุงุฑููุฏ</th>
                  <th>ุงูุญุงูุฉ</th>
                  <th>ุฅุฌุฑุงุกุงุช</th>
                </tr>
              </thead>
              <tbody>
                {invites.map(inv => (
                  <tr key={inv.id} className="border-b border-[#1a1e24]">
                    <td>{inv.guestName}</td>
                    <td dir="ltr">{inv.phone}</td>
                    <td>{inv.count}</td>
                    <td>
                      {inv.qrId && QRDataCache.get(inv.qrId) ? (
                        <div className="flex items-center gap-2">
                          <a className="link" href={QRDataCache.get(inv.qrId)} download={`${inv.qrName||'qr'}-${inv.qrNumber||''}.png`} title="ุชูุฒูู ุฃูู ุจุงุฑููุฏ (ูุญูู)">
                            <img className="thumb" src={QRDataCache.get(inv.qrId)} alt="QR" />
                          </a>
                          {Array.isArray(inv.qrIds) && inv.qrIds.length>1 && (
                            <span className="chip text-xs">+{inv.qrIds.length-1} ุฅุถุงููุฉ</span>
                          )}
                        </div>
                      ) : (<span className="chip">โ</span>)}
                    </td>
                    <td>
                      <span className={`chip ${inv.status==='new'?'':''} ${inv.status==='sent'?'!bg-blue-600 !text-white':''} ${inv.status==='reminded'?'!bg-purple-600 !text-white':''} ${inv.status==='attended'?'!bg-green-600 !text-white':''}`}>
                        {inv.status==='new'? 'ุฌุฏูุฏุฉ' : inv.status==='sent'? 'ููุฑุณูุฉ' : inv.status==='reminded'? 'ููุฐููุฑ' : 'ุญุถุฑ'}
                      </span>
                    </td>
                    <td>
                      <div className="flex gap-2 justify-end">
                        <button className="btn btn-primary" onClick={()=>onMark(inv.id,'sent')}>ุฅุฑุณุงู</button>
                        <button className="btn btn-ghost" onClick={()=>onMark(inv.id,'reminded')}>ุชุฐููุฑ</button>
                        <button className="btn btn-ghost" onClick={()=>onMark(inv.id,'attended')}>ุญุถูุฑ</button>
                        <button className="btn btn-ghost" onClick={()=>onDelete(inv.id)}>ุญุฐู</button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      }

      function NewInviteForm({ onCreate, forcedEventName, cardsRemaining, onImportPeopleFile }){
        const [guestName,setGuestName]=useState('');
        const [phone,setPhone]=useState('');
        const [count,setCount]=useState(1);
        const [eventName,setEventName]=useState(forcedEventName||'');
        const peopleInput=useRef(null);
        useEffect(()=>{ if(forcedEventName) setEventName(forcedEventName); },[forcedEventName]);

        const importFromContacts = async () => {
          try {
            const supported = 'contacts' in navigator && 'select' in (navigator.contacts||{});
            if(!supported){ alert('ูุฏ ูุง ูุฏุนู ูุชุตูุญู ุงุณุชูุฑุงุฏ ุฌูุงุช ุงูุงุชุตุงู. ุฌุฑูุจ ูุฑูู ุนูู ุฃูุฏุฑููุฏ.'); return; }
            const contacts = await navigator.contacts.select(['name','tel'], { multiple:false });
            if(contacts && contacts[0]){
              const c = contacts[0];
              setGuestName((c.name && c.name[0]) || '');
              setPhone((c.tel && c.tel[0]) || '');
            }
          } catch { alert('ุชุนุฐุฑ ุงููุตูู ูุฌูุงุช ุงูุงุชุตุงู'); }
        };

        const handlePeoplePick=(e)=>{ 
          const f=e.target.files?.[0]; 
          if(f) onImportPeopleFile(f); 
          e.target.value=''; 
        };

        const create=()=>{
          if(!guestName || !phone){ alert('ูุฑุฌู ุฅุฏุฎุงู ุงูุงุณู ูุฑูู ุงููุงุชู'); return; }
          if(cardsRemaining <= 0){ alert('ูุง ุชูุฌุฏ ูุฑูุช ุจุงุฑููุฏ ูุชุงุญุฉ. ุงุฑูุนูุง ุฃููุงู ูู ุชุจููุจ ุงูุงุณุชูุฑุงุฏ.'); return; }
          onCreate({ guestName, phone, count, eventName });
          setGuestName(''); setPhone(''); setCount(1);
        };

        return (
          <div className="card p-6 mt-3">
            <div className="grid md:grid-cols-2 gap-4">
              <div className="md:col-span-2">
                <label className="mb-1 inline-block text-sm">ุงุณุชูุฑุงุฏ ุณุฑูุน ููุจูุงูุงุช</label>
                <div className="flex flex-wrap gap-2">
                  <button className="btn btn-ghost" onClick={importFromContacts}>ุณุฌู ุงููุงุชู</button>
                  <button className="btn btn-ghost" onClick={()=>peopleInput.current?.click()}>ุงุณุชูุฑุงุฏ ูู ููู (CSV/XLSX)</button>
                  <input ref={peopleInput} type="file" accept=".csv,.xlsx,.xls" className="hidden" onChange={handlePeoplePick} />
                  <span className="text-xs text-neutral-400 self-center">* ุงูุงุณุชูุฑุงุฏ ุงูุขู ูุณุญุจ ุงููุฑูุช ุชููุงุฆูุงู</span>
                </div>
              </div>
              <div>
                <label className="block text-sm mb-1">ุงูุงุณู</label>
                <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={guestName} onChange={e=>setGuestName(e.target.value)} placeholder="ุงุณู ุงูุถูู" />
              </div>
              <div>
                <label className="block text-sm mb-1">ุฑูู ุงููุงุชู</label>
                <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={phone} onChange={e=>setPhone(e.target.value)} placeholder="05xxxxxxxx" />
              </div>
              <div>
                <label className="block text-sm mb-1">ุนุฏุฏ ุงููุฑูุช ูููุฑุงูููู</label>
                <input type="number" min="1" className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={count} onChange={e=>setCount(Number(e.target.value||1))} />
              </div>
              <div>
                <label className="block text-sm mb-1">ุงุณู ุงูุญุฏุซ</label>
                <input className="w-full rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" value={eventName} onChange={e=>setEventName(e.target.value)} placeholder="ูุซุงู: ุฒูุงู ุฎุงูุฏ" readOnly={Boolean(forcedEventName)} />
                <p className="text-xs text-neutral-400 mt-1">ุงููุฑูุช ุงููุชุงุญุฉ ุญุงููุงู: {cardsRemaining}</p>
              </div>
              <div className="md:col-span-2 flex items-center gap-2">
                <button className="btn btn-primary" onClick={create}>ุฅุถุงูุฉ ุงูุฏุนูุฉ (ุณุญุจ {""}{count} ูุฑุช)</button>
              </div>
            </div>
          </div>
        );
      }

      function ImportCenter({ qrCards, setQrCards, onImportPeopleFile, onExportData, onImportData }){
        const peopleInput=useRef(null); const qrInput=useRef(null); const jsonInput=useRef(null);
        const [uploading, setUploading] = useState(false);

        const handlePeoplePick=(e)=>{ const f=e.target.files?.[0]; if(f) onImportPeopleFile(f); e.target.value=''; };
        const handleJsonPick=(e)=>{ const f=e.target.files?.[0]; if(f) onImportData(f); e.target.value=''; };
        
        const onQrPick=async (e)=>{
          const files=Array.from(e.target.files||[]); if(!files.length) return;
          setUploading(true);
          try{
            const existing=qrCards; 
            const hashSet=new Set(existing.map(c=>c.contentHash)); 
            const toAdd=[];
            let addedCount = 0;
            
            for(const file of files){
                try {
                    const dataUrl = await readFileAsDataURL(file); 
                    const r = getQrMetadata(file, dataUrl); 
                    
                    if(hashSet.has(r.contentHash)) continue;

                    toAdd.push(r); 
                    hashSet.add(r.contentHash); 

                } catch(readError) {
                    console.error(`Failed to read file ${file.name}:`, readError);
                }
            }
            
            if(toAdd.length){ 
              setQrCards(prev=>[...toAdd, ...prev]); 
              addedCount = toAdd.length;
              alert(`ุชู ุชุญููู ${addedCount} ุจุงุฑููุฏ ูุญูุธูุง ูุญููุงู (ุจุฏูู ุชูุฑุงุฑ).`);
            } else {
              alert('ูู ุงููููุงุช ููุฑุฑุฉ ุฃู ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุฑุงุกุฉ.');
            }

          }catch(err){ 
            console.error(err); 
            alert('ุชุนุฐุฑ ูุฑุงุกุฉ ุงููููุงุช.'); 
          }
          setUploading(false);
          e.target.value='';
        };

        const clearUsed=()=>{ if(confirm('ุฅุนุงุฏุฉ ุชุนููู ุญุงูุฉ ุฌููุน ุงููุฑูุช ุฅูู "ูุชุงุญ"ุ')) setQrCards(prev=>prev.map(c=>({...c,used:false}))); };
        
        const purgeAll =()=>{ 
            if(confirm('ูุณุญ ุฌููุน ุงูุจูุงูุงุช (ุงูุฏุนูุงุช ูุงููุฑูุช) ุงููุฎุฒูุฉ ูุญููุงู ููุฐุง ุงูุญุฏุซุ')) {
                setQrCards([]); 
                QRDataCache.clear(); 
                updateQrCache();
                SafeStorage.removeItem(LS_INVITES);
                alert('ุชู ูุณุญ ุฌููุน ุจูุงูุงุช ุงููุฑูุช ูุงูุฏุนูุงุช ูู ุงูุฐุงูุฑุฉ ุงููุญููุฉ ููุฐุง ุงูุฌูุงุฒ. (ุงุณู ุงูุญุฏุซ ููููุฉ ุงููุฑูุฑ ูุง ุฒุงูุช ุซุงุจุชุฉ ูู ุงูููุฏ).');
                window.location.reload(); 
            }
        };
        
        const cardsToDisplay = qrCards.map(c => ({
            ...c,
            dataUrl: QRDataCache.get(c.id) || null
        }));


        return (
          <div className="grid md:grid-cols-2 gap-4 mt-3">
            <div className="card p-6 md:col-span-2">
                <h3 className="font-bold">ุชุตุฏูุฑ/ุงุณุชูุฑุงุฏ ุจูุงูุงุช ุงูุญุฏุซ (ููู ุจูู ุงูุฃุฌูุฒุฉ)</h3>
                <p className="text-xs text-neutral-400 mt-1">ููุณุชุฎุฏู ูุฐุง ูุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุฃู ููู ุฌููุน ุจูุงูุงุช ุงูุฏุนูุงุช ูุงููุฑูุช ุงูููุฎุตุตุฉ ุฅูู ุฌูุงุฒ ุขุฎุฑ. **ูุฐุง ุงูููู ูุดูู ุงููุงุด ุงูุฎุงุต ุจุงูุจุงุฑููุฏ.**</p>
                <div className="mt-3 flex flex-wrap gap-2">
                    <button className="btn btn-primary" onClick={onExportData}>ุชุตุฏูุฑ ุงูุจูุงูุงุช ูู JSON</button>
                    <button className="btn btn-ghost" onClick={()=>jsonInput.current?.click()}>ุงุณุชูุฑุงุฏ ุจูุงูุงุช JSON</button>
                    <input ref={jsonInput} type="file" accept=".json" className="hidden" onChange={handleJsonPick} />
                </div>
            </div>

            <div className="card p-6">
              <h3 className="font-bold">ุชุญููู ูุฑูุช ุงูุจุงุฑููุฏ (ุตูุฑ)</h3>
              <p className="text-xs text-neutral-400 mt-1">ูุชู ุญูุธ ุงูุตูุฑ **ูุญููุงู** ููุง ุชูุฒุงูู. ูู ุชุธูุฑ ุนูู ุฃู ุฌูุงุฒ ุขุฎุฑ.</p>
              <div className="mt-3 flex flex-wrap gap-2">
                <button disabled={uploading} className="btn btn-primary" onClick={()=>qrInput.current?.click()}>
                    {uploading ? 'ุฌุงุฑู ุงููุฑุงุกุฉ...' : 'ุงุฎุชูุงุฑ ูููุงุช ุจุงุฑููุฏ'}
                </button>
                <input ref={qrInput} type="file" accept="image/png,image/jpeg,image/jpg,image/svg+xml" multiple className="hidden" onChange={onQrPick} />
                <button className="btn btn-ghost" onClick={clearUsed}>ุฅุนุงุฏุฉ ุชุนููู ุงูุงุณุชุฎุฏุงู</button>
                <button className="btn btn-ghost !bg-red-700/20 !text-red-400" onClick={purgeAll}>ูุณุญ ูู ุจูุงูุงุช ุงูุญุฏุซ ูุญููุงู</button>
              </div>
              <div className="mt-4 grid grid-cols-3 sm:grid-cols-5 md:grid-cols-6 gap-3">
                {cardsToDisplay.map(c=> (
                  <div key={c.id} className="flex flex-col items-center gap-1">
                    {c.dataUrl
                      ? (<img className="thumb" src={c.dataUrl} alt={c.name} title={c.name} />)
                      : (<div className="thumb flex items-center justify-center text-[10px] text-neutral-500">ุบูุฑ ูุชููุฑ ูุญููุงู</div>)}
                    <span className="text-[10px] text-neutral-400">{c.cardNumber ? `#${c.cardNumber}` : 'ุจุฏูู ุฑูู'}</span>
                    <span className={`text-[10px] ${c.used? 'text-yellow-400' : 'text-neutral-500'}`}>{c.used? 'ูุณุชุฎุฏู' : 'ูุชุงุญ'}</span>
                  </div>
                ))}
              </div>
            </div>

            <div className="card p-6">
              <h3 className="font-bold">ุชุญููู ุงูุฃุณูุงุก ูุงูุฃุฑูุงู ูุนุฏุฏ ุงููุฑูุช (CSV / XLSX)</h3>
              <p className="text-xs text-neutral-400 mt-1">ุณูุชู ุงูุขู ุณุญุจ ุงููุฑูุช ูุชุฎุตูุตูุง ุชููุงุฆูุงู ุนูุฏ ุงูุงุณุชูุฑุงุฏ.</p>
              <div className="mt-3 flex gap-2">
                <button className="btn btn-ghost" onClick={()=>peopleInput.current?.click()}>ุงุฎุชูุงุฑ ููู</button>
                <input ref={peopleInput} type="file" accept=".csv,.xlsx,.xls" className="hidden" onChange={handlePeoplePick} />
              </div>
              <p className="text-xs text-yellow-400 mt-3">* ููุงุญุธุฉ: ุฅุฐุง ูู ุชุชููุฑ ูุฑูุช ูุงููุฉุ ุณูุชู ุฅุถุงูุฉ ุงูุถููู ุจุงููุฑูุช ุงููุชุงุญุฉ ููุท.</p>
            </div>
          </div>
        );
      }

      function SendCenter({ invites, onSend, onBulk }){
        const [filter,setFilter]=useState('');
        const list=invites.filter(i=> i.status==='new' || i.status==='reminded')
          .filter(i=> [i.guestName,i.phone,i.eventName].some(f=> (f||'').toLowerCase().includes(filter.toLowerCase())));
        return (
          <div className="card p-6 mt-3">
            <div className="flex flex-wrap items-center gap-2 mb-4">
              <input className="w-full md:w-80 rounded-xl bg-[#0f1318] border border-[#23262b] px-3 py-2" placeholder="ุจุญุซ ุจุงูุงุณู ุฃู ุงูุฑูู" value={filter} onChange={e=>setFilter(e.target.value)} />
              <button disabled={!list.length} className="btn btn-primary" onClick={()=>onBulk(list)}>ุฅุฑุณุงู ุฌูุงุนู ({list.length})</button>
            </div>
            {!list.length ? (
              <p className="text-neutral-400 text-sm">ูุง ุชูุฌุฏ ุนูุงุตุฑ ุฌุงูุฒุฉ ููุฅุฑุณุงู ุงูุขู.</p>
            ) : (
              <div className="grid md:grid-cols-2 gap-3">
                {list.map(inv => (
                  <div key={inv.id} className="card p-4 space-y-2">
                    <p><b>{inv.guestName}</b> โ <span dir="ltr">{inv.phone}</span></p>
                    <p className="text-sm text-neutral-400">ูุฑูุช ูููุฑุงูููู: {inv.count}</p>
                    {inv.qrId && QRDataCache.get(inv.qrId) && (
                      <a className="link" href={QRDataCache.get(inv.qrId)} download={`${inv.qrName||'qr'}-${inv.qrNumber||''}.png`}>ุชูุฒูู ุฃูู ุจุงุฑููุฏ (ูุญูู)</a>
                    )}
                    <div className="flex gap-2 justify-end">
                      <button className="btn btn-primary" onClick={()=>onSend(inv)}>ุฅุฑุณุงู ูุฑุฏู (ูุต)</button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }
      
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
