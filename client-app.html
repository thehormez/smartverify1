<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hormez — تطبيق العميل لإرسال الدعوات</title>
  <style>
    :root{--bg:#0b0f1a;--ink:#e8edf4;--muted:#9aa4b2;--line:#273043;--card:#0f1524;--accent:#ffd24a;--ok:#16a34a;--bad:#dc2626;--warn:#f59e0b}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0f1a,#0a0f1d);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .btn{appearance:none;border:1px solid var(--line);background:#0b1220;color:var(--ink);border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:#0d1528}
    .btn-cta{background:linear-gradient(135deg,var(--accent),#ffe494);color:#0a0a0a;border:none;font-weight:800}
    .select,.input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:12px}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    @media(max-width:980px){.grid-3{grid-template-columns:1fr}}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1220;cursor:pointer}
    .tab.active{background:#121b31;border-color:#2a3958}
    .hide{display:none}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-top:1px solid rgba(255,255,255,.08)}
    thead th{position:sticky;top:0;background:#101a33}
    .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
    .badge{padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);font-weight:700;font-size:12px}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#0b1220;border-radius:10px;padding:8px 10px}
  </style>
</head>
<body>
  <div class="container">
    <!-- ===== Login ===== -->
    <div id="loginView" class="card" style="max-width:520px;margin:40px auto">
      <div class="row" style="gap:12px">
        <div class="logo" style="width:42px;height:42px;border-radius:12px;background:#111;border:1px solid #333;display:grid;place-items:center"><span style="font-weight:900;color:var(--accent)">HS</span></div>
        <div>
          <div class="muted" style="font-size:12px">HORMEZ</div>
          <div style="font-weight:800">تسجيل دخول العميل</div>
        </div>
      </div>
      <div class="muted" style="margin-top:10px">ادخل الحساب وكلمة المرور التي منحتها للعميل.</div>
      <div class="grid" style="margin-top:10px">
        <div>
          <div class="muted">الحساب (username)</div>
          <input id="u" class="input" placeholder="مثال: alkendi" />
        </div>
        <div>
          <div class="muted">كلمة المرور</div>
          <input id="p" class="input" type="password" placeholder="••••" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="loginBtn" class="btn btn-cta">دخول</button>
      </div>
      <div id="loginErr" class="muted" style="color:#fca5a5;margin-top:8px;display:none">بيانات الدخول غير صحيحة</div>
      <div class="muted" style="margin-top:10px;font-size:12px">* للتعديل السريع على الحسابات، عدّل الكود في أعلى الصفحة (CLIENTS)</div>
    </div>

    <!-- ===== App ===== -->
    <div id="appView" class="hide">
      <!-- App top -->
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <div class="muted" style="font-size:12px">مرحبا، <span id="helloName">—</span></div>
            <div style="font-weight:800">لوحة العميل</div>
          </div>
          <div class="row">
            <button id="logoutBtn" class="btn">خروج</button>
          </div>
        </div>
        <div class="grid grid-3" style="margin-top:10px">
          <div class="card">
            <div class="muted">الدعوات المحجوزة</div>
            <div class="mono" id="kReserved" style="font-size:26px;font-weight:900">0</div>
          </div>
          <div class="card">
            <div class="muted">الرصيد</div>
            <div class="mono" id="kBalance" style="font-size:26px;font-weight:900">0</div>
          </div>
          <div class="card">
            <div class="muted">الإرسال الكلي</div>
            <div class="mono" id="kSent" style="font-size:26px;font-weight:900">0</div>
          </div>
        </div>
      </div>

      <!-- Nav -->
      <div class="card" style="margin-top:10px">
        <div class="nav">
          <button class="tab active" data-tab="home">الصفحة الرئيسية</button>
          <button class="tab" data-tab="new">دعوة جديدة</button>
          <button class="tab" data-tab="send">الإرسال</button>
          <button class="tab" data-tab="remind">التذكير</button>
          <button class="tab" data-tab="attend">الحضور</button>
        </div>
      </div>

      <!-- Tabs Content -->
      <div id="tab-home" class="card">
        <div class="muted">إدارة الحدث</div>
        <div class="row" style="margin-top:10px;align-items:flex-end">
          <div style="flex:2">
            <div class="muted">اسم الحدث</div>
            <input id="eventName" class="input" placeholder="زفاف سعيد" />
          </div>
          <div>
            <button id="applyEvent" class="btn">تطبيق على الروابط</button>
          </div>
          <div class="pill">رابط المشاركة: <span id="shareUrl" class="mono" style="margin-inline-start:6px"></span></div>
        </div>
        <div class="row" style="margin-top:8px">
          <a id="openScanner" target="_blank" class="btn">🔎 الماسح</a>
          <a id="openDashboard" target="_blank" class="btn">📊 لوحة الحضور</a>
          <a id="openMerge" target="_blank" class="btn">🧩 دمج الباركود</a>
        </div>
      </div>

      <div id="tab-new" class="card hide">
        <div class="muted">إنشاء دعوة جديدة</div>
        <div class="row" style="margin-top:10px">
          <button id="pickContactBtn" class="btn">📇 سجل الهاتف</button>
          <span class="muted" style="font-size:12px">قد لا تعمل على كل الأجهزة (Contacts Picker)</span>
        </div>
        <div class="grid" style="margin-top:10px">
          <div>
            <div class="muted">الاسم من سجل الهاتف</div>
            <input id="phoneName" class="input" placeholder="—" disabled />
          </div>
          <div>
            <div class="muted">رقم الهاتف</div>
            <input id="phoneNumber" class="input" placeholder="05xxxxxxxx" />
          </div>
        </div>
        <div class="grid" style="margin-top:10px">
          <div>
            <div class="muted">الاسم على الدعوة</div>
            <input id="inviteName" class="input" placeholder="اسم الضيف" />
          </div>
          <div>
            <div class="muted">عدد الكروت للمرافقين</div>
            <input id="companions" class="input" type="number" min="1" value="1" />
          </div>
        </div>
        <div style="margin-top:10px">
          <div class="muted">نص رسالة واتساب</div>
          <textarea id="waMsg" rows="5" class="input" placeholder="مرحبًا {{name}}، يسعدنا دعوتك لحضور {{event}}. عدد الدعوات: {{count}}."></textarea>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="sendNowBtn" class="btn btn-cta">إرسال الآن (WhatsApp Web)</button>
          <button id="shareBtn" class="btn">فتح للمشاركة</button>
        </div>
      </div>

      <div id="tab-send" class="card hide">
        <div class="muted">إرسال للمجموعة</div>
        <div style="margin-top:8px">
          <textarea id="bulkArea" rows="6" class="input" placeholder="name, phone, count\nAli, 0551234567, 2"></textarea>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="bulkParseBtn" class="btn">إضافة</button>
          <button id="bulkClearBtn" class="btn">مسح</button>
        </div>
        <div style="max-height:40vh;overflow:auto;margin-top:8px">
          <table>
            <thead><tr><th>الاسم</th><th>الرقم</th><th>العدد</th><th>إرسال</th></tr></thead>
            <tbody id="bulkBody"></tbody>
          </table>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="bulkSendBtn" class="btn btn-cta">إرسال جماعي (يفتح واتساب ويب)</button>
        </div>
      </div>

      <div id="tab-remind" class="card hide">
        <div class="muted">التذكير</div>
        <div style="margin-top:6px">اكتب رسالة تذكير قصيرة وسيتم فتح واتساب ويب لكل مختار.</div>
        <div style="margin-top:6px"><textarea id="remMsg" rows="4" class="input" placeholder="تذكير بموعد المناسبة غدًا عند الساعة ..."></textarea></div>
        <div class="row" style="margin-top:8px">
          <button id="remPreviewBtn" class="btn">معاينة 5</button>
          <button id="remSendBtn" class="btn btn-cta">إرسال التذكيرات</button>
        </div>
      </div>

      <div id="tab-attend" class="card hide">
        <div class="muted">الحضور</div>
        <div style="margin-top:6px" class="row">
          <a id="attDash" target="_blank" class="btn">📊 فتح لوحة الحضور</a>
          <a id="attScanner" target="_blank" class="btn">🔎 فتح الماسح</a>
        </div>
        <div class="muted" style="margin-top:6px">تُفتح الصفحات على الحدث الحالي تلقائيًا.</div>
      </div>
    </div>
  </div>

  <script>
    // ===== Admin: عيّن حسابات العملاء هنا =====
    const CLIENTS = {
      "alkendi": { password: "6666", name: "الكندي", quota: 200 },
      // أضف المزيد بهيئة: "username": { password:"xxxx", name:"اسم العميل", quota: عدد الرصيد }
    };

    // ===== Helpers =====
    const $=(s,root=document)=>root.querySelector(s);
    const SKEY=(u)=>`hs:client:${u}:state`;
    function loadState(u){ try{ return JSON.parse(localStorage.getItem(SKEY(u))||'{}'); }catch{return{}} }
    function saveState(u,st){ localStorage.setItem(SKEY(u), JSON.stringify(st)); }
    function toast(msg){ const t=document.createElement('div'); t.textContent=msg; t.style.position='fixed'; t.style.left='50%'; t.style.transform='translateX(-50%)'; t.style.top='12px'; t.style.background='#0b1220'; t.style.border='1px solid #334155'; t.style.padding='8px 12px'; t.style.borderRadius='10px'; t.style.zIndex='50'; document.body.appendChild(t); setTimeout(()=>t.remove(),1500); }
    function tpl(str, ctx){ return (str||'').replace(/\{\{(\w+)\}\}/g,(_,k)=> ctx[k]??''); }
    function onlyDigits(s){ return (s||'').toString().replace(/[^0-9]/g,''); }

    // ===== Session =====
    let USER=null; let STATE={sent:0,reserved:0,event:""};

    function updateKpis(){ $('#kReserved').textContent=STATE.reserved||0; const q=(USER?.quota||0); const bal=Math.max(q-(STATE.sent||0),0); $('#kBalance').textContent=bal; $('#kSent').textContent=STATE.sent||0; }

    function rebuildLinks(){ const ev=encodeURIComponent($('#eventName').value.trim()); const base=location.origin+location.pathname.replace(/[^\/]*$/,'');
      const scan=`new-scanner.html${ev?`?event=${ev}`:''}`; const dash=`new-dashboard.html${ev?`?event=${ev}`:''}`; const merge=`new-merge-qr.html${ev?`?event=${ev}`:''}`;
      $('#openScanner').href=scan; $('#openDashboard').href=dash; $('#openMerge').href=merge; $('#attDash').href=dash; $('#attScanner').href=scan; $('#shareUrl').textContent = base + `client-app.html?event=${ev}`; }

    function openWA(phone,text){ const url=`https://wa.me/${encodeURIComponent(phone)}?text=${encodeURIComponent(text)}`; window.open(url,'_blank'); }

    // ===== Login flow =====
    function tryLogin(){ const u=$('#u').value.trim(); const p=$('#p').value; const rec=CLIENTS[u]; if(!rec || rec.password!==p){ $('#loginErr').style.display='block'; return; } USER={username:u, ...rec}; STATE = {...{sent:0,reserved:0,event:""}, ...loadState(u)}; $('#helloName').textContent=USER.name; updateKpis(); $('#loginView').classList.add('hide'); $('#appView').classList.remove('hide'); const purl=new URLSearchParams(location.search); const ev=purl.get('event')||STATE.event||''; if(ev) $('#eventName').value=decodeURIComponent(ev); rebuildLinks(); }

    function logout(){ USER=null; STATE={}; sessionStorage.removeItem('hs:client:session'); location.reload(); }

    // ===== Tabs =====
    function showTab(id){ document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id)); ['home','new','send','remind','attend'].forEach(t=> $('#tab-'+t).classList.toggle('hide', t!==id)); }

    // ===== New Invite =====
    async function pickContact(){ try{ if(!('contacts' in navigator) || !('select' in navigator.contacts)){ alert('المتصفح لا يدعم اختيار جهات الاتصال.'); return; } const sel=await navigator.contacts.select(['name','tel'],{multiple:false}); if(!sel||!sel.length) return; const c=sel[0]; const name=Array.isArray(c.name)? (c.name[0]||''): (c.name||''); const tel=Array.isArray(c.tel)? (c.tel[0]||'') : (c.tel||''); $('#phoneName').value=name; $('#phoneNumber').value=tel; if(!$('#inviteName').value) $('#inviteName').value=name; }catch(e){ alert('تعذر الوصول لجهات الاتصال: '+(e.message||e)); } }

    function buildPhone(){ const p=onlyDigits($('#phoneNumber').value); return p; }
    function buildMsg(){ const name=$('#inviteName').value.trim(); const count=parseInt($('#companions').value||'1',10)||1; const ev=$('#eventName').value.trim(); const tplMsg=$('#waMsg').value||'مرحبًا {{name}}، يسعدنا دعوتك لحضور {{event}}. عدد الدعوات: {{count}}.'; return tpl(tplMsg,{name, count, event:ev}); }

    function sendNow(){ const phone=buildPhone(); if(!phone){ alert('رقم غير صالح'); return;} const text=buildMsg(); openWA(phone,text); STATE.sent=(STATE.sent||0)+1; saveState(USER.username, STATE); updateKpis(); toast('تم فتح واتساب'); }

    function shareOpen(){ const phone=buildPhone()||''; const text=buildMsg(); const url=`https://wa.me/${encodeURIComponent(phone)}?text=${encodeURIComponent(text)}`; window.open(url,'_blank'); }

    // ===== Bulk =====
    let BULK=[];
    function renderBulk(){ const body=$('#bulkBody'); body.innerHTML=''; BULK.forEach((r,i)=>{ const tr=document.createElement('tr'); const t1=document.createElement('td'); t1.textContent=r.name; tr.appendChild(t1); const t2=document.createElement('td'); t2.textContent=r.phone; tr.appendChild(t2); const t3=document.createElement('td'); const inp=document.createElement('input'); inp.type='number'; inp.min='1'; inp.value=r.count||1; inp.className='input'; inp.style.width='100px'; inp.onchange=()=>{ r.count=Math.max(1,parseInt(inp.value||'1',10)||1); }; t3.appendChild(inp); tr.appendChild(t3); const t4=document.createElement('td'); const b=document.createElement('button'); b.className='btn'; b.textContent='إرسال'; b.onclick=()=>{ const msg=tpl($('#waMsg').value||'مرحبًا {{name}}، يسعدنا دعوتك لحضور {{event}}. عدد الدعوات: {{count}}.', {name:r.name, count:r.count||1, event:$('#eventName').value.trim()}); openWA(onlyDigits(r.phone), msg); STATE.sent=(STATE.sent||0)+1; saveState(USER.username, STATE); updateKpis(); }; t4.appendChild(b); tr.appendChild(t4); body.appendChild(tr); }); }

    function bulkParse(){ const text=$('#bulkArea').value||''; const lines=text.split(/\n+/).map(s=>s.trim()).filter(Boolean); BULK = lines.map(l=>{ const parts=l.split(','); return { name:(parts[0]||'').trim(), phone:(parts[1]||'').trim(), count: parseInt((parts[2]||'1').trim(),10)||1 }; }).filter(r=>r.name && r.phone); renderBulk(); toast('تمت الإضافة'); }
    function bulkClear(){ BULK=[]; renderBulk(); }
    async function bulkSend(){ if(!BULK.length){ alert('لا توجد بيانات'); return;} const ev=$('#eventName').value.trim(); const msgTpl=$('#waMsg').value||'مرحبًا {{name}}، يسعدنا دعوتك لحضور {{event}}. عدد الدعوات: {{count}}.'; let opened=0; for(const r of BULK){ const msg=tpl(msgTpl,{name:r.name,count:r.count||1,event:ev}); openWA(onlyDigits(r.phone), msg); opened++; if(opened%8===0){ await new Promise(res=>setTimeout(res,800)); } STATE.sent=(STATE.sent||0)+1; } saveState(USER.username, STATE); updateKpis(); }

    // ===== Reminders =====
    function remPreview(){ const msg=$('#remMsg').value||''; const ex=BULK.slice(0,5).map(r=>`إلى ${r.name} (${r.phone}): ${msg}`).join('\n\n'); alert(ex||'لا توجد بيانات للمعاينة.'); }
    async function remSend(){ const msg=$('#remMsg').value||''; if(!msg){ alert('اكتب رسالة التذكير'); return;} let opened=0; for(const r of BULK){ openWA(onlyDigits(r.phone), msg); opened++; if(opened%8===0) await new Promise(res=>setTimeout(res,800)); } toast('تم فتح واتساب للتذكير'); }

    // ===== Wire =====
    document.addEventListener('DOMContentLoaded',()=>{
      // Login
      $('#loginBtn').addEventListener('click', tryLogin);
      $('#logoutBtn').addEventListener('click', logout);

      // Tabs
      document.querySelectorAll('.tab').forEach(b=> b.addEventListener('click', ()=> showTab(b.dataset.tab)));

      // Home links
      $('#applyEvent').addEventListener('click', ()=>{ STATE.event=$('#eventName').value.trim(); saveState(USER.username, STATE); rebuildLinks(); toast('تم التطبيق'); });

      // New
      $('#pickContactBtn').addEventListener('click', pickContact);
      $('#sendNowBtn').addEventListener('click', sendNow);
      $('#shareBtn').addEventListener('click', shareOpen);

      // Bulk
      $('#bulkParseBtn').addEventListener('click', bulkParse);
      $('#bulkClearBtn').addEventListener('click', bulkClear);
      $('#bulkSendBtn').addEventListener('click', bulkSend);

      // Remind
      $('#remPreviewBtn').addEventListener('click', remPreview);
      $('#remSendBtn').addEventListener('click', remSend);

      // Deep-link event from URL
      const p=new URLSearchParams(location.search); const ev=p.get('event'); if(ev) $('#eventName').value=decodeURIComponent(ev);

      // Default tab
      showTab('home');
    });
  </script>
</body>
</html>
