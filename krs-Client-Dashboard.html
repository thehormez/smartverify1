<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>KRS INVITE â€” Ù„ÙˆØ­Ø© Ø­Ø¶ÙˆØ± Ø¨Ø³ÙŠØ·Ø©</title>

  <style>
    :root{
      --bg0:#06080f; --bg1:#0a0f1d;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --ink:#e9edf5; --muted:#a7b0c3;
      --gold:#d6b15e; --blue:#1e40af; --rose:#be123c; --green:#047857;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --r16:16px; --r20:20px;
      --focus: 0 0 0 4px rgba(214,177,94,.12);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui,-apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial;
    }
    [data-theme="light"]{
      --bg0:#f8fafc; --bg1:#eef2ff;
      --card:rgba(0,0,0,.04);
      --stroke:rgba(0,0,0,.10);
      --stroke2:rgba(0,0,0,.14);
      --ink:#0b1220; --muted:#475569;
      --shadow:0 18px 60px rgba(2,6,23,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 18% 8%, rgba(214,177,94,.14), transparent 55%),
        radial-gradient(900px 500px at 82% 15%, rgba(30,64,175,.12), transparent 60%),
        radial-gradient(900px 500px at 70% 92%, rgba(190,18,60,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .container{max-width:1120px;margin:0 auto;padding:14px}
    .topbar{
      position:sticky; top:0; z-index:30;
      background: rgba(6,8,15,.72);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--stroke);
    }
    [data-theme="light"] .topbar{ background: rgba(248,250,252,.72); }
    .top-inner{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:12px; min-width: 280px}
    .logo{
      width:44px;height:44px;border-radius:18px;
      background: radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.22), transparent 55%),
                  linear-gradient(145deg, rgba(214,177,94,.25), rgba(180,138,24,.08));
      border:1px solid rgba(214,177,94,.35);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      display:grid;place-items:center;
      font-weight:1000;color:var(--gold);
    }
    .hdrOrg{color:var(--muted);font-size:12px;letter-spacing:.6px}
    .hdrTitle{font-weight:1000;font-size:15px}
    .hdrTitle .ev{color:var(--gold)}
    .actions{margin-inline-start:auto; display:flex; gap:8px; flex-wrap:wrap}
    .btn{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      color:var(--ink);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      min-height:42px;
      font-size:14px;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
    }
    .btn:hover{background:rgba(255,255,255,.08); border-color:rgba(214,177,94,.30)}
    .btn.danger{border-color: rgba(190,18,60,.45); background: rgba(190,18,60,.10)}
    .btn.ghost{background:transparent}

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r20);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .muted{color:var(--muted);font-size:12px}

    .grid{display:grid; gap:12px}
    .grid-3{grid-template-columns: 1.1fr 1fr .9fr}
    @media(max-width:980px){.grid-3{grid-template-columns:1fr}}
    .input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      color:var(--ink);
      min-height:44px;
      font-size:14px;
      outline:none;
    }
    .input:focus{
      border-color: rgba(214,177,94,.42);
      background: rgba(255,255,255,.07);
      box-shadow: var(--focus);
    }

    .kpiRow{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px}
    @media(max-width:980px){.kpiRow{grid-template-columns:repeat(2,1fr)}}
    .kpi{
      border-radius: var(--r20);
      padding:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      box-shadow: 0 14px 40px rgba(0,0,0,.18);
    }
    .kpi .t{font-weight:1000;font-size:12px;color:var(--muted)}
    .kpi .n{font-size:26px;font-weight:1100;margin-top:6px}
    .kpi.blue{background:linear-gradient(135deg, rgba(30,64,175,1), rgba(30,64,175,.45)); color:#fff; border:none}
    .kpi.gold{background:linear-gradient(135deg, rgba(214,177,94,1), rgba(180,138,24,.40)); color:#161106; border:none}
    .kpi.rose{background:linear-gradient(135deg, rgba(190,18,60,1), rgba(190,18,60,.40)); color:#fff; border:none}
    .kpi.green{background:linear-gradient(135deg, rgba(4,120,87,1), rgba(4,120,87,.40)); color:#fff; border:none}

    .tableWrap{
      margin-top:12px;
      border-radius: var(--r20);
      overflow:auto;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
    }
    table{width:100%; border-collapse:collapse; min-width:860px}
    thead th{
      text-align:start;
      padding:10px 10px;
      background: rgba(255,255,255,.06);
      border-bottom:1px solid var(--stroke);
      font-weight:1000;
      letter-spacing:.3px;
      font-size:12px;
      color:var(--muted);
      position:sticky; top:0;
      backdrop-filter: blur(6px);
    }
    tbody td{
      padding:10px;
      border-top:1px solid rgba(255,255,255,.08);
      font-size:14px;
    }
    tbody tr:hover td{background: rgba(214,177,94,.06)}
    .mono{font-family: var(--mono)}
    .badge{
      padding:6px 10px;
      border-radius: 999px;
      font-weight:1000;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
    }
    .badge.ok{border-color:rgba(34,197,94,.25); background:rgba(34,197,94,.10); color:rgba(34,197,94,.95)}
    .badge.no{border-color:rgba(244,63,94,.25); background:rgba(244,63,94,.10); color:rgba(244,63,94,.95)}

    /* Login overlay */
    .gate{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.55); z-index:9999; padding:16px;
    }
    .panel{
      width:min(560px, 100%);
      border-radius: 22px;
      background: rgba(10,15,29,.92);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(12px);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
    }
    [data-theme="light"] .panel{ background: rgba(248,250,252,.95) }
    .panel .ph{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.12);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .panel .pb{padding:14px}
    .err{color:#ffb4c2;font-size:12px;margin-top:10px;display:none}
    [data-theme="light"] .err{color:#be123c}

    @media print{
      .topbar, .no-print{display:none!important}
      body{background:#fff;color:#111}
      .card,.tableWrap{box-shadow:none;border:1px solid #ddd;background:#fff}
      thead th{background:#f5f5f5;color:#111}
      tbody td{color:#111}
    }
  </style>
</head>

<body>
  <div class="topbar no-print">
    <div class="container top-inner">
      <div class="brand">
        <div class="logo">KRS</div>
        <div>
          <div class="hdrOrg">KRS INVITE</div>
          <div class="hdrTitle">Ù„ÙˆØ­Ø© Ø­Ø¶ÙˆØ± Ø¨Ø³ÙŠØ·Ø© â€” <span class="ev" id="evName">â€”</span></div>
          <div class="muted" id="sub">Source: invites â€¢ Read-only</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn ghost" id="themeBtn">ğŸŒ“</button>
        <button class="btn" id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
        <button class="btn danger" id="logoutBtn" disabled>Ø®Ø±ÙˆØ¬</button>
        <button class="btn" id="printBtn" disabled>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Controls -->
    <div class="grid grid-3 no-print">
      <div class="card">
        <div class="muted">EventName</div>
        <input id="eventInput" class="input" placeholder="Ù…Ø«Ø§Ù„: zafaf_khaled" />
      </div>
      <div class="card">
        <div class="muted">Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯</div>
        <input id="searchInput" class="input" placeholder="KH_001" />
      </div>
      <div class="card" style="display:flex;gap:10px;align-items:end;justify-content:flex-end">
        <button class="btn" id="loadBtn" disabled>ØªØ­Ù…ÙŠÙ„</button>
        <button class="btn" id="refreshBtn" disabled>ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>

    <!-- KPI -->
    <div class="kpiRow" style="margin-top:12px">
      <div class="kpi blue"><div class="t">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div><div class="n" id="k_total">â€”</div></div>
      <div class="kpi gold"><div class="t">Ø§Ù„Ø­Ø¶ÙˆØ± (yes)</div><div class="n" id="k_used">â€”</div></div>
      <div class="kpi rose"><div class="t">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (no)</div><div class="n" id="k_left">â€”</div></div>
      <div class="kpi green"><div class="t">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div><div class="n" id="k_rate">â€”%</div></div>
    </div>

    <!-- Table -->
    <div class="card" style="margin-top:12px">
      <div class="muted">Ø§Ù„Ø³Ø¬Ù„ (Ø¢Ø®Ø± 300 ÙƒÙˆØ¯ â€” Ù…Ø±ØªÙ‘Ø¨ Ø­Ø³Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„)</div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„ÙƒÙˆØ¯</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ù…ØªÙ‰ Ø¯Ø®Ù„</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="3" class="muted">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¯Ø« ÙˆØ§Ø¶ØºØ· ØªØ­Ù…ÙŠÙ„.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="muted" id="lastLoad" style="margin-top:10px">â€”</div>
    </div>
  </div>

  <!-- Login gate -->
  <div class="gate" id="gate">
    <div class="panel">
      <div class="ph">
        <div style="font-weight:1000">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
        <button class="btn ghost" id="closeGate">âœ•</button>
      </div>
      <div class="pb">
        <div class="grid" style="gap:10px">
          <div>
            <div class="muted">Email</div>
            <input id="email" class="input" autocomplete="username" placeholder="client@email.com" />
          </div>
          <div>
            <div class="muted">Password</div>
            <input id="pass" class="input" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          </div>
          <button class="btn" id="doLogin">Ø¯Ø®ÙˆÙ„</button>
          <div class="err" id="err"></div>
          <div class="muted" style="line-height:1.7">
            âœ… Ù‡Ø°Ø§ ÙŠØ­Ù…ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª invites. Ù…Ø§ ÙÙŠ publicDash ÙˆÙ„Ø§ ÙØªØ­ Ù„Ù„Ø¹Ø§Ù…Ø©.
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const $=(s)=>document.querySelector(s);

  // âœ… Firebase config (Ù…Ø´Ø±ÙˆØ¹Ùƒ)
  const app = initializeApp({
    apiKey:"AIzaSyBt7eV0k_yTcOgiU8rx5UbvkkeBHduR6ac",
    authDomain:"hormez-inv.firebaseapp.com",
    projectId:"hormez-inv",
    storageBucket:"hormez-inv.firebasestorage.app",
    messagingSenderId:"747519941805",
    appId:"1:747519941805:web:468fada2492700e9da3a24"
  });

  const auth=getAuth(app);
  const db=getFirestore(app);

  // Theme
  const themeBtn=$("#themeBtn");
  function setTheme(t){ document.documentElement.setAttribute("data-theme", t); localStorage.setItem("krs:theme", t); }
  setTheme(localStorage.getItem("krs:theme")||"dark");
  themeBtn.addEventListener("click", ()=> setTheme((document.documentElement.getAttribute("data-theme")||"dark")==="dark"?"light":"dark"));

  // Gate
  const gate=$("#gate");
  $("#loginBtn").addEventListener("click", ()=>{ $("#err").style.display="none"; gate.style.display="flex"; setTimeout(()=>$("#email").focus(), 50); });
  $("#closeGate").addEventListener("click", ()=> gate.style.display="none");

  async function doLogin(){
    const email=($("#email").value||"").trim();
    const pass =($("#pass").value||"").trim();
    if(!email || !pass){ $("#err").textContent="Ø§ÙƒØªØ¨ Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯"; $("#err").style.display="block"; return; }
    $("#doLogin").disabled=true;
    try{
      await signInWithEmailAndPassword(auth,email,pass);
      gate.style.display="none";
    }catch(e){
      $("#err").textContent="ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + (e?.message||e);
      $("#err").style.display="block";
    }finally{
      $("#doLogin").disabled=false;
    }
  }
  $("#doLogin").addEventListener("click", doLogin);
  $("#pass").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); doLogin(); } });

  $("#logoutBtn").addEventListener("click", ()=> signOut(auth));
  $("#printBtn").addEventListener("click", ()=> window.print());

  function setAuthUI(isIn){
    $("#logoutBtn").disabled = !isIn;
    $("#printBtn").disabled = !isIn;
    $("#loadBtn").disabled = !isIn;
    $("#refreshBtn").disabled = !isIn;
  }

  onAuthStateChanged(auth, (user)=>{
    setAuthUI(!!user);
    if(user){
      const last = localStorage.getItem("krs:lastEvent")||"";
      if(last && !$("#eventInput").value) $("#eventInput").value = last;
    }
  });

  // Data
  const isYes=(v)=>String(v||"").toLowerCase()==="yes";

  function fmt(ts){
    if(!ts) return "â€”";
    try{
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString("ar-AE");
    }catch{ return "â€”"; }
  }

  function badge(status){
    const ok=isYes(status);
    return `<span class="badge ${ok?'ok':'no'}">${ok?'ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„':'Ù„Ù… ÙŠØ¯Ø®Ù„'}</span>`;
  }

  let ALL=[];

  function render(){
    const q=($("#searchInput").value||"").trim().toLowerCase();
    let rows = ALL.slice();

    if(q) rows = rows.filter(r => (r.Code||"").toLowerCase().includes(q));

    // KPIs from ALL (not filtered)
    const total = ALL.length;
    const used  = ALL.filter(r=>isYes(r.Status)).length;
    const left  = Math.max(total-used,0);
    const rate  = total? Math.round((used/total)*100) : 0;

    $("#k_total").textContent = total;
    $("#k_used").textContent  = used;
    $("#k_left").textContent  = left;
    $("#k_rate").textContent  = rate + "%";

    // table
    const tb=$("#rows");
    if(!rows.length){
      tb.innerHTML = `<tr><td colspan="3" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</td></tr>`;
      return;
    }

    tb.innerHTML = rows.slice(0,300).map(r=>{
      return `
        <tr>
          <td class="mono">${r.Code}</td>
          <td>${badge(r.Status)}</td>
          <td class="muted">${fmt(r.scannedAt)}</td>
        </tr>
      `;
    }).join("");
  }

  async function load(){
    const ev = ($("#eventInput").value||"").trim();
    if(!ev){ alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø­Ø¯Ø« (Ù…Ø«Ø§Ù„: zafaf_khaled)"); return; }

    localStorage.setItem("krs:lastEvent", ev);
    $("#evName").textContent = ev;

    $("#rows").innerHTML = `<tr><td colspan="3" class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>`;
    ALL=[];

    try{
      const col = collection(db,"invites");
      const snap = await getDocs(query(col, where("EventName","==", ev)));

      snap.forEach(docu=>{
        const d = docu.data() || {};
        ALL.push({
          Code: d.Code || docu.id,
          Status: d.Status || "no",
          scannedAt: d.scannedAt || null
        });
      });

      // sort: latest first (nulls last)
      ALL.sort((a,b)=>{
        const ta = a.scannedAt?.toDate?.()?.getTime?.() || 0;
        const tb = b.scannedAt?.toDate?.()?.getTime?.() || 0;
        return tb - ta;
      });

      $("#lastLoad").textContent = "Ø¢Ø®Ø± ØªØ­Ù…ÙŠÙ„: " + new Date().toLocaleString("ar-AE") + " â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ: " + ALL.length;
      render();
    }catch(e){
      console.error(e);
      $("#rows").innerHTML = `<tr><td colspan="3" class="muted">Ø®Ø·Ø£: ${(e?.message||e)}</td></tr>`;
    }
  }

  $("#loadBtn").addEventListener("click", load);
  $("#refreshBtn").addEventListener("click", load);
  $("#searchInput").addEventListener("input", render);

</script>
</body>
</html>
